var rainbowSDK=function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}return __webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{enumerable:!0,get:getter})},__webpack_require__.r=function(exports){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(exports,"__esModule",{value:!0})},__webpack_require__.t=function(value,mode){if(1&mode&&(value=__webpack_require__(value)),8&mode)return value;if(4&mode&&"object"==typeof value&&value&&value.__esModule)return value;var ns=Object.create(null);if(__webpack_require__.r(ns),Object.defineProperty(ns,"default",{enumerable:!0,value:value}),2&mode&&"string"!=typeof value)for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=306)}([function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class Call{constructor(status,id,type,contact){this.isVm=!1,this.remoteMedia=0,this.localMedia=0,this.isEscalated=!1,this.startDate=new Date,this.isInitiator=!1,this.participants=null,this.isRemoteVideoMuted=!1,this.isConference=!1,this.subject=void 0,this.currentCalled={contactPhoneNumber:"",contact:null,participantsPhoneNumbers:[],participants:[]},this.fullJid="",this.mediaPillarCall=null,this.isSecondary=!1,this.relevant=!0,this.relevantEquipmentId="unknown",this.deviceId=null,this.isOwner=void 0,this.pbxConnectionDown=void 0,this.isMuted=!1,this.duration=0,this.unifiedPlanActivated=!1,this.status=status,this.type=type,this.id=id,this.conversationId=null,this.connectionId=null,this.isVm=null,this.contact=contact,this.remoteMedia=0,this.localMedia=0,this.isEscalated=!1,this.startDate=new Date,this.isInitiator=!1,this.participants=null,this.isRemoteVideoMuted=!1,this.isConference=!1,this.avatars=contact&&contact.avatar?[this.contact.avatar.src]:[],this.subject=void 0,this.currentCalled={contactPhoneNumber:"",contact:null,participantsPhoneNumbers:[],participants:[]},this.fullJid="",this.mediaPillarCall=null,this.isSecondary=!1,this.relevant=!1,this.relevantEquipmentId="unknown",this.deviceId=null,this.isOwner=void 0,this.pbxConnectionDown=void 0,this.isMuted=!1,this.duration=0,this.statusInfo=null}static create(status,id,type,contact){return new Call(status,id,type,contact)}setCallId(id){this.id=id}setConversationId(conversationId){this.conversationId=conversationId}setStatus(status){this.status=status}setType(type){this.type=type}setIsVm(isVM){this.isVm=isVM}setContact(contact){this.contact=contact,this.avatars=[this.contact.avatar.src]}startDuration(){this.duration}getCurrentCalled(){return this.currentCalled}setSubject(subject){this.subject=subject}setCurrentCalledContactNumber(number){this.currentCalled.contactPhoneNumber=number}setRelevantEquipmentId(relevantEquipmentId){this.relevantEquipmentId=relevantEquipmentId}setParticipants(participants){this.participants=participants,this.avatars=[];this.participants.forEach(participant=>{this.avatars.push(participant.avatar.src)})}setConnectionId(connectionId){this.connectionId=connectionId,this.id=Call.getIdFromConnectionId(connectionId)}isInConversationWithMobile(){return!!this.fullJid&&(-1!==this.fullJid.indexOf("mobile_android")||-1!==this.fullJid.indexOf("mobile_ios"))}setCurrentCalled(currentCalled){currentCalled?this.contact&&this.contact.id?(this.currentCalled.contactPhoneNumber=currentCalled.contactPhoneNumber&&""!==currentCalled.contactPhoneNumber?currentCalled.contactPhoneNumber:"",this.currentCalled.contact=currentCalled.contact?currentCalled.contact:null,this.currentCalled.participantsPhoneNumbers=null,this.currentCalled.participants=null):(this.currentCalled.contactPhoneNumber="",this.currentCalled.contact=null,this.currentCalled.participantsPhoneNumbers=currentCalled.participantsPhoneNumbers&&currentCalled.participantsPhoneNumbers.length>0?currentCalled.participantsPhoneNumbers:null,this.currentCalled.participants=currentCalled.participants&&currentCalled.participants.length>0?currentCalled.participants:null):(this.currentCalled.contactPhoneNumber="",this.currentCalled.contact=null,this.currentCalled.participantsPhoneNumbers=null,this.currentCalled.participants=null)}static getIdFromConnectionId(connectionId){return connectionId}static getCallIdFromConnectionId(connectionId){return connectionId?connectionId.split("#")[0]:null}static getDeviceIdFromConnectionId(connectionId){var deviceId=connectionId?connectionId.split("#")[1]:null;return deviceId||null}isMediaPillarCall(){return null!==this.mediaPillarCall}getMediaPillarCall(){return this.mediaPillarCall}setMediaPillarCall(mediaPillarCallContext){this.mediaPillarCall=mediaPillarCallContext||null}setDeviceIdSipWise(deviceId){this.deviceId=deviceId||null}getDeviceIdSipWise(){return this.deviceId}setConnectionIdSipWise(connectionId){this.connectionId=connectionId}getDeviceIdFromConnectionIdFromCall(){return this.deviceId?this.deviceId:this.connectionId?this.connectionId.split("#")[1]:null}toString(){return"(type:"+this.type.value+", id:"+this.id+", status:"+this.status.value}isInCallWithMediaPillar(){return this.fullJid&&-1!==this.fullJid.indexOf("mp_")}}exports.Call=Call,Call.Status={UNKNOWN:{key:0,value:"Unknown"},DIALING:{key:1,value:"dialing"},QUEUED_INCOMMING:{key:2,value:"queuedIncomming"},QUEUED_OUTGOING:{key:10,value:"queuedOutGoing"},RINGING_INCOMMING:{key:3,value:"incommingCall"},RINGING_OUTGOING:{key:4,value:"ringingOutgoing"},ACTIVE:{key:5,value:"active"},HOLD:{key:6,value:"held"},PUT_ON_HOLD:{key:7,value:"putOnHold"},RELEASING:{key:8,value:"releasing"},ANSWERING:{key:9,value:"answering"},CONNECTING:{key:12,value:"connecting"},ERROR:{key:11,value:"error"}},Call.Type={WEBRTC:{key:1,value:"Video"},PHONE:{key:2,value:"Phone"}},Call.Media={AUDIO:1,VIDEO:2,PHONE:4,SHARING:8},angular.module("rainbow").factory("Call",()=>Call)},function(module,exports){"function"==typeof Object.create?module.exports=function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})}:module.exports=function(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}},function(module,exports,__webpack_require__){(function(global){module.exports=function(){var CryptoJS=CryptoJS||function(Math,undefined){var crypto;if("undefined"!=typeof window&&window.crypto&&(crypto=window.crypto),!crypto&&"undefined"!=typeof window&&window.msCrypto&&(crypto=window.msCrypto),!crypto&&void 0!==global&&global.crypto&&(crypto=global.crypto),!crypto)try{crypto=__webpack_require__(108)}catch(err){}var cryptoSecureRandomInt=function(){if(crypto){if("function"==typeof crypto.getRandomValues)try{return crypto.getRandomValues(new Uint32Array(1))[0]}catch(err){}if("function"==typeof crypto.randomBytes)try{return crypto.randomBytes(4).readInt32LE()}catch(err){}}throw new Error("Native crypto module could not be used to get secure random number.")},create=Object.create||function(){function F(){}return function(obj){var subtype;return F.prototype=obj,subtype=new F,F.prototype=null,subtype}}(),C={},C_lib=C.lib={},Base=C_lib.Base={extend:function(overrides){var subtype=create(this);return overrides&&subtype.mixIn(overrides),subtype.hasOwnProperty("init")&&this.init!==subtype.init||(subtype.init=function(){subtype.$super.init.apply(this,arguments)}),subtype.init.prototype=subtype,subtype.$super=this,subtype},create:function(){var instance=this.extend();return instance.init.apply(instance,arguments),instance},init:function(){},mixIn:function(properties){for(var propertyName in properties)properties.hasOwnProperty(propertyName)&&(this[propertyName]=properties[propertyName]);properties.hasOwnProperty("toString")&&(this.toString=properties.toString)},clone:function(){return this.init.prototype.extend(this)}},WordArray=C_lib.WordArray=Base.extend({init:function(words,sigBytes){words=this.words=words||[],this.sigBytes=null!=sigBytes?sigBytes:4*words.length},toString:function(encoder){return(encoder||Hex).stringify(this)},concat:function(wordArray){var thisWords=this.words,thatWords=wordArray.words,thisSigBytes=this.sigBytes,thatSigBytes=wordArray.sigBytes;if(this.clamp(),thisSigBytes%4)for(var i=0;i<thatSigBytes;i++){var thatByte=thatWords[i>>>2]>>>24-i%4*8&255;thisWords[thisSigBytes+i>>>2]|=thatByte<<24-(thisSigBytes+i)%4*8}else for(i=0;i<thatSigBytes;i+=4)thisWords[thisSigBytes+i>>>2]=thatWords[i>>>2];return this.sigBytes+=thatSigBytes,this},clamp:function(){var words=this.words,sigBytes=this.sigBytes;words[sigBytes>>>2]&=4294967295<<32-sigBytes%4*8,words.length=Math.ceil(sigBytes/4)},clone:function(){var clone=Base.clone.call(this);return clone.words=this.words.slice(0),clone},random:function(nBytes){for(var words=[],i=0;i<nBytes;i+=4)words.push(cryptoSecureRandomInt());return new WordArray.init(words,nBytes)}}),C_enc=C.enc={},Hex=C_enc.Hex={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,hexChars=[],i=0;i<sigBytes;i++){var bite=words[i>>>2]>>>24-i%4*8&255;hexChars.push((bite>>>4).toString(16)),hexChars.push((15&bite).toString(16))}return hexChars.join("")},parse:function(hexStr){for(var hexStrLength=hexStr.length,words=[],i=0;i<hexStrLength;i+=2)words[i>>>3]|=parseInt(hexStr.substr(i,2),16)<<24-i%8*4;return new WordArray.init(words,hexStrLength/2)}},Latin1=C_enc.Latin1={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,latin1Chars=[],i=0;i<sigBytes;i++){var bite=words[i>>>2]>>>24-i%4*8&255;latin1Chars.push(String.fromCharCode(bite))}return latin1Chars.join("")},parse:function(latin1Str){for(var latin1StrLength=latin1Str.length,words=[],i=0;i<latin1StrLength;i++)words[i>>>2]|=(255&latin1Str.charCodeAt(i))<<24-i%4*8;return new WordArray.init(words,latin1StrLength)}},Utf8=C_enc.Utf8={stringify:function(wordArray){try{return decodeURIComponent(escape(Latin1.stringify(wordArray)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(utf8Str){return Latin1.parse(unescape(encodeURIComponent(utf8Str)))}},BufferedBlockAlgorithm=C_lib.BufferedBlockAlgorithm=Base.extend({reset:function(){this._data=new WordArray.init,this._nDataBytes=0},_append:function(data){"string"==typeof data&&(data=Utf8.parse(data)),this._data.concat(data),this._nDataBytes+=data.sigBytes},_process:function(doFlush){var processedWords,data=this._data,dataWords=data.words,dataSigBytes=data.sigBytes,blockSize=this.blockSize,nBlocksReady=dataSigBytes/(4*blockSize),nWordsReady=(nBlocksReady=doFlush?Math.ceil(nBlocksReady):Math.max((0|nBlocksReady)-this._minBufferSize,0))*blockSize,nBytesReady=Math.min(4*nWordsReady,dataSigBytes);if(nWordsReady){for(var offset=0;offset<nWordsReady;offset+=blockSize)this._doProcessBlock(dataWords,offset);processedWords=dataWords.splice(0,nWordsReady),data.sigBytes-=nBytesReady}return new WordArray.init(processedWords,nBytesReady)},clone:function(){var clone=Base.clone.call(this);return clone._data=this._data.clone(),clone},_minBufferSize:0}),C_algo=(C_lib.Hasher=BufferedBlockAlgorithm.extend({cfg:Base.extend(),init:function(cfg){this.cfg=this.cfg.extend(cfg),this.reset()},reset:function(){BufferedBlockAlgorithm.reset.call(this),this._doReset()},update:function(messageUpdate){return this._append(messageUpdate),this._process(),this},finalize:function(messageUpdate){return messageUpdate&&this._append(messageUpdate),this._doFinalize()},blockSize:16,_createHelper:function(hasher){return function(message,cfg){return new hasher.init(cfg).finalize(message)}},_createHmacHelper:function(hasher){return function(message,key){return new C_algo.HMAC.init(hasher,key).finalize(message)}}}),C.algo={});return C}(Math);return CryptoJS}()}).call(this,__webpack_require__(10))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return CryptoJS}(__webpack_require__(2),__webpack_require__(33),__webpack_require__(194),__webpack_require__(195),__webpack_require__(18),__webpack_require__(19),__webpack_require__(46),__webpack_require__(83),__webpack_require__(196),__webpack_require__(84),__webpack_require__(197),__webpack_require__(198),__webpack_require__(199),__webpack_require__(47),__webpack_require__(200),__webpack_require__(15),__webpack_require__(7),__webpack_require__(201),__webpack_require__(202),__webpack_require__(203),__webpack_require__(204),__webpack_require__(205),__webpack_require__(206),__webpack_require__(207),__webpack_require__(208),__webpack_require__(209),__webpack_require__(210),__webpack_require__(211),__webpack_require__(212),__webpack_require__(213),__webpack_require__(214),__webpack_require__(215),__webpack_require__(216))},function(module,exports,__webpack_require__){var buffer=__webpack_require__(5),Buffer=buffer.Buffer;function copyProps(src,dst){for(var key in src)dst[key]=src[key]}function SafeBuffer(arg,encodingOrOffset,length){return Buffer(arg,encodingOrOffset,length)}Buffer.from&&Buffer.alloc&&Buffer.allocUnsafe&&Buffer.allocUnsafeSlow?module.exports=buffer:(copyProps(buffer,exports),exports.Buffer=SafeBuffer),copyProps(Buffer,SafeBuffer),SafeBuffer.from=function(arg,encodingOrOffset,length){if("number"==typeof arg)throw new TypeError("Argument must not be a number");return Buffer(arg,encodingOrOffset,length)},SafeBuffer.alloc=function(size,fill,encoding){if("number"!=typeof size)throw new TypeError("Argument must be a number");var buf=Buffer(size);return void 0!==fill?"string"==typeof encoding?buf.fill(fill,encoding):buf.fill(fill):buf.fill(0),buf},SafeBuffer.allocUnsafe=function(size){if("number"!=typeof size)throw new TypeError("Argument must be a number");return Buffer(size)},SafeBuffer.allocUnsafeSlow=function(size){if("number"!=typeof size)throw new TypeError("Argument must be a number");return buffer.SlowBuffer(size)}},function(module,exports,__webpack_require__){"use strict";(function(global){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
var base64=__webpack_require__(109),ieee754=__webpack_require__(110),isArray=__webpack_require__(48);function kMaxLength(){return Buffer.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function createBuffer(that,length){if(kMaxLength()<length)throw new RangeError("Invalid typed array length");return Buffer.TYPED_ARRAY_SUPPORT?(that=new Uint8Array(length)).__proto__=Buffer.prototype:(null===that&&(that=new Buffer(length)),that.length=length),that}function Buffer(arg,encodingOrOffset,length){if(!(Buffer.TYPED_ARRAY_SUPPORT||this instanceof Buffer))return new Buffer(arg,encodingOrOffset,length);if("number"==typeof arg){if("string"==typeof encodingOrOffset)throw new Error("If encoding is specified then the first argument must be a string");return allocUnsafe(this,arg)}return from(this,arg,encodingOrOffset,length)}function from(that,value,encodingOrOffset,length){if("number"==typeof value)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&value instanceof ArrayBuffer?function(that,array,byteOffset,length){if(array.byteLength,byteOffset<0||array.byteLength<byteOffset)throw new RangeError("'offset' is out of bounds");if(array.byteLength<byteOffset+(length||0))throw new RangeError("'length' is out of bounds");array=void 0===byteOffset&&void 0===length?new Uint8Array(array):void 0===length?new Uint8Array(array,byteOffset):new Uint8Array(array,byteOffset,length);Buffer.TYPED_ARRAY_SUPPORT?(that=array).__proto__=Buffer.prototype:that=fromArrayLike(that,array);return that}(that,value,encodingOrOffset,length):"string"==typeof value?function(that,string,encoding){"string"==typeof encoding&&""!==encoding||(encoding="utf8");if(!Buffer.isEncoding(encoding))throw new TypeError('"encoding" must be a valid string encoding');var length=0|byteLength(string,encoding),actual=(that=createBuffer(that,length)).write(string,encoding);actual!==length&&(that=that.slice(0,actual));return that}(that,value,encodingOrOffset):function(that,obj){if(Buffer.isBuffer(obj)){var len=0|checked(obj.length);return 0===(that=createBuffer(that,len)).length?that:(obj.copy(that,0,0,len),that)}if(obj){if("undefined"!=typeof ArrayBuffer&&obj.buffer instanceof ArrayBuffer||"length"in obj)return"number"!=typeof obj.length||(val=obj.length)!=val?createBuffer(that,0):fromArrayLike(that,obj);if("Buffer"===obj.type&&isArray(obj.data))return fromArrayLike(that,obj.data)}var val;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(that,value)}function assertSize(size){if("number"!=typeof size)throw new TypeError('"size" argument must be a number');if(size<0)throw new RangeError('"size" argument must not be negative')}function allocUnsafe(that,size){if(assertSize(size),that=createBuffer(that,size<0?0:0|checked(size)),!Buffer.TYPED_ARRAY_SUPPORT)for(var i=0;i<size;++i)that[i]=0;return that}function fromArrayLike(that,array){var length=array.length<0?0:0|checked(array.length);that=createBuffer(that,length);for(var i=0;i<length;i+=1)that[i]=255&array[i];return that}function checked(length){if(length>=kMaxLength())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+kMaxLength().toString(16)+" bytes");return 0|length}function byteLength(string,encoding){if(Buffer.isBuffer(string))return string.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(string)||string instanceof ArrayBuffer))return string.byteLength;"string"!=typeof string&&(string=""+string);var len=string.length;if(0===len)return 0;for(var loweredCase=!1;;)switch(encoding){case"ascii":case"latin1":case"binary":return len;case"utf8":case"utf-8":case void 0:return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*len;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase)return utf8ToBytes(string).length;encoding=(""+encoding).toLowerCase(),loweredCase=!0}}function slowToString(encoding,start,end){var loweredCase=!1;if((void 0===start||start<0)&&(start=0),start>this.length)return"";if((void 0===end||end>this.length)&&(end=this.length),end<=0)return"";if((end>>>=0)<=(start>>>=0))return"";for(encoding||(encoding="utf8");;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"latin1":case"binary":return latin1Slice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}}function swap(b,n,m){var i=b[n];b[n]=b[m],b[m]=i}function bidirectionalIndexOf(buffer,val,byteOffset,encoding,dir){if(0===buffer.length)return-1;if("string"==typeof byteOffset?(encoding=byteOffset,byteOffset=0):byteOffset>2147483647?byteOffset=2147483647:byteOffset<-2147483648&&(byteOffset=-2147483648),byteOffset=+byteOffset,isNaN(byteOffset)&&(byteOffset=dir?0:buffer.length-1),byteOffset<0&&(byteOffset=buffer.length+byteOffset),byteOffset>=buffer.length){if(dir)return-1;byteOffset=buffer.length-1}else if(byteOffset<0){if(!dir)return-1;byteOffset=0}if("string"==typeof val&&(val=Buffer.from(val,encoding)),Buffer.isBuffer(val))return 0===val.length?-1:arrayIndexOf(buffer,val,byteOffset,encoding,dir);if("number"==typeof val)return val&=255,Buffer.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?dir?Uint8Array.prototype.indexOf.call(buffer,val,byteOffset):Uint8Array.prototype.lastIndexOf.call(buffer,val,byteOffset):arrayIndexOf(buffer,[val],byteOffset,encoding,dir);throw new TypeError("val must be string, number or Buffer")}function arrayIndexOf(arr,val,byteOffset,encoding,dir){var i,indexSize=1,arrLength=arr.length,valLength=val.length;if(void 0!==encoding&&("ucs2"===(encoding=String(encoding).toLowerCase())||"ucs-2"===encoding||"utf16le"===encoding||"utf-16le"===encoding)){if(arr.length<2||val.length<2)return-1;indexSize=2,arrLength/=2,valLength/=2,byteOffset/=2}function read(buf,i){return 1===indexSize?buf[i]:buf.readUInt16BE(i*indexSize)}if(dir){var foundIndex=-1;for(i=byteOffset;i<arrLength;i++)if(read(arr,i)===read(val,-1===foundIndex?0:i-foundIndex)){if(-1===foundIndex&&(foundIndex=i),i-foundIndex+1===valLength)return foundIndex*indexSize}else-1!==foundIndex&&(i-=i-foundIndex),foundIndex=-1}else for(byteOffset+valLength>arrLength&&(byteOffset=arrLength-valLength),i=byteOffset;i>=0;i--){for(var found=!0,j=0;j<valLength;j++)if(read(arr,i+j)!==read(val,j)){found=!1;break}if(found)return i}return-1}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?(length=Number(length))>remaining&&(length=remaining):length=remaining;var strLen=string.length;if(strLen%2!=0)throw new TypeError("Invalid hex string");length>strLen/2&&(length=strLen/2);for(var i=0;i<length;++i){var parsed=parseInt(string.substr(2*i,2),16);if(isNaN(parsed))return i;buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(function(str){for(var byteArray=[],i=0;i<str.length;++i)byteArray.push(255&str.charCodeAt(i));return byteArray}(string),buf,offset,length)}function latin1Write(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(function(str,units){for(var c,hi,lo,byteArray=[],i=0;i<str.length&&!((units-=2)<0);++i)c=str.charCodeAt(i),hi=c>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}(string,buf.length-offset),buf,offset,length)}function base64Slice(buf,start,end){return 0===start&&end===buf.length?base64.fromByteArray(buf):base64.fromByteArray(buf.slice(start,end))}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);for(var res=[],i=start;i<end;){var secondByte,thirdByte,fourthByte,tempCodePoint,firstByte=buf[i],codePoint=null,bytesPerSequence=firstByte>239?4:firstByte>223?3:firstByte>191?2:1;if(i+bytesPerSequence<=end)switch(bytesPerSequence){case 1:firstByte<128&&(codePoint=firstByte);break;case 2:128==(192&(secondByte=buf[i+1]))&&(tempCodePoint=(31&firstByte)<<6|63&secondByte)>127&&(codePoint=tempCodePoint);break;case 3:secondByte=buf[i+1],thirdByte=buf[i+2],128==(192&secondByte)&&128==(192&thirdByte)&&(tempCodePoint=(15&firstByte)<<12|(63&secondByte)<<6|63&thirdByte)>2047&&(tempCodePoint<55296||tempCodePoint>57343)&&(codePoint=tempCodePoint);break;case 4:secondByte=buf[i+1],thirdByte=buf[i+2],fourthByte=buf[i+3],128==(192&secondByte)&&128==(192&thirdByte)&&128==(192&fourthByte)&&(tempCodePoint=(15&firstByte)<<18|(63&secondByte)<<12|(63&thirdByte)<<6|63&fourthByte)>65535&&tempCodePoint<1114112&&(codePoint=tempCodePoint)}null===codePoint?(codePoint=65533,bytesPerSequence=1):codePoint>65535&&(codePoint-=65536,res.push(codePoint>>>10&1023|55296),codePoint=56320|1023&codePoint),res.push(codePoint),i+=bytesPerSequence}return function(codePoints){var len=codePoints.length;if(len<=MAX_ARGUMENTS_LENGTH)return String.fromCharCode.apply(String,codePoints);var res="",i=0;for(;i<len;)res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH));return res}(res)}exports.Buffer=Buffer,exports.SlowBuffer=function(length){+length!=length&&(length=0);return Buffer.alloc(+length)},exports.INSPECT_MAX_BYTES=50,Buffer.TYPED_ARRAY_SUPPORT=void 0!==global.TYPED_ARRAY_SUPPORT?global.TYPED_ARRAY_SUPPORT:function(){try{var arr=new Uint8Array(1);return arr.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===arr.foo()&&"function"==typeof arr.subarray&&0===arr.subarray(1,1).byteLength}catch(e){return!1}}(),exports.kMaxLength=kMaxLength(),Buffer.poolSize=8192,Buffer._augment=function(arr){return arr.__proto__=Buffer.prototype,arr},Buffer.from=function(value,encodingOrOffset,length){return from(null,value,encodingOrOffset,length)},Buffer.TYPED_ARRAY_SUPPORT&&(Buffer.prototype.__proto__=Uint8Array.prototype,Buffer.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&Buffer[Symbol.species]===Buffer&&Object.defineProperty(Buffer,Symbol.species,{value:null,configurable:!0})),Buffer.alloc=function(size,fill,encoding){return function(that,size,fill,encoding){return assertSize(size),size<=0?createBuffer(that,size):void 0!==fill?"string"==typeof encoding?createBuffer(that,size).fill(fill,encoding):createBuffer(that,size).fill(fill):createBuffer(that,size)}(null,size,fill,encoding)},Buffer.allocUnsafe=function(size){return allocUnsafe(null,size)},Buffer.allocUnsafeSlow=function(size){return allocUnsafe(null,size)},Buffer.isBuffer=function(b){return!(null==b||!b._isBuffer)},Buffer.compare=function(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError("Arguments must be Buffers");if(a===b)return 0;for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);i<len;++i)if(a[i]!==b[i]){x=a[i],y=b[i];break}return x<y?-1:y<x?1:0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,length){if(!isArray(list))throw new TypeError('"list" argument must be an Array of Buffers');if(0===list.length)return Buffer.alloc(0);var i;if(void 0===length)for(length=0,i=0;i<list.length;++i)length+=list[i].length;var buffer=Buffer.allocUnsafe(length),pos=0;for(i=0;i<list.length;++i){var buf=list[i];if(!Buffer.isBuffer(buf))throw new TypeError('"list" argument must be an Array of Buffers');buf.copy(buffer,pos),pos+=buf.length}return buffer},Buffer.byteLength=byteLength,Buffer.prototype._isBuffer=!0,Buffer.prototype.swap16=function(){var len=this.length;if(len%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var i=0;i<len;i+=2)swap(this,i,i+1);return this},Buffer.prototype.swap32=function(){var len=this.length;if(len%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var i=0;i<len;i+=4)swap(this,i,i+3),swap(this,i+1,i+2);return this},Buffer.prototype.swap64=function(){var len=this.length;if(len%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var i=0;i<len;i+=8)swap(this,i,i+7),swap(this,i+1,i+6),swap(this,i+2,i+5),swap(this,i+3,i+4);return this},Buffer.prototype.toString=function(){var length=0|this.length;return 0===length?"":0===arguments.length?utf8Slice(this,0,length):slowToString.apply(this,arguments)},Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return this===b||0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="",max=exports.INSPECT_MAX_BYTES;return this.length>0&&(str=this.toString("hex",0,max).match(/.{2}/g).join(" "),this.length>max&&(str+=" ... ")),"<Buffer "+str+">"},Buffer.prototype.compare=function(target,start,end,thisStart,thisEnd){if(!Buffer.isBuffer(target))throw new TypeError("Argument must be a Buffer");if(void 0===start&&(start=0),void 0===end&&(end=target?target.length:0),void 0===thisStart&&(thisStart=0),void 0===thisEnd&&(thisEnd=this.length),start<0||end>target.length||thisStart<0||thisEnd>this.length)throw new RangeError("out of range index");if(thisStart>=thisEnd&&start>=end)return 0;if(thisStart>=thisEnd)return-1;if(start>=end)return 1;if(this===target)return 0;for(var x=(thisEnd>>>=0)-(thisStart>>>=0),y=(end>>>=0)-(start>>>=0),len=Math.min(x,y),thisCopy=this.slice(thisStart,thisEnd),targetCopy=target.slice(start,end),i=0;i<len;++i)if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i],y=targetCopy[i];break}return x<y?-1:y<x?1:0},Buffer.prototype.includes=function(val,byteOffset,encoding){return-1!==this.indexOf(val,byteOffset,encoding)},Buffer.prototype.indexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!0)},Buffer.prototype.lastIndexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!1)},Buffer.prototype.write=function(string,offset,length,encoding){if(void 0===offset)encoding="utf8",length=this.length,offset=0;else if(void 0===length&&"string"==typeof offset)encoding=offset,length=this.length,offset=0;else{if(!isFinite(offset))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");offset|=0,isFinite(length)?(length|=0,void 0===encoding&&(encoding="utf8")):(encoding=length,length=void 0)}var remaining=this.length-offset;if((void 0===length||length>remaining)&&(length=remaining),string.length>0&&(length<0||offset<0)||offset>this.length)throw new RangeError("Attempt to write outside buffer bounds");encoding||(encoding="utf8");for(var loweredCase=!1;;)switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"latin1":case"binary":return latin1Write(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase(),loweredCase=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var MAX_ARGUMENTS_LENGTH=4096;function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(127&buf[i]);return ret}function latin1Slice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(buf[i]);return ret}function hexSlice(buf,start,end){var len=buf.length;(!start||start<0)&&(start=0),(!end||end<0||end>len)&&(end=len);for(var out="",i=start;i<end;++i)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){for(var bytes=buf.slice(start,end),res="",i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!=0||offset<0)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(value>max||value<min)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError("Index out of range")}function objectWriteUInt16(buf,value,offset,littleEndian){value<0&&(value=65535+value+1);for(var i=0,j=Math.min(buf.length-offset,2);i<j;++i)buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>8*(littleEndian?i:1-i)}function objectWriteUInt32(buf,value,offset,littleEndian){value<0&&(value=4294967295+value+1);for(var i=0,j=Math.min(buf.length-offset,4);i<j;++i)buf[offset+i]=value>>>8*(littleEndian?i:3-i)&255}function checkIEEE754(buf,value,offset,ext,max,min){if(offset+ext>buf.length)throw new RangeError("Index out of range");if(offset<0)throw new RangeError("Index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,0,offset,4),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,0,offset,8),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}Buffer.prototype.slice=function(start,end){var newBuf,len=this.length;if((start=~~start)<0?(start+=len)<0&&(start=0):start>len&&(start=len),(end=void 0===end?len:~~end)<0?(end+=len)<0&&(end=0):end>len&&(end=len),end<start&&(end=start),Buffer.TYPED_ARRAY_SUPPORT)(newBuf=this.subarray(start,end)).__proto__=Buffer.prototype;else{var sliceLen=end-start;newBuf=new Buffer(sliceLen,void 0);for(var i=0;i<sliceLen;++i)newBuf[i]=this[i+start]}return newBuf},Buffer.prototype.readUIntLE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val},Buffer.prototype.readUIntBE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset+--byteLength],mul=1;byteLength>0&&(mul*=256);)val+=this[offset+--byteLength]*mul;return val},Buffer.prototype.readUInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readIntLE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val>=(mul*=128)&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readIntBE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var i=byteLength,mul=1,val=this[offset+--i];i>0&&(mul*=256);)val+=this[offset+--i]*mul;return val>=(mul*=128)&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),128&this[offset]?-1*(255-this[offset]+1):this[offset]},Buffer.prototype.readInt16LE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4)},Buffer.prototype.readDoubleLE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUIntLE=function(value,offset,byteLength,noAssert){(value=+value,offset|=0,byteLength|=0,noAssert)||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength)-1,0);var mul=1,i=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUIntBE=function(value,offset,byteLength,noAssert){(value=+value,offset|=0,byteLength|=0,noAssert)||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength)-1,0);var i=byteLength-1,mul=1;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,1,255,0),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),this[offset]=255&value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=255&value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=255&value):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeIntLE=function(value,offset,byteLength,noAssert){if(value=+value,offset|=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0,mul=1,sub=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i-1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeIntBE=function(value,offset,byteLength,noAssert){if(value=+value,offset|=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1,mul=1,sub=0;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i+1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,1,127,-128),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),value<0&&(value=255+value+1),this[offset]=255&value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=255&value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),value<0&&(value=4294967295+value+1),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,targetStart,start,end){if(start||(start=0),end||0===end||(end=this.length),targetStart>=target.length&&(targetStart=target.length),targetStart||(targetStart=0),end>0&&end<start&&(end=start),end===start)return 0;if(0===target.length||0===this.length)return 0;if(targetStart<0)throw new RangeError("targetStart out of bounds");if(start<0||start>=this.length)throw new RangeError("sourceStart out of bounds");if(end<0)throw new RangeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-targetStart<end-start&&(end=target.length-targetStart+start);var i,len=end-start;if(this===target&&start<targetStart&&targetStart<end)for(i=len-1;i>=0;--i)target[i+targetStart]=this[i+start];else if(len<1e3||!Buffer.TYPED_ARRAY_SUPPORT)for(i=0;i<len;++i)target[i+targetStart]=this[i+start];else Uint8Array.prototype.set.call(target,this.subarray(start,start+len),targetStart);return len},Buffer.prototype.fill=function(val,start,end,encoding){if("string"==typeof val){if("string"==typeof start?(encoding=start,start=0,end=this.length):"string"==typeof end&&(encoding=end,end=this.length),1===val.length){var code=val.charCodeAt(0);code<256&&(val=code)}if(void 0!==encoding&&"string"!=typeof encoding)throw new TypeError("encoding must be a string");if("string"==typeof encoding&&!Buffer.isEncoding(encoding))throw new TypeError("Unknown encoding: "+encoding)}else"number"==typeof val&&(val&=255);if(start<0||this.length<start||this.length<end)throw new RangeError("Out of range index");if(end<=start)return this;var i;if(start>>>=0,end=void 0===end?this.length:end>>>0,val||(val=0),"number"==typeof val)for(i=start;i<end;++i)this[i]=val;else{var bytes=Buffer.isBuffer(val)?val:utf8ToBytes(new Buffer(val,encoding).toString()),len=bytes.length;for(i=0;i<end-start;++i)this[i+start]=bytes[i%len]}return this};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g;function toHex(n){return n<16?"0"+n.toString(16):n.toString(16)}function utf8ToBytes(string,units){var codePoint;units=units||1/0;for(var length=string.length,leadSurrogate=null,bytes=[],i=0;i<length;++i){if((codePoint=string.charCodeAt(i))>55295&&codePoint<57344){if(!leadSurrogate){if(codePoint>56319){(units-=3)>-1&&bytes.push(239,191,189);continue}if(i+1===length){(units-=3)>-1&&bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(codePoint<56320){(units-=3)>-1&&bytes.push(239,191,189),leadSurrogate=codePoint;continue}codePoint=65536+(leadSurrogate-55296<<10|codePoint-56320)}else leadSurrogate&&(units-=3)>-1&&bytes.push(239,191,189);if(leadSurrogate=null,codePoint<128){if((units-=1)<0)break;bytes.push(codePoint)}else if(codePoint<2048){if((units-=2)<0)break;bytes.push(codePoint>>6|192,63&codePoint|128)}else if(codePoint<65536){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,63&codePoint|128)}else{if(!(codePoint<1114112))throw new Error("Invalid code point");if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,63&codePoint|128)}}return bytes}function base64ToBytes(str){return base64.toByteArray(function(str){if((str=function(str){return str.trim?str.trim():str.replace(/^\s+|\s+$/g,"")}(str).replace(INVALID_BASE64_RE,"")).length<2)return"";for(;str.length%4!=0;)str+="=";return str}(str))}function blitBuffer(src,dst,offset,length){for(var i=0;i<length&&!(i+offset>=dst.length||i>=src.length);++i)dst[i+offset]=src[i];return i}}).call(this,__webpack_require__(10))},function(module,exports,__webpack_require__){(function(module){!function(module,exports){"use strict";function assert(val,msg){if(!val)throw new Error(msg||"Assertion failed")}function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}function BN(number,base,endian){if(BN.isBN(number))return number;this.negative=0,this.words=null,this.length=0,this.red=null,null!==number&&("le"!==base&&"be"!==base||(endian=base,base=10),this._init(number||0,base||10,endian||"be"))}var Buffer;"object"==typeof module?module.exports=BN:exports.BN=BN,BN.BN=BN,BN.wordSize=26;try{Buffer=__webpack_require__(148).Buffer}catch(e){}function parseHex(str,start,end){for(var r=0,len=Math.min(str.length,end),i=start;i<len;i++){var c=str.charCodeAt(i)-48;r<<=4,r|=c>=49&&c<=54?c-49+10:c>=17&&c<=22?c-17+10:15&c}return r}function parseBase(str,start,end,mul){for(var r=0,len=Math.min(str.length,end),i=start;i<len;i++){var c=str.charCodeAt(i)-48;r*=mul,r+=c>=49?c-49+10:c>=17?c-17+10:c}return r}BN.isBN=function(num){return num instanceof BN||null!==num&&"object"==typeof num&&num.constructor.wordSize===BN.wordSize&&Array.isArray(num.words)},BN.max=function(left,right){return left.cmp(right)>0?left:right},BN.min=function(left,right){return left.cmp(right)<0?left:right},BN.prototype._init=function(number,base,endian){if("number"==typeof number)return this._initNumber(number,base,endian);if("object"==typeof number)return this._initArray(number,base,endian);"hex"===base&&(base=16),assert(base===(0|base)&&base>=2&&base<=36);var start=0;"-"===(number=number.toString().replace(/\s+/g,""))[0]&&start++,16===base?this._parseHex(number,start):this._parseBase(number,base,start),"-"===number[0]&&(this.negative=1),this.strip(),"le"===endian&&this._initArray(this.toArray(),base,endian)},BN.prototype._initNumber=function(number,base,endian){number<0&&(this.negative=1,number=-number),number<67108864?(this.words=[67108863&number],this.length=1):number<4503599627370496?(this.words=[67108863&number,number/67108864&67108863],this.length=2):(assert(number<9007199254740992),this.words=[67108863&number,number/67108864&67108863,1],this.length=3),"le"===endian&&this._initArray(this.toArray(),base,endian)},BN.prototype._initArray=function(number,base,endian){if(assert("number"==typeof number.length),number.length<=0)return this.words=[0],this.length=1,this;this.length=Math.ceil(number.length/3),this.words=new Array(this.length);for(var i=0;i<this.length;i++)this.words[i]=0;var j,w,off=0;if("be"===endian)for(i=number.length-1,j=0;i>=0;i-=3)w=number[i]|number[i-1]<<8|number[i-2]<<16,this.words[j]|=w<<off&67108863,this.words[j+1]=w>>>26-off&67108863,(off+=24)>=26&&(off-=26,j++);else if("le"===endian)for(i=0,j=0;i<number.length;i+=3)w=number[i]|number[i+1]<<8|number[i+2]<<16,this.words[j]|=w<<off&67108863,this.words[j+1]=w>>>26-off&67108863,(off+=24)>=26&&(off-=26,j++);return this.strip()},BN.prototype._parseHex=function(number,start){this.length=Math.ceil((number.length-start)/6),this.words=new Array(this.length);for(var i=0;i<this.length;i++)this.words[i]=0;var j,w,off=0;for(i=number.length-6,j=0;i>=start;i-=6)w=parseHex(number,i,i+6),this.words[j]|=w<<off&67108863,this.words[j+1]|=w>>>26-off&4194303,(off+=24)>=26&&(off-=26,j++);i+6!==start&&(w=parseHex(number,start,i+6),this.words[j]|=w<<off&67108863,this.words[j+1]|=w>>>26-off&4194303),this.strip()},BN.prototype._parseBase=function(number,base,start){this.words=[0],this.length=1;for(var limbLen=0,limbPow=1;limbPow<=67108863;limbPow*=base)limbLen++;limbLen--,limbPow=limbPow/base|0;for(var total=number.length-start,mod=total%limbLen,end=Math.min(total,total-mod)+start,word=0,i=start;i<end;i+=limbLen)word=parseBase(number,i,i+limbLen,base),this.imuln(limbPow),this.words[0]+word<67108864?this.words[0]+=word:this._iaddn(word);if(0!==mod){var pow=1;for(word=parseBase(number,i,number.length,base),i=0;i<mod;i++)pow*=base;this.imuln(pow),this.words[0]+word<67108864?this.words[0]+=word:this._iaddn(word)}},BN.prototype.copy=function(dest){dest.words=new Array(this.length);for(var i=0;i<this.length;i++)dest.words[i]=this.words[i];dest.length=this.length,dest.negative=this.negative,dest.red=this.red},BN.prototype.clone=function(){var r=new BN(null);return this.copy(r),r},BN.prototype._expand=function(size){for(;this.length<size;)this.words[this.length++]=0;return this},BN.prototype.strip=function(){for(;this.length>1&&0===this.words[this.length-1];)this.length--;return this._normSign()},BN.prototype._normSign=function(){return 1===this.length&&0===this.words[0]&&(this.negative=0),this},BN.prototype.inspect=function(){return(this.red?"<BN-R: ":"<BN: ")+this.toString(16)+">"};var zeros=["","0","00","000","0000","00000","000000","0000000","00000000","000000000","0000000000","00000000000","000000000000","0000000000000","00000000000000","000000000000000","0000000000000000","00000000000000000","000000000000000000","0000000000000000000","00000000000000000000","000000000000000000000","0000000000000000000000","00000000000000000000000","000000000000000000000000","0000000000000000000000000"],groupSizes=[0,0,25,16,12,11,10,9,8,8,7,7,7,7,6,6,6,6,6,6,6,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5],groupBases=[0,0,33554432,43046721,16777216,48828125,60466176,40353607,16777216,43046721,1e7,19487171,35831808,62748517,7529536,11390625,16777216,24137569,34012224,47045881,64e6,4084101,5153632,6436343,7962624,9765625,11881376,14348907,17210368,20511149,243e5,28629151,33554432,39135393,45435424,52521875,60466176];function smallMulTo(self,num,out){out.negative=num.negative^self.negative;var len=self.length+num.length|0;out.length=len,len=len-1|0;var a=0|self.words[0],b=0|num.words[0],r=a*b,lo=67108863&r,carry=r/67108864|0;out.words[0]=lo;for(var k=1;k<len;k++){for(var ncarry=carry>>>26,rword=67108863&carry,maxJ=Math.min(k,num.length-1),j=Math.max(0,k-self.length+1);j<=maxJ;j++){var i=k-j|0;ncarry+=(r=(a=0|self.words[i])*(b=0|num.words[j])+rword)/67108864|0,rword=67108863&r}out.words[k]=0|rword,carry=0|ncarry}return 0!==carry?out.words[k]=0|carry:out.length--,out.strip()}BN.prototype.toString=function(base,padding){var out;if(padding=0|padding||1,16===(base=base||10)||"hex"===base){out="";for(var off=0,carry=0,i=0;i<this.length;i++){var w=this.words[i],word=(16777215&(w<<off|carry)).toString(16);out=0!==(carry=w>>>24-off&16777215)||i!==this.length-1?zeros[6-word.length]+word+out:word+out,(off+=2)>=26&&(off-=26,i--)}for(0!==carry&&(out=carry.toString(16)+out);out.length%padding!=0;)out="0"+out;return 0!==this.negative&&(out="-"+out),out}if(base===(0|base)&&base>=2&&base<=36){var groupSize=groupSizes[base],groupBase=groupBases[base];out="";var c=this.clone();for(c.negative=0;!c.isZero();){var r=c.modn(groupBase).toString(base);out=(c=c.idivn(groupBase)).isZero()?r+out:zeros[groupSize-r.length]+r+out}for(this.isZero()&&(out="0"+out);out.length%padding!=0;)out="0"+out;return 0!==this.negative&&(out="-"+out),out}assert(!1,"Base should be between 2 and 36")},BN.prototype.toNumber=function(){var ret=this.words[0];return 2===this.length?ret+=67108864*this.words[1]:3===this.length&&1===this.words[2]?ret+=4503599627370496+67108864*this.words[1]:this.length>2&&assert(!1,"Number can only safely store up to 53 bits"),0!==this.negative?-ret:ret},BN.prototype.toJSON=function(){return this.toString(16)},BN.prototype.toBuffer=function(endian,length){return assert(void 0!==Buffer),this.toArrayLike(Buffer,endian,length)},BN.prototype.toArray=function(endian,length){return this.toArrayLike(Array,endian,length)},BN.prototype.toArrayLike=function(ArrayType,endian,length){var byteLength=this.byteLength(),reqLength=length||Math.max(1,byteLength);assert(byteLength<=reqLength,"byte array longer than desired length"),assert(reqLength>0,"Requested array length <= 0"),this.strip();var b,i,littleEndian="le"===endian,res=new ArrayType(reqLength),q=this.clone();if(littleEndian){for(i=0;!q.isZero();i++)b=q.andln(255),q.iushrn(8),res[i]=b;for(;i<reqLength;i++)res[i]=0}else{for(i=0;i<reqLength-byteLength;i++)res[i]=0;for(i=0;!q.isZero();i++)b=q.andln(255),q.iushrn(8),res[reqLength-i-1]=b}return res},Math.clz32?BN.prototype._countBits=function(w){return 32-Math.clz32(w)}:BN.prototype._countBits=function(w){var t=w,r=0;return t>=4096&&(r+=13,t>>>=13),t>=64&&(r+=7,t>>>=7),t>=8&&(r+=4,t>>>=4),t>=2&&(r+=2,t>>>=2),r+t},BN.prototype._zeroBits=function(w){if(0===w)return 26;var t=w,r=0;return 0==(8191&t)&&(r+=13,t>>>=13),0==(127&t)&&(r+=7,t>>>=7),0==(15&t)&&(r+=4,t>>>=4),0==(3&t)&&(r+=2,t>>>=2),0==(1&t)&&r++,r},BN.prototype.bitLength=function(){var w=this.words[this.length-1],hi=this._countBits(w);return 26*(this.length-1)+hi},BN.prototype.zeroBits=function(){if(this.isZero())return 0;for(var r=0,i=0;i<this.length;i++){var b=this._zeroBits(this.words[i]);if(r+=b,26!==b)break}return r},BN.prototype.byteLength=function(){return Math.ceil(this.bitLength()/8)},BN.prototype.toTwos=function(width){return 0!==this.negative?this.abs().inotn(width).iaddn(1):this.clone()},BN.prototype.fromTwos=function(width){return this.testn(width-1)?this.notn(width).iaddn(1).ineg():this.clone()},BN.prototype.isNeg=function(){return 0!==this.negative},BN.prototype.neg=function(){return this.clone().ineg()},BN.prototype.ineg=function(){return this.isZero()||(this.negative^=1),this},BN.prototype.iuor=function(num){for(;this.length<num.length;)this.words[this.length++]=0;for(var i=0;i<num.length;i++)this.words[i]=this.words[i]|num.words[i];return this.strip()},BN.prototype.ior=function(num){return assert(0==(this.negative|num.negative)),this.iuor(num)},BN.prototype.or=function(num){return this.length>num.length?this.clone().ior(num):num.clone().ior(this)},BN.prototype.uor=function(num){return this.length>num.length?this.clone().iuor(num):num.clone().iuor(this)},BN.prototype.iuand=function(num){var b;b=this.length>num.length?num:this;for(var i=0;i<b.length;i++)this.words[i]=this.words[i]&num.words[i];return this.length=b.length,this.strip()},BN.prototype.iand=function(num){return assert(0==(this.negative|num.negative)),this.iuand(num)},BN.prototype.and=function(num){return this.length>num.length?this.clone().iand(num):num.clone().iand(this)},BN.prototype.uand=function(num){return this.length>num.length?this.clone().iuand(num):num.clone().iuand(this)},BN.prototype.iuxor=function(num){var a,b;this.length>num.length?(a=this,b=num):(a=num,b=this);for(var i=0;i<b.length;i++)this.words[i]=a.words[i]^b.words[i];if(this!==a)for(;i<a.length;i++)this.words[i]=a.words[i];return this.length=a.length,this.strip()},BN.prototype.ixor=function(num){return assert(0==(this.negative|num.negative)),this.iuxor(num)},BN.prototype.xor=function(num){return this.length>num.length?this.clone().ixor(num):num.clone().ixor(this)},BN.prototype.uxor=function(num){return this.length>num.length?this.clone().iuxor(num):num.clone().iuxor(this)},BN.prototype.inotn=function(width){assert("number"==typeof width&&width>=0);var bytesNeeded=0|Math.ceil(width/26),bitsLeft=width%26;this._expand(bytesNeeded),bitsLeft>0&&bytesNeeded--;for(var i=0;i<bytesNeeded;i++)this.words[i]=67108863&~this.words[i];return bitsLeft>0&&(this.words[i]=~this.words[i]&67108863>>26-bitsLeft),this.strip()},BN.prototype.notn=function(width){return this.clone().inotn(width)},BN.prototype.setn=function(bit,val){assert("number"==typeof bit&&bit>=0);var off=bit/26|0,wbit=bit%26;return this._expand(off+1),this.words[off]=val?this.words[off]|1<<wbit:this.words[off]&~(1<<wbit),this.strip()},BN.prototype.iadd=function(num){var r,a,b;if(0!==this.negative&&0===num.negative)return this.negative=0,r=this.isub(num),this.negative^=1,this._normSign();if(0===this.negative&&0!==num.negative)return num.negative=0,r=this.isub(num),num.negative=1,r._normSign();this.length>num.length?(a=this,b=num):(a=num,b=this);for(var carry=0,i=0;i<b.length;i++)r=(0|a.words[i])+(0|b.words[i])+carry,this.words[i]=67108863&r,carry=r>>>26;for(;0!==carry&&i<a.length;i++)r=(0|a.words[i])+carry,this.words[i]=67108863&r,carry=r>>>26;if(this.length=a.length,0!==carry)this.words[this.length]=carry,this.length++;else if(a!==this)for(;i<a.length;i++)this.words[i]=a.words[i];return this},BN.prototype.add=function(num){var res;return 0!==num.negative&&0===this.negative?(num.negative=0,res=this.sub(num),num.negative^=1,res):0===num.negative&&0!==this.negative?(this.negative=0,res=num.sub(this),this.negative=1,res):this.length>num.length?this.clone().iadd(num):num.clone().iadd(this)},BN.prototype.isub=function(num){if(0!==num.negative){num.negative=0;var r=this.iadd(num);return num.negative=1,r._normSign()}if(0!==this.negative)return this.negative=0,this.iadd(num),this.negative=1,this._normSign();var a,b,cmp=this.cmp(num);if(0===cmp)return this.negative=0,this.length=1,this.words[0]=0,this;cmp>0?(a=this,b=num):(a=num,b=this);for(var carry=0,i=0;i<b.length;i++)carry=(r=(0|a.words[i])-(0|b.words[i])+carry)>>26,this.words[i]=67108863&r;for(;0!==carry&&i<a.length;i++)carry=(r=(0|a.words[i])+carry)>>26,this.words[i]=67108863&r;if(0===carry&&i<a.length&&a!==this)for(;i<a.length;i++)this.words[i]=a.words[i];return this.length=Math.max(this.length,i),a!==this&&(this.negative=1),this.strip()},BN.prototype.sub=function(num){return this.clone().isub(num)};var comb10MulTo=function(self,num,out){var lo,mid,hi,a=self.words,b=num.words,o=out.words,c=0,a0=0|a[0],al0=8191&a0,ah0=a0>>>13,a1=0|a[1],al1=8191&a1,ah1=a1>>>13,a2=0|a[2],al2=8191&a2,ah2=a2>>>13,a3=0|a[3],al3=8191&a3,ah3=a3>>>13,a4=0|a[4],al4=8191&a4,ah4=a4>>>13,a5=0|a[5],al5=8191&a5,ah5=a5>>>13,a6=0|a[6],al6=8191&a6,ah6=a6>>>13,a7=0|a[7],al7=8191&a7,ah7=a7>>>13,a8=0|a[8],al8=8191&a8,ah8=a8>>>13,a9=0|a[9],al9=8191&a9,ah9=a9>>>13,b0=0|b[0],bl0=8191&b0,bh0=b0>>>13,b1=0|b[1],bl1=8191&b1,bh1=b1>>>13,b2=0|b[2],bl2=8191&b2,bh2=b2>>>13,b3=0|b[3],bl3=8191&b3,bh3=b3>>>13,b4=0|b[4],bl4=8191&b4,bh4=b4>>>13,b5=0|b[5],bl5=8191&b5,bh5=b5>>>13,b6=0|b[6],bl6=8191&b6,bh6=b6>>>13,b7=0|b[7],bl7=8191&b7,bh7=b7>>>13,b8=0|b[8],bl8=8191&b8,bh8=b8>>>13,b9=0|b[9],bl9=8191&b9,bh9=b9>>>13;out.negative=self.negative^num.negative,out.length=19;var w0=(c+(lo=Math.imul(al0,bl0))|0)+((8191&(mid=(mid=Math.imul(al0,bh0))+Math.imul(ah0,bl0)|0))<<13)|0;c=((hi=Math.imul(ah0,bh0))+(mid>>>13)|0)+(w0>>>26)|0,w0&=67108863,lo=Math.imul(al1,bl0),mid=(mid=Math.imul(al1,bh0))+Math.imul(ah1,bl0)|0,hi=Math.imul(ah1,bh0);var w1=(c+(lo=lo+Math.imul(al0,bl1)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al0,bh1)|0)+Math.imul(ah0,bl1)|0))<<13)|0;c=((hi=hi+Math.imul(ah0,bh1)|0)+(mid>>>13)|0)+(w1>>>26)|0,w1&=67108863,lo=Math.imul(al2,bl0),mid=(mid=Math.imul(al2,bh0))+Math.imul(ah2,bl0)|0,hi=Math.imul(ah2,bh0),lo=lo+Math.imul(al1,bl1)|0,mid=(mid=mid+Math.imul(al1,bh1)|0)+Math.imul(ah1,bl1)|0,hi=hi+Math.imul(ah1,bh1)|0;var w2=(c+(lo=lo+Math.imul(al0,bl2)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al0,bh2)|0)+Math.imul(ah0,bl2)|0))<<13)|0;c=((hi=hi+Math.imul(ah0,bh2)|0)+(mid>>>13)|0)+(w2>>>26)|0,w2&=67108863,lo=Math.imul(al3,bl0),mid=(mid=Math.imul(al3,bh0))+Math.imul(ah3,bl0)|0,hi=Math.imul(ah3,bh0),lo=lo+Math.imul(al2,bl1)|0,mid=(mid=mid+Math.imul(al2,bh1)|0)+Math.imul(ah2,bl1)|0,hi=hi+Math.imul(ah2,bh1)|0,lo=lo+Math.imul(al1,bl2)|0,mid=(mid=mid+Math.imul(al1,bh2)|0)+Math.imul(ah1,bl2)|0,hi=hi+Math.imul(ah1,bh2)|0;var w3=(c+(lo=lo+Math.imul(al0,bl3)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al0,bh3)|0)+Math.imul(ah0,bl3)|0))<<13)|0;c=((hi=hi+Math.imul(ah0,bh3)|0)+(mid>>>13)|0)+(w3>>>26)|0,w3&=67108863,lo=Math.imul(al4,bl0),mid=(mid=Math.imul(al4,bh0))+Math.imul(ah4,bl0)|0,hi=Math.imul(ah4,bh0),lo=lo+Math.imul(al3,bl1)|0,mid=(mid=mid+Math.imul(al3,bh1)|0)+Math.imul(ah3,bl1)|0,hi=hi+Math.imul(ah3,bh1)|0,lo=lo+Math.imul(al2,bl2)|0,mid=(mid=mid+Math.imul(al2,bh2)|0)+Math.imul(ah2,bl2)|0,hi=hi+Math.imul(ah2,bh2)|0,lo=lo+Math.imul(al1,bl3)|0,mid=(mid=mid+Math.imul(al1,bh3)|0)+Math.imul(ah1,bl3)|0,hi=hi+Math.imul(ah1,bh3)|0;var w4=(c+(lo=lo+Math.imul(al0,bl4)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al0,bh4)|0)+Math.imul(ah0,bl4)|0))<<13)|0;c=((hi=hi+Math.imul(ah0,bh4)|0)+(mid>>>13)|0)+(w4>>>26)|0,w4&=67108863,lo=Math.imul(al5,bl0),mid=(mid=Math.imul(al5,bh0))+Math.imul(ah5,bl0)|0,hi=Math.imul(ah5,bh0),lo=lo+Math.imul(al4,bl1)|0,mid=(mid=mid+Math.imul(al4,bh1)|0)+Math.imul(ah4,bl1)|0,hi=hi+Math.imul(ah4,bh1)|0,lo=lo+Math.imul(al3,bl2)|0,mid=(mid=mid+Math.imul(al3,bh2)|0)+Math.imul(ah3,bl2)|0,hi=hi+Math.imul(ah3,bh2)|0,lo=lo+Math.imul(al2,bl3)|0,mid=(mid=mid+Math.imul(al2,bh3)|0)+Math.imul(ah2,bl3)|0,hi=hi+Math.imul(ah2,bh3)|0,lo=lo+Math.imul(al1,bl4)|0,mid=(mid=mid+Math.imul(al1,bh4)|0)+Math.imul(ah1,bl4)|0,hi=hi+Math.imul(ah1,bh4)|0;var w5=(c+(lo=lo+Math.imul(al0,bl5)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al0,bh5)|0)+Math.imul(ah0,bl5)|0))<<13)|0;c=((hi=hi+Math.imul(ah0,bh5)|0)+(mid>>>13)|0)+(w5>>>26)|0,w5&=67108863,lo=Math.imul(al6,bl0),mid=(mid=Math.imul(al6,bh0))+Math.imul(ah6,bl0)|0,hi=Math.imul(ah6,bh0),lo=lo+Math.imul(al5,bl1)|0,mid=(mid=mid+Math.imul(al5,bh1)|0)+Math.imul(ah5,bl1)|0,hi=hi+Math.imul(ah5,bh1)|0,lo=lo+Math.imul(al4,bl2)|0,mid=(mid=mid+Math.imul(al4,bh2)|0)+Math.imul(ah4,bl2)|0,hi=hi+Math.imul(ah4,bh2)|0,lo=lo+Math.imul(al3,bl3)|0,mid=(mid=mid+Math.imul(al3,bh3)|0)+Math.imul(ah3,bl3)|0,hi=hi+Math.imul(ah3,bh3)|0,lo=lo+Math.imul(al2,bl4)|0,mid=(mid=mid+Math.imul(al2,bh4)|0)+Math.imul(ah2,bl4)|0,hi=hi+Math.imul(ah2,bh4)|0,lo=lo+Math.imul(al1,bl5)|0,mid=(mid=mid+Math.imul(al1,bh5)|0)+Math.imul(ah1,bl5)|0,hi=hi+Math.imul(ah1,bh5)|0;var w6=(c+(lo=lo+Math.imul(al0,bl6)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al0,bh6)|0)+Math.imul(ah0,bl6)|0))<<13)|0;c=((hi=hi+Math.imul(ah0,bh6)|0)+(mid>>>13)|0)+(w6>>>26)|0,w6&=67108863,lo=Math.imul(al7,bl0),mid=(mid=Math.imul(al7,bh0))+Math.imul(ah7,bl0)|0,hi=Math.imul(ah7,bh0),lo=lo+Math.imul(al6,bl1)|0,mid=(mid=mid+Math.imul(al6,bh1)|0)+Math.imul(ah6,bl1)|0,hi=hi+Math.imul(ah6,bh1)|0,lo=lo+Math.imul(al5,bl2)|0,mid=(mid=mid+Math.imul(al5,bh2)|0)+Math.imul(ah5,bl2)|0,hi=hi+Math.imul(ah5,bh2)|0,lo=lo+Math.imul(al4,bl3)|0,mid=(mid=mid+Math.imul(al4,bh3)|0)+Math.imul(ah4,bl3)|0,hi=hi+Math.imul(ah4,bh3)|0,lo=lo+Math.imul(al3,bl4)|0,mid=(mid=mid+Math.imul(al3,bh4)|0)+Math.imul(ah3,bl4)|0,hi=hi+Math.imul(ah3,bh4)|0,lo=lo+Math.imul(al2,bl5)|0,mid=(mid=mid+Math.imul(al2,bh5)|0)+Math.imul(ah2,bl5)|0,hi=hi+Math.imul(ah2,bh5)|0,lo=lo+Math.imul(al1,bl6)|0,mid=(mid=mid+Math.imul(al1,bh6)|0)+Math.imul(ah1,bl6)|0,hi=hi+Math.imul(ah1,bh6)|0;var w7=(c+(lo=lo+Math.imul(al0,bl7)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al0,bh7)|0)+Math.imul(ah0,bl7)|0))<<13)|0;c=((hi=hi+Math.imul(ah0,bh7)|0)+(mid>>>13)|0)+(w7>>>26)|0,w7&=67108863,lo=Math.imul(al8,bl0),mid=(mid=Math.imul(al8,bh0))+Math.imul(ah8,bl0)|0,hi=Math.imul(ah8,bh0),lo=lo+Math.imul(al7,bl1)|0,mid=(mid=mid+Math.imul(al7,bh1)|0)+Math.imul(ah7,bl1)|0,hi=hi+Math.imul(ah7,bh1)|0,lo=lo+Math.imul(al6,bl2)|0,mid=(mid=mid+Math.imul(al6,bh2)|0)+Math.imul(ah6,bl2)|0,hi=hi+Math.imul(ah6,bh2)|0,lo=lo+Math.imul(al5,bl3)|0,mid=(mid=mid+Math.imul(al5,bh3)|0)+Math.imul(ah5,bl3)|0,hi=hi+Math.imul(ah5,bh3)|0,lo=lo+Math.imul(al4,bl4)|0,mid=(mid=mid+Math.imul(al4,bh4)|0)+Math.imul(ah4,bl4)|0,hi=hi+Math.imul(ah4,bh4)|0,lo=lo+Math.imul(al3,bl5)|0,mid=(mid=mid+Math.imul(al3,bh5)|0)+Math.imul(ah3,bl5)|0,hi=hi+Math.imul(ah3,bh5)|0,lo=lo+Math.imul(al2,bl6)|0,mid=(mid=mid+Math.imul(al2,bh6)|0)+Math.imul(ah2,bl6)|0,hi=hi+Math.imul(ah2,bh6)|0,lo=lo+Math.imul(al1,bl7)|0,mid=(mid=mid+Math.imul(al1,bh7)|0)+Math.imul(ah1,bl7)|0,hi=hi+Math.imul(ah1,bh7)|0;var w8=(c+(lo=lo+Math.imul(al0,bl8)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al0,bh8)|0)+Math.imul(ah0,bl8)|0))<<13)|0;c=((hi=hi+Math.imul(ah0,bh8)|0)+(mid>>>13)|0)+(w8>>>26)|0,w8&=67108863,lo=Math.imul(al9,bl0),mid=(mid=Math.imul(al9,bh0))+Math.imul(ah9,bl0)|0,hi=Math.imul(ah9,bh0),lo=lo+Math.imul(al8,bl1)|0,mid=(mid=mid+Math.imul(al8,bh1)|0)+Math.imul(ah8,bl1)|0,hi=hi+Math.imul(ah8,bh1)|0,lo=lo+Math.imul(al7,bl2)|0,mid=(mid=mid+Math.imul(al7,bh2)|0)+Math.imul(ah7,bl2)|0,hi=hi+Math.imul(ah7,bh2)|0,lo=lo+Math.imul(al6,bl3)|0,mid=(mid=mid+Math.imul(al6,bh3)|0)+Math.imul(ah6,bl3)|0,hi=hi+Math.imul(ah6,bh3)|0,lo=lo+Math.imul(al5,bl4)|0,mid=(mid=mid+Math.imul(al5,bh4)|0)+Math.imul(ah5,bl4)|0,hi=hi+Math.imul(ah5,bh4)|0,lo=lo+Math.imul(al4,bl5)|0,mid=(mid=mid+Math.imul(al4,bh5)|0)+Math.imul(ah4,bl5)|0,hi=hi+Math.imul(ah4,bh5)|0,lo=lo+Math.imul(al3,bl6)|0,mid=(mid=mid+Math.imul(al3,bh6)|0)+Math.imul(ah3,bl6)|0,hi=hi+Math.imul(ah3,bh6)|0,lo=lo+Math.imul(al2,bl7)|0,mid=(mid=mid+Math.imul(al2,bh7)|0)+Math.imul(ah2,bl7)|0,hi=hi+Math.imul(ah2,bh7)|0,lo=lo+Math.imul(al1,bl8)|0,mid=(mid=mid+Math.imul(al1,bh8)|0)+Math.imul(ah1,bl8)|0,hi=hi+Math.imul(ah1,bh8)|0;var w9=(c+(lo=lo+Math.imul(al0,bl9)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al0,bh9)|0)+Math.imul(ah0,bl9)|0))<<13)|0;c=((hi=hi+Math.imul(ah0,bh9)|0)+(mid>>>13)|0)+(w9>>>26)|0,w9&=67108863,lo=Math.imul(al9,bl1),mid=(mid=Math.imul(al9,bh1))+Math.imul(ah9,bl1)|0,hi=Math.imul(ah9,bh1),lo=lo+Math.imul(al8,bl2)|0,mid=(mid=mid+Math.imul(al8,bh2)|0)+Math.imul(ah8,bl2)|0,hi=hi+Math.imul(ah8,bh2)|0,lo=lo+Math.imul(al7,bl3)|0,mid=(mid=mid+Math.imul(al7,bh3)|0)+Math.imul(ah7,bl3)|0,hi=hi+Math.imul(ah7,bh3)|0,lo=lo+Math.imul(al6,bl4)|0,mid=(mid=mid+Math.imul(al6,bh4)|0)+Math.imul(ah6,bl4)|0,hi=hi+Math.imul(ah6,bh4)|0,lo=lo+Math.imul(al5,bl5)|0,mid=(mid=mid+Math.imul(al5,bh5)|0)+Math.imul(ah5,bl5)|0,hi=hi+Math.imul(ah5,bh5)|0,lo=lo+Math.imul(al4,bl6)|0,mid=(mid=mid+Math.imul(al4,bh6)|0)+Math.imul(ah4,bl6)|0,hi=hi+Math.imul(ah4,bh6)|0,lo=lo+Math.imul(al3,bl7)|0,mid=(mid=mid+Math.imul(al3,bh7)|0)+Math.imul(ah3,bl7)|0,hi=hi+Math.imul(ah3,bh7)|0,lo=lo+Math.imul(al2,bl8)|0,mid=(mid=mid+Math.imul(al2,bh8)|0)+Math.imul(ah2,bl8)|0,hi=hi+Math.imul(ah2,bh8)|0;var w10=(c+(lo=lo+Math.imul(al1,bl9)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al1,bh9)|0)+Math.imul(ah1,bl9)|0))<<13)|0;c=((hi=hi+Math.imul(ah1,bh9)|0)+(mid>>>13)|0)+(w10>>>26)|0,w10&=67108863,lo=Math.imul(al9,bl2),mid=(mid=Math.imul(al9,bh2))+Math.imul(ah9,bl2)|0,hi=Math.imul(ah9,bh2),lo=lo+Math.imul(al8,bl3)|0,mid=(mid=mid+Math.imul(al8,bh3)|0)+Math.imul(ah8,bl3)|0,hi=hi+Math.imul(ah8,bh3)|0,lo=lo+Math.imul(al7,bl4)|0,mid=(mid=mid+Math.imul(al7,bh4)|0)+Math.imul(ah7,bl4)|0,hi=hi+Math.imul(ah7,bh4)|0,lo=lo+Math.imul(al6,bl5)|0,mid=(mid=mid+Math.imul(al6,bh5)|0)+Math.imul(ah6,bl5)|0,hi=hi+Math.imul(ah6,bh5)|0,lo=lo+Math.imul(al5,bl6)|0,mid=(mid=mid+Math.imul(al5,bh6)|0)+Math.imul(ah5,bl6)|0,hi=hi+Math.imul(ah5,bh6)|0,lo=lo+Math.imul(al4,bl7)|0,mid=(mid=mid+Math.imul(al4,bh7)|0)+Math.imul(ah4,bl7)|0,hi=hi+Math.imul(ah4,bh7)|0,lo=lo+Math.imul(al3,bl8)|0,mid=(mid=mid+Math.imul(al3,bh8)|0)+Math.imul(ah3,bl8)|0,hi=hi+Math.imul(ah3,bh8)|0;var w11=(c+(lo=lo+Math.imul(al2,bl9)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al2,bh9)|0)+Math.imul(ah2,bl9)|0))<<13)|0;c=((hi=hi+Math.imul(ah2,bh9)|0)+(mid>>>13)|0)+(w11>>>26)|0,w11&=67108863,lo=Math.imul(al9,bl3),mid=(mid=Math.imul(al9,bh3))+Math.imul(ah9,bl3)|0,hi=Math.imul(ah9,bh3),lo=lo+Math.imul(al8,bl4)|0,mid=(mid=mid+Math.imul(al8,bh4)|0)+Math.imul(ah8,bl4)|0,hi=hi+Math.imul(ah8,bh4)|0,lo=lo+Math.imul(al7,bl5)|0,mid=(mid=mid+Math.imul(al7,bh5)|0)+Math.imul(ah7,bl5)|0,hi=hi+Math.imul(ah7,bh5)|0,lo=lo+Math.imul(al6,bl6)|0,mid=(mid=mid+Math.imul(al6,bh6)|0)+Math.imul(ah6,bl6)|0,hi=hi+Math.imul(ah6,bh6)|0,lo=lo+Math.imul(al5,bl7)|0,mid=(mid=mid+Math.imul(al5,bh7)|0)+Math.imul(ah5,bl7)|0,hi=hi+Math.imul(ah5,bh7)|0,lo=lo+Math.imul(al4,bl8)|0,mid=(mid=mid+Math.imul(al4,bh8)|0)+Math.imul(ah4,bl8)|0,hi=hi+Math.imul(ah4,bh8)|0;var w12=(c+(lo=lo+Math.imul(al3,bl9)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al3,bh9)|0)+Math.imul(ah3,bl9)|0))<<13)|0;c=((hi=hi+Math.imul(ah3,bh9)|0)+(mid>>>13)|0)+(w12>>>26)|0,w12&=67108863,lo=Math.imul(al9,bl4),mid=(mid=Math.imul(al9,bh4))+Math.imul(ah9,bl4)|0,hi=Math.imul(ah9,bh4),lo=lo+Math.imul(al8,bl5)|0,mid=(mid=mid+Math.imul(al8,bh5)|0)+Math.imul(ah8,bl5)|0,hi=hi+Math.imul(ah8,bh5)|0,lo=lo+Math.imul(al7,bl6)|0,mid=(mid=mid+Math.imul(al7,bh6)|0)+Math.imul(ah7,bl6)|0,hi=hi+Math.imul(ah7,bh6)|0,lo=lo+Math.imul(al6,bl7)|0,mid=(mid=mid+Math.imul(al6,bh7)|0)+Math.imul(ah6,bl7)|0,hi=hi+Math.imul(ah6,bh7)|0,lo=lo+Math.imul(al5,bl8)|0,mid=(mid=mid+Math.imul(al5,bh8)|0)+Math.imul(ah5,bl8)|0,hi=hi+Math.imul(ah5,bh8)|0;var w13=(c+(lo=lo+Math.imul(al4,bl9)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al4,bh9)|0)+Math.imul(ah4,bl9)|0))<<13)|0;c=((hi=hi+Math.imul(ah4,bh9)|0)+(mid>>>13)|0)+(w13>>>26)|0,w13&=67108863,lo=Math.imul(al9,bl5),mid=(mid=Math.imul(al9,bh5))+Math.imul(ah9,bl5)|0,hi=Math.imul(ah9,bh5),lo=lo+Math.imul(al8,bl6)|0,mid=(mid=mid+Math.imul(al8,bh6)|0)+Math.imul(ah8,bl6)|0,hi=hi+Math.imul(ah8,bh6)|0,lo=lo+Math.imul(al7,bl7)|0,mid=(mid=mid+Math.imul(al7,bh7)|0)+Math.imul(ah7,bl7)|0,hi=hi+Math.imul(ah7,bh7)|0,lo=lo+Math.imul(al6,bl8)|0,mid=(mid=mid+Math.imul(al6,bh8)|0)+Math.imul(ah6,bl8)|0,hi=hi+Math.imul(ah6,bh8)|0;var w14=(c+(lo=lo+Math.imul(al5,bl9)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al5,bh9)|0)+Math.imul(ah5,bl9)|0))<<13)|0;c=((hi=hi+Math.imul(ah5,bh9)|0)+(mid>>>13)|0)+(w14>>>26)|0,w14&=67108863,lo=Math.imul(al9,bl6),mid=(mid=Math.imul(al9,bh6))+Math.imul(ah9,bl6)|0,hi=Math.imul(ah9,bh6),lo=lo+Math.imul(al8,bl7)|0,mid=(mid=mid+Math.imul(al8,bh7)|0)+Math.imul(ah8,bl7)|0,hi=hi+Math.imul(ah8,bh7)|0,lo=lo+Math.imul(al7,bl8)|0,mid=(mid=mid+Math.imul(al7,bh8)|0)+Math.imul(ah7,bl8)|0,hi=hi+Math.imul(ah7,bh8)|0;var w15=(c+(lo=lo+Math.imul(al6,bl9)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al6,bh9)|0)+Math.imul(ah6,bl9)|0))<<13)|0;c=((hi=hi+Math.imul(ah6,bh9)|0)+(mid>>>13)|0)+(w15>>>26)|0,w15&=67108863,lo=Math.imul(al9,bl7),mid=(mid=Math.imul(al9,bh7))+Math.imul(ah9,bl7)|0,hi=Math.imul(ah9,bh7),lo=lo+Math.imul(al8,bl8)|0,mid=(mid=mid+Math.imul(al8,bh8)|0)+Math.imul(ah8,bl8)|0,hi=hi+Math.imul(ah8,bh8)|0;var w16=(c+(lo=lo+Math.imul(al7,bl9)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al7,bh9)|0)+Math.imul(ah7,bl9)|0))<<13)|0;c=((hi=hi+Math.imul(ah7,bh9)|0)+(mid>>>13)|0)+(w16>>>26)|0,w16&=67108863,lo=Math.imul(al9,bl8),mid=(mid=Math.imul(al9,bh8))+Math.imul(ah9,bl8)|0,hi=Math.imul(ah9,bh8);var w17=(c+(lo=lo+Math.imul(al8,bl9)|0)|0)+((8191&(mid=(mid=mid+Math.imul(al8,bh9)|0)+Math.imul(ah8,bl9)|0))<<13)|0;c=((hi=hi+Math.imul(ah8,bh9)|0)+(mid>>>13)|0)+(w17>>>26)|0,w17&=67108863;var w18=(c+(lo=Math.imul(al9,bl9))|0)+((8191&(mid=(mid=Math.imul(al9,bh9))+Math.imul(ah9,bl9)|0))<<13)|0;return c=((hi=Math.imul(ah9,bh9))+(mid>>>13)|0)+(w18>>>26)|0,w18&=67108863,o[0]=w0,o[1]=w1,o[2]=w2,o[3]=w3,o[4]=w4,o[5]=w5,o[6]=w6,o[7]=w7,o[8]=w8,o[9]=w9,o[10]=w10,o[11]=w11,o[12]=w12,o[13]=w13,o[14]=w14,o[15]=w15,o[16]=w16,o[17]=w17,o[18]=w18,0!==c&&(o[19]=c,out.length++),out};function jumboMulTo(self,num,out){return(new FFTM).mulp(self,num,out)}function FFTM(x,y){this.x=x,this.y=y}Math.imul||(comb10MulTo=smallMulTo),BN.prototype.mulTo=function(num,out){var len=this.length+num.length;return 10===this.length&&10===num.length?comb10MulTo(this,num,out):len<63?smallMulTo(this,num,out):len<1024?function(self,num,out){out.negative=num.negative^self.negative,out.length=self.length+num.length;for(var carry=0,hncarry=0,k=0;k<out.length-1;k++){var ncarry=hncarry;hncarry=0;for(var rword=67108863&carry,maxJ=Math.min(k,num.length-1),j=Math.max(0,k-self.length+1);j<=maxJ;j++){var i=k-j,r=(0|self.words[i])*(0|num.words[j]),lo=67108863&r;rword=67108863&(lo=lo+rword|0),hncarry+=(ncarry=(ncarry=ncarry+(r/67108864|0)|0)+(lo>>>26)|0)>>>26,ncarry&=67108863}out.words[k]=rword,carry=ncarry,ncarry=hncarry}return 0!==carry?out.words[k]=carry:out.length--,out.strip()}(this,num,out):jumboMulTo(this,num,out)},FFTM.prototype.makeRBT=function(N){for(var t=new Array(N),l=BN.prototype._countBits(N)-1,i=0;i<N;i++)t[i]=this.revBin(i,l,N);return t},FFTM.prototype.revBin=function(x,l,N){if(0===x||x===N-1)return x;for(var rb=0,i=0;i<l;i++)rb|=(1&x)<<l-i-1,x>>=1;return rb},FFTM.prototype.permute=function(rbt,rws,iws,rtws,itws,N){for(var i=0;i<N;i++)rtws[i]=rws[rbt[i]],itws[i]=iws[rbt[i]]},FFTM.prototype.transform=function(rws,iws,rtws,itws,N,rbt){this.permute(rbt,rws,iws,rtws,itws,N);for(var s=1;s<N;s<<=1)for(var l=s<<1,rtwdf=Math.cos(2*Math.PI/l),itwdf=Math.sin(2*Math.PI/l),p=0;p<N;p+=l)for(var rtwdf_=rtwdf,itwdf_=itwdf,j=0;j<s;j++){var re=rtws[p+j],ie=itws[p+j],ro=rtws[p+j+s],io=itws[p+j+s],rx=rtwdf_*ro-itwdf_*io;io=rtwdf_*io+itwdf_*ro,ro=rx,rtws[p+j]=re+ro,itws[p+j]=ie+io,rtws[p+j+s]=re-ro,itws[p+j+s]=ie-io,j!==l&&(rx=rtwdf*rtwdf_-itwdf*itwdf_,itwdf_=rtwdf*itwdf_+itwdf*rtwdf_,rtwdf_=rx)}},FFTM.prototype.guessLen13b=function(n,m){var N=1|Math.max(m,n),odd=1&N,i=0;for(N=N/2|0;N;N>>>=1)i++;return 1<<i+1+odd},FFTM.prototype.conjugate=function(rws,iws,N){if(!(N<=1))for(var i=0;i<N/2;i++){var t=rws[i];rws[i]=rws[N-i-1],rws[N-i-1]=t,t=iws[i],iws[i]=-iws[N-i-1],iws[N-i-1]=-t}},FFTM.prototype.normalize13b=function(ws,N){for(var carry=0,i=0;i<N/2;i++){var w=8192*Math.round(ws[2*i+1]/N)+Math.round(ws[2*i]/N)+carry;ws[i]=67108863&w,carry=w<67108864?0:w/67108864|0}return ws},FFTM.prototype.convert13b=function(ws,len,rws,N){for(var carry=0,i=0;i<len;i++)carry+=0|ws[i],rws[2*i]=8191&carry,carry>>>=13,rws[2*i+1]=8191&carry,carry>>>=13;for(i=2*len;i<N;++i)rws[i]=0;assert(0===carry),assert(0==(-8192&carry))},FFTM.prototype.stub=function(N){for(var ph=new Array(N),i=0;i<N;i++)ph[i]=0;return ph},FFTM.prototype.mulp=function(x,y,out){var N=2*this.guessLen13b(x.length,y.length),rbt=this.makeRBT(N),_=this.stub(N),rws=new Array(N),rwst=new Array(N),iwst=new Array(N),nrws=new Array(N),nrwst=new Array(N),niwst=new Array(N),rmws=out.words;rmws.length=N,this.convert13b(x.words,x.length,rws,N),this.convert13b(y.words,y.length,nrws,N),this.transform(rws,_,rwst,iwst,N,rbt),this.transform(nrws,_,nrwst,niwst,N,rbt);for(var i=0;i<N;i++){var rx=rwst[i]*nrwst[i]-iwst[i]*niwst[i];iwst[i]=rwst[i]*niwst[i]+iwst[i]*nrwst[i],rwst[i]=rx}return this.conjugate(rwst,iwst,N),this.transform(rwst,iwst,rmws,_,N,rbt),this.conjugate(rmws,_,N),this.normalize13b(rmws,N),out.negative=x.negative^y.negative,out.length=x.length+y.length,out.strip()},BN.prototype.mul=function(num){var out=new BN(null);return out.words=new Array(this.length+num.length),this.mulTo(num,out)},BN.prototype.mulf=function(num){var out=new BN(null);return out.words=new Array(this.length+num.length),jumboMulTo(this,num,out)},BN.prototype.imul=function(num){return this.clone().mulTo(num,this)},BN.prototype.imuln=function(num){assert("number"==typeof num),assert(num<67108864);for(var carry=0,i=0;i<this.length;i++){var w=(0|this.words[i])*num,lo=(67108863&w)+(67108863&carry);carry>>=26,carry+=w/67108864|0,carry+=lo>>>26,this.words[i]=67108863&lo}return 0!==carry&&(this.words[i]=carry,this.length++),this},BN.prototype.muln=function(num){return this.clone().imuln(num)},BN.prototype.sqr=function(){return this.mul(this)},BN.prototype.isqr=function(){return this.imul(this.clone())},BN.prototype.pow=function(num){var w=function(num){for(var w=new Array(num.bitLength()),bit=0;bit<w.length;bit++){var off=bit/26|0,wbit=bit%26;w[bit]=(num.words[off]&1<<wbit)>>>wbit}return w}(num);if(0===w.length)return new BN(1);for(var res=this,i=0;i<w.length&&0===w[i];i++,res=res.sqr());if(++i<w.length)for(var q=res.sqr();i<w.length;i++,q=q.sqr())0!==w[i]&&(res=res.mul(q));return res},BN.prototype.iushln=function(bits){assert("number"==typeof bits&&bits>=0);var i,r=bits%26,s=(bits-r)/26,carryMask=67108863>>>26-r<<26-r;if(0!==r){var carry=0;for(i=0;i<this.length;i++){var newCarry=this.words[i]&carryMask,c=(0|this.words[i])-newCarry<<r;this.words[i]=c|carry,carry=newCarry>>>26-r}carry&&(this.words[i]=carry,this.length++)}if(0!==s){for(i=this.length-1;i>=0;i--)this.words[i+s]=this.words[i];for(i=0;i<s;i++)this.words[i]=0;this.length+=s}return this.strip()},BN.prototype.ishln=function(bits){return assert(0===this.negative),this.iushln(bits)},BN.prototype.iushrn=function(bits,hint,extended){var h;assert("number"==typeof bits&&bits>=0),h=hint?(hint-hint%26)/26:0;var r=bits%26,s=Math.min((bits-r)/26,this.length),mask=67108863^67108863>>>r<<r,maskedWords=extended;if(h-=s,h=Math.max(0,h),maskedWords){for(var i=0;i<s;i++)maskedWords.words[i]=this.words[i];maskedWords.length=s}if(0===s);else if(this.length>s)for(this.length-=s,i=0;i<this.length;i++)this.words[i]=this.words[i+s];else this.words[0]=0,this.length=1;var carry=0;for(i=this.length-1;i>=0&&(0!==carry||i>=h);i--){var word=0|this.words[i];this.words[i]=carry<<26-r|word>>>r,carry=word&mask}return maskedWords&&0!==carry&&(maskedWords.words[maskedWords.length++]=carry),0===this.length&&(this.words[0]=0,this.length=1),this.strip()},BN.prototype.ishrn=function(bits,hint,extended){return assert(0===this.negative),this.iushrn(bits,hint,extended)},BN.prototype.shln=function(bits){return this.clone().ishln(bits)},BN.prototype.ushln=function(bits){return this.clone().iushln(bits)},BN.prototype.shrn=function(bits){return this.clone().ishrn(bits)},BN.prototype.ushrn=function(bits){return this.clone().iushrn(bits)},BN.prototype.testn=function(bit){assert("number"==typeof bit&&bit>=0);var r=bit%26,s=(bit-r)/26,q=1<<r;return!(this.length<=s)&&!!(this.words[s]&q)},BN.prototype.imaskn=function(bits){assert("number"==typeof bits&&bits>=0);var r=bits%26,s=(bits-r)/26;if(assert(0===this.negative,"imaskn works only with positive numbers"),this.length<=s)return this;if(0!==r&&s++,this.length=Math.min(s,this.length),0!==r){var mask=67108863^67108863>>>r<<r;this.words[this.length-1]&=mask}return this.strip()},BN.prototype.maskn=function(bits){return this.clone().imaskn(bits)},BN.prototype.iaddn=function(num){return assert("number"==typeof num),assert(num<67108864),num<0?this.isubn(-num):0!==this.negative?1===this.length&&(0|this.words[0])<num?(this.words[0]=num-(0|this.words[0]),this.negative=0,this):(this.negative=0,this.isubn(num),this.negative=1,this):this._iaddn(num)},BN.prototype._iaddn=function(num){this.words[0]+=num;for(var i=0;i<this.length&&this.words[i]>=67108864;i++)this.words[i]-=67108864,i===this.length-1?this.words[i+1]=1:this.words[i+1]++;return this.length=Math.max(this.length,i+1),this},BN.prototype.isubn=function(num){if(assert("number"==typeof num),assert(num<67108864),num<0)return this.iaddn(-num);if(0!==this.negative)return this.negative=0,this.iaddn(num),this.negative=1,this;if(this.words[0]-=num,1===this.length&&this.words[0]<0)this.words[0]=-this.words[0],this.negative=1;else for(var i=0;i<this.length&&this.words[i]<0;i++)this.words[i]+=67108864,this.words[i+1]-=1;return this.strip()},BN.prototype.addn=function(num){return this.clone().iaddn(num)},BN.prototype.subn=function(num){return this.clone().isubn(num)},BN.prototype.iabs=function(){return this.negative=0,this},BN.prototype.abs=function(){return this.clone().iabs()},BN.prototype._ishlnsubmul=function(num,mul,shift){var i,w,len=num.length+shift;this._expand(len);var carry=0;for(i=0;i<num.length;i++){w=(0|this.words[i+shift])+carry;var right=(0|num.words[i])*mul;carry=((w-=67108863&right)>>26)-(right/67108864|0),this.words[i+shift]=67108863&w}for(;i<this.length-shift;i++)carry=(w=(0|this.words[i+shift])+carry)>>26,this.words[i+shift]=67108863&w;if(0===carry)return this.strip();for(assert(-1===carry),carry=0,i=0;i<this.length;i++)carry=(w=-(0|this.words[i])+carry)>>26,this.words[i]=67108863&w;return this.negative=1,this.strip()},BN.prototype._wordDiv=function(num,mode){var shift=(this.length,num.length),a=this.clone(),b=num,bhi=0|b.words[b.length-1];0!==(shift=26-this._countBits(bhi))&&(b=b.ushln(shift),a.iushln(shift),bhi=0|b.words[b.length-1]);var q,m=a.length-b.length;if("mod"!==mode){(q=new BN(null)).length=m+1,q.words=new Array(q.length);for(var i=0;i<q.length;i++)q.words[i]=0}var diff=a.clone()._ishlnsubmul(b,1,m);0===diff.negative&&(a=diff,q&&(q.words[m]=1));for(var j=m-1;j>=0;j--){var qj=67108864*(0|a.words[b.length+j])+(0|a.words[b.length+j-1]);for(qj=Math.min(qj/bhi|0,67108863),a._ishlnsubmul(b,qj,j);0!==a.negative;)qj--,a.negative=0,a._ishlnsubmul(b,1,j),a.isZero()||(a.negative^=1);q&&(q.words[j]=qj)}return q&&q.strip(),a.strip(),"div"!==mode&&0!==shift&&a.iushrn(shift),{div:q||null,mod:a}},BN.prototype.divmod=function(num,mode,positive){return assert(!num.isZero()),this.isZero()?{div:new BN(0),mod:new BN(0)}:0!==this.negative&&0===num.negative?(res=this.neg().divmod(num,mode),"mod"!==mode&&(div=res.div.neg()),"div"!==mode&&(mod=res.mod.neg(),positive&&0!==mod.negative&&mod.iadd(num)),{div:div,mod:mod}):0===this.negative&&0!==num.negative?(res=this.divmod(num.neg(),mode),"mod"!==mode&&(div=res.div.neg()),{div:div,mod:res.mod}):0!=(this.negative&num.negative)?(res=this.neg().divmod(num.neg(),mode),"div"!==mode&&(mod=res.mod.neg(),positive&&0!==mod.negative&&mod.isub(num)),{div:res.div,mod:mod}):num.length>this.length||this.cmp(num)<0?{div:new BN(0),mod:this}:1===num.length?"div"===mode?{div:this.divn(num.words[0]),mod:null}:"mod"===mode?{div:null,mod:new BN(this.modn(num.words[0]))}:{div:this.divn(num.words[0]),mod:new BN(this.modn(num.words[0]))}:this._wordDiv(num,mode);var div,mod,res},BN.prototype.div=function(num){return this.divmod(num,"div",!1).div},BN.prototype.mod=function(num){return this.divmod(num,"mod",!1).mod},BN.prototype.umod=function(num){return this.divmod(num,"mod",!0).mod},BN.prototype.divRound=function(num){var dm=this.divmod(num);if(dm.mod.isZero())return dm.div;var mod=0!==dm.div.negative?dm.mod.isub(num):dm.mod,half=num.ushrn(1),r2=num.andln(1),cmp=mod.cmp(half);return cmp<0||1===r2&&0===cmp?dm.div:0!==dm.div.negative?dm.div.isubn(1):dm.div.iaddn(1)},BN.prototype.modn=function(num){assert(num<=67108863);for(var p=(1<<26)%num,acc=0,i=this.length-1;i>=0;i--)acc=(p*acc+(0|this.words[i]))%num;return acc},BN.prototype.idivn=function(num){assert(num<=67108863);for(var carry=0,i=this.length-1;i>=0;i--){var w=(0|this.words[i])+67108864*carry;this.words[i]=w/num|0,carry=w%num}return this.strip()},BN.prototype.divn=function(num){return this.clone().idivn(num)},BN.prototype.egcd=function(p){assert(0===p.negative),assert(!p.isZero());var x=this,y=p.clone();x=0!==x.negative?x.umod(p):x.clone();for(var A=new BN(1),B=new BN(0),C=new BN(0),D=new BN(1),g=0;x.isEven()&&y.isEven();)x.iushrn(1),y.iushrn(1),++g;for(var yp=y.clone(),xp=x.clone();!x.isZero();){for(var i=0,im=1;0==(x.words[0]&im)&&i<26;++i,im<<=1);if(i>0)for(x.iushrn(i);i-- >0;)(A.isOdd()||B.isOdd())&&(A.iadd(yp),B.isub(xp)),A.iushrn(1),B.iushrn(1);for(var j=0,jm=1;0==(y.words[0]&jm)&&j<26;++j,jm<<=1);if(j>0)for(y.iushrn(j);j-- >0;)(C.isOdd()||D.isOdd())&&(C.iadd(yp),D.isub(xp)),C.iushrn(1),D.iushrn(1);x.cmp(y)>=0?(x.isub(y),A.isub(C),B.isub(D)):(y.isub(x),C.isub(A),D.isub(B))}return{a:C,b:D,gcd:y.iushln(g)}},BN.prototype._invmp=function(p){assert(0===p.negative),assert(!p.isZero());var a=this,b=p.clone();a=0!==a.negative?a.umod(p):a.clone();for(var res,x1=new BN(1),x2=new BN(0),delta=b.clone();a.cmpn(1)>0&&b.cmpn(1)>0;){for(var i=0,im=1;0==(a.words[0]&im)&&i<26;++i,im<<=1);if(i>0)for(a.iushrn(i);i-- >0;)x1.isOdd()&&x1.iadd(delta),x1.iushrn(1);for(var j=0,jm=1;0==(b.words[0]&jm)&&j<26;++j,jm<<=1);if(j>0)for(b.iushrn(j);j-- >0;)x2.isOdd()&&x2.iadd(delta),x2.iushrn(1);a.cmp(b)>=0?(a.isub(b),x1.isub(x2)):(b.isub(a),x2.isub(x1))}return(res=0===a.cmpn(1)?x1:x2).cmpn(0)<0&&res.iadd(p),res},BN.prototype.gcd=function(num){if(this.isZero())return num.abs();if(num.isZero())return this.abs();var a=this.clone(),b=num.clone();a.negative=0,b.negative=0;for(var shift=0;a.isEven()&&b.isEven();shift++)a.iushrn(1),b.iushrn(1);for(;;){for(;a.isEven();)a.iushrn(1);for(;b.isEven();)b.iushrn(1);var r=a.cmp(b);if(r<0){var t=a;a=b,b=t}else if(0===r||0===b.cmpn(1))break;a.isub(b)}return b.iushln(shift)},BN.prototype.invm=function(num){return this.egcd(num).a.umod(num)},BN.prototype.isEven=function(){return 0==(1&this.words[0])},BN.prototype.isOdd=function(){return 1==(1&this.words[0])},BN.prototype.andln=function(num){return this.words[0]&num},BN.prototype.bincn=function(bit){assert("number"==typeof bit);var r=bit%26,s=(bit-r)/26,q=1<<r;if(this.length<=s)return this._expand(s+1),this.words[s]|=q,this;for(var carry=q,i=s;0!==carry&&i<this.length;i++){var w=0|this.words[i];carry=(w+=carry)>>>26,w&=67108863,this.words[i]=w}return 0!==carry&&(this.words[i]=carry,this.length++),this},BN.prototype.isZero=function(){return 1===this.length&&0===this.words[0]},BN.prototype.cmpn=function(num){var res,negative=num<0;if(0!==this.negative&&!negative)return-1;if(0===this.negative&&negative)return 1;if(this.strip(),this.length>1)res=1;else{negative&&(num=-num),assert(num<=67108863,"Number is too big");var w=0|this.words[0];res=w===num?0:w<num?-1:1}return 0!==this.negative?0|-res:res},BN.prototype.cmp=function(num){if(0!==this.negative&&0===num.negative)return-1;if(0===this.negative&&0!==num.negative)return 1;var res=this.ucmp(num);return 0!==this.negative?0|-res:res},BN.prototype.ucmp=function(num){if(this.length>num.length)return 1;if(this.length<num.length)return-1;for(var res=0,i=this.length-1;i>=0;i--){var a=0|this.words[i],b=0|num.words[i];if(a!==b){a<b?res=-1:a>b&&(res=1);break}}return res},BN.prototype.gtn=function(num){return 1===this.cmpn(num)},BN.prototype.gt=function(num){return 1===this.cmp(num)},BN.prototype.gten=function(num){return this.cmpn(num)>=0},BN.prototype.gte=function(num){return this.cmp(num)>=0},BN.prototype.ltn=function(num){return-1===this.cmpn(num)},BN.prototype.lt=function(num){return-1===this.cmp(num)},BN.prototype.lten=function(num){return this.cmpn(num)<=0},BN.prototype.lte=function(num){return this.cmp(num)<=0},BN.prototype.eqn=function(num){return 0===this.cmpn(num)},BN.prototype.eq=function(num){return 0===this.cmp(num)},BN.red=function(num){return new Red(num)},BN.prototype.toRed=function(ctx){return assert(!this.red,"Already a number in reduction context"),assert(0===this.negative,"red works only with positives"),ctx.convertTo(this)._forceRed(ctx)},BN.prototype.fromRed=function(){return assert(this.red,"fromRed works only with numbers in reduction context"),this.red.convertFrom(this)},BN.prototype._forceRed=function(ctx){return this.red=ctx,this},BN.prototype.forceRed=function(ctx){return assert(!this.red,"Already a number in reduction context"),this._forceRed(ctx)},BN.prototype.redAdd=function(num){return assert(this.red,"redAdd works only with red numbers"),this.red.add(this,num)},BN.prototype.redIAdd=function(num){return assert(this.red,"redIAdd works only with red numbers"),this.red.iadd(this,num)},BN.prototype.redSub=function(num){return assert(this.red,"redSub works only with red numbers"),this.red.sub(this,num)},BN.prototype.redISub=function(num){return assert(this.red,"redISub works only with red numbers"),this.red.isub(this,num)},BN.prototype.redShl=function(num){return assert(this.red,"redShl works only with red numbers"),this.red.shl(this,num)},BN.prototype.redMul=function(num){return assert(this.red,"redMul works only with red numbers"),this.red._verify2(this,num),this.red.mul(this,num)},BN.prototype.redIMul=function(num){return assert(this.red,"redMul works only with red numbers"),this.red._verify2(this,num),this.red.imul(this,num)},BN.prototype.redSqr=function(){return assert(this.red,"redSqr works only with red numbers"),this.red._verify1(this),this.red.sqr(this)},BN.prototype.redISqr=function(){return assert(this.red,"redISqr works only with red numbers"),this.red._verify1(this),this.red.isqr(this)},BN.prototype.redSqrt=function(){return assert(this.red,"redSqrt works only with red numbers"),this.red._verify1(this),this.red.sqrt(this)},BN.prototype.redInvm=function(){return assert(this.red,"redInvm works only with red numbers"),this.red._verify1(this),this.red.invm(this)},BN.prototype.redNeg=function(){return assert(this.red,"redNeg works only with red numbers"),this.red._verify1(this),this.red.neg(this)},BN.prototype.redPow=function(num){return assert(this.red&&!num.red,"redPow(normalNum)"),this.red._verify1(this),this.red.pow(this,num)};var primes={k256:null,p224:null,p192:null,p25519:null};function MPrime(name,p){this.name=name,this.p=new BN(p,16),this.n=this.p.bitLength(),this.k=new BN(1).iushln(this.n).isub(this.p),this.tmp=this._tmp()}function K256(){MPrime.call(this,"k256","ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe fffffc2f")}function P224(){MPrime.call(this,"p224","ffffffff ffffffff ffffffff ffffffff 00000000 00000000 00000001")}function P192(){MPrime.call(this,"p192","ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff")}function P25519(){MPrime.call(this,"25519","7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed")}function Red(m){if("string"==typeof m){var prime=BN._prime(m);this.m=prime.p,this.prime=prime}else assert(m.gtn(1),"modulus must be greater than 1"),this.m=m,this.prime=null}function Mont(m){Red.call(this,m),this.shift=this.m.bitLength(),this.shift%26!=0&&(this.shift+=26-this.shift%26),this.r=new BN(1).iushln(this.shift),this.r2=this.imod(this.r.sqr()),this.rinv=this.r._invmp(this.m),this.minv=this.rinv.mul(this.r).isubn(1).div(this.m),this.minv=this.minv.umod(this.r),this.minv=this.r.sub(this.minv)}MPrime.prototype._tmp=function(){var tmp=new BN(null);return tmp.words=new Array(Math.ceil(this.n/13)),tmp},MPrime.prototype.ireduce=function(num){var rlen,r=num;do{this.split(r,this.tmp),rlen=(r=(r=this.imulK(r)).iadd(this.tmp)).bitLength()}while(rlen>this.n);var cmp=rlen<this.n?-1:r.ucmp(this.p);return 0===cmp?(r.words[0]=0,r.length=1):cmp>0?r.isub(this.p):r.strip(),r},MPrime.prototype.split=function(input,out){input.iushrn(this.n,0,out)},MPrime.prototype.imulK=function(num){return num.imul(this.k)},inherits(K256,MPrime),K256.prototype.split=function(input,output){for(var outLen=Math.min(input.length,9),i=0;i<outLen;i++)output.words[i]=input.words[i];if(output.length=outLen,input.length<=9)return input.words[0]=0,void(input.length=1);var prev=input.words[9];for(output.words[output.length++]=4194303&prev,i=10;i<input.length;i++){var next=0|input.words[i];input.words[i-10]=(4194303&next)<<4|prev>>>22,prev=next}prev>>>=22,input.words[i-10]=prev,0===prev&&input.length>10?input.length-=10:input.length-=9},K256.prototype.imulK=function(num){num.words[num.length]=0,num.words[num.length+1]=0,num.length+=2;for(var lo=0,i=0;i<num.length;i++){var w=0|num.words[i];lo+=977*w,num.words[i]=67108863&lo,lo=64*w+(lo/67108864|0)}return 0===num.words[num.length-1]&&(num.length--,0===num.words[num.length-1]&&num.length--),num},inherits(P224,MPrime),inherits(P192,MPrime),inherits(P25519,MPrime),P25519.prototype.imulK=function(num){for(var carry=0,i=0;i<num.length;i++){var hi=19*(0|num.words[i])+carry,lo=67108863&hi;hi>>>=26,num.words[i]=lo,carry=hi}return 0!==carry&&(num.words[num.length++]=carry),num},BN._prime=function(name){if(primes[name])return primes[name];var prime;if("k256"===name)prime=new K256;else if("p224"===name)prime=new P224;else if("p192"===name)prime=new P192;else{if("p25519"!==name)throw new Error("Unknown prime "+name);prime=new P25519}return primes[name]=prime,prime},Red.prototype._verify1=function(a){assert(0===a.negative,"red works only with positives"),assert(a.red,"red works only with red numbers")},Red.prototype._verify2=function(a,b){assert(0==(a.negative|b.negative),"red works only with positives"),assert(a.red&&a.red===b.red,"red works only with red numbers")},Red.prototype.imod=function(a){return this.prime?this.prime.ireduce(a)._forceRed(this):a.umod(this.m)._forceRed(this)},Red.prototype.neg=function(a){return a.isZero()?a.clone():this.m.sub(a)._forceRed(this)},Red.prototype.add=function(a,b){this._verify2(a,b);var res=a.add(b);return res.cmp(this.m)>=0&&res.isub(this.m),res._forceRed(this)},Red.prototype.iadd=function(a,b){this._verify2(a,b);var res=a.iadd(b);return res.cmp(this.m)>=0&&res.isub(this.m),res},Red.prototype.sub=function(a,b){this._verify2(a,b);var res=a.sub(b);return res.cmpn(0)<0&&res.iadd(this.m),res._forceRed(this)},Red.prototype.isub=function(a,b){this._verify2(a,b);var res=a.isub(b);return res.cmpn(0)<0&&res.iadd(this.m),res},Red.prototype.shl=function(a,num){return this._verify1(a),this.imod(a.ushln(num))},Red.prototype.imul=function(a,b){return this._verify2(a,b),this.imod(a.imul(b))},Red.prototype.mul=function(a,b){return this._verify2(a,b),this.imod(a.mul(b))},Red.prototype.isqr=function(a){return this.imul(a,a.clone())},Red.prototype.sqr=function(a){return this.mul(a,a)},Red.prototype.sqrt=function(a){if(a.isZero())return a.clone();var mod3=this.m.andln(3);if(assert(mod3%2==1),3===mod3){var pow=this.m.add(new BN(1)).iushrn(2);return this.pow(a,pow)}for(var q=this.m.subn(1),s=0;!q.isZero()&&0===q.andln(1);)s++,q.iushrn(1);assert(!q.isZero());var one=new BN(1).toRed(this),nOne=one.redNeg(),lpow=this.m.subn(1).iushrn(1),z=this.m.bitLength();for(z=new BN(2*z*z).toRed(this);0!==this.pow(z,lpow).cmp(nOne);)z.redIAdd(nOne);for(var c=this.pow(z,q),r=this.pow(a,q.addn(1).iushrn(1)),t=this.pow(a,q),m=s;0!==t.cmp(one);){for(var tmp=t,i=0;0!==tmp.cmp(one);i++)tmp=tmp.redSqr();assert(i<m);var b=this.pow(c,new BN(1).iushln(m-i-1));r=r.redMul(b),c=b.redSqr(),t=t.redMul(c),m=i}return r},Red.prototype.invm=function(a){var inv=a._invmp(this.m);return 0!==inv.negative?(inv.negative=0,this.imod(inv).redNeg()):this.imod(inv)},Red.prototype.pow=function(a,num){if(num.isZero())return new BN(1).toRed(this);if(0===num.cmpn(1))return a.clone();var wnd=new Array(16);wnd[0]=new BN(1).toRed(this),wnd[1]=a;for(var i=2;i<wnd.length;i++)wnd[i]=this.mul(wnd[i-1],a);var res=wnd[0],current=0,currentLen=0,start=num.bitLength()%26;for(0===start&&(start=26),i=num.length-1;i>=0;i--){for(var word=num.words[i],j=start-1;j>=0;j--){var bit=word>>j&1;res!==wnd[0]&&(res=this.sqr(res)),0!==bit||0!==current?(current<<=1,current|=bit,(4===++currentLen||0===i&&0===j)&&(res=this.mul(res,wnd[current]),currentLen=0,current=0)):currentLen=0}start=26}return res},Red.prototype.convertTo=function(num){var r=num.umod(this.m);return r===num?r.clone():r},Red.prototype.convertFrom=function(num){var res=num.clone();return res.red=null,res},BN.mont=function(num){return new Mont(num)},inherits(Mont,Red),Mont.prototype.convertTo=function(num){return this.imod(num.ushln(this.shift))},Mont.prototype.convertFrom=function(num){var r=this.imod(num.mul(this.rinv));return r.red=null,r},Mont.prototype.imul=function(a,b){if(a.isZero()||b.isZero())return a.words[0]=0,a.length=1,a;var t=a.imul(b),c=t.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),u=t.isub(c).iushrn(this.shift),res=u;return u.cmp(this.m)>=0?res=u.isub(this.m):u.cmpn(0)<0&&(res=u.iadd(this.m)),res._forceRed(this)},Mont.prototype.mul=function(a,b){if(a.isZero()||b.isZero())return new BN(0)._forceRed(this);var t=a.mul(b),c=t.maskn(this.shift).mul(this.minv).imaskn(this.shift).mul(this.m),u=t.isub(c).iushrn(this.shift),res=u;return u.cmp(this.m)>=0?res=u.isub(this.m):u.cmpn(0)<0&&(res=u.iadd(this.m)),res._forceRed(this)},Mont.prototype.invm=function(a){return this.imod(a._invmp(this.m).mul(this.r2))._forceRed(this)}}(module,this)}).call(this,__webpack_require__(147)(module))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){CryptoJS.lib.Cipher||function(undefined){var C=CryptoJS,C_lib=C.lib,Base=C_lib.Base,WordArray=C_lib.WordArray,BufferedBlockAlgorithm=C_lib.BufferedBlockAlgorithm,C_enc=C.enc,Base64=(C_enc.Utf8,C_enc.Base64),EvpKDF=C.algo.EvpKDF,Cipher=C_lib.Cipher=BufferedBlockAlgorithm.extend({cfg:Base.extend(),createEncryptor:function(key,cfg){return this.create(this._ENC_XFORM_MODE,key,cfg)},createDecryptor:function(key,cfg){return this.create(this._DEC_XFORM_MODE,key,cfg)},init:function(xformMode,key,cfg){this.cfg=this.cfg.extend(cfg),this._xformMode=xformMode,this._key=key,this.reset()},reset:function(){BufferedBlockAlgorithm.reset.call(this),this._doReset()},process:function(dataUpdate){return this._append(dataUpdate),this._process()},finalize:function(dataUpdate){return dataUpdate&&this._append(dataUpdate),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function selectCipherStrategy(key){return"string"==typeof key?PasswordBasedCipher:SerializableCipher}return function(cipher){return{encrypt:function(message,key,cfg){return selectCipherStrategy(key).encrypt(cipher,message,key,cfg)},decrypt:function(ciphertext,key,cfg){return selectCipherStrategy(key).decrypt(cipher,ciphertext,key,cfg)}}}}()}),C_mode=(C_lib.StreamCipher=Cipher.extend({_doFinalize:function(){return this._process(!0)},blockSize:1}),C.mode={}),BlockCipherMode=C_lib.BlockCipherMode=Base.extend({createEncryptor:function(cipher,iv){return this.Encryptor.create(cipher,iv)},createDecryptor:function(cipher,iv){return this.Decryptor.create(cipher,iv)},init:function(cipher,iv){this._cipher=cipher,this._iv=iv}}),CBC=C_mode.CBC=function(){var CBC=BlockCipherMode.extend();function xorBlock(words,offset,blockSize){var block,iv=this._iv;iv?(block=iv,this._iv=undefined):block=this._prevBlock;for(var i=0;i<blockSize;i++)words[offset+i]^=block[i]}return CBC.Encryptor=CBC.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize;xorBlock.call(this,words,offset,blockSize),cipher.encryptBlock(words,offset),this._prevBlock=words.slice(offset,offset+blockSize)}}),CBC.Decryptor=CBC.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize,thisBlock=words.slice(offset,offset+blockSize);cipher.decryptBlock(words,offset),xorBlock.call(this,words,offset,blockSize),this._prevBlock=thisBlock}}),CBC}(),Pkcs7=(C.pad={}).Pkcs7={pad:function(data,blockSize){for(var blockSizeBytes=4*blockSize,nPaddingBytes=blockSizeBytes-data.sigBytes%blockSizeBytes,paddingWord=nPaddingBytes<<24|nPaddingBytes<<16|nPaddingBytes<<8|nPaddingBytes,paddingWords=[],i=0;i<nPaddingBytes;i+=4)paddingWords.push(paddingWord);var padding=WordArray.create(paddingWords,nPaddingBytes);data.concat(padding)},unpad:function(data){var nPaddingBytes=255&data.words[data.sigBytes-1>>>2];data.sigBytes-=nPaddingBytes}},CipherParams=(C_lib.BlockCipher=Cipher.extend({cfg:Cipher.cfg.extend({mode:CBC,padding:Pkcs7}),reset:function(){var modeCreator;Cipher.reset.call(this);var cfg=this.cfg,iv=cfg.iv,mode=cfg.mode;this._xformMode==this._ENC_XFORM_MODE?modeCreator=mode.createEncryptor:(modeCreator=mode.createDecryptor,this._minBufferSize=1),this._mode&&this._mode.__creator==modeCreator?this._mode.init(this,iv&&iv.words):(this._mode=modeCreator.call(mode,this,iv&&iv.words),this._mode.__creator=modeCreator)},_doProcessBlock:function(words,offset){this._mode.processBlock(words,offset)},_doFinalize:function(){var finalProcessedBlocks,padding=this.cfg.padding;return this._xformMode==this._ENC_XFORM_MODE?(padding.pad(this._data,this.blockSize),finalProcessedBlocks=this._process(!0)):(finalProcessedBlocks=this._process(!0),padding.unpad(finalProcessedBlocks)),finalProcessedBlocks},blockSize:4}),C_lib.CipherParams=Base.extend({init:function(cipherParams){this.mixIn(cipherParams)},toString:function(formatter){return(formatter||this.formatter).stringify(this)}})),OpenSSLFormatter=(C.format={}).OpenSSL={stringify:function(cipherParams){var ciphertext=cipherParams.ciphertext,salt=cipherParams.salt;return(salt?WordArray.create([1398893684,1701076831]).concat(salt).concat(ciphertext):ciphertext).toString(Base64)},parse:function(openSSLStr){var salt,ciphertext=Base64.parse(openSSLStr),ciphertextWords=ciphertext.words;return 1398893684==ciphertextWords[0]&&1701076831==ciphertextWords[1]&&(salt=WordArray.create(ciphertextWords.slice(2,4)),ciphertextWords.splice(0,4),ciphertext.sigBytes-=16),CipherParams.create({ciphertext:ciphertext,salt:salt})}},SerializableCipher=C_lib.SerializableCipher=Base.extend({cfg:Base.extend({format:OpenSSLFormatter}),encrypt:function(cipher,message,key,cfg){cfg=this.cfg.extend(cfg);var encryptor=cipher.createEncryptor(key,cfg),ciphertext=encryptor.finalize(message),cipherCfg=encryptor.cfg;return CipherParams.create({ciphertext:ciphertext,key:key,iv:cipherCfg.iv,algorithm:cipher,mode:cipherCfg.mode,padding:cipherCfg.padding,blockSize:cipher.blockSize,formatter:cfg.format})},decrypt:function(cipher,ciphertext,key,cfg){return cfg=this.cfg.extend(cfg),ciphertext=this._parse(ciphertext,cfg.format),cipher.createDecryptor(key,cfg).finalize(ciphertext.ciphertext)},_parse:function(ciphertext,format){return"string"==typeof ciphertext?format.parse(ciphertext,this):ciphertext}}),OpenSSLKdf=(C.kdf={}).OpenSSL={execute:function(password,keySize,ivSize,salt){salt||(salt=WordArray.random(8));var key=EvpKDF.create({keySize:keySize+ivSize}).compute(password,salt),iv=WordArray.create(key.words.slice(keySize),4*ivSize);return key.sigBytes=4*keySize,CipherParams.create({key:key,iv:iv,salt:salt})}},PasswordBasedCipher=C_lib.PasswordBasedCipher=SerializableCipher.extend({cfg:SerializableCipher.cfg.extend({kdf:OpenSSLKdf}),encrypt:function(cipher,message,password,cfg){var derivedParams=(cfg=this.cfg.extend(cfg)).kdf.execute(password,cipher.keySize,cipher.ivSize);cfg.iv=derivedParams.iv;var ciphertext=SerializableCipher.encrypt.call(this,cipher,message,derivedParams.key,cfg);return ciphertext.mixIn(derivedParams),ciphertext},decrypt:function(cipher,ciphertext,password,cfg){cfg=this.cfg.extend(cfg),ciphertext=this._parse(ciphertext,cfg.format);var derivedParams=cfg.kdf.execute(password,cipher.keySize,cipher.ivSize,ciphertext.salt);return cfg.iv=derivedParams.iv,SerializableCipher.decrypt.call(this,cipher,ciphertext,derivedParams.key,cfg)}})}()}(__webpack_require__(2),__webpack_require__(15))},function(module,exports,__webpack_require__){"use strict";var elliptic=exports;elliptic.version=__webpack_require__(154).version,elliptic.utils=__webpack_require__(155),elliptic.rand=__webpack_require__(70),elliptic.curve=__webpack_require__(31),elliptic.curves=__webpack_require__(160),elliptic.ec=__webpack_require__(168),elliptic.eddsa=__webpack_require__(172)},function(module,exports){function assert(val,msg){if(!val)throw new Error(msg||"Assertion failed")}module.exports=assert,assert.equal=function(l,r,msg){if(l!=r)throw new Error(msg||"Assertion failed: "+l+" != "+r)}},function(module,exports){var g;g=function(){return this}();try{g=g||new Function("return this")()}catch(e){"object"==typeof window&&(g=window)}module.exports=g},function(module,exports,__webpack_require__){"use strict";var assert=__webpack_require__(9),inherits=__webpack_require__(1);function htonl(w){return(w>>>24|w>>>8&65280|w<<8&16711680|(255&w)<<24)>>>0}function zero2(word){return 1===word.length?"0"+word:word}function zero8(word){return 7===word.length?"0"+word:6===word.length?"00"+word:5===word.length?"000"+word:4===word.length?"0000"+word:3===word.length?"00000"+word:2===word.length?"000000"+word:1===word.length?"0000000"+word:word}exports.inherits=inherits,exports.toArray=function(msg,enc){if(Array.isArray(msg))return msg.slice();if(!msg)return[];var res=[];if("string"==typeof msg)if(enc){if("hex"===enc)for((msg=msg.replace(/[^a-z0-9]+/gi,"")).length%2!=0&&(msg="0"+msg),i=0;i<msg.length;i+=2)res.push(parseInt(msg[i]+msg[i+1],16))}else for(var i=0;i<msg.length;i++){var c=msg.charCodeAt(i),hi=c>>8,lo=255&c;hi?res.push(hi,lo):res.push(lo)}else for(i=0;i<msg.length;i++)res[i]=0|msg[i];return res},exports.toHex=function(msg){for(var res="",i=0;i<msg.length;i++)res+=zero2(msg[i].toString(16));return res},exports.htonl=htonl,exports.toHex32=function(msg,endian){for(var res="",i=0;i<msg.length;i++){var w=msg[i];"little"===endian&&(w=htonl(w)),res+=zero8(w.toString(16))}return res},exports.zero2=zero2,exports.zero8=zero8,exports.join32=function(msg,start,end,endian){var len=end-start;assert(len%4==0);for(var res=new Array(len/4),i=0,k=start;i<res.length;i++,k+=4){var w;w="big"===endian?msg[k]<<24|msg[k+1]<<16|msg[k+2]<<8|msg[k+3]:msg[k+3]<<24|msg[k+2]<<16|msg[k+1]<<8|msg[k],res[i]=w>>>0}return res},exports.split32=function(msg,endian){for(var res=new Array(4*msg.length),i=0,k=0;i<msg.length;i++,k+=4){var m=msg[i];"big"===endian?(res[k]=m>>>24,res[k+1]=m>>>16&255,res[k+2]=m>>>8&255,res[k+3]=255&m):(res[k+3]=m>>>24,res[k+2]=m>>>16&255,res[k+1]=m>>>8&255,res[k]=255&m)}return res},exports.rotr32=function(w,b){return w>>>b|w<<32-b},exports.rotl32=function(w,b){return w<<b|w>>>32-b},exports.sum32=function(a,b){return a+b>>>0},exports.sum32_3=function(a,b,c){return a+b+c>>>0},exports.sum32_4=function(a,b,c,d){return a+b+c+d>>>0},exports.sum32_5=function(a,b,c,d,e){return a+b+c+d+e>>>0},exports.sum64=function(buf,pos,ah,al){var bh=buf[pos],lo=al+buf[pos+1]>>>0,hi=(lo<al?1:0)+ah+bh;buf[pos]=hi>>>0,buf[pos+1]=lo},exports.sum64_hi=function(ah,al,bh,bl){return(al+bl>>>0<al?1:0)+ah+bh>>>0},exports.sum64_lo=function(ah,al,bh,bl){return al+bl>>>0},exports.sum64_4_hi=function(ah,al,bh,bl,ch,cl,dh,dl){var carry=0,lo=al;return carry+=(lo=lo+bl>>>0)<al?1:0,carry+=(lo=lo+cl>>>0)<cl?1:0,ah+bh+ch+dh+(carry+=(lo=lo+dl>>>0)<dl?1:0)>>>0},exports.sum64_4_lo=function(ah,al,bh,bl,ch,cl,dh,dl){return al+bl+cl+dl>>>0},exports.sum64_5_hi=function(ah,al,bh,bl,ch,cl,dh,dl,eh,el){var carry=0,lo=al;return carry+=(lo=lo+bl>>>0)<al?1:0,carry+=(lo=lo+cl>>>0)<cl?1:0,carry+=(lo=lo+dl>>>0)<dl?1:0,ah+bh+ch+dh+eh+(carry+=(lo=lo+el>>>0)<el?1:0)>>>0},exports.sum64_5_lo=function(ah,al,bh,bl,ch,cl,dh,dl,eh,el){return al+bl+cl+dl+el>>>0},exports.rotr64_hi=function(ah,al,num){return(al<<32-num|ah>>>num)>>>0},exports.rotr64_lo=function(ah,al,num){return(ah<<32-num|al>>>num)>>>0},exports.shr64_hi=function(ah,al,num){return ah>>>num},exports.shr64_lo=function(ah,al,num){return(ah<<32-num|al>>>num)>>>0}},function(module,exports){var cachedSetTimeout,cachedClearTimeout,process=module.exports={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,function(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},function(module,exports,__webpack_require__){var Buffer=__webpack_require__(4).Buffer,Transform=__webpack_require__(35).Transform,StringDecoder=__webpack_require__(38).StringDecoder;function CipherBase(hashMode){Transform.call(this),this.hashMode="string"==typeof hashMode,this.hashMode?this[hashMode]=this._finalOrDigest:this.final=this._finalOrDigest,this._final&&(this.__final=this._final,this._final=null),this._decoder=null,this._encoding=null}__webpack_require__(1)(CipherBase,Transform),CipherBase.prototype.update=function(data,inputEnc,outputEnc){"string"==typeof data&&(data=Buffer.from(data,inputEnc));var outData=this._update(data);return this.hashMode?this:(outputEnc&&(outData=this._toString(outData,outputEnc)),outData)},CipherBase.prototype.setAutoPadding=function(){},CipherBase.prototype.getAuthTag=function(){throw new Error("trying to get auth tag in unsupported state")},CipherBase.prototype.setAuthTag=function(){throw new Error("trying to set auth tag in unsupported state")},CipherBase.prototype.setAAD=function(){throw new Error("trying to set aad in unsupported state")},CipherBase.prototype._transform=function(data,_,next){var err;try{this.hashMode?this._update(data):this.push(this._update(data))}catch(e){err=e}finally{next(err)}},CipherBase.prototype._flush=function(done){var err;try{this.push(this.__final())}catch(e){err=e}done(err)},CipherBase.prototype._finalOrDigest=function(outputEnc){var outData=this.__final()||Buffer.alloc(0);return outputEnc&&(outData=this._toString(outData,outputEnc,!0)),outData},CipherBase.prototype._toString=function(value,enc,fin){if(this._decoder||(this._decoder=new StringDecoder(enc),this._encoding=enc),this._encoding!==enc)throw new Error("can't switch encodings");var out=this._decoder.write(value);return fin&&(out+=this._decoder.end()),out},module.exports=CipherBase},function(module,exports,__webpack_require__){"use strict";var pna=__webpack_require__(28),objectKeys=Object.keys||function(obj){var keys=[];for(var key in obj)keys.push(key);return keys};module.exports=Duplex;var util=__webpack_require__(22);util.inherits=__webpack_require__(1);var Readable=__webpack_require__(50),Writable=__webpack_require__(37);util.inherits(Duplex,Readable);for(var keys=objectKeys(Writable.prototype),v=0;v<keys.length;v++){var method=keys[v];Duplex.prototype[method]||(Duplex.prototype[method]=Writable.prototype[method])}function Duplex(options){if(!(this instanceof Duplex))return new Duplex(options);Readable.call(this,options),Writable.call(this,options),options&&!1===options.readable&&(this.readable=!1),options&&!1===options.writable&&(this.writable=!1),this.allowHalfOpen=!0,options&&!1===options.allowHalfOpen&&(this.allowHalfOpen=!1),this.once("end",onend)}function onend(){this.allowHalfOpen||this._writableState.ended||pna.nextTick(onEndNT,this)}function onEndNT(self){self.end()}Object.defineProperty(Duplex.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(Duplex.prototype,"destroyed",{get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed&&this._writableState.destroyed)},set:function(value){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=value,this._writableState.destroyed=value)}}),Duplex.prototype._destroy=function(err,cb){this.push(null),this.end(),pna.nextTick(cb,err)}},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return C_lib=(C=CryptoJS).lib,Base=C_lib.Base,WordArray=C_lib.WordArray,C_algo=C.algo,MD5=C_algo.MD5,EvpKDF=C_algo.EvpKDF=Base.extend({cfg:Base.extend({keySize:4,hasher:MD5,iterations:1}),init:function(cfg){this.cfg=this.cfg.extend(cfg)},compute:function(password,salt){for(var block,cfg=this.cfg,hasher=cfg.hasher.create(),derivedKey=WordArray.create(),derivedKeyWords=derivedKey.words,keySize=cfg.keySize,iterations=cfg.iterations;derivedKeyWords.length<keySize;){block&&hasher.update(block),block=hasher.update(password).finalize(salt),hasher.reset();for(var i=1;i<iterations;i++)block=hasher.finalize(block),hasher.reset();derivedKey.concat(block)}return derivedKey.sigBytes=4*keySize,derivedKey}}),C.EvpKDF=function(password,salt,cfg){return EvpKDF.create(cfg).compute(password,salt)},CryptoJS.EvpKDF;var C,C_lib,Base,WordArray,C_algo,MD5,EvpKDF}(__webpack_require__(2),__webpack_require__(46),__webpack_require__(47))},function(module,exports,__webpack_require__){"use strict";(function(global,process){var Buffer=__webpack_require__(4).Buffer,crypto=global.crypto||global.msCrypto;crypto&&crypto.getRandomValues?module.exports=function(size,cb){if(size>65536)throw new Error("requested too many random bytes");var rawBytes=new global.Uint8Array(size);size>0&&crypto.getRandomValues(rawBytes);var bytes=Buffer.from(rawBytes.buffer);if("function"==typeof cb)return process.nextTick((function(){cb(null,bytes)}));return bytes}:module.exports=function(){throw new Error("Secure random number generation is not supported by this browser.\nUse Chrome, Firefox or Internet Explorer 11")}}).call(this,__webpack_require__(10),__webpack_require__(12))},function(module,exports,__webpack_require__){var Buffer=__webpack_require__(4).Buffer;function Hash(blockSize,finalSize){this._block=Buffer.alloc(blockSize),this._finalSize=finalSize,this._blockSize=blockSize,this._len=0}Hash.prototype.update=function(data,enc){"string"==typeof data&&(enc=enc||"utf8",data=Buffer.from(data,enc));for(var block=this._block,blockSize=this._blockSize,length=data.length,accum=this._len,offset=0;offset<length;){for(var assigned=accum%blockSize,remainder=Math.min(length-offset,blockSize-assigned),i=0;i<remainder;i++)block[assigned+i]=data[offset+i];offset+=remainder,(accum+=remainder)%blockSize==0&&this._update(block)}return this._len+=length,this},Hash.prototype.digest=function(enc){var rem=this._len%this._blockSize;this._block[rem]=128,this._block.fill(0,rem+1),rem>=this._finalSize&&(this._update(this._block),this._block.fill(0));var bits=8*this._len;if(bits<=4294967295)this._block.writeUInt32BE(bits,this._blockSize-4);else{var lowBits=(4294967295&bits)>>>0,highBits=(bits-lowBits)/4294967296;this._block.writeUInt32BE(highBits,this._blockSize-8),this._block.writeUInt32BE(lowBits,this._blockSize-4)}this._update(this._block);var hash=this._hash();return enc?hash.toString(enc):hash},Hash.prototype._update=function(){throw new Error("_update must be implemented by subclass")},module.exports=Hash},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return WordArray=(C=CryptoJS).lib.WordArray,C.enc.Base64={stringify:function(wordArray){var words=wordArray.words,sigBytes=wordArray.sigBytes,map=this._map;wordArray.clamp();for(var base64Chars=[],i=0;i<sigBytes;i+=3)for(var triplet=(words[i>>>2]>>>24-i%4*8&255)<<16|(words[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|words[i+2>>>2]>>>24-(i+2)%4*8&255,j=0;j<4&&i+.75*j<sigBytes;j++)base64Chars.push(map.charAt(triplet>>>6*(3-j)&63));var paddingChar=map.charAt(64);if(paddingChar)for(;base64Chars.length%4;)base64Chars.push(paddingChar);return base64Chars.join("")},parse:function(base64Str){var base64StrLength=base64Str.length,map=this._map,reverseMap=this._reverseMap;if(!reverseMap){reverseMap=this._reverseMap=[];for(var j=0;j<map.length;j++)reverseMap[map.charCodeAt(j)]=j}var paddingChar=map.charAt(64);if(paddingChar){var paddingIndex=base64Str.indexOf(paddingChar);-1!==paddingIndex&&(base64StrLength=paddingIndex)}return function(base64Str,base64StrLength,reverseMap){for(var words=[],nBytes=0,i=0;i<base64StrLength;i++)if(i%4){var bits1=reverseMap[base64Str.charCodeAt(i-1)]<<i%4*2,bits2=reverseMap[base64Str.charCodeAt(i)]>>>6-i%4*2,bitsCombined=bits1|bits2;words[nBytes>>>2]|=bitsCombined<<24-nBytes%4*8,nBytes++}return WordArray.create(words,nBytes)}(base64Str,base64StrLength,reverseMap)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},CryptoJS.enc.Base64;var C,WordArray}(__webpack_require__(2))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return function(Math){var C=CryptoJS,C_lib=C.lib,WordArray=C_lib.WordArray,Hasher=C_lib.Hasher,C_algo=C.algo,T=[];!function(){for(var i=0;i<64;i++)T[i]=4294967296*Math.abs(Math.sin(i+1))|0}();var MD5=C_algo.MD5=Hasher.extend({_doReset:function(){this._hash=new WordArray.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(M,offset){for(var i=0;i<16;i++){var offset_i=offset+i,M_offset_i=M[offset_i];M[offset_i]=16711935&(M_offset_i<<8|M_offset_i>>>24)|4278255360&(M_offset_i<<24|M_offset_i>>>8)}var H=this._hash.words,M_offset_0=M[offset+0],M_offset_1=M[offset+1],M_offset_2=M[offset+2],M_offset_3=M[offset+3],M_offset_4=M[offset+4],M_offset_5=M[offset+5],M_offset_6=M[offset+6],M_offset_7=M[offset+7],M_offset_8=M[offset+8],M_offset_9=M[offset+9],M_offset_10=M[offset+10],M_offset_11=M[offset+11],M_offset_12=M[offset+12],M_offset_13=M[offset+13],M_offset_14=M[offset+14],M_offset_15=M[offset+15],a=H[0],b=H[1],c=H[2],d=H[3];a=FF(a,b,c,d,M_offset_0,7,T[0]),d=FF(d,a,b,c,M_offset_1,12,T[1]),c=FF(c,d,a,b,M_offset_2,17,T[2]),b=FF(b,c,d,a,M_offset_3,22,T[3]),a=FF(a,b,c,d,M_offset_4,7,T[4]),d=FF(d,a,b,c,M_offset_5,12,T[5]),c=FF(c,d,a,b,M_offset_6,17,T[6]),b=FF(b,c,d,a,M_offset_7,22,T[7]),a=FF(a,b,c,d,M_offset_8,7,T[8]),d=FF(d,a,b,c,M_offset_9,12,T[9]),c=FF(c,d,a,b,M_offset_10,17,T[10]),b=FF(b,c,d,a,M_offset_11,22,T[11]),a=FF(a,b,c,d,M_offset_12,7,T[12]),d=FF(d,a,b,c,M_offset_13,12,T[13]),c=FF(c,d,a,b,M_offset_14,17,T[14]),a=GG(a,b=FF(b,c,d,a,M_offset_15,22,T[15]),c,d,M_offset_1,5,T[16]),d=GG(d,a,b,c,M_offset_6,9,T[17]),c=GG(c,d,a,b,M_offset_11,14,T[18]),b=GG(b,c,d,a,M_offset_0,20,T[19]),a=GG(a,b,c,d,M_offset_5,5,T[20]),d=GG(d,a,b,c,M_offset_10,9,T[21]),c=GG(c,d,a,b,M_offset_15,14,T[22]),b=GG(b,c,d,a,M_offset_4,20,T[23]),a=GG(a,b,c,d,M_offset_9,5,T[24]),d=GG(d,a,b,c,M_offset_14,9,T[25]),c=GG(c,d,a,b,M_offset_3,14,T[26]),b=GG(b,c,d,a,M_offset_8,20,T[27]),a=GG(a,b,c,d,M_offset_13,5,T[28]),d=GG(d,a,b,c,M_offset_2,9,T[29]),c=GG(c,d,a,b,M_offset_7,14,T[30]),a=HH(a,b=GG(b,c,d,a,M_offset_12,20,T[31]),c,d,M_offset_5,4,T[32]),d=HH(d,a,b,c,M_offset_8,11,T[33]),c=HH(c,d,a,b,M_offset_11,16,T[34]),b=HH(b,c,d,a,M_offset_14,23,T[35]),a=HH(a,b,c,d,M_offset_1,4,T[36]),d=HH(d,a,b,c,M_offset_4,11,T[37]),c=HH(c,d,a,b,M_offset_7,16,T[38]),b=HH(b,c,d,a,M_offset_10,23,T[39]),a=HH(a,b,c,d,M_offset_13,4,T[40]),d=HH(d,a,b,c,M_offset_0,11,T[41]),c=HH(c,d,a,b,M_offset_3,16,T[42]),b=HH(b,c,d,a,M_offset_6,23,T[43]),a=HH(a,b,c,d,M_offset_9,4,T[44]),d=HH(d,a,b,c,M_offset_12,11,T[45]),c=HH(c,d,a,b,M_offset_15,16,T[46]),a=II(a,b=HH(b,c,d,a,M_offset_2,23,T[47]),c,d,M_offset_0,6,T[48]),d=II(d,a,b,c,M_offset_7,10,T[49]),c=II(c,d,a,b,M_offset_14,15,T[50]),b=II(b,c,d,a,M_offset_5,21,T[51]),a=II(a,b,c,d,M_offset_12,6,T[52]),d=II(d,a,b,c,M_offset_3,10,T[53]),c=II(c,d,a,b,M_offset_10,15,T[54]),b=II(b,c,d,a,M_offset_1,21,T[55]),a=II(a,b,c,d,M_offset_8,6,T[56]),d=II(d,a,b,c,M_offset_15,10,T[57]),c=II(c,d,a,b,M_offset_6,15,T[58]),b=II(b,c,d,a,M_offset_13,21,T[59]),a=II(a,b,c,d,M_offset_4,6,T[60]),d=II(d,a,b,c,M_offset_11,10,T[61]),c=II(c,d,a,b,M_offset_2,15,T[62]),b=II(b,c,d,a,M_offset_9,21,T[63]),H[0]=H[0]+a|0,H[1]=H[1]+b|0,H[2]=H[2]+c|0,H[3]=H[3]+d|0},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsTotal=8*this._nDataBytes,nBitsLeft=8*data.sigBytes;dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32;var nBitsTotalH=Math.floor(nBitsTotal/4294967296),nBitsTotalL=nBitsTotal;dataWords[15+(nBitsLeft+64>>>9<<4)]=16711935&(nBitsTotalH<<8|nBitsTotalH>>>24)|4278255360&(nBitsTotalH<<24|nBitsTotalH>>>8),dataWords[14+(nBitsLeft+64>>>9<<4)]=16711935&(nBitsTotalL<<8|nBitsTotalL>>>24)|4278255360&(nBitsTotalL<<24|nBitsTotalL>>>8),data.sigBytes=4*(dataWords.length+1),this._process();for(var hash=this._hash,H=hash.words,i=0;i<4;i++){var H_i=H[i];H[i]=16711935&(H_i<<8|H_i>>>24)|4278255360&(H_i<<24|H_i>>>8)}return hash},clone:function(){var clone=Hasher.clone.call(this);return clone._hash=this._hash.clone(),clone}});function FF(a,b,c,d,x,s,t){var n=a+(b&c|~b&d)+x+t;return(n<<s|n>>>32-s)+b}function GG(a,b,c,d,x,s,t){var n=a+(b&d|c&~d)+x+t;return(n<<s|n>>>32-s)+b}function HH(a,b,c,d,x,s,t){var n=a+(b^c^d)+x+t;return(n<<s|n>>>32-s)+b}function II(a,b,c,d,x,s,t){var n=a+(c^(b|~d))+x+t;return(n<<s|n>>>32-s)+b}C.MD5=Hasher._createHelper(MD5),C.HmacMD5=Hasher._createHmacHelper(MD5)}(Math),CryptoJS.MD5}(__webpack_require__(2))},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var int64_buffer_1=__webpack_require__(85),EBMLEncoder_1=__webpack_require__(86),_Buffer=__webpack_require__(5),_tools=__webpack_require__(290),_block=__webpack_require__(291);function WebPBlockFilter(elms){return elms.reduce((function(lst,elm){return"b"!==elm.type?lst:"SimpleBlock"!==elm.name?lst:exports.ebmlBlock(elm.data).frames.some((function(frame){return"9d012a"===frame.slice(3,6).toString("hex")}))?lst.concat(elm):lst}),[])}function VP8BitStreamToRiffWebPBuffer(frame){var VP8Chunk=createRIFFChunk("VP8 ",frame);return createRIFFChunk("RIFF",concat([new exports.Buffer("WEBP","ascii"),VP8Chunk]))}function createRIFFChunk(FourCC,chunk){var chunkSize=new exports.Buffer(4);return chunkSize.writeUInt32LE(chunk.byteLength,0),concat([new exports.Buffer(FourCC.substr(0,4),"ascii"),chunkSize,chunk,new exports.Buffer(chunk.byteLength%2==0?0:1)])}function removeElement(idName,metadata){for(var start=-1,i=0;i<metadata.length;i++){var element=metadata[i];if(element.name===idName){if("m"!==element.type)return void metadata.splice(i,1);if(element.isEnd){if(-1==start)throw new Error("Detected "+idName+" closing element before finding the start");return void metadata.splice(start,i-start+1)}start=i}}}function extractElement(idName,metadata){for(var result=[],start=-1,i=0;i<metadata.length;i++){var element=metadata[i];if(element.name===idName){if("m"!==element.type){result.push(metadata[i]);break}if(element.isEnd){if(-1==start)throw new Error("Detected "+idName+" closing element before finding the start");result=metadata.slice(start,i+1);break}start=i}}return result}function encodedSizeOfEbml(refinedMetaData){var encorder=new EBMLEncoder_1.default;return refinedMetaData.reduce((function(lst,elm){return lst.concat(encorder.encode([elm]))}),[]).reduce((function(o,buf){return o+buf.byteLength}),0)}function refineMetadata(mesetadata,sizeDiff,info){var duration=info.duration,clusterPtrs=info.clusterPtrs,cues=info.cues,_metadata=mesetadata.slice(0);if("number"==typeof duration){var overwrited_1=!1;_metadata.forEach((function(elm){"f"===elm.type&&"Duration"===elm.name&&(overwrited_1=!0,elm.data=createFloatBuffer(duration,8))})),overwrited_1||insertTag(_metadata,"Info",[{name:"Duration",type:"f",data:createFloatBuffer(duration,8)}])}Array.isArray(cues)&&insertTag(_metadata,"Cues",function(cueInfos,sizeDiff){var cues=[];return cueInfos.forEach((function(_a){var CueTrack=_a.CueTrack,CueClusterPosition=_a.CueClusterPosition,CueTime=_a.CueTime;cues.push({name:"CuePoint",type:"m",isEnd:!1}),cues.push({name:"CueTime",type:"u",data:createUIntBuffer(CueTime)}),cues.push({name:"CueTrackPositions",type:"m",isEnd:!1}),cues.push({name:"CueTrack",type:"u",data:createUIntBuffer(CueTrack)}),cues.push({name:"CueClusterPosition",type:"u",data:createUIntBuffer(CueClusterPosition+sizeDiff)}),cues.push({name:"CueTrackPositions",type:"m",isEnd:!0}),cues.push({name:"CuePoint",type:"m",isEnd:!0})})),cues}(cues,sizeDiff));var seekhead_children=[];return Array.isArray(clusterPtrs)&&(console.warn("append cluster pointers to seekhead is deprecated. please use cues"),seekhead_children=function(clusterPtrs,sizeDiff){var seeks=[];return clusterPtrs.forEach((function(start){seeks.push({name:"Seek",type:"m",isEnd:!1}),seeks.push({name:"SeekID",type:"b",data:new exports.Buffer([31,67,182,117])}),seeks.push({name:"SeekPosition",type:"u",data:createUIntBuffer(start+sizeDiff)}),seeks.push({name:"Seek",type:"m",isEnd:!0})})),seeks}(clusterPtrs,sizeDiff)),insertTag(_metadata,"SeekHead",seekhead_children,!0),_metadata}function insertTag(_metadata,tagName,children,insertHead){void 0===insertHead&&(insertHead=!1);for(var idx=-1,i=0;i<_metadata.length;i++){var elm=_metadata[i];if("m"===elm.type&&elm.name===tagName&&!1===elm.isEnd){idx=i;break}}idx>=0?Array.prototype.splice.apply(_metadata,[idx+1,0].concat(children)):insertHead?[].concat([{name:tagName,type:"m",isEnd:!1}],children,[{name:tagName,type:"m",isEnd:!0}]).reverse().forEach((function(elm){_metadata.unshift(elm)})):(_metadata.push({name:tagName,type:"m",isEnd:!1}),children.forEach((function(elm){_metadata.push(elm)})),_metadata.push({name:tagName,type:"m",isEnd:!0}))}function concat(list){for(var i=0,length=0;i<list.length;++i)length+=list[i].length;var buffer=exports.Buffer.allocUnsafe(length),pos=0;for(i=0;i<list.length;++i){var buf=list[i];buf.copy(buffer,pos),pos+=buf.length}return buffer}function createUIntBuffer(value){for(var bytes=1;value>=Math.pow(2,8*bytes);bytes++);if(bytes>=7)return console.warn("7bit or more bigger uint not supported."),new int64_buffer_1.Uint64BE(value).toBuffer();var data=new exports.Buffer(bytes);return data.writeUIntBE(value,0,bytes),data}function createIntBuffer(value){for(var bytes=1;value>=Math.pow(2,8*bytes);bytes++);if(bytes>=7)return console.warn("7bit or more bigger uint not supported."),new int64_buffer_1.Int64BE(value).toBuffer();var data=new exports.Buffer(bytes);return data.writeIntBE(value,0,bytes),data}function createFloatBuffer(value,bytes){var data;if(void 0===bytes&&(bytes=8),8===bytes)return(data=new exports.Buffer(8)).writeDoubleBE(value,0),data;if(4===bytes)return(data=new exports.Buffer(4)).writeFloatBE(value,0),data;throw new Error("float type bits must 4bytes or 8bytes")}exports.Buffer=_Buffer.Buffer,exports.readVint=_tools.readVint,exports.writeVint=_tools.writeVint,exports.ebmlBlock=_block,exports.readBlock=function(buf){return exports.ebmlBlock(new exports.Buffer(buf))},exports.encodeTag=function(tagId,tagData,unknownSize){return void 0===unknownSize&&(unknownSize=!1),concat([tagId,unknownSize?new exports.Buffer("01ffffffffffffff","hex"):exports.writeVint(tagData.length),tagData])},exports.WebPFrameFilter=function(elms){return WebPBlockFilter(elms).reduce((function(lst,elm){return exports.ebmlBlock(elm.data).frames.reduce((function(lst,frame){var webpBuf=VP8BitStreamToRiffWebPBuffer(frame),webp=new Blob([webpBuf],{type:"image/webp"});return lst.concat(webp)}),lst)}),[])},exports.WebPBlockFilter=WebPBlockFilter,exports.VP8BitStreamToRiffWebPBuffer=VP8BitStreamToRiffWebPBuffer,exports.createRIFFChunk=createRIFFChunk,exports.makeMetadataSeekable=function(originalMetadata,duration,cuesInfo){var header=extractElement("EBML",originalMetadata),segmentContentStartPos=encodedSizeOfEbml(header)+12,originalMetadataSize=originalMetadata[originalMetadata.length-1].dataEnd-segmentContentStartPos,info=extractElement("Info",originalMetadata);removeElement("Duration",info),info.splice(1,0,{name:"Duration",type:"f",data:createFloatBuffer(duration,8)});for(var infoSize=encodedSizeOfEbml(info),tracks=extractElement("Tracks",originalMetadata),tracksSize=encodedSizeOfEbml(tracks),seekHeadSize=47,seekHead=[],cuesSize=5+15*cuesInfo.length,cues=[],lastSizeDifference=-1,_loop_1=function(i){var infoStart=seekHeadSize,tracksStart=infoStart+infoSize,cuesStart=tracksStart+tracksSize,sizeDifference=cuesStart+cuesSize-originalMetadataSize;if((seekHead=[]).push({name:"SeekHead",type:"m",isEnd:!1}),seekHead.push({name:"Seek",type:"m",isEnd:!1}),seekHead.push({name:"SeekID",type:"b",data:new exports.Buffer([21,73,169,102])}),seekHead.push({name:"SeekPosition",type:"u",data:createUIntBuffer(infoStart)}),seekHead.push({name:"Seek",type:"m",isEnd:!0}),seekHead.push({name:"Seek",type:"m",isEnd:!1}),seekHead.push({name:"SeekID",type:"b",data:new exports.Buffer([22,84,174,107])}),seekHead.push({name:"SeekPosition",type:"u",data:createUIntBuffer(tracksStart)}),seekHead.push({name:"Seek",type:"m",isEnd:!0}),seekHead.push({name:"Seek",type:"m",isEnd:!1}),seekHead.push({name:"SeekID",type:"b",data:new exports.Buffer([28,83,187,107])}),seekHead.push({name:"SeekPosition",type:"u",data:createUIntBuffer(cuesStart)}),seekHead.push({name:"Seek",type:"m",isEnd:!0}),seekHead.push({name:"SeekHead",type:"m",isEnd:!0}),seekHeadSize=encodedSizeOfEbml(seekHead),(cues=[]).push({name:"Cues",type:"m",isEnd:!1}),cuesInfo.forEach((function(_a){var CueTrack=_a.CueTrack,CueClusterPosition=_a.CueClusterPosition,CueTime=_a.CueTime;cues.push({name:"CuePoint",type:"m",isEnd:!1}),cues.push({name:"CueTime",type:"u",data:createUIntBuffer(CueTime)}),cues.push({name:"CueTrackPositions",type:"m",isEnd:!1}),cues.push({name:"CueTrack",type:"u",data:createUIntBuffer(CueTrack)}),CueClusterPosition-=segmentContentStartPos,CueClusterPosition+=sizeDifference,cues.push({name:"CueClusterPosition",type:"u",data:createUIntBuffer(CueClusterPosition)}),cues.push({name:"CueTrackPositions",type:"m",isEnd:!0}),cues.push({name:"CuePoint",type:"m",isEnd:!0})})),cues.push({name:"Cues",type:"m",isEnd:!0}),cuesSize=encodedSizeOfEbml(cues),lastSizeDifference===sizeDifference)return"break";if(lastSizeDifference=sizeDifference,9===i)throw new Error("Failed to converge to a stable metadata size")},i=0;i<10;i++){if("break"===_loop_1(i))break}var finalMetadata=[].concat.apply([],[header,{name:"Segment",type:"m",isEnd:!1,unknownSize:!0},seekHead,info,tracks,cues]);return(new EBMLEncoder_1.default).encode(finalMetadata)},exports.removeElement=removeElement,exports.extractElement=extractElement,exports.putRefinedMetaData=function(metadata,info){Array.isArray(info.cueInfos)&&!Array.isArray(info.cues)&&(console.warn("putRefinedMetaData: info.cueInfos property is deprecated. please use info.cues"),info.cues=info.cueInfos);for(var ebml=[],payload=[],i_1=0;i_1<metadata.length;i_1++){var elm=metadata[i_1];if("m"===elm.type&&"Segment"===elm.name){if(ebml=metadata.slice(0,i_1),payload=metadata.slice(i_1),elm.unknownSize){payload.shift();break}throw new Error("this metadata is not streaming webm file")}}if(!(payload[payload.length-1].dataEnd>0))throw new Error("metadata dataEnd has wrong number");var i,originalPayloadOffsetEnd=payload[payload.length-1].dataEnd,ebmlSize=ebml[ebml.length-1].dataEnd,offsetDiff=(new EBMLEncoder_1.default).encode(ebml).byteLength-ebmlSize,payloadSize=originalPayloadOffsetEnd-payload[0].tagStart,segmentTagBuf=(payload[0].tagStart,payload[0].tagStart,new exports.Buffer([24,83,128,103])),segmentSizeBuf=new exports.Buffer("01ffffffffffffff","hex"),_segmentSize=segmentTagBuf.byteLength+segmentSizeBuf.byteLength,newPayloadSize=payloadSize;for(i=1;i<20;i++){var refined=refineMetadata(payload,offsetDiff+(ebmlSize+_segmentSize+newPayloadSize-originalPayloadOffsetEnd),info),newNewRefinedSize=(new EBMLEncoder_1.default).encode(refined).byteLength;if(newNewRefinedSize===newPayloadSize)return(new EBMLEncoder_1.default).encode([].concat(ebml,[{type:"m",name:"Segment",isEnd:!1,unknownSize:!0}],refined));newPayloadSize=newNewRefinedSize}throw new Error("unable to refine metadata, stable size could not be found in "+i+" iterations!")},exports.concat=concat,exports.encodeValueToBuffer=function(elm){var data=new exports.Buffer(0);if("m"===elm.type)return elm;switch(elm.type){case"u":data=createUIntBuffer(elm.value);break;case"i":data=createIntBuffer(elm.value);break;case"f":data=createFloatBuffer(elm.value);break;case"s":data=new exports.Buffer(elm.value,"ascii");break;case"8":data=new exports.Buffer(elm.value,"utf8");break;case"b":data=elm.value;break;case"d":data=new int64_buffer_1.Int64BE(elm.value.getTime().toString()).toBuffer()}return Object.assign({},elm,{data:data})},exports.createUIntBuffer=createUIntBuffer,exports.createIntBuffer=createIntBuffer,exports.createFloatBuffer=createFloatBuffer,exports.convertEBMLDateToJSDate=function(int64str){return int64str instanceof Date?int64str:new Date(new Date("2001-01-01T00:00:00.000Z").getTime()+Number(int64str)/1e3/1e3)}},function(module,exports,__webpack_require__){"use strict";var inherits=__webpack_require__(1),MD5=__webpack_require__(34),RIPEMD160=__webpack_require__(39),sha=__webpack_require__(40),Base=__webpack_require__(13);function Hash(hash){Base.call(this,"digest"),this._hash=hash}inherits(Hash,Base),Hash.prototype._update=function(data){this._hash.update(data)},Hash.prototype._final=function(){return this._hash.digest()},module.exports=function(alg){return"md5"===(alg=alg.toLowerCase())?new MD5:"rmd160"===alg||"ripemd160"===alg?new RIPEMD160:new Hash(sha(alg))}},function(module,exports,__webpack_require__){(function(Buffer){function objectToString(o){return Object.prototype.toString.call(o)}exports.isArray=function(arg){return Array.isArray?Array.isArray(arg):"[object Array]"===objectToString(arg)},exports.isBoolean=function(arg){return"boolean"==typeof arg},exports.isNull=function(arg){return null===arg},exports.isNullOrUndefined=function(arg){return null==arg},exports.isNumber=function(arg){return"number"==typeof arg},exports.isString=function(arg){return"string"==typeof arg},exports.isSymbol=function(arg){return"symbol"==typeof arg},exports.isUndefined=function(arg){return void 0===arg},exports.isRegExp=function(re){return"[object RegExp]"===objectToString(re)},exports.isObject=function(arg){return"object"==typeof arg&&null!==arg},exports.isDate=function(d){return"[object Date]"===objectToString(d)},exports.isError=function(e){return"[object Error]"===objectToString(e)||e instanceof Error},exports.isFunction=function(arg){return"function"==typeof arg},exports.isPrimitive=function(arg){return null===arg||"boolean"==typeof arg||"number"==typeof arg||"string"==typeof arg||"symbol"==typeof arg||void 0===arg},exports.isBuffer=Buffer.isBuffer}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){(function(Buffer){module.exports=function(a,b){for(var length=Math.min(a.length,b.length),buffer=new Buffer(length),i=0;i<length;++i)buffer[i]=a[i]^b[i];return buffer}}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){"use strict";var utils=__webpack_require__(11),assert=__webpack_require__(9);function BlockHash(){this.pending=null,this.pendingTotal=0,this.blockSize=this.constructor.blockSize,this.outSize=this.constructor.outSize,this.hmacStrength=this.constructor.hmacStrength,this.padLength=this.constructor.padLength/8,this.endian="big",this._delta8=this.blockSize/8,this._delta32=this.blockSize/32}exports.BlockHash=BlockHash,BlockHash.prototype.update=function(msg,enc){if(msg=utils.toArray(msg,enc),this.pending?this.pending=this.pending.concat(msg):this.pending=msg,this.pendingTotal+=msg.length,this.pending.length>=this._delta8){var r=(msg=this.pending).length%this._delta8;this.pending=msg.slice(msg.length-r,msg.length),0===this.pending.length&&(this.pending=null),msg=utils.join32(msg,0,msg.length-r,this.endian);for(var i=0;i<msg.length;i+=this._delta32)this._update(msg,i,i+this._delta32)}return this},BlockHash.prototype.digest=function(enc){return this.update(this._pad()),assert(null===this.pending),this._digest(enc)},BlockHash.prototype._pad=function(){var len=this.pendingTotal,bytes=this._delta8,k=bytes-(len+this.padLength)%bytes,res=new Array(k+this.padLength);res[0]=128;for(var i=1;i<k;i++)res[i]=0;if(len<<=3,"big"===this.endian){for(var t=8;t<this.padLength;t++)res[i++]=0;res[i++]=0,res[i++]=0,res[i++]=0,res[i++]=0,res[i++]=len>>>24&255,res[i++]=len>>>16&255,res[i++]=len>>>8&255,res[i++]=255&len}else for(res[i++]=255&len,res[i++]=len>>>8&255,res[i++]=len>>>16&255,res[i++]=len>>>24&255,res[i++]=0,res[i++]=0,res[i++]=0,res[i++]=0,t=8;t<this.padLength;t++)res[i++]=0;return res}},function(module,exports,__webpack_require__){var asn1=exports;asn1.bignum=__webpack_require__(6),asn1.define=__webpack_require__(176).define,asn1.base=__webpack_require__(26),asn1.constants=__webpack_require__(76),asn1.decoders=__webpack_require__(181),asn1.encoders=__webpack_require__(183)},function(module,exports,__webpack_require__){var base=exports;base.Reporter=__webpack_require__(178).Reporter,base.DecoderBuffer=__webpack_require__(75).DecoderBuffer,base.EncoderBuffer=__webpack_require__(75).EncoderBuffer,base.Node=__webpack_require__(179)},function(module,exports,__webpack_require__){"use strict";var ReflectOwnKeys,R="object"==typeof Reflect?Reflect:null,ReflectApply=R&&"function"==typeof R.apply?R.apply:function(target,receiver,args){return Function.prototype.apply.call(target,receiver,args)};ReflectOwnKeys=R&&"function"==typeof R.ownKeys?R.ownKeys:Object.getOwnPropertySymbols?function(target){return Object.getOwnPropertyNames(target).concat(Object.getOwnPropertySymbols(target))}:function(target){return Object.getOwnPropertyNames(target)};var NumberIsNaN=Number.isNaN||function(value){return value!=value};function EventEmitter(){EventEmitter.init.call(this)}module.exports=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._eventsCount=0,EventEmitter.prototype._maxListeners=void 0;var defaultMaxListeners=10;function $getMaxListeners(that){return void 0===that._maxListeners?EventEmitter.defaultMaxListeners:that._maxListeners}function _addListener(target,type,listener,prepend){var m,events,existing,warning;if("function"!=typeof listener)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof listener);if(void 0===(events=target._events)?(events=target._events=Object.create(null),target._eventsCount=0):(void 0!==events.newListener&&(target.emit("newListener",type,listener.listener?listener.listener:listener),events=target._events),existing=events[type]),void 0===existing)existing=events[type]=listener,++target._eventsCount;else if("function"==typeof existing?existing=events[type]=prepend?[listener,existing]:[existing,listener]:prepend?existing.unshift(listener):existing.push(listener),(m=$getMaxListeners(target))>0&&existing.length>m&&!existing.warned){existing.warned=!0;var w=new Error("Possible EventEmitter memory leak detected. "+existing.length+" "+String(type)+" listeners added. Use emitter.setMaxListeners() to increase limit");w.name="MaxListenersExceededWarning",w.emitter=target,w.type=type,w.count=existing.length,warning=w,console&&console.warn&&console.warn(warning)}return target}function onceWrapper(){for(var args=[],i=0;i<arguments.length;i++)args.push(arguments[i]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,ReflectApply(this.listener,this.target,args))}function _onceWrap(target,type,listener){var state={fired:!1,wrapFn:void 0,target:target,type:type,listener:listener},wrapped=onceWrapper.bind(state);return wrapped.listener=listener,state.wrapFn=wrapped,wrapped}function _listeners(target,type,unwrap){var events=target._events;if(void 0===events)return[];var evlistener=events[type];return void 0===evlistener?[]:"function"==typeof evlistener?unwrap?[evlistener.listener||evlistener]:[evlistener]:unwrap?function(arr){for(var ret=new Array(arr.length),i=0;i<ret.length;++i)ret[i]=arr[i].listener||arr[i];return ret}(evlistener):arrayClone(evlistener,evlistener.length)}function listenerCount(type){var events=this._events;if(void 0!==events){var evlistener=events[type];if("function"==typeof evlistener)return 1;if(void 0!==evlistener)return evlistener.length}return 0}function arrayClone(arr,n){for(var copy=new Array(n),i=0;i<n;++i)copy[i]=arr[i];return copy}Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(arg){if("number"!=typeof arg||arg<0||NumberIsNaN(arg))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+arg+".");defaultMaxListeners=arg}}),EventEmitter.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function(n){if("number"!=typeof n||n<0||NumberIsNaN(n))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+n+".");return this._maxListeners=n,this},EventEmitter.prototype.getMaxListeners=function(){return $getMaxListeners(this)},EventEmitter.prototype.emit=function(type){for(var args=[],i=1;i<arguments.length;i++)args.push(arguments[i]);var doError="error"===type,events=this._events;if(void 0!==events)doError=doError&&void 0===events.error;else if(!doError)return!1;if(doError){var er;if(args.length>0&&(er=args[0]),er instanceof Error)throw er;var err=new Error("Unhandled error."+(er?" ("+er.message+")":""));throw err.context=er,err}var handler=events[type];if(void 0===handler)return!1;if("function"==typeof handler)ReflectApply(handler,this,args);else{var len=handler.length,listeners=arrayClone(handler,len);for(i=0;i<len;++i)ReflectApply(listeners[i],this,args)}return!0},EventEmitter.prototype.addListener=function(type,listener){return _addListener(this,type,listener,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function(type,listener){return _addListener(this,type,listener,!0)},EventEmitter.prototype.once=function(type,listener){if("function"!=typeof listener)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof listener);return this.on(type,_onceWrap(this,type,listener)),this},EventEmitter.prototype.prependOnceListener=function(type,listener){if("function"!=typeof listener)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof listener);return this.prependListener(type,_onceWrap(this,type,listener)),this},EventEmitter.prototype.removeListener=function(type,listener){var list,events,position,i,originalListener;if("function"!=typeof listener)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof listener);if(void 0===(events=this._events))return this;if(void 0===(list=events[type]))return this;if(list===listener||list.listener===listener)0==--this._eventsCount?this._events=Object.create(null):(delete events[type],events.removeListener&&this.emit("removeListener",type,list.listener||listener));else if("function"!=typeof list){for(position=-1,i=list.length-1;i>=0;i--)if(list[i]===listener||list[i].listener===listener){originalListener=list[i].listener,position=i;break}if(position<0)return this;0===position?list.shift():function(list,index){for(;index+1<list.length;index++)list[index]=list[index+1];list.pop()}(list,position),1===list.length&&(events[type]=list[0]),void 0!==events.removeListener&&this.emit("removeListener",type,originalListener||listener)}return this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.removeAllListeners=function(type){var listeners,events,i;if(void 0===(events=this._events))return this;if(void 0===events.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==events[type]&&(0==--this._eventsCount?this._events=Object.create(null):delete events[type]),this;if(0===arguments.length){var key,keys=Object.keys(events);for(i=0;i<keys.length;++i)"removeListener"!==(key=keys[i])&&this.removeAllListeners(key);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(listeners=events[type]))this.removeListener(type,listeners);else if(void 0!==listeners)for(i=listeners.length-1;i>=0;i--)this.removeListener(type,listeners[i]);return this},EventEmitter.prototype.listeners=function(type){return _listeners(this,type,!0)},EventEmitter.prototype.rawListeners=function(type){return _listeners(this,type,!1)},EventEmitter.listenerCount=function(emitter,type){return"function"==typeof emitter.listenerCount?emitter.listenerCount(type):listenerCount.call(emitter,type)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]}},function(module,exports,__webpack_require__){"use strict";(function(process){!process.version||0===process.version.indexOf("v0.")||0===process.version.indexOf("v1.")&&0!==process.version.indexOf("v1.8.")?module.exports={nextTick:function(fn,arg1,arg2,arg3){if("function"!=typeof fn)throw new TypeError('"callback" argument must be a function');var args,i,len=arguments.length;switch(len){case 0:case 1:return process.nextTick(fn);case 2:return process.nextTick((function(){fn.call(null,arg1)}));case 3:return process.nextTick((function(){fn.call(null,arg1,arg2)}));case 4:return process.nextTick((function(){fn.call(null,arg1,arg2,arg3)}));default:for(args=new Array(len-1),i=0;i<args.length;)args[i++]=arguments[i];return process.nextTick((function(){fn.apply(null,args)}))}}}:module.exports=process}).call(this,__webpack_require__(12))},function(module,exports,__webpack_require__){var Buffer=__webpack_require__(4).Buffer;function asUInt32Array(buf){Buffer.isBuffer(buf)||(buf=Buffer.from(buf));for(var len=buf.length/4|0,out=new Array(len),i=0;i<len;i++)out[i]=buf.readUInt32BE(4*i);return out}function scrubVec(v){for(;0<v.length;v++)v[0]=0}function cryptBlock(M,keySchedule,SUB_MIX,SBOX,nRounds){for(var t0,t1,t2,t3,SUB_MIX0=SUB_MIX[0],SUB_MIX1=SUB_MIX[1],SUB_MIX2=SUB_MIX[2],SUB_MIX3=SUB_MIX[3],s0=M[0]^keySchedule[0],s1=M[1]^keySchedule[1],s2=M[2]^keySchedule[2],s3=M[3]^keySchedule[3],ksRow=4,round=1;round<nRounds;round++)t0=SUB_MIX0[s0>>>24]^SUB_MIX1[s1>>>16&255]^SUB_MIX2[s2>>>8&255]^SUB_MIX3[255&s3]^keySchedule[ksRow++],t1=SUB_MIX0[s1>>>24]^SUB_MIX1[s2>>>16&255]^SUB_MIX2[s3>>>8&255]^SUB_MIX3[255&s0]^keySchedule[ksRow++],t2=SUB_MIX0[s2>>>24]^SUB_MIX1[s3>>>16&255]^SUB_MIX2[s0>>>8&255]^SUB_MIX3[255&s1]^keySchedule[ksRow++],t3=SUB_MIX0[s3>>>24]^SUB_MIX1[s0>>>16&255]^SUB_MIX2[s1>>>8&255]^SUB_MIX3[255&s2]^keySchedule[ksRow++],s0=t0,s1=t1,s2=t2,s3=t3;return t0=(SBOX[s0>>>24]<<24|SBOX[s1>>>16&255]<<16|SBOX[s2>>>8&255]<<8|SBOX[255&s3])^keySchedule[ksRow++],t1=(SBOX[s1>>>24]<<24|SBOX[s2>>>16&255]<<16|SBOX[s3>>>8&255]<<8|SBOX[255&s0])^keySchedule[ksRow++],t2=(SBOX[s2>>>24]<<24|SBOX[s3>>>16&255]<<16|SBOX[s0>>>8&255]<<8|SBOX[255&s1])^keySchedule[ksRow++],t3=(SBOX[s3>>>24]<<24|SBOX[s0>>>16&255]<<16|SBOX[s1>>>8&255]<<8|SBOX[255&s2])^keySchedule[ksRow++],[t0>>>=0,t1>>>=0,t2>>>=0,t3>>>=0]}var RCON=[0,1,2,4,8,16,32,64,128,27,54],G=function(){for(var d=new Array(256),j=0;j<256;j++)d[j]=j<128?j<<1:j<<1^283;for(var SBOX=[],INV_SBOX=[],SUB_MIX=[[],[],[],[]],INV_SUB_MIX=[[],[],[],[]],x=0,xi=0,i=0;i<256;++i){var sx=xi^xi<<1^xi<<2^xi<<3^xi<<4;sx=sx>>>8^255&sx^99,SBOX[x]=sx,INV_SBOX[sx]=x;var x2=d[x],x4=d[x2],x8=d[x4],t=257*d[sx]^16843008*sx;SUB_MIX[0][x]=t<<24|t>>>8,SUB_MIX[1][x]=t<<16|t>>>16,SUB_MIX[2][x]=t<<8|t>>>24,SUB_MIX[3][x]=t,t=16843009*x8^65537*x4^257*x2^16843008*x,INV_SUB_MIX[0][sx]=t<<24|t>>>8,INV_SUB_MIX[1][sx]=t<<16|t>>>16,INV_SUB_MIX[2][sx]=t<<8|t>>>24,INV_SUB_MIX[3][sx]=t,0===x?x=xi=1:(x=x2^d[d[d[x8^x2]]],xi^=d[d[xi]])}return{SBOX:SBOX,INV_SBOX:INV_SBOX,SUB_MIX:SUB_MIX,INV_SUB_MIX:INV_SUB_MIX}}();function AES(key){this._key=asUInt32Array(key),this._reset()}AES.blockSize=16,AES.keySize=32,AES.prototype.blockSize=AES.blockSize,AES.prototype.keySize=AES.keySize,AES.prototype._reset=function(){for(var keyWords=this._key,keySize=keyWords.length,nRounds=keySize+6,ksRows=4*(nRounds+1),keySchedule=[],k=0;k<keySize;k++)keySchedule[k]=keyWords[k];for(k=keySize;k<ksRows;k++){var t=keySchedule[k-1];k%keySize==0?(t=t<<8|t>>>24,t=G.SBOX[t>>>24]<<24|G.SBOX[t>>>16&255]<<16|G.SBOX[t>>>8&255]<<8|G.SBOX[255&t],t^=RCON[k/keySize|0]<<24):keySize>6&&k%keySize==4&&(t=G.SBOX[t>>>24]<<24|G.SBOX[t>>>16&255]<<16|G.SBOX[t>>>8&255]<<8|G.SBOX[255&t]),keySchedule[k]=keySchedule[k-keySize]^t}for(var invKeySchedule=[],ik=0;ik<ksRows;ik++){var ksR=ksRows-ik,tt=keySchedule[ksR-(ik%4?0:4)];invKeySchedule[ik]=ik<4||ksR<=4?tt:G.INV_SUB_MIX[0][G.SBOX[tt>>>24]]^G.INV_SUB_MIX[1][G.SBOX[tt>>>16&255]]^G.INV_SUB_MIX[2][G.SBOX[tt>>>8&255]]^G.INV_SUB_MIX[3][G.SBOX[255&tt]]}this._nRounds=nRounds,this._keySchedule=keySchedule,this._invKeySchedule=invKeySchedule},AES.prototype.encryptBlockRaw=function(M){return cryptBlock(M=asUInt32Array(M),this._keySchedule,G.SUB_MIX,G.SBOX,this._nRounds)},AES.prototype.encryptBlock=function(M){var out=this.encryptBlockRaw(M),buf=Buffer.allocUnsafe(16);return buf.writeUInt32BE(out[0],0),buf.writeUInt32BE(out[1],4),buf.writeUInt32BE(out[2],8),buf.writeUInt32BE(out[3],12),buf},AES.prototype.decryptBlock=function(M){var m1=(M=asUInt32Array(M))[1];M[1]=M[3],M[3]=m1;var out=cryptBlock(M,this._invKeySchedule,G.INV_SUB_MIX,G.INV_SBOX,this._nRounds),buf=Buffer.allocUnsafe(16);return buf.writeUInt32BE(out[0],0),buf.writeUInt32BE(out[3],4),buf.writeUInt32BE(out[2],8),buf.writeUInt32BE(out[1],12),buf},AES.prototype.scrub=function(){scrubVec(this._keySchedule),scrubVec(this._invKeySchedule),scrubVec(this._key)},module.exports.AES=AES},function(module,exports,__webpack_require__){var Buffer=__webpack_require__(4).Buffer,MD5=__webpack_require__(34);module.exports=function(password,salt,keyBits,ivLen){if(Buffer.isBuffer(password)||(password=Buffer.from(password,"binary")),salt&&(Buffer.isBuffer(salt)||(salt=Buffer.from(salt,"binary")),8!==salt.length))throw new RangeError("salt should be Buffer with 8 byte length");for(var keyLen=keyBits/8,key=Buffer.alloc(keyLen),iv=Buffer.alloc(ivLen||0),tmp=Buffer.alloc(0);keyLen>0||ivLen>0;){var hash=new MD5;hash.update(tmp),hash.update(password),salt&&hash.update(salt),tmp=hash.digest();var used=0;if(keyLen>0){var keyStart=key.length-keyLen;used=Math.min(keyLen,tmp.length),tmp.copy(key,keyStart,0,used),keyLen-=used}if(used<tmp.length&&ivLen>0){var ivStart=iv.length-ivLen,length=Math.min(ivLen,tmp.length-used);tmp.copy(iv,ivStart,used,used+length),ivLen-=length}}return tmp.fill(0),{key:key,iv:iv}}},function(module,exports,__webpack_require__){"use strict";var curve=exports;curve.base=__webpack_require__(156),curve.short=__webpack_require__(157),curve.mont=__webpack_require__(158),curve.edwards=__webpack_require__(159)},function(module,exports,__webpack_require__){(function(Buffer){var asn1=__webpack_require__(175),aesid=__webpack_require__(186),fixProc=__webpack_require__(187),ciphers=__webpack_require__(42),compat=__webpack_require__(59);function parseKeys(buffer){var password;"object"!=typeof buffer||Buffer.isBuffer(buffer)||(password=buffer.passphrase,buffer=buffer.key),"string"==typeof buffer&&(buffer=new Buffer(buffer));var subtype,ndata,stripped=fixProc(buffer,password),type=stripped.tag,data=stripped.data;switch(type){case"CERTIFICATE":ndata=asn1.certificate.decode(data,"der").tbsCertificate.subjectPublicKeyInfo;case"PUBLIC KEY":switch(ndata||(ndata=asn1.PublicKey.decode(data,"der")),subtype=ndata.algorithm.algorithm.join(".")){case"1.2.840.113549.1.1.1":return asn1.RSAPublicKey.decode(ndata.subjectPublicKey.data,"der");case"1.2.840.10045.2.1":return ndata.subjectPrivateKey=ndata.subjectPublicKey,{type:"ec",data:ndata};case"1.2.840.10040.4.1":return ndata.algorithm.params.pub_key=asn1.DSAparam.decode(ndata.subjectPublicKey.data,"der"),{type:"dsa",data:ndata.algorithm.params};default:throw new Error("unknown key id "+subtype)}throw new Error("unknown key type "+type);case"ENCRYPTED PRIVATE KEY":data=function(data,password){var salt=data.algorithm.decrypt.kde.kdeparams.salt,iters=parseInt(data.algorithm.decrypt.kde.kdeparams.iters.toString(),10),algo=aesid[data.algorithm.decrypt.cipher.algo.join(".")],iv=data.algorithm.decrypt.cipher.iv,cipherText=data.subjectPrivateKey,keylen=parseInt(algo.split("-")[1],10)/8,key=compat.pbkdf2Sync(password,salt,iters,keylen),cipher=ciphers.createDecipheriv(algo,key,iv),out=[];return out.push(cipher.update(cipherText)),out.push(cipher.final()),Buffer.concat(out)}(data=asn1.EncryptedPrivateKey.decode(data,"der"),password);case"PRIVATE KEY":switch(subtype=(ndata=asn1.PrivateKey.decode(data,"der")).algorithm.algorithm.join(".")){case"1.2.840.113549.1.1.1":return asn1.RSAPrivateKey.decode(ndata.subjectPrivateKey,"der");case"1.2.840.10045.2.1":return{curve:ndata.algorithm.curve,privateKey:asn1.ECPrivateKey.decode(ndata.subjectPrivateKey,"der").privateKey};case"1.2.840.10040.4.1":return ndata.algorithm.params.priv_key=asn1.DSAparam.decode(ndata.subjectPrivateKey,"der"),{type:"dsa",params:ndata.algorithm.params};default:throw new Error("unknown key id "+subtype)}throw new Error("unknown key type "+type);case"RSA PUBLIC KEY":return asn1.RSAPublicKey.decode(data,"der");case"RSA PRIVATE KEY":return asn1.RSAPrivateKey.decode(data,"der");case"DSA PRIVATE KEY":return{type:"dsa",params:asn1.DSAPrivateKey.decode(data,"der")};case"EC PRIVATE KEY":return{curve:(data=asn1.ECPrivateKey.decode(data,"der")).parameters.value,privateKey:data.privateKey};default:throw new Error("unknown key type "+type)}}module.exports=parseKeys,parseKeys.signature=asn1.signature}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return C_lib=(C=CryptoJS).lib,Base=C_lib.Base,X32WordArray=C_lib.WordArray,(C_x64=C.x64={}).Word=Base.extend({init:function(high,low){this.high=high,this.low=low}}),C_x64.WordArray=Base.extend({init:function(words,sigBytes){words=this.words=words||[],this.sigBytes=null!=sigBytes?sigBytes:8*words.length},toX32:function(){for(var x64Words=this.words,x64WordsLength=x64Words.length,x32Words=[],i=0;i<x64WordsLength;i++){var x64Word=x64Words[i];x32Words.push(x64Word.high),x32Words.push(x64Word.low)}return X32WordArray.create(x32Words,this.sigBytes)},clone:function(){for(var clone=Base.clone.call(this),words=clone.words=this.words.slice(0),wordsLength=words.length,i=0;i<wordsLength;i++)words[i]=words[i].clone();return clone}}),CryptoJS;var C,C_lib,Base,X32WordArray,C_x64}(__webpack_require__(2))},function(module,exports,__webpack_require__){"use strict";(function(Buffer){var inherits=__webpack_require__(1),HashBase=__webpack_require__(49),ARRAY16=new Array(16);function MD5(){HashBase.call(this,64),this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878}function rotl(x,n){return x<<n|x>>>32-n}function fnF(a,b,c,d,m,k,s){return rotl(a+(b&c|~b&d)+m+k|0,s)+b|0}function fnG(a,b,c,d,m,k,s){return rotl(a+(b&d|c&~d)+m+k|0,s)+b|0}function fnH(a,b,c,d,m,k,s){return rotl(a+(b^c^d)+m+k|0,s)+b|0}function fnI(a,b,c,d,m,k,s){return rotl(a+(c^(b|~d))+m+k|0,s)+b|0}inherits(MD5,HashBase),MD5.prototype._update=function(){for(var M=ARRAY16,i=0;i<16;++i)M[i]=this._block.readInt32LE(4*i);var a=this._a,b=this._b,c=this._c,d=this._d;a=fnF(a,b,c,d,M[0],3614090360,7),d=fnF(d,a,b,c,M[1],3905402710,12),c=fnF(c,d,a,b,M[2],606105819,17),b=fnF(b,c,d,a,M[3],3250441966,22),a=fnF(a,b,c,d,M[4],4118548399,7),d=fnF(d,a,b,c,M[5],1200080426,12),c=fnF(c,d,a,b,M[6],2821735955,17),b=fnF(b,c,d,a,M[7],4249261313,22),a=fnF(a,b,c,d,M[8],1770035416,7),d=fnF(d,a,b,c,M[9],2336552879,12),c=fnF(c,d,a,b,M[10],4294925233,17),b=fnF(b,c,d,a,M[11],2304563134,22),a=fnF(a,b,c,d,M[12],1804603682,7),d=fnF(d,a,b,c,M[13],4254626195,12),c=fnF(c,d,a,b,M[14],2792965006,17),a=fnG(a,b=fnF(b,c,d,a,M[15],1236535329,22),c,d,M[1],4129170786,5),d=fnG(d,a,b,c,M[6],3225465664,9),c=fnG(c,d,a,b,M[11],643717713,14),b=fnG(b,c,d,a,M[0],3921069994,20),a=fnG(a,b,c,d,M[5],3593408605,5),d=fnG(d,a,b,c,M[10],38016083,9),c=fnG(c,d,a,b,M[15],3634488961,14),b=fnG(b,c,d,a,M[4],3889429448,20),a=fnG(a,b,c,d,M[9],568446438,5),d=fnG(d,a,b,c,M[14],3275163606,9),c=fnG(c,d,a,b,M[3],4107603335,14),b=fnG(b,c,d,a,M[8],1163531501,20),a=fnG(a,b,c,d,M[13],2850285829,5),d=fnG(d,a,b,c,M[2],4243563512,9),c=fnG(c,d,a,b,M[7],1735328473,14),a=fnH(a,b=fnG(b,c,d,a,M[12],2368359562,20),c,d,M[5],4294588738,4),d=fnH(d,a,b,c,M[8],2272392833,11),c=fnH(c,d,a,b,M[11],1839030562,16),b=fnH(b,c,d,a,M[14],4259657740,23),a=fnH(a,b,c,d,M[1],2763975236,4),d=fnH(d,a,b,c,M[4],1272893353,11),c=fnH(c,d,a,b,M[7],4139469664,16),b=fnH(b,c,d,a,M[10],3200236656,23),a=fnH(a,b,c,d,M[13],681279174,4),d=fnH(d,a,b,c,M[0],3936430074,11),c=fnH(c,d,a,b,M[3],3572445317,16),b=fnH(b,c,d,a,M[6],76029189,23),a=fnH(a,b,c,d,M[9],3654602809,4),d=fnH(d,a,b,c,M[12],3873151461,11),c=fnH(c,d,a,b,M[15],530742520,16),a=fnI(a,b=fnH(b,c,d,a,M[2],3299628645,23),c,d,M[0],4096336452,6),d=fnI(d,a,b,c,M[7],1126891415,10),c=fnI(c,d,a,b,M[14],2878612391,15),b=fnI(b,c,d,a,M[5],4237533241,21),a=fnI(a,b,c,d,M[12],1700485571,6),d=fnI(d,a,b,c,M[3],2399980690,10),c=fnI(c,d,a,b,M[10],4293915773,15),b=fnI(b,c,d,a,M[1],2240044497,21),a=fnI(a,b,c,d,M[8],1873313359,6),d=fnI(d,a,b,c,M[15],4264355552,10),c=fnI(c,d,a,b,M[6],2734768916,15),b=fnI(b,c,d,a,M[13],1309151649,21),a=fnI(a,b,c,d,M[4],4149444226,6),d=fnI(d,a,b,c,M[11],3174756917,10),c=fnI(c,d,a,b,M[2],718787259,15),b=fnI(b,c,d,a,M[9],3951481745,21),this._a=this._a+a|0,this._b=this._b+b|0,this._c=this._c+c|0,this._d=this._d+d|0},MD5.prototype._digest=function(){this._block[this._blockOffset++]=128,this._blockOffset>56&&(this._block.fill(0,this._blockOffset,64),this._update(),this._blockOffset=0),this._block.fill(0,this._blockOffset,56),this._block.writeUInt32LE(this._length[0],56),this._block.writeUInt32LE(this._length[1],60),this._update();var buffer=new Buffer(16);return buffer.writeInt32LE(this._a,0),buffer.writeInt32LE(this._b,4),buffer.writeInt32LE(this._c,8),buffer.writeInt32LE(this._d,12),buffer},module.exports=MD5}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){module.exports=Stream;var EE=__webpack_require__(27).EventEmitter;function Stream(){EE.call(this)}__webpack_require__(1)(Stream,EE),Stream.Readable=__webpack_require__(36),Stream.Writable=__webpack_require__(118),Stream.Duplex=__webpack_require__(119),Stream.Transform=__webpack_require__(120),Stream.PassThrough=__webpack_require__(121),Stream.Stream=Stream,Stream.prototype.pipe=function(dest,options){var source=this;function ondata(chunk){dest.writable&&!1===dest.write(chunk)&&source.pause&&source.pause()}function ondrain(){source.readable&&source.resume&&source.resume()}source.on("data",ondata),dest.on("drain",ondrain),dest._isStdio||options&&!1===options.end||(source.on("end",onend),source.on("close",onclose));var didOnEnd=!1;function onend(){didOnEnd||(didOnEnd=!0,dest.end())}function onclose(){didOnEnd||(didOnEnd=!0,"function"==typeof dest.destroy&&dest.destroy())}function onerror(er){if(cleanup(),0===EE.listenerCount(this,"error"))throw er}function cleanup(){source.removeListener("data",ondata),dest.removeListener("drain",ondrain),source.removeListener("end",onend),source.removeListener("close",onclose),source.removeListener("error",onerror),dest.removeListener("error",onerror),source.removeListener("end",cleanup),source.removeListener("close",cleanup),dest.removeListener("close",cleanup)}return source.on("error",onerror),dest.on("error",onerror),source.on("end",cleanup),source.on("close",cleanup),dest.on("close",cleanup),dest.emit("pipe",source),dest}},function(module,exports,__webpack_require__){(exports=module.exports=__webpack_require__(50)).Stream=exports,exports.Readable=exports,exports.Writable=__webpack_require__(37),exports.Duplex=__webpack_require__(14),exports.Transform=__webpack_require__(53),exports.PassThrough=__webpack_require__(117)},function(module,exports,__webpack_require__){"use strict";(function(process,setImmediate,global){var pna=__webpack_require__(28);function CorkedRequest(state){var _this=this;this.next=null,this.entry=null,this.finish=function(){!function(corkReq,state,err){var entry=corkReq.entry;corkReq.entry=null;for(;entry;){var cb=entry.callback;state.pendingcb--,cb(err),entry=entry.next}state.corkedRequestsFree?state.corkedRequestsFree.next=corkReq:state.corkedRequestsFree=corkReq}(_this,state)}}module.exports=Writable;var Duplex,asyncWrite=!process.browser&&["v0.10","v0.9."].indexOf(process.version.slice(0,5))>-1?setImmediate:pna.nextTick;Writable.WritableState=WritableState;var util=__webpack_require__(22);util.inherits=__webpack_require__(1);var internalUtil={deprecate:__webpack_require__(116)},Stream=__webpack_require__(51),Buffer=__webpack_require__(4).Buffer,OurUint8Array=global.Uint8Array||function(){};var realHasInstance,destroyImpl=__webpack_require__(52);function nop(){}function WritableState(options,stream){Duplex=Duplex||__webpack_require__(14),options=options||{};var isDuplex=stream instanceof Duplex;this.objectMode=!!options.objectMode,isDuplex&&(this.objectMode=this.objectMode||!!options.writableObjectMode);var hwm=options.highWaterMark,writableHwm=options.writableHighWaterMark,defaultHwm=this.objectMode?16:16384;this.highWaterMark=hwm||0===hwm?hwm:isDuplex&&(writableHwm||0===writableHwm)?writableHwm:defaultHwm,this.highWaterMark=Math.floor(this.highWaterMark),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var noDecode=!1===options.decodeStrings;this.decodeStrings=!noDecode,this.defaultEncoding=options.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(er){!function(stream,er){var state=stream._writableState,sync=state.sync,cb=state.writecb;if(function(state){state.writing=!1,state.writecb=null,state.length-=state.writelen,state.writelen=0}(state),er)!function(stream,state,sync,er,cb){--state.pendingcb,sync?(pna.nextTick(cb,er),pna.nextTick(finishMaybe,stream,state),stream._writableState.errorEmitted=!0,stream.emit("error",er)):(cb(er),stream._writableState.errorEmitted=!0,stream.emit("error",er),finishMaybe(stream,state))}(stream,state,sync,er,cb);else{var finished=needFinish(state);finished||state.corked||state.bufferProcessing||!state.bufferedRequest||clearBuffer(stream,state),sync?asyncWrite(afterWrite,stream,state,finished,cb):afterWrite(stream,state,finished,cb)}}(stream,er)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.bufferedRequestCount=0,this.corkedRequestsFree=new CorkedRequest(this)}function Writable(options){if(Duplex=Duplex||__webpack_require__(14),!(realHasInstance.call(Writable,this)||this instanceof Duplex))return new Writable(options);this._writableState=new WritableState(options,this),this.writable=!0,options&&("function"==typeof options.write&&(this._write=options.write),"function"==typeof options.writev&&(this._writev=options.writev),"function"==typeof options.destroy&&(this._destroy=options.destroy),"function"==typeof options.final&&(this._final=options.final)),Stream.call(this)}function doWrite(stream,state,writev,len,chunk,encoding,cb){state.writelen=len,state.writecb=cb,state.writing=!0,state.sync=!0,writev?stream._writev(chunk,state.onwrite):stream._write(chunk,encoding,state.onwrite),state.sync=!1}function afterWrite(stream,state,finished,cb){finished||function(stream,state){0===state.length&&state.needDrain&&(state.needDrain=!1,stream.emit("drain"))}(stream,state),state.pendingcb--,cb(),finishMaybe(stream,state)}function clearBuffer(stream,state){state.bufferProcessing=!0;var entry=state.bufferedRequest;if(stream._writev&&entry&&entry.next){var l=state.bufferedRequestCount,buffer=new Array(l),holder=state.corkedRequestsFree;holder.entry=entry;for(var count=0,allBuffers=!0;entry;)buffer[count]=entry,entry.isBuf||(allBuffers=!1),entry=entry.next,count+=1;buffer.allBuffers=allBuffers,doWrite(stream,state,!0,state.length,buffer,"",holder.finish),state.pendingcb++,state.lastBufferedRequest=null,holder.next?(state.corkedRequestsFree=holder.next,holder.next=null):state.corkedRequestsFree=new CorkedRequest(state),state.bufferedRequestCount=0}else{for(;entry;){var chunk=entry.chunk,encoding=entry.encoding,cb=entry.callback;if(doWrite(stream,state,!1,state.objectMode?1:chunk.length,chunk,encoding,cb),entry=entry.next,state.bufferedRequestCount--,state.writing)break}null===entry&&(state.lastBufferedRequest=null)}state.bufferedRequest=entry,state.bufferProcessing=!1}function needFinish(state){return state.ending&&0===state.length&&null===state.bufferedRequest&&!state.finished&&!state.writing}function callFinal(stream,state){stream._final((function(err){state.pendingcb--,err&&stream.emit("error",err),state.prefinished=!0,stream.emit("prefinish"),finishMaybe(stream,state)}))}function finishMaybe(stream,state){var need=needFinish(state);return need&&(!function(stream,state){state.prefinished||state.finalCalled||("function"==typeof stream._final?(state.pendingcb++,state.finalCalled=!0,pna.nextTick(callFinal,stream,state)):(state.prefinished=!0,stream.emit("prefinish")))}(stream,state),0===state.pendingcb&&(state.finished=!0,stream.emit("finish"))),need}util.inherits(Writable,Stream),WritableState.prototype.getBuffer=function(){for(var current=this.bufferedRequest,out=[];current;)out.push(current),current=current.next;return out},function(){try{Object.defineProperty(WritableState.prototype,"buffer",{get:internalUtil.deprecate((function(){return this.getBuffer()}),"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(_){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(realHasInstance=Function.prototype[Symbol.hasInstance],Object.defineProperty(Writable,Symbol.hasInstance,{value:function(object){return!!realHasInstance.call(this,object)||this===Writable&&(object&&object._writableState instanceof WritableState)}})):realHasInstance=function(object){return object instanceof this},Writable.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe, not readable"))},Writable.prototype.write=function(chunk,encoding,cb){var obj,state=this._writableState,ret=!1,isBuf=!state.objectMode&&(obj=chunk,Buffer.isBuffer(obj)||obj instanceof OurUint8Array);return isBuf&&!Buffer.isBuffer(chunk)&&(chunk=function(chunk){return Buffer.from(chunk)}(chunk)),"function"==typeof encoding&&(cb=encoding,encoding=null),isBuf?encoding="buffer":encoding||(encoding=state.defaultEncoding),"function"!=typeof cb&&(cb=nop),state.ended?function(stream,cb){var er=new Error("write after end");stream.emit("error",er),pna.nextTick(cb,er)}(this,cb):(isBuf||function(stream,state,chunk,cb){var valid=!0,er=!1;return null===chunk?er=new TypeError("May not write null values to stream"):"string"==typeof chunk||void 0===chunk||state.objectMode||(er=new TypeError("Invalid non-string/buffer chunk")),er&&(stream.emit("error",er),pna.nextTick(cb,er),valid=!1),valid}(this,state,chunk,cb))&&(state.pendingcb++,ret=function(stream,state,isBuf,chunk,encoding,cb){if(!isBuf){var newChunk=function(state,chunk,encoding){state.objectMode||!1===state.decodeStrings||"string"!=typeof chunk||(chunk=Buffer.from(chunk,encoding));return chunk}(state,chunk,encoding);chunk!==newChunk&&(isBuf=!0,encoding="buffer",chunk=newChunk)}var len=state.objectMode?1:chunk.length;state.length+=len;var ret=state.length<state.highWaterMark;ret||(state.needDrain=!0);if(state.writing||state.corked){var last=state.lastBufferedRequest;state.lastBufferedRequest={chunk:chunk,encoding:encoding,isBuf:isBuf,callback:cb,next:null},last?last.next=state.lastBufferedRequest:state.bufferedRequest=state.lastBufferedRequest,state.bufferedRequestCount+=1}else doWrite(stream,state,!1,len,chunk,encoding,cb);return ret}(this,state,isBuf,chunk,encoding,cb)),ret},Writable.prototype.cork=function(){this._writableState.corked++},Writable.prototype.uncork=function(){var state=this._writableState;state.corked&&(state.corked--,state.writing||state.corked||state.finished||state.bufferProcessing||!state.bufferedRequest||clearBuffer(this,state))},Writable.prototype.setDefaultEncoding=function(encoding){if("string"==typeof encoding&&(encoding=encoding.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((encoding+"").toLowerCase())>-1))throw new TypeError("Unknown encoding: "+encoding);return this._writableState.defaultEncoding=encoding,this},Object.defineProperty(Writable.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Writable.prototype._write=function(chunk,encoding,cb){cb(new Error("_write() is not implemented"))},Writable.prototype._writev=null,Writable.prototype.end=function(chunk,encoding,cb){var state=this._writableState;"function"==typeof chunk?(cb=chunk,chunk=null,encoding=null):"function"==typeof encoding&&(cb=encoding,encoding=null),null!=chunk&&this.write(chunk,encoding),state.corked&&(state.corked=1,this.uncork()),state.ending||state.finished||function(stream,state,cb){state.ending=!0,finishMaybe(stream,state),cb&&(state.finished?pna.nextTick(cb):stream.once("finish",cb));state.ended=!0,stream.writable=!1}(this,state,cb)},Object.defineProperty(Writable.prototype,"destroyed",{get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(value){this._writableState&&(this._writableState.destroyed=value)}}),Writable.prototype.destroy=destroyImpl.destroy,Writable.prototype._undestroy=destroyImpl.undestroy,Writable.prototype._destroy=function(err,cb){this.end(),cb(err)}}).call(this,__webpack_require__(12),__webpack_require__(114).setImmediate,__webpack_require__(10))},function(module,exports,__webpack_require__){"use strict";var Buffer=__webpack_require__(4).Buffer,isEncoding=Buffer.isEncoding||function(encoding){switch((encoding=""+encoding)&&encoding.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function StringDecoder(encoding){var nb;switch(this.encoding=function(enc){var nenc=function(enc){if(!enc)return"utf8";for(var retried;;)switch(enc){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return enc;default:if(retried)return;enc=(""+enc).toLowerCase(),retried=!0}}(enc);if("string"!=typeof nenc&&(Buffer.isEncoding===isEncoding||!isEncoding(enc)))throw new Error("Unknown encoding: "+enc);return nenc||enc}(encoding),this.encoding){case"utf16le":this.text=utf16Text,this.end=utf16End,nb=4;break;case"utf8":this.fillLast=utf8FillLast,nb=4;break;case"base64":this.text=base64Text,this.end=base64End,nb=3;break;default:return this.write=simpleWrite,void(this.end=simpleEnd)}this.lastNeed=0,this.lastTotal=0,this.lastChar=Buffer.allocUnsafe(nb)}function utf8CheckByte(byte){return byte<=127?0:byte>>5==6?2:byte>>4==14?3:byte>>3==30?4:byte>>6==2?-1:-2}function utf8FillLast(buf){var p=this.lastTotal-this.lastNeed,r=function(self,buf,p){if(128!=(192&buf[0]))return self.lastNeed=0,"";if(self.lastNeed>1&&buf.length>1){if(128!=(192&buf[1]))return self.lastNeed=1,"";if(self.lastNeed>2&&buf.length>2&&128!=(192&buf[2]))return self.lastNeed=2,""}}(this,buf);return void 0!==r?r:this.lastNeed<=buf.length?(buf.copy(this.lastChar,p,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(buf.copy(this.lastChar,p,0,buf.length),void(this.lastNeed-=buf.length))}function utf16Text(buf,i){if((buf.length-i)%2==0){var r=buf.toString("utf16le",i);if(r){var c=r.charCodeAt(r.length-1);if(c>=55296&&c<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=buf[buf.length-2],this.lastChar[1]=buf[buf.length-1],r.slice(0,-1)}return r}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=buf[buf.length-1],buf.toString("utf16le",i,buf.length-1)}function utf16End(buf){var r=buf&&buf.length?this.write(buf):"";if(this.lastNeed){var end=this.lastTotal-this.lastNeed;return r+this.lastChar.toString("utf16le",0,end)}return r}function base64Text(buf,i){var n=(buf.length-i)%3;return 0===n?buf.toString("base64",i):(this.lastNeed=3-n,this.lastTotal=3,1===n?this.lastChar[0]=buf[buf.length-1]:(this.lastChar[0]=buf[buf.length-2],this.lastChar[1]=buf[buf.length-1]),buf.toString("base64",i,buf.length-n))}function base64End(buf){var r=buf&&buf.length?this.write(buf):"";return this.lastNeed?r+this.lastChar.toString("base64",0,3-this.lastNeed):r}function simpleWrite(buf){return buf.toString(this.encoding)}function simpleEnd(buf){return buf&&buf.length?this.write(buf):""}exports.StringDecoder=StringDecoder,StringDecoder.prototype.write=function(buf){if(0===buf.length)return"";var r,i;if(this.lastNeed){if(void 0===(r=this.fillLast(buf)))return"";i=this.lastNeed,this.lastNeed=0}else i=0;return i<buf.length?r?r+this.text(buf,i):this.text(buf,i):r||""},StringDecoder.prototype.end=function(buf){var r=buf&&buf.length?this.write(buf):"";return this.lastNeed?r+"":r},StringDecoder.prototype.text=function(buf,i){var total=function(self,buf,i){var j=buf.length-1;if(j<i)return 0;var nb=utf8CheckByte(buf[j]);if(nb>=0)return nb>0&&(self.lastNeed=nb-1),nb;if(--j<i||-2===nb)return 0;if((nb=utf8CheckByte(buf[j]))>=0)return nb>0&&(self.lastNeed=nb-2),nb;if(--j<i||-2===nb)return 0;if((nb=utf8CheckByte(buf[j]))>=0)return nb>0&&(2===nb?nb=0:self.lastNeed=nb-3),nb;return 0}(this,buf,i);if(!this.lastNeed)return buf.toString("utf8",i);this.lastTotal=total;var end=buf.length-(total-this.lastNeed);return buf.copy(this.lastChar,0,end),buf.toString("utf8",i,end)},StringDecoder.prototype.fillLast=function(buf){if(this.lastNeed<=buf.length)return buf.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);buf.copy(this.lastChar,this.lastTotal-this.lastNeed,0,buf.length),this.lastNeed-=buf.length}},function(module,exports,__webpack_require__){"use strict";var Buffer=__webpack_require__(5).Buffer,inherits=__webpack_require__(1),HashBase=__webpack_require__(49),ARRAY16=new Array(16),zl=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13],zr=[5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11],sl=[11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6],sr=[8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11],hl=[0,1518500249,1859775393,2400959708,2840853838],hr=[1352829926,1548603684,1836072691,2053994217,0];function RIPEMD160(){HashBase.call(this,64),this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520}function rotl(x,n){return x<<n|x>>>32-n}function fn1(a,b,c,d,e,m,k,s){return rotl(a+(b^c^d)+m+k|0,s)+e|0}function fn2(a,b,c,d,e,m,k,s){return rotl(a+(b&c|~b&d)+m+k|0,s)+e|0}function fn3(a,b,c,d,e,m,k,s){return rotl(a+((b|~c)^d)+m+k|0,s)+e|0}function fn4(a,b,c,d,e,m,k,s){return rotl(a+(b&d|c&~d)+m+k|0,s)+e|0}function fn5(a,b,c,d,e,m,k,s){return rotl(a+(b^(c|~d))+m+k|0,s)+e|0}inherits(RIPEMD160,HashBase),RIPEMD160.prototype._update=function(){for(var words=ARRAY16,j=0;j<16;++j)words[j]=this._block.readInt32LE(4*j);for(var al=0|this._a,bl=0|this._b,cl=0|this._c,dl=0|this._d,el=0|this._e,ar=0|this._a,br=0|this._b,cr=0|this._c,dr=0|this._d,er=0|this._e,i=0;i<80;i+=1){var tl,tr;i<16?(tl=fn1(al,bl,cl,dl,el,words[zl[i]],hl[0],sl[i]),tr=fn5(ar,br,cr,dr,er,words[zr[i]],hr[0],sr[i])):i<32?(tl=fn2(al,bl,cl,dl,el,words[zl[i]],hl[1],sl[i]),tr=fn4(ar,br,cr,dr,er,words[zr[i]],hr[1],sr[i])):i<48?(tl=fn3(al,bl,cl,dl,el,words[zl[i]],hl[2],sl[i]),tr=fn3(ar,br,cr,dr,er,words[zr[i]],hr[2],sr[i])):i<64?(tl=fn4(al,bl,cl,dl,el,words[zl[i]],hl[3],sl[i]),tr=fn2(ar,br,cr,dr,er,words[zr[i]],hr[3],sr[i])):(tl=fn5(al,bl,cl,dl,el,words[zl[i]],hl[4],sl[i]),tr=fn1(ar,br,cr,dr,er,words[zr[i]],hr[4],sr[i])),al=el,el=dl,dl=rotl(cl,10),cl=bl,bl=tl,ar=er,er=dr,dr=rotl(cr,10),cr=br,br=tr}var t=this._b+cl+dr|0;this._b=this._c+dl+er|0,this._c=this._d+el+ar|0,this._d=this._e+al+br|0,this._e=this._a+bl+cr|0,this._a=t},RIPEMD160.prototype._digest=function(){this._block[this._blockOffset++]=128,this._blockOffset>56&&(this._block.fill(0,this._blockOffset,64),this._update(),this._blockOffset=0),this._block.fill(0,this._blockOffset,56),this._block.writeUInt32LE(this._length[0],56),this._block.writeUInt32LE(this._length[1],60),this._update();var buffer=Buffer.alloc?Buffer.alloc(20):new Buffer(20);return buffer.writeInt32LE(this._a,0),buffer.writeInt32LE(this._b,4),buffer.writeInt32LE(this._c,8),buffer.writeInt32LE(this._d,12),buffer.writeInt32LE(this._e,16),buffer},module.exports=RIPEMD160},function(module,exports,__webpack_require__){(exports=module.exports=function(algorithm){algorithm=algorithm.toLowerCase();var Algorithm=exports[algorithm];if(!Algorithm)throw new Error(algorithm+" is not supported (we accept pull requests)");return new Algorithm}).sha=__webpack_require__(122),exports.sha1=__webpack_require__(123),exports.sha224=__webpack_require__(124),exports.sha256=__webpack_require__(54),exports.sha384=__webpack_require__(125),exports.sha512=__webpack_require__(55)},function(module,exports,__webpack_require__){"use strict";exports.utils=__webpack_require__(131),exports.Cipher=__webpack_require__(132),exports.DES=__webpack_require__(133),exports.CBC=__webpack_require__(134),exports.EDE=__webpack_require__(135)},function(module,exports,__webpack_require__){var ciphers=__webpack_require__(136),deciphers=__webpack_require__(144),modes=__webpack_require__(65);exports.createCipher=exports.Cipher=ciphers.createCipher,exports.createCipheriv=exports.Cipheriv=ciphers.createCipheriv,exports.createDecipher=exports.Decipher=deciphers.createDecipher,exports.createDecipheriv=exports.Decipheriv=deciphers.createDecipheriv,exports.listCiphers=exports.getCiphers=function(){return Object.keys(modes)}},function(module,exports,__webpack_require__){var modeModules={ECB:__webpack_require__(137),CBC:__webpack_require__(138),CFB:__webpack_require__(139),CFB8:__webpack_require__(140),CFB1:__webpack_require__(141),OFB:__webpack_require__(142),CTR:__webpack_require__(63),GCM:__webpack_require__(63)},modes=__webpack_require__(65);for(var key in modes)modes[key].module=modeModules[modes[key].mode];module.exports=modes},function(module,exports,__webpack_require__){(function(Buffer){var bn=__webpack_require__(6),randomBytes=__webpack_require__(16);function crt(msg,priv){var blinds=function(priv){var r=getr(priv);return{blinder:r.toRed(bn.mont(priv.modulus)).redPow(new bn(priv.publicExponent)).fromRed(),unblinder:r.invm(priv.modulus)}}(priv),len=priv.modulus.byteLength(),blinded=(bn.mont(priv.modulus),new bn(msg).mul(blinds.blinder).umod(priv.modulus)),c1=blinded.toRed(bn.mont(priv.prime1)),c2=blinded.toRed(bn.mont(priv.prime2)),qinv=priv.coefficient,p=priv.prime1,q=priv.prime2,m1=c1.redPow(priv.exponent1),m2=c2.redPow(priv.exponent2);m1=m1.fromRed(),m2=m2.fromRed();var h=m1.isub(m2).imul(qinv).umod(p);return h.imul(q),m2.iadd(h),new Buffer(m2.imul(blinds.unblinder).umod(priv.modulus).toArray(!1,len))}function getr(priv){for(var len=priv.modulus.byteLength(),r=new bn(randomBytes(len));r.cmp(priv.modulus)>=0||!r.umod(priv.prime1)||!r.umod(priv.prime2);)r=new bn(randomBytes(len));return r}module.exports=crt,crt.getr=getr}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){var hash=exports;hash.utils=__webpack_require__(11),hash.common=__webpack_require__(24),hash.sha=__webpack_require__(161),hash.ripemd=__webpack_require__(165),hash.hmac=__webpack_require__(166),hash.sha1=hash.sha.sha1,hash.sha256=hash.sha.sha256,hash.sha224=hash.sha.sha224,hash.sha384=hash.sha.sha384,hash.sha512=hash.sha.sha512,hash.ripemd160=hash.ripemd.ripemd160},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return C_lib=(C=CryptoJS).lib,WordArray=C_lib.WordArray,Hasher=C_lib.Hasher,C_algo=C.algo,W=[],SHA1=C_algo.SHA1=Hasher.extend({_doReset:function(){this._hash=new WordArray.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(M,offset){for(var H=this._hash.words,a=H[0],b=H[1],c=H[2],d=H[3],e=H[4],i=0;i<80;i++){if(i<16)W[i]=0|M[offset+i];else{var n=W[i-3]^W[i-8]^W[i-14]^W[i-16];W[i]=n<<1|n>>>31}var t=(a<<5|a>>>27)+e+W[i];t+=i<20?1518500249+(b&c|~b&d):i<40?1859775393+(b^c^d):i<60?(b&c|b&d|c&d)-1894007588:(b^c^d)-899497514,e=d,d=c,c=b<<30|b>>>2,b=a,a=t}H[0]=H[0]+a|0,H[1]=H[1]+b|0,H[2]=H[2]+c|0,H[3]=H[3]+d|0,H[4]=H[4]+e|0},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsTotal=8*this._nDataBytes,nBitsLeft=8*data.sigBytes;return dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32,dataWords[14+(nBitsLeft+64>>>9<<4)]=Math.floor(nBitsTotal/4294967296),dataWords[15+(nBitsLeft+64>>>9<<4)]=nBitsTotal,data.sigBytes=4*dataWords.length,this._process(),this._hash},clone:function(){var clone=Hasher.clone.call(this);return clone._hash=this._hash.clone(),clone}}),C.SHA1=Hasher._createHelper(SHA1),C.HmacSHA1=Hasher._createHmacHelper(SHA1),CryptoJS.SHA1;var C,C_lib,WordArray,Hasher,C_algo,W,SHA1}(__webpack_require__(2))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){var C,Base,Utf8;Base=(C=CryptoJS).lib.Base,Utf8=C.enc.Utf8,C.algo.HMAC=Base.extend({init:function(hasher,key){hasher=this._hasher=new hasher.init,"string"==typeof key&&(key=Utf8.parse(key));var hasherBlockSize=hasher.blockSize,hasherBlockSizeBytes=4*hasherBlockSize;key.sigBytes>hasherBlockSizeBytes&&(key=hasher.finalize(key)),key.clamp();for(var oKey=this._oKey=key.clone(),iKey=this._iKey=key.clone(),oKeyWords=oKey.words,iKeyWords=iKey.words,i=0;i<hasherBlockSize;i++)oKeyWords[i]^=1549556828,iKeyWords[i]^=909522486;oKey.sigBytes=iKey.sigBytes=hasherBlockSizeBytes,this.reset()},reset:function(){var hasher=this._hasher;hasher.reset(),hasher.update(this._iKey)},update:function(messageUpdate){return this._hasher.update(messageUpdate),this},finalize:function(messageUpdate){var hasher=this._hasher,innerHash=hasher.finalize(messageUpdate);return hasher.reset(),hasher.finalize(this._oKey.clone().concat(innerHash))}})}(__webpack_require__(2))},function(module,exports){var toString={}.toString;module.exports=Array.isArray||function(arr){return"[object Array]"==toString.call(arr)}},function(module,exports,__webpack_require__){"use strict";var Buffer=__webpack_require__(4).Buffer,Transform=__webpack_require__(35).Transform;function HashBase(blockSize){Transform.call(this),this._block=Buffer.allocUnsafe(blockSize),this._blockSize=blockSize,this._blockOffset=0,this._length=[0,0,0,0],this._finalized=!1}__webpack_require__(1)(HashBase,Transform),HashBase.prototype._transform=function(chunk,encoding,callback){var error=null;try{this.update(chunk,encoding)}catch(err){error=err}callback(error)},HashBase.prototype._flush=function(callback){var error=null;try{this.push(this.digest())}catch(err){error=err}callback(error)},HashBase.prototype.update=function(data,encoding){if(function(val,prefix){if(!Buffer.isBuffer(val)&&"string"!=typeof val)throw new TypeError(prefix+" must be a string or a buffer")}(data,"Data"),this._finalized)throw new Error("Digest already called");Buffer.isBuffer(data)||(data=Buffer.from(data,encoding));for(var block=this._block,offset=0;this._blockOffset+data.length-offset>=this._blockSize;){for(var i=this._blockOffset;i<this._blockSize;)block[i++]=data[offset++];this._update(),this._blockOffset=0}for(;offset<data.length;)block[this._blockOffset++]=data[offset++];for(var j=0,carry=8*data.length;carry>0;++j)this._length[j]+=carry,(carry=this._length[j]/4294967296|0)>0&&(this._length[j]-=4294967296*carry);return this},HashBase.prototype._update=function(){throw new Error("_update is not implemented")},HashBase.prototype.digest=function(encoding){if(this._finalized)throw new Error("Digest already called");this._finalized=!0;var digest=this._digest();void 0!==encoding&&(digest=digest.toString(encoding)),this._block.fill(0),this._blockOffset=0;for(var i=0;i<4;++i)this._length[i]=0;return digest},HashBase.prototype._digest=function(){throw new Error("_digest is not implemented")},module.exports=HashBase},function(module,exports,__webpack_require__){"use strict";(function(global,process){var pna=__webpack_require__(28);module.exports=Readable;var Duplex,isArray=__webpack_require__(48);Readable.ReadableState=ReadableState;__webpack_require__(27).EventEmitter;var EElistenerCount=function(emitter,type){return emitter.listeners(type).length},Stream=__webpack_require__(51),Buffer=__webpack_require__(4).Buffer,OurUint8Array=global.Uint8Array||function(){};var util=__webpack_require__(22);util.inherits=__webpack_require__(1);var debugUtil=__webpack_require__(111),debug=void 0;debug=debugUtil&&debugUtil.debuglog?debugUtil.debuglog("stream"):function(){};var StringDecoder,BufferList=__webpack_require__(112),destroyImpl=__webpack_require__(52);util.inherits(Readable,Stream);var kProxyEvents=["error","close","destroy","pause","resume"];function ReadableState(options,stream){options=options||{};var isDuplex=stream instanceof(Duplex=Duplex||__webpack_require__(14));this.objectMode=!!options.objectMode,isDuplex&&(this.objectMode=this.objectMode||!!options.readableObjectMode);var hwm=options.highWaterMark,readableHwm=options.readableHighWaterMark,defaultHwm=this.objectMode?16:16384;this.highWaterMark=hwm||0===hwm?hwm:isDuplex&&(readableHwm||0===readableHwm)?readableHwm:defaultHwm,this.highWaterMark=Math.floor(this.highWaterMark),this.buffer=new BufferList,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.destroyed=!1,this.defaultEncoding=options.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,options.encoding&&(StringDecoder||(StringDecoder=__webpack_require__(38).StringDecoder),this.decoder=new StringDecoder(options.encoding),this.encoding=options.encoding)}function Readable(options){if(Duplex=Duplex||__webpack_require__(14),!(this instanceof Readable))return new Readable(options);this._readableState=new ReadableState(options,this),this.readable=!0,options&&("function"==typeof options.read&&(this._read=options.read),"function"==typeof options.destroy&&(this._destroy=options.destroy)),Stream.call(this)}function readableAddChunk(stream,chunk,encoding,addToFront,skipChunkCheck){var er,state=stream._readableState;null===chunk?(state.reading=!1,function(stream,state){if(state.ended)return;if(state.decoder){var chunk=state.decoder.end();chunk&&chunk.length&&(state.buffer.push(chunk),state.length+=state.objectMode?1:chunk.length)}state.ended=!0,emitReadable(stream)}(stream,state)):(skipChunkCheck||(er=function(state,chunk){var er;obj=chunk,Buffer.isBuffer(obj)||obj instanceof OurUint8Array||"string"==typeof chunk||void 0===chunk||state.objectMode||(er=new TypeError("Invalid non-string/buffer chunk"));var obj;return er}(state,chunk)),er?stream.emit("error",er):state.objectMode||chunk&&chunk.length>0?("string"==typeof chunk||state.objectMode||Object.getPrototypeOf(chunk)===Buffer.prototype||(chunk=function(chunk){return Buffer.from(chunk)}(chunk)),addToFront?state.endEmitted?stream.emit("error",new Error("stream.unshift() after end event")):addChunk(stream,state,chunk,!0):state.ended?stream.emit("error",new Error("stream.push() after EOF")):(state.reading=!1,state.decoder&&!encoding?(chunk=state.decoder.write(chunk),state.objectMode||0!==chunk.length?addChunk(stream,state,chunk,!1):maybeReadMore(stream,state)):addChunk(stream,state,chunk,!1))):addToFront||(state.reading=!1));return function(state){return!state.ended&&(state.needReadable||state.length<state.highWaterMark||0===state.length)}(state)}function addChunk(stream,state,chunk,addToFront){state.flowing&&0===state.length&&!state.sync?(stream.emit("data",chunk),stream.read(0)):(state.length+=state.objectMode?1:chunk.length,addToFront?state.buffer.unshift(chunk):state.buffer.push(chunk),state.needReadable&&emitReadable(stream)),maybeReadMore(stream,state)}Object.defineProperty(Readable.prototype,"destroyed",{get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(value){this._readableState&&(this._readableState.destroyed=value)}}),Readable.prototype.destroy=destroyImpl.destroy,Readable.prototype._undestroy=destroyImpl.undestroy,Readable.prototype._destroy=function(err,cb){this.push(null),cb(err)},Readable.prototype.push=function(chunk,encoding){var skipChunkCheck,state=this._readableState;return state.objectMode?skipChunkCheck=!0:"string"==typeof chunk&&((encoding=encoding||state.defaultEncoding)!==state.encoding&&(chunk=Buffer.from(chunk,encoding),encoding=""),skipChunkCheck=!0),readableAddChunk(this,chunk,encoding,!1,skipChunkCheck)},Readable.prototype.unshift=function(chunk){return readableAddChunk(this,chunk,null,!0,!1)},Readable.prototype.isPaused=function(){return!1===this._readableState.flowing},Readable.prototype.setEncoding=function(enc){return StringDecoder||(StringDecoder=__webpack_require__(38).StringDecoder),this._readableState.decoder=new StringDecoder(enc),this._readableState.encoding=enc,this};var MAX_HWM=8388608;function howMuchToRead(n,state){return n<=0||0===state.length&&state.ended?0:state.objectMode?1:n!=n?state.flowing&&state.length?state.buffer.head.data.length:state.length:(n>state.highWaterMark&&(state.highWaterMark=function(n){return n>=MAX_HWM?n=MAX_HWM:(n--,n|=n>>>1,n|=n>>>2,n|=n>>>4,n|=n>>>8,n|=n>>>16,n++),n}(n)),n<=state.length?n:state.ended?state.length:(state.needReadable=!0,0))}function emitReadable(stream){var state=stream._readableState;state.needReadable=!1,state.emittedReadable||(debug("emitReadable",state.flowing),state.emittedReadable=!0,state.sync?pna.nextTick(emitReadable_,stream):emitReadable_(stream))}function emitReadable_(stream){debug("emit readable"),stream.emit("readable"),flow(stream)}function maybeReadMore(stream,state){state.readingMore||(state.readingMore=!0,pna.nextTick(maybeReadMore_,stream,state))}function maybeReadMore_(stream,state){for(var len=state.length;!state.reading&&!state.flowing&&!state.ended&&state.length<state.highWaterMark&&(debug("maybeReadMore read 0"),stream.read(0),len!==state.length);)len=state.length;state.readingMore=!1}function nReadingNextTick(self){debug("readable nexttick read 0"),self.read(0)}function resume_(stream,state){state.reading||(debug("resume read 0"),stream.read(0)),state.resumeScheduled=!1,state.awaitDrain=0,stream.emit("resume"),flow(stream),state.flowing&&!state.reading&&stream.read(0)}function flow(stream){var state=stream._readableState;for(debug("flow",state.flowing);state.flowing&&null!==stream.read(););}function fromList(n,state){return 0===state.length?null:(state.objectMode?ret=state.buffer.shift():!n||n>=state.length?(ret=state.decoder?state.buffer.join(""):1===state.buffer.length?state.buffer.head.data:state.buffer.concat(state.length),state.buffer.clear()):ret=function(n,list,hasStrings){var ret;n<list.head.data.length?(ret=list.head.data.slice(0,n),list.head.data=list.head.data.slice(n)):ret=n===list.head.data.length?list.shift():hasStrings?function(n,list){var p=list.head,c=1,ret=p.data;n-=ret.length;for(;p=p.next;){var str=p.data,nb=n>str.length?str.length:n;if(nb===str.length?ret+=str:ret+=str.slice(0,n),0===(n-=nb)){nb===str.length?(++c,p.next?list.head=p.next:list.head=list.tail=null):(list.head=p,p.data=str.slice(nb));break}++c}return list.length-=c,ret}(n,list):function(n,list){var ret=Buffer.allocUnsafe(n),p=list.head,c=1;p.data.copy(ret),n-=p.data.length;for(;p=p.next;){var buf=p.data,nb=n>buf.length?buf.length:n;if(buf.copy(ret,ret.length-n,0,nb),0===(n-=nb)){nb===buf.length?(++c,p.next?list.head=p.next:list.head=list.tail=null):(list.head=p,p.data=buf.slice(nb));break}++c}return list.length-=c,ret}(n,list);return ret}(n,state.buffer,state.decoder),ret);var ret}function endReadable(stream){var state=stream._readableState;if(state.length>0)throw new Error('"endReadable()" called on non-empty stream');state.endEmitted||(state.ended=!0,pna.nextTick(endReadableNT,state,stream))}function endReadableNT(state,stream){state.endEmitted||0!==state.length||(state.endEmitted=!0,stream.readable=!1,stream.emit("end"))}function indexOf(xs,x){for(var i=0,l=xs.length;i<l;i++)if(xs[i]===x)return i;return-1}Readable.prototype.read=function(n){debug("read",n),n=parseInt(n,10);var state=this._readableState,nOrig=n;if(0!==n&&(state.emittedReadable=!1),0===n&&state.needReadable&&(state.length>=state.highWaterMark||state.ended))return debug("read: emitReadable",state.length,state.ended),0===state.length&&state.ended?endReadable(this):emitReadable(this),null;if(0===(n=howMuchToRead(n,state))&&state.ended)return 0===state.length&&endReadable(this),null;var ret,doRead=state.needReadable;return debug("need readable",doRead),(0===state.length||state.length-n<state.highWaterMark)&&debug("length less than watermark",doRead=!0),state.ended||state.reading?debug("reading or ended",doRead=!1):doRead&&(debug("do read"),state.reading=!0,state.sync=!0,0===state.length&&(state.needReadable=!0),this._read(state.highWaterMark),state.sync=!1,state.reading||(n=howMuchToRead(nOrig,state))),null===(ret=n>0?fromList(n,state):null)?(state.needReadable=!0,n=0):state.length-=n,0===state.length&&(state.ended||(state.needReadable=!0),nOrig!==n&&state.ended&&endReadable(this)),null!==ret&&this.emit("data",ret),ret},Readable.prototype._read=function(n){this.emit("error",new Error("_read() is not implemented"))},Readable.prototype.pipe=function(dest,pipeOpts){var src=this,state=this._readableState;switch(state.pipesCount){case 0:state.pipes=dest;break;case 1:state.pipes=[state.pipes,dest];break;default:state.pipes.push(dest)}state.pipesCount+=1,debug("pipe count=%d opts=%j",state.pipesCount,pipeOpts);var endFn=(!pipeOpts||!1!==pipeOpts.end)&&dest!==process.stdout&&dest!==process.stderr?onend:unpipe;function onunpipe(readable,unpipeInfo){debug("onunpipe"),readable===src&&unpipeInfo&&!1===unpipeInfo.hasUnpiped&&(unpipeInfo.hasUnpiped=!0,debug("cleanup"),dest.removeListener("close",onclose),dest.removeListener("finish",onfinish),dest.removeListener("drain",ondrain),dest.removeListener("error",onerror),dest.removeListener("unpipe",onunpipe),src.removeListener("end",onend),src.removeListener("end",unpipe),src.removeListener("data",ondata),cleanedUp=!0,!state.awaitDrain||dest._writableState&&!dest._writableState.needDrain||ondrain())}function onend(){debug("onend"),dest.end()}state.endEmitted?pna.nextTick(endFn):src.once("end",endFn),dest.on("unpipe",onunpipe);var ondrain=function(src){return function(){var state=src._readableState;debug("pipeOnDrain",state.awaitDrain),state.awaitDrain&&state.awaitDrain--,0===state.awaitDrain&&EElistenerCount(src,"data")&&(state.flowing=!0,flow(src))}}(src);dest.on("drain",ondrain);var cleanedUp=!1;var increasedAwaitDrain=!1;function ondata(chunk){debug("ondata"),increasedAwaitDrain=!1,!1!==dest.write(chunk)||increasedAwaitDrain||((1===state.pipesCount&&state.pipes===dest||state.pipesCount>1&&-1!==indexOf(state.pipes,dest))&&!cleanedUp&&(debug("false write response, pause",src._readableState.awaitDrain),src._readableState.awaitDrain++,increasedAwaitDrain=!0),src.pause())}function onerror(er){debug("onerror",er),unpipe(),dest.removeListener("error",onerror),0===EElistenerCount(dest,"error")&&dest.emit("error",er)}function onclose(){dest.removeListener("finish",onfinish),unpipe()}function onfinish(){debug("onfinish"),dest.removeListener("close",onclose),unpipe()}function unpipe(){debug("unpipe"),src.unpipe(dest)}return src.on("data",ondata),function(emitter,event,fn){if("function"==typeof emitter.prependListener)return emitter.prependListener(event,fn);emitter._events&&emitter._events[event]?isArray(emitter._events[event])?emitter._events[event].unshift(fn):emitter._events[event]=[fn,emitter._events[event]]:emitter.on(event,fn)}(dest,"error",onerror),dest.once("close",onclose),dest.once("finish",onfinish),dest.emit("pipe",src),state.flowing||(debug("pipe resume"),src.resume()),dest},Readable.prototype.unpipe=function(dest){var state=this._readableState,unpipeInfo={hasUnpiped:!1};if(0===state.pipesCount)return this;if(1===state.pipesCount)return dest&&dest!==state.pipes?this:(dest||(dest=state.pipes),state.pipes=null,state.pipesCount=0,state.flowing=!1,dest&&dest.emit("unpipe",this,unpipeInfo),this);if(!dest){var dests=state.pipes,len=state.pipesCount;state.pipes=null,state.pipesCount=0,state.flowing=!1;for(var i=0;i<len;i++)dests[i].emit("unpipe",this,unpipeInfo);return this}var index=indexOf(state.pipes,dest);return-1===index?this:(state.pipes.splice(index,1),state.pipesCount-=1,1===state.pipesCount&&(state.pipes=state.pipes[0]),dest.emit("unpipe",this,unpipeInfo),this)},Readable.prototype.on=function(ev,fn){var res=Stream.prototype.on.call(this,ev,fn);if("data"===ev)!1!==this._readableState.flowing&&this.resume();else if("readable"===ev){var state=this._readableState;state.endEmitted||state.readableListening||(state.readableListening=state.needReadable=!0,state.emittedReadable=!1,state.reading?state.length&&emitReadable(this):pna.nextTick(nReadingNextTick,this))}return res},Readable.prototype.addListener=Readable.prototype.on,Readable.prototype.resume=function(){var state=this._readableState;return state.flowing||(debug("resume"),state.flowing=!0,function(stream,state){state.resumeScheduled||(state.resumeScheduled=!0,pna.nextTick(resume_,stream,state))}(this,state)),this},Readable.prototype.pause=function(){return debug("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(debug("pause"),this._readableState.flowing=!1,this.emit("pause")),this},Readable.prototype.wrap=function(stream){var _this=this,state=this._readableState,paused=!1;for(var i in stream.on("end",(function(){if(debug("wrapped end"),state.decoder&&!state.ended){var chunk=state.decoder.end();chunk&&chunk.length&&_this.push(chunk)}_this.push(null)})),stream.on("data",(function(chunk){(debug("wrapped data"),state.decoder&&(chunk=state.decoder.write(chunk)),state.objectMode&&null==chunk)||(state.objectMode||chunk&&chunk.length)&&(_this.push(chunk)||(paused=!0,stream.pause()))})),stream)void 0===this[i]&&"function"==typeof stream[i]&&(this[i]=function(method){return function(){return stream[method].apply(stream,arguments)}}(i));for(var n=0;n<kProxyEvents.length;n++)stream.on(kProxyEvents[n],this.emit.bind(this,kProxyEvents[n]));return this._read=function(n){debug("wrapped _read",n),paused&&(paused=!1,stream.resume())},this},Object.defineProperty(Readable.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Readable._fromList=fromList}).call(this,__webpack_require__(10),__webpack_require__(12))},function(module,exports,__webpack_require__){module.exports=__webpack_require__(27).EventEmitter},function(module,exports,__webpack_require__){"use strict";var pna=__webpack_require__(28);function emitErrorNT(self,err){self.emit("error",err)}module.exports={destroy:function(err,cb){var _this=this,readableDestroyed=this._readableState&&this._readableState.destroyed,writableDestroyed=this._writableState&&this._writableState.destroyed;return readableDestroyed||writableDestroyed?(cb?cb(err):!err||this._writableState&&this._writableState.errorEmitted||pna.nextTick(emitErrorNT,this,err),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(err||null,(function(err){!cb&&err?(pna.nextTick(emitErrorNT,_this,err),_this._writableState&&(_this._writableState.errorEmitted=!0)):cb&&cb(err)})),this)},undestroy:function(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}}},function(module,exports,__webpack_require__){"use strict";module.exports=Transform;var Duplex=__webpack_require__(14),util=__webpack_require__(22);function afterTransform(er,data){var ts=this._transformState;ts.transforming=!1;var cb=ts.writecb;if(!cb)return this.emit("error",new Error("write callback called multiple times"));ts.writechunk=null,ts.writecb=null,null!=data&&this.push(data),cb(er);var rs=this._readableState;rs.reading=!1,(rs.needReadable||rs.length<rs.highWaterMark)&&this._read(rs.highWaterMark)}function Transform(options){if(!(this instanceof Transform))return new Transform(options);Duplex.call(this,options),this._transformState={afterTransform:afterTransform.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,options&&("function"==typeof options.transform&&(this._transform=options.transform),"function"==typeof options.flush&&(this._flush=options.flush)),this.on("prefinish",prefinish)}function prefinish(){var _this=this;"function"==typeof this._flush?this._flush((function(er,data){done(_this,er,data)})):done(this,null,null)}function done(stream,er,data){if(er)return stream.emit("error",er);if(null!=data&&stream.push(data),stream._writableState.length)throw new Error("Calling transform done when ws.length != 0");if(stream._transformState.transforming)throw new Error("Calling transform done when still transforming");return stream.push(null)}util.inherits=__webpack_require__(1),util.inherits(Transform,Duplex),Transform.prototype.push=function(chunk,encoding){return this._transformState.needTransform=!1,Duplex.prototype.push.call(this,chunk,encoding)},Transform.prototype._transform=function(chunk,encoding,cb){throw new Error("_transform() is not implemented")},Transform.prototype._write=function(chunk,encoding,cb){var ts=this._transformState;if(ts.writecb=cb,ts.writechunk=chunk,ts.writeencoding=encoding,!ts.transforming){var rs=this._readableState;(ts.needTransform||rs.needReadable||rs.length<rs.highWaterMark)&&this._read(rs.highWaterMark)}},Transform.prototype._read=function(n){var ts=this._transformState;null!==ts.writechunk&&ts.writecb&&!ts.transforming?(ts.transforming=!0,this._transform(ts.writechunk,ts.writeencoding,ts.afterTransform)):ts.needTransform=!0},Transform.prototype._destroy=function(err,cb){var _this2=this;Duplex.prototype._destroy.call(this,err,(function(err2){cb(err2),_this2.emit("close")}))}},function(module,exports,__webpack_require__){var inherits=__webpack_require__(1),Hash=__webpack_require__(17),Buffer=__webpack_require__(4).Buffer,K=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],W=new Array(64);function Sha256(){this.init(),this._w=W,Hash.call(this,64,56)}function ch(x,y,z){return z^x&(y^z)}function maj(x,y,z){return x&y|z&(x|y)}function sigma0(x){return(x>>>2|x<<30)^(x>>>13|x<<19)^(x>>>22|x<<10)}function sigma1(x){return(x>>>6|x<<26)^(x>>>11|x<<21)^(x>>>25|x<<7)}function gamma0(x){return(x>>>7|x<<25)^(x>>>18|x<<14)^x>>>3}inherits(Sha256,Hash),Sha256.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this},Sha256.prototype._update=function(M){for(var x,W=this._w,a=0|this._a,b=0|this._b,c=0|this._c,d=0|this._d,e=0|this._e,f=0|this._f,g=0|this._g,h=0|this._h,i=0;i<16;++i)W[i]=M.readInt32BE(4*i);for(;i<64;++i)W[i]=0|(((x=W[i-2])>>>17|x<<15)^(x>>>19|x<<13)^x>>>10)+W[i-7]+gamma0(W[i-15])+W[i-16];for(var j=0;j<64;++j){var T1=h+sigma1(e)+ch(e,f,g)+K[j]+W[j]|0,T2=sigma0(a)+maj(a,b,c)|0;h=g,g=f,f=e,e=d+T1|0,d=c,c=b,b=a,a=T1+T2|0}this._a=a+this._a|0,this._b=b+this._b|0,this._c=c+this._c|0,this._d=d+this._d|0,this._e=e+this._e|0,this._f=f+this._f|0,this._g=g+this._g|0,this._h=h+this._h|0},Sha256.prototype._hash=function(){var H=Buffer.allocUnsafe(32);return H.writeInt32BE(this._a,0),H.writeInt32BE(this._b,4),H.writeInt32BE(this._c,8),H.writeInt32BE(this._d,12),H.writeInt32BE(this._e,16),H.writeInt32BE(this._f,20),H.writeInt32BE(this._g,24),H.writeInt32BE(this._h,28),H},module.exports=Sha256},function(module,exports,__webpack_require__){var inherits=__webpack_require__(1),Hash=__webpack_require__(17),Buffer=__webpack_require__(4).Buffer,K=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],W=new Array(160);function Sha512(){this.init(),this._w=W,Hash.call(this,128,112)}function Ch(x,y,z){return z^x&(y^z)}function maj(x,y,z){return x&y|z&(x|y)}function sigma0(x,xl){return(x>>>28|xl<<4)^(xl>>>2|x<<30)^(xl>>>7|x<<25)}function sigma1(x,xl){return(x>>>14|xl<<18)^(x>>>18|xl<<14)^(xl>>>9|x<<23)}function Gamma0(x,xl){return(x>>>1|xl<<31)^(x>>>8|xl<<24)^x>>>7}function Gamma0l(x,xl){return(x>>>1|xl<<31)^(x>>>8|xl<<24)^(x>>>7|xl<<25)}function Gamma1(x,xl){return(x>>>19|xl<<13)^(xl>>>29|x<<3)^x>>>6}function Gamma1l(x,xl){return(x>>>19|xl<<13)^(xl>>>29|x<<3)^(x>>>6|xl<<26)}function getCarry(a,b){return a>>>0<b>>>0?1:0}inherits(Sha512,Hash),Sha512.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this},Sha512.prototype._update=function(M){for(var W=this._w,ah=0|this._ah,bh=0|this._bh,ch=0|this._ch,dh=0|this._dh,eh=0|this._eh,fh=0|this._fh,gh=0|this._gh,hh=0|this._hh,al=0|this._al,bl=0|this._bl,cl=0|this._cl,dl=0|this._dl,el=0|this._el,fl=0|this._fl,gl=0|this._gl,hl=0|this._hl,i=0;i<32;i+=2)W[i]=M.readInt32BE(4*i),W[i+1]=M.readInt32BE(4*i+4);for(;i<160;i+=2){var xh=W[i-30],xl=W[i-30+1],gamma0=Gamma0(xh,xl),gamma0l=Gamma0l(xl,xh),gamma1=Gamma1(xh=W[i-4],xl=W[i-4+1]),gamma1l=Gamma1l(xl,xh),Wi7h=W[i-14],Wi7l=W[i-14+1],Wi16h=W[i-32],Wi16l=W[i-32+1],Wil=gamma0l+Wi7l|0,Wih=gamma0+Wi7h+getCarry(Wil,gamma0l)|0;Wih=(Wih=Wih+gamma1+getCarry(Wil=Wil+gamma1l|0,gamma1l)|0)+Wi16h+getCarry(Wil=Wil+Wi16l|0,Wi16l)|0,W[i]=Wih,W[i+1]=Wil}for(var j=0;j<160;j+=2){Wih=W[j],Wil=W[j+1];var majh=maj(ah,bh,ch),majl=maj(al,bl,cl),sigma0h=sigma0(ah,al),sigma0l=sigma0(al,ah),sigma1h=sigma1(eh,el),sigma1l=sigma1(el,eh),Kih=K[j],Kil=K[j+1],chh=Ch(eh,fh,gh),chl=Ch(el,fl,gl),t1l=hl+sigma1l|0,t1h=hh+sigma1h+getCarry(t1l,hl)|0;t1h=(t1h=(t1h=t1h+chh+getCarry(t1l=t1l+chl|0,chl)|0)+Kih+getCarry(t1l=t1l+Kil|0,Kil)|0)+Wih+getCarry(t1l=t1l+Wil|0,Wil)|0;var t2l=sigma0l+majl|0,t2h=sigma0h+majh+getCarry(t2l,sigma0l)|0;hh=gh,hl=gl,gh=fh,gl=fl,fh=eh,fl=el,eh=dh+t1h+getCarry(el=dl+t1l|0,dl)|0,dh=ch,dl=cl,ch=bh,cl=bl,bh=ah,bl=al,ah=t1h+t2h+getCarry(al=t1l+t2l|0,t1l)|0}this._al=this._al+al|0,this._bl=this._bl+bl|0,this._cl=this._cl+cl|0,this._dl=this._dl+dl|0,this._el=this._el+el|0,this._fl=this._fl+fl|0,this._gl=this._gl+gl|0,this._hl=this._hl+hl|0,this._ah=this._ah+ah+getCarry(this._al,al)|0,this._bh=this._bh+bh+getCarry(this._bl,bl)|0,this._ch=this._ch+ch+getCarry(this._cl,cl)|0,this._dh=this._dh+dh+getCarry(this._dl,dl)|0,this._eh=this._eh+eh+getCarry(this._el,el)|0,this._fh=this._fh+fh+getCarry(this._fl,fl)|0,this._gh=this._gh+gh+getCarry(this._gl,gl)|0,this._hh=this._hh+hh+getCarry(this._hl,hl)|0},Sha512.prototype._hash=function(){var H=Buffer.allocUnsafe(64);function writeInt64BE(h,l,offset){H.writeInt32BE(h,offset),H.writeInt32BE(l,offset+4)}return writeInt64BE(this._ah,this._al,0),writeInt64BE(this._bh,this._bl,8),writeInt64BE(this._ch,this._cl,16),writeInt64BE(this._dh,this._dl,24),writeInt64BE(this._eh,this._el,32),writeInt64BE(this._fh,this._fl,40),writeInt64BE(this._gh,this._gl,48),writeInt64BE(this._hh,this._hl,56),H},module.exports=Sha512},function(module,exports,__webpack_require__){"use strict";var inherits=__webpack_require__(1),Legacy=__webpack_require__(126),Base=__webpack_require__(13),Buffer=__webpack_require__(4).Buffer,md5=__webpack_require__(57),RIPEMD160=__webpack_require__(39),sha=__webpack_require__(40),ZEROS=Buffer.alloc(128);function Hmac(alg,key){Base.call(this,"digest"),"string"==typeof key&&(key=Buffer.from(key));var blocksize="sha512"===alg||"sha384"===alg?128:64;(this._alg=alg,this._key=key,key.length>blocksize)?key=("rmd160"===alg?new RIPEMD160:sha(alg)).update(key).digest():key.length<blocksize&&(key=Buffer.concat([key,ZEROS],blocksize));for(var ipad=this._ipad=Buffer.allocUnsafe(blocksize),opad=this._opad=Buffer.allocUnsafe(blocksize),i=0;i<blocksize;i++)ipad[i]=54^key[i],opad[i]=92^key[i];this._hash="rmd160"===alg?new RIPEMD160:sha(alg),this._hash.update(ipad)}inherits(Hmac,Base),Hmac.prototype._update=function(data){this._hash.update(data)},Hmac.prototype._final=function(){var h=this._hash.digest();return("rmd160"===this._alg?new RIPEMD160:sha(this._alg)).update(this._opad).update(h).digest()},module.exports=function(alg,key){return"rmd160"===(alg=alg.toLowerCase())||"ripemd160"===alg?new Hmac("rmd160",key):"md5"===alg?new Legacy(md5,key):new Hmac(alg,key)}},function(module,exports,__webpack_require__){var MD5=__webpack_require__(34);module.exports=function(buffer){return(new MD5).update(buffer).digest()}},function(module){module.exports=JSON.parse('{"sha224WithRSAEncryption":{"sign":"rsa","hash":"sha224","id":"302d300d06096086480165030402040500041c"},"RSA-SHA224":{"sign":"ecdsa/rsa","hash":"sha224","id":"302d300d06096086480165030402040500041c"},"sha256WithRSAEncryption":{"sign":"rsa","hash":"sha256","id":"3031300d060960864801650304020105000420"},"RSA-SHA256":{"sign":"ecdsa/rsa","hash":"sha256","id":"3031300d060960864801650304020105000420"},"sha384WithRSAEncryption":{"sign":"rsa","hash":"sha384","id":"3041300d060960864801650304020205000430"},"RSA-SHA384":{"sign":"ecdsa/rsa","hash":"sha384","id":"3041300d060960864801650304020205000430"},"sha512WithRSAEncryption":{"sign":"rsa","hash":"sha512","id":"3051300d060960864801650304020305000440"},"RSA-SHA512":{"sign":"ecdsa/rsa","hash":"sha512","id":"3051300d060960864801650304020305000440"},"RSA-SHA1":{"sign":"rsa","hash":"sha1","id":"3021300906052b0e03021a05000414"},"ecdsa-with-SHA1":{"sign":"ecdsa","hash":"sha1","id":""},"sha256":{"sign":"ecdsa","hash":"sha256","id":""},"sha224":{"sign":"ecdsa","hash":"sha224","id":""},"sha384":{"sign":"ecdsa","hash":"sha384","id":""},"sha512":{"sign":"ecdsa","hash":"sha512","id":""},"DSA-SHA":{"sign":"dsa","hash":"sha1","id":""},"DSA-SHA1":{"sign":"dsa","hash":"sha1","id":""},"DSA":{"sign":"dsa","hash":"sha1","id":""},"DSA-WITH-SHA224":{"sign":"dsa","hash":"sha224","id":""},"DSA-SHA224":{"sign":"dsa","hash":"sha224","id":""},"DSA-WITH-SHA256":{"sign":"dsa","hash":"sha256","id":""},"DSA-SHA256":{"sign":"dsa","hash":"sha256","id":""},"DSA-WITH-SHA384":{"sign":"dsa","hash":"sha384","id":""},"DSA-SHA384":{"sign":"dsa","hash":"sha384","id":""},"DSA-WITH-SHA512":{"sign":"dsa","hash":"sha512","id":""},"DSA-SHA512":{"sign":"dsa","hash":"sha512","id":""},"DSA-RIPEMD160":{"sign":"dsa","hash":"rmd160","id":""},"ripemd160WithRSA":{"sign":"rsa","hash":"rmd160","id":"3021300906052b2403020105000414"},"RSA-RIPEMD160":{"sign":"rsa","hash":"rmd160","id":"3021300906052b2403020105000414"},"md5WithRSAEncryption":{"sign":"rsa","hash":"md5","id":"3020300c06082a864886f70d020505000410"},"RSA-MD5":{"sign":"rsa","hash":"md5","id":"3020300c06082a864886f70d020505000410"}}')},function(module,exports,__webpack_require__){exports.pbkdf2=__webpack_require__(128),exports.pbkdf2Sync=__webpack_require__(62)},function(module,exports,__webpack_require__){(function(Buffer){var MAX_ALLOC=Math.pow(2,30)-1;function checkBuffer(buf,name){if("string"!=typeof buf&&!Buffer.isBuffer(buf))throw new TypeError(name+" must be a buffer or string")}module.exports=function(password,salt,iterations,keylen){if(checkBuffer(password,"Password"),checkBuffer(salt,"Salt"),"number"!=typeof iterations)throw new TypeError("Iterations not a number");if(iterations<0)throw new TypeError("Bad iterations");if("number"!=typeof keylen)throw new TypeError("Key length not a number");if(keylen<0||keylen>MAX_ALLOC||keylen!=keylen)throw new TypeError("Bad key length")}}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){(function(process){var defaultEncoding;process.browser?defaultEncoding="utf-8":defaultEncoding=parseInt(process.version.split(".")[0].slice(1),10)>=6?"utf-8":"binary";module.exports=defaultEncoding}).call(this,__webpack_require__(12))},function(module,exports,__webpack_require__){var md5=__webpack_require__(57),rmd160=__webpack_require__(39),sha=__webpack_require__(40),checkParameters=__webpack_require__(60),defaultEncoding=__webpack_require__(61),Buffer=__webpack_require__(4).Buffer,ZEROS=Buffer.alloc(128),sizes={md5:16,sha1:20,sha224:28,sha256:32,sha384:48,sha512:64,rmd160:20,ripemd160:20};function Hmac(alg,key,saltLen){var hash=function(alg){return"rmd160"===alg||"ripemd160"===alg?rmd160:"md5"===alg?md5:function(data){return sha(alg).update(data).digest()}}(alg),blocksize="sha512"===alg||"sha384"===alg?128:64;key.length>blocksize?key=hash(key):key.length<blocksize&&(key=Buffer.concat([key,ZEROS],blocksize));for(var ipad=Buffer.allocUnsafe(blocksize+sizes[alg]),opad=Buffer.allocUnsafe(blocksize+sizes[alg]),i=0;i<blocksize;i++)ipad[i]=54^key[i],opad[i]=92^key[i];var ipad1=Buffer.allocUnsafe(blocksize+saltLen+4);ipad.copy(ipad1,0,0,blocksize),this.ipad1=ipad1,this.ipad2=ipad,this.opad=opad,this.alg=alg,this.blocksize=blocksize,this.hash=hash,this.size=sizes[alg]}Hmac.prototype.run=function(data,ipad){return data.copy(ipad,this.blocksize),this.hash(ipad).copy(this.opad,this.blocksize),this.hash(this.opad)},module.exports=function(password,salt,iterations,keylen,digest){checkParameters(password,salt,iterations,keylen),Buffer.isBuffer(password)||(password=Buffer.from(password,defaultEncoding)),Buffer.isBuffer(salt)||(salt=Buffer.from(salt,defaultEncoding));var hmac=new Hmac(digest=digest||"sha1",password,salt.length),DK=Buffer.allocUnsafe(keylen),block1=Buffer.allocUnsafe(salt.length+4);salt.copy(block1,0,0,salt.length);for(var destPos=0,hLen=sizes[digest],l=Math.ceil(keylen/hLen),i=1;i<=l;i++){block1.writeUInt32BE(i,salt.length);for(var T=hmac.run(block1,hmac.ipad1),U=T,j=1;j<iterations;j++){U=hmac.run(U,hmac.ipad2);for(var k=0;k<hLen;k++)T[k]^=U[k]}T.copy(DK,destPos),destPos+=hLen}return DK}},function(module,exports,__webpack_require__){var xor=__webpack_require__(23),Buffer=__webpack_require__(4).Buffer,incr32=__webpack_require__(64);function getBlock(self){var out=self._cipher.encryptBlockRaw(self._prev);return incr32(self._prev),out}exports.encrypt=function(self,chunk){var chunkNum=Math.ceil(chunk.length/16),start=self._cache.length;self._cache=Buffer.concat([self._cache,Buffer.allocUnsafe(16*chunkNum)]);for(var i=0;i<chunkNum;i++){var out=getBlock(self),offset=start+16*i;self._cache.writeUInt32BE(out[0],offset+0),self._cache.writeUInt32BE(out[1],offset+4),self._cache.writeUInt32BE(out[2],offset+8),self._cache.writeUInt32BE(out[3],offset+12)}var pad=self._cache.slice(0,chunk.length);return self._cache=self._cache.slice(chunk.length),xor(chunk,pad)}},function(module,exports){module.exports=function(iv){for(var item,len=iv.length;len--;){if(255!==(item=iv.readUInt8(len))){item++,iv.writeUInt8(item,len);break}iv.writeUInt8(0,len)}}},function(module){module.exports=JSON.parse('{"aes-128-ecb":{"cipher":"AES","key":128,"iv":0,"mode":"ECB","type":"block"},"aes-192-ecb":{"cipher":"AES","key":192,"iv":0,"mode":"ECB","type":"block"},"aes-256-ecb":{"cipher":"AES","key":256,"iv":0,"mode":"ECB","type":"block"},"aes-128-cbc":{"cipher":"AES","key":128,"iv":16,"mode":"CBC","type":"block"},"aes-192-cbc":{"cipher":"AES","key":192,"iv":16,"mode":"CBC","type":"block"},"aes-256-cbc":{"cipher":"AES","key":256,"iv":16,"mode":"CBC","type":"block"},"aes128":{"cipher":"AES","key":128,"iv":16,"mode":"CBC","type":"block"},"aes192":{"cipher":"AES","key":192,"iv":16,"mode":"CBC","type":"block"},"aes256":{"cipher":"AES","key":256,"iv":16,"mode":"CBC","type":"block"},"aes-128-cfb":{"cipher":"AES","key":128,"iv":16,"mode":"CFB","type":"stream"},"aes-192-cfb":{"cipher":"AES","key":192,"iv":16,"mode":"CFB","type":"stream"},"aes-256-cfb":{"cipher":"AES","key":256,"iv":16,"mode":"CFB","type":"stream"},"aes-128-cfb8":{"cipher":"AES","key":128,"iv":16,"mode":"CFB8","type":"stream"},"aes-192-cfb8":{"cipher":"AES","key":192,"iv":16,"mode":"CFB8","type":"stream"},"aes-256-cfb8":{"cipher":"AES","key":256,"iv":16,"mode":"CFB8","type":"stream"},"aes-128-cfb1":{"cipher":"AES","key":128,"iv":16,"mode":"CFB1","type":"stream"},"aes-192-cfb1":{"cipher":"AES","key":192,"iv":16,"mode":"CFB1","type":"stream"},"aes-256-cfb1":{"cipher":"AES","key":256,"iv":16,"mode":"CFB1","type":"stream"},"aes-128-ofb":{"cipher":"AES","key":128,"iv":16,"mode":"OFB","type":"stream"},"aes-192-ofb":{"cipher":"AES","key":192,"iv":16,"mode":"OFB","type":"stream"},"aes-256-ofb":{"cipher":"AES","key":256,"iv":16,"mode":"OFB","type":"stream"},"aes-128-ctr":{"cipher":"AES","key":128,"iv":16,"mode":"CTR","type":"stream"},"aes-192-ctr":{"cipher":"AES","key":192,"iv":16,"mode":"CTR","type":"stream"},"aes-256-ctr":{"cipher":"AES","key":256,"iv":16,"mode":"CTR","type":"stream"},"aes-128-gcm":{"cipher":"AES","key":128,"iv":12,"mode":"GCM","type":"auth"},"aes-192-gcm":{"cipher":"AES","key":192,"iv":12,"mode":"GCM","type":"auth"},"aes-256-gcm":{"cipher":"AES","key":256,"iv":12,"mode":"GCM","type":"auth"}}')},function(module,exports,__webpack_require__){var aes=__webpack_require__(29),Buffer=__webpack_require__(4).Buffer,Transform=__webpack_require__(13),inherits=__webpack_require__(1),GHASH=__webpack_require__(143),xor=__webpack_require__(23),incr32=__webpack_require__(64);function StreamCipher(mode,key,iv,decrypt){Transform.call(this);var h=Buffer.alloc(4,0);this._cipher=new aes.AES(key);var ck=this._cipher.encryptBlock(h);this._ghash=new GHASH(ck),iv=function(self,iv,ck){if(12===iv.length)return self._finID=Buffer.concat([iv,Buffer.from([0,0,0,1])]),Buffer.concat([iv,Buffer.from([0,0,0,2])]);var ghash=new GHASH(ck),len=iv.length,toPad=len%16;ghash.update(iv),toPad&&(toPad=16-toPad,ghash.update(Buffer.alloc(toPad,0))),ghash.update(Buffer.alloc(8,0));var ivBits=8*len,tail=Buffer.alloc(8);tail.writeUIntBE(ivBits,0,8),ghash.update(tail),self._finID=ghash.state;var out=Buffer.from(self._finID);return incr32(out),out}(this,iv,ck),this._prev=Buffer.from(iv),this._cache=Buffer.allocUnsafe(0),this._secCache=Buffer.allocUnsafe(0),this._decrypt=decrypt,this._alen=0,this._len=0,this._mode=mode,this._authTag=null,this._called=!1}inherits(StreamCipher,Transform),StreamCipher.prototype._update=function(chunk){if(!this._called&&this._alen){var rump=16-this._alen%16;rump<16&&(rump=Buffer.alloc(rump,0),this._ghash.update(rump))}this._called=!0;var out=this._mode.encrypt(this,chunk);return this._decrypt?this._ghash.update(chunk):this._ghash.update(out),this._len+=chunk.length,out},StreamCipher.prototype._final=function(){if(this._decrypt&&!this._authTag)throw new Error("Unsupported state or unable to authenticate data");var tag=xor(this._ghash.final(8*this._alen,8*this._len),this._cipher.encryptBlock(this._finID));if(this._decrypt&&function(a,b){var out=0;a.length!==b.length&&out++;for(var len=Math.min(a.length,b.length),i=0;i<len;++i)out+=a[i]^b[i];return out}(tag,this._authTag))throw new Error("Unsupported state or unable to authenticate data");this._authTag=tag,this._cipher.scrub()},StreamCipher.prototype.getAuthTag=function(){if(this._decrypt||!Buffer.isBuffer(this._authTag))throw new Error("Attempting to get auth tag in unsupported state");return this._authTag},StreamCipher.prototype.setAuthTag=function(tag){if(!this._decrypt)throw new Error("Attempting to set auth tag in unsupported state");this._authTag=tag},StreamCipher.prototype.setAAD=function(buf){if(this._called)throw new Error("Attempting to set AAD in unsupported state");this._ghash.update(buf),this._alen+=buf.length},module.exports=StreamCipher},function(module,exports,__webpack_require__){var aes=__webpack_require__(29),Buffer=__webpack_require__(4).Buffer,Transform=__webpack_require__(13);function StreamCipher(mode,key,iv,decrypt){Transform.call(this),this._cipher=new aes.AES(key),this._prev=Buffer.from(iv),this._cache=Buffer.allocUnsafe(0),this._secCache=Buffer.allocUnsafe(0),this._decrypt=decrypt,this._mode=mode}__webpack_require__(1)(StreamCipher,Transform),StreamCipher.prototype._update=function(chunk){return this._mode.encrypt(this,chunk,this._decrypt)},StreamCipher.prototype._final=function(){this._cipher.scrub()},module.exports=StreamCipher},function(module,exports,__webpack_require__){var randomBytes=__webpack_require__(16);module.exports=findPrime,findPrime.simpleSieve=simpleSieve,findPrime.fermatTest=fermatTest;var BN=__webpack_require__(6),TWENTYFOUR=new BN(24),millerRabin=new(__webpack_require__(69)),ONE=new BN(1),TWO=new BN(2),FIVE=new BN(5),TEN=(new BN(16),new BN(8),new BN(10)),THREE=new BN(3),ELEVEN=(new BN(7),new BN(11)),FOUR=new BN(4),primes=(new BN(12),null);function _getPrimes(){if(null!==primes)return primes;var res=[];res[0]=2;for(var i=1,k=3;k<1048576;k+=2){for(var sqrt=Math.ceil(Math.sqrt(k)),j=0;j<i&&res[j]<=sqrt&&k%res[j]!=0;j++);i!==j&&res[j]<=sqrt||(res[i++]=k)}return primes=res,res}function simpleSieve(p){for(var primes=_getPrimes(),i=0;i<primes.length;i++)if(0===p.modn(primes[i]))return 0===p.cmpn(primes[i]);return!0}function fermatTest(p){var red=BN.mont(p);return 0===TWO.toRed(red).redPow(p.subn(1)).fromRed().cmpn(1)}function findPrime(bits,gen){if(bits<16)return new BN(2===gen||5===gen?[140,123]:[140,39]);var num,n2;for(gen=new BN(gen);;){for(num=new BN(randomBytes(Math.ceil(bits/8)));num.bitLength()>bits;)num.ishrn(1);if(num.isEven()&&num.iadd(ONE),num.testn(1)||num.iadd(TWO),gen.cmp(TWO)){if(!gen.cmp(FIVE))for(;num.mod(TEN).cmp(THREE);)num.iadd(FOUR)}else for(;num.mod(TWENTYFOUR).cmp(ELEVEN);)num.iadd(FOUR);if(simpleSieve(n2=num.shrn(1))&&simpleSieve(num)&&fermatTest(n2)&&fermatTest(num)&&millerRabin.test(n2)&&millerRabin.test(num))return num}}},function(module,exports,__webpack_require__){var bn=__webpack_require__(6),brorand=__webpack_require__(70);function MillerRabin(rand){this.rand=rand||new brorand.Rand}module.exports=MillerRabin,MillerRabin.create=function(rand){return new MillerRabin(rand)},MillerRabin.prototype._randbelow=function(n){var len=n.bitLength(),min_bytes=Math.ceil(len/8);do{var a=new bn(this.rand.generate(min_bytes))}while(a.cmp(n)>=0);return a},MillerRabin.prototype._randrange=function(start,stop){var size=stop.sub(start);return start.add(this._randbelow(size))},MillerRabin.prototype.test=function(n,k,cb){var len=n.bitLength(),red=bn.mont(n),rone=new bn(1).toRed(red);k||(k=Math.max(1,len/48|0));for(var n1=n.subn(1),s=0;!n1.testn(s);s++);for(var d=n.shrn(s),rn1=n1.toRed(red);k>0;k--){var a=this._randrange(new bn(2),n1);cb&&cb(a);var x=a.toRed(red).redPow(d);if(0!==x.cmp(rone)&&0!==x.cmp(rn1)){for(var i=1;i<s;i++){if(0===(x=x.redSqr()).cmp(rone))return!1;if(0===x.cmp(rn1))break}if(i===s)return!1}}return!0},MillerRabin.prototype.getDivisor=function(n,k){var len=n.bitLength(),red=bn.mont(n),rone=new bn(1).toRed(red);k||(k=Math.max(1,len/48|0));for(var n1=n.subn(1),s=0;!n1.testn(s);s++);for(var d=n.shrn(s),rn1=n1.toRed(red);k>0;k--){var a=this._randrange(new bn(2),n1),g=n.gcd(a);if(0!==g.cmpn(1))return g;var x=a.toRed(red).redPow(d);if(0!==x.cmp(rone)&&0!==x.cmp(rn1)){for(var i=1;i<s;i++){if(0===(x=x.redSqr()).cmp(rone))return x.fromRed().subn(1).gcd(n);if(0===x.cmp(rn1))break}if(i===s)return(x=x.redSqr()).fromRed().subn(1).gcd(n)}}return!1}},function(module,exports,__webpack_require__){var r;function Rand(rand){this.rand=rand}if(module.exports=function(len){return r||(r=new Rand(null)),r.generate(len)},module.exports.Rand=Rand,Rand.prototype.generate=function(len){return this._rand(len)},Rand.prototype._rand=function(n){if(this.rand.getBytes)return this.rand.getBytes(n);for(var res=new Uint8Array(n),i=0;i<res.length;i++)res[i]=this.rand.getByte();return res},"object"==typeof self)self.crypto&&self.crypto.getRandomValues?Rand.prototype._rand=function(n){var arr=new Uint8Array(n);return self.crypto.getRandomValues(arr),arr}:self.msCrypto&&self.msCrypto.getRandomValues?Rand.prototype._rand=function(n){var arr=new Uint8Array(n);return self.msCrypto.getRandomValues(arr),arr}:"object"==typeof window&&(Rand.prototype._rand=function(){throw new Error("Not implemented yet")});else try{var crypto=__webpack_require__(149);if("function"!=typeof crypto.randomBytes)throw new Error("Not supported");Rand.prototype._rand=function(n){return crypto.randomBytes(n)}}catch(e){}},function(module,exports,__webpack_require__){"use strict";var utils=exports;function zero2(word){return 1===word.length?"0"+word:word}function toHex(msg){for(var res="",i=0;i<msg.length;i++)res+=zero2(msg[i].toString(16));return res}utils.toArray=function(msg,enc){if(Array.isArray(msg))return msg.slice();if(!msg)return[];var res=[];if("string"!=typeof msg){for(var i=0;i<msg.length;i++)res[i]=0|msg[i];return res}if("hex"===enc){(msg=msg.replace(/[^a-z0-9]+/gi,"")).length%2!=0&&(msg="0"+msg);for(i=0;i<msg.length;i+=2)res.push(parseInt(msg[i]+msg[i+1],16))}else for(i=0;i<msg.length;i++){var c=msg.charCodeAt(i),hi=c>>8,lo=255&c;hi?res.push(hi,lo):res.push(lo)}return res},utils.zero2=zero2,utils.toHex=toHex,utils.encode=function(arr,enc){return"hex"===enc?toHex(arr):arr}},function(module,exports,__webpack_require__){"use strict";var rotr32=__webpack_require__(11).rotr32;function ch32(x,y,z){return x&y^~x&z}function maj32(x,y,z){return x&y^x&z^y&z}function p32(x,y,z){return x^y^z}exports.ft_1=function(s,x,y,z){return 0===s?ch32(x,y,z):1===s||3===s?p32(x,y,z):2===s?maj32(x,y,z):void 0},exports.ch32=ch32,exports.maj32=maj32,exports.p32=p32,exports.s0_256=function(x){return rotr32(x,2)^rotr32(x,13)^rotr32(x,22)},exports.s1_256=function(x){return rotr32(x,6)^rotr32(x,11)^rotr32(x,25)},exports.g0_256=function(x){return rotr32(x,7)^rotr32(x,18)^x>>>3},exports.g1_256=function(x){return rotr32(x,17)^rotr32(x,19)^x>>>10}},function(module,exports,__webpack_require__){"use strict";var utils=__webpack_require__(11),common=__webpack_require__(24),shaCommon=__webpack_require__(72),assert=__webpack_require__(9),sum32=utils.sum32,sum32_4=utils.sum32_4,sum32_5=utils.sum32_5,ch32=shaCommon.ch32,maj32=shaCommon.maj32,s0_256=shaCommon.s0_256,s1_256=shaCommon.s1_256,g0_256=shaCommon.g0_256,g1_256=shaCommon.g1_256,BlockHash=common.BlockHash,sha256_K=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function SHA256(){if(!(this instanceof SHA256))return new SHA256;BlockHash.call(this),this.h=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],this.k=sha256_K,this.W=new Array(64)}utils.inherits(SHA256,BlockHash),module.exports=SHA256,SHA256.blockSize=512,SHA256.outSize=256,SHA256.hmacStrength=192,SHA256.padLength=64,SHA256.prototype._update=function(msg,start){for(var W=this.W,i=0;i<16;i++)W[i]=msg[start+i];for(;i<W.length;i++)W[i]=sum32_4(g1_256(W[i-2]),W[i-7],g0_256(W[i-15]),W[i-16]);var a=this.h[0],b=this.h[1],c=this.h[2],d=this.h[3],e=this.h[4],f=this.h[5],g=this.h[6],h=this.h[7];for(assert(this.k.length===W.length),i=0;i<W.length;i++){var T1=sum32_5(h,s1_256(e),ch32(e,f,g),this.k[i],W[i]),T2=sum32(s0_256(a),maj32(a,b,c));h=g,g=f,f=e,e=sum32(d,T1),d=c,c=b,b=a,a=sum32(T1,T2)}this.h[0]=sum32(this.h[0],a),this.h[1]=sum32(this.h[1],b),this.h[2]=sum32(this.h[2],c),this.h[3]=sum32(this.h[3],d),this.h[4]=sum32(this.h[4],e),this.h[5]=sum32(this.h[5],f),this.h[6]=sum32(this.h[6],g),this.h[7]=sum32(this.h[7],h)},SHA256.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h,"big"):utils.split32(this.h,"big")}},function(module,exports,__webpack_require__){"use strict";var utils=__webpack_require__(11),common=__webpack_require__(24),assert=__webpack_require__(9),rotr64_hi=utils.rotr64_hi,rotr64_lo=utils.rotr64_lo,shr64_hi=utils.shr64_hi,shr64_lo=utils.shr64_lo,sum64=utils.sum64,sum64_hi=utils.sum64_hi,sum64_lo=utils.sum64_lo,sum64_4_hi=utils.sum64_4_hi,sum64_4_lo=utils.sum64_4_lo,sum64_5_hi=utils.sum64_5_hi,sum64_5_lo=utils.sum64_5_lo,BlockHash=common.BlockHash,sha512_K=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591];function SHA512(){if(!(this instanceof SHA512))return new SHA512;BlockHash.call(this),this.h=[1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209],this.k=sha512_K,this.W=new Array(160)}function ch64_hi(xh,xl,yh,yl,zh){var r=xh&yh^~xh&zh;return r<0&&(r+=4294967296),r}function ch64_lo(xh,xl,yh,yl,zh,zl){var r=xl&yl^~xl&zl;return r<0&&(r+=4294967296),r}function maj64_hi(xh,xl,yh,yl,zh){var r=xh&yh^xh&zh^yh&zh;return r<0&&(r+=4294967296),r}function maj64_lo(xh,xl,yh,yl,zh,zl){var r=xl&yl^xl&zl^yl&zl;return r<0&&(r+=4294967296),r}function s0_512_hi(xh,xl){var r=rotr64_hi(xh,xl,28)^rotr64_hi(xl,xh,2)^rotr64_hi(xl,xh,7);return r<0&&(r+=4294967296),r}function s0_512_lo(xh,xl){var r=rotr64_lo(xh,xl,28)^rotr64_lo(xl,xh,2)^rotr64_lo(xl,xh,7);return r<0&&(r+=4294967296),r}function s1_512_hi(xh,xl){var r=rotr64_hi(xh,xl,14)^rotr64_hi(xh,xl,18)^rotr64_hi(xl,xh,9);return r<0&&(r+=4294967296),r}function s1_512_lo(xh,xl){var r=rotr64_lo(xh,xl,14)^rotr64_lo(xh,xl,18)^rotr64_lo(xl,xh,9);return r<0&&(r+=4294967296),r}function g0_512_hi(xh,xl){var r=rotr64_hi(xh,xl,1)^rotr64_hi(xh,xl,8)^shr64_hi(xh,xl,7);return r<0&&(r+=4294967296),r}function g0_512_lo(xh,xl){var r=rotr64_lo(xh,xl,1)^rotr64_lo(xh,xl,8)^shr64_lo(xh,xl,7);return r<0&&(r+=4294967296),r}function g1_512_hi(xh,xl){var r=rotr64_hi(xh,xl,19)^rotr64_hi(xl,xh,29)^shr64_hi(xh,xl,6);return r<0&&(r+=4294967296),r}function g1_512_lo(xh,xl){var r=rotr64_lo(xh,xl,19)^rotr64_lo(xl,xh,29)^shr64_lo(xh,xl,6);return r<0&&(r+=4294967296),r}utils.inherits(SHA512,BlockHash),module.exports=SHA512,SHA512.blockSize=1024,SHA512.outSize=512,SHA512.hmacStrength=192,SHA512.padLength=128,SHA512.prototype._prepareBlock=function(msg,start){for(var W=this.W,i=0;i<32;i++)W[i]=msg[start+i];for(;i<W.length;i+=2){var c0_hi=g1_512_hi(W[i-4],W[i-3]),c0_lo=g1_512_lo(W[i-4],W[i-3]),c1_hi=W[i-14],c1_lo=W[i-13],c2_hi=g0_512_hi(W[i-30],W[i-29]),c2_lo=g0_512_lo(W[i-30],W[i-29]),c3_hi=W[i-32],c3_lo=W[i-31];W[i]=sum64_4_hi(c0_hi,c0_lo,c1_hi,c1_lo,c2_hi,c2_lo,c3_hi,c3_lo),W[i+1]=sum64_4_lo(c0_hi,c0_lo,c1_hi,c1_lo,c2_hi,c2_lo,c3_hi,c3_lo)}},SHA512.prototype._update=function(msg,start){this._prepareBlock(msg,start);var W=this.W,ah=this.h[0],al=this.h[1],bh=this.h[2],bl=this.h[3],ch=this.h[4],cl=this.h[5],dh=this.h[6],dl=this.h[7],eh=this.h[8],el=this.h[9],fh=this.h[10],fl=this.h[11],gh=this.h[12],gl=this.h[13],hh=this.h[14],hl=this.h[15];assert(this.k.length===W.length);for(var i=0;i<W.length;i+=2){var c0_hi=hh,c0_lo=hl,c1_hi=s1_512_hi(eh,el),c1_lo=s1_512_lo(eh,el),c2_hi=ch64_hi(eh,el,fh,fl,gh),c2_lo=ch64_lo(eh,el,fh,fl,gh,gl),c3_hi=this.k[i],c3_lo=this.k[i+1],c4_hi=W[i],c4_lo=W[i+1],T1_hi=sum64_5_hi(c0_hi,c0_lo,c1_hi,c1_lo,c2_hi,c2_lo,c3_hi,c3_lo,c4_hi,c4_lo),T1_lo=sum64_5_lo(c0_hi,c0_lo,c1_hi,c1_lo,c2_hi,c2_lo,c3_hi,c3_lo,c4_hi,c4_lo);c0_hi=s0_512_hi(ah,al),c0_lo=s0_512_lo(ah,al),c1_hi=maj64_hi(ah,al,bh,bl,ch),c1_lo=maj64_lo(ah,al,bh,bl,ch,cl);var T2_hi=sum64_hi(c0_hi,c0_lo,c1_hi,c1_lo),T2_lo=sum64_lo(c0_hi,c0_lo,c1_hi,c1_lo);hh=gh,hl=gl,gh=fh,gl=fl,fh=eh,fl=el,eh=sum64_hi(dh,dl,T1_hi,T1_lo),el=sum64_lo(dl,dl,T1_hi,T1_lo),dh=ch,dl=cl,ch=bh,cl=bl,bh=ah,bl=al,ah=sum64_hi(T1_hi,T1_lo,T2_hi,T2_lo),al=sum64_lo(T1_hi,T1_lo,T2_hi,T2_lo)}sum64(this.h,0,ah,al),sum64(this.h,2,bh,bl),sum64(this.h,4,ch,cl),sum64(this.h,6,dh,dl),sum64(this.h,8,eh,el),sum64(this.h,10,fh,fl),sum64(this.h,12,gh,gl),sum64(this.h,14,hh,hl)},SHA512.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h,"big"):utils.split32(this.h,"big")}},function(module,exports,__webpack_require__){var inherits=__webpack_require__(1),Reporter=__webpack_require__(26).Reporter,Buffer=__webpack_require__(5).Buffer;function DecoderBuffer(base,options){Reporter.call(this,options),Buffer.isBuffer(base)?(this.base=base,this.offset=0,this.length=base.length):this.error("Input not Buffer")}function EncoderBuffer(value,reporter){if(Array.isArray(value))this.length=0,this.value=value.map((function(item){return item instanceof EncoderBuffer||(item=new EncoderBuffer(item,reporter)),this.length+=item.length,item}),this);else if("number"==typeof value){if(!(0<=value&&value<=255))return reporter.error("non-byte EncoderBuffer value");this.value=value,this.length=1}else if("string"==typeof value)this.value=value,this.length=Buffer.byteLength(value);else{if(!Buffer.isBuffer(value))return reporter.error("Unsupported type: "+typeof value);this.value=value,this.length=value.length}}inherits(DecoderBuffer,Reporter),exports.DecoderBuffer=DecoderBuffer,DecoderBuffer.prototype.save=function(){return{offset:this.offset,reporter:Reporter.prototype.save.call(this)}},DecoderBuffer.prototype.restore=function(save){var res=new DecoderBuffer(this.base);return res.offset=save.offset,res.length=this.offset,this.offset=save.offset,Reporter.prototype.restore.call(this,save.reporter),res},DecoderBuffer.prototype.isEmpty=function(){return this.offset===this.length},DecoderBuffer.prototype.readUInt8=function(fail){return this.offset+1<=this.length?this.base.readUInt8(this.offset++,!0):this.error(fail||"DecoderBuffer overrun")},DecoderBuffer.prototype.skip=function(bytes,fail){if(!(this.offset+bytes<=this.length))return this.error(fail||"DecoderBuffer overrun");var res=new DecoderBuffer(this.base);return res._reporterState=this._reporterState,res.offset=this.offset,res.length=this.offset+bytes,this.offset+=bytes,res},DecoderBuffer.prototype.raw=function(save){return this.base.slice(save?save.offset:this.offset,this.length)},exports.EncoderBuffer=EncoderBuffer,EncoderBuffer.prototype.join=function(out,offset){return out||(out=new Buffer(this.length)),offset||(offset=0),0===this.length?out:(Array.isArray(this.value)?this.value.forEach((function(item){item.join(out,offset),offset+=item.length})):("number"==typeof this.value?out[offset]=this.value:"string"==typeof this.value?out.write(this.value,offset):Buffer.isBuffer(this.value)&&this.value.copy(out,offset),offset+=this.length),out)}},function(module,exports,__webpack_require__){var constants=exports;constants._reverse=function(map){var res={};return Object.keys(map).forEach((function(key){(0|key)==key&&(key|=0);var value=map[key];res[value]=key})),res},constants.der=__webpack_require__(180)},function(module,exports,__webpack_require__){var inherits=__webpack_require__(1),asn1=__webpack_require__(25),base=asn1.base,bignum=asn1.bignum,der=asn1.constants.der;function DERDecoder(entity){this.enc="der",this.name=entity.name,this.entity=entity,this.tree=new DERNode,this.tree._init(entity.body)}function DERNode(parent){base.Node.call(this,"der",parent)}function derDecodeTag(buf,fail){var tag=buf.readUInt8(fail);if(buf.isError(tag))return tag;var cls=der.tagClass[tag>>6],primitive=0==(32&tag);if(31==(31&tag)){var oct=tag;for(tag=0;128==(128&oct);){if(oct=buf.readUInt8(fail),buf.isError(oct))return oct;tag<<=7,tag|=127&oct}}else tag&=31;return{cls:cls,primitive:primitive,tag:tag,tagStr:der.tag[tag]}}function derDecodeLen(buf,primitive,fail){var len=buf.readUInt8(fail);if(buf.isError(len))return len;if(!primitive&&128===len)return null;if(0==(128&len))return len;var num=127&len;if(num>4)return buf.error("length octect is too long");len=0;for(var i=0;i<num;i++){len<<=8;var j=buf.readUInt8(fail);if(buf.isError(j))return j;len|=j}return len}module.exports=DERDecoder,DERDecoder.prototype.decode=function(data,options){return data instanceof base.DecoderBuffer||(data=new base.DecoderBuffer(data,options)),this.tree._decode(data,options)},inherits(DERNode,base.Node),DERNode.prototype._peekTag=function(buffer,tag,any){if(buffer.isEmpty())return!1;var state=buffer.save(),decodedTag=derDecodeTag(buffer,'Failed to peek tag: "'+tag+'"');return buffer.isError(decodedTag)?decodedTag:(buffer.restore(state),decodedTag.tag===tag||decodedTag.tagStr===tag||decodedTag.tagStr+"of"===tag||any)},DERNode.prototype._decodeTag=function(buffer,tag,any){var decodedTag=derDecodeTag(buffer,'Failed to decode tag of "'+tag+'"');if(buffer.isError(decodedTag))return decodedTag;var len=derDecodeLen(buffer,decodedTag.primitive,'Failed to get length of "'+tag+'"');if(buffer.isError(len))return len;if(!any&&decodedTag.tag!==tag&&decodedTag.tagStr!==tag&&decodedTag.tagStr+"of"!==tag)return buffer.error('Failed to match tag: "'+tag+'"');if(decodedTag.primitive||null!==len)return buffer.skip(len,'Failed to match body of: "'+tag+'"');var state=buffer.save(),res=this._skipUntilEnd(buffer,'Failed to skip indefinite length body: "'+this.tag+'"');return buffer.isError(res)?res:(len=buffer.offset-state.offset,buffer.restore(state),buffer.skip(len,'Failed to match body of: "'+tag+'"'))},DERNode.prototype._skipUntilEnd=function(buffer,fail){for(;;){var tag=derDecodeTag(buffer,fail);if(buffer.isError(tag))return tag;var res,len=derDecodeLen(buffer,tag.primitive,fail);if(buffer.isError(len))return len;if(res=tag.primitive||null!==len?buffer.skip(len):this._skipUntilEnd(buffer,fail),buffer.isError(res))return res;if("end"===tag.tagStr)break}},DERNode.prototype._decodeList=function(buffer,tag,decoder,options){for(var result=[];!buffer.isEmpty();){var possibleEnd=this._peekTag(buffer,"end");if(buffer.isError(possibleEnd))return possibleEnd;var res=decoder.decode(buffer,"der",options);if(buffer.isError(res)&&possibleEnd)break;result.push(res)}return result},DERNode.prototype._decodeStr=function(buffer,tag){if("bitstr"===tag){var unused=buffer.readUInt8();return buffer.isError(unused)?unused:{unused:unused,data:buffer.raw()}}if("bmpstr"===tag){var raw=buffer.raw();if(raw.length%2==1)return buffer.error("Decoding of string type: bmpstr length mismatch");for(var str="",i=0;i<raw.length/2;i++)str+=String.fromCharCode(raw.readUInt16BE(2*i));return str}if("numstr"===tag){var numstr=buffer.raw().toString("ascii");return this._isNumstr(numstr)?numstr:buffer.error("Decoding of string type: numstr unsupported characters")}if("octstr"===tag)return buffer.raw();if("objDesc"===tag)return buffer.raw();if("printstr"===tag){var printstr=buffer.raw().toString("ascii");return this._isPrintstr(printstr)?printstr:buffer.error("Decoding of string type: printstr unsupported characters")}return/str$/.test(tag)?buffer.raw().toString():buffer.error("Decoding of string type: "+tag+" unsupported")},DERNode.prototype._decodeObjid=function(buffer,values,relative){for(var result,identifiers=[],ident=0;!buffer.isEmpty();){var subident=buffer.readUInt8();ident<<=7,ident|=127&subident,0==(128&subident)&&(identifiers.push(ident),ident=0)}128&subident&&identifiers.push(ident);var first=identifiers[0]/40|0,second=identifiers[0]%40;if(result=relative?identifiers:[first,second].concat(identifiers.slice(1)),values){var tmp=values[result.join(" ")];void 0===tmp&&(tmp=values[result.join(".")]),void 0!==tmp&&(result=tmp)}return result},DERNode.prototype._decodeTime=function(buffer,tag){var str=buffer.raw().toString();if("gentime"===tag)var year=0|str.slice(0,4),mon=0|str.slice(4,6),day=0|str.slice(6,8),hour=0|str.slice(8,10),min=0|str.slice(10,12),sec=0|str.slice(12,14);else{if("utctime"!==tag)return buffer.error("Decoding "+tag+" time is not supported yet");year=0|str.slice(0,2),mon=0|str.slice(2,4),day=0|str.slice(4,6),hour=0|str.slice(6,8),min=0|str.slice(8,10),sec=0|str.slice(10,12);year=year<70?2e3+year:1900+year}return Date.UTC(year,mon-1,day,hour,min,sec,0)},DERNode.prototype._decodeNull=function(buffer){return null},DERNode.prototype._decodeBool=function(buffer){var res=buffer.readUInt8();return buffer.isError(res)?res:0!==res},DERNode.prototype._decodeInt=function(buffer,values){var raw=buffer.raw(),res=new bignum(raw);return values&&(res=values[res.toString(10)]||res),res},DERNode.prototype._use=function(entity,obj){return"function"==typeof entity&&(entity=entity(obj)),entity._getDecoder("der").tree}},function(module,exports,__webpack_require__){var inherits=__webpack_require__(1),Buffer=__webpack_require__(5).Buffer,asn1=__webpack_require__(25),base=asn1.base,der=asn1.constants.der;function DEREncoder(entity){this.enc="der",this.name=entity.name,this.entity=entity,this.tree=new DERNode,this.tree._init(entity.body)}function DERNode(parent){base.Node.call(this,"der",parent)}function two(num){return num<10?"0"+num:num}module.exports=DEREncoder,DEREncoder.prototype.encode=function(data,reporter){return this.tree._encode(data,reporter).join()},inherits(DERNode,base.Node),DERNode.prototype._encodeComposite=function(tag,primitive,cls,content){var header,encodedTag=function(tag,primitive,cls,reporter){var res;"seqof"===tag?tag="seq":"setof"===tag&&(tag="set");if(der.tagByName.hasOwnProperty(tag))res=der.tagByName[tag];else{if("number"!=typeof tag||(0|tag)!==tag)return reporter.error("Unknown tag: "+tag);res=tag}if(res>=31)return reporter.error("Multi-octet tag encoding unsupported");primitive||(res|=32);return res|=der.tagClassByName[cls||"universal"]<<6}(tag,primitive,cls,this.reporter);if(content.length<128)return(header=new Buffer(2))[0]=encodedTag,header[1]=content.length,this._createEncoderBuffer([header,content]);for(var lenOctets=1,i=content.length;i>=256;i>>=8)lenOctets++;(header=new Buffer(2+lenOctets))[0]=encodedTag,header[1]=128|lenOctets;i=1+lenOctets;for(var j=content.length;j>0;i--,j>>=8)header[i]=255&j;return this._createEncoderBuffer([header,content])},DERNode.prototype._encodeStr=function(str,tag){if("bitstr"===tag)return this._createEncoderBuffer([0|str.unused,str.data]);if("bmpstr"===tag){for(var buf=new Buffer(2*str.length),i=0;i<str.length;i++)buf.writeUInt16BE(str.charCodeAt(i),2*i);return this._createEncoderBuffer(buf)}return"numstr"===tag?this._isNumstr(str)?this._createEncoderBuffer(str):this.reporter.error("Encoding of string type: numstr supports only digits and space"):"printstr"===tag?this._isPrintstr(str)?this._createEncoderBuffer(str):this.reporter.error("Encoding of string type: printstr supports only latin upper and lower case letters, digits, space, apostrophe, left and rigth parenthesis, plus sign, comma, hyphen, dot, slash, colon, equal sign, question mark"):/str$/.test(tag)?this._createEncoderBuffer(str):"objDesc"===tag?this._createEncoderBuffer(str):this.reporter.error("Encoding of string type: "+tag+" unsupported")},DERNode.prototype._encodeObjid=function(id,values,relative){if("string"==typeof id){if(!values)return this.reporter.error("string objid given, but no values map found");if(!values.hasOwnProperty(id))return this.reporter.error("objid not found in values map");id=values[id].split(/[\s\.]+/g);for(var i=0;i<id.length;i++)id[i]|=0}else if(Array.isArray(id)){id=id.slice();for(i=0;i<id.length;i++)id[i]|=0}if(!Array.isArray(id))return this.reporter.error("objid() should be either array or string, got: "+JSON.stringify(id));if(!relative){if(id[1]>=40)return this.reporter.error("Second objid identifier OOB");id.splice(0,2,40*id[0]+id[1])}var size=0;for(i=0;i<id.length;i++){var ident=id[i];for(size++;ident>=128;ident>>=7)size++}var objid=new Buffer(size),offset=objid.length-1;for(i=id.length-1;i>=0;i--){ident=id[i];for(objid[offset--]=127&ident;(ident>>=7)>0;)objid[offset--]=128|127&ident}return this._createEncoderBuffer(objid)},DERNode.prototype._encodeTime=function(time,tag){var str,date=new Date(time);return"gentime"===tag?str=[two(date.getFullYear()),two(date.getUTCMonth()+1),two(date.getUTCDate()),two(date.getUTCHours()),two(date.getUTCMinutes()),two(date.getUTCSeconds()),"Z"].join(""):"utctime"===tag?str=[two(date.getFullYear()%100),two(date.getUTCMonth()+1),two(date.getUTCDate()),two(date.getUTCHours()),two(date.getUTCMinutes()),two(date.getUTCSeconds()),"Z"].join(""):this.reporter.error("Encoding "+tag+" time is not supported yet"),this._encodeStr(str,"octstr")},DERNode.prototype._encodeNull=function(){return this._createEncoderBuffer("")},DERNode.prototype._encodeInt=function(num,values){if("string"==typeof num){if(!values)return this.reporter.error("String int or enum given, but no values map");if(!values.hasOwnProperty(num))return this.reporter.error("Values map doesn't contain: "+JSON.stringify(num));num=values[num]}if("number"!=typeof num&&!Buffer.isBuffer(num)){var numArray=num.toArray();!num.sign&&128&numArray[0]&&numArray.unshift(0),num=new Buffer(numArray)}if(Buffer.isBuffer(num)){var size=num.length;0===num.length&&size++;var out=new Buffer(size);return num.copy(out),0===num.length&&(out[0]=0),this._createEncoderBuffer(out)}if(num<128)return this._createEncoderBuffer(num);if(num<256)return this._createEncoderBuffer([0,num]);size=1;for(var i=num;i>=256;i>>=8)size++;for(i=(out=new Array(size)).length-1;i>=0;i--)out[i]=255&num,num>>=8;return 128&out[0]&&out.unshift(0),this._createEncoderBuffer(new Buffer(out))},DERNode.prototype._encodeBool=function(value){return this._createEncoderBuffer(value?255:0)},DERNode.prototype._use=function(entity,obj){return"function"==typeof entity&&(entity=entity(obj)),entity._getEncoder("der").tree},DERNode.prototype._skipDefault=function(dataBuffer,reporter,parent){var i,state=this._baseState;if(null===state.default)return!1;var data=dataBuffer.join();if(void 0===state.defaultBuffer&&(state.defaultBuffer=this._encodeValue(state.default,reporter,parent).join()),data.length!==state.defaultBuffer.length)return!1;for(i=0;i<data.length;i++)if(data[i]!==state.defaultBuffer[i])return!1;return!0}},function(module){module.exports=JSON.parse('{"1.3.132.0.10":"secp256k1","1.3.132.0.33":"p224","1.2.840.10045.3.1.1":"p192","1.2.840.10045.3.1.7":"p256","1.3.132.0.34":"p384","1.3.132.0.35":"p521"}')},function(module,exports,__webpack_require__){(function(Buffer){var createHash=__webpack_require__(21);function i2ops(c){var out=new Buffer(4);return out.writeUInt32BE(c,0),out}module.exports=function(seed,len){for(var c,t=new Buffer(""),i=0;t.length<len;)c=i2ops(i++),t=Buffer.concat([t,createHash("sha1").update(seed).update(c).digest()]);return t.slice(0,len)}}).call(this,__webpack_require__(5).Buffer)},function(module,exports){module.exports=function(a,b){for(var len=a.length,i=-1;++i<len;)a[i]^=b[i];return a}},function(module,exports,__webpack_require__){(function(Buffer){var bn=__webpack_require__(6);module.exports=function(paddedMsg,key){return new Buffer(paddedMsg.toRed(bn.mont(key.modulus)).redPow(new bn(key.publicExponent)).fromRed().toArray())}}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return function(Math){var C=CryptoJS,C_lib=C.lib,WordArray=C_lib.WordArray,Hasher=C_lib.Hasher,C_algo=C.algo,H=[],K=[];!function(){function isPrime(n){for(var sqrtN=Math.sqrt(n),factor=2;factor<=sqrtN;factor++)if(!(n%factor))return!1;return!0}function getFractionalBits(n){return 4294967296*(n-(0|n))|0}for(var n=2,nPrime=0;nPrime<64;)isPrime(n)&&(nPrime<8&&(H[nPrime]=getFractionalBits(Math.pow(n,.5))),K[nPrime]=getFractionalBits(Math.pow(n,1/3)),nPrime++),n++}();var W=[],SHA256=C_algo.SHA256=Hasher.extend({_doReset:function(){this._hash=new WordArray.init(H.slice(0))},_doProcessBlock:function(M,offset){for(var H=this._hash.words,a=H[0],b=H[1],c=H[2],d=H[3],e=H[4],f=H[5],g=H[6],h=H[7],i=0;i<64;i++){if(i<16)W[i]=0|M[offset+i];else{var gamma0x=W[i-15],gamma0=(gamma0x<<25|gamma0x>>>7)^(gamma0x<<14|gamma0x>>>18)^gamma0x>>>3,gamma1x=W[i-2],gamma1=(gamma1x<<15|gamma1x>>>17)^(gamma1x<<13|gamma1x>>>19)^gamma1x>>>10;W[i]=gamma0+W[i-7]+gamma1+W[i-16]}var maj=a&b^a&c^b&c,sigma0=(a<<30|a>>>2)^(a<<19|a>>>13)^(a<<10|a>>>22),t1=h+((e<<26|e>>>6)^(e<<21|e>>>11)^(e<<7|e>>>25))+(e&f^~e&g)+K[i]+W[i];h=g,g=f,f=e,e=d+t1|0,d=c,c=b,b=a,a=t1+(sigma0+maj)|0}H[0]=H[0]+a|0,H[1]=H[1]+b|0,H[2]=H[2]+c|0,H[3]=H[3]+d|0,H[4]=H[4]+e|0,H[5]=H[5]+f|0,H[6]=H[6]+g|0,H[7]=H[7]+h|0},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsTotal=8*this._nDataBytes,nBitsLeft=8*data.sigBytes;return dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32,dataWords[14+(nBitsLeft+64>>>9<<4)]=Math.floor(nBitsTotal/4294967296),dataWords[15+(nBitsLeft+64>>>9<<4)]=nBitsTotal,data.sigBytes=4*dataWords.length,this._process(),this._hash},clone:function(){var clone=Hasher.clone.call(this);return clone._hash=this._hash.clone(),clone}});C.SHA256=Hasher._createHelper(SHA256),C.HmacSHA256=Hasher._createHmacHelper(SHA256)}(Math),CryptoJS.SHA256}(__webpack_require__(2))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return function(){var C=CryptoJS,Hasher=C.lib.Hasher,C_x64=C.x64,X64Word=C_x64.Word,X64WordArray=C_x64.WordArray,C_algo=C.algo;function X64Word_create(){return X64Word.create.apply(X64Word,arguments)}var K=[X64Word_create(1116352408,3609767458),X64Word_create(1899447441,602891725),X64Word_create(3049323471,3964484399),X64Word_create(3921009573,2173295548),X64Word_create(961987163,4081628472),X64Word_create(1508970993,3053834265),X64Word_create(2453635748,2937671579),X64Word_create(2870763221,3664609560),X64Word_create(3624381080,2734883394),X64Word_create(310598401,1164996542),X64Word_create(607225278,1323610764),X64Word_create(1426881987,3590304994),X64Word_create(1925078388,4068182383),X64Word_create(2162078206,991336113),X64Word_create(2614888103,633803317),X64Word_create(3248222580,3479774868),X64Word_create(3835390401,2666613458),X64Word_create(4022224774,944711139),X64Word_create(264347078,2341262773),X64Word_create(604807628,2007800933),X64Word_create(770255983,1495990901),X64Word_create(1249150122,1856431235),X64Word_create(1555081692,3175218132),X64Word_create(1996064986,2198950837),X64Word_create(2554220882,3999719339),X64Word_create(2821834349,766784016),X64Word_create(2952996808,2566594879),X64Word_create(3210313671,3203337956),X64Word_create(3336571891,1034457026),X64Word_create(3584528711,2466948901),X64Word_create(113926993,3758326383),X64Word_create(338241895,168717936),X64Word_create(666307205,1188179964),X64Word_create(773529912,1546045734),X64Word_create(1294757372,1522805485),X64Word_create(1396182291,2643833823),X64Word_create(1695183700,2343527390),X64Word_create(1986661051,1014477480),X64Word_create(2177026350,1206759142),X64Word_create(2456956037,344077627),X64Word_create(2730485921,1290863460),X64Word_create(2820302411,3158454273),X64Word_create(3259730800,3505952657),X64Word_create(3345764771,106217008),X64Word_create(3516065817,3606008344),X64Word_create(3600352804,1432725776),X64Word_create(4094571909,1467031594),X64Word_create(275423344,851169720),X64Word_create(430227734,3100823752),X64Word_create(506948616,1363258195),X64Word_create(659060556,3750685593),X64Word_create(883997877,3785050280),X64Word_create(958139571,3318307427),X64Word_create(1322822218,3812723403),X64Word_create(1537002063,2003034995),X64Word_create(1747873779,3602036899),X64Word_create(1955562222,1575990012),X64Word_create(2024104815,1125592928),X64Word_create(2227730452,2716904306),X64Word_create(2361852424,442776044),X64Word_create(2428436474,593698344),X64Word_create(2756734187,3733110249),X64Word_create(3204031479,2999351573),X64Word_create(3329325298,3815920427),X64Word_create(3391569614,3928383900),X64Word_create(3515267271,566280711),X64Word_create(3940187606,3454069534),X64Word_create(4118630271,4000239992),X64Word_create(116418474,1914138554),X64Word_create(174292421,2731055270),X64Word_create(289380356,3203993006),X64Word_create(460393269,320620315),X64Word_create(685471733,587496836),X64Word_create(852142971,1086792851),X64Word_create(1017036298,365543100),X64Word_create(1126000580,2618297676),X64Word_create(1288033470,3409855158),X64Word_create(1501505948,4234509866),X64Word_create(1607167915,987167468),X64Word_create(1816402316,1246189591)],W=[];!function(){for(var i=0;i<80;i++)W[i]=X64Word_create()}();var SHA512=C_algo.SHA512=Hasher.extend({_doReset:function(){this._hash=new X64WordArray.init([new X64Word.init(1779033703,4089235720),new X64Word.init(3144134277,2227873595),new X64Word.init(1013904242,4271175723),new X64Word.init(2773480762,1595750129),new X64Word.init(1359893119,2917565137),new X64Word.init(2600822924,725511199),new X64Word.init(528734635,4215389547),new X64Word.init(1541459225,327033209)])},_doProcessBlock:function(M,offset){for(var H=this._hash.words,H0=H[0],H1=H[1],H2=H[2],H3=H[3],H4=H[4],H5=H[5],H6=H[6],H7=H[7],H0h=H0.high,H0l=H0.low,H1h=H1.high,H1l=H1.low,H2h=H2.high,H2l=H2.low,H3h=H3.high,H3l=H3.low,H4h=H4.high,H4l=H4.low,H5h=H5.high,H5l=H5.low,H6h=H6.high,H6l=H6.low,H7h=H7.high,H7l=H7.low,ah=H0h,al=H0l,bh=H1h,bl=H1l,ch=H2h,cl=H2l,dh=H3h,dl=H3l,eh=H4h,el=H4l,fh=H5h,fl=H5l,gh=H6h,gl=H6l,hh=H7h,hl=H7l,i=0;i<80;i++){var Wil,Wih,Wi=W[i];if(i<16)Wih=Wi.high=0|M[offset+2*i],Wil=Wi.low=0|M[offset+2*i+1];else{var gamma0x=W[i-15],gamma0xh=gamma0x.high,gamma0xl=gamma0x.low,gamma0h=(gamma0xh>>>1|gamma0xl<<31)^(gamma0xh>>>8|gamma0xl<<24)^gamma0xh>>>7,gamma0l=(gamma0xl>>>1|gamma0xh<<31)^(gamma0xl>>>8|gamma0xh<<24)^(gamma0xl>>>7|gamma0xh<<25),gamma1x=W[i-2],gamma1xh=gamma1x.high,gamma1xl=gamma1x.low,gamma1h=(gamma1xh>>>19|gamma1xl<<13)^(gamma1xh<<3|gamma1xl>>>29)^gamma1xh>>>6,gamma1l=(gamma1xl>>>19|gamma1xh<<13)^(gamma1xl<<3|gamma1xh>>>29)^(gamma1xl>>>6|gamma1xh<<26),Wi7=W[i-7],Wi7h=Wi7.high,Wi7l=Wi7.low,Wi16=W[i-16],Wi16h=Wi16.high,Wi16l=Wi16.low;Wih=(Wih=(Wih=gamma0h+Wi7h+((Wil=gamma0l+Wi7l)>>>0<gamma0l>>>0?1:0))+gamma1h+((Wil+=gamma1l)>>>0<gamma1l>>>0?1:0))+Wi16h+((Wil+=Wi16l)>>>0<Wi16l>>>0?1:0),Wi.high=Wih,Wi.low=Wil}var t1l,chh=eh&fh^~eh&gh,chl=el&fl^~el&gl,majh=ah&bh^ah&ch^bh&ch,majl=al&bl^al&cl^bl&cl,sigma0h=(ah>>>28|al<<4)^(ah<<30|al>>>2)^(ah<<25|al>>>7),sigma0l=(al>>>28|ah<<4)^(al<<30|ah>>>2)^(al<<25|ah>>>7),sigma1h=(eh>>>14|el<<18)^(eh>>>18|el<<14)^(eh<<23|el>>>9),sigma1l=(el>>>14|eh<<18)^(el>>>18|eh<<14)^(el<<23|eh>>>9),Ki=K[i],Kih=Ki.high,Kil=Ki.low,t1h=hh+sigma1h+((t1l=hl+sigma1l)>>>0<hl>>>0?1:0),t2l=sigma0l+majl;hh=gh,hl=gl,gh=fh,gl=fl,fh=eh,fl=el,eh=dh+(t1h=(t1h=(t1h=t1h+chh+((t1l+=chl)>>>0<chl>>>0?1:0))+Kih+((t1l+=Kil)>>>0<Kil>>>0?1:0))+Wih+((t1l+=Wil)>>>0<Wil>>>0?1:0))+((el=dl+t1l|0)>>>0<dl>>>0?1:0)|0,dh=ch,dl=cl,ch=bh,cl=bl,bh=ah,bl=al,ah=t1h+(sigma0h+majh+(t2l>>>0<sigma0l>>>0?1:0))+((al=t1l+t2l|0)>>>0<t1l>>>0?1:0)|0}H0l=H0.low=H0l+al,H0.high=H0h+ah+(H0l>>>0<al>>>0?1:0),H1l=H1.low=H1l+bl,H1.high=H1h+bh+(H1l>>>0<bl>>>0?1:0),H2l=H2.low=H2l+cl,H2.high=H2h+ch+(H2l>>>0<cl>>>0?1:0),H3l=H3.low=H3l+dl,H3.high=H3h+dh+(H3l>>>0<dl>>>0?1:0),H4l=H4.low=H4l+el,H4.high=H4h+eh+(H4l>>>0<el>>>0?1:0),H5l=H5.low=H5l+fl,H5.high=H5h+fh+(H5l>>>0<fl>>>0?1:0),H6l=H6.low=H6l+gl,H6.high=H6h+gh+(H6l>>>0<gl>>>0?1:0),H7l=H7.low=H7l+hl,H7.high=H7h+hh+(H7l>>>0<hl>>>0?1:0)},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsTotal=8*this._nDataBytes,nBitsLeft=8*data.sigBytes;return dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32,dataWords[30+(nBitsLeft+128>>>10<<5)]=Math.floor(nBitsTotal/4294967296),dataWords[31+(nBitsLeft+128>>>10<<5)]=nBitsTotal,data.sigBytes=4*dataWords.length,this._process(),this._hash.toX32()},clone:function(){var clone=Hasher.clone.call(this);return clone._hash=this._hash.clone(),clone},blockSize:32});C.SHA512=Hasher._createHelper(SHA512),C.HmacSHA512=Hasher._createHmacHelper(SHA512)}(),CryptoJS.SHA512}(__webpack_require__(2),__webpack_require__(33))},function(module,exports,__webpack_require__){(function(Buffer){!function(exports){var storage,UNDEFINED="undefined",BUFFER=UNDEFINED!==typeof Buffer&&Buffer,UINT8ARRAY=UNDEFINED!==typeof Uint8Array&&Uint8Array,ARRAYBUFFER=UNDEFINED!==typeof ArrayBuffer&&ArrayBuffer,ZERO=[0,0,0,0,0,0,0,0],isArray=Array.isArray||function(val){return!!val&&"[object Array]"==Object.prototype.toString.call(val)},BIT32=4294967296,BIT24=16777216;function factory(name,bigendian,unsigned){var posH=bigendian?0:4,posL=bigendian?4:0,pos0=bigendian?0:3,pos1=bigendian?1:2,pos2=bigendian?2:1,pos3=bigendian?3:0,fromPositive=bigendian?fromPositiveBE:fromPositiveLE,fromNegative=bigendian?fromNegativeBE:fromNegativeLE,proto=Int64.prototype,isName="is"+name,_isInt64="_"+isName;return proto.buffer=void 0,proto.offset=0,proto[_isInt64]=!0,proto.toNumber=toNumber,proto.toString=function(radix){var buffer=this.buffer,offset=this.offset,high=readInt32(buffer,offset+posH),low=readInt32(buffer,offset+posL),str="",sign=!unsigned&&2147483648&high;sign&&(high=~high,low=BIT32-low);radix=radix||10;for(;;){var mod=high%radix*BIT32+low;if(high=Math.floor(high/radix),low=Math.floor(mod/radix),str=(mod%radix).toString(radix)+str,!high&&!low)break}sign&&(str="-"+str);return str},proto.toJSON=toNumber,proto.toArray=toArray,BUFFER&&(proto.toBuffer=toBuffer),UINT8ARRAY&&(proto.toArrayBuffer=toArrayBuffer),Int64[isName]=function(b){return!(!b||!b[_isInt64])},exports[name]=Int64,Int64;function Int64(buffer,offset,value,raddix){return this instanceof Int64?function(that,buffer,offset,value,raddix){UINT8ARRAY&&ARRAYBUFFER&&(buffer instanceof ARRAYBUFFER&&(buffer=new UINT8ARRAY(buffer)),value instanceof ARRAYBUFFER&&(value=new UINT8ARRAY(value)));if(!(buffer||offset||value||storage))return void(that.buffer=newArray(ZERO,0));if(!isValidBuffer(buffer,offset)){raddix=offset,value=buffer,offset=0,buffer=new(storage||Array)(8)}if(that.buffer=buffer,that.offset=offset|=0,UNDEFINED===typeof value)return;"string"==typeof value?function(buffer,offset,str,raddix){var pos=0,len=str.length,high=0,low=0;"-"===str[0]&&pos++;var sign=pos;for(;pos<len;){var chr=parseInt(str[pos++],raddix);if(!(chr>=0))break;low=low*raddix+chr,high=high*raddix+Math.floor(low/BIT32),low%=BIT32}sign&&(high=~high,low?low=BIT32-low:high++);writeInt32(buffer,offset+posH,high),writeInt32(buffer,offset+posL,low)}(buffer,offset,value,raddix||10):isValidBuffer(value,raddix)?fromArray(buffer,offset,value,raddix):"number"==typeof raddix?(writeInt32(buffer,offset+posH,value),writeInt32(buffer,offset+posL,raddix)):value>0?fromPositive(buffer,offset,value):value<0?fromNegative(buffer,offset,value):fromArray(buffer,offset,ZERO,0)}(this,buffer,offset,value,raddix):new Int64(buffer,offset,value,raddix)}function toNumber(){var buffer=this.buffer,offset=this.offset,high=readInt32(buffer,offset+posH),low=readInt32(buffer,offset+posL);return unsigned||(high|=0),high?high*BIT32+low:low}function writeInt32(buffer,offset,value){buffer[offset+pos3]=255&value,value>>=8,buffer[offset+pos2]=255&value,value>>=8,buffer[offset+pos1]=255&value,value>>=8,buffer[offset+pos0]=255&value}function readInt32(buffer,offset){return buffer[offset+pos0]*BIT24+(buffer[offset+pos1]<<16)+(buffer[offset+pos2]<<8)+buffer[offset+pos3]}}function toArray(raw){var buffer=this.buffer,offset=this.offset;return storage=null,!1!==raw&&0===offset&&8===buffer.length&&isArray(buffer)?buffer:newArray(buffer,offset)}function toBuffer(raw){var buffer=this.buffer,offset=this.offset;if(storage=BUFFER,!1!==raw&&0===offset&&8===buffer.length&&Buffer.isBuffer(buffer))return buffer;var dest=new BUFFER(8);return fromArray(dest,0,buffer,offset),dest}function toArrayBuffer(raw){var buffer=this.buffer,offset=this.offset,arrbuf=buffer.buffer;if(storage=UINT8ARRAY,!1!==raw&&0===offset&&arrbuf instanceof ARRAYBUFFER&&8===arrbuf.byteLength)return arrbuf;var dest=new UINT8ARRAY(8);return fromArray(dest,0,buffer,offset),dest.buffer}function isValidBuffer(buffer,offset){var len=buffer&&buffer.length;return offset|=0,len&&offset+8<=len&&"string"!=typeof buffer[offset]}function fromArray(destbuf,destoff,srcbuf,srcoff){destoff|=0,srcoff|=0;for(var i=0;i<8;i++)destbuf[destoff++]=255&srcbuf[srcoff++]}function newArray(buffer,offset){return Array.prototype.slice.call(buffer,offset,offset+8)}function fromPositiveBE(buffer,offset,value){for(var pos=offset+8;pos>offset;)buffer[--pos]=255&value,value/=256}function fromNegativeBE(buffer,offset,value){var pos=offset+8;for(value++;pos>offset;)buffer[--pos]=255&-value^255,value/=256}function fromPositiveLE(buffer,offset,value){for(var end=offset+8;offset<end;)buffer[offset++]=255&value,value/=256}function fromNegativeLE(buffer,offset,value){var end=offset+8;for(value++;offset<end;)buffer[offset++]=255&-value^255,value/=256}factory("Uint64BE",!0,!0),factory("Int64BE",!0,!1),factory("Uint64LE",!1,!0),factory("Int64LE",!1,!1)}("string"!=typeof exports.nodeName?exports:this||{})}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tools=__webpack_require__(20),tools_1=__webpack_require__(20),byEbmlID=__webpack_require__(87).byEbmlID,EBMLEncoder=function(){function EBMLEncoder(){this._schema=byEbmlID,this._buffers=[],this._stack=[]}return EBMLEncoder.prototype.encode=function(elms){var _this=this;return tools.concat(elms.reduce((function(lst,elm){return lst.concat(_this.encodeChunk(elm))}),[])).buffer},EBMLEncoder.prototype.encodeChunk=function(elm){return"m"===elm.type?elm.isEnd?this.endTag(elm):this.startTag(elm):this.writeTag(elm),this.flush()},EBMLEncoder.prototype.flush=function(){var ret=this._buffers;return this._buffers=[],ret},EBMLEncoder.prototype.getSchemaInfo=function(tagName){for(var tagNums=Object.keys(this._schema).map(Number),i=0;i<tagNums.length;i++){var tagNum=tagNums[i];if(this._schema[tagNum].name===tagName)return new tools_1.Buffer(tagNum.toString(16),"hex")}return null},EBMLEncoder.prototype.writeTag=function(elm){var tagName=elm.name,tagId=this.getSchemaInfo(tagName),tagData=elm.data;if(null==tagId)throw new Error("No schema entry found for "+tagName);var data=tools.encodeTag(tagId,tagData);this._stack.length>0?this._stack[this._stack.length-1].children.push({tagId:tagId,elm:elm,children:[],data:data}):this._buffers=this._buffers.concat(data)},EBMLEncoder.prototype.startTag=function(elm){var tagName=elm.name,tagId=this.getSchemaInfo(tagName);if(null==tagId)throw new Error("No schema entry found for "+tagName);if(elm.unknownSize){var data=tools.encodeTag(tagId,new tools_1.Buffer(0),elm.unknownSize);this._buffers=this._buffers.concat(data)}else{var tag={tagId:tagId,elm:elm,children:[],data:null};this._stack.length>0&&this._stack[this._stack.length-1].children.push(tag),this._stack.push(tag)}},EBMLEncoder.prototype.endTag=function(elm){elm.name;var tag=this._stack.pop();if(null==tag)throw new Error("EBML structure is broken");if(tag.elm.name!==elm.name)throw new Error("EBML structure is broken");var childTagDataBuffers=tag.children.reduce((function(lst,child){if(null===child.data)throw new Error("EBML structure is broken");return lst.concat(child.data)}),[]),childTagDataBuffer=tools.concat(childTagDataBuffers);"m"===tag.elm.type?tag.data=tools.encodeTag(tag.tagId,childTagDataBuffer,tag.elm.unknownSize):tag.data=tools.encodeTag(tag.tagId,childTagDataBuffer),this._stack.length<1&&(this._buffers=this._buffers.concat(tag.data))},EBMLEncoder}();exports.default=EBMLEncoder},function(module,exports,__webpack_require__){"use strict";var byEbmlID={128:{name:"ChapterDisplay",level:4,type:"m",multiple:!0,minver:1,webm:!0,description:"Contains all possible strings to use for the chapter display."},131:{name:"TrackType",level:3,type:"u",mandatory:!0,minver:1,range:"1-254",description:"A set of track types coded on 8 bits (1: video, 2: audio, 3: complex, 0x10: logo, 0x11: subtitle, 0x12: buttons, 0x20: control)."},133:{name:"ChapString",cppname:"ChapterString",level:5,type:"8",mandatory:!0,minver:1,webm:!0,description:"Contains the string to use as the chapter atom."},134:{name:"CodecID",level:3,type:"s",mandatory:!0,minver:1,description:"An ID corresponding to the codec, see the codec page for more info."},136:{name:"FlagDefault",cppname:"TrackFlagDefault",level:3,type:"u",mandatory:!0,minver:1,default:1,range:"0-1",description:"Set if that track (audio, video or subs) SHOULD be active if no language found matches the user preference. (1 bit)"},137:{name:"ChapterTrackNumber",level:5,type:"u",mandatory:!0,multiple:!0,minver:1,webm:!1,range:"not 0",description:"UID of the Track to apply this chapter too. In the absense of a control track, choosing this chapter will select the listed Tracks and deselect unlisted tracks. Absense of this element indicates that the Chapter should be applied to any currently used Tracks."},145:{name:"ChapterTimeStart",level:4,type:"u",mandatory:!0,minver:1,webm:!0,description:"Timestamp of the start of Chapter (not scaled)."},146:{name:"ChapterTimeEnd",level:4,type:"u",minver:1,webm:!1,description:"Timestamp of the end of Chapter (timestamp excluded, not scaled)."},150:{name:"CueRefTime",level:5,type:"u",mandatory:!0,minver:2,webm:!1,description:"Timestamp of the referenced Block."},151:{name:"CueRefCluster",level:5,type:"u",mandatory:!0,webm:!1,description:"The Position of the Cluster containing the referenced Block."},152:{name:"ChapterFlagHidden",level:4,type:"u",mandatory:!0,minver:1,webm:!1,default:0,range:"0-1",description:"If a chapter is hidden (1), it should not be available to the user interface (but still to Control Tracks; see flag notes). (1 bit)"},16980:{name:"ContentCompAlgo",level:6,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"The compression algorithm used. Algorithms that have been specified so far are: 0 - zlib,   3 - Header Stripping"},16981:{name:"ContentCompSettings",level:6,type:"b",minver:1,webm:!1,description:"Settings that might be needed by the decompressor. For Header Stripping (ContentCompAlgo=3), the bytes that were removed from the beggining of each frames of the track."},17026:{name:"DocType",level:1,type:"s",mandatory:!0,default:"matroska",minver:1,description:"A string that describes the type of document that follows this EBML header. 'matroska' in our case or 'webm' for webm files."},17029:{name:"DocTypeReadVersion",level:1,type:"u",mandatory:!0,default:1,minver:1,description:"The minimum DocType version an interpreter has to support to read this file."},17030:{name:"EBMLVersion",level:1,type:"u",mandatory:!0,default:1,minver:1,description:"The version of EBML parser used to create the file."},17031:{name:"DocTypeVersion",level:1,type:"u",mandatory:!0,default:1,minver:1,description:"The version of DocType interpreter used to create the file."},17476:{name:"SegmentFamily",level:2,type:"b",multiple:!0,minver:1,webm:!1,bytesize:16,description:"A randomly generated unique ID that all segments related to each other must use (128 bits)."},17505:{name:"DateUTC",level:2,type:"d",minver:1,description:"Date of the origin of timestamp (value 0), i.e. production date."},17540:{name:"TagDefault",level:4,type:"u",mandatory:!0,minver:1,webm:!1,default:1,range:"0-1",description:"Indication to know if this is the default/original language to use for the given tag. (1 bit)"},17541:{name:"TagBinary",level:4,type:"b",minver:1,webm:!1,description:"The values of the Tag if it is binary. Note that this cannot be used in the same SimpleTag as TagString."},17543:{name:"TagString",level:4,type:"8",minver:1,webm:!1,description:"The value of the Element."},17545:{name:"Duration",level:2,type:"f",minver:1,range:"> 0",description:"Duration of the segment (based on TimecodeScale)."},17816:{name:"ChapterFlagEnabled",level:4,type:"u",mandatory:!0,minver:1,webm:!1,default:1,range:"0-1",description:"Specify wether the chapter is enabled. It can be enabled/disabled by a Control Track. When disabled, the movie should skip all the content between the TimeStart and TimeEnd of this chapter (see flag notes). (1 bit)"},18016:{name:"FileMimeType",level:3,type:"s",mandatory:!0,minver:1,webm:!1,description:"MIME type of the file."},18017:{name:"FileUsedStartTime",level:3,type:"u",divx:!0,description:"DivX font extension"},18018:{name:"FileUsedEndTime",level:3,type:"u",divx:!0,description:"DivX font extension"},18037:{name:"FileReferral",level:3,type:"b",webm:!1,description:"A binary value that a track/codec can refer to when the attachment is needed."},20529:{name:"ContentEncodingOrder",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"Tells when this modification was used during encoding/muxing starting with 0 and counting upwards. The decoder/demuxer has to start with the highest order number it finds and work its way down. This value has to be unique over all ContentEncodingOrder elements in the segment."},20530:{name:"ContentEncodingScope",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:1,range:"not 0",description:"A bit field that describes which elements have been modified in this way. Values (big endian) can be OR'ed. Possible values: 1 - all frame contents, 2 - the track's private data, 4 - the next ContentEncoding (next ContentEncodingOrder. Either the data inside ContentCompression and/or ContentEncryption)"},20531:{name:"ContentEncodingType",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"A value describing what kind of transformation has been done. Possible values: 0 - compression, 1 - encryption"},20532:{name:"ContentCompression",level:5,type:"m",minver:1,webm:!1,description:"Settings describing the compression used. Must be present if the value of ContentEncodingType is 0 and absent otherwise. Each block must be decompressable even if no previous block is available in order not to prevent seeking."},20533:{name:"ContentEncryption",level:5,type:"m",minver:1,webm:!1,description:"Settings describing the encryption used. Must be present if the value of ContentEncodingType is 1 and absent otherwise."},21368:{name:"CueBlockNumber",level:4,type:"u",minver:1,default:1,range:"not 0",description:"Number of the Block in the specified Cluster."},22100:{name:"ChapterStringUID",level:4,type:"8",mandatory:!1,minver:3,webm:!0,description:"A unique string ID to identify the Chapter. Use for WebVTT cue identifier storage."},22337:{name:"WritingApp",level:2,type:"8",mandatory:!0,minver:1,description:'Writing application ("mkvmerge-0.3.3").'},22612:{name:"SilentTracks",cppname:"ClusterSilentTracks",level:2,type:"m",minver:1,webm:!1,description:"The list of tracks that are not used in that part of the stream. It is useful when using overlay tracks on seeking. Then you should decide what track to use."},25152:{name:"ContentEncoding",level:4,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"Settings for one content encoding like compression or encryption."},25188:{name:"BitDepth",cppname:"AudioBitDepth",level:4,type:"u",minver:1,range:"not 0",description:"Bits per sample, mostly used for PCM."},25906:{name:"SignedElement",level:3,type:"b",multiple:!0,webm:!1,description:"An element ID whose data will be used to compute the signature."},26148:{name:"TrackTranslate",level:3,type:"m",multiple:!0,minver:1,webm:!1,description:"The track identification for the given Chapter Codec."},26897:{name:"ChapProcessCommand",cppname:"ChapterProcessCommand",level:5,type:"m",multiple:!0,minver:1,webm:!1,description:"Contains all the commands associated to the Atom."},26914:{name:"ChapProcessTime",cppname:"ChapterProcessTime",level:6,type:"u",mandatory:!0,minver:1,webm:!1,description:"Defines when the process command should be handled (0: during the whole chapter, 1: before starting playback, 2: after playback of the chapter)."},26916:{name:"ChapterTranslate",level:2,type:"m",multiple:!0,minver:1,webm:!1,description:"A tuple of corresponding ID used by chapter codecs to represent this segment."},26931:{name:"ChapProcessData",cppname:"ChapterProcessData",level:6,type:"b",mandatory:!0,minver:1,webm:!1,description:"Contains the command information. The data should be interpreted depending on the ChapProcessCodecID value. For ChapProcessCodecID = 1, the data correspond to the binary DVD cell pre/post commands."},26948:{name:"ChapProcess",cppname:"ChapterProcess",level:4,type:"m",multiple:!0,minver:1,webm:!1,description:"Contains all the commands associated to the Atom."},26965:{name:"ChapProcessCodecID",cppname:"ChapterProcessCodecID",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"Contains the type of the codec used for the processing. A value of 0 means native Matroska processing (to be defined), a value of 1 means the DVD command set is used. More codec IDs can be added later."},29555:{name:"Tag",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"Element containing elements specific to Tracks/Chapters."},29572:{name:"SegmentFilename",level:2,type:"8",minver:1,webm:!1,description:"A filename corresponding to this segment."},29766:{name:"AttachmentLink",cppname:"TrackAttachmentLink",level:3,type:"u",minver:1,webm:!1,range:"not 0",description:"The UID of an attachment that is used by this codec."},2459272:{name:"CodecName",level:3,type:"8",minver:1,description:"A human-readable string specifying the codec."},408125543:{name:"Segment",level:"0",type:"m",mandatory:!0,multiple:!0,minver:1,description:"This element contains all other top-level (level 1) elements. Typically a Matroska file is composed of 1 segment."},17530:{name:"TagLanguage",level:4,type:"s",mandatory:!0,minver:1,webm:!1,default:"und",description:"Specifies the language of the tag specified, in the Matroska languages form."},17827:{name:"TagName",level:4,type:"8",mandatory:!0,minver:1,webm:!1,description:"The name of the Tag that is going to be stored."},26568:{name:"SimpleTag",cppname:"TagSimple",level:3,recursive:"1",type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"Contains general information about the target."},25542:{name:"TagAttachmentUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,default:0,description:"A unique ID to identify the Attachment(s) the tags belong to. If the value is 0 at this level, the tags apply to all the attachments in the Segment."},25540:{name:"TagChapterUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,default:0,description:"A unique ID to identify the Chapter(s) the tags belong to. If the value is 0 at this level, the tags apply to all chapters in the Segment."},25545:{name:"TagEditionUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,default:0,description:"A unique ID to identify the EditionEntry(s) the tags belong to. If the value is 0 at this level, the tags apply to all editions in the Segment."},25541:{name:"TagTrackUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,default:0,description:"A unique ID to identify the Track(s) the tags belong to. If the value is 0 at this level, the tags apply to all tracks in the Segment."},25546:{name:"TargetType",cppname:"TagTargetType",level:4,type:"s",minver:1,webm:!1,strong:"informational",description:'An  string that can be used to display the logical level of the target like "ALBUM", "TRACK", "MOVIE", "CHAPTER", etc (see TargetType).'},26826:{name:"TargetTypeValue",cppname:"TagTargetTypeValue",level:4,type:"u",minver:1,webm:!1,default:50,description:"A number to indicate the logical level of the target (see TargetType)."},25536:{name:"Targets",cppname:"TagTargets",level:3,type:"m",mandatory:!0,minver:1,webm:!1,description:"Contain all UIDs where the specified meta data apply. It is empty to describe everything in the segment."},307544935:{name:"Tags",level:1,type:"m",multiple:!0,minver:1,webm:!1,description:"Element containing elements specific to Tracks/Chapters. A list of valid tags can be found here."},17677:{name:"ChapProcessPrivate",cppname:"ChapterProcessPrivate",level:5,type:"b",minver:1,webm:!1,description:'Some optional data attached to the ChapProcessCodecID information. For ChapProcessCodecID = 1, it is the "DVD level" equivalent.'},17278:{name:"ChapCountry",cppname:"ChapterCountry",level:5,type:"s",multiple:!0,minver:1,webm:!1,description:"The countries corresponding to the string, same 2 octets as in Internet domains."},17276:{name:"ChapLanguage",cppname:"ChapterLanguage",level:5,type:"s",mandatory:!0,multiple:!0,minver:1,webm:!0,default:"eng",description:"The languages corresponding to the string, in the bibliographic ISO-639-2 form."},143:{name:"ChapterTrack",level:4,type:"m",minver:1,webm:!1,description:"List of tracks on which the chapter applies. If this element is not present, all tracks apply"},25539:{name:"ChapterPhysicalEquiv",level:4,type:"u",minver:1,webm:!1,description:'Specify the physical equivalent of this ChapterAtom like "DVD" (60) or "SIDE" (50), see complete list of values.'},28348:{name:"ChapterSegmentEditionUID",level:4,type:"u",minver:1,webm:!1,range:"not 0",description:"The EditionUID to play from the segment linked in ChapterSegmentUID."},28263:{name:"ChapterSegmentUID",level:4,type:"b",minver:1,webm:!1,range:">0",bytesize:16,description:"A segment to play in place of this chapter. Edition ChapterSegmentEditionUID should be used for this segment, otherwise no edition is used."},29636:{name:"ChapterUID",level:4,type:"u",mandatory:!0,minver:1,webm:!0,range:"not 0",description:"A unique ID to identify the Chapter."},182:{name:"ChapterAtom",level:3,recursive:"1",type:"m",mandatory:!0,multiple:!0,minver:1,webm:!0,description:"Contains the atom information to use as the chapter atom (apply to all tracks)."},17885:{name:"EditionFlagOrdered",level:3,type:"u",minver:1,webm:!1,default:0,range:"0-1",description:"Specify if the chapters can be defined multiple times and the order to play them is enforced. (1 bit)"},17883:{name:"EditionFlagDefault",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,range:"0-1",description:"If a flag is set (1) the edition should be used as the default one. (1 bit)"},17853:{name:"EditionFlagHidden",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,range:"0-1",description:"If an edition is hidden (1), it should not be available to the user interface (but still to Control Tracks; see flag notes). (1 bit)"},17852:{name:"EditionUID",level:3,type:"u",minver:1,webm:!1,range:"not 0",description:"A unique ID to identify the edition. It's useful for tagging an edition."},17849:{name:"EditionEntry",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!0,description:"Contains all information about a segment edition."},272869232:{name:"Chapters",level:1,type:"m",minver:1,webm:!0,description:"A system to define basic menus and partition data. For more detailed information, look at the Chapters Explanation."},18094:{name:"FileUID",level:3,type:"u",mandatory:!0,minver:1,webm:!1,range:"not 0",description:"Unique ID representing the file, as random as possible."},18012:{name:"FileData",level:3,type:"b",mandatory:!0,minver:1,webm:!1,description:"The data of the file."},18030:{name:"FileName",level:3,type:"8",mandatory:!0,minver:1,webm:!1,description:"Filename of the attached file."},18046:{name:"FileDescription",level:3,type:"8",minver:1,webm:!1,description:"A human-friendly name for the attached file."},24999:{name:"AttachedFile",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"An attached file."},423732329:{name:"Attachments",level:1,type:"m",minver:1,webm:!1,description:"Contain attached files."},235:{name:"CueRefCodecState",level:5,type:"u",webm:!1,default:0,description:"The position of the Codec State corresponding to this referenced element. 0 means that the data is taken from the initial Track Entry."},21343:{name:"CueRefNumber",level:5,type:"u",webm:!1,default:1,range:"not 0",description:"Number of the referenced Block of Track X in the specified Cluster."},219:{name:"CueReference",level:4,type:"m",multiple:!0,minver:2,webm:!1,description:"The Clusters containing the required referenced Blocks."},234:{name:"CueCodecState",level:4,type:"u",minver:2,webm:!1,default:0,description:"The position of the Codec State corresponding to this Cue element. 0 means that the data is taken from the initial Track Entry."},178:{name:"CueDuration",level:4,type:"u",mandatory:!1,minver:4,webm:!1,description:"The duration of the block according to the segment time base. If missing the track's DefaultDuration does not apply and no duration information is available in terms of the cues."},240:{name:"CueRelativePosition",level:4,type:"u",mandatory:!1,minver:4,webm:!1,description:"The relative position of the referenced block inside the cluster with 0 being the first possible position for an element inside that cluster.",position:"clusterRelative"},241:{name:"CueClusterPosition",level:4,type:"u",mandatory:!0,minver:1,description:"The position of the Cluster containing the required Block.",position:"segment"},247:{name:"CueTrack",level:4,type:"u",mandatory:!0,minver:1,range:"not 0",description:"The track for which a position is given."},183:{name:"CueTrackPositions",level:3,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Contain positions for different tracks corresponding to the timestamp."},179:{name:"CueTime",level:3,type:"u",mandatory:!0,minver:1,description:"Absolute timestamp according to the segment time base."},187:{name:"CuePoint",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Contains all information relative to a seek point in the segment."},475249515:{name:"Cues",level:1,type:"m",minver:1,description:'A top-level element to speed seeking access. All entries are local to the segment. Should be mandatory for non "live" streams.'},18406:{name:"ContentSigHashAlgo",level:6,type:"u",minver:1,webm:!1,default:0,description:"The hash algorithm used for the signature. A value of '0' means that the contents have not been signed but only encrypted. Predefined values: 1 - SHA1-160 2 - MD5"},18405:{name:"ContentSigAlgo",level:6,type:"u",minver:1,webm:!1,default:0,description:"The algorithm used for the signature. A value of '0' means that the contents have not been signed but only encrypted. Predefined values: 1 - RSA"},18404:{name:"ContentSigKeyID",level:6,type:"b",minver:1,webm:!1,description:"This is the ID of the private key the data was signed with."},18403:{name:"ContentSignature",level:6,type:"b",minver:1,webm:!1,description:"A cryptographic signature of the contents."},18402:{name:"ContentEncKeyID",level:6,type:"b",minver:1,webm:!1,description:"For public key algorithms this is the ID of the public key the the data was encrypted with."},18401:{name:"ContentEncAlgo",level:6,type:"u",minver:1,webm:!1,default:0,description:"The encryption algorithm used. The value '0' means that the contents have not been encrypted but only signed. Predefined values: 1 - DES, 2 - 3DES, 3 - Twofish, 4 - Blowfish, 5 - AES"},28032:{name:"ContentEncodings",level:3,type:"m",minver:1,webm:!1,description:"Settings for several content encoding mechanisms like compression or encryption."},196:{name:"TrickMasterTrackSegmentUID",level:3,type:"b",divx:!0,bytesize:16,description:"DivX trick track extenstions"},199:{name:"TrickMasterTrackUID",level:3,type:"u",divx:!0,description:"DivX trick track extenstions"},198:{name:"TrickTrackFlag",level:3,type:"u",divx:!0,default:0,description:"DivX trick track extenstions"},193:{name:"TrickTrackSegmentUID",level:3,type:"b",divx:!0,bytesize:16,description:"DivX trick track extenstions"},192:{name:"TrickTrackUID",level:3,type:"u",divx:!0,description:"DivX trick track extenstions"},237:{name:"TrackJoinUID",level:5,type:"u",mandatory:!0,multiple:!0,minver:3,webm:!1,range:"not 0",description:"The trackUID number of a track whose blocks are used to create this virtual track."},233:{name:"TrackJoinBlocks",level:4,type:"m",minver:3,webm:!1,description:"Contains the list of all tracks whose Blocks need to be combined to create this virtual track"},230:{name:"TrackPlaneType",level:6,type:"u",mandatory:!0,minver:3,webm:!1,description:"The kind of plane this track corresponds to (0: left eye, 1: right eye, 2: background)."},229:{name:"TrackPlaneUID",level:6,type:"u",mandatory:!0,minver:3,webm:!1,range:"not 0",description:"The trackUID number of the track representing the plane."},228:{name:"TrackPlane",level:5,type:"m",mandatory:!0,multiple:!0,minver:3,webm:!1,description:"Contains a video plane track that need to be combined to create this 3D track"},227:{name:"TrackCombinePlanes",level:4,type:"m",minver:3,webm:!1,description:"Contains the list of all video plane tracks that need to be combined to create this 3D track"},226:{name:"TrackOperation",level:3,type:"m",minver:3,webm:!1,description:"Operation that needs to be applied on tracks to create this virtual track. For more details look at the Specification Notes on the subject."},32123:{name:"ChannelPositions",cppname:"AudioPosition",level:4,type:"b",webm:!1,description:"Table of horizontal angles for each successive channel, see appendix."},159:{name:"Channels",cppname:"AudioChannels",level:4,type:"u",mandatory:!0,minver:1,default:1,range:"not 0",description:"Numbers of channels in the track."},30901:{name:"OutputSamplingFrequency",cppname:"AudioOutputSamplingFreq",level:4,type:"f",minver:1,default:"Sampling Frequency",range:"> 0",description:"Real output sampling frequency in Hz (used for SBR techniques)."},181:{name:"SamplingFrequency",cppname:"AudioSamplingFreq",level:4,type:"f",mandatory:!0,minver:1,default:8e3,range:"> 0",description:"Sampling frequency in Hz."},225:{name:"Audio",cppname:"TrackAudio",level:3,type:"m",minver:1,description:"Audio settings."},2327523:{name:"FrameRate",cppname:"VideoFrameRate",level:4,type:"f",range:"> 0",strong:"Informational",description:"Number of frames per second.  only."},3126563:{name:"GammaValue",cppname:"VideoGamma",level:4,type:"f",webm:!1,range:"> 0",description:"Gamma Value."},3061028:{name:"ColourSpace",cppname:"VideoColourSpace",level:4,type:"b",minver:1,webm:!1,bytesize:4,description:"Same value as in AVI (32 bits)."},21683:{name:"AspectRatioType",cppname:"VideoAspectRatio",level:4,type:"u",minver:1,default:0,description:"Specify the possible modifications to the aspect ratio (0: free resizing, 1: keep aspect ratio, 2: fixed)."},21682:{name:"DisplayUnit",cppname:"VideoDisplayUnit",level:4,type:"u",minver:1,default:0,description:"How DisplayWidth & DisplayHeight should be interpreted (0: pixels, 1: centimeters, 2: inches, 3: Display Aspect Ratio)."},21690:{name:"DisplayHeight",cppname:"VideoDisplayHeight",level:4,type:"u",minver:1,default:"PixelHeight",range:"not 0",description:"Height of the video frames to display. The default value is only valid when DisplayUnit is 0."},21680:{name:"DisplayWidth",cppname:"VideoDisplayWidth",level:4,type:"u",minver:1,default:"PixelWidth",range:"not 0",description:"Width of the video frames to display. The default value is only valid when DisplayUnit is 0."},21725:{name:"PixelCropRight",cppname:"VideoPixelCropRight",level:4,type:"u",minver:1,default:0,description:"The number of video pixels to remove on the right of the image."},21708:{name:"PixelCropLeft",cppname:"VideoPixelCropLeft",level:4,type:"u",minver:1,default:0,description:"The number of video pixels to remove on the left of the image."},21691:{name:"PixelCropTop",cppname:"VideoPixelCropTop",level:4,type:"u",minver:1,default:0,description:"The number of video pixels to remove at the top of the image."},21674:{name:"PixelCropBottom",cppname:"VideoPixelCropBottom",level:4,type:"u",minver:1,default:0,description:"The number of video pixels to remove at the bottom of the image (for HDTV content)."},186:{name:"PixelHeight",cppname:"VideoPixelHeight",level:4,type:"u",mandatory:!0,minver:1,range:"not 0",description:"Height of the encoded video frames in pixels."},176:{name:"PixelWidth",cppname:"VideoPixelWidth",level:4,type:"u",mandatory:!0,minver:1,range:"not 0",description:"Width of the encoded video frames in pixels."},21433:{name:"OldStereoMode",level:4,type:"u",maxver:"0",webm:!1,divx:!1,description:"DEPRECATED, DO NOT USE. Bogus StereoMode value used in old versions of libmatroska. (0: mono, 1: right eye, 2: left eye, 3: both eyes)."},21440:{name:"AlphaMode",cppname:"VideoAlphaMode",level:4,type:"u",minver:3,webm:!0,default:0,description:"Alpha Video Mode. Presence of this element indicates that the BlockAdditional element could contain Alpha data."},21432:{name:"StereoMode",cppname:"VideoStereoMode",level:4,type:"u",minver:3,webm:!0,default:0,description:"Stereo-3D video mode (0: mono, 1: side by side (left eye is first), 2: top-bottom (right eye is first), 3: top-bottom (left eye is first), 4: checkboard (right is first), 5: checkboard (left is first), 6: row interleaved (right is first), 7: row interleaved (left is first), 8: column interleaved (right is first), 9: column interleaved (left is first), 10: anaglyph (cyan/red), 11: side by side (right eye is first), 12: anaglyph (green/magenta), 13 both eyes laced in one Block (left eye is first), 14 both eyes laced in one Block (right eye is first)) . There are some more details on 3D support in the Specification Notes."},154:{name:"FlagInterlaced",cppname:"VideoFlagInterlaced",level:4,type:"u",mandatory:!0,minver:2,webm:!0,default:0,range:"0-1",description:"Set if the video is interlaced. (1 bit)"},224:{name:"Video",cppname:"TrackVideo",level:3,type:"m",minver:1,description:"Video settings."},26277:{name:"TrackTranslateTrackID",level:4,type:"b",mandatory:!0,minver:1,webm:!1,description:"The binary value used to represent this track in the chapter codec data. The format depends on the ChapProcessCodecID used."},26303:{name:"TrackTranslateCodec",level:4,type:"u",mandatory:!0,minver:1,webm:!1,description:"The chapter codec using this ID (0: Matroska Script, 1: DVD-menu)."},26364:{name:"TrackTranslateEditionUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,description:"Specify an edition UID on which this translation applies. When not specified, it means for all editions found in the segment."},22203:{name:"SeekPreRoll",level:3,type:"u",mandatory:!0,multiple:!1,default:0,minver:4,webm:!0,description:"After a discontinuity, SeekPreRoll is the duration in nanoseconds of the data the decoder must decode before the decoded data is valid."},22186:{name:"CodecDelay",level:3,type:"u",multiple:!1,default:0,minver:4,webm:!0,description:"CodecDelay is The codec-built-in delay in nanoseconds. This value must be subtracted from each block timestamp in order to get the actual timestamp. The value should be small so the muxing of tracks with the same actual timestamp are in the same Cluster."},28587:{name:"TrackOverlay",level:3,type:"u",multiple:!0,minver:1,webm:!1,description:"Specify that this track is an overlay track for the Track specified (in the u-integer). That means when this track has a gap (see SilentTracks) the overlay track should be used instead. The order of multiple TrackOverlay matters, the first one is the one that should be used. If not found it should be the second, etc."},170:{name:"CodecDecodeAll",level:3,type:"u",mandatory:!0,minver:2,webm:!1,default:1,range:"0-1",description:"The codec can decode potentially damaged data (1 bit)."},2536e3:{name:"CodecDownloadURL",level:3,type:"s",multiple:!0,webm:!1,description:"A URL to download about the codec used."},3883072:{name:"CodecInfoURL",level:3,type:"s",multiple:!0,webm:!1,description:"A URL to find information about the codec used."},3839639:{name:"CodecSettings",level:3,type:"8",webm:!1,description:"A string describing the encoding setting used."},25506:{name:"CodecPrivate",level:3,type:"b",minver:1,description:"Private data only known to the codec."},2274716:{name:"Language",cppname:"TrackLanguage",level:3,type:"s",minver:1,default:"eng",description:"Specifies the language of the track in the Matroska languages form."},21358:{name:"Name",cppname:"TrackName",level:3,type:"8",minver:1,description:"A human-readable track name."},21998:{name:"MaxBlockAdditionID",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"The maximum value of BlockAdditions for this track."},21375:{name:"TrackOffset",level:3,type:"i",webm:!1,default:0,description:"A value to add to the Block's Timestamp. This can be used to adjust the playback offset of a track."},2306383:{name:"TrackTimecodeScale",level:3,type:"f",mandatory:!0,minver:1,maxver:"3",webm:!1,default:1,range:"> 0",description:"DEPRECATED, DO NOT USE. The scale to apply on this track to work at normal speed in relation with other tracks (mostly used to adjust video speed when the audio length differs)."},2313850:{name:"DefaultDecodedFieldDuration",cppname:"TrackDefaultDecodedFieldDuration",level:3,type:"u",minver:4,range:"not 0",description:"The period in nanoseconds (not scaled by TimcodeScale)\nbetween two successive fields at the output of the decoding process (see the notes)"},2352003:{name:"DefaultDuration",cppname:"TrackDefaultDuration",level:3,type:"u",minver:1,range:"not 0",description:"Number of nanoseconds (not scaled via TimecodeScale) per frame ('frame' in the Matroska sense -- one element put into a (Simple)Block)."},28152:{name:"MaxCache",cppname:"TrackMaxCache",level:3,type:"u",minver:1,webm:!1,description:"The maximum cache size required to store referenced frames in and the current frame. 0 means no cache is needed."},28135:{name:"MinCache",cppname:"TrackMinCache",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"The minimum number of frames a player should be able to cache during playback. If set to 0, the reference pseudo-cache system is not used."},156:{name:"FlagLacing",cppname:"TrackFlagLacing",level:3,type:"u",mandatory:!0,minver:1,default:1,range:"0-1",description:"Set if the track may contain blocks using lacing. (1 bit)"},21930:{name:"FlagForced",cppname:"TrackFlagForced",level:3,type:"u",mandatory:!0,minver:1,default:0,range:"0-1",description:"Set if that track MUST be active during playback. There can be many forced track for a kind (audio, video or subs), the player should select the one which language matches the user preference or the default + forced track. Overlay MAY happen between a forced and non-forced track of the same kind. (1 bit)"},185:{name:"FlagEnabled",cppname:"TrackFlagEnabled",level:3,type:"u",mandatory:!0,minver:2,webm:!0,default:1,range:"0-1",description:"Set if the track is usable. (1 bit)"},29637:{name:"TrackUID",level:3,type:"u",mandatory:!0,minver:1,range:"not 0",description:"A unique ID to identify the Track. This should be kept the same when making a direct stream copy of the Track to another file."},215:{name:"TrackNumber",level:3,type:"u",mandatory:!0,minver:1,range:"not 0",description:"The track number as used in the Block Header (using more than 127 tracks is not encouraged, though the design allows an unlimited number)."},174:{name:"TrackEntry",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Describes a track with all elements."},374648427:{name:"Tracks",level:1,type:"m",multiple:!0,minver:1,description:"A top-level block of information with many tracks described."},175:{name:"EncryptedBlock",level:2,type:"b",multiple:!0,webm:!1,description:"Similar to EncryptedBlock Structure)"},202:{name:"ReferenceTimeCode",level:4,type:"u",multiple:!1,mandatory:!0,minver:0,webm:!1,divx:!0,description:"DivX trick track extenstions"},201:{name:"ReferenceOffset",level:4,type:"u",multiple:!1,mandatory:!0,minver:0,webm:!1,divx:!0,description:"DivX trick track extenstions"},200:{name:"ReferenceFrame",level:3,type:"m",multiple:!1,minver:0,webm:!1,divx:!0,description:"DivX trick track extenstions"},207:{name:"SliceDuration",level:5,type:"u",default:0,description:"The (scaled) duration to apply to the element."},206:{name:"Delay",cppname:"SliceDelay",level:5,type:"u",default:0,description:"The (scaled) delay to apply to the element."},203:{name:"BlockAdditionID",cppname:"SliceBlockAddID",level:5,type:"u",default:0,description:"The ID of the BlockAdditional element (0 is the main Block)."},205:{name:"FrameNumber",cppname:"SliceFrameNumber",level:5,type:"u",default:0,description:"The number of the frame to generate from this lace with this delay (allow you to generate many frames from the same Block/Frame)."},204:{name:"LaceNumber",cppname:"SliceLaceNumber",level:5,type:"u",minver:1,default:0,divx:!1,description:"The reverse number of the frame in the lace (0 is the last frame, 1 is the next to last, etc). While there are a few files in the wild with this element, it is no longer in use and has been deprecated. Being able to interpret this element is not required for playback."},232:{name:"TimeSlice",level:4,type:"m",multiple:!0,minver:1,divx:!1,description:"Contains extra time information about the data contained in the Block. While there are a few files in the wild with this element, it is no longer in use and has been deprecated. Being able to interpret this element is not required for playback."},142:{name:"Slices",level:3,type:"m",minver:1,divx:!1,description:"Contains slices description."},30114:{name:"DiscardPadding",level:3,type:"i",minver:4,webm:!0,description:"Duration in nanoseconds of the silent data added to the Block (padding at the end of the Block for positive value, at the beginning of the Block for negative value). The duration of DiscardPadding is not calculated in the duration of the TrackEntry and should be discarded during playback."},164:{name:"CodecState",level:3,type:"b",minver:2,webm:!1,description:"The new codec state to use. Data interpretation is private to the codec. This information should always be referenced by a seek entry."},253:{name:"ReferenceVirtual",level:3,type:"i",webm:!1,description:"Relative position of the data that should be in position of the virtual block."},251:{name:"ReferenceBlock",level:3,type:"i",multiple:!0,minver:1,description:"Timestamp of another frame used as a reference (ie: B or P frame). The timestamp is relative to the block it's attached to."},250:{name:"ReferencePriority",cppname:"FlagReferenced",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"This frame is referenced and has the specified cache priority. In cache only a frame of the same or higher priority can replace this frame. A value of 0 means the frame is not referenced."},155:{name:"BlockDuration",level:3,type:"u",minver:1,default:"TrackDuration",description:'The duration of the Block (based on TimecodeScale). This element is mandatory when DefaultDuration is set for the track (but can be omitted as other default values). When not written and with no DefaultDuration, the value is assumed to be the difference between the timestamp of this Block and the timestamp of the next Block in "display" order (not coding order). This element can be useful at the end of a Track (as there is not other Block available), or when there is a break in a track like for subtitle tracks. When set to 0 that means the frame is not a keyframe.'},165:{name:"BlockAdditional",level:5,type:"b",mandatory:!0,minver:1,webm:!1,description:"Interpreted by the codec as it wishes (using the BlockAddID)."},238:{name:"BlockAddID",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:1,range:"not 0",description:"An ID to identify the BlockAdditional level."},166:{name:"BlockMore",level:4,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"Contain the BlockAdditional and some parameters."},30113:{name:"BlockAdditions",level:3,type:"m",minver:1,webm:!1,description:"Contain additional blocks to complete the main one. An EBML parser that has no knowledge of the Block structure could still see and use/skip these data."},162:{name:"BlockVirtual",level:3,type:"b",webm:!1,description:"A Block with no data. It must be stored in the stream at the place the real Block should be in display order. (see Block Virtual)"},161:{name:"Block",level:3,type:"b",mandatory:!0,minver:1,description:"Block containing the actual data to be rendered and a timestamp relative to the Cluster Timecode. (see Block Structure)"},160:{name:"BlockGroup",level:2,type:"m",multiple:!0,minver:1,description:"Basic container of information containing a single Block or BlockVirtual, and information specific to that Block/VirtualBlock."},163:{name:"SimpleBlock",level:2,type:"b",multiple:!0,minver:2,webm:!0,divx:!0,description:"Similar to SimpleBlock Structure"},171:{name:"PrevSize",cppname:"ClusterPrevSize",level:2,type:"u",minver:1,description:"Size of the previous Cluster, in octets. Can be useful for backward playing.",position:"prevCluster"},167:{name:"Position",cppname:"ClusterPosition",level:2,type:"u",minver:1,webm:!1,description:"The Position of the Cluster in the segment (0 in live broadcast streams). It might help to resynchronise offset on damaged streams.",position:"segment"},22743:{name:"SilentTrackNumber",cppname:"ClusterSilentTrackNumber",level:3,type:"u",multiple:!0,minver:1,webm:!1,description:"One of the track number that are not used from now on in the stream. It could change later if not specified as silent in a further Cluster."},231:{name:"Timecode",cppname:"ClusterTimecode",level:2,type:"u",mandatory:!0,minver:1,description:"Absolute timestamp of the cluster (based on TimecodeScale)."},524531317:{name:"Cluster",level:1,type:"m",multiple:!0,minver:1,description:"The lower level element containing the (monolithic) Block structure."},19840:{name:"MuxingApp",level:2,type:"8",mandatory:!0,minver:1,description:'Muxing application or library ("libmatroska-0.4.3").'},31657:{name:"Title",level:2,type:"8",minver:1,webm:!1,description:"General name of the segment."},2807730:{name:"TimecodeScaleDenominator",level:2,type:"u",mandatory:!0,minver:4,default:"1000000000",description:"Timestamp scale numerator, see TimecodeScale."},2807729:{name:"TimecodeScale",level:2,type:"u",mandatory:!0,minver:1,default:"1000000",description:"Timestamp scale in nanoseconds (1.000.000 means all timestamps in the segment are expressed in milliseconds)."},27045:{name:"ChapterTranslateID",level:3,type:"b",mandatory:!0,minver:1,webm:!1,description:"The binary value used to represent this segment in the chapter codec data. The format depends on the ChapProcessCodecID used."},27071:{name:"ChapterTranslateCodec",level:3,type:"u",mandatory:!0,minver:1,webm:!1,description:"The chapter codec using this ID (0: Matroska Script, 1: DVD-menu)."},27132:{name:"ChapterTranslateEditionUID",level:3,type:"u",multiple:!0,minver:1,webm:!1,description:"Specify an edition UID on which this correspondance applies. When not specified, it means for all editions found in the segment."},4096955:{name:"NextFilename",level:2,type:"8",minver:1,webm:!1,description:"An escaped filename corresponding to the next segment."},4110627:{name:"NextUID",level:2,type:"b",minver:1,webm:!1,bytesize:16,description:"A unique ID to identify the next chained segment (128 bits)."},3965867:{name:"PrevFilename",level:2,type:"8",minver:1,webm:!1,description:"An escaped filename corresponding to the previous segment."},3979555:{name:"PrevUID",level:2,type:"b",minver:1,webm:!1,bytesize:16,description:"A unique ID to identify the previous chained segment (128 bits)."},29604:{name:"SegmentUID",level:2,type:"b",minver:1,webm:!1,range:"not 0",bytesize:16,description:"A randomly generated unique ID to identify the current segment between many others (128 bits)."},357149030:{name:"Info",level:1,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Contains miscellaneous general information and statistics on the file."},21420:{name:"SeekPosition",level:3,type:"u",mandatory:!0,minver:1,description:"The position of the element in the segment in octets (0 = first level 1 element).",position:"segment"},21419:{name:"SeekID",level:3,type:"b",mandatory:!0,minver:1,description:"The binary ID corresponding to the element name.",type2:"ebmlID"},19899:{name:"Seek",cppname:"SeekPoint",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Contains a single seek entry to an EBML element."},290298740:{name:"SeekHead",cppname:"SeekHeader",level:1,type:"m",multiple:!0,minver:1,description:"Contains the position of other level 1 elements."},32379:{name:"SignatureElementList",level:2,type:"m",multiple:!0,webm:!1,i:"Cluster|Block|BlockAdditional",description:"A list consists of a number of consecutive elements that represent one case where data is used in signature. Ex:  means that the BlockAdditional of all Blocks in all Clusters is used for encryption."},32347:{name:"SignatureElements",level:1,type:"m",webm:!1,description:"Contains elements that will be used to compute the signature."},32437:{name:"Signature",level:1,type:"b",webm:!1,description:"The signature of the data (until a new."},32421:{name:"SignaturePublicKey",level:1,type:"b",webm:!1,description:"The public key to use with the algorithm (in the case of a PKI-based signature)."},32410:{name:"SignatureHash",level:1,type:"u",webm:!1,description:"Hash algorithm used (1=SHA1-160, 2=MD5)."},32394:{name:"SignatureAlgo",level:1,type:"u",webm:!1,description:"Signature algorithm used (1=RSA, 2=elliptic)."},458458727:{name:"SignatureSlot",level:-1,type:"m",multiple:!0,webm:!1,description:"Contain signature of some (coming) elements in the stream."},191:{name:"CRC-32",level:-1,type:"b",minver:1,webm:!1,description:"The CRC is computed on all the data of the Master element it's in. The CRC element should be the first in it's parent master for easier reading. All level 1 elements should include a CRC-32. The CRC in use is the IEEE CRC32 Little Endian",crc:!0},236:{name:"Void",level:-1,type:"b",minver:1,description:"Used to void damaged data, to avoid unexpected behaviors when using damaged data. The content is discarded. Also used to reserve space in a sub-element for later use."},17139:{name:"EBMLMaxSizeLength",level:1,type:"u",mandatory:!0,default:8,minver:1,description:"The maximum length of the sizes you'll find in this file (8 or less in Matroska). This does not override the element size indicated at the beginning of an element. Elements that have an indicated size which is larger than what is allowed by EBMLMaxSizeLength shall be considered invalid."},17138:{name:"EBMLMaxIDLength",level:1,type:"u",mandatory:!0,default:4,minver:1,description:"The maximum length of the IDs you'll find in this file (4 or less in Matroska)."},17143:{name:"EBMLReadVersion",level:1,type:"u",mandatory:!0,default:1,minver:1,description:"The minimum EBML version a parser has to support to read this file."},440786851:{name:"EBML",level:"0",type:"m",mandatory:!0,multiple:!0,minver:1,description:"Set the EBML characteristics of the data to follow. Each EBML document has to start with this."}},byName={},schema={byEbmlID:byEbmlID,byName:byName};for(var ebmlID in byEbmlID){byName[byEbmlID[ebmlID].name.replace("-","_")]=parseInt(ebmlID,10)}module.exports=schema},function(module,exports){window.version="1.68.1"},function(module,exports){window.sdkversion="1.68.0"},function(module,exports){window.app=angular.module("rainbow",["angular-jwt"]),window.rainbowAdmin=angular.module("rainbowAdmin",[]),window.rainbow=angular.module("rainbow",["rainbowAdmin"])},function(module,exports,__webpack_require__){__webpack_require__(92),__webpack_require__(93),__webpack_require__(94),__webpack_require__(95),__webpack_require__(96),__webpack_require__(97),__webpack_require__(98),__webpack_require__(99),__webpack_require__(100),__webpack_require__(101),__webpack_require__(102),__webpack_require__(103),__webpack_require__(104),__webpack_require__(105),__webpack_require__(106),__webpack_require__(107),__webpack_require__(217),__webpack_require__(218),__webpack_require__(219),__webpack_require__(0),__webpack_require__(220),__webpack_require__(221),__webpack_require__(222),__webpack_require__(223),__webpack_require__(224),__webpack_require__(225),__webpack_require__(226),__webpack_require__(227),__webpack_require__(228),__webpack_require__(229),__webpack_require__(230),__webpack_require__(231),__webpack_require__(232),__webpack_require__(233),__webpack_require__(234),__webpack_require__(235),__webpack_require__(236),__webpack_require__(237),__webpack_require__(238),__webpack_require__(239),__webpack_require__(240),__webpack_require__(241),__webpack_require__(242),__webpack_require__(243),__webpack_require__(244),__webpack_require__(245),__webpack_require__(246),__webpack_require__(247),__webpack_require__(248),__webpack_require__(249),__webpack_require__(251),__webpack_require__(252),__webpack_require__(253),__webpack_require__(254),__webpack_require__(255),__webpack_require__(256),__webpack_require__(257),__webpack_require__(258),__webpack_require__(259),__webpack_require__(260),__webpack_require__(261),__webpack_require__(262),__webpack_require__(263),__webpack_require__(264),__webpack_require__(265),__webpack_require__(266),__webpack_require__(267),__webpack_require__(268),__webpack_require__(269),__webpack_require__(270),__webpack_require__(271),__webpack_require__(272),__webpack_require__(273),__webpack_require__(274),__webpack_require__(275),__webpack_require__(276),__webpack_require__(277),__webpack_require__(278),__webpack_require__(279),__webpack_require__(280),__webpack_require__(281),__webpack_require__(282),__webpack_require__(283),__webpack_require__(284),__webpack_require__(285),__webpack_require__(286),__webpack_require__(287),__webpack_require__(296),__webpack_require__(297),__webpack_require__(298),__webpack_require__(299),__webpack_require__(300),__webpack_require__(301)},function(module,exports){angular.module("rainbow").factory("AuthSettings",[function(){"use strict";function AuthSettings(authURLs){if(authURLs.length>0){if(1===authURLs.length)var authSettings=authURLs[0];else authSettings=authURLs.reduce((function(settings,authUrl){return"RAINBOW"===authUrl.type&&"RAINBOW"!==settings.type?(settings.safetyUrl=authUrl.url||authUrl.loginUrl,settings):(authUrl.safetyUrl=settings.url||settings.loginUrl,authUrl)}));this.type=authSettings.type,this.loginUrl=authSettings.url||authSettings.loginUrl,this.logoutUrl=authSettings.logoutUrl,this.safetyUrl=authSettings.safetyUrl}this.setParameter=function(name,fn){switch(name){case"uid":this.userId=fn();break;case"x-rainbow-app-auth":if("RAINBOW"!==this.type&&this.loginUrl){var appAuth=fn((url=new URL(this.loginUrl)).searchParams.get("challenge"));url.searchParams.append(name,appAuth),this.loginUrl=url.href}break;case"token":if("RAINBOW"!==this.type&&this.logoutUrl){var url=new URL(this.logoutUrl),tkn=fn();url.searchParams.append(name,tkn),this.logoutUrl=url.href}break;case"safetyUrl":"RAINBOW"===this.type||this.safetyUrl||(this.safetyUrl=fn())}}}return AuthSettings.createFromData=function(data){return new AuthSettings(data)},AuthSettings}])},function(module,exports){function RBError(message,details,detailsCode,detailsData){this.name="RainbowError",this.message=message,this.details=details,this.detailsCode=detailsCode,this.detailsData=detailsData,this.stack=(new Error).stack}RBError.prototype=Object.create(Error.prototype),RBError.prototype.constructor=RBError,window.RBError=RBError},function(module,exports){angular.module("rainbow").factory("Company",[function(){"use strict";function Company(data){var _this=this;Company.attributes.forEach((function(attribute){angular.isDefined(data[attribute.name])?_this[attribute.name]=data[attribute.name]:angular.isDefined(attribute.defaultValue)&&(_this[attribute.name]=attribute.defaultValue)})),this.state=data.state?data.state:"USA"===data.country?"AL":"CAN"===data.country?"AB":null,this.logo=null,this.filterName=this.name.toLowerCase(),this.updateFromData=function(newData){Company.attributes.forEach((function(attribute){angular.isDefined(newData[attribute.name])&&(_this[attribute.name]=newData[attribute.name])}))},this.nameForLogs="",this.isActive=function(){return"active"===this.status},this.isInitializing=function(){return"initializing"===this.status},this.isInvited=function(){return"invited"===this.status},this.isFreemium=function(){return"freemium"===this.offerType},this.isPremium=function(){return"premium"===this.offerType},this.isVAD=function(){return this.isBP&&"VAD"===this.bpType},this.isIR=function(){return this.isBP&&"IR"===this.bpType},this.isDR=function(){return this.isBP&&"DR"===this.bpType},this.isEC=function(){return!this.isBP}}return Company.createFromData=function(data){return new Company(data)},Company.create=function(id,name){return new Company({id:id,name:name})},Company.prune=function(data,userContact){var dataCopy=Object.assign({},data);return delete dataCopy.dataLocation,dataCopy.isBP||(delete dataCopy.bpType,delete dataCopy.bpBusinessModel,delete dataCopy.bpApplicantNumber,delete dataCopy.bpCRDid,delete dataCopy.bpHasRightToSell,delete dataCopy.bpHasRightToConnect,delete dataCopy.bpIsContractAccepted),userContact&&(userContact.isSuperadmin()||userContact.isBPAdminFinance())||(delete dataCopy.bpType,delete dataCopy.adminHasRightToUpdateSubscriptions,delete dataCopy.adminAllowedUpdateSubscriptionsOps),userContact&&userContact.isSuperadmin()||delete dataCopy.superadminComment,""===dataCopy.economicActivityClassification&&delete dataCopy.economicActivityClassification,userContact&&(userContact.isSuperadmin()||null!==dataCopy.supportEmail&&""!==dataCopy.supportEmail)||delete dataCopy.supportEmail,userContact&&(userContact.isSuperadmin()||null!==dataCopy.privateDC&&""!==dataCopy.privateDC)||delete dataCopy.privateDC,dataCopy},Company.StatusValues=["initializing","active","alerting","hold","terminated"],Company.VisibilityValuesWithOrganization=["public","private","organization","closed","isolated"],Company.VisibilityValues=["public","private","closed","isolated"],Company.SizeValues=["self-employed","1-10 employees","11-50 employees","51-200 employees","201-500 employees","501-1000 employees","1001-5000 employees","5001-10,000 employees","10,001+ employees"],Company.OfferTypes=["freemium","premium"],Company.BPTypes=["VAD","DR","IR"],Company.BPTypeLabels={IR:"Indirect Reseller",VAD:"Value Added Distributor",DR:"Direct Reseller"},Company.BPBusinessModels=["resell"],Company.BPBusinessModelLabels={resell:"Resell",referral:"Referral"},Company.adminAllowedUpdateSubscriptionsOperations=["all","increase_only"],Company.BPBusinessTypes={DEFAULT:"default",VOICE_BY_ALE:"voice_by_ale",VOICE_BY_PARTNER:"voice_by_partner",CONFERENCE:"conference"},Company.FileSharingCustomisationValues=["enabled","disabled"],Company.UserTitleNameCustomisationValues=["enabled","disabled"],Company.EconomicActivityClassificationTypes={NONE:"notDefined-f",A:"agriculture",B:"mining",C:"manufacturing",D:"electricity",E:"water supply",F:"construction",G:"wholesale",H:"transportation",I:"accommodation",J:"information and communication",K:"financial",L:"real estate activities",M:"professional",N:"administrative",O:"public administration",P:"education",Q:"human health",R:"arts",S:"other service activities",T:"activities of households as employer",U:"activities of extraterritorial organisations and bodies"},Company.PrivateDCValues=["HDS"],Company.attributes=[{name:"id",defaultValue:void 0},{name:"name",defaultValue:""},{name:"companyContactId",defaultValue:void 0},{name:"adminEmail",defaultValue:""},{name:"supportEmail",defaultValue:void 0},{name:"status",defaultValue:"active"},{name:"economicActivityClassification",defaultValue:"NONE"},{name:"website",defaultValue:void 0},{name:"description",defaultValue:void 0},{name:"visibility",defaultValue:"private"},{name:"visibleBy",defaultValue:[]},{name:"organisationId",defaultValue:""},{name:"userSelfRegisterEnabled",defaultValue:!1},{name:"userSelfRegisterAllowedDomains",defaultValue:[]},{name:"offerType",defaultValue:"freemium"},{name:"country",defaultValue:void 0},{name:"state",defaultValue:null},{name:"size",defaultValue:void 0},{name:"slogan",defaultValue:void 0},{name:"isBP",defaultValue:!1},{name:"bpType",defaultValue:void 0},{name:"bpBusinessModel",defaultValue:void 0},{name:"bpApplicantNumber",defaultValue:void 0},{name:"bpCRDid",defaultValue:void 0},{name:"bpHasRightToSell",defaultValue:void 0},{name:"bpId",defaultValue:void 0},{name:"bpHasRightToConnect",defaultValue:void 0},{name:"adminHasRightToUpdateSubscriptions",defaultValue:!1},{name:"adminAllowedUpdateSubscriptionsOps",defaultValue:"all"},{name:"externalReference",defaultValue:void 0},{name:"externalReference2",defaultValue:void 0},{name:"lastAvatarUpdateDate",defaultValue:null},{name:"lastBannerUpdateDate",defaultValue:null},{name:"avatarShape",defaultValue:"circle"},{name:"catalogId",defaultValue:void 0},{name:"office365Tenant",defaultValue:void 0},{name:"isCentrex",defaultValue:void 0},{name:"tenantCallNumber",defaultValue:void 0},{name:"tenantName",defaultValue:void 0},{name:"numberUsers",defaultValue:void 0},{name:"giphyEnabled",defaultValue:!0},{name:"dataLocation",defaultValue:void 0},{name:"privateDC",defaultValue:void 0},{name:"superadminComment",defaultValue:void 0},{name:"bpBusinessType",defaultValue:[]},{name:"voIPSettings",defaultValue:void 0},{name:"fileSharingCustomisation",defaultValue:void 0},{name:"userTitleNameCustomisation",defaultValue:void 0},{name:"tryNewUiCustomisation",defaultValue:void 0},{name:"softphoneOnlyCustomisation",defaultValue:void 0}],Company.prototype.getNameForLogs=function(){if(!this.nameForLogs&&this.name){var temp=this.name.replace(/[^\s](?=.{1,}$)/g,"*");this.nameForLogs=this.name.charAt(0)+temp.substr(1)}return this.nameForLogs},Company}]),angular.module("rainbow").filter("companyOfferFilter",[function(){"use strict";return function(input){return"freemium"===input?"Freemium":"premium"===input?"Premium":input?input.charAt(0).toUpperCase()+input.slice(1).toLowerCase():input}}])},function(module,exports){angular.module("rainbow").factory("CompanyInvitation",[function(){"use strict";function CompanyInvitation(id,companyId,companyName,invitedUserId,invitedUserEmail,invitingAdminId,invitingAdminLoginEmail,invitationDate,lastNotificationDate,requestedNotificationLanguage,status,acceptationDate,declinationDate,invitedToBeCompanyAdmin){this.id=id,this.companyId=companyId,this.companyName=companyName,this.invitedUserId=invitedUserId,this.invitedUserEmail=invitedUserEmail,this.invitingAdminId=invitingAdminId,this.invitingAdminLoginEmail=invitingAdminLoginEmail,this.invitationDate=invitationDate,this.lastNotificationDate=lastNotificationDate,this.requestedNotificationLanguage=requestedNotificationLanguage,this.status=status,this.acceptationDate=acceptationDate,this.declinationDate=declinationDate,this.invitedToBeCompanyAdmin=invitedToBeCompanyAdmin}return CompanyInvitation.createFromData=function(data){return new CompanyInvitation(data.id,data.companyId,data.companyName,data.invitedUserId,data.invitedUserEmail,data.invitingAdminId,data.invitingAdminLoginEmail,data.invitationDate,data.lastNotificationDate,data.requestedNotificationLanguage,data.status,data.acceptationDate,data.declinationDate,data.invitedToBeCompanyAdmin)},CompanyInvitation}])},function(module,exports){class FileState{}FileState.DELETED="deleted",FileState.UPLOADING="uploading",FileState.UPLOADED="uploaded",FileState.NOT_UPLOADED="not_uploaded",FileState.DOWNLOADING="downloading",FileState.UNKNOWN="unknown";class ThumbnailPlaceholder{constructor(icon,style){this.icon=icon,this.style=style}}class Thumbnail{constructor(data){data?(this.availableThumbnail=data.availableThumbnail,this.md5sum=data.md5sum,this.size=data.size,this.wantThumbnailDate=data.wantThumbnailDate):this.availableThumbnail=!1}isThumbnailAvailable(){return this.availableThumbnail}}class FileDescriptor{constructor(id=null,url=null,ownerId=null,fileName=null,extension=null,typeMIME=null,size=null,registrationDate=null,uploadedDate=null,dateToSort=null,viewers=null,state=null,thumbnail=null,orientation=0,tags=null,virusScanState=null,voiceMessage=!1){this.id=id,this.url=url,this.ownerId=ownerId,this.fileName=fileName,this.extension=extension,this.typeMIME=typeMIME,this.thumbnailPlaceholder=this.getThumbnailPlaceholderFromMimetype(typeMIME),this.size=size,this.registrationDate=registrationDate,this.uploadedDate=uploadedDate,this.dateToSort=dateToSort,this.viewers=viewers,this.state=state,this.thumbnail=new Thumbnail(thumbnail),this.fileToSend=void 0,this.previewBlob=void 0,this.tags=tags,this.orientation=orientation||void 0,this.virusScanState=virusScanState,this.voiceMessage=voiceMessage}isMicrosoftFile(){return["docx","doc","ppt","pptx","xls","xlsx"].some(ext=>ext===this.extension)}isThumbnailPossible(){return this.isImage()||this.isPDF()}isPDF(){return"application/pdf"===this.typeMIME}isImage(){return this.typeMIME&&this.typeMIME.length>="image/".length&&"image/"===this.typeMIME.slice(0,"image/".length)}isAudioVideo(){return["avi","mpg","wma","mp3","wmv","mkv","mov","wav","ogg","mp4","aac"].some(ext=>ext===this.extension)}isUploaded(){return this.state&&this.state===FileState.UPLOADED}isAlreadyFileViewer(viewerId){return!(!this.ownerId||this.ownerId!==viewerId)||!!this.viewers&&this.viewers.some(viewer=>viewer.viewerId===viewerId)}getDisplayName(){return this.fileName.replace(/\.[^/.]+$/,"")}getDisplayNameTruncated(){var str=this.fileName.replace(/\.[^/.]+$/,"");return[str.substring(0,str.length-4),str.slice(-4)]}getExtension(){return this.fileName.toUpperCase()===this.extension.toUpperCase()?"":"."+this.extension}getThumbnailPlaceholderFromMimetype(mime){return mime?0===mime.indexOf("image")?new ThumbnailPlaceholder("icon_image","imageStyle"):"application/msword"===mime||/^application\/vnd.openxmlformats-officedocument.wordprocessingml.*$/.test(mime)||"application/vnd.oasis.opendocument.text"===mime?new ThumbnailPlaceholder("icon_doc","docStyle"):/^application\/vnd.ms-powerpoint.*$/.test(mime)||/^application\/vnd.openxmlformats-officedocument.presentationml.*$/.test(mime)||"application/vnd.oasis.opendocument.presentation"===mime?new ThumbnailPlaceholder("icon_ppt","pptStyle"):0===mime.indexOf("application/vnd.ms-excel")||/^application\/vnd.openxmlformats-officedocument.spreadsheetml.*$/.test(mime)?new ThumbnailPlaceholder("icon_xls","xlsStyle"):"application/pdf"===mime||"application/vnd.oasis.opendocument.spreadsheet"===mime?new ThumbnailPlaceholder("icon_pdf","pdfStyle"):0===mime.indexOf("video/")||0===mime.indexOf("audio/")?new ThumbnailPlaceholder("icon_file-video","imageStyle"):new ThumbnailPlaceholder("icon_filestandard","otherStyle"):new ThumbnailPlaceholder("icon_filestandard","otherStyle")}releaseURL(){this.localURL=void 0}}angular.module("rainbow").factory("fileDescriptorFactory",[function(){return(id,url,ownerId,fileName,extension,typeMIME,size,registrationDate,uploadedDate,dateToSort,viewers,state,thumbnail,orientation,tags,virusScanState,voiceMessage)=>new FileDescriptor(id,url,ownerId,fileName,extension,typeMIME,size,registrationDate,uploadedDate,dateToSort,viewers,state,thumbnail,orientation,tags,virusScanState,voiceMessage)}])},function(module,exports){class FileViewerType{}FileViewerType.USER="user",FileViewerType.ROOM="room";class FileViewer{constructor(viewerId,type,contact,contactService=null,channelService=null){this.contactService=contactService,this.channelService=channelService,this.viewerId=viewerId,this.type=type,this.contact=contact}get avatarSrc(){if("user"===this.type&&this.contact)this._avatarSrc=this.contact.avatar.src;else if("channel"===this.type&&this.channel)this._avatarSrc=this.channel.getAvatarSrc();else if(this._avatarSrc=null,"user"===this.type&&this.contactService.getContactByDBId(this.viewerId).then(contact=>{this.contact=contact,this._avatarSrc=this.contact.avatar.src}),"channel"===this.type){let channel=this.channelService.getChannelFromCache(this.viewerId,!1);channel&&(this.channel=channel,this._avatarSrc=this.channel.getAvatarSrc())}return this._avatarSrc}}angular.module("rainbow").factory("fileViewerFactory",[function(){return data=>{let viewers=[];for(let viewerData of data)viewers.push(new FileViewer(viewerData.viewerId,viewerData.type,viewerData.contact,viewerData.contactService,viewerData.channelService));return viewers}}]),angular.module("rainbow").factory("fileViewerElementFactory",[function(){return(viewerId,type,contact,contactService,channelService)=>new FileViewer(viewerId,type,contact,contactService,channelService)}])},function(module,exports){angular.module("rainbow").factory("CompanyRequest",[function(){"use strict";function CompanyRequest(id,requestingUserId,requestingUserLoginEmail,requestedCompanyId,requestedCompanyName,status,requestingDate,requestedNotificationLanguage,lastNotificationDate,requestedToCompanyAdmin,requestedCompanyInvitationId){this.id=id,this.requestingUserId=requestingUserId,this.requestingUserLoginEmail=requestingUserLoginEmail,this.requestedCompanyId=requestedCompanyId,this.requestedCompanyName=requestedCompanyName,this.status=status,this.requestingDate=requestingDate,this.requestedNotificationLanguage=requestedNotificationLanguage,this.lastNotificationDate=lastNotificationDate,this.requestedToCompanyAdmin=requestedToCompanyAdmin,this.requestedCompanyInvitationId=requestedCompanyInvitationId}return CompanyRequest.createFromData=function(data){return new CompanyRequest(data.id,data.requestingUserId,data.requestingUserLoginEmail,data.requestedCompanyId,data.requestedCompanyName,data.status,data.requestingDate,data.requestedNotificationLanguage,data.lastNotificationDate,data.requestedToCompanyAdmin,data.requestedCompanyInvitationId)},CompanyRequest}])},function(module,exports){angular.module("rainbow").factory("CompanyBpLinkInvitation",[function(){"use strict";function CompanyBpLinkInvitation(id,invitedCompanyId,invitedCompanyName,invitedToBeBpIr,invitingAdminId,invitingAdminLoginEmail,invitingCompanyId,invitingCompanyName,invitationDate,lastNotificationDate,requestedNotificationLanguage,status,acceptationDate,cancelationDate,declinationDate){this.id=id,this.invitedCompanyId=invitedCompanyId,this.invitedCompanyName=invitedCompanyName,this.invitedToBeBpIr=invitedToBeBpIr,this.invitingAdminId=invitingAdminId,this.invitingAdminLoginEmail=invitingAdminLoginEmail,this.invitingCompanyId=invitingCompanyId,this.invitingCompanyName=invitingCompanyName,this.invitationDate=invitationDate,this.lastNotificationDate=lastNotificationDate,this.requestedNotificationLanguage=requestedNotificationLanguage,this.status=status,this.acceptationDate=acceptationDate,this.cancelationDate=cancelationDate,this.declinationDate=declinationDate}return CompanyBpLinkInvitation.createFromData=function(data){return new CompanyBpLinkInvitation(data.id,data.invitedCompanyId,data.invitedCompanyName,data.invitedToBeBpIr,data.invitingAdminId,data.invitingAdminLoginEmail,data.invitingCompanyId,data.invitingCompanyName,data.invitationDate,data.lastNotificationDate,data.requestedNotificationLanguage,data.status,data.acceptationDate,data.cancelationDate,data.declinationDate)},CompanyBpLinkInvitation}])},function(module,exports){angular.module("rainbow").factory("CompanyBpLinkRequest",[function(){"use strict";function CompanyBpLinkRequest(id,requestingAdminId,requestingAdminLoginEmail,requestingCompanyId,requestingCompanyName,requestedCompanyId,requestedCompanyName,requestedToBeBpIr,requestDate,lastNotificationDate,requestedNotificationLanguage,status,acceptationDate,cancelationDate,declinationDate){this.id=id,this.requestingAdminId=requestingAdminId,this.requestingAdminLoginEmail=requestingAdminLoginEmail,this.requestingCompanyId=requestingCompanyId,this.requestingCompanyName=requestingCompanyName,this.requestedCompanyId=requestedCompanyId,this.requestedCompanyName=requestedCompanyName,this.requestedToBeBpIr=requestedToBeBpIr,this.requestDate=requestDate,this.lastNotificationDate=lastNotificationDate,this.requestedNotificationLanguage=requestedNotificationLanguage,this.status=status,this.acceptationDate=acceptationDate,this.cancelationDate=cancelationDate,this.declinationDate=declinationDate}return CompanyBpLinkRequest.createFromData=function(data){return new CompanyBpLinkRequest(data.id,data.requestingAdminId,data.requestingAdminLoginEmail,data.requestingCompanyId,data.requestingCompanyName,data.requestedCompanyId,data.requestedCompanyName,data.requestedToBeBpIr,data.requestDate,data.lastNotificationDate,data.requestedNotificationLanguage,data.status,data.acceptationDate,data.cancelationDate,data.declinationDate)},CompanyBpLinkRequest}])},function(module,exports){angular.module("rainbow").factory("Conference",[function(){"use strict";function Conference(companyId,id,mediaType,name,passCodes,scheduled,lastUpdateDate,userId,confDialOutDisabled,playEntryTone,muteUponEntry){this.companyId=companyId,this.id=id,this.mediaType=mediaType,this.name=name,this.passCodes=passCodes||[],this.scheduled=scheduled,this.lastUpdateDate=lastUpdateDate,this.userId=userId,this.confDialOutDisabled=confDialOutDisabled,this.playEntryTone=playEntryTone,this.muteUponEntry=muteUponEntry,this.updateFromData=function(data){this.companyId=data.companyId,this.id=data.id,this.mediaType=data.mediaType,this.name=data.name,this.passCodes=data.passCodes,this.scheduled=data.scheduled,this.lastUpdateDate=data.lastUpdateDate,this.userId=data.userId,this.confDialOutDisabled=data.confDialOutDisabled,this.playEntryTone=data.playEntryTone,this.muteUponEntry=data.muteUponEntry}}return Conference.createFromData=function(data){return new Conference(data.companyId,data.id,data.mediaType,data.name,data.passCodes,data.scheduled,data.lastUpdateDate,data.userId,data.confDialOutDisabled,data.playEntryTone,data.muteUponEntry)},Conference}])},function(module,exports){angular.module("rainbow").factory("ConferenceSession",["$log","ConferenceParticipant","contactService","$q",function($log,ConferenceParticipant,contactService,$q){"use strict";function ConferenceSession(_id,_participants,_active,_type){var that=this;that.id=_id,that.participants=_participants,that.active=_active,that.talkerActive=void 0,that.recordingStarted=void 0,that.talkers=void 0,that.isLeaderAlreadyConnected=!1,that.status=null,that.localStreams=[],that.sessions={},that.publishers=[],that.type=_type,that.callId=null,that.hasLocalVideo=!1,that.jingleJid=null,that.localVideoSessionId=null,that.localSharingSessionId=null,that.haveJoined=!1,that.lock=!1,that.cleanupSessionData=function(){$log.debug("[ConferenceSession] Cleanup for conferenceSession "+that.id),that.participants=[],that.talkerActive=void 0,that.recordingStarted=void 0,that.talkers=void 0,that.isLeaderAlreadyConnected=!1,that.localStreams=[],that.sessions={},that.publishers=[],that.hasLocalVideo=!1,that.metricsState="",that.recordingStarted=!1,that.status="ended",that.hasLocalSharing=!1,that.reversedVideos=!1,that.jingleJid=null,that.localVideoSessionId=null,that.localSharingSessionId=null,that.haveJoined=!1,that.lock=!1},that.updateFromData=function(id,participants,active){that.id=id,that.participants=participants,that.active=active},that.updateActiveState=function(active){that.active=active},that.updateStateFromData=function(active,talkerActive,recordingStarted,lock){that.active=active,that.talkerActive=talkerActive,that.recordingStarted=recordingStarted,that.lock=lock},that.updateParticipants=function(participantsData){return $q((function(resolve){var result=!1;participantsData||resolve(!1),that.participants||(that.participants=[]),0===participantsData.length&&(that.participants=[]),participantsData.forEach((function(participantData){if(participantData.participantId){$log.debug("[conferenceSession] updateParticipants participantId="+participantData.participantId);var existingParticipant=that.getParticipantById(participantData.participantId)?that.getParticipantById(participantData.participantId):participantData.jid_im?that.getParticipantByJid(participantData.jid_im):null;existingParticipant?($log.debug("[conferenceSession] updateParticipants update participantId="+participantData.participantId),existingParticipant.updateFromData(participantData)):($log.debug("[conferenceSession] updateParticipants create participantId="+participantData.participantId),that.participants.push(ConferenceParticipant.createFromData(participantData)),result=!0)}})),resolve(result)}))},that.removeParticipants=function(removedParticipants){removedParticipants&&removedParticipants.forEach((function(removedParticipantId){var removedParticipantIndex=that.getParticipantIndexById(removedParticipantId);-1!==removedParticipantIndex&&($log.debug("[conferenceSession] removeParticipants remove participantId="+removedParticipantId),that.participants.splice(removedParticipantIndex,1))}))},that.removePublisher=function(removedPublisherId){if(removedPublisherId){var removedPublisherIndex=that.getPublisherIndexById(removedPublisherId);-1!==removedPublisherIndex&&($log.debug("[conferenceSession] removePublisher remove participantId="+removedPublisherId),that.publishers.splice(removedPublisherIndex,1))}},that.updateTalkers=function(talkers){$log.debug("[conferenceSession] updateTalkers talkers="+talkers),that.talkers=talkers},that.isActive=function(){return void 0!==that.active&&that.active},that.isTalkerActive=function(){return void 0!==that.talkerActive&&that.talkerActive},that.isRecordingStarted=function(){return void 0!==that.recordingStarted&&that.recordingStarted},that.getParticipants=function(){return that.participants},that.getConnectedParticipants=function(){return that.participants?that.participants.filter((function(participant){return"disconnected"!==participant.state&&"watching"!==participant.state})):void 0},that.getWatchingParticipants=function(){return that.participants?that.participants.filter((function(participant){return"watching"===participant.state})):void 0},that.getConnectedParticipantsExceptLeader=function(){return that.participants?that.participants.filter((function(participant){return"disconnected"!==participant.state&&"watching"!==participant.state&&"moderator"!==participant.role})):void 0},that.getConnectedLeaderParticipantsExcept=function(jid){return that.participants?that.participants.filter((function(participant){return"disconnected"!==participant.state&&"moderator"===participant.role&&participant.jid_im!==jid})):void 0},that.getConnectedParticipantsExcept=function(jid){return that.participants?that.participants.filter((function(participant){return participant.jid_im!==jid&&"disconnected"!==participant.state&&"watching"!==participant.state})):void 0},that.getLeaderParticipant=function(){return that.participants?that.participants.find((function(participant){return"moderator"===participant.role&&"disconnected"!==participant.state&&"watching"!==participant.state})):void 0},that.getLeaderParticipantById=function(jid){return that.participants?that.participants.find((function(participant){return"moderator"===participant.role&&"disconnected"!==participant.state&&"watching"!==participant.state&&participant.jid_im===jid})):void 0},that.getParticipantById=function(participantId){return that.participants?that.participants.find((function(participant){return participant.participantId===participantId})):void 0},that.getParticipantByJid=function(jid){return that.participants?that.participants.find((function(participant){return participant.jid_im===jid})):void 0},that.getNonDisconnectedParticipantByJid=function(jid){return that.participants?that.participants.find((function(participant){return participant.jid_im===jid&&"disconnected"!==participant.state})):void 0},that.getConnectedParticipantByJid=function(jid){return that.participants?that.participants.find((function(participant){return participant.jid_im===jid&&"connected"===participant.state})):void 0},that.getWatchingParticipantByJid=function(jid){return that.participants?that.participants.find((function(participant){return participant.jid_im===jid&&"watching"===participant.state})):void 0},that.getParticipantIndexById=function(participantId){return that.participants?that.participants.findIndex((function(participant){return participant.participantId===participantId})):-1},that.getPublisherIndexById=function(publisherId){return that.publishers?that.publishers.findIndex((function(publisher){return publisher.participantId===publisherId})):-1},that.isParticipantConnectedByJid=function(jid){return void 0!==that.participants&&that.participants.some((function(participant){return participant.jid_im===jid&&"connected"===participant.state}))},that.isParticipantWatchingByJid=function(jid){return void 0!==that.participants&&that.participants.some((function(participant){return participant.jid_im===jid&&"watching"===participant.state}))},that.isParticipantRingingByJid=function(jid){return void 0!==that.participants&&that.participants.some((function(participant){return participant.jid_im===jid&&"ringing"===participant.state}))},that.isParticipantConnectedWithThisUAByJid=function(jid){return that.haveJoined&&void 0!==that.participants&&that.participants.some((function(participant){return participant.jid_im===jid&&"connected"===participant.state}))},that.getTalkers=function(){return that.talkers},that.setCallId=function(callId){that.callId=callId},that.getListOfRemoteVideoPublishers=function(){var result=[];if(that.publishers)for(var i=0;i<that.publishers.length;i++)"video"===that.publishers[i].mediaType&&that.publishers[i].jid_im!==contactService.userContact.jid&&result.push(that.publishers[i]);return result}}return ConferenceSession.createFromData=function(id,participants,active,type){return type||(type="pstnAudio"),new ConferenceSession(id,participants,active,type)},ConferenceSession}])},function(module,exports){angular.module("rainbow").factory("ConferenceParticipant",[function(){"use strict";function ConferenceParticipant(participantId,userId,jid_im,jid_tel,role,mute,held,confStartDate,startDate,phoneNumber,state){this.participantId=participantId,this.userId=userId,this.jid_im=jid_im,this.jid_tel=jid_tel,this.role=role,this.mute=mute,this.held=held,this.confStartDate=confStartDate,this.startDate=startDate,this.phoneNumber=phoneNumber,this.state=state,this.updateFromData=function(data){data.participantId&&(this.participantId=data.participantId),data.userId&&(this.userId=data.userId),this.jid_im=data.jid_im,data.jid_tel&&(this.jid_tel=data.jid_tel),this.role=data.participantRole?data.participantRole:this.role,this.confStartDate=data.confStartDate?data.confStartDate:this.confStartDate,this.startDate=data.startDate?data.startDate:this.startDate,this.phoneNumber=data.phoneNumber?data.phoneNumber:this.phoneNumber,this.state=data.participantState?data.participantState:this.state,this.mute=data.mute,this.held=data.held}}return ConferenceParticipant.createFromData=function(data){return new ConferenceParticipant(data.participantId,data.userId,data.jid_im,data.jid_tel,data.participantRole,data.mute,data.held,data.confStartDate,data.startDate,data.phoneNumber,data.participantState)},ConferenceParticipant}])},function(module,exports){class Channel{constructor(name,id,visibility,topic,creatorId,companyId,creationDate,users_count,lastAvatarUpdateDate,subscribed,type,invited,category,mode,subscribers_count){this.userRole="none",this.messageRetrieved=!1,this.messages=[],this.subscribed=!1,this.deleted=!1,this.invited=!1,this.type="SIMPLE",this.pageIndex=0,this.isLoading=!1,this.complete=!1,this.users=[],this.publishersRetreived=!1,this.loaded=!1,this.name=name,this.id=id,this.visibility=visibility,this.topic=topic,this.creatorId=creatorId,this.companyId=companyId,this.creationDate=creationDate,this.type=type,this.users_count=users_count,this.subscribers_count=subscribers_count,this.category=category,this.mode=mode,this.lastAvatarUpdateDate=lastAvatarUpdateDate;let timestamp=this.lastAvatarUpdateDate?"&ts="+new Date(this.lastAvatarUpdateDate).getTime():"";if(this.avatar=config.restServerUrl+"/api/channel-avatar/"+id+"?size=256"+timestamp,void 0!==subscribed&&(this.subscribed=subscribed),void 0!==type&&(this.userRole=type),void 0!==invited&&(this.invited=invited),!this.mode)switch(this.visibility){case"company":this.mode="company_public";break;case"public":this.mode="all_public";break;case"private":this.mode="company_private"}}isNotMember(){return this.userRole="none"}isOwner(){return"owner"===this.userRole}isPublisher(){return this.subscribed&&("owner"===this.userRole||"publisher"===this.userRole)}isMember(){return"member"===this.userRole}getAvatarSrc(){return this.lastAvatarUpdateDate?this.avatar:"/resources/skins/rainbow/images/channels/default_channel_avatar.png"}static ChannelFactory(){return data=>new Channel(data.name,data.id,data.visibility,data.topic,data.creatorId,data.companyId,data.creationDate,data.users_count,data.lastAvatarUpdateDate,data.subscribed,data.type,data.invited,data.category,data.mode,data.subscribers_count)}}angular.module("rainbow").factory("Channel",Channel.ChannelFactory)},function(module,exports){class SearchTextMsgResult{constructor(){this.body=void 0,this.date=void 0,this.isRoom=!1,this.isSent=!1,this.messageId=void 0}static SearchTextMsgResultFactory(){return()=>new SearchTextMsgResult}}class SearchTextResult{constructor(convId){this.room=null,this.contact=null,this.totalCount=-1,this.convRes=[],this.otherJid=convId}getResultFromMsgId(msgId){for(let item of this.convRes)if(item.messageId===msgId)return item}addMsgItem(msgItem){this.convRes.push(msgItem)}isRoom(){return this.conversation?null!=this.conversation.room:null!==this.room}}class SearchTextConvResults{constructor(){this.searchedText="",this.results=[],this.queryIds=[],this.totalCount=0,this.searchCounter=0}isEmpty(){return 0===this.queryIds.length||0===Object.keys(this.results).length}searchCount(){this.searchCounter++}getAvailableCount(){let count=0;for(let item of this.results)count+=item.convRes.length;return count}getTotalCount(){return this.totalCount}clearAll(){this.queryIds=[],this.totalCount=0,this.clearMessagesResults()}clearMessagesResults(){this.results.splice(0,this.results.length)}isCurrentQuery(queryId){return this.queryIds.indexOf(queryId)>-1}getItemForConvId(convJid){for(let item of this.results)if(item.otherJid===convJid)return item}createNewResult(convJid){let currentConvResults=this.getItemForConvId(convJid);return currentConvResults||(currentConvResults=new SearchTextResult(convJid),this.results.push(currentConvResults)),currentConvResults}addNewItemResult(convJid,searchTextItem){let currentConvResults=this.getItemForConvId(convJid);currentConvResults||(currentConvResults=new SearchTextResult(convJid),this.results.push(currentConvResults)),currentConvResults.getResultFromMsgId(searchTextItem.messageId)||currentConvResults.addMsgItem(searchTextItem)}splitText(text,searchFilter){var textStart="",textColored="",textEnd="",textSimplified=this.cleanUpSpecialChars(text).toLowerCase(),searchFilterSimplified=this.cleanUpSpecialChars(searchFilter).toLowerCase(),index=textSimplified.indexOf(searchFilterSimplified);return index>=0?(index>0&&(textStart=text.slice(0,index)),textColored=text.slice(index,index+searchFilter.length),text.length>searchFilter.length+index&&(textEnd=text.slice(index+searchFilter.length,text.length))):textStart=text,[textStart,textColored,textEnd]}cleanUpSpecialChars(str){return str=(str=(str=(str=(str=(str=(str=(str=(str=(str=str.replace(/[]/g,"A")).replace(/[]/g,"a")).replace(/[]/g,"E")).replace(/[]/g,"e")).replace(/[]/g,"I")).replace(/[]/g,"i")).replace(/[]/g,"O")).replace(/[]/g,"o")).replace(/[]/g,"u")).replace(/[]/g,"c")}}angular.module("rainbow").factory("SearchTextConvResultsFactory",(function(){return()=>new SearchTextConvResults})),angular.module("rainbow").factory("SearchTextMsgResultFactory",SearchTextMsgResult.SearchTextMsgResultFactory)},function(module,exports){angular.module("rainbowAdmin").factory("Offer",[function(){"use strict";function Offer(id,name,description,groupName,offerReference,profileId,canBeSold,businessModel,isDefault,isExclusive,isPrepaid,prepaidDuration,autoSubscribe,hasConference,hasVoice,isDemo,isBundle,isChinaOffer){this.id=id,this.name=name||"",this.description=description||"Rainbow "+this.name,this.groupName=hasConference?"Conference":groupName||name,this.offerReference=offerReference,this.profileId=profileId,this.canBeSold=canBeSold||!1,this.businessModel=businessModel,this.isDefault=isDefault,this.isExclusive=isExclusive,this.isPrepaid=isPrepaid,this.prepaidDuration=prepaidDuration,this.autoSubscribe=autoSubscribe,this.hasConference=hasConference,this.hasVoice=hasVoice,this.isDemo=void 0===isDemo?!this.isDefault&&!this.canBeSold&&this.name.toLowerCase().includes("demo"):isDemo,this.isBundle=isBundle,this.isChinaOffer=isChinaOffer,this.disallowUnsubscribeWithAllocatedLicences=this.hasVoice||"Room"===this.groupName,this.disallowAllocationToUsers="Room"===this.groupName,this.hasVoice?this.logo="logo-offer-voice.svg":this.hasConference?this.logo="logo-offer-conference.svg":this.logo=Offer.getLogoByName(this.name),this.isEnterprise=function(){return this.name.toLowerCase().startsWith("enterprise")},this.isBusiness=function(){return this.name.toLowerCase().startsWith("business")},this.isEssential=function(){return this.isDefault},this.isTrial=function(){return this.isDemo},this.isUserLicense=function(){return this.isDefault||"nb_users"===this.businessModel||"usage"===this.businessModel},this.isDeviceLicense=function(deviceType){return"TV"===deviceType&&"Room"===this.groupName},this.isFixedLicense=function(){return"flat_fee"===this.businessModel},this.isUserBasedLicense=function(){return"nb_users"===this.businessModel},this.isUsageBasedLicense=function(){return"usage"===this.businessModel}}return Offer.createFromData=function(data){return new Offer(data.id,data.name,data.description,data.groupName,data.offerReference,data.profileId,data.canBeSold,data.businessModel,data.isDefault,data.isExclusive,data.isPrepaid,data.prepaidDuration,data.autoSubscribe,data.hasConference,data.hasVoice,data.isDemo,data.isBundle,data.isChinaOffer)},Offer.createFromSubscriptionData=function(subscription){return new Offer(subscription.offerId,subscription.offerName,subscription.offerDescription,subscription.groupName,subscription.offerReference,subscription.profileId,subscription.canBeSold,subscription.businessModel,subscription.isDefault,subscription.isExclusive,subscription.isPrepaid,subscription.prepaidDuration,subscription.autoSubscribe,subscription.hasConference,subscription.hasVoice,subscription.isDemo,subscription.isBundle,subscription.isChinaOffer)},Offer.createFromSubscriptionCountersData=function(subscriptionCounters){return new Offer(subscriptionCounters.offerId,subscriptionCounters.offerName,void 0,subscriptionCounters.groupName,subscriptionCounters.offerReference,void 0,subscriptionCounters.canBeSold,subscriptionCounters.businessModel,subscriptionCounters.isDefault,subscriptionCounters.isExclusive,subscriptionCounters.isPrepaid,subscriptionCounters.prepaidDuration,void 0,subscriptionCounters.hasConference,subscriptionCounters.hasVoice,subscriptionCounters.isDemo,subscriptionCounters.isBundle)},Offer.createFromProfileData=function(profile){return new Offer(profile.offerId,profile.offerName,void 0,void 0,void 0,profile.profileId,!1,void 0,profile.isDefault,profile.isExclusive,profile.isPrepaid,profile.prepaidDuration,void 0,profile.hasConference,profile.hasVoice,profile.isDemo,profile.isBundle)},Offer.createFromOperationLog=function(operationLog){var data="delete"===operationLog.operationType?operationLog.previousData:operationLog.newData;return new Offer(data.offerId,data.offerName,data.offerDescription,void 0,data.offerReference,data.profileId,data.canBeSold,data.businessModel,data.isDefault,data.isExclusive,data.isPrepaid,data.prepaidDuration,void 0,data.hasConference,data.hasVoice,data.isDemo,data.isBundle)},Offer.getLogoByName=function(offerName){var logo="logo-offer-default.svg";if(offerName){var name=offerName.toLowerCase();-1!==name.indexOf("voice")?name="voice":-1!==name.indexOf("conference")?name="conference":-1!==name.indexOf("enterprise")?name="enterprise":-1!==name.indexOf("business")&&(name="business"),logo="logo-offer-"+name+".svg"}return logo},Offer.offerComparator=function(offer1,offer2){var offerOrder=["Essential","Business","Enterprise","Voice","Room","Conference"];if(offer1.isEssential())return-1;if(offer2.isEssential())return 1;if(offer1.isTrial()&&!offer2.isTrial())return-1;if(!offer1.isTrial()&&offer2.isTrial())return 1;if(offer1.hasConference&&!offer2.hasConference)return 1;if(!offer1.hasConference&&offer2.hasConference)return-1;var orderIndex1=offerOrder.findIndex((function(order){return offer1.name.startsWith(order)})),orderIndex2=offerOrder.findIndex((function(order){return offer2.name.startsWith(order)}));return(orderIndex1=-1===orderIndex1?offerOrder.length:orderIndex1)<(orderIndex2=-1===orderIndex2?offerOrder.length:orderIndex2)?-1:orderIndex1>orderIndex2?1:offer1.isTrial()?-1:offer2.isTrial()?1:offer1.isPrepaid&&!offer2.isPrepaid?1:!offer1.isPrepaid&&offer2.isPrepaid?-1:offer1.name<offer2.name?-1:offer1.name>offer2.name?1:0},Offer.isExclusive=function(offer){return offer.isDefault||offer.isExclusive},Offer.isOptional=function(offer){return!Offer.isExclusive(offer)},Offer.isEssential=function(offer){return offer.isDefault},Offer.isNotEssential=function(offer){return!offer.isDefault},Offer.isModelByNbUsers=function(offer){return"nb_users"===offer.businessModel},Offer.isPrepaid=function(offer){return offer.isPrepaid},Offer.isNotPrepaid=function(offer){return!offer.isPrepaid},Offer.isUserLicense=function(offer){return offer.isUserLicense()},Offer.isUsageBasedLicense=function(offer){return offer.isUsageBasedLicense()},Offer}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var crypto_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3);angular.module("rainbow").factory("Contact",["$q","$rootScope","$interval","$document","$translate","$sce","settingsService","Company","$log","xmppService","authService","utilService",function($q,$rootScope,$interval,$document,$translate,$sce,settingsService,Company,$log,xmppService,authService,utilService){function Contact(jid,name,company){var that=this;this.id=jid,this.jid=jid,this.fullJid=null,this.jidtel=null,this.dbId=null,this.login=null,this.temp=!1,this.status="unknown",this.telStatus="",this.imStatus="offline",this.imStatusStamp=[],this.resources={},this.loginEmail="",this.lastname="",this.firstname="",this.company=company,this.nickname="",this.title="",this.jobTitle="",this.country="",this.defaultAvatar=null,this._avatar=null,this._avatarLoading=!1,this.avatarSrc=null,this.timezone="",this.roles=null,this.confId="",this.phonePro="",this.phoneProCan="",this.phonePbx="",this.phoneInternalNumber="",this.pbxId="",this.mobilePro="",this.mobileProCan="",this.isMobileProShared=!1,this.phonePerso="",this.isPhonePersoShared=!1,this.phonePersoCan="",this.mobilePerso="",this.isMobilePersoShared=!1,this.mobilePersoCan="",this.emailPro="",this.emailPerso="",this.oldImStatus=null,this.roster=!1,this.initialized=!1,this._displayName=name||jid,this.name={value:this._displayName},this.initials="",this.message="",this.cellStyle="",this.ask="none",this.subscription="none",this.conversation=null,this.adminType=null,this.capabilities=null,this.groups=null,this.mobileResource=null,this.language=null,this.lastActivityDate=null,this.nameUpdatePrio=Contact.NameUpdatePrio.MAX_UPDATE_PRIO,this.isInDefaultCompany=!1,this.calendarState={},this.guest=!1,this.isVirtualTerm=!1,this.nameForLogs="",this.systDeviceName=null,this.isTv=!1,this.rainbowTvData={},this.fileSharingEnabled=!0,this.userTitleNameEnabled=!0,this.tags=null,$rootScope.$on("$destroy",$rootScope.$on("ON_DISPLAY_ORDER_EVENT",(function(){that.computeDisplayName()}))),$rootScope.$on("$destroy",$rootScope.$on("ON_DISPLAY_ORDER_EVENT",(function(){that.computeDisplayName()})))}return Contact.create=function(jid,firstname,lastname,company,login){var contact=new Contact(jid,null,company);return firstname&&lastname&&(firstname=firstname.charAt(0).toUpperCase()+firstname.slice(1),lastname=lastname.charAt(0).toUpperCase()+lastname.slice(1),contact.computeCompleteDisplayName(firstname,lastname)),contact.login=login,contact},Contact.createByPhoneNumber=function(phoneNumber){var contact=new Contact(null,phoneNumber);return contact.id=phoneNumber,contact},Contact.createBotContact=function(jid,botName,id,botAvatarUrl){var contact=new Contact(jid),image=new Image;return window.rainbowSDK?image=null:image.src=botAvatarUrl,contact.lastname=botName,contact.isBot=!0,contact.computeDisplayName(),contact.status="online",contact.imStatus="online",contact.subscription="both",contact.avatar=image,contact.dbId=id,contact},Contact.updateContactToBot=function(contact,name,id,botAvatarUrl){var image=new Image;return window.rainbowSDK?image=null:image.src=botAvatarUrl,contact.lastname=name,contact.isBot=!0,contact.computeDisplayName(),contact.status="online",contact.imStatus="online",contact.subscription="both",contact.avatar=image,contact.dbId=id,contact},Contact.AdminType={ORGANIZATION_ADMIN:"organization_admin",COMPANY_ADMIN:"company_admin",SITE_ADMIN:"site_admin",UNDEFINED:"undefined"},Contact.NameUpdatePrio={NO_UPDATE_PRIO:0,OUTLOOK_UPDATE_PRIO:1,SERVER_UPDATE_PRIO:2,MAX_UPDATE_PRIO:99},Object.defineProperty(Contact.prototype,"avatar",{set:function(avatar){this._avatar=avatar},get:function(){var that=this;if(that._avatar)return that._avatar;if(!that._avatarLoading&&that.avatarSrc){that._avatarLoading=!0;var image=new Image;image.onload=function(){var loadedImage=this;$interval((function(){that._avatar=loadedImage,that._avatarLoading=!1,$log.log("[contact] Lazily load avatar for "+that.displayNameForLog()+" success"),$rootScope.$broadcast("ON_CONTACT_AVATAR_UPDATE",that.jid)}),0,1,!0)},image.onerror=function(){$log.warn("[contact] Lazily load avatar for "+that.displayNameForLog()+" failure : use text avatar"),that._avatar=that.defaultAvatar,that._avatarLoading=!1},image.src=that.avatarSrc}return that.defaultAvatar}}),Object.defineProperty(Contact.prototype,"displayName",{set:function(value){this._displayName=value,this.name.value=value,this.displayNameMD5=Object(crypto_js__WEBPACK_IMPORTED_MODULE_0__.MD5)(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Latin1.parse(value)).toString(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Hex)},get:function(){return this._displayName}}),Object.defineProperty(Contact.prototype,"lastActivityDate",{set:function(lastActivityDate){this._lastActivityDate=lastActivityDate,this.updateLastActivityMessage()},get:function(){return this._lastActivityDate}}),Object.defineProperty(Contact.prototype,"statusMessage",{get:function(){if((this._currentStatus!==this.status||this._currentLastActivityMessage!==this.lastActivityMessage||this._currentMessage!==this.message)&&(this._currentStatus=this.status,this._currentMessage=this.message,this._currentLastActivityMessage=this.lastActivityMessage,"unknown"===this.status?this._statusMessage=this.company&&this.company.name?this.company.name:$translate.instant("unknown"):"offline"===this.status&&""===this.lastActivityMessage?this._statusMessage=$translate.instant("offlineFilter"):"away"===this.status&&""===this.lastActivityMessage?this._statusMessage=$translate.instant("shortAway"):this._statusMessage=$translate.instant(this.status,{offlineDate:this.lastActivityMessage}),this.message)){var message=$translate.instant(this.message);"("!==message.charAt(0)&&(message="("+message+")"),this._statusMessage+=" "+message}return this._statusMessage}}),Object.defineProperty(Contact.prototype,"lastActivityMessage",{get:function(){var that=this;if(!that._lastActivityMessage&&!that._lastActivityInProgress){that._lastActivityInProgress=!0;try{xmppService.connection.lastactivity.query(that.jid,{onResponse:function(stanza){var inactivityInMSeconds=1e3*$(stanza).find("query").attr("seconds"),lastActivityDateInMSeconds=(new Date).getTime()-inactivityInMSeconds;that.lastActivityDate=new Date(lastActivityDateInMSeconds),that._lastActivityInProgress=!1}})}catch(error){$log.error("[Contact] lastActivityDate getter accessor for contact "+that.jid_im+" -- failure : "+error),that._lastActivityInProgress=!1}return null}return this._lastActivityMessage}}),Contact.prototype.updateLastActivityMessage=function(){if(this._lastActivityDate){var mdate=moment(this._lastActivityDate);moment.locale().startsWith("de")?(this._lastActivityMessage=mdate.fromNow(!0).replace("Tage","Tagen"),this._lastActivityMessage=this._lastActivityMessage.replace("eine Stunde","einer Stunde")):this._lastActivityMessage=mdate.fromNow(!0)}else this._lastActivityMessage=""},Contact.prototype.getLastAvailableDate=function(){var lastStamp=null,stamps=this.imStatusStamp;return Object.keys(stamps).forEach((function(key){var stamp=stamps[key];lastStamp?lastStamp<stamp&&(lastStamp=stamp):lastStamp=stamp})),lastStamp},Contact.prototype.updateCalendarPresenceInfo=function(){var calendarState=this.calendarState,calendarParams=null,calendarMessage=null;calendarState.iconId=null;var calendarLabelKey=null;calendarState.autoReplyOn?(calendarState.iconId="icon_outofoffice",calendarMessage="<div style='text-align:left'>"+utilService.escapeHtml(calendarState.autoReplyInfos.message).replace(/\n/g,"<br/>")+"</div>",calendarParams={meetingDate:calendarState.autoReplyInfos.until,message:calendarMessage},calendarLabelKey=calendarState.autoReplyInfos.until?calendarState.autoReplyInfos.untilDate?"calendarAutoReply-date":"calendarAutoReply":"calendarAutoReplySimple"):("busy"===calendarState.message?(calendarState.iconId="icon_inameeting",calendarLabelKey=calendarState.untilDate?"calendar-busy-date":"calendar-busy"):"out_of_office"===calendarState.message&&(calendarState.iconId="icon_outofoffice",calendarLabelKey=calendarState.untilDate?"calendar-outofoffice-date":"calendar-outofoffice"),calendarParams={meetingDate:calendarState.until}),calendarLabelKey&&(calendarState.tooltip=$translate.instant(calendarLabelKey,{meetingDate:calendarParams.meetingDate}),calendarParams.message&&(calendarParams.message=calendarParams.message.replace(/<script>/g,""),calendarState.tooltip=$sce.trustAsHtml(calendarState.tooltip+" "+calendarParams.message)))},Contact.prototype.displayNameForLog=function(){return config&&config.debug?this.displayName:this.displayNameMD5},Contact.prototype.isMobileResource=function(jid){return-1!==jid.indexOf("mobile_")},Contact.prototype.calculateStatusFromResources=function(isMe){var presence="offline",message="",initStamp="",stamp="",fullJid=this.fullJid,desktopPresence=!1,allowMobiles=config.webrtcWithMobiles;for(var key in this.resources)if(this.resources.hasOwnProperty(key)){if("dnd"===this.resources[key].show&&"phone"===this.resources[key].status){presence="busy",message="audioPhone",desktopPresence=!0,fullJid=key;break}if("xa"===this.resources[key].show||"dnd"===this.resources[key].show&&""===this.resources[key].status){var toUpdate=!1;this.resources[key].initStamp?initStamp?this.resources[key].initStamp.getTime()>initStamp.getTime()&&(initStamp=this.resources[key].initStamp,toUpdate=!0):(initStamp=this.resources[key].initStamp,toUpdate=!0):stamp?this.resources[key].stamp.getTime()>stamp.getTime()&&(stamp=this.resources[key].stamp,initStamp=this.resources[key].stamp,toUpdate=!0):(stamp=this.resources[key].stamp,initStamp=this.resources[key].stamp,toUpdate=!0),toUpdate&&(presence=this.resources[key].show,message=this.resources[key].status)}else"xa"!==presence&&("dnd"!==presence||"dnd"===presence&&""!==message)&&"dnd"===this.resources[key].show&&""!==this.resources[key].status?("presentation"===this.resources[key].status?(presence=this.resources[key].show,message="presentation"):(presence="busy",message=this.resources[key].status),fullJid=key,desktopPresence=!0):isMe&&"online"===this.resources[key].show&&"mode=auto"===this.resources[key].status&&key===this.fullJid?"busy"!==presence&&"dnd"!==presence&&"presentation"!==message&&(presence="online",message="",this.resources[key].status="",this.isMobileResource(key)?presence="online-mobile":desktopPresence=!0):"online"===this.resources[key].show&&"xa"!==presence&&"dnd"!==presence&&"busy"!==presence?(message="","online-mobile"!==presence&&(presence="online"),this.resources[key].status="",this.isMobileResource(key)?presence="online-mobile":(fullJid=key,desktopPresence=!0),allowMobiles&&(fullJid=key)):"away"===this.resources[key].show&&"offline"===presence&&(presence="away",message="",fullJid=key);"mode=auto"===this.resources[key].status&&(this.resources[key].status="")}for(var key in this.resources)this.resources.hasOwnProperty(key)&&"mode=auto"===this.resources[key].status&&(this.resources[key].status="");return isMe||this.fullJid||(this.fullJid=fullJid),"online-mobile"===presence&&desktopPresence?(presence="online",message=""):"online-mobile"!==presence||isMe||allowMobiles||(this.fullJid=null,message=""),{presence:presence,message:message}},Contact.prototype.isCPaaSGuest=function(){return this.roles.indexOf("guest")>=0},Contact.prototype.isGuest=function(){return this.guestMode},Contact.prototype.hasAdminRights=function(){return this.isSuperadmin()||this.isBusinessAdmin()||this.isAdmin()||this.isBPAdmin()},Contact.prototype.isSuperadmin=function(){return this.roles.indexOf("superadmin")>=0},Contact.prototype.isBusinessAdmin=function(){return this.roles.indexOf("business_admin")>=0},Contact.prototype.isAdmin=function(){return this.roles.indexOf("admin")>=0&&(!this.isOrganizationAdmin()||!this.isBPAdmin())},Contact.prototype.isOrganizationAdmin=function(){return this.roles.indexOf("admin")>=0&&this.adminType===Contact.AdminType.ORGANIZATION_ADMIN},Contact.prototype.isCompanyAdmin=function(){return this.roles.indexOf("admin")>=0&&this.adminType===Contact.AdminType.COMPANY_ADMIN},Contact.prototype.isSiteAdmin=function(){return this.roles.indexOf("admin")>=0&&this.adminType===Contact.AdminType.SITE_ADMIN},Contact.prototype.getAdminType=function(){return this.roles.indexOf("admin")>=0?this.adminType:Contact.AdminType.UNDEFINED},Contact.prototype.isECAdmin=function(){return this.company&&!this.company.isBP&&this.isAdmin()},Contact.prototype.isBPAdmin=function(){return this.isBPAdminOperations()||this.isBPAdminFinance()},Contact.prototype.isBPAdminOperations=function(){return this.company&&this.company.isBP&&this.roles.indexOf("bp_admin")>=0},Contact.prototype.isBPAdminFinance=function(){return this.company&&this.company.isBP&&this.roles.indexOf("bp_finance")>=0},Contact.prototype.isBPAdminDR=function(){return this.isBPAdmin()&&this.company.isDR()},Contact.prototype.isBPAdminVAD=function(){return this.isBPAdmin()&&this.company.isVAD()},Contact.prototype.isBPAdminIR=function(){return this.isBPAdmin()&&this.company.isIR()},Contact.prototype.isDirectoryAdmin=function(){return this.roles.indexOf("directory_admin")>=0},Contact.prototype.updateIMStatus=function(attr,isMe){if(this.imStatusStamp[attr.jid]&&this.imStatusStamp[attr.jid]>attr.stamp)$log.info("[Contact] Ignore obsolete presence message for contact "+this.jid);else{$log.info("[Contact] updateIMStatus "+JSON.stringify(attr)),this.imStatusStamp[attr.jid]=attr.stamp,attr.status&&(this.imStatus=attr.status);var status=attr.message?attr.message:"";if("offline"===this.imStatus)this.fullJid===attr.jid&&(this.fullJid=null),delete this.resources[attr.jid],delete this.imStatusStamp[attr.jid],0===this.resources.length&&(this.message="");else{this.resources[attr.jid]?(this.resources[attr.jid].show=this.imStatus,this.resources[attr.jid].status=status,this.resources[attr.jid].stamp=attr.stamp):this.resources[attr.jid]={show:this.imStatus,status:status,initStamp:attr.stamp,stamp:attr.stamp},$log.info("[Contact] updateIMStatus user resources after update "+JSON.stringify(this.resources)),this.isMobileResource(attr.jid)||isMe||(this.fullJid=attr.jid);var allowMobiles=config.webrtcWithMobiles;!isMe&&allowMobiles&&(this.fullJid=attr.jid)}if(this.updateRichStatus(isMe),isMe&&this.isMobileResource(attr.jid)&&("offline"!==attr.status&&null===this.mobileResource&&(this.mobileResource=attr.jid,$log.info("[Contact] updateIMStatus: post event ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT"),$rootScope.$broadcast("ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT","started")),"offline"===attr.status)){var otherMobileResource=null;for(var key in this.resources)if(this.resources.hasOwnProperty(key)&&this.isMobileResource(key)){otherMobileResource=key;break}this.mobileResource=otherMobileResource,null===this.mobileResource&&$rootScope.$broadcast("ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT","stopped")}}},Contact.prototype.getPCGPresenceSource=function(jid){var result="";if(jid){var index=jid.indexOf("/");-1!==index&&(result=jid.substr(index+1))}return result},Contact.prototype.transcodePCG2Presence=function(attr){var result="";switch(attr.status){case"offline":result="";break;case"online":result="EVT_CONNECTION_CLEARED";break;case"dnd":result="EVT_ESTABLISHED"}return result},Contact.prototype.updateTelephonyStatus=function(attr,isMe){var statusOrg=this.telStatus;"pcg2"===this.getPCGPresenceSource(attr.jid)?this.telStatus=this.transcodePCG2Presence(attr):this.telStatus=attr.message,this.updateRichStatus(isMe),isMe&&statusOrg!==this.telStatus&&$rootScope.$broadcast("ON_UPDATE_MYTELEPHONY_STATUS_EVENT")},Contact.prototype.updatePresenceStatus=function(status){this.status=status},Contact.prototype.updateRichStatus=function(isMe){if("EVT_SERVICE_INITIATED"===this.telStatus||"EVT_ESTABLISHED"===this.telStatus)this.status="busy",this.message="audioPhone";else if("subscribe"===this.ask)this.status="wait";else if("none"===this.subscription||"from"===this.subscription)this.status="unknown";else{var calculatedStatus=this.calculateStatusFromResources(isMe);"xa"===calculatedStatus.presence&&(""!==calculatedStatus.message||isMe?"away"===calculatedStatus.message&&(calculatedStatus.presence="away",calculatedStatus.message=""):calculatedStatus.presence="offline"),this.status=calculatedStatus.presence,this.message=calculatedStatus.message,isMe?$log.info("[Contact] updateRichStatus MY PRESENCE : "+calculatedStatus.presence+" || message : "+calculatedStatus.message):$log.info("[Contact] updateRichStatus presence : "+calculatedStatus.presence+" || message : "+calculatedStatus.message),"offline"!==this.status&&(this.lastActivityDate=null)}isMe&&$rootScope.$broadcast("ON_UPDATE_MYCONTACT_EVENT"),$rootScope.$broadcast("ON_UPDATE_CONTACT_RICH_STATUS_EVENT",this)},Contact.prototype.updateFromUserData=function(userData){this.dbId=userData.id,this.loginEmail=userData.loginEmail,this.firstname=userData.firstName,this.lastname=userData.lastName,this.nickname=userData.nickName?userData.nickName:"",this.title=userData.title?userData.title:"",this.jobTitle=userData.jobTitle?userData.jobTitle:"",this.organisationId=userData.organisationId,this.siteId=userData.siteId,this.country=userData.country?userData.country:"FRA",this.timezone=userData.timezone,this.roles=userData.roles,this.adminType=userData.adminType,this.isBot=!1,this.isTerminated=userData.isTerminated,this.isInDefaultCompany=userData.isInDefaultCompany,this.lastAvatarUpdateDate=userData.lastAvatarUpdateDate,this.initialized=userData.isInitialized,this.guestMode=!!userData.guestMode&&userData.guestMode,this.newUIEnabled=!!userData.tryNewUiCustomisation&&"enabled"===userData.tryNewUiCustomisation,this.isTv=userData.isTv,userData.fileSharingCustomisation&&(this.fileSharingEnabled="enabled"===userData.fileSharingCustomisation),userData.userTitleNameCustomisation&&(this.userTitleNameEnabled="enabled"===userData.userTitleNameCustomisation),this.tags=userData.tags,userData.jid_im&&(this.id=userData.jid_im,this.jid=userData.jid_im,this.jidtel=userData.jid_tel),this.company&&this.company.id===userData.companyId||(this.company=Company.create(userData.companyId,userData.companyName)),this.phonePro=this.phoneProCan="",this.phonePbx="",this.phoneInternalNumber="",this.pbxId="",this.mobilePro=this.mobileProCan="",this.phonePerso=this.phonePersoCan="",this.mobilePerso=this.mobilePersoCan="",this.voicemailNumber="",this.hasPhoneNumber=!1,this.hasPhoneProDdiNumber=!1;var that=this;userData.emails&&(that.emailPerso="",userData.emails.forEach((function(email){switch(email.type){case"work":that.emailPro=email.email;break;case"home":that.emailPerso=email.email}}))),userData.phoneNumbers&&(userData.phoneNumbers.forEach((function(phoneNumber){var number=phoneNumber.number,numberCan=phoneNumber.numberE164,deviceType=phoneNumber.deviceType;switch(that.hasPhoneNumber=!0,phoneNumber.type){case"work":"landline"===deviceType&&(phoneNumber.isCloudPbxDDI?(that.phonePro=phoneNumber.number,that.phoneProCan=phoneNumber.numberE164,that.hasPhoneProDdiNumber=!0):that.hasPhoneProDdiNumber||(that.phonePro=number,that.phoneProCan=numberCan),phoneNumber.isFromSystem&&(that.phonePbx=phoneNumber.shortNumber,phoneNumber.internalNumber&&(that.phoneInternalNumber=phoneNumber.internalNumber,"Remote Extension"!==phoneNumber.deviceName&&"Any Device"!==phoneNumber.deviceName||(that.isVirtualTerm=!0)),that.systDeviceName=phoneNumber.deviceName?phoneNumber.deviceName:null,that.pbxId=phoneNumber.pbxId,that.voicemailNumber=phoneNumber.voiceMailNumber)),"mobile"===deviceType&&(that.mobilePro=number,that.isMobileProShared=phoneNumber.isVisibleByOthers,that.mobileProCan=numberCan);break;case"home":"landline"===deviceType&&(that.phonePerso=number,that.isPhonePersoShared=phoneNumber.isVisibleByOthers,that.phonePersoCan=numberCan),"mobile"===deviceType&&(that.mobilePerso=number,that.isMobilePersoShared=phoneNumber.isVisibleByOthers,that.mobilePersoCan=numberCan)}})),this.phoneNumbersInitialized=!0),this.computeDisplayName()},Contact.prototype.updateName=function(firstName,lastName){this.firstname=firstName,this.lastname=lastName,this.computeDisplayName(),this.getAvatar()},Contact.prototype.getNameUpdatePrio=function(){return this.nameUpdatePrio},Contact.prototype.setNameUpdatePrio=function(prio){switch(prio){case Contact.NameUpdatePrio.NO_UPDATE_PRIO:case Contact.NameUpdatePrio.OUTLOOK_UPDATE_PRIO:case Contact.NameUpdatePrio.SERVER_UPDATE_PRIO:case Contact.NameUpdatePrio.MAX_UPDATE_PRIO:this.nameUpdatePrio=prio}},Contact.prototype.containsEmail=function(email){var lowerCaseEmail=email.toLowerCase();return!(!this.loginEmail||this.loginEmail.toLowerCase()!==lowerCaseEmail)||(!(!this.emailPro||this.emailPro.toLowerCase()!==lowerCaseEmail)||!(!this.emailPerso||this.emailPerso.toLowerCase()!==lowerCaseEmail))},Contact.prototype.computeDisplayName=function(){var firstName=this.firstname?this.firstname.charAt(0).toUpperCase()+this.firstname.slice(1):null,lastName=this.lastname?this.lastname.charAt(0).toUpperCase()+this.lastname.slice(1):null,nickName=this.nickname?this.nickname.charAt(0).toUpperCase()+this.nickname.slice(1):null;this.isTv?(this.displayName=firstName||lastName,this.initials=this.displayName.charAt(0)):lastName&&firstName?this.computeCompleteDisplayName(firstName,lastName):lastName&&!firstName?(this.displayName=lastName,this.initials=lastName.charAt(0)):nickName?(this.displayName=nickName,this.initials=nickName.charAt(0)):this.loginEmail?(this.displayName=this.loginEmail,this.initials=this.loginEmail.substring(0,2).toUpperCase()):firstName?(this.displayName=firstName,this.initials=firstName.charAt(0)):(this.displayName="Anonymous",this.initials="A")},Contact.prototype.computeCompleteDisplayName=function(firstName,lastName){var displayName="",initials="";1!==lastName.length&&2!==firstName.length?"FL"===settingsService.getSetting("displayOrder")?(displayName=firstName+" "+lastName,initials=firstName.charAt(0)+lastName.charAt(0)):(displayName=lastName+" "+firstName,initials=lastName.charAt(0)+firstName.charAt(0)):(displayName="FL"===settingsService.getSetting("displayOrder")?firstName+" "+lastName:lastName+" "+firstName,initials=firstName.charAt(0)+firstName.charAt(1)),this.displayName=displayName,this.initials=initials;for(var upperCaseDisplayName=this.displayName.toUpperCase(),sum=0,i=0;i<upperCaseDisplayName.length;i++)sum+=upperCaseDisplayName.charCodeAt(i);this.colorIndex=sum%12,this.color=Contact.textAvatarColor[this.colorIndex]},Contact.prototype.getAvatarInBase64=function(){var contact=this,that=this;return $q((function(resolve){try{if(contact&&contact.avatar&&contact.avatar.src||resolve(),contact.avatar.src&&!contact.avatar.src.startsWith("data:image/png")){var img=new Image,canvas=$document[0].createElement("canvas");canvas.width=120,canvas.height=120;var ctx=canvas.getContext("2d");ctx.rect(0,0,120,120),ctx.fillStyle=that.color,ctx.fill(),img.onload=function(){ctx.drawImage(this,0,0,120,120);var dataURL=canvas.toDataURL("image/png");resolve(dataURL)},img.src=contact.avatar.src}else resolve(contact.avatar.src)}catch(error){$log.warn("[contactService] getAvatarInBase64 error "+error),resolve()}}))},Contact.prototype.getAvatar=function(size,forced){var contact=this;if(contact.dbId&&contact.lastAvatarUpdateDate){var serverURL=config.webservices.protocol+"://"+config.webservices.currentServer;$rootScope.cdn&&(serverURL=$rootScope.cdnServer);var imgSrc=serverURL+"/api/avatar/"+contact.dbId+"?size="+(size||256);imgSrc+="&update="+Object(crypto_js__WEBPACK_IMPORTED_MODULE_0__.MD5)(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Latin1.parse(contact.lastAvatarUpdateDate)).toString(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Hex),contact.avatarSrc=imgSrc}if(authService.fromSDK)return contact.createTextAvatarImage(),$q.when();if(contact.isTv){var image=new Image;return image.src="/resources/skins/rainbow/images/misc/androidtv.svg",contact.defaultAvatar=image,$q.when()}return $q((function(resolve){contact.createTextAvatarImage(),!forced&&contact.lastAvatarUpdateDate||(contact.avatar=null),resolve(contact)}))},Contact.prototype.createTextAvatarImage=function(){var image=new Image,canvas=$document[0].createElement("canvas");canvas.width=image.width=225,canvas.height=image.height=225;var ctx=canvas.getContext("2d");ctx.rect(0,0,225,225),ctx.fillStyle=this.color,ctx.fill(),ctx.font="bold 100px Helvetica",ctx.textAlign="center",ctx.fillStyle="white",ctx.fillText(this.initials,110,150),image.src=canvas.toDataURL("image/png"),this.defaultAvatar=image},Contact.prototype.getGroups=function(){return this.groups},Contact.prototype.setGroups=function(groups){this.groups=groups},Contact.prototype.getNameForLogs=function(){if(!this.nameForLogs&&this.displayName){var temp=this.displayName.replace(/[^\s](?=.{1,}$)/g,"*");this.nameForLogs=this.displayName.charAt(0)+temp.substr(1)}return this.nameForLogs},Contact.textAvatarColor=["#ff4500","#d38700","#348833","#007356","#00b2a9","#00b0e5","#0085ca","#6639b7","#91278a","#cf0072","#a50034","#d20000"],Contact}])},function(module,exports,__webpack_require__){"use strict";exports.randomBytes=exports.rng=exports.pseudoRandomBytes=exports.prng=__webpack_require__(16),exports.createHash=exports.Hash=__webpack_require__(21),exports.createHmac=exports.Hmac=__webpack_require__(56);var algos=__webpack_require__(127),algoKeys=Object.keys(algos),hashes=["sha1","sha224","sha256","sha384","sha512","md5","rmd160"].concat(algoKeys);exports.getHashes=function(){return hashes};var p=__webpack_require__(59);exports.pbkdf2=p.pbkdf2,exports.pbkdf2Sync=p.pbkdf2Sync;var aes=__webpack_require__(129);exports.Cipher=aes.Cipher,exports.createCipher=aes.createCipher,exports.Cipheriv=aes.Cipheriv,exports.createCipheriv=aes.createCipheriv,exports.Decipher=aes.Decipher,exports.createDecipher=aes.createDecipher,exports.Decipheriv=aes.Decipheriv,exports.createDecipheriv=aes.createDecipheriv,exports.getCiphers=aes.getCiphers,exports.listCiphers=aes.listCiphers;var dh=__webpack_require__(146);exports.DiffieHellmanGroup=dh.DiffieHellmanGroup,exports.createDiffieHellmanGroup=dh.createDiffieHellmanGroup,exports.getDiffieHellman=dh.getDiffieHellman,exports.createDiffieHellman=dh.createDiffieHellman,exports.DiffieHellman=dh.DiffieHellman;var sign=__webpack_require__(152);exports.createSign=sign.createSign,exports.Sign=sign.Sign,exports.createVerify=sign.createVerify,exports.Verify=sign.Verify,exports.createECDH=__webpack_require__(189);var publicEncrypt=__webpack_require__(190);exports.publicEncrypt=publicEncrypt.publicEncrypt,exports.privateEncrypt=publicEncrypt.privateEncrypt,exports.publicDecrypt=publicEncrypt.publicDecrypt,exports.privateDecrypt=publicEncrypt.privateDecrypt;var rf=__webpack_require__(193);exports.randomFill=rf.randomFill,exports.randomFillSync=rf.randomFillSync,exports.createCredentials=function(){throw new Error(["sorry, createCredentials is not implemented yet","we accept pull requests","https://github.com/crypto-browserify/crypto-browserify"].join("\n"))},exports.constants={DH_CHECK_P_NOT_SAFE_PRIME:2,DH_CHECK_P_NOT_PRIME:1,DH_UNABLE_TO_CHECK_GENERATOR:4,DH_NOT_SUITABLE_GENERATOR:8,NPN_ENABLED:1,ALPN_ENABLED:1,RSA_PKCS1_PADDING:1,RSA_SSLV23_PADDING:2,RSA_NO_PADDING:3,RSA_PKCS1_OAEP_PADDING:4,RSA_X931_PADDING:5,RSA_PKCS1_PSS_PADDING:6,POINT_CONVERSION_COMPRESSED:2,POINT_CONVERSION_UNCOMPRESSED:4,POINT_CONVERSION_HYBRID:6}},function(module,exports,__webpack_require__){"use strict";exports.byteLength=function(b64){var lens=getLens(b64),validLen=lens[0],placeHoldersLen=lens[1];return 3*(validLen+placeHoldersLen)/4-placeHoldersLen},exports.toByteArray=function(b64){for(var tmp,lens=getLens(b64),validLen=lens[0],placeHoldersLen=lens[1],arr=new Arr(function(b64,validLen,placeHoldersLen){return 3*(validLen+placeHoldersLen)/4-placeHoldersLen}(0,validLen,placeHoldersLen)),curByte=0,len=placeHoldersLen>0?validLen-4:validLen,i=0;i<len;i+=4)tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)],arr[curByte++]=tmp>>16&255,arr[curByte++]=tmp>>8&255,arr[curByte++]=255&tmp;2===placeHoldersLen&&(tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4,arr[curByte++]=255&tmp);1===placeHoldersLen&&(tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2,arr[curByte++]=tmp>>8&255,arr[curByte++]=255&tmp);return arr},exports.fromByteArray=function(uint8){for(var tmp,len=uint8.length,extraBytes=len%3,parts=[],i=0,len2=len-extraBytes;i<len2;i+=16383)parts.push(encodeChunk(uint8,i,i+16383>len2?len2:i+16383));1===extraBytes?(tmp=uint8[len-1],parts.push(lookup[tmp>>2]+lookup[tmp<<4&63]+"==")):2===extraBytes&&(tmp=(uint8[len-2]<<8)+uint8[len-1],parts.push(lookup[tmp>>10]+lookup[tmp>>4&63]+lookup[tmp<<2&63]+"="));return parts.join("")};for(var lookup=[],revLookup=[],Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;i<len;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;function getLens(b64){var len=b64.length;if(len%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var validLen=b64.indexOf("=");return-1===validLen&&(validLen=len),[validLen,validLen===len?0:4-validLen%4]}function encodeChunk(uint8,start,end){for(var tmp,num,output=[],i=start;i<end;i+=3)tmp=(uint8[i]<<16&16711680)+(uint8[i+1]<<8&65280)+(255&uint8[i+2]),output.push(lookup[(num=tmp)>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[63&num]);return output.join("")}revLookup["-".charCodeAt(0)]=62,revLookup["_".charCodeAt(0)]=63},function(module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?NaN:1/0*(s?-1:1);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=value<0||0===value&&1/value<0?1:0;for(value=Math.abs(value),isNaN(value)||value===1/0?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),(value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias))*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},function(module,exports){},function(module,exports,__webpack_require__){"use strict";var Buffer=__webpack_require__(4).Buffer,util=__webpack_require__(113);module.exports=function(){function BufferList(){!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,BufferList),this.head=null,this.tail=null,this.length=0}return BufferList.prototype.push=function(v){var entry={data:v,next:null};this.length>0?this.tail.next=entry:this.head=entry,this.tail=entry,++this.length},BufferList.prototype.unshift=function(v){var entry={data:v,next:this.head};0===this.length&&(this.tail=entry),this.head=entry,++this.length},BufferList.prototype.shift=function(){if(0!==this.length){var ret=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,ret}},BufferList.prototype.clear=function(){this.head=this.tail=null,this.length=0},BufferList.prototype.join=function(s){if(0===this.length)return"";for(var p=this.head,ret=""+p.data;p=p.next;)ret+=s+p.data;return ret},BufferList.prototype.concat=function(n){if(0===this.length)return Buffer.alloc(0);if(1===this.length)return this.head.data;for(var src,target,offset,ret=Buffer.allocUnsafe(n>>>0),p=this.head,i=0;p;)src=p.data,target=ret,offset=i,src.copy(target,offset),i+=p.data.length,p=p.next;return ret},BufferList}(),util&&util.inspect&&util.inspect.custom&&(module.exports.prototype[util.inspect.custom]=function(){var obj=util.inspect({length:this.length});return this.constructor.name+" "+obj})},function(module,exports){},function(module,exports,__webpack_require__){(function(global){var scope=void 0!==global&&global||"undefined"!=typeof self&&self||window,apply=Function.prototype.apply;function Timeout(id,clearFn){this._id=id,this._clearFn=clearFn}exports.setTimeout=function(){return new Timeout(apply.call(setTimeout,scope,arguments),clearTimeout)},exports.setInterval=function(){return new Timeout(apply.call(setInterval,scope,arguments),clearInterval)},exports.clearTimeout=exports.clearInterval=function(timeout){timeout&&timeout.close()},Timeout.prototype.unref=Timeout.prototype.ref=function(){},Timeout.prototype.close=function(){this._clearFn.call(scope,this._id)},exports.enroll=function(item,msecs){clearTimeout(item._idleTimeoutId),item._idleTimeout=msecs},exports.unenroll=function(item){clearTimeout(item._idleTimeoutId),item._idleTimeout=-1},exports._unrefActive=exports.active=function(item){clearTimeout(item._idleTimeoutId);var msecs=item._idleTimeout;msecs>=0&&(item._idleTimeoutId=setTimeout((function(){item._onTimeout&&item._onTimeout()}),msecs))},__webpack_require__(115),exports.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==global&&global.setImmediate||this&&this.setImmediate,exports.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==global&&global.clearImmediate||this&&this.clearImmediate}).call(this,__webpack_require__(10))},function(module,exports,__webpack_require__){(function(global,process){!function(global,undefined){"use strict";if(!global.setImmediate){var registerImmediate,html,channel,messagePrefix,onGlobalMessage,nextHandle=1,tasksByHandle={},currentlyRunningATask=!1,doc=global.document,attachTo=Object.getPrototypeOf&&Object.getPrototypeOf(global);attachTo=attachTo&&attachTo.setTimeout?attachTo:global,"[object process]"==={}.toString.call(global.process)?registerImmediate=function(handle){process.nextTick((function(){runIfPresent(handle)}))}:!function(){if(global.postMessage&&!global.importScripts){var postMessageIsAsynchronous=!0,oldOnMessage=global.onmessage;return global.onmessage=function(){postMessageIsAsynchronous=!1},global.postMessage("","*"),global.onmessage=oldOnMessage,postMessageIsAsynchronous}}()?global.MessageChannel?((channel=new MessageChannel).port1.onmessage=function(event){runIfPresent(event.data)},registerImmediate=function(handle){channel.port2.postMessage(handle)}):doc&&"onreadystatechange"in doc.createElement("script")?(html=doc.documentElement,registerImmediate=function(handle){var script=doc.createElement("script");script.onreadystatechange=function(){runIfPresent(handle),script.onreadystatechange=null,html.removeChild(script),script=null},html.appendChild(script)}):registerImmediate=function(handle){setTimeout(runIfPresent,0,handle)}:(messagePrefix="setImmediate$"+Math.random()+"$",onGlobalMessage=function(event){event.source===global&&"string"==typeof event.data&&0===event.data.indexOf(messagePrefix)&&runIfPresent(+event.data.slice(messagePrefix.length))},global.addEventListener?global.addEventListener("message",onGlobalMessage,!1):global.attachEvent("onmessage",onGlobalMessage),registerImmediate=function(handle){global.postMessage(messagePrefix+handle,"*")}),attachTo.setImmediate=function(callback){"function"!=typeof callback&&(callback=new Function(""+callback));for(var args=new Array(arguments.length-1),i=0;i<args.length;i++)args[i]=arguments[i+1];var task={callback:callback,args:args};return tasksByHandle[nextHandle]=task,registerImmediate(nextHandle),nextHandle++},attachTo.clearImmediate=clearImmediate}function clearImmediate(handle){delete tasksByHandle[handle]}function runIfPresent(handle){if(currentlyRunningATask)setTimeout(runIfPresent,0,handle);else{var task=tasksByHandle[handle];if(task){currentlyRunningATask=!0;try{!function(task){var callback=task.callback,args=task.args;switch(args.length){case 0:callback();break;case 1:callback(args[0]);break;case 2:callback(args[0],args[1]);break;case 3:callback(args[0],args[1],args[2]);break;default:callback.apply(undefined,args)}}(task)}finally{clearImmediate(handle),currentlyRunningATask=!1}}}}}("undefined"==typeof self?void 0===global?this:global:self)}).call(this,__webpack_require__(10),__webpack_require__(12))},function(module,exports,__webpack_require__){(function(global){function config(name){try{if(!global.localStorage)return!1}catch(_){return!1}var val=global.localStorage[name];return null!=val&&"true"===String(val).toLowerCase()}module.exports=function(fn,msg){if(config("noDeprecation"))return fn;var warned=!1;return function(){if(!warned){if(config("throwDeprecation"))throw new Error(msg);config("traceDeprecation")?console.trace(msg):console.warn(msg),warned=!0}return fn.apply(this,arguments)}}}).call(this,__webpack_require__(10))},function(module,exports,__webpack_require__){"use strict";module.exports=PassThrough;var Transform=__webpack_require__(53),util=__webpack_require__(22);function PassThrough(options){if(!(this instanceof PassThrough))return new PassThrough(options);Transform.call(this,options)}util.inherits=__webpack_require__(1),util.inherits(PassThrough,Transform),PassThrough.prototype._transform=function(chunk,encoding,cb){cb(null,chunk)}},function(module,exports,__webpack_require__){module.exports=__webpack_require__(37)},function(module,exports,__webpack_require__){module.exports=__webpack_require__(14)},function(module,exports,__webpack_require__){module.exports=__webpack_require__(36).Transform},function(module,exports,__webpack_require__){module.exports=__webpack_require__(36).PassThrough},function(module,exports,__webpack_require__){var inherits=__webpack_require__(1),Hash=__webpack_require__(17),Buffer=__webpack_require__(4).Buffer,K=[1518500249,1859775393,-1894007588,-899497514],W=new Array(80);function Sha(){this.init(),this._w=W,Hash.call(this,64,56)}function rotl30(num){return num<<30|num>>>2}function ft(s,b,c,d){return 0===s?b&c|~b&d:2===s?b&c|b&d|c&d:b^c^d}inherits(Sha,Hash),Sha.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this},Sha.prototype._update=function(M){for(var num,W=this._w,a=0|this._a,b=0|this._b,c=0|this._c,d=0|this._d,e=0|this._e,i=0;i<16;++i)W[i]=M.readInt32BE(4*i);for(;i<80;++i)W[i]=W[i-3]^W[i-8]^W[i-14]^W[i-16];for(var j=0;j<80;++j){var s=~~(j/20),t=0|((num=a)<<5|num>>>27)+ft(s,b,c,d)+e+W[j]+K[s];e=d,d=c,c=rotl30(b),b=a,a=t}this._a=a+this._a|0,this._b=b+this._b|0,this._c=c+this._c|0,this._d=d+this._d|0,this._e=e+this._e|0},Sha.prototype._hash=function(){var H=Buffer.allocUnsafe(20);return H.writeInt32BE(0|this._a,0),H.writeInt32BE(0|this._b,4),H.writeInt32BE(0|this._c,8),H.writeInt32BE(0|this._d,12),H.writeInt32BE(0|this._e,16),H},module.exports=Sha},function(module,exports,__webpack_require__){var inherits=__webpack_require__(1),Hash=__webpack_require__(17),Buffer=__webpack_require__(4).Buffer,K=[1518500249,1859775393,-1894007588,-899497514],W=new Array(80);function Sha1(){this.init(),this._w=W,Hash.call(this,64,56)}function rotl5(num){return num<<5|num>>>27}function rotl30(num){return num<<30|num>>>2}function ft(s,b,c,d){return 0===s?b&c|~b&d:2===s?b&c|b&d|c&d:b^c^d}inherits(Sha1,Hash),Sha1.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this},Sha1.prototype._update=function(M){for(var num,W=this._w,a=0|this._a,b=0|this._b,c=0|this._c,d=0|this._d,e=0|this._e,i=0;i<16;++i)W[i]=M.readInt32BE(4*i);for(;i<80;++i)W[i]=(num=W[i-3]^W[i-8]^W[i-14]^W[i-16])<<1|num>>>31;for(var j=0;j<80;++j){var s=~~(j/20),t=rotl5(a)+ft(s,b,c,d)+e+W[j]+K[s]|0;e=d,d=c,c=rotl30(b),b=a,a=t}this._a=a+this._a|0,this._b=b+this._b|0,this._c=c+this._c|0,this._d=d+this._d|0,this._e=e+this._e|0},Sha1.prototype._hash=function(){var H=Buffer.allocUnsafe(20);return H.writeInt32BE(0|this._a,0),H.writeInt32BE(0|this._b,4),H.writeInt32BE(0|this._c,8),H.writeInt32BE(0|this._d,12),H.writeInt32BE(0|this._e,16),H},module.exports=Sha1},function(module,exports,__webpack_require__){var inherits=__webpack_require__(1),Sha256=__webpack_require__(54),Hash=__webpack_require__(17),Buffer=__webpack_require__(4).Buffer,W=new Array(64);function Sha224(){this.init(),this._w=W,Hash.call(this,64,56)}inherits(Sha224,Sha256),Sha224.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this},Sha224.prototype._hash=function(){var H=Buffer.allocUnsafe(28);return H.writeInt32BE(this._a,0),H.writeInt32BE(this._b,4),H.writeInt32BE(this._c,8),H.writeInt32BE(this._d,12),H.writeInt32BE(this._e,16),H.writeInt32BE(this._f,20),H.writeInt32BE(this._g,24),H},module.exports=Sha224},function(module,exports,__webpack_require__){var inherits=__webpack_require__(1),SHA512=__webpack_require__(55),Hash=__webpack_require__(17),Buffer=__webpack_require__(4).Buffer,W=new Array(160);function Sha384(){this.init(),this._w=W,Hash.call(this,128,112)}inherits(Sha384,SHA512),Sha384.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this},Sha384.prototype._hash=function(){var H=Buffer.allocUnsafe(48);function writeInt64BE(h,l,offset){H.writeInt32BE(h,offset),H.writeInt32BE(l,offset+4)}return writeInt64BE(this._ah,this._al,0),writeInt64BE(this._bh,this._bl,8),writeInt64BE(this._ch,this._cl,16),writeInt64BE(this._dh,this._dl,24),writeInt64BE(this._eh,this._el,32),writeInt64BE(this._fh,this._fl,40),H},module.exports=Sha384},function(module,exports,__webpack_require__){"use strict";var inherits=__webpack_require__(1),Buffer=__webpack_require__(4).Buffer,Base=__webpack_require__(13),ZEROS=Buffer.alloc(128),blocksize=64;function Hmac(alg,key){Base.call(this,"digest"),"string"==typeof key&&(key=Buffer.from(key)),this._alg=alg,this._key=key,key.length>blocksize?key=alg(key):key.length<blocksize&&(key=Buffer.concat([key,ZEROS],blocksize));for(var ipad=this._ipad=Buffer.allocUnsafe(blocksize),opad=this._opad=Buffer.allocUnsafe(blocksize),i=0;i<blocksize;i++)ipad[i]=54^key[i],opad[i]=92^key[i];this._hash=[ipad]}inherits(Hmac,Base),Hmac.prototype._update=function(data){this._hash.push(data)},Hmac.prototype._final=function(){var h=this._alg(Buffer.concat(this._hash));return this._alg(Buffer.concat([this._opad,h]))},module.exports=Hmac},function(module,exports,__webpack_require__){module.exports=__webpack_require__(58)},function(module,exports,__webpack_require__){(function(global,process){var ZERO_BUF,checkParameters=__webpack_require__(60),defaultEncoding=__webpack_require__(61),sync=__webpack_require__(62),Buffer=__webpack_require__(4).Buffer,subtle=global.crypto&&global.crypto.subtle,toBrowser={sha:"SHA-1","sha-1":"SHA-1",sha1:"SHA-1",sha256:"SHA-256","sha-256":"SHA-256",sha384:"SHA-384","sha-384":"SHA-384","sha-512":"SHA-512",sha512:"SHA-512"},checks=[];function browserPbkdf2(password,salt,iterations,length,algo){return subtle.importKey("raw",password,{name:"PBKDF2"},!1,["deriveBits"]).then((function(key){return subtle.deriveBits({name:"PBKDF2",salt:salt,iterations:iterations,hash:{name:algo}},key,length<<3)})).then((function(res){return Buffer.from(res)}))}module.exports=function(password,salt,iterations,keylen,digest,callback){"function"==typeof digest&&(callback=digest,digest=void 0);var algo=toBrowser[(digest=digest||"sha1").toLowerCase()];if(!algo||"function"!=typeof global.Promise)return process.nextTick((function(){var out;try{out=sync(password,salt,iterations,keylen,digest)}catch(e){return callback(e)}callback(null,out)}));if(checkParameters(password,salt,iterations,keylen),"function"!=typeof callback)throw new Error("No callback provided to pbkdf2");Buffer.isBuffer(password)||(password=Buffer.from(password,defaultEncoding)),Buffer.isBuffer(salt)||(salt=Buffer.from(salt,defaultEncoding)),function(promise,callback){promise.then((function(out){process.nextTick((function(){callback(null,out)}))}),(function(e){process.nextTick((function(){callback(e)}))}))}(function(algo){if(global.process&&!global.process.browser)return Promise.resolve(!1);if(!subtle||!subtle.importKey||!subtle.deriveBits)return Promise.resolve(!1);if(void 0!==checks[algo])return checks[algo];var prom=browserPbkdf2(ZERO_BUF=ZERO_BUF||Buffer.alloc(8),ZERO_BUF,10,128,algo).then((function(){return!0})).catch((function(){return!1}));return checks[algo]=prom,prom}(algo).then((function(resp){return resp?browserPbkdf2(password,salt,iterations,keylen,algo):sync(password,salt,iterations,keylen,digest)})),callback)}}).call(this,__webpack_require__(10),__webpack_require__(12))},function(module,exports,__webpack_require__){var DES=__webpack_require__(130),aes=__webpack_require__(42),aesModes=__webpack_require__(43),desModes=__webpack_require__(145),ebtk=__webpack_require__(30);function createCipheriv(suite,key,iv){if(suite=suite.toLowerCase(),aesModes[suite])return aes.createCipheriv(suite,key,iv);if(desModes[suite])return new DES({key:key,iv:iv,mode:suite});throw new TypeError("invalid suite type")}function createDecipheriv(suite,key,iv){if(suite=suite.toLowerCase(),aesModes[suite])return aes.createDecipheriv(suite,key,iv);if(desModes[suite])return new DES({key:key,iv:iv,mode:suite,decrypt:!0});throw new TypeError("invalid suite type")}exports.createCipher=exports.Cipher=function(suite,password){var keyLen,ivLen;if(suite=suite.toLowerCase(),aesModes[suite])keyLen=aesModes[suite].key,ivLen=aesModes[suite].iv;else{if(!desModes[suite])throw new TypeError("invalid suite type");keyLen=8*desModes[suite].key,ivLen=desModes[suite].iv}var keys=ebtk(password,!1,keyLen,ivLen);return createCipheriv(suite,keys.key,keys.iv)},exports.createCipheriv=exports.Cipheriv=createCipheriv,exports.createDecipher=exports.Decipher=function(suite,password){var keyLen,ivLen;if(suite=suite.toLowerCase(),aesModes[suite])keyLen=aesModes[suite].key,ivLen=aesModes[suite].iv;else{if(!desModes[suite])throw new TypeError("invalid suite type");keyLen=8*desModes[suite].key,ivLen=desModes[suite].iv}var keys=ebtk(password,!1,keyLen,ivLen);return createDecipheriv(suite,keys.key,keys.iv)},exports.createDecipheriv=exports.Decipheriv=createDecipheriv,exports.listCiphers=exports.getCiphers=function(){return Object.keys(desModes).concat(aes.getCiphers())}},function(module,exports,__webpack_require__){(function(Buffer){var CipherBase=__webpack_require__(13),des=__webpack_require__(41),inherits=__webpack_require__(1),modes={"des-ede3-cbc":des.CBC.instantiate(des.EDE),"des-ede3":des.EDE,"des-ede-cbc":des.CBC.instantiate(des.EDE),"des-ede":des.EDE,"des-cbc":des.CBC.instantiate(des.DES),"des-ecb":des.DES};function DES(opts){CipherBase.call(this);var type,modeName=opts.mode.toLowerCase(),mode=modes[modeName];type=opts.decrypt?"decrypt":"encrypt";var key=opts.key;"des-ede"!==modeName&&"des-ede-cbc"!==modeName||(key=Buffer.concat([key,key.slice(0,8)]));var iv=opts.iv;this._des=mode.create({key:key,iv:iv,type:type})}modes.des=modes["des-cbc"],modes.des3=modes["des-ede3-cbc"],module.exports=DES,inherits(DES,CipherBase),DES.prototype._update=function(data){return new Buffer(this._des.update(data))},DES.prototype._final=function(){return new Buffer(this._des.final())}}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){"use strict";exports.readUInt32BE=function(bytes,off){return(bytes[0+off]<<24|bytes[1+off]<<16|bytes[2+off]<<8|bytes[3+off])>>>0},exports.writeUInt32BE=function(bytes,value,off){bytes[0+off]=value>>>24,bytes[1+off]=value>>>16&255,bytes[2+off]=value>>>8&255,bytes[3+off]=255&value},exports.ip=function(inL,inR,out,off){for(var outL=0,outR=0,i=6;i>=0;i-=2){for(var j=0;j<=24;j+=8)outL<<=1,outL|=inR>>>j+i&1;for(j=0;j<=24;j+=8)outL<<=1,outL|=inL>>>j+i&1}for(i=6;i>=0;i-=2){for(j=1;j<=25;j+=8)outR<<=1,outR|=inR>>>j+i&1;for(j=1;j<=25;j+=8)outR<<=1,outR|=inL>>>j+i&1}out[off+0]=outL>>>0,out[off+1]=outR>>>0},exports.rip=function(inL,inR,out,off){for(var outL=0,outR=0,i=0;i<4;i++)for(var j=24;j>=0;j-=8)outL<<=1,outL|=inR>>>j+i&1,outL<<=1,outL|=inL>>>j+i&1;for(i=4;i<8;i++)for(j=24;j>=0;j-=8)outR<<=1,outR|=inR>>>j+i&1,outR<<=1,outR|=inL>>>j+i&1;out[off+0]=outL>>>0,out[off+1]=outR>>>0},exports.pc1=function(inL,inR,out,off){for(var outL=0,outR=0,i=7;i>=5;i--){for(var j=0;j<=24;j+=8)outL<<=1,outL|=inR>>j+i&1;for(j=0;j<=24;j+=8)outL<<=1,outL|=inL>>j+i&1}for(j=0;j<=24;j+=8)outL<<=1,outL|=inR>>j+i&1;for(i=1;i<=3;i++){for(j=0;j<=24;j+=8)outR<<=1,outR|=inR>>j+i&1;for(j=0;j<=24;j+=8)outR<<=1,outR|=inL>>j+i&1}for(j=0;j<=24;j+=8)outR<<=1,outR|=inL>>j+i&1;out[off+0]=outL>>>0,out[off+1]=outR>>>0},exports.r28shl=function(num,shift){return num<<shift&268435455|num>>>28-shift};var pc2table=[14,11,17,4,27,23,25,0,13,22,7,18,5,9,16,24,2,20,12,21,1,8,15,26,15,4,25,19,9,1,26,16,5,11,23,8,12,7,17,0,22,3,10,14,6,20,27,24];exports.pc2=function(inL,inR,out,off){for(var outL=0,outR=0,len=pc2table.length>>>1,i=0;i<len;i++)outL<<=1,outL|=inL>>>pc2table[i]&1;for(i=len;i<pc2table.length;i++)outR<<=1,outR|=inR>>>pc2table[i]&1;out[off+0]=outL>>>0,out[off+1]=outR>>>0},exports.expand=function(r,out,off){var outL=0,outR=0;outL=(1&r)<<5|r>>>27;for(var i=23;i>=15;i-=4)outL<<=6,outL|=r>>>i&63;for(i=11;i>=3;i-=4)outR|=r>>>i&63,outR<<=6;outR|=(31&r)<<1|r>>>31,out[off+0]=outL>>>0,out[off+1]=outR>>>0};var sTable=[14,0,4,15,13,7,1,4,2,14,15,2,11,13,8,1,3,10,10,6,6,12,12,11,5,9,9,5,0,3,7,8,4,15,1,12,14,8,8,2,13,4,6,9,2,1,11,7,15,5,12,11,9,3,7,14,3,10,10,0,5,6,0,13,15,3,1,13,8,4,14,7,6,15,11,2,3,8,4,14,9,12,7,0,2,1,13,10,12,6,0,9,5,11,10,5,0,13,14,8,7,10,11,1,10,3,4,15,13,4,1,2,5,11,8,6,12,7,6,12,9,0,3,5,2,14,15,9,10,13,0,7,9,0,14,9,6,3,3,4,15,6,5,10,1,2,13,8,12,5,7,14,11,12,4,11,2,15,8,1,13,1,6,10,4,13,9,0,8,6,15,9,3,8,0,7,11,4,1,15,2,14,12,3,5,11,10,5,14,2,7,12,7,13,13,8,14,11,3,5,0,6,6,15,9,0,10,3,1,4,2,7,8,2,5,12,11,1,12,10,4,14,15,9,10,3,6,15,9,0,0,6,12,10,11,1,7,13,13,8,15,9,1,4,3,5,14,11,5,12,2,7,8,2,4,14,2,14,12,11,4,2,1,12,7,4,10,7,11,13,6,1,8,5,5,0,3,15,15,10,13,3,0,9,14,8,9,6,4,11,2,8,1,12,11,7,10,1,13,14,7,2,8,13,15,6,9,15,12,0,5,9,6,10,3,4,0,5,14,3,12,10,1,15,10,4,15,2,9,7,2,12,6,9,8,5,0,6,13,1,3,13,4,14,14,0,7,11,5,3,11,8,9,4,14,3,15,2,5,12,2,9,8,5,12,15,3,10,7,11,0,14,4,1,10,7,1,6,13,0,11,8,6,13,4,13,11,0,2,11,14,7,15,4,0,9,8,1,13,10,3,14,12,3,9,5,7,12,5,2,10,15,6,8,1,6,1,6,4,11,11,13,13,8,12,1,3,4,7,10,14,7,10,9,15,5,6,0,8,15,0,14,5,2,9,3,2,12,13,1,2,15,8,13,4,8,6,10,15,3,11,7,1,4,10,12,9,5,3,6,14,11,5,0,0,14,12,9,7,2,7,2,11,1,4,14,1,7,9,4,12,10,14,8,2,13,0,15,6,12,10,9,13,0,15,3,3,5,5,6,8,11];exports.substitute=function(inL,inR){for(var out=0,i=0;i<4;i++){out<<=4,out|=sTable[64*i+(inL>>>18-6*i&63)]}for(i=0;i<4;i++){out<<=4,out|=sTable[256+64*i+(inR>>>18-6*i&63)]}return out>>>0};var permuteTable=[16,25,12,11,3,20,4,15,31,17,9,6,27,14,1,22,30,24,8,18,0,5,29,23,13,19,2,26,10,21,28,7];exports.permute=function(num){for(var out=0,i=0;i<permuteTable.length;i++)out<<=1,out|=num>>>permuteTable[i]&1;return out>>>0},exports.padSplit=function(num,size,group){for(var str=num.toString(2);str.length<size;)str="0"+str;for(var out=[],i=0;i<size;i+=group)out.push(str.slice(i,i+group));return out.join(" ")}},function(module,exports,__webpack_require__){"use strict";var assert=__webpack_require__(9);function Cipher(options){this.options=options,this.type=this.options.type,this.blockSize=8,this._init(),this.buffer=new Array(this.blockSize),this.bufferOff=0}module.exports=Cipher,Cipher.prototype._init=function(){},Cipher.prototype.update=function(data){return 0===data.length?[]:"decrypt"===this.type?this._updateDecrypt(data):this._updateEncrypt(data)},Cipher.prototype._buffer=function(data,off){for(var min=Math.min(this.buffer.length-this.bufferOff,data.length-off),i=0;i<min;i++)this.buffer[this.bufferOff+i]=data[off+i];return this.bufferOff+=min,min},Cipher.prototype._flushBuffer=function(out,off){return this._update(this.buffer,0,out,off),this.bufferOff=0,this.blockSize},Cipher.prototype._updateEncrypt=function(data){var inputOff=0,outputOff=0,count=(this.bufferOff+data.length)/this.blockSize|0,out=new Array(count*this.blockSize);0!==this.bufferOff&&(inputOff+=this._buffer(data,inputOff),this.bufferOff===this.buffer.length&&(outputOff+=this._flushBuffer(out,outputOff)));for(var max=data.length-(data.length-inputOff)%this.blockSize;inputOff<max;inputOff+=this.blockSize)this._update(data,inputOff,out,outputOff),outputOff+=this.blockSize;for(;inputOff<data.length;inputOff++,this.bufferOff++)this.buffer[this.bufferOff]=data[inputOff];return out},Cipher.prototype._updateDecrypt=function(data){for(var inputOff=0,outputOff=0,count=Math.ceil((this.bufferOff+data.length)/this.blockSize)-1,out=new Array(count*this.blockSize);count>0;count--)inputOff+=this._buffer(data,inputOff),outputOff+=this._flushBuffer(out,outputOff);return inputOff+=this._buffer(data,inputOff),out},Cipher.prototype.final=function(buffer){var first,last;return buffer&&(first=this.update(buffer)),last="encrypt"===this.type?this._finalEncrypt():this._finalDecrypt(),first?first.concat(last):last},Cipher.prototype._pad=function(buffer,off){if(0===off)return!1;for(;off<buffer.length;)buffer[off++]=0;return!0},Cipher.prototype._finalEncrypt=function(){if(!this._pad(this.buffer,this.bufferOff))return[];var out=new Array(this.blockSize);return this._update(this.buffer,0,out,0),out},Cipher.prototype._unpad=function(buffer){return buffer},Cipher.prototype._finalDecrypt=function(){assert.equal(this.bufferOff,this.blockSize,"Not enough data to decrypt");var out=new Array(this.blockSize);return this._flushBuffer(out,0),this._unpad(out)}},function(module,exports,__webpack_require__){"use strict";var assert=__webpack_require__(9),inherits=__webpack_require__(1),des=__webpack_require__(41),utils=des.utils,Cipher=des.Cipher;function DESState(){this.tmp=new Array(2),this.keys=null}function DES(options){Cipher.call(this,options);var state=new DESState;this._desState=state,this.deriveKeys(state,options.key)}inherits(DES,Cipher),module.exports=DES,DES.create=function(options){return new DES(options)};var shiftTable=[1,1,2,2,2,2,2,2,1,2,2,2,2,2,2,1];DES.prototype.deriveKeys=function(state,key){state.keys=new Array(32),assert.equal(key.length,this.blockSize,"Invalid key length");var kL=utils.readUInt32BE(key,0),kR=utils.readUInt32BE(key,4);utils.pc1(kL,kR,state.tmp,0),kL=state.tmp[0],kR=state.tmp[1];for(var i=0;i<state.keys.length;i+=2){var shift=shiftTable[i>>>1];kL=utils.r28shl(kL,shift),kR=utils.r28shl(kR,shift),utils.pc2(kL,kR,state.keys,i)}},DES.prototype._update=function(inp,inOff,out,outOff){var state=this._desState,l=utils.readUInt32BE(inp,inOff),r=utils.readUInt32BE(inp,inOff+4);utils.ip(l,r,state.tmp,0),l=state.tmp[0],r=state.tmp[1],"encrypt"===this.type?this._encrypt(state,l,r,state.tmp,0):this._decrypt(state,l,r,state.tmp,0),l=state.tmp[0],r=state.tmp[1],utils.writeUInt32BE(out,l,outOff),utils.writeUInt32BE(out,r,outOff+4)},DES.prototype._pad=function(buffer,off){for(var value=buffer.length-off,i=off;i<buffer.length;i++)buffer[i]=value;return!0},DES.prototype._unpad=function(buffer){for(var pad=buffer[buffer.length-1],i=buffer.length-pad;i<buffer.length;i++)assert.equal(buffer[i],pad);return buffer.slice(0,buffer.length-pad)},DES.prototype._encrypt=function(state,lStart,rStart,out,off){for(var l=lStart,r=rStart,i=0;i<state.keys.length;i+=2){var keyL=state.keys[i],keyR=state.keys[i+1];utils.expand(r,state.tmp,0),keyL^=state.tmp[0],keyR^=state.tmp[1];var s=utils.substitute(keyL,keyR),t=r;r=(l^utils.permute(s))>>>0,l=t}utils.rip(r,l,out,off)},DES.prototype._decrypt=function(state,lStart,rStart,out,off){for(var l=rStart,r=lStart,i=state.keys.length-2;i>=0;i-=2){var keyL=state.keys[i],keyR=state.keys[i+1];utils.expand(l,state.tmp,0),keyL^=state.tmp[0],keyR^=state.tmp[1];var s=utils.substitute(keyL,keyR),t=l;l=(r^utils.permute(s))>>>0,r=t}utils.rip(l,r,out,off)}},function(module,exports,__webpack_require__){"use strict";var assert=__webpack_require__(9),inherits=__webpack_require__(1),proto={};function CBCState(iv){assert.equal(iv.length,8,"Invalid IV length"),this.iv=new Array(8);for(var i=0;i<this.iv.length;i++)this.iv[i]=iv[i]}exports.instantiate=function(Base){function CBC(options){Base.call(this,options),this._cbcInit()}inherits(CBC,Base);for(var keys=Object.keys(proto),i=0;i<keys.length;i++){var key=keys[i];CBC.prototype[key]=proto[key]}return CBC.create=function(options){return new CBC(options)},CBC},proto._cbcInit=function(){var state=new CBCState(this.options.iv);this._cbcState=state},proto._update=function(inp,inOff,out,outOff){var state=this._cbcState,superProto=this.constructor.super_.prototype,iv=state.iv;if("encrypt"===this.type){for(var i=0;i<this.blockSize;i++)iv[i]^=inp[inOff+i];superProto._update.call(this,iv,0,out,outOff);for(i=0;i<this.blockSize;i++)iv[i]=out[outOff+i]}else{superProto._update.call(this,inp,inOff,out,outOff);for(i=0;i<this.blockSize;i++)out[outOff+i]^=iv[i];for(i=0;i<this.blockSize;i++)iv[i]=inp[inOff+i]}}},function(module,exports,__webpack_require__){"use strict";var assert=__webpack_require__(9),inherits=__webpack_require__(1),des=__webpack_require__(41),Cipher=des.Cipher,DES=des.DES;function EDEState(type,key){assert.equal(key.length,24,"Invalid key length");var k1=key.slice(0,8),k2=key.slice(8,16),k3=key.slice(16,24);this.ciphers="encrypt"===type?[DES.create({type:"encrypt",key:k1}),DES.create({type:"decrypt",key:k2}),DES.create({type:"encrypt",key:k3})]:[DES.create({type:"decrypt",key:k3}),DES.create({type:"encrypt",key:k2}),DES.create({type:"decrypt",key:k1})]}function EDE(options){Cipher.call(this,options);var state=new EDEState(this.type,this.options.key);this._edeState=state}inherits(EDE,Cipher),module.exports=EDE,EDE.create=function(options){return new EDE(options)},EDE.prototype._update=function(inp,inOff,out,outOff){var state=this._edeState;state.ciphers[0]._update(inp,inOff,out,outOff),state.ciphers[1]._update(out,outOff,out,outOff),state.ciphers[2]._update(out,outOff,out,outOff)},EDE.prototype._pad=DES.prototype._pad,EDE.prototype._unpad=DES.prototype._unpad},function(module,exports,__webpack_require__){var MODES=__webpack_require__(43),AuthCipher=__webpack_require__(66),Buffer=__webpack_require__(4).Buffer,StreamCipher=__webpack_require__(67),Transform=__webpack_require__(13),aes=__webpack_require__(29),ebtk=__webpack_require__(30);function Cipher(mode,key,iv){Transform.call(this),this._cache=new Splitter,this._cipher=new aes.AES(key),this._prev=Buffer.from(iv),this._mode=mode,this._autopadding=!0}__webpack_require__(1)(Cipher,Transform),Cipher.prototype._update=function(data){var chunk,thing;this._cache.add(data);for(var out=[];chunk=this._cache.get();)thing=this._mode.encrypt(this,chunk),out.push(thing);return Buffer.concat(out)};var PADDING=Buffer.alloc(16,16);function Splitter(){this.cache=Buffer.allocUnsafe(0)}function createCipheriv(suite,password,iv){var config=MODES[suite.toLowerCase()];if(!config)throw new TypeError("invalid suite type");if("string"==typeof password&&(password=Buffer.from(password)),password.length!==config.key/8)throw new TypeError("invalid key length "+password.length);if("string"==typeof iv&&(iv=Buffer.from(iv)),"GCM"!==config.mode&&iv.length!==config.iv)throw new TypeError("invalid iv length "+iv.length);return"stream"===config.type?new StreamCipher(config.module,password,iv):"auth"===config.type?new AuthCipher(config.module,password,iv):new Cipher(config.module,password,iv)}Cipher.prototype._final=function(){var chunk=this._cache.flush();if(this._autopadding)return chunk=this._mode.encrypt(this,chunk),this._cipher.scrub(),chunk;if(!chunk.equals(PADDING))throw this._cipher.scrub(),new Error("data not multiple of block length")},Cipher.prototype.setAutoPadding=function(setTo){return this._autopadding=!!setTo,this},Splitter.prototype.add=function(data){this.cache=Buffer.concat([this.cache,data])},Splitter.prototype.get=function(){if(this.cache.length>15){var out=this.cache.slice(0,16);return this.cache=this.cache.slice(16),out}return null},Splitter.prototype.flush=function(){for(var len=16-this.cache.length,padBuff=Buffer.allocUnsafe(len),i=-1;++i<len;)padBuff.writeUInt8(len,i);return Buffer.concat([this.cache,padBuff])},exports.createCipheriv=createCipheriv,exports.createCipher=function(suite,password){var config=MODES[suite.toLowerCase()];if(!config)throw new TypeError("invalid suite type");var keys=ebtk(password,!1,config.key,config.iv);return createCipheriv(suite,keys.key,keys.iv)}},function(module,exports){exports.encrypt=function(self,block){return self._cipher.encryptBlock(block)},exports.decrypt=function(self,block){return self._cipher.decryptBlock(block)}},function(module,exports,__webpack_require__){var xor=__webpack_require__(23);exports.encrypt=function(self,block){var data=xor(block,self._prev);return self._prev=self._cipher.encryptBlock(data),self._prev},exports.decrypt=function(self,block){var pad=self._prev;self._prev=block;var out=self._cipher.decryptBlock(block);return xor(out,pad)}},function(module,exports,__webpack_require__){var Buffer=__webpack_require__(4).Buffer,xor=__webpack_require__(23);function encryptStart(self,data,decrypt){var len=data.length,out=xor(data,self._cache);return self._cache=self._cache.slice(len),self._prev=Buffer.concat([self._prev,decrypt?data:out]),out}exports.encrypt=function(self,data,decrypt){for(var len,out=Buffer.allocUnsafe(0);data.length;){if(0===self._cache.length&&(self._cache=self._cipher.encryptBlock(self._prev),self._prev=Buffer.allocUnsafe(0)),!(self._cache.length<=data.length)){out=Buffer.concat([out,encryptStart(self,data,decrypt)]);break}len=self._cache.length,out=Buffer.concat([out,encryptStart(self,data.slice(0,len),decrypt)]),data=data.slice(len)}return out}},function(module,exports,__webpack_require__){var Buffer=__webpack_require__(4).Buffer;function encryptByte(self,byteParam,decrypt){var out=self._cipher.encryptBlock(self._prev)[0]^byteParam;return self._prev=Buffer.concat([self._prev.slice(1),Buffer.from([decrypt?byteParam:out])]),out}exports.encrypt=function(self,chunk,decrypt){for(var len=chunk.length,out=Buffer.allocUnsafe(len),i=-1;++i<len;)out[i]=encryptByte(self,chunk[i],decrypt);return out}},function(module,exports,__webpack_require__){var Buffer=__webpack_require__(4).Buffer;function encryptByte(self,byteParam,decrypt){for(var bit,value,i=-1,out=0;++i<8;)bit=byteParam&1<<7-i?128:0,out+=(128&(value=self._cipher.encryptBlock(self._prev)[0]^bit))>>i%8,self._prev=shiftIn(self._prev,decrypt?bit:value);return out}function shiftIn(buffer,value){var len=buffer.length,i=-1,out=Buffer.allocUnsafe(buffer.length);for(buffer=Buffer.concat([buffer,Buffer.from([value])]);++i<len;)out[i]=buffer[i]<<1|buffer[i+1]>>7;return out}exports.encrypt=function(self,chunk,decrypt){for(var len=chunk.length,out=Buffer.allocUnsafe(len),i=-1;++i<len;)out[i]=encryptByte(self,chunk[i],decrypt);return out}},function(module,exports,__webpack_require__){(function(Buffer){var xor=__webpack_require__(23);function getBlock(self){return self._prev=self._cipher.encryptBlock(self._prev),self._prev}exports.encrypt=function(self,chunk){for(;self._cache.length<chunk.length;)self._cache=Buffer.concat([self._cache,getBlock(self)]);var pad=self._cache.slice(0,chunk.length);return self._cache=self._cache.slice(chunk.length),xor(chunk,pad)}}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){var Buffer=__webpack_require__(4).Buffer,ZEROES=Buffer.alloc(16,0);function fromArray(out){var buf=Buffer.allocUnsafe(16);return buf.writeUInt32BE(out[0]>>>0,0),buf.writeUInt32BE(out[1]>>>0,4),buf.writeUInt32BE(out[2]>>>0,8),buf.writeUInt32BE(out[3]>>>0,12),buf}function GHASH(key){this.h=key,this.state=Buffer.alloc(16,0),this.cache=Buffer.allocUnsafe(0)}GHASH.prototype.ghash=function(block){for(var i=-1;++i<block.length;)this.state[i]^=block[i];this._multiply()},GHASH.prototype._multiply=function(){for(var buf,j,lsbVi,Vi=[(buf=this.h).readUInt32BE(0),buf.readUInt32BE(4),buf.readUInt32BE(8),buf.readUInt32BE(12)],Zi=[0,0,0,0],i=-1;++i<128;){for(0!=(this.state[~~(i/8)]&1<<7-i%8)&&(Zi[0]^=Vi[0],Zi[1]^=Vi[1],Zi[2]^=Vi[2],Zi[3]^=Vi[3]),lsbVi=0!=(1&Vi[3]),j=3;j>0;j--)Vi[j]=Vi[j]>>>1|(1&Vi[j-1])<<31;Vi[0]=Vi[0]>>>1,lsbVi&&(Vi[0]=Vi[0]^225<<24)}this.state=fromArray(Zi)},GHASH.prototype.update=function(buf){var chunk;for(this.cache=Buffer.concat([this.cache,buf]);this.cache.length>=16;)chunk=this.cache.slice(0,16),this.cache=this.cache.slice(16),this.ghash(chunk)},GHASH.prototype.final=function(abl,bl){return this.cache.length&&this.ghash(Buffer.concat([this.cache,ZEROES],16)),this.ghash(fromArray([0,abl,0,bl])),this.state},module.exports=GHASH},function(module,exports,__webpack_require__){var AuthCipher=__webpack_require__(66),Buffer=__webpack_require__(4).Buffer,MODES=__webpack_require__(43),StreamCipher=__webpack_require__(67),Transform=__webpack_require__(13),aes=__webpack_require__(29),ebtk=__webpack_require__(30);function Decipher(mode,key,iv){Transform.call(this),this._cache=new Splitter,this._last=void 0,this._cipher=new aes.AES(key),this._prev=Buffer.from(iv),this._mode=mode,this._autopadding=!0}function Splitter(){this.cache=Buffer.allocUnsafe(0)}function createDecipheriv(suite,password,iv){var config=MODES[suite.toLowerCase()];if(!config)throw new TypeError("invalid suite type");if("string"==typeof iv&&(iv=Buffer.from(iv)),"GCM"!==config.mode&&iv.length!==config.iv)throw new TypeError("invalid iv length "+iv.length);if("string"==typeof password&&(password=Buffer.from(password)),password.length!==config.key/8)throw new TypeError("invalid key length "+password.length);return"stream"===config.type?new StreamCipher(config.module,password,iv,!0):"auth"===config.type?new AuthCipher(config.module,password,iv,!0):new Decipher(config.module,password,iv)}__webpack_require__(1)(Decipher,Transform),Decipher.prototype._update=function(data){var chunk,thing;this._cache.add(data);for(var out=[];chunk=this._cache.get(this._autopadding);)thing=this._mode.decrypt(this,chunk),out.push(thing);return Buffer.concat(out)},Decipher.prototype._final=function(){var chunk=this._cache.flush();if(this._autopadding)return function(last){var padded=last[15];if(padded<1||padded>16)throw new Error("unable to decrypt data");var i=-1;for(;++i<padded;)if(last[i+(16-padded)]!==padded)throw new Error("unable to decrypt data");if(16===padded)return;return last.slice(0,16-padded)}(this._mode.decrypt(this,chunk));if(chunk)throw new Error("data not multiple of block length")},Decipher.prototype.setAutoPadding=function(setTo){return this._autopadding=!!setTo,this},Splitter.prototype.add=function(data){this.cache=Buffer.concat([this.cache,data])},Splitter.prototype.get=function(autoPadding){var out;if(autoPadding){if(this.cache.length>16)return out=this.cache.slice(0,16),this.cache=this.cache.slice(16),out}else if(this.cache.length>=16)return out=this.cache.slice(0,16),this.cache=this.cache.slice(16),out;return null},Splitter.prototype.flush=function(){if(this.cache.length)return this.cache},exports.createDecipher=function(suite,password){var config=MODES[suite.toLowerCase()];if(!config)throw new TypeError("invalid suite type");var keys=ebtk(password,!1,config.key,config.iv);return createDecipheriv(suite,keys.key,keys.iv)},exports.createDecipheriv=createDecipheriv},function(module,exports){exports["des-ecb"]={key:8,iv:0},exports["des-cbc"]=exports.des={key:8,iv:8},exports["des-ede3-cbc"]=exports.des3={key:24,iv:8},exports["des-ede3"]={key:24,iv:0},exports["des-ede-cbc"]={key:16,iv:8},exports["des-ede"]={key:16,iv:0}},function(module,exports,__webpack_require__){(function(Buffer){var generatePrime=__webpack_require__(68),primes=__webpack_require__(150),DH=__webpack_require__(151);var ENCODINGS={binary:!0,hex:!0,base64:!0};exports.DiffieHellmanGroup=exports.createDiffieHellmanGroup=exports.getDiffieHellman=function(mod){var prime=new Buffer(primes[mod].prime,"hex"),gen=new Buffer(primes[mod].gen,"hex");return new DH(prime,gen)},exports.createDiffieHellman=exports.DiffieHellman=function createDiffieHellman(prime,enc,generator,genc){return Buffer.isBuffer(enc)||void 0===ENCODINGS[enc]?createDiffieHellman(prime,"binary",enc,generator):(enc=enc||"binary",genc=genc||"binary",generator=generator||new Buffer([2]),Buffer.isBuffer(generator)||(generator=new Buffer(generator,genc)),"number"==typeof prime?new DH(generatePrime(prime,generator),generator,!0):(Buffer.isBuffer(prime)||(prime=new Buffer(prime,enc)),new DH(prime,generator,!0)))}}).call(this,__webpack_require__(5).Buffer)},function(module,exports){module.exports=function(module){return module.webpackPolyfill||(module.deprecate=function(){},module.paths=[],module.children||(module.children=[]),Object.defineProperty(module,"loaded",{enumerable:!0,get:function(){return module.l}}),Object.defineProperty(module,"id",{enumerable:!0,get:function(){return module.i}}),module.webpackPolyfill=1),module}},function(module,exports){},function(module,exports){},function(module){module.exports=JSON.parse('{"modp1":{"gen":"02","prime":"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a63a3620ffffffffffffffff"},"modp2":{"gen":"02","prime":"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece65381ffffffffffffffff"},"modp5":{"gen":"02","prime":"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca237327ffffffffffffffff"},"modp14":{"gen":"02","prime":"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aacaa68ffffffffffffffff"},"modp15":{"gen":"02","prime":"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aaac42dad33170d04507a33a85521abdf1cba64ecfb850458dbef0a8aea71575d060c7db3970f85a6e1e4c7abf5ae8cdb0933d71e8c94e04a25619dcee3d2261ad2ee6bf12ffa06d98a0864d87602733ec86a64521f2b18177b200cbbe117577a615d6c770988c0bad946e208e24fa074e5ab3143db5bfce0fd108e4b82d120a93ad2caffffffffffffffff"},"modp16":{"gen":"02","prime":"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aaac42dad33170d04507a33a85521abdf1cba64ecfb850458dbef0a8aea71575d060c7db3970f85a6e1e4c7abf5ae8cdb0933d71e8c94e04a25619dcee3d2261ad2ee6bf12ffa06d98a0864d87602733ec86a64521f2b18177b200cbbe117577a615d6c770988c0bad946e208e24fa074e5ab3143db5bfce0fd108e4b82d120a92108011a723c12a787e6d788719a10bdba5b2699c327186af4e23c1a946834b6150bda2583e9ca2ad44ce8dbbbc2db04de8ef92e8efc141fbecaa6287c59474e6bc05d99b2964fa090c3a2233ba186515be7ed1f612970cee2d7afb81bdd762170481cd0069127d5b05aa993b4ea988d8fddc186ffb7dc90a6c08f4df435c934063199ffffffffffffffff"},"modp17":{"gen":"02","prime":"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aaac42dad33170d04507a33a85521abdf1cba64ecfb850458dbef0a8aea71575d060c7db3970f85a6e1e4c7abf5ae8cdb0933d71e8c94e04a25619dcee3d2261ad2ee6bf12ffa06d98a0864d87602733ec86a64521f2b18177b200cbbe117577a615d6c770988c0bad946e208e24fa074e5ab3143db5bfce0fd108e4b82d120a92108011a723c12a787e6d788719a10bdba5b2699c327186af4e23c1a946834b6150bda2583e9ca2ad44ce8dbbbc2db04de8ef92e8efc141fbecaa6287c59474e6bc05d99b2964fa090c3a2233ba186515be7ed1f612970cee2d7afb81bdd762170481cd0069127d5b05aa993b4ea988d8fddc186ffb7dc90a6c08f4df435c93402849236c3fab4d27c7026c1d4dcb2602646dec9751e763dba37bdf8ff9406ad9e530ee5db382f413001aeb06a53ed9027d831179727b0865a8918da3edbebcf9b14ed44ce6cbaced4bb1bdb7f1447e6cc254b332051512bd7af426fb8f401378cd2bf5983ca01c64b92ecf032ea15d1721d03f482d7ce6e74fef6d55e702f46980c82b5a84031900b1c9e59e7c97fbec7e8f323a97a7e36cc88be0f1d45b7ff585ac54bd407b22b4154aacc8f6d7ebf48e1d814cc5ed20f8037e0a79715eef29be32806a1d58bb7c5da76f550aa3d8a1fbff0eb19ccb1a313d55cda56c9ec2ef29632387fe8d76e3c0468043e8f663f4860ee12bf2d5b0b7474d6e694f91e6dcc4024ffffffffffffffff"},"modp18":{"gen":"02","prime":"ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea63b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f24117c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08ca18217c32905e462e36ce3be39e772c180e86039b2783a2ec07a28fb5c55df06f4c52c9de2bcbf6955817183995497cea956ae515d2261898fa051015728e5a8aaac42dad33170d04507a33a85521abdf1cba64ecfb850458dbef0a8aea71575d060c7db3970f85a6e1e4c7abf5ae8cdb0933d71e8c94e04a25619dcee3d2261ad2ee6bf12ffa06d98a0864d87602733ec86a64521f2b18177b200cbbe117577a615d6c770988c0bad946e208e24fa074e5ab3143db5bfce0fd108e4b82d120a92108011a723c12a787e6d788719a10bdba5b2699c327186af4e23c1a946834b6150bda2583e9ca2ad44ce8dbbbc2db04de8ef92e8efc141fbecaa6287c59474e6bc05d99b2964fa090c3a2233ba186515be7ed1f612970cee2d7afb81bdd762170481cd0069127d5b05aa993b4ea988d8fddc186ffb7dc90a6c08f4df435c93402849236c3fab4d27c7026c1d4dcb2602646dec9751e763dba37bdf8ff9406ad9e530ee5db382f413001aeb06a53ed9027d831179727b0865a8918da3edbebcf9b14ed44ce6cbaced4bb1bdb7f1447e6cc254b332051512bd7af426fb8f401378cd2bf5983ca01c64b92ecf032ea15d1721d03f482d7ce6e74fef6d55e702f46980c82b5a84031900b1c9e59e7c97fbec7e8f323a97a7e36cc88be0f1d45b7ff585ac54bd407b22b4154aacc8f6d7ebf48e1d814cc5ed20f8037e0a79715eef29be32806a1d58bb7c5da76f550aa3d8a1fbff0eb19ccb1a313d55cda56c9ec2ef29632387fe8d76e3c0468043e8f663f4860ee12bf2d5b0b7474d6e694f91e6dbe115974a3926f12fee5e438777cb6a932df8cd8bec4d073b931ba3bc832b68d9dd300741fa7bf8afc47ed2576f6936ba424663aab639c5ae4f5683423b4742bf1c978238f16cbe39d652de3fdb8befc848ad922222e04a4037c0713eb57a81a23f0c73473fc646cea306b4bcbc8862f8385ddfa9d4b7fa2c087e879683303ed5bdd3a062b3cf5b3a278a66d2a13f83f44f82ddf310ee074ab6a364597e899a0255dc164f31cc50846851df9ab48195ded7ea1b1d510bd7ee74d73faf36bc31ecfa268359046f4eb879f924009438b481c6cd7889a002ed5ee382bc9190da6fc026e479558e4475677e9aa9e3050e2765694dfc81f56e880b96e7160c980dd98edd3dfffffffffffffffff"}}')},function(module,exports,__webpack_require__){(function(Buffer){var BN=__webpack_require__(6),millerRabin=new(__webpack_require__(69)),TWENTYFOUR=new BN(24),ELEVEN=new BN(11),TEN=new BN(10),THREE=new BN(3),SEVEN=new BN(7),primes=__webpack_require__(68),randomBytes=__webpack_require__(16);function setPublicKey(pub,enc){return enc=enc||"utf8",Buffer.isBuffer(pub)||(pub=new Buffer(pub,enc)),this._pub=new BN(pub),this}function setPrivateKey(priv,enc){return enc=enc||"utf8",Buffer.isBuffer(priv)||(priv=new Buffer(priv,enc)),this._priv=new BN(priv),this}module.exports=DH;var primeCache={};function DH(prime,generator,malleable){this.setGenerator(generator),this.__prime=new BN(prime),this._prime=BN.mont(this.__prime),this._primeLen=prime.length,this._pub=void 0,this._priv=void 0,this._primeCode=void 0,malleable?(this.setPublicKey=setPublicKey,this.setPrivateKey=setPrivateKey):this._primeCode=8}function formatReturnValue(bn,enc){var buf=new Buffer(bn.toArray());return enc?buf.toString(enc):buf}Object.defineProperty(DH.prototype,"verifyError",{enumerable:!0,get:function(){return"number"!=typeof this._primeCode&&(this._primeCode=function(prime,generator){var gen=generator.toString("hex"),hex=[gen,prime.toString(16)].join("_");if(hex in primeCache)return primeCache[hex];var rem,error=0;if(prime.isEven()||!primes.simpleSieve||!primes.fermatTest(prime)||!millerRabin.test(prime))return error+=1,error+="02"===gen||"05"===gen?8:4,primeCache[hex]=error,error;switch(millerRabin.test(prime.shrn(1))||(error+=2),gen){case"02":prime.mod(TWENTYFOUR).cmp(ELEVEN)&&(error+=8);break;case"05":(rem=prime.mod(TEN)).cmp(THREE)&&rem.cmp(SEVEN)&&(error+=8);break;default:error+=4}return primeCache[hex]=error,error}(this.__prime,this.__gen)),this._primeCode}}),DH.prototype.generateKeys=function(){return this._priv||(this._priv=new BN(randomBytes(this._primeLen))),this._pub=this._gen.toRed(this._prime).redPow(this._priv).fromRed(),this.getPublicKey()},DH.prototype.computeSecret=function(other){var secret=(other=(other=new BN(other)).toRed(this._prime)).redPow(this._priv).fromRed(),out=new Buffer(secret.toArray()),prime=this.getPrime();if(out.length<prime.length){var front=new Buffer(prime.length-out.length);front.fill(0),out=Buffer.concat([front,out])}return out},DH.prototype.getPublicKey=function(enc){return formatReturnValue(this._pub,enc)},DH.prototype.getPrivateKey=function(enc){return formatReturnValue(this._priv,enc)},DH.prototype.getPrime=function(enc){return formatReturnValue(this.__prime,enc)},DH.prototype.getGenerator=function(enc){return formatReturnValue(this._gen,enc)},DH.prototype.setGenerator=function(gen,enc){return enc=enc||"utf8",Buffer.isBuffer(gen)||(gen=new Buffer(gen,enc)),this.__gen=gen,this._gen=new BN(gen),this}}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){(function(Buffer){var createHash=__webpack_require__(21),stream=__webpack_require__(35),inherits=__webpack_require__(1),sign=__webpack_require__(153),verify=__webpack_require__(188),algorithms=__webpack_require__(58);function Sign(algorithm){stream.Writable.call(this);var data=algorithms[algorithm];if(!data)throw new Error("Unknown message digest");this._hashType=data.hash,this._hash=createHash(data.hash),this._tag=data.id,this._signType=data.sign}function Verify(algorithm){stream.Writable.call(this);var data=algorithms[algorithm];if(!data)throw new Error("Unknown message digest");this._hash=createHash(data.hash),this._tag=data.id,this._signType=data.sign}function createSign(algorithm){return new Sign(algorithm)}function createVerify(algorithm){return new Verify(algorithm)}Object.keys(algorithms).forEach((function(key){algorithms[key].id=new Buffer(algorithms[key].id,"hex"),algorithms[key.toLowerCase()]=algorithms[key]})),inherits(Sign,stream.Writable),Sign.prototype._write=function(data,_,done){this._hash.update(data),done()},Sign.prototype.update=function(data,enc){return"string"==typeof data&&(data=new Buffer(data,enc)),this._hash.update(data),this},Sign.prototype.sign=function(key,enc){this.end();var hash=this._hash.digest(),sig=sign(hash,key,this._hashType,this._signType,this._tag);return enc?sig.toString(enc):sig},inherits(Verify,stream.Writable),Verify.prototype._write=function(data,_,done){this._hash.update(data),done()},Verify.prototype.update=function(data,enc){return"string"==typeof data&&(data=new Buffer(data,enc)),this._hash.update(data),this},Verify.prototype.verify=function(key,sig,enc){"string"==typeof sig&&(sig=new Buffer(sig,enc)),this.end();var hash=this._hash.digest();return verify(sig,hash,key,this._signType,this._tag)},module.exports={Sign:createSign,Verify:createVerify,createSign:createSign,createVerify:createVerify}}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){(function(Buffer){var createHmac=__webpack_require__(56),crt=__webpack_require__(44),EC=__webpack_require__(8).ec,BN=__webpack_require__(6),parseKeys=__webpack_require__(32),curves=__webpack_require__(79);function getKey(x,q,hash,algo){if((x=new Buffer(x.toArray())).length<q.byteLength()){var zeros=new Buffer(q.byteLength()-x.length);zeros.fill(0),x=Buffer.concat([zeros,x])}var hlen=hash.length,hbits=function(bits,q){bits=(bits=bits2int(bits,q)).mod(q);var out=new Buffer(bits.toArray());if(out.length<q.byteLength()){var zeros=new Buffer(q.byteLength()-out.length);zeros.fill(0),out=Buffer.concat([zeros,out])}return out}(hash,q),v=new Buffer(hlen);v.fill(1);var k=new Buffer(hlen);return k.fill(0),k=createHmac(algo,k).update(v).update(new Buffer([0])).update(x).update(hbits).digest(),v=createHmac(algo,k).update(v).digest(),{k:k=createHmac(algo,k).update(v).update(new Buffer([1])).update(x).update(hbits).digest(),v:v=createHmac(algo,k).update(v).digest()}}function bits2int(obits,q){var bits=new BN(obits),shift=(obits.length<<3)-q.bitLength();return shift>0&&bits.ishrn(shift),bits}function makeKey(q,kv,algo){var t,k;do{for(t=new Buffer(0);8*t.length<q.bitLength();)kv.v=createHmac(algo,kv.k).update(kv.v).digest(),t=Buffer.concat([t,kv.v]);k=bits2int(t,q),kv.k=createHmac(algo,kv.k).update(kv.v).update(new Buffer([0])).digest(),kv.v=createHmac(algo,kv.k).update(kv.v).digest()}while(-1!==k.cmp(q));return k}function makeR(g,k,p,q){return g.toRed(BN.mont(p)).redPow(k).fromRed().mod(q)}module.exports=function(hash,key,hashType,signType,tag){var priv=parseKeys(key);if(priv.curve){if("ecdsa"!==signType&&"ecdsa/rsa"!==signType)throw new Error("wrong private key type");return function(hash,priv){var curveId=curves[priv.curve.join(".")];if(!curveId)throw new Error("unknown curve "+priv.curve.join("."));var out=new EC(curveId).keyFromPrivate(priv.privateKey).sign(hash);return new Buffer(out.toDER())}(hash,priv)}if("dsa"===priv.type){if("dsa"!==signType)throw new Error("wrong private key type");return function(hash,priv,algo){var k,x=priv.params.priv_key,p=priv.params.p,q=priv.params.q,g=priv.params.g,r=new BN(0),H=bits2int(hash,q).mod(q),s=!1,kv=getKey(x,q,hash,algo);for(;!1===s;)k=makeKey(q,kv,algo),r=makeR(g,k,p,q),0===(s=k.invm(q).imul(H.add(x.mul(r))).mod(q)).cmpn(0)&&(s=!1,r=new BN(0));return function(r,s){r=r.toArray(),s=s.toArray(),128&r[0]&&(r=[0].concat(r));128&s[0]&&(s=[0].concat(s));var res=[48,r.length+s.length+4,2,r.length];return res=res.concat(r,[2,s.length],s),new Buffer(res)}(r,s)}(hash,priv,hashType)}if("rsa"!==signType&&"ecdsa/rsa"!==signType)throw new Error("wrong private key type");hash=Buffer.concat([tag,hash]);for(var len=priv.modulus.byteLength(),pad=[0,1];hash.length+pad.length+1<len;)pad.push(255);pad.push(0);for(var i=-1;++i<hash.length;)pad.push(hash[i]);return crt(pad,priv)},module.exports.getKey=getKey,module.exports.makeKey=makeKey}).call(this,__webpack_require__(5).Buffer)},function(module){module.exports=JSON.parse('{"_args":[["elliptic@6.4.0","/home/konrad/web/sdk"]],"_from":"elliptic@6.4.0","_id":"elliptic@6.4.0","_inBundle":false,"_integrity":"sha1-ysmvh2LIWDYYcAPI3+GT5eLq5d8=","_location":"/elliptic","_phantomChildren":{},"_requested":{"type":"version","registry":true,"raw":"elliptic@6.4.0","name":"elliptic","escapedName":"elliptic","rawSpec":"6.4.0","saveSpec":null,"fetchSpec":"6.4.0"},"_requiredBy":["/browserify-sign","/create-ecdh"],"_resolved":"https://registry.npmjs.org/elliptic/-/elliptic-6.4.0.tgz","_spec":"6.4.0","_where":"/home/konrad/web/sdk","author":{"name":"Fedor Indutny","email":"fedor@indutny.com"},"bugs":{"url":"https://github.com/indutny/elliptic/issues"},"dependencies":{"bn.js":"^4.4.0","brorand":"^1.0.1","hash.js":"^1.0.0","hmac-drbg":"^1.0.0","inherits":"^2.0.1","minimalistic-assert":"^1.0.0","minimalistic-crypto-utils":"^1.0.0"},"description":"EC cryptography","devDependencies":{"brfs":"^1.4.3","coveralls":"^2.11.3","grunt":"^0.4.5","grunt-browserify":"^5.0.0","grunt-cli":"^1.2.0","grunt-contrib-connect":"^1.0.0","grunt-contrib-copy":"^1.0.0","grunt-contrib-uglify":"^1.0.1","grunt-mocha-istanbul":"^3.0.1","grunt-saucelabs":"^8.6.2","istanbul":"^0.4.2","jscs":"^2.9.0","jshint":"^2.6.0","mocha":"^2.1.0"},"files":["lib"],"homepage":"https://github.com/indutny/elliptic","keywords":["EC","Elliptic","curve","Cryptography"],"license":"MIT","main":"lib/elliptic.js","name":"elliptic","repository":{"type":"git","url":"git+ssh://git@github.com/indutny/elliptic.git"},"scripts":{"jscs":"jscs benchmarks/*.js lib/*.js lib/**/*.js lib/**/**/*.js test/index.js","jshint":"jscs benchmarks/*.js lib/*.js lib/**/*.js lib/**/**/*.js test/index.js","lint":"npm run jscs && npm run jshint","test":"npm run lint && npm run unit","unit":"istanbul test _mocha --reporter=spec test/index.js","version":"grunt dist && git add dist/"},"version":"6.4.0"}')},function(module,exports,__webpack_require__){"use strict";var utils=exports,BN=__webpack_require__(6),minAssert=__webpack_require__(9),minUtils=__webpack_require__(71);utils.assert=minAssert,utils.toArray=minUtils.toArray,utils.zero2=minUtils.zero2,utils.toHex=minUtils.toHex,utils.encode=minUtils.encode,utils.getNAF=function(num,w){for(var naf=[],ws=1<<w+1,k=num.clone();k.cmpn(1)>=0;){var z;if(k.isOdd()){var mod=k.andln(ws-1);z=mod>(ws>>1)-1?(ws>>1)-mod:mod,k.isubn(z)}else z=0;naf.push(z);for(var shift=0!==k.cmpn(0)&&0===k.andln(ws-1)?w+1:1,i=1;i<shift;i++)naf.push(0);k.iushrn(shift)}return naf},utils.getJSF=function(k1,k2){var jsf=[[],[]];k1=k1.clone(),k2=k2.clone();for(var d1=0,d2=0;k1.cmpn(-d1)>0||k2.cmpn(-d2)>0;){var u1,u2,m8,m14=k1.andln(3)+d1&3,m24=k2.andln(3)+d2&3;if(3===m14&&(m14=-1),3===m24&&(m24=-1),0==(1&m14))u1=0;else u1=3!==(m8=k1.andln(7)+d1&7)&&5!==m8||2!==m24?m14:-m14;if(jsf[0].push(u1),0==(1&m24))u2=0;else u2=3!==(m8=k2.andln(7)+d2&7)&&5!==m8||2!==m14?m24:-m24;jsf[1].push(u2),2*d1===u1+1&&(d1=1-d1),2*d2===u2+1&&(d2=1-d2),k1.iushrn(1),k2.iushrn(1)}return jsf},utils.cachedProperty=function(obj,name,computer){var key="_"+name;obj.prototype[name]=function(){return void 0!==this[key]?this[key]:this[key]=computer.call(this)}},utils.parseBytes=function(bytes){return"string"==typeof bytes?utils.toArray(bytes,"hex"):bytes},utils.intFromLE=function(bytes){return new BN(bytes,"hex","le")}},function(module,exports,__webpack_require__){"use strict";var BN=__webpack_require__(6),utils=__webpack_require__(8).utils,getNAF=utils.getNAF,getJSF=utils.getJSF,assert=utils.assert;function BaseCurve(type,conf){this.type=type,this.p=new BN(conf.p,16),this.red=conf.prime?BN.red(conf.prime):BN.mont(this.p),this.zero=new BN(0).toRed(this.red),this.one=new BN(1).toRed(this.red),this.two=new BN(2).toRed(this.red),this.n=conf.n&&new BN(conf.n,16),this.g=conf.g&&this.pointFromJSON(conf.g,conf.gRed),this._wnafT1=new Array(4),this._wnafT2=new Array(4),this._wnafT3=new Array(4),this._wnafT4=new Array(4);var adjustCount=this.n&&this.p.div(this.n);!adjustCount||adjustCount.cmpn(100)>0?this.redN=null:(this._maxwellTrick=!0,this.redN=this.n.toRed(this.red))}function BasePoint(curve,type){this.curve=curve,this.type=type,this.precomputed=null}module.exports=BaseCurve,BaseCurve.prototype.point=function(){throw new Error("Not implemented")},BaseCurve.prototype.validate=function(){throw new Error("Not implemented")},BaseCurve.prototype._fixedNafMul=function(p,k){assert(p.precomputed);var doubles=p._getDoubles(),naf=getNAF(k,1),I=(1<<doubles.step+1)-(doubles.step%2==0?2:1);I/=3;for(var repr=[],j=0;j<naf.length;j+=doubles.step){var nafW=0;for(k=j+doubles.step-1;k>=j;k--)nafW=(nafW<<1)+naf[k];repr.push(nafW)}for(var a=this.jpoint(null,null,null),b=this.jpoint(null,null,null),i=I;i>0;i--){for(j=0;j<repr.length;j++){(nafW=repr[j])===i?b=b.mixedAdd(doubles.points[j]):nafW===-i&&(b=b.mixedAdd(doubles.points[j].neg()))}a=a.add(b)}return a.toP()},BaseCurve.prototype._wnafMul=function(p,k){var w=4,nafPoints=p._getNAFPoints(w);w=nafPoints.wnd;for(var wnd=nafPoints.points,naf=getNAF(k,w),acc=this.jpoint(null,null,null),i=naf.length-1;i>=0;i--){for(k=0;i>=0&&0===naf[i];i--)k++;if(i>=0&&k++,acc=acc.dblp(k),i<0)break;var z=naf[i];assert(0!==z),acc="affine"===p.type?z>0?acc.mixedAdd(wnd[z-1>>1]):acc.mixedAdd(wnd[-z-1>>1].neg()):z>0?acc.add(wnd[z-1>>1]):acc.add(wnd[-z-1>>1].neg())}return"affine"===p.type?acc.toP():acc},BaseCurve.prototype._wnafMulAdd=function(defW,points,coeffs,len,jacobianResult){for(var wndWidth=this._wnafT1,wnd=this._wnafT2,naf=this._wnafT3,max=0,i=0;i<len;i++){var nafPoints=(p=points[i])._getNAFPoints(defW);wndWidth[i]=nafPoints.wnd,wnd[i]=nafPoints.points}for(i=len-1;i>=1;i-=2){var a=i-1,b=i;if(1===wndWidth[a]&&1===wndWidth[b]){var comb=[points[a],null,null,points[b]];0===points[a].y.cmp(points[b].y)?(comb[1]=points[a].add(points[b]),comb[2]=points[a].toJ().mixedAdd(points[b].neg())):0===points[a].y.cmp(points[b].y.redNeg())?(comb[1]=points[a].toJ().mixedAdd(points[b]),comb[2]=points[a].add(points[b].neg())):(comb[1]=points[a].toJ().mixedAdd(points[b]),comb[2]=points[a].toJ().mixedAdd(points[b].neg()));var index=[-3,-1,-5,-7,0,7,5,1,3],jsf=getJSF(coeffs[a],coeffs[b]);max=Math.max(jsf[0].length,max),naf[a]=new Array(max),naf[b]=new Array(max);for(var j=0;j<max;j++){var ja=0|jsf[0][j],jb=0|jsf[1][j];naf[a][j]=index[3*(ja+1)+(jb+1)],naf[b][j]=0,wnd[a]=comb}}else naf[a]=getNAF(coeffs[a],wndWidth[a]),naf[b]=getNAF(coeffs[b],wndWidth[b]),max=Math.max(naf[a].length,max),max=Math.max(naf[b].length,max)}var acc=this.jpoint(null,null,null),tmp=this._wnafT4;for(i=max;i>=0;i--){for(var k=0;i>=0;){var zero=!0;for(j=0;j<len;j++)tmp[j]=0|naf[j][i],0!==tmp[j]&&(zero=!1);if(!zero)break;k++,i--}if(i>=0&&k++,acc=acc.dblp(k),i<0)break;for(j=0;j<len;j++){var p,z=tmp[j];0!==z&&(z>0?p=wnd[j][z-1>>1]:z<0&&(p=wnd[j][-z-1>>1].neg()),acc="affine"===p.type?acc.mixedAdd(p):acc.add(p))}}for(i=0;i<len;i++)wnd[i]=null;return jacobianResult?acc:acc.toP()},BaseCurve.BasePoint=BasePoint,BasePoint.prototype.eq=function(){throw new Error("Not implemented")},BasePoint.prototype.validate=function(){return this.curve.validate(this)},BaseCurve.prototype.decodePoint=function(bytes,enc){bytes=utils.toArray(bytes,enc);var len=this.p.byteLength();if((4===bytes[0]||6===bytes[0]||7===bytes[0])&&bytes.length-1==2*len)return 6===bytes[0]?assert(bytes[bytes.length-1]%2==0):7===bytes[0]&&assert(bytes[bytes.length-1]%2==1),this.point(bytes.slice(1,1+len),bytes.slice(1+len,1+2*len));if((2===bytes[0]||3===bytes[0])&&bytes.length-1===len)return this.pointFromX(bytes.slice(1,1+len),3===bytes[0]);throw new Error("Unknown point format")},BasePoint.prototype.encodeCompressed=function(enc){return this.encode(enc,!0)},BasePoint.prototype._encode=function(compact){var len=this.curve.p.byteLength(),x=this.getX().toArray("be",len);return compact?[this.getY().isEven()?2:3].concat(x):[4].concat(x,this.getY().toArray("be",len))},BasePoint.prototype.encode=function(enc,compact){return utils.encode(this._encode(compact),enc)},BasePoint.prototype.precompute=function(power){if(this.precomputed)return this;var precomputed={doubles:null,naf:null,beta:null};return precomputed.naf=this._getNAFPoints(8),precomputed.doubles=this._getDoubles(4,power),precomputed.beta=this._getBeta(),this.precomputed=precomputed,this},BasePoint.prototype._hasDoubles=function(k){if(!this.precomputed)return!1;var doubles=this.precomputed.doubles;return!!doubles&&doubles.points.length>=Math.ceil((k.bitLength()+1)/doubles.step)},BasePoint.prototype._getDoubles=function(step,power){if(this.precomputed&&this.precomputed.doubles)return this.precomputed.doubles;for(var doubles=[this],acc=this,i=0;i<power;i+=step){for(var j=0;j<step;j++)acc=acc.dbl();doubles.push(acc)}return{step:step,points:doubles}},BasePoint.prototype._getNAFPoints=function(wnd){if(this.precomputed&&this.precomputed.naf)return this.precomputed.naf;for(var res=[this],max=(1<<wnd)-1,dbl=1===max?null:this.dbl(),i=1;i<max;i++)res[i]=res[i-1].add(dbl);return{wnd:wnd,points:res}},BasePoint.prototype._getBeta=function(){return null},BasePoint.prototype.dblp=function(k){for(var r=this,i=0;i<k;i++)r=r.dbl();return r}},function(module,exports,__webpack_require__){"use strict";var curve=__webpack_require__(31),elliptic=__webpack_require__(8),BN=__webpack_require__(6),inherits=__webpack_require__(1),Base=curve.base,assert=elliptic.utils.assert;function ShortCurve(conf){Base.call(this,"short",conf),this.a=new BN(conf.a,16).toRed(this.red),this.b=new BN(conf.b,16).toRed(this.red),this.tinv=this.two.redInvm(),this.zeroA=0===this.a.fromRed().cmpn(0),this.threeA=0===this.a.fromRed().sub(this.p).cmpn(-3),this.endo=this._getEndomorphism(conf),this._endoWnafT1=new Array(4),this._endoWnafT2=new Array(4)}function Point(curve,x,y,isRed){Base.BasePoint.call(this,curve,"affine"),null===x&&null===y?(this.x=null,this.y=null,this.inf=!0):(this.x=new BN(x,16),this.y=new BN(y,16),isRed&&(this.x.forceRed(this.curve.red),this.y.forceRed(this.curve.red)),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.y.red||(this.y=this.y.toRed(this.curve.red)),this.inf=!1)}function JPoint(curve,x,y,z){Base.BasePoint.call(this,curve,"jacobian"),null===x&&null===y&&null===z?(this.x=this.curve.one,this.y=this.curve.one,this.z=new BN(0)):(this.x=new BN(x,16),this.y=new BN(y,16),this.z=new BN(z,16)),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.y.red||(this.y=this.y.toRed(this.curve.red)),this.z.red||(this.z=this.z.toRed(this.curve.red)),this.zOne=this.z===this.curve.one}inherits(ShortCurve,Base),module.exports=ShortCurve,ShortCurve.prototype._getEndomorphism=function(conf){if(this.zeroA&&this.g&&this.n&&1===this.p.modn(3)){var beta,lambda;if(conf.beta)beta=new BN(conf.beta,16).toRed(this.red);else{var betas=this._getEndoRoots(this.p);beta=(beta=betas[0].cmp(betas[1])<0?betas[0]:betas[1]).toRed(this.red)}if(conf.lambda)lambda=new BN(conf.lambda,16);else{var lambdas=this._getEndoRoots(this.n);0===this.g.mul(lambdas[0]).x.cmp(this.g.x.redMul(beta))?lambda=lambdas[0]:(lambda=lambdas[1],assert(0===this.g.mul(lambda).x.cmp(this.g.x.redMul(beta))))}return{beta:beta,lambda:lambda,basis:conf.basis?conf.basis.map((function(vec){return{a:new BN(vec.a,16),b:new BN(vec.b,16)}})):this._getEndoBasis(lambda)}}},ShortCurve.prototype._getEndoRoots=function(num){var red=num===this.p?this.red:BN.mont(num),tinv=new BN(2).toRed(red).redInvm(),ntinv=tinv.redNeg(),s=new BN(3).toRed(red).redNeg().redSqrt().redMul(tinv);return[ntinv.redAdd(s).fromRed(),ntinv.redSub(s).fromRed()]},ShortCurve.prototype._getEndoBasis=function(lambda){for(var a0,b0,a1,b1,a2,b2,prevR,r,x,aprxSqrt=this.n.ushrn(Math.floor(this.n.bitLength()/2)),u=lambda,v=this.n.clone(),x1=new BN(1),y1=new BN(0),x2=new BN(0),y2=new BN(1),i=0;0!==u.cmpn(0);){var q=v.div(u);r=v.sub(q.mul(u)),x=x2.sub(q.mul(x1));var y=y2.sub(q.mul(y1));if(!a1&&r.cmp(aprxSqrt)<0)a0=prevR.neg(),b0=x1,a1=r.neg(),b1=x;else if(a1&&2==++i)break;prevR=r,v=u,u=r,x2=x1,x1=x,y2=y1,y1=y}a2=r.neg(),b2=x;var len1=a1.sqr().add(b1.sqr());return a2.sqr().add(b2.sqr()).cmp(len1)>=0&&(a2=a0,b2=b0),a1.negative&&(a1=a1.neg(),b1=b1.neg()),a2.negative&&(a2=a2.neg(),b2=b2.neg()),[{a:a1,b:b1},{a:a2,b:b2}]},ShortCurve.prototype._endoSplit=function(k){var basis=this.endo.basis,v1=basis[0],v2=basis[1],c1=v2.b.mul(k).divRound(this.n),c2=v1.b.neg().mul(k).divRound(this.n),p1=c1.mul(v1.a),p2=c2.mul(v2.a),q1=c1.mul(v1.b),q2=c2.mul(v2.b);return{k1:k.sub(p1).sub(p2),k2:q1.add(q2).neg()}},ShortCurve.prototype.pointFromX=function(x,odd){(x=new BN(x,16)).red||(x=x.toRed(this.red));var y2=x.redSqr().redMul(x).redIAdd(x.redMul(this.a)).redIAdd(this.b),y=y2.redSqrt();if(0!==y.redSqr().redSub(y2).cmp(this.zero))throw new Error("invalid point");var isOdd=y.fromRed().isOdd();return(odd&&!isOdd||!odd&&isOdd)&&(y=y.redNeg()),this.point(x,y)},ShortCurve.prototype.validate=function(point){if(point.inf)return!0;var x=point.x,y=point.y,ax=this.a.redMul(x),rhs=x.redSqr().redMul(x).redIAdd(ax).redIAdd(this.b);return 0===y.redSqr().redISub(rhs).cmpn(0)},ShortCurve.prototype._endoWnafMulAdd=function(points,coeffs,jacobianResult){for(var npoints=this._endoWnafT1,ncoeffs=this._endoWnafT2,i=0;i<points.length;i++){var split=this._endoSplit(coeffs[i]),p=points[i],beta=p._getBeta();split.k1.negative&&(split.k1.ineg(),p=p.neg(!0)),split.k2.negative&&(split.k2.ineg(),beta=beta.neg(!0)),npoints[2*i]=p,npoints[2*i+1]=beta,ncoeffs[2*i]=split.k1,ncoeffs[2*i+1]=split.k2}for(var res=this._wnafMulAdd(1,npoints,ncoeffs,2*i,jacobianResult),j=0;j<2*i;j++)npoints[j]=null,ncoeffs[j]=null;return res},inherits(Point,Base.BasePoint),ShortCurve.prototype.point=function(x,y,isRed){return new Point(this,x,y,isRed)},ShortCurve.prototype.pointFromJSON=function(obj,red){return Point.fromJSON(this,obj,red)},Point.prototype._getBeta=function(){if(this.curve.endo){var pre=this.precomputed;if(pre&&pre.beta)return pre.beta;var beta=this.curve.point(this.x.redMul(this.curve.endo.beta),this.y);if(pre){var curve=this.curve,endoMul=function(p){return curve.point(p.x.redMul(curve.endo.beta),p.y)};pre.beta=beta,beta.precomputed={beta:null,naf:pre.naf&&{wnd:pre.naf.wnd,points:pre.naf.points.map(endoMul)},doubles:pre.doubles&&{step:pre.doubles.step,points:pre.doubles.points.map(endoMul)}}}return beta}},Point.prototype.toJSON=function(){return this.precomputed?[this.x,this.y,this.precomputed&&{doubles:this.precomputed.doubles&&{step:this.precomputed.doubles.step,points:this.precomputed.doubles.points.slice(1)},naf:this.precomputed.naf&&{wnd:this.precomputed.naf.wnd,points:this.precomputed.naf.points.slice(1)}}]:[this.x,this.y]},Point.fromJSON=function(curve,obj,red){"string"==typeof obj&&(obj=JSON.parse(obj));var res=curve.point(obj[0],obj[1],red);if(!obj[2])return res;function obj2point(obj){return curve.point(obj[0],obj[1],red)}var pre=obj[2];return res.precomputed={beta:null,doubles:pre.doubles&&{step:pre.doubles.step,points:[res].concat(pre.doubles.points.map(obj2point))},naf:pre.naf&&{wnd:pre.naf.wnd,points:[res].concat(pre.naf.points.map(obj2point))}},res},Point.prototype.inspect=function(){return this.isInfinity()?"<EC Point Infinity>":"<EC Point x: "+this.x.fromRed().toString(16,2)+" y: "+this.y.fromRed().toString(16,2)+">"},Point.prototype.isInfinity=function(){return this.inf},Point.prototype.add=function(p){if(this.inf)return p;if(p.inf)return this;if(this.eq(p))return this.dbl();if(this.neg().eq(p))return this.curve.point(null,null);if(0===this.x.cmp(p.x))return this.curve.point(null,null);var c=this.y.redSub(p.y);0!==c.cmpn(0)&&(c=c.redMul(this.x.redSub(p.x).redInvm()));var nx=c.redSqr().redISub(this.x).redISub(p.x),ny=c.redMul(this.x.redSub(nx)).redISub(this.y);return this.curve.point(nx,ny)},Point.prototype.dbl=function(){if(this.inf)return this;var ys1=this.y.redAdd(this.y);if(0===ys1.cmpn(0))return this.curve.point(null,null);var a=this.curve.a,x2=this.x.redSqr(),dyinv=ys1.redInvm(),c=x2.redAdd(x2).redIAdd(x2).redIAdd(a).redMul(dyinv),nx=c.redSqr().redISub(this.x.redAdd(this.x)),ny=c.redMul(this.x.redSub(nx)).redISub(this.y);return this.curve.point(nx,ny)},Point.prototype.getX=function(){return this.x.fromRed()},Point.prototype.getY=function(){return this.y.fromRed()},Point.prototype.mul=function(k){return k=new BN(k,16),this._hasDoubles(k)?this.curve._fixedNafMul(this,k):this.curve.endo?this.curve._endoWnafMulAdd([this],[k]):this.curve._wnafMul(this,k)},Point.prototype.mulAdd=function(k1,p2,k2){var points=[this,p2],coeffs=[k1,k2];return this.curve.endo?this.curve._endoWnafMulAdd(points,coeffs):this.curve._wnafMulAdd(1,points,coeffs,2)},Point.prototype.jmulAdd=function(k1,p2,k2){var points=[this,p2],coeffs=[k1,k2];return this.curve.endo?this.curve._endoWnafMulAdd(points,coeffs,!0):this.curve._wnafMulAdd(1,points,coeffs,2,!0)},Point.prototype.eq=function(p){return this===p||this.inf===p.inf&&(this.inf||0===this.x.cmp(p.x)&&0===this.y.cmp(p.y))},Point.prototype.neg=function(_precompute){if(this.inf)return this;var res=this.curve.point(this.x,this.y.redNeg());if(_precompute&&this.precomputed){var pre=this.precomputed,negate=function(p){return p.neg()};res.precomputed={naf:pre.naf&&{wnd:pre.naf.wnd,points:pre.naf.points.map(negate)},doubles:pre.doubles&&{step:pre.doubles.step,points:pre.doubles.points.map(negate)}}}return res},Point.prototype.toJ=function(){return this.inf?this.curve.jpoint(null,null,null):this.curve.jpoint(this.x,this.y,this.curve.one)},inherits(JPoint,Base.BasePoint),ShortCurve.prototype.jpoint=function(x,y,z){return new JPoint(this,x,y,z)},JPoint.prototype.toP=function(){if(this.isInfinity())return this.curve.point(null,null);var zinv=this.z.redInvm(),zinv2=zinv.redSqr(),ax=this.x.redMul(zinv2),ay=this.y.redMul(zinv2).redMul(zinv);return this.curve.point(ax,ay)},JPoint.prototype.neg=function(){return this.curve.jpoint(this.x,this.y.redNeg(),this.z)},JPoint.prototype.add=function(p){if(this.isInfinity())return p;if(p.isInfinity())return this;var pz2=p.z.redSqr(),z2=this.z.redSqr(),u1=this.x.redMul(pz2),u2=p.x.redMul(z2),s1=this.y.redMul(pz2.redMul(p.z)),s2=p.y.redMul(z2.redMul(this.z)),h=u1.redSub(u2),r=s1.redSub(s2);if(0===h.cmpn(0))return 0!==r.cmpn(0)?this.curve.jpoint(null,null,null):this.dbl();var h2=h.redSqr(),h3=h2.redMul(h),v=u1.redMul(h2),nx=r.redSqr().redIAdd(h3).redISub(v).redISub(v),ny=r.redMul(v.redISub(nx)).redISub(s1.redMul(h3)),nz=this.z.redMul(p.z).redMul(h);return this.curve.jpoint(nx,ny,nz)},JPoint.prototype.mixedAdd=function(p){if(this.isInfinity())return p.toJ();if(p.isInfinity())return this;var z2=this.z.redSqr(),u1=this.x,u2=p.x.redMul(z2),s1=this.y,s2=p.y.redMul(z2).redMul(this.z),h=u1.redSub(u2),r=s1.redSub(s2);if(0===h.cmpn(0))return 0!==r.cmpn(0)?this.curve.jpoint(null,null,null):this.dbl();var h2=h.redSqr(),h3=h2.redMul(h),v=u1.redMul(h2),nx=r.redSqr().redIAdd(h3).redISub(v).redISub(v),ny=r.redMul(v.redISub(nx)).redISub(s1.redMul(h3)),nz=this.z.redMul(h);return this.curve.jpoint(nx,ny,nz)},JPoint.prototype.dblp=function(pow){if(0===pow)return this;if(this.isInfinity())return this;if(!pow)return this.dbl();if(this.curve.zeroA||this.curve.threeA){for(var r=this,i=0;i<pow;i++)r=r.dbl();return r}var a=this.curve.a,tinv=this.curve.tinv,jx=this.x,jy=this.y,jz=this.z,jz4=jz.redSqr().redSqr(),jyd=jy.redAdd(jy);for(i=0;i<pow;i++){var jx2=jx.redSqr(),jyd2=jyd.redSqr(),jyd4=jyd2.redSqr(),c=jx2.redAdd(jx2).redIAdd(jx2).redIAdd(a.redMul(jz4)),t1=jx.redMul(jyd2),nx=c.redSqr().redISub(t1.redAdd(t1)),t2=t1.redISub(nx),dny=c.redMul(t2);dny=dny.redIAdd(dny).redISub(jyd4);var nz=jyd.redMul(jz);i+1<pow&&(jz4=jz4.redMul(jyd4)),jx=nx,jz=nz,jyd=dny}return this.curve.jpoint(jx,jyd.redMul(tinv),jz)},JPoint.prototype.dbl=function(){return this.isInfinity()?this:this.curve.zeroA?this._zeroDbl():this.curve.threeA?this._threeDbl():this._dbl()},JPoint.prototype._zeroDbl=function(){var nx,ny,nz;if(this.zOne){var xx=this.x.redSqr(),yy=this.y.redSqr(),yyyy=yy.redSqr(),s=this.x.redAdd(yy).redSqr().redISub(xx).redISub(yyyy);s=s.redIAdd(s);var m=xx.redAdd(xx).redIAdd(xx),t=m.redSqr().redISub(s).redISub(s),yyyy8=yyyy.redIAdd(yyyy);yyyy8=(yyyy8=yyyy8.redIAdd(yyyy8)).redIAdd(yyyy8),nx=t,ny=m.redMul(s.redISub(t)).redISub(yyyy8),nz=this.y.redAdd(this.y)}else{var a=this.x.redSqr(),b=this.y.redSqr(),c=b.redSqr(),d=this.x.redAdd(b).redSqr().redISub(a).redISub(c);d=d.redIAdd(d);var e=a.redAdd(a).redIAdd(a),f=e.redSqr(),c8=c.redIAdd(c);c8=(c8=c8.redIAdd(c8)).redIAdd(c8),nx=f.redISub(d).redISub(d),ny=e.redMul(d.redISub(nx)).redISub(c8),nz=(nz=this.y.redMul(this.z)).redIAdd(nz)}return this.curve.jpoint(nx,ny,nz)},JPoint.prototype._threeDbl=function(){var nx,ny,nz;if(this.zOne){var xx=this.x.redSqr(),yy=this.y.redSqr(),yyyy=yy.redSqr(),s=this.x.redAdd(yy).redSqr().redISub(xx).redISub(yyyy);s=s.redIAdd(s);var m=xx.redAdd(xx).redIAdd(xx).redIAdd(this.curve.a),t=m.redSqr().redISub(s).redISub(s);nx=t;var yyyy8=yyyy.redIAdd(yyyy);yyyy8=(yyyy8=yyyy8.redIAdd(yyyy8)).redIAdd(yyyy8),ny=m.redMul(s.redISub(t)).redISub(yyyy8),nz=this.y.redAdd(this.y)}else{var delta=this.z.redSqr(),gamma=this.y.redSqr(),beta=this.x.redMul(gamma),alpha=this.x.redSub(delta).redMul(this.x.redAdd(delta));alpha=alpha.redAdd(alpha).redIAdd(alpha);var beta4=beta.redIAdd(beta),beta8=(beta4=beta4.redIAdd(beta4)).redAdd(beta4);nx=alpha.redSqr().redISub(beta8),nz=this.y.redAdd(this.z).redSqr().redISub(gamma).redISub(delta);var ggamma8=gamma.redSqr();ggamma8=(ggamma8=(ggamma8=ggamma8.redIAdd(ggamma8)).redIAdd(ggamma8)).redIAdd(ggamma8),ny=alpha.redMul(beta4.redISub(nx)).redISub(ggamma8)}return this.curve.jpoint(nx,ny,nz)},JPoint.prototype._dbl=function(){var a=this.curve.a,jx=this.x,jy=this.y,jz=this.z,jz4=jz.redSqr().redSqr(),jx2=jx.redSqr(),jy2=jy.redSqr(),c=jx2.redAdd(jx2).redIAdd(jx2).redIAdd(a.redMul(jz4)),jxd4=jx.redAdd(jx),t1=(jxd4=jxd4.redIAdd(jxd4)).redMul(jy2),nx=c.redSqr().redISub(t1.redAdd(t1)),t2=t1.redISub(nx),jyd8=jy2.redSqr();jyd8=(jyd8=(jyd8=jyd8.redIAdd(jyd8)).redIAdd(jyd8)).redIAdd(jyd8);var ny=c.redMul(t2).redISub(jyd8),nz=jy.redAdd(jy).redMul(jz);return this.curve.jpoint(nx,ny,nz)},JPoint.prototype.trpl=function(){if(!this.curve.zeroA)return this.dbl().add(this);var xx=this.x.redSqr(),yy=this.y.redSqr(),zz=this.z.redSqr(),yyyy=yy.redSqr(),m=xx.redAdd(xx).redIAdd(xx),mm=m.redSqr(),e=this.x.redAdd(yy).redSqr().redISub(xx).redISub(yyyy),ee=(e=(e=(e=e.redIAdd(e)).redAdd(e).redIAdd(e)).redISub(mm)).redSqr(),t=yyyy.redIAdd(yyyy);t=(t=(t=t.redIAdd(t)).redIAdd(t)).redIAdd(t);var u=m.redIAdd(e).redSqr().redISub(mm).redISub(ee).redISub(t),yyu4=yy.redMul(u);yyu4=(yyu4=yyu4.redIAdd(yyu4)).redIAdd(yyu4);var nx=this.x.redMul(ee).redISub(yyu4);nx=(nx=nx.redIAdd(nx)).redIAdd(nx);var ny=this.y.redMul(u.redMul(t.redISub(u)).redISub(e.redMul(ee)));ny=(ny=(ny=ny.redIAdd(ny)).redIAdd(ny)).redIAdd(ny);var nz=this.z.redAdd(e).redSqr().redISub(zz).redISub(ee);return this.curve.jpoint(nx,ny,nz)},JPoint.prototype.mul=function(k,kbase){return k=new BN(k,kbase),this.curve._wnafMul(this,k)},JPoint.prototype.eq=function(p){if("affine"===p.type)return this.eq(p.toJ());if(this===p)return!0;var z2=this.z.redSqr(),pz2=p.z.redSqr();if(0!==this.x.redMul(pz2).redISub(p.x.redMul(z2)).cmpn(0))return!1;var z3=z2.redMul(this.z),pz3=pz2.redMul(p.z);return 0===this.y.redMul(pz3).redISub(p.y.redMul(z3)).cmpn(0)},JPoint.prototype.eqXToP=function(x){var zs=this.z.redSqr(),rx=x.toRed(this.curve.red).redMul(zs);if(0===this.x.cmp(rx))return!0;for(var xc=x.clone(),t=this.curve.redN.redMul(zs);;){if(xc.iadd(this.curve.n),xc.cmp(this.curve.p)>=0)return!1;if(rx.redIAdd(t),0===this.x.cmp(rx))return!0}return!1},JPoint.prototype.inspect=function(){return this.isInfinity()?"<EC JPoint Infinity>":"<EC JPoint x: "+this.x.toString(16,2)+" y: "+this.y.toString(16,2)+" z: "+this.z.toString(16,2)+">"},JPoint.prototype.isInfinity=function(){return 0===this.z.cmpn(0)}},function(module,exports,__webpack_require__){"use strict";var curve=__webpack_require__(31),BN=__webpack_require__(6),inherits=__webpack_require__(1),Base=curve.base,utils=__webpack_require__(8).utils;function MontCurve(conf){Base.call(this,"mont",conf),this.a=new BN(conf.a,16).toRed(this.red),this.b=new BN(conf.b,16).toRed(this.red),this.i4=new BN(4).toRed(this.red).redInvm(),this.two=new BN(2).toRed(this.red),this.a24=this.i4.redMul(this.a.redAdd(this.two))}function Point(curve,x,z){Base.BasePoint.call(this,curve,"projective"),null===x&&null===z?(this.x=this.curve.one,this.z=this.curve.zero):(this.x=new BN(x,16),this.z=new BN(z,16),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.z.red||(this.z=this.z.toRed(this.curve.red)))}inherits(MontCurve,Base),module.exports=MontCurve,MontCurve.prototype.validate=function(point){var x=point.normalize().x,x2=x.redSqr(),rhs=x2.redMul(x).redAdd(x2.redMul(this.a)).redAdd(x);return 0===rhs.redSqrt().redSqr().cmp(rhs)},inherits(Point,Base.BasePoint),MontCurve.prototype.decodePoint=function(bytes,enc){return this.point(utils.toArray(bytes,enc),1)},MontCurve.prototype.point=function(x,z){return new Point(this,x,z)},MontCurve.prototype.pointFromJSON=function(obj){return Point.fromJSON(this,obj)},Point.prototype.precompute=function(){},Point.prototype._encode=function(){return this.getX().toArray("be",this.curve.p.byteLength())},Point.fromJSON=function(curve,obj){return new Point(curve,obj[0],obj[1]||curve.one)},Point.prototype.inspect=function(){return this.isInfinity()?"<EC Point Infinity>":"<EC Point x: "+this.x.fromRed().toString(16,2)+" z: "+this.z.fromRed().toString(16,2)+">"},Point.prototype.isInfinity=function(){return 0===this.z.cmpn(0)},Point.prototype.dbl=function(){var aa=this.x.redAdd(this.z).redSqr(),bb=this.x.redSub(this.z).redSqr(),c=aa.redSub(bb),nx=aa.redMul(bb),nz=c.redMul(bb.redAdd(this.curve.a24.redMul(c)));return this.curve.point(nx,nz)},Point.prototype.add=function(){throw new Error("Not supported on Montgomery curve")},Point.prototype.diffAdd=function(p,diff){var a=this.x.redAdd(this.z),b=this.x.redSub(this.z),c=p.x.redAdd(p.z),da=p.x.redSub(p.z).redMul(a),cb=c.redMul(b),nx=diff.z.redMul(da.redAdd(cb).redSqr()),nz=diff.x.redMul(da.redISub(cb).redSqr());return this.curve.point(nx,nz)},Point.prototype.mul=function(k){for(var t=k.clone(),a=this,b=this.curve.point(null,null),bits=[];0!==t.cmpn(0);t.iushrn(1))bits.push(t.andln(1));for(var i=bits.length-1;i>=0;i--)0===bits[i]?(a=a.diffAdd(b,this),b=b.dbl()):(b=a.diffAdd(b,this),a=a.dbl());return b},Point.prototype.mulAdd=function(){throw new Error("Not supported on Montgomery curve")},Point.prototype.jumlAdd=function(){throw new Error("Not supported on Montgomery curve")},Point.prototype.eq=function(other){return 0===this.getX().cmp(other.getX())},Point.prototype.normalize=function(){return this.x=this.x.redMul(this.z.redInvm()),this.z=this.curve.one,this},Point.prototype.getX=function(){return this.normalize(),this.x.fromRed()}},function(module,exports,__webpack_require__){"use strict";var curve=__webpack_require__(31),elliptic=__webpack_require__(8),BN=__webpack_require__(6),inherits=__webpack_require__(1),Base=curve.base,assert=elliptic.utils.assert;function EdwardsCurve(conf){this.twisted=1!=(0|conf.a),this.mOneA=this.twisted&&-1==(0|conf.a),this.extended=this.mOneA,Base.call(this,"edwards",conf),this.a=new BN(conf.a,16).umod(this.red.m),this.a=this.a.toRed(this.red),this.c=new BN(conf.c,16).toRed(this.red),this.c2=this.c.redSqr(),this.d=new BN(conf.d,16).toRed(this.red),this.dd=this.d.redAdd(this.d),assert(!this.twisted||0===this.c.fromRed().cmpn(1)),this.oneC=1==(0|conf.c)}function Point(curve,x,y,z,t){Base.BasePoint.call(this,curve,"projective"),null===x&&null===y&&null===z?(this.x=this.curve.zero,this.y=this.curve.one,this.z=this.curve.one,this.t=this.curve.zero,this.zOne=!0):(this.x=new BN(x,16),this.y=new BN(y,16),this.z=z?new BN(z,16):this.curve.one,this.t=t&&new BN(t,16),this.x.red||(this.x=this.x.toRed(this.curve.red)),this.y.red||(this.y=this.y.toRed(this.curve.red)),this.z.red||(this.z=this.z.toRed(this.curve.red)),this.t&&!this.t.red&&(this.t=this.t.toRed(this.curve.red)),this.zOne=this.z===this.curve.one,this.curve.extended&&!this.t&&(this.t=this.x.redMul(this.y),this.zOne||(this.t=this.t.redMul(this.z.redInvm()))))}inherits(EdwardsCurve,Base),module.exports=EdwardsCurve,EdwardsCurve.prototype._mulA=function(num){return this.mOneA?num.redNeg():this.a.redMul(num)},EdwardsCurve.prototype._mulC=function(num){return this.oneC?num:this.c.redMul(num)},EdwardsCurve.prototype.jpoint=function(x,y,z,t){return this.point(x,y,z,t)},EdwardsCurve.prototype.pointFromX=function(x,odd){(x=new BN(x,16)).red||(x=x.toRed(this.red));var x2=x.redSqr(),rhs=this.c2.redSub(this.a.redMul(x2)),lhs=this.one.redSub(this.c2.redMul(this.d).redMul(x2)),y2=rhs.redMul(lhs.redInvm()),y=y2.redSqrt();if(0!==y.redSqr().redSub(y2).cmp(this.zero))throw new Error("invalid point");var isOdd=y.fromRed().isOdd();return(odd&&!isOdd||!odd&&isOdd)&&(y=y.redNeg()),this.point(x,y)},EdwardsCurve.prototype.pointFromY=function(y,odd){(y=new BN(y,16)).red||(y=y.toRed(this.red));var y2=y.redSqr(),lhs=y2.redSub(this.one),rhs=y2.redMul(this.d).redAdd(this.one),x2=lhs.redMul(rhs.redInvm());if(0===x2.cmp(this.zero)){if(odd)throw new Error("invalid point");return this.point(this.zero,y)}var x=x2.redSqrt();if(0!==x.redSqr().redSub(x2).cmp(this.zero))throw new Error("invalid point");return x.isOdd()!==odd&&(x=x.redNeg()),this.point(x,y)},EdwardsCurve.prototype.validate=function(point){if(point.isInfinity())return!0;point.normalize();var x2=point.x.redSqr(),y2=point.y.redSqr(),lhs=x2.redMul(this.a).redAdd(y2),rhs=this.c2.redMul(this.one.redAdd(this.d.redMul(x2).redMul(y2)));return 0===lhs.cmp(rhs)},inherits(Point,Base.BasePoint),EdwardsCurve.prototype.pointFromJSON=function(obj){return Point.fromJSON(this,obj)},EdwardsCurve.prototype.point=function(x,y,z,t){return new Point(this,x,y,z,t)},Point.fromJSON=function(curve,obj){return new Point(curve,obj[0],obj[1],obj[2])},Point.prototype.inspect=function(){return this.isInfinity()?"<EC Point Infinity>":"<EC Point x: "+this.x.fromRed().toString(16,2)+" y: "+this.y.fromRed().toString(16,2)+" z: "+this.z.fromRed().toString(16,2)+">"},Point.prototype.isInfinity=function(){return 0===this.x.cmpn(0)&&0===this.y.cmp(this.z)},Point.prototype._extDbl=function(){var a=this.x.redSqr(),b=this.y.redSqr(),c=this.z.redSqr();c=c.redIAdd(c);var d=this.curve._mulA(a),e=this.x.redAdd(this.y).redSqr().redISub(a).redISub(b),g=d.redAdd(b),f=g.redSub(c),h=d.redSub(b),nx=e.redMul(f),ny=g.redMul(h),nt=e.redMul(h),nz=f.redMul(g);return this.curve.point(nx,ny,nz,nt)},Point.prototype._projDbl=function(){var nx,ny,nz,b=this.x.redAdd(this.y).redSqr(),c=this.x.redSqr(),d=this.y.redSqr();if(this.curve.twisted){var f=(e=this.curve._mulA(c)).redAdd(d);if(this.zOne)nx=b.redSub(c).redSub(d).redMul(f.redSub(this.curve.two)),ny=f.redMul(e.redSub(d)),nz=f.redSqr().redSub(f).redSub(f);else{var h=this.z.redSqr(),j=f.redSub(h).redISub(h);nx=b.redSub(c).redISub(d).redMul(j),ny=f.redMul(e.redSub(d)),nz=f.redMul(j)}}else{var e=c.redAdd(d);h=this.curve._mulC(this.c.redMul(this.z)).redSqr(),j=e.redSub(h).redSub(h);nx=this.curve._mulC(b.redISub(e)).redMul(j),ny=this.curve._mulC(e).redMul(c.redISub(d)),nz=e.redMul(j)}return this.curve.point(nx,ny,nz)},Point.prototype.dbl=function(){return this.isInfinity()?this:this.curve.extended?this._extDbl():this._projDbl()},Point.prototype._extAdd=function(p){var a=this.y.redSub(this.x).redMul(p.y.redSub(p.x)),b=this.y.redAdd(this.x).redMul(p.y.redAdd(p.x)),c=this.t.redMul(this.curve.dd).redMul(p.t),d=this.z.redMul(p.z.redAdd(p.z)),e=b.redSub(a),f=d.redSub(c),g=d.redAdd(c),h=b.redAdd(a),nx=e.redMul(f),ny=g.redMul(h),nt=e.redMul(h),nz=f.redMul(g);return this.curve.point(nx,ny,nz,nt)},Point.prototype._projAdd=function(p){var ny,nz,a=this.z.redMul(p.z),b=a.redSqr(),c=this.x.redMul(p.x),d=this.y.redMul(p.y),e=this.curve.d.redMul(c).redMul(d),f=b.redSub(e),g=b.redAdd(e),tmp=this.x.redAdd(this.y).redMul(p.x.redAdd(p.y)).redISub(c).redISub(d),nx=a.redMul(f).redMul(tmp);return this.curve.twisted?(ny=a.redMul(g).redMul(d.redSub(this.curve._mulA(c))),nz=f.redMul(g)):(ny=a.redMul(g).redMul(d.redSub(c)),nz=this.curve._mulC(f).redMul(g)),this.curve.point(nx,ny,nz)},Point.prototype.add=function(p){return this.isInfinity()?p:p.isInfinity()?this:this.curve.extended?this._extAdd(p):this._projAdd(p)},Point.prototype.mul=function(k){return this._hasDoubles(k)?this.curve._fixedNafMul(this,k):this.curve._wnafMul(this,k)},Point.prototype.mulAdd=function(k1,p,k2){return this.curve._wnafMulAdd(1,[this,p],[k1,k2],2,!1)},Point.prototype.jmulAdd=function(k1,p,k2){return this.curve._wnafMulAdd(1,[this,p],[k1,k2],2,!0)},Point.prototype.normalize=function(){if(this.zOne)return this;var zi=this.z.redInvm();return this.x=this.x.redMul(zi),this.y=this.y.redMul(zi),this.t&&(this.t=this.t.redMul(zi)),this.z=this.curve.one,this.zOne=!0,this},Point.prototype.neg=function(){return this.curve.point(this.x.redNeg(),this.y,this.z,this.t&&this.t.redNeg())},Point.prototype.getX=function(){return this.normalize(),this.x.fromRed()},Point.prototype.getY=function(){return this.normalize(),this.y.fromRed()},Point.prototype.eq=function(other){return this===other||0===this.getX().cmp(other.getX())&&0===this.getY().cmp(other.getY())},Point.prototype.eqXToP=function(x){var rx=x.toRed(this.curve.red).redMul(this.z);if(0===this.x.cmp(rx))return!0;for(var xc=x.clone(),t=this.curve.redN.redMul(this.z);;){if(xc.iadd(this.curve.n),xc.cmp(this.curve.p)>=0)return!1;if(rx.redIAdd(t),0===this.x.cmp(rx))return!0}return!1},Point.prototype.toP=Point.prototype.normalize,Point.prototype.mixedAdd=Point.prototype.add},function(module,exports,__webpack_require__){"use strict";var pre,curves=exports,hash=__webpack_require__(45),elliptic=__webpack_require__(8),assert=elliptic.utils.assert;function PresetCurve(options){"short"===options.type?this.curve=new elliptic.curve.short(options):"edwards"===options.type?this.curve=new elliptic.curve.edwards(options):this.curve=new elliptic.curve.mont(options),this.g=this.curve.g,this.n=this.curve.n,this.hash=options.hash,assert(this.g.validate(),"Invalid curve"),assert(this.g.mul(this.n).isInfinity(),"Invalid curve, G*N != O")}function defineCurve(name,options){Object.defineProperty(curves,name,{configurable:!0,enumerable:!0,get:function(){var curve=new PresetCurve(options);return Object.defineProperty(curves,name,{configurable:!0,enumerable:!0,value:curve}),curve}})}curves.PresetCurve=PresetCurve,defineCurve("p192",{type:"short",prime:"p192",p:"ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff",a:"ffffffff ffffffff ffffffff fffffffe ffffffff fffffffc",b:"64210519 e59c80e7 0fa7e9ab 72243049 feb8deec c146b9b1",n:"ffffffff ffffffff ffffffff 99def836 146bc9b1 b4d22831",hash:hash.sha256,gRed:!1,g:["188da80e b03090f6 7cbf20eb 43a18800 f4ff0afd 82ff1012","07192b95 ffc8da78 631011ed 6b24cdd5 73f977a1 1e794811"]}),defineCurve("p224",{type:"short",prime:"p224",p:"ffffffff ffffffff ffffffff ffffffff 00000000 00000000 00000001",a:"ffffffff ffffffff ffffffff fffffffe ffffffff ffffffff fffffffe",b:"b4050a85 0c04b3ab f5413256 5044b0b7 d7bfd8ba 270b3943 2355ffb4",n:"ffffffff ffffffff ffffffff ffff16a2 e0b8f03e 13dd2945 5c5c2a3d",hash:hash.sha256,gRed:!1,g:["b70e0cbd 6bb4bf7f 321390b9 4a03c1d3 56c21122 343280d6 115c1d21","bd376388 b5f723fb 4c22dfe6 cd4375a0 5a074764 44d58199 85007e34"]}),defineCurve("p256",{type:"short",prime:null,p:"ffffffff 00000001 00000000 00000000 00000000 ffffffff ffffffff ffffffff",a:"ffffffff 00000001 00000000 00000000 00000000 ffffffff ffffffff fffffffc",b:"5ac635d8 aa3a93e7 b3ebbd55 769886bc 651d06b0 cc53b0f6 3bce3c3e 27d2604b",n:"ffffffff 00000000 ffffffff ffffffff bce6faad a7179e84 f3b9cac2 fc632551",hash:hash.sha256,gRed:!1,g:["6b17d1f2 e12c4247 f8bce6e5 63a440f2 77037d81 2deb33a0 f4a13945 d898c296","4fe342e2 fe1a7f9b 8ee7eb4a 7c0f9e16 2bce3357 6b315ece cbb64068 37bf51f5"]}),defineCurve("p384",{type:"short",prime:null,p:"ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe ffffffff 00000000 00000000 ffffffff",a:"ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe ffffffff 00000000 00000000 fffffffc",b:"b3312fa7 e23ee7e4 988e056b e3f82d19 181d9c6e fe814112 0314088f 5013875a c656398d 8a2ed19d 2a85c8ed d3ec2aef",n:"ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff c7634d81 f4372ddf 581a0db2 48b0a77a ecec196a ccc52973",hash:hash.sha384,gRed:!1,g:["aa87ca22 be8b0537 8eb1c71e f320ad74 6e1d3b62 8ba79b98 59f741e0 82542a38 5502f25d bf55296c 3a545e38 72760ab7","3617de4a 96262c6f 5d9e98bf 9292dc29 f8f41dbd 289a147c e9da3113 b5f0b8c0 0a60b1ce 1d7e819d 7a431d7c 90ea0e5f"]}),defineCurve("p521",{type:"short",prime:null,p:"000001ff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff",a:"000001ff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffc",b:"00000051 953eb961 8e1c9a1f 929a21a0 b68540ee a2da725b 99b315f3 b8b48991 8ef109e1 56193951 ec7e937b 1652c0bd 3bb1bf07 3573df88 3d2c34f1 ef451fd4 6b503f00",n:"000001ff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffa 51868783 bf2f966b 7fcc0148 f709a5d0 3bb5c9b8 899c47ae bb6fb71e 91386409",hash:hash.sha512,gRed:!1,g:["000000c6 858e06b7 0404e9cd 9e3ecb66 2395b442 9c648139 053fb521 f828af60 6b4d3dba a14b5e77 efe75928 fe1dc127 a2ffa8de 3348b3c1 856a429b f97e7e31 c2e5bd66","00000118 39296a78 9a3bc004 5c8a5fb4 2c7d1bd9 98f54449 579b4468 17afbd17 273e662c 97ee7299 5ef42640 c550b901 3fad0761 353c7086 a272c240 88be9476 9fd16650"]}),defineCurve("curve25519",{type:"mont",prime:"p25519",p:"7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed",a:"76d06",b:"1",n:"1000000000000000 0000000000000000 14def9dea2f79cd6 5812631a5cf5d3ed",hash:hash.sha256,gRed:!1,g:["9"]}),defineCurve("ed25519",{type:"edwards",prime:"p25519",p:"7fffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffed",a:"-1",c:"1",d:"52036cee2b6ffe73 8cc740797779e898 00700a4d4141d8ab 75eb4dca135978a3",n:"1000000000000000 0000000000000000 14def9dea2f79cd6 5812631a5cf5d3ed",hash:hash.sha256,gRed:!1,g:["216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a","6666666666666666666666666666666666666666666666666666666666666658"]});try{pre=__webpack_require__(167)}catch(e){pre=void 0}defineCurve("secp256k1",{type:"short",prime:"k256",p:"ffffffff ffffffff ffffffff ffffffff ffffffff ffffffff fffffffe fffffc2f",a:"0",b:"7",n:"ffffffff ffffffff ffffffff fffffffe baaedce6 af48a03b bfd25e8c d0364141",h:"1",hash:hash.sha256,beta:"7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee",lambda:"5363ad4cc05c30e0a5261c028812645a122e22ea20816678df02967c1b23bd72",basis:[{a:"3086d221a7d46bcde86c90e49284eb15",b:"-e4437ed6010e88286f547fa90abfe4c3"},{a:"114ca50f7a8e2f3f657c1108d9d44cfd8",b:"3086d221a7d46bcde86c90e49284eb15"}],gRed:!1,g:["79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798","483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8",pre]})},function(module,exports,__webpack_require__){"use strict";exports.sha1=__webpack_require__(162),exports.sha224=__webpack_require__(163),exports.sha256=__webpack_require__(73),exports.sha384=__webpack_require__(164),exports.sha512=__webpack_require__(74)},function(module,exports,__webpack_require__){"use strict";var utils=__webpack_require__(11),common=__webpack_require__(24),shaCommon=__webpack_require__(72),rotl32=utils.rotl32,sum32=utils.sum32,sum32_5=utils.sum32_5,ft_1=shaCommon.ft_1,BlockHash=common.BlockHash,sha1_K=[1518500249,1859775393,2400959708,3395469782];function SHA1(){if(!(this instanceof SHA1))return new SHA1;BlockHash.call(this),this.h=[1732584193,4023233417,2562383102,271733878,3285377520],this.W=new Array(80)}utils.inherits(SHA1,BlockHash),module.exports=SHA1,SHA1.blockSize=512,SHA1.outSize=160,SHA1.hmacStrength=80,SHA1.padLength=64,SHA1.prototype._update=function(msg,start){for(var W=this.W,i=0;i<16;i++)W[i]=msg[start+i];for(;i<W.length;i++)W[i]=rotl32(W[i-3]^W[i-8]^W[i-14]^W[i-16],1);var a=this.h[0],b=this.h[1],c=this.h[2],d=this.h[3],e=this.h[4];for(i=0;i<W.length;i++){var s=~~(i/20),t=sum32_5(rotl32(a,5),ft_1(s,b,c,d),e,W[i],sha1_K[s]);e=d,d=c,c=rotl32(b,30),b=a,a=t}this.h[0]=sum32(this.h[0],a),this.h[1]=sum32(this.h[1],b),this.h[2]=sum32(this.h[2],c),this.h[3]=sum32(this.h[3],d),this.h[4]=sum32(this.h[4],e)},SHA1.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h,"big"):utils.split32(this.h,"big")}},function(module,exports,__webpack_require__){"use strict";var utils=__webpack_require__(11),SHA256=__webpack_require__(73);function SHA224(){if(!(this instanceof SHA224))return new SHA224;SHA256.call(this),this.h=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428]}utils.inherits(SHA224,SHA256),module.exports=SHA224,SHA224.blockSize=512,SHA224.outSize=224,SHA224.hmacStrength=192,SHA224.padLength=64,SHA224.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h.slice(0,7),"big"):utils.split32(this.h.slice(0,7),"big")}},function(module,exports,__webpack_require__){"use strict";var utils=__webpack_require__(11),SHA512=__webpack_require__(74);function SHA384(){if(!(this instanceof SHA384))return new SHA384;SHA512.call(this),this.h=[3418070365,3238371032,1654270250,914150663,2438529370,812702999,355462360,4144912697,1731405415,4290775857,2394180231,1750603025,3675008525,1694076839,1203062813,3204075428]}utils.inherits(SHA384,SHA512),module.exports=SHA384,SHA384.blockSize=1024,SHA384.outSize=384,SHA384.hmacStrength=192,SHA384.padLength=128,SHA384.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h.slice(0,12),"big"):utils.split32(this.h.slice(0,12),"big")}},function(module,exports,__webpack_require__){"use strict";var utils=__webpack_require__(11),common=__webpack_require__(24),rotl32=utils.rotl32,sum32=utils.sum32,sum32_3=utils.sum32_3,sum32_4=utils.sum32_4,BlockHash=common.BlockHash;function RIPEMD160(){if(!(this instanceof RIPEMD160))return new RIPEMD160;BlockHash.call(this),this.h=[1732584193,4023233417,2562383102,271733878,3285377520],this.endian="little"}function f(j,x,y,z){return j<=15?x^y^z:j<=31?x&y|~x&z:j<=47?(x|~y)^z:j<=63?x&z|y&~z:x^(y|~z)}function K(j){return j<=15?0:j<=31?1518500249:j<=47?1859775393:j<=63?2400959708:2840853838}function Kh(j){return j<=15?1352829926:j<=31?1548603684:j<=47?1836072691:j<=63?2053994217:0}utils.inherits(RIPEMD160,BlockHash),exports.ripemd160=RIPEMD160,RIPEMD160.blockSize=512,RIPEMD160.outSize=160,RIPEMD160.hmacStrength=192,RIPEMD160.padLength=64,RIPEMD160.prototype._update=function(msg,start){for(var A=this.h[0],B=this.h[1],C=this.h[2],D=this.h[3],E=this.h[4],Ah=A,Bh=B,Ch=C,Dh=D,Eh=E,j=0;j<80;j++){var T=sum32(rotl32(sum32_4(A,f(j,B,C,D),msg[r[j]+start],K(j)),s[j]),E);A=E,E=D,D=rotl32(C,10),C=B,B=T,T=sum32(rotl32(sum32_4(Ah,f(79-j,Bh,Ch,Dh),msg[rh[j]+start],Kh(j)),sh[j]),Eh),Ah=Eh,Eh=Dh,Dh=rotl32(Ch,10),Ch=Bh,Bh=T}T=sum32_3(this.h[1],C,Dh),this.h[1]=sum32_3(this.h[2],D,Eh),this.h[2]=sum32_3(this.h[3],E,Ah),this.h[3]=sum32_3(this.h[4],A,Bh),this.h[4]=sum32_3(this.h[0],B,Ch),this.h[0]=T},RIPEMD160.prototype._digest=function(enc){return"hex"===enc?utils.toHex32(this.h,"little"):utils.split32(this.h,"little")};var r=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13],rh=[5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11],s=[11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6],sh=[8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]},function(module,exports,__webpack_require__){"use strict";var utils=__webpack_require__(11),assert=__webpack_require__(9);function Hmac(hash,key,enc){if(!(this instanceof Hmac))return new Hmac(hash,key,enc);this.Hash=hash,this.blockSize=hash.blockSize/8,this.outSize=hash.outSize/8,this.inner=null,this.outer=null,this._init(utils.toArray(key,enc))}module.exports=Hmac,Hmac.prototype._init=function(key){key.length>this.blockSize&&(key=(new this.Hash).update(key).digest()),assert(key.length<=this.blockSize);for(var i=key.length;i<this.blockSize;i++)key.push(0);for(i=0;i<key.length;i++)key[i]^=54;for(this.inner=(new this.Hash).update(key),i=0;i<key.length;i++)key[i]^=106;this.outer=(new this.Hash).update(key)},Hmac.prototype.update=function(msg,enc){return this.inner.update(msg,enc),this},Hmac.prototype.digest=function(enc){return this.outer.update(this.inner.digest()),this.outer.digest(enc)}},function(module,exports){module.exports={doubles:{step:4,points:[["e60fce93b59e9ec53011aabc21c23e97b2a31369b87a5ae9c44ee89e2a6dec0a","f7e3507399e595929db99f34f57937101296891e44d23f0be1f32cce69616821"],["8282263212c609d9ea2a6e3e172de238d8c39cabd5ac1ca10646e23fd5f51508","11f8a8098557dfe45e8256e830b60ace62d613ac2f7b17bed31b6eaff6e26caf"],["175e159f728b865a72f99cc6c6fc846de0b93833fd2222ed73fce5b551e5b739","d3506e0d9e3c79eba4ef97a51ff71f5eacb5955add24345c6efa6ffee9fed695"],["363d90d447b00c9c99ceac05b6262ee053441c7e55552ffe526bad8f83ff4640","4e273adfc732221953b445397f3363145b9a89008199ecb62003c7f3bee9de9"],["8b4b5f165df3c2be8c6244b5b745638843e4a781a15bcd1b69f79a55dffdf80c","4aad0a6f68d308b4b3fbd7813ab0da04f9e336546162ee56b3eff0c65fd4fd36"],["723cbaa6e5db996d6bf771c00bd548c7b700dbffa6c0e77bcb6115925232fcda","96e867b5595cc498a921137488824d6e2660a0653779494801dc069d9eb39f5f"],["eebfa4d493bebf98ba5feec812c2d3b50947961237a919839a533eca0e7dd7fa","5d9a8ca3970ef0f269ee7edaf178089d9ae4cdc3a711f712ddfd4fdae1de8999"],["100f44da696e71672791d0a09b7bde459f1215a29b3c03bfefd7835b39a48db0","cdd9e13192a00b772ec8f3300c090666b7ff4a18ff5195ac0fbd5cd62bc65a09"],["e1031be262c7ed1b1dc9227a4a04c017a77f8d4464f3b3852c8acde6e534fd2d","9d7061928940405e6bb6a4176597535af292dd419e1ced79a44f18f29456a00d"],["feea6cae46d55b530ac2839f143bd7ec5cf8b266a41d6af52d5e688d9094696d","e57c6b6c97dce1bab06e4e12bf3ecd5c981c8957cc41442d3155debf18090088"],["da67a91d91049cdcb367be4be6ffca3cfeed657d808583de33fa978bc1ec6cb1","9bacaa35481642bc41f463f7ec9780e5dec7adc508f740a17e9ea8e27a68be1d"],["53904faa0b334cdda6e000935ef22151ec08d0f7bb11069f57545ccc1a37b7c0","5bc087d0bc80106d88c9eccac20d3c1c13999981e14434699dcb096b022771c8"],["8e7bcd0bd35983a7719cca7764ca906779b53a043a9b8bcaeff959f43ad86047","10b7770b2a3da4b3940310420ca9514579e88e2e47fd68b3ea10047e8460372a"],["385eed34c1cdff21e6d0818689b81bde71a7f4f18397e6690a841e1599c43862","283bebc3e8ea23f56701de19e9ebf4576b304eec2086dc8cc0458fe5542e5453"],["6f9d9b803ecf191637c73a4413dfa180fddf84a5947fbc9c606ed86c3fac3a7","7c80c68e603059ba69b8e2a30e45c4d47ea4dd2f5c281002d86890603a842160"],["3322d401243c4e2582a2147c104d6ecbf774d163db0f5e5313b7e0e742d0e6bd","56e70797e9664ef5bfb019bc4ddaf9b72805f63ea2873af624f3a2e96c28b2a0"],["85672c7d2de0b7da2bd1770d89665868741b3f9af7643397721d74d28134ab83","7c481b9b5b43b2eb6374049bfa62c2e5e77f17fcc5298f44c8e3094f790313a6"],["948bf809b1988a46b06c9f1919413b10f9226c60f668832ffd959af60c82a0a","53a562856dcb6646dc6b74c5d1c3418c6d4dff08c97cd2bed4cb7f88d8c8e589"],["6260ce7f461801c34f067ce0f02873a8f1b0e44dfc69752accecd819f38fd8e8","bc2da82b6fa5b571a7f09049776a1ef7ecd292238051c198c1a84e95b2b4ae17"],["e5037de0afc1d8d43d8348414bbf4103043ec8f575bfdc432953cc8d2037fa2d","4571534baa94d3b5f9f98d09fb990bddbd5f5b03ec481f10e0e5dc841d755bda"],["e06372b0f4a207adf5ea905e8f1771b4e7e8dbd1c6a6c5b725866a0ae4fce725","7a908974bce18cfe12a27bb2ad5a488cd7484a7787104870b27034f94eee31dd"],["213c7a715cd5d45358d0bbf9dc0ce02204b10bdde2a3f58540ad6908d0559754","4b6dad0b5ae462507013ad06245ba190bb4850f5f36a7eeddff2c27534b458f2"],["4e7c272a7af4b34e8dbb9352a5419a87e2838c70adc62cddf0cc3a3b08fbd53c","17749c766c9d0b18e16fd09f6def681b530b9614bff7dd33e0b3941817dcaae6"],["fea74e3dbe778b1b10f238ad61686aa5c76e3db2be43057632427e2840fb27b6","6e0568db9b0b13297cf674deccb6af93126b596b973f7b77701d3db7f23cb96f"],["76e64113f677cf0e10a2570d599968d31544e179b760432952c02a4417bdde39","c90ddf8dee4e95cf577066d70681f0d35e2a33d2b56d2032b4b1752d1901ac01"],["c738c56b03b2abe1e8281baa743f8f9a8f7cc643df26cbee3ab150242bcbb891","893fb578951ad2537f718f2eacbfbbbb82314eef7880cfe917e735d9699a84c3"],["d895626548b65b81e264c7637c972877d1d72e5f3a925014372e9f6588f6c14b","febfaa38f2bc7eae728ec60818c340eb03428d632bb067e179363ed75d7d991f"],["b8da94032a957518eb0f6433571e8761ceffc73693e84edd49150a564f676e03","2804dfa44805a1e4d7c99cc9762808b092cc584d95ff3b511488e4e74efdf6e7"],["e80fea14441fb33a7d8adab9475d7fab2019effb5156a792f1a11778e3c0df5d","eed1de7f638e00771e89768ca3ca94472d155e80af322ea9fcb4291b6ac9ec78"],["a301697bdfcd704313ba48e51d567543f2a182031efd6915ddc07bbcc4e16070","7370f91cfb67e4f5081809fa25d40f9b1735dbf7c0a11a130c0d1a041e177ea1"],["90ad85b389d6b936463f9d0512678de208cc330b11307fffab7ac63e3fb04ed4","e507a3620a38261affdcbd9427222b839aefabe1582894d991d4d48cb6ef150"],["8f68b9d2f63b5f339239c1ad981f162ee88c5678723ea3351b7b444c9ec4c0da","662a9f2dba063986de1d90c2b6be215dbbea2cfe95510bfdf23cbf79501fff82"],["e4f3fb0176af85d65ff99ff9198c36091f48e86503681e3e6686fd5053231e11","1e63633ad0ef4f1c1661a6d0ea02b7286cc7e74ec951d1c9822c38576feb73bc"],["8c00fa9b18ebf331eb961537a45a4266c7034f2f0d4e1d0716fb6eae20eae29e","efa47267fea521a1a9dc343a3736c974c2fadafa81e36c54e7d2a4c66702414b"],["e7a26ce69dd4829f3e10cec0a9e98ed3143d084f308b92c0997fddfc60cb3e41","2a758e300fa7984b471b006a1aafbb18d0a6b2c0420e83e20e8a9421cf2cfd51"],["b6459e0ee3662ec8d23540c223bcbdc571cbcb967d79424f3cf29eb3de6b80ef","67c876d06f3e06de1dadf16e5661db3c4b3ae6d48e35b2ff30bf0b61a71ba45"],["d68a80c8280bb840793234aa118f06231d6f1fc67e73c5a5deda0f5b496943e8","db8ba9fff4b586d00c4b1f9177b0e28b5b0e7b8f7845295a294c84266b133120"],["324aed7df65c804252dc0270907a30b09612aeb973449cea4095980fc28d3d5d","648a365774b61f2ff130c0c35aec1f4f19213b0c7e332843967224af96ab7c84"],["4df9c14919cde61f6d51dfdbe5fee5dceec4143ba8d1ca888e8bd373fd054c96","35ec51092d8728050974c23a1d85d4b5d506cdc288490192ebac06cad10d5d"],["9c3919a84a474870faed8a9c1cc66021523489054d7f0308cbfc99c8ac1f98cd","ddb84f0f4a4ddd57584f044bf260e641905326f76c64c8e6be7e5e03d4fc599d"],["6057170b1dd12fdf8de05f281d8e06bb91e1493a8b91d4cc5a21382120a959e5","9a1af0b26a6a4807add9a2daf71df262465152bc3ee24c65e899be932385a2a8"],["a576df8e23a08411421439a4518da31880cef0fba7d4df12b1a6973eecb94266","40a6bf20e76640b2c92b97afe58cd82c432e10a7f514d9f3ee8be11ae1b28ec8"],["7778a78c28dec3e30a05fe9629de8c38bb30d1f5cf9a3a208f763889be58ad71","34626d9ab5a5b22ff7098e12f2ff580087b38411ff24ac563b513fc1fd9f43ac"],["928955ee637a84463729fd30e7afd2ed5f96274e5ad7e5cb09eda9c06d903ac","c25621003d3f42a827b78a13093a95eeac3d26efa8a8d83fc5180e935bcd091f"],["85d0fef3ec6db109399064f3a0e3b2855645b4a907ad354527aae75163d82751","1f03648413a38c0be29d496e582cf5663e8751e96877331582c237a24eb1f962"],["ff2b0dce97eece97c1c9b6041798b85dfdfb6d8882da20308f5404824526087e","493d13fef524ba188af4c4dc54d07936c7b7ed6fb90e2ceb2c951e01f0c29907"],["827fbbe4b1e880ea9ed2b2e6301b212b57f1ee148cd6dd28780e5e2cf856e241","c60f9c923c727b0b71bef2c67d1d12687ff7a63186903166d605b68baec293ec"],["eaa649f21f51bdbae7be4ae34ce6e5217a58fdce7f47f9aa7f3b58fa2120e2b3","be3279ed5bbbb03ac69a80f89879aa5a01a6b965f13f7e59d47a5305ba5ad93d"],["e4a42d43c5cf169d9391df6decf42ee541b6d8f0c9a137401e23632dda34d24f","4d9f92e716d1c73526fc99ccfb8ad34ce886eedfa8d8e4f13a7f7131deba9414"],["1ec80fef360cbdd954160fadab352b6b92b53576a88fea4947173b9d4300bf19","aeefe93756b5340d2f3a4958a7abbf5e0146e77f6295a07b671cdc1cc107cefd"],["146a778c04670c2f91b00af4680dfa8bce3490717d58ba889ddb5928366642be","b318e0ec3354028add669827f9d4b2870aaa971d2f7e5ed1d0b297483d83efd0"],["fa50c0f61d22e5f07e3acebb1aa07b128d0012209a28b9776d76a8793180eef9","6b84c6922397eba9b72cd2872281a68a5e683293a57a213b38cd8d7d3f4f2811"],["da1d61d0ca721a11b1a5bf6b7d88e8421a288ab5d5bba5220e53d32b5f067ec2","8157f55a7c99306c79c0766161c91e2966a73899d279b48a655fba0f1ad836f1"],["a8e282ff0c9706907215ff98e8fd416615311de0446f1e062a73b0610d064e13","7f97355b8db81c09abfb7f3c5b2515888b679a3e50dd6bd6cef7c73111f4cc0c"],["174a53b9c9a285872d39e56e6913cab15d59b1fa512508c022f382de8319497c","ccc9dc37abfc9c1657b4155f2c47f9e6646b3a1d8cb9854383da13ac079afa73"],["959396981943785c3d3e57edf5018cdbe039e730e4918b3d884fdff09475b7ba","2e7e552888c331dd8ba0386a4b9cd6849c653f64c8709385e9b8abf87524f2fd"],["d2a63a50ae401e56d645a1153b109a8fcca0a43d561fba2dbb51340c9d82b151","e82d86fb6443fcb7565aee58b2948220a70f750af484ca52d4142174dcf89405"],["64587e2335471eb890ee7896d7cfdc866bacbdbd3839317b3436f9b45617e073","d99fcdd5bf6902e2ae96dd6447c299a185b90a39133aeab358299e5e9faf6589"],["8481bde0e4e4d885b3a546d3e549de042f0aa6cea250e7fd358d6c86dd45e458","38ee7b8cba5404dd84a25bf39cecb2ca900a79c42b262e556d64b1b59779057e"],["13464a57a78102aa62b6979ae817f4637ffcfed3c4b1ce30bcd6303f6caf666b","69be159004614580ef7e433453ccb0ca48f300a81d0942e13f495a907f6ecc27"],["bc4a9df5b713fe2e9aef430bcc1dc97a0cd9ccede2f28588cada3a0d2d83f366","d3a81ca6e785c06383937adf4b798caa6e8a9fbfa547b16d758d666581f33c1"],["8c28a97bf8298bc0d23d8c749452a32e694b65e30a9472a3954ab30fe5324caa","40a30463a3305193378fedf31f7cc0eb7ae784f0451cb9459e71dc73cbef9482"],["8ea9666139527a8c1dd94ce4f071fd23c8b350c5a4bb33748c4ba111faccae0","620efabbc8ee2782e24e7c0cfb95c5d735b783be9cf0f8e955af34a30e62b945"],["dd3625faef5ba06074669716bbd3788d89bdde815959968092f76cc4eb9a9787","7a188fa3520e30d461da2501045731ca941461982883395937f68d00c644a573"],["f710d79d9eb962297e4f6232b40e8f7feb2bc63814614d692c12de752408221e","ea98e67232d3b3295d3b535532115ccac8612c721851617526ae47a9c77bfc82"]]},naf:{wnd:7,points:[["f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9","388f7b0f632de8140fe337e62a37f3566500a99934c2231b6cb9fd7584b8e672"],["2f8bde4d1a07209355b4a7250a5c5128e88b84bddc619ab7cba8d569b240efe4","d8ac222636e5e3d6d4dba9dda6c9c426f788271bab0d6840dca87d3aa6ac62d6"],["5cbdf0646e5db4eaa398f365f2ea7a0e3d419b7e0330e39ce92bddedcac4f9bc","6aebca40ba255960a3178d6d861a54dba813d0b813fde7b5a5082628087264da"],["acd484e2f0c7f65309ad178a9f559abde09796974c57e714c35f110dfc27ccbe","cc338921b0a7d9fd64380971763b61e9add888a4375f8e0f05cc262ac64f9c37"],["774ae7f858a9411e5ef4246b70c65aac5649980be5c17891bbec17895da008cb","d984a032eb6b5e190243dd56d7b7b365372db1e2dff9d6a8301d74c9c953c61b"],["f28773c2d975288bc7d1d205c3748651b075fbc6610e58cddeeddf8f19405aa8","ab0902e8d880a89758212eb65cdaf473a1a06da521fa91f29b5cb52db03ed81"],["d7924d4f7d43ea965a465ae3095ff41131e5946f3c85f79e44adbcf8e27e080e","581e2872a86c72a683842ec228cc6defea40af2bd896d3a5c504dc9ff6a26b58"],["defdea4cdb677750a420fee807eacf21eb9898ae79b9768766e4faa04a2d4a34","4211ab0694635168e997b0ead2a93daeced1f4a04a95c0f6cfb199f69e56eb77"],["2b4ea0a797a443d293ef5cff444f4979f06acfebd7e86d277475656138385b6c","85e89bc037945d93b343083b5a1c86131a01f60c50269763b570c854e5c09b7a"],["352bbf4a4cdd12564f93fa332ce333301d9ad40271f8107181340aef25be59d5","321eb4075348f534d59c18259dda3e1f4a1b3b2e71b1039c67bd3d8bcf81998c"],["2fa2104d6b38d11b0230010559879124e42ab8dfeff5ff29dc9cdadd4ecacc3f","2de1068295dd865b64569335bd5dd80181d70ecfc882648423ba76b532b7d67"],["9248279b09b4d68dab21a9b066edda83263c3d84e09572e269ca0cd7f5453714","73016f7bf234aade5d1aa71bdea2b1ff3fc0de2a887912ffe54a32ce97cb3402"],["daed4f2be3a8bf278e70132fb0beb7522f570e144bf615c07e996d443dee8729","a69dce4a7d6c98e8d4a1aca87ef8d7003f83c230f3afa726ab40e52290be1c55"],["c44d12c7065d812e8acf28d7cbb19f9011ecd9e9fdf281b0e6a3b5e87d22e7db","2119a460ce326cdc76c45926c982fdac0e106e861edf61c5a039063f0e0e6482"],["6a245bf6dc698504c89a20cfded60853152b695336c28063b61c65cbd269e6b4","e022cf42c2bd4a708b3f5126f16a24ad8b33ba48d0423b6efd5e6348100d8a82"],["1697ffa6fd9de627c077e3d2fe541084ce13300b0bec1146f95ae57f0d0bd6a5","b9c398f186806f5d27561506e4557433a2cf15009e498ae7adee9d63d01b2396"],["605bdb019981718b986d0f07e834cb0d9deb8360ffb7f61df982345ef27a7479","2972d2de4f8d20681a78d93ec96fe23c26bfae84fb14db43b01e1e9056b8c49"],["62d14dab4150bf497402fdc45a215e10dcb01c354959b10cfe31c7e9d87ff33d","80fc06bd8cc5b01098088a1950eed0db01aa132967ab472235f5642483b25eaf"],["80c60ad0040f27dade5b4b06c408e56b2c50e9f56b9b8b425e555c2f86308b6f","1c38303f1cc5c30f26e66bad7fe72f70a65eed4cbe7024eb1aa01f56430bd57a"],["7a9375ad6167ad54aa74c6348cc54d344cc5dc9487d847049d5eabb0fa03c8fb","d0e3fa9eca8726909559e0d79269046bdc59ea10c70ce2b02d499ec224dc7f7"],["d528ecd9b696b54c907a9ed045447a79bb408ec39b68df504bb51f459bc3ffc9","eecf41253136e5f99966f21881fd656ebc4345405c520dbc063465b521409933"],["49370a4b5f43412ea25f514e8ecdad05266115e4a7ecb1387231808f8b45963","758f3f41afd6ed428b3081b0512fd62a54c3f3afbb5b6764b653052a12949c9a"],["77f230936ee88cbbd73df930d64702ef881d811e0e1498e2f1c13eb1fc345d74","958ef42a7886b6400a08266e9ba1b37896c95330d97077cbbe8eb3c7671c60d6"],["f2dac991cc4ce4b9ea44887e5c7c0bce58c80074ab9d4dbaeb28531b7739f530","e0dedc9b3b2f8dad4da1f32dec2531df9eb5fbeb0598e4fd1a117dba703a3c37"],["463b3d9f662621fb1b4be8fbbe2520125a216cdfc9dae3debcba4850c690d45b","5ed430d78c296c3543114306dd8622d7c622e27c970a1de31cb377b01af7307e"],["f16f804244e46e2a09232d4aff3b59976b98fac14328a2d1a32496b49998f247","cedabd9b82203f7e13d206fcdf4e33d92a6c53c26e5cce26d6579962c4e31df6"],["caf754272dc84563b0352b7a14311af55d245315ace27c65369e15f7151d41d1","cb474660ef35f5f2a41b643fa5e460575f4fa9b7962232a5c32f908318a04476"],["2600ca4b282cb986f85d0f1709979d8b44a09c07cb86d7c124497bc86f082120","4119b88753c15bd6a693b03fcddbb45d5ac6be74ab5f0ef44b0be9475a7e4b40"],["7635ca72d7e8432c338ec53cd12220bc01c48685e24f7dc8c602a7746998e435","91b649609489d613d1d5e590f78e6d74ecfc061d57048bad9e76f302c5b9c61"],["754e3239f325570cdbbf4a87deee8a66b7f2b33479d468fbc1a50743bf56cc18","673fb86e5bda30fb3cd0ed304ea49a023ee33d0197a695d0c5d98093c536683"],["e3e6bd1071a1e96aff57859c82d570f0330800661d1c952f9fe2694691d9b9e8","59c9e0bba394e76f40c0aa58379a3cb6a5a2283993e90c4167002af4920e37f5"],["186b483d056a033826ae73d88f732985c4ccb1f32ba35f4b4cc47fdcf04aa6eb","3b952d32c67cf77e2e17446e204180ab21fb8090895138b4a4a797f86e80888b"],["df9d70a6b9876ce544c98561f4be4f725442e6d2b737d9c91a8321724ce0963f","55eb2dafd84d6ccd5f862b785dc39d4ab157222720ef9da217b8c45cf2ba2417"],["5edd5cc23c51e87a497ca815d5dce0f8ab52554f849ed8995de64c5f34ce7143","efae9c8dbc14130661e8cec030c89ad0c13c66c0d17a2905cdc706ab7399a868"],["290798c2b6476830da12fe02287e9e777aa3fba1c355b17a722d362f84614fba","e38da76dcd440621988d00bcf79af25d5b29c094db2a23146d003afd41943e7a"],["af3c423a95d9f5b3054754efa150ac39cd29552fe360257362dfdecef4053b45","f98a3fd831eb2b749a93b0e6f35cfb40c8cd5aa667a15581bc2feded498fd9c6"],["766dbb24d134e745cccaa28c99bf274906bb66b26dcf98df8d2fed50d884249a","744b1152eacbe5e38dcc887980da38b897584a65fa06cedd2c924f97cbac5996"],["59dbf46f8c94759ba21277c33784f41645f7b44f6c596a58ce92e666191abe3e","c534ad44175fbc300f4ea6ce648309a042ce739a7919798cd85e216c4a307f6e"],["f13ada95103c4537305e691e74e9a4a8dd647e711a95e73cb62dc6018cfd87b8","e13817b44ee14de663bf4bc808341f326949e21a6a75c2570778419bdaf5733d"],["7754b4fa0e8aced06d4167a2c59cca4cda1869c06ebadfb6488550015a88522c","30e93e864e669d82224b967c3020b8fa8d1e4e350b6cbcc537a48b57841163a2"],["948dcadf5990e048aa3874d46abef9d701858f95de8041d2a6828c99e2262519","e491a42537f6e597d5d28a3224b1bc25df9154efbd2ef1d2cbba2cae5347d57e"],["7962414450c76c1689c7b48f8202ec37fb224cf5ac0bfa1570328a8a3d7c77ab","100b610ec4ffb4760d5c1fc133ef6f6b12507a051f04ac5760afa5b29db83437"],["3514087834964b54b15b160644d915485a16977225b8847bb0dd085137ec47ca","ef0afbb2056205448e1652c48e8127fc6039e77c15c2378b7e7d15a0de293311"],["d3cc30ad6b483e4bc79ce2c9dd8bc54993e947eb8df787b442943d3f7b527eaf","8b378a22d827278d89c5e9be8f9508ae3c2ad46290358630afb34db04eede0a4"],["1624d84780732860ce1c78fcbfefe08b2b29823db913f6493975ba0ff4847610","68651cf9b6da903e0914448c6cd9d4ca896878f5282be4c8cc06e2a404078575"],["733ce80da955a8a26902c95633e62a985192474b5af207da6df7b4fd5fc61cd4","f5435a2bd2badf7d485a4d8b8db9fcce3e1ef8e0201e4578c54673bc1dc5ea1d"],["15d9441254945064cf1a1c33bbd3b49f8966c5092171e699ef258dfab81c045c","d56eb30b69463e7234f5137b73b84177434800bacebfc685fc37bbe9efe4070d"],["a1d0fcf2ec9de675b612136e5ce70d271c21417c9d2b8aaaac138599d0717940","edd77f50bcb5a3cab2e90737309667f2641462a54070f3d519212d39c197a629"],["e22fbe15c0af8ccc5780c0735f84dbe9a790badee8245c06c7ca37331cb36980","a855babad5cd60c88b430a69f53a1a7a38289154964799be43d06d77d31da06"],["311091dd9860e8e20ee13473c1155f5f69635e394704eaa74009452246cfa9b3","66db656f87d1f04fffd1f04788c06830871ec5a64feee685bd80f0b1286d8374"],["34c1fd04d301be89b31c0442d3e6ac24883928b45a9340781867d4232ec2dbdf","9414685e97b1b5954bd46f730174136d57f1ceeb487443dc5321857ba73abee"],["f219ea5d6b54701c1c14de5b557eb42a8d13f3abbcd08affcc2a5e6b049b8d63","4cb95957e83d40b0f73af4544cccf6b1f4b08d3c07b27fb8d8c2962a400766d1"],["d7b8740f74a8fbaab1f683db8f45de26543a5490bca627087236912469a0b448","fa77968128d9c92ee1010f337ad4717eff15db5ed3c049b3411e0315eaa4593b"],["32d31c222f8f6f0ef86f7c98d3a3335ead5bcd32abdd94289fe4d3091aa824bf","5f3032f5892156e39ccd3d7915b9e1da2e6dac9e6f26e961118d14b8462e1661"],["7461f371914ab32671045a155d9831ea8793d77cd59592c4340f86cbc18347b5","8ec0ba238b96bec0cbdddcae0aa442542eee1ff50c986ea6b39847b3cc092ff6"],["ee079adb1df1860074356a25aa38206a6d716b2c3e67453d287698bad7b2b2d6","8dc2412aafe3be5c4c5f37e0ecc5f9f6a446989af04c4e25ebaac479ec1c8c1e"],["16ec93e447ec83f0467b18302ee620f7e65de331874c9dc72bfd8616ba9da6b5","5e4631150e62fb40d0e8c2a7ca5804a39d58186a50e497139626778e25b0674d"],["eaa5f980c245f6f038978290afa70b6bd8855897f98b6aa485b96065d537bd99","f65f5d3e292c2e0819a528391c994624d784869d7e6ea67fb18041024edc07dc"],["78c9407544ac132692ee1910a02439958ae04877151342ea96c4b6b35a49f51","f3e0319169eb9b85d5404795539a5e68fa1fbd583c064d2462b675f194a3ddb4"],["494f4be219a1a77016dcd838431aea0001cdc8ae7a6fc688726578d9702857a5","42242a969283a5f339ba7f075e36ba2af925ce30d767ed6e55f4b031880d562c"],["a598a8030da6d86c6bc7f2f5144ea549d28211ea58faa70ebf4c1e665c1fe9b5","204b5d6f84822c307e4b4a7140737aec23fc63b65b35f86a10026dbd2d864e6b"],["c41916365abb2b5d09192f5f2dbeafec208f020f12570a184dbadc3e58595997","4f14351d0087efa49d245b328984989d5caf9450f34bfc0ed16e96b58fa9913"],["841d6063a586fa475a724604da03bc5b92a2e0d2e0a36acfe4c73a5514742881","73867f59c0659e81904f9a1c7543698e62562d6744c169ce7a36de01a8d6154"],["5e95bb399a6971d376026947f89bde2f282b33810928be4ded112ac4d70e20d5","39f23f366809085beebfc71181313775a99c9aed7d8ba38b161384c746012865"],["36e4641a53948fd476c39f8a99fd974e5ec07564b5315d8bf99471bca0ef2f66","d2424b1b1abe4eb8164227b085c9aa9456ea13493fd563e06fd51cf5694c78fc"],["336581ea7bfbbb290c191a2f507a41cf5643842170e914faeab27c2c579f726","ead12168595fe1be99252129b6e56b3391f7ab1410cd1e0ef3dcdcabd2fda224"],["8ab89816dadfd6b6a1f2634fcf00ec8403781025ed6890c4849742706bd43ede","6fdcef09f2f6d0a044e654aef624136f503d459c3e89845858a47a9129cdd24e"],["1e33f1a746c9c5778133344d9299fcaa20b0938e8acff2544bb40284b8c5fb94","60660257dd11b3aa9c8ed618d24edff2306d320f1d03010e33a7d2057f3b3b6"],["85b7c1dcb3cec1b7ee7f30ded79dd20a0ed1f4cc18cbcfcfa410361fd8f08f31","3d98a9cdd026dd43f39048f25a8847f4fcafad1895d7a633c6fed3c35e999511"],["29df9fbd8d9e46509275f4b125d6d45d7fbe9a3b878a7af872a2800661ac5f51","b4c4fe99c775a606e2d8862179139ffda61dc861c019e55cd2876eb2a27d84b"],["a0b1cae06b0a847a3fea6e671aaf8adfdfe58ca2f768105c8082b2e449fce252","ae434102edde0958ec4b19d917a6a28e6b72da1834aff0e650f049503a296cf2"],["4e8ceafb9b3e9a136dc7ff67e840295b499dfb3b2133e4ba113f2e4c0e121e5","cf2174118c8b6d7a4b48f6d534ce5c79422c086a63460502b827ce62a326683c"],["d24a44e047e19b6f5afb81c7ca2f69080a5076689a010919f42725c2b789a33b","6fb8d5591b466f8fc63db50f1c0f1c69013f996887b8244d2cdec417afea8fa3"],["ea01606a7a6c9cdd249fdfcfacb99584001edd28abbab77b5104e98e8e3b35d4","322af4908c7312b0cfbfe369f7a7b3cdb7d4494bc2823700cfd652188a3ea98d"],["af8addbf2b661c8a6c6328655eb96651252007d8c5ea31be4ad196de8ce2131f","6749e67c029b85f52a034eafd096836b2520818680e26ac8f3dfbcdb71749700"],["e3ae1974566ca06cc516d47e0fb165a674a3dabcfca15e722f0e3450f45889","2aeabe7e4531510116217f07bf4d07300de97e4874f81f533420a72eeb0bd6a4"],["591ee355313d99721cf6993ffed1e3e301993ff3ed258802075ea8ced397e246","b0ea558a113c30bea60fc4775460c7901ff0b053d25ca2bdeee98f1a4be5d196"],["11396d55fda54c49f19aa97318d8da61fa8584e47b084945077cf03255b52984","998c74a8cd45ac01289d5833a7beb4744ff536b01b257be4c5767bea93ea57a4"],["3c5d2a1ba39c5a1790000738c9e0c40b8dcdfd5468754b6405540157e017aa7a","b2284279995a34e2f9d4de7396fc18b80f9b8b9fdd270f6661f79ca4c81bd257"],["cc8704b8a60a0defa3a99a7299f2e9c3fbc395afb04ac078425ef8a1793cc030","bdd46039feed17881d1e0862db347f8cf395b74fc4bcdc4e940b74e3ac1f1b13"],["c533e4f7ea8555aacd9777ac5cad29b97dd4defccc53ee7ea204119b2889b197","6f0a256bc5efdf429a2fb6242f1a43a2d9b925bb4a4b3a26bb8e0f45eb596096"],["c14f8f2ccb27d6f109f6d08d03cc96a69ba8c34eec07bbcf566d48e33da6593","c359d6923bb398f7fd4473e16fe1c28475b740dd098075e6c0e8649113dc3a38"],["a6cbc3046bc6a450bac24789fa17115a4c9739ed75f8f21ce441f72e0b90e6ef","21ae7f4680e889bb130619e2c0f95a360ceb573c70603139862afd617fa9b9f"],["347d6d9a02c48927ebfb86c1359b1caf130a3c0267d11ce6344b39f99d43cc38","60ea7f61a353524d1c987f6ecec92f086d565ab687870cb12689ff1e31c74448"],["da6545d2181db8d983f7dcb375ef5866d47c67b1bf31c8cf855ef7437b72656a","49b96715ab6878a79e78f07ce5680c5d6673051b4935bd897fea824b77dc208a"],["c40747cc9d012cb1a13b8148309c6de7ec25d6945d657146b9d5994b8feb1111","5ca560753be2a12fc6de6caf2cb489565db936156b9514e1bb5e83037e0fa2d4"],["4e42c8ec82c99798ccf3a610be870e78338c7f713348bd34c8203ef4037f3502","7571d74ee5e0fb92a7a8b33a07783341a5492144cc54bcc40a94473693606437"],["3775ab7089bc6af823aba2e1af70b236d251cadb0c86743287522a1b3b0dedea","be52d107bcfa09d8bcb9736a828cfa7fac8db17bf7a76a2c42ad961409018cf7"],["cee31cbf7e34ec379d94fb814d3d775ad954595d1314ba8846959e3e82f74e26","8fd64a14c06b589c26b947ae2bcf6bfa0149ef0be14ed4d80f448a01c43b1c6d"],["b4f9eaea09b6917619f6ea6a4eb5464efddb58fd45b1ebefcdc1a01d08b47986","39e5c9925b5a54b07433a4f18c61726f8bb131c012ca542eb24a8ac07200682a"],["d4263dfc3d2df923a0179a48966d30ce84e2515afc3dccc1b77907792ebcc60e","62dfaf07a0f78feb30e30d6295853ce189e127760ad6cf7fae164e122a208d54"],["48457524820fa65a4f8d35eb6930857c0032acc0a4a2de422233eeda897612c4","25a748ab367979d98733c38a1fa1c2e7dc6cc07db2d60a9ae7a76aaa49bd0f77"],["dfeeef1881101f2cb11644f3a2afdfc2045e19919152923f367a1767c11cceda","ecfb7056cf1de042f9420bab396793c0c390bde74b4bbdff16a83ae09a9a7517"],["6d7ef6b17543f8373c573f44e1f389835d89bcbc6062ced36c82df83b8fae859","cd450ec335438986dfefa10c57fea9bcc521a0959b2d80bbf74b190dca712d10"],["e75605d59102a5a2684500d3b991f2e3f3c88b93225547035af25af66e04541f","f5c54754a8f71ee540b9b48728473e314f729ac5308b06938360990e2bfad125"],["eb98660f4c4dfaa06a2be453d5020bc99a0c2e60abe388457dd43fefb1ed620c","6cb9a8876d9cb8520609af3add26cd20a0a7cd8a9411131ce85f44100099223e"],["13e87b027d8514d35939f2e6892b19922154596941888336dc3563e3b8dba942","fef5a3c68059a6dec5d624114bf1e91aac2b9da568d6abeb2570d55646b8adf1"],["ee163026e9fd6fe017c38f06a5be6fc125424b371ce2708e7bf4491691e5764a","1acb250f255dd61c43d94ccc670d0f58f49ae3fa15b96623e5430da0ad6c62b2"],["b268f5ef9ad51e4d78de3a750c2dc89b1e626d43505867999932e5db33af3d80","5f310d4b3c99b9ebb19f77d41c1dee018cf0d34fd4191614003e945a1216e423"],["ff07f3118a9df035e9fad85eb6c7bfe42b02f01ca99ceea3bf7ffdba93c4750d","438136d603e858a3a5c440c38eccbaddc1d2942114e2eddd4740d098ced1f0d8"],["8d8b9855c7c052a34146fd20ffb658bea4b9f69e0d825ebec16e8c3ce2b526a1","cdb559eedc2d79f926baf44fb84ea4d44bcf50fee51d7ceb30e2e7f463036758"],["52db0b5384dfbf05bfa9d472d7ae26dfe4b851ceca91b1eba54263180da32b63","c3b997d050ee5d423ebaf66a6db9f57b3180c902875679de924b69d84a7b375"],["e62f9490d3d51da6395efd24e80919cc7d0f29c3f3fa48c6fff543becbd43352","6d89ad7ba4876b0b22c2ca280c682862f342c8591f1daf5170e07bfd9ccafa7d"],["7f30ea2476b399b4957509c88f77d0191afa2ff5cb7b14fd6d8e7d65aaab1193","ca5ef7d4b231c94c3b15389a5f6311e9daff7bb67b103e9880ef4bff637acaec"],["5098ff1e1d9f14fb46a210fada6c903fef0fb7b4a1dd1d9ac60a0361800b7a00","9731141d81fc8f8084d37c6e7542006b3ee1b40d60dfe5362a5b132fd17ddc0"],["32b78c7de9ee512a72895be6b9cbefa6e2f3c4ccce445c96b9f2c81e2778ad58","ee1849f513df71e32efc3896ee28260c73bb80547ae2275ba497237794c8753c"],["e2cb74fddc8e9fbcd076eef2a7c72b0ce37d50f08269dfc074b581550547a4f7","d3aa2ed71c9dd2247a62df062736eb0baddea9e36122d2be8641abcb005cc4a4"],["8438447566d4d7bedadc299496ab357426009a35f235cb141be0d99cd10ae3a8","c4e1020916980a4da5d01ac5e6ad330734ef0d7906631c4f2390426b2edd791f"],["4162d488b89402039b584c6fc6c308870587d9c46f660b878ab65c82c711d67e","67163e903236289f776f22c25fb8a3afc1732f2b84b4e95dbda47ae5a0852649"],["3fad3fa84caf0f34f0f89bfd2dcf54fc175d767aec3e50684f3ba4a4bf5f683d","cd1bc7cb6cc407bb2f0ca647c718a730cf71872e7d0d2a53fa20efcdfe61826"],["674f2600a3007a00568c1a7ce05d0816c1fb84bf1370798f1c69532faeb1a86b","299d21f9413f33b3edf43b257004580b70db57da0b182259e09eecc69e0d38a5"],["d32f4da54ade74abb81b815ad1fb3b263d82d6c692714bcff87d29bd5ee9f08f","f9429e738b8e53b968e99016c059707782e14f4535359d582fc416910b3eea87"],["30e4e670435385556e593657135845d36fbb6931f72b08cb1ed954f1e3ce3ff6","462f9bce619898638499350113bbc9b10a878d35da70740dc695a559eb88db7b"],["be2062003c51cc3004682904330e4dee7f3dcd10b01e580bf1971b04d4cad297","62188bc49d61e5428573d48a74e1c655b1c61090905682a0d5558ed72dccb9bc"],["93144423ace3451ed29e0fb9ac2af211cb6e84a601df5993c419859fff5df04a","7c10dfb164c3425f5c71a3f9d7992038f1065224f72bb9d1d902a6d13037b47c"],["b015f8044f5fcbdcf21ca26d6c34fb8197829205c7b7d2a7cb66418c157b112c","ab8c1e086d04e813744a655b2df8d5f83b3cdc6faa3088c1d3aea1454e3a1d5f"],["d5e9e1da649d97d89e4868117a465a3a4f8a18de57a140d36b3f2af341a21b52","4cb04437f391ed73111a13cc1d4dd0db1693465c2240480d8955e8592f27447a"],["d3ae41047dd7ca065dbf8ed77b992439983005cd72e16d6f996a5316d36966bb","bd1aeb21ad22ebb22a10f0303417c6d964f8cdd7df0aca614b10dc14d125ac46"],["463e2763d885f958fc66cdd22800f0a487197d0a82e377b49f80af87c897b065","bfefacdb0e5d0fd7df3a311a94de062b26b80c61fbc97508b79992671ef7ca7f"],["7985fdfd127c0567c6f53ec1bb63ec3158e597c40bfe747c83cddfc910641917","603c12daf3d9862ef2b25fe1de289aed24ed291e0ec6708703a5bd567f32ed03"],["74a1ad6b5f76e39db2dd249410eac7f99e74c59cb83d2d0ed5ff1543da7703e9","cc6157ef18c9c63cd6193d83631bbea0093e0968942e8c33d5737fd790e0db08"],["30682a50703375f602d416664ba19b7fc9bab42c72747463a71d0896b22f6da3","553e04f6b018b4fa6c8f39e7f311d3176290d0e0f19ca73f17714d9977a22ff8"],["9e2158f0d7c0d5f26c3791efefa79597654e7a2b2464f52b1ee6c1347769ef57","712fcdd1b9053f09003a3481fa7762e9ffd7c8ef35a38509e2fbf2629008373"],["176e26989a43c9cfeba4029c202538c28172e566e3c4fce7322857f3be327d66","ed8cc9d04b29eb877d270b4878dc43c19aefd31f4eee09ee7b47834c1fa4b1c3"],["75d46efea3771e6e68abb89a13ad747ecf1892393dfc4f1b7004788c50374da8","9852390a99507679fd0b86fd2b39a868d7efc22151346e1a3ca4726586a6bed8"],["809a20c67d64900ffb698c4c825f6d5f2310fb0451c869345b7319f645605721","9e994980d9917e22b76b061927fa04143d096ccc54963e6a5ebfa5f3f8e286c1"],["1b38903a43f7f114ed4500b4eac7083fdefece1cf29c63528d563446f972c180","4036edc931a60ae889353f77fd53de4a2708b26b6f5da72ad3394119daf408f9"]]}}},function(module,exports,__webpack_require__){"use strict";var BN=__webpack_require__(6),HmacDRBG=__webpack_require__(169),elliptic=__webpack_require__(8),assert=elliptic.utils.assert,KeyPair=__webpack_require__(170),Signature=__webpack_require__(171);function EC(options){if(!(this instanceof EC))return new EC(options);"string"==typeof options&&(assert(elliptic.curves.hasOwnProperty(options),"Unknown curve "+options),options=elliptic.curves[options]),options instanceof elliptic.curves.PresetCurve&&(options={curve:options}),this.curve=options.curve.curve,this.n=this.curve.n,this.nh=this.n.ushrn(1),this.g=this.curve.g,this.g=options.curve.g,this.g.precompute(options.curve.n.bitLength()+1),this.hash=options.hash||options.curve.hash}module.exports=EC,EC.prototype.keyPair=function(options){return new KeyPair(this,options)},EC.prototype.keyFromPrivate=function(priv,enc){return KeyPair.fromPrivate(this,priv,enc)},EC.prototype.keyFromPublic=function(pub,enc){return KeyPair.fromPublic(this,pub,enc)},EC.prototype.genKeyPair=function(options){options||(options={});for(var drbg=new HmacDRBG({hash:this.hash,pers:options.pers,persEnc:options.persEnc||"utf8",entropy:options.entropy||elliptic.rand(this.hash.hmacStrength),entropyEnc:options.entropy&&options.entropyEnc||"utf8",nonce:this.n.toArray()}),bytes=this.n.byteLength(),ns2=this.n.sub(new BN(2));;){var priv=new BN(drbg.generate(bytes));if(!(priv.cmp(ns2)>0))return priv.iaddn(1),this.keyFromPrivate(priv)}},EC.prototype._truncateToN=function(msg,truncOnly){var delta=8*msg.byteLength()-this.n.bitLength();return delta>0&&(msg=msg.ushrn(delta)),!truncOnly&&msg.cmp(this.n)>=0?msg.sub(this.n):msg},EC.prototype.sign=function(msg,key,enc,options){"object"==typeof enc&&(options=enc,enc=null),options||(options={}),key=this.keyFromPrivate(key,enc),msg=this._truncateToN(new BN(msg,16));for(var bytes=this.n.byteLength(),bkey=key.getPrivate().toArray("be",bytes),nonce=msg.toArray("be",bytes),drbg=new HmacDRBG({hash:this.hash,entropy:bkey,nonce:nonce,pers:options.pers,persEnc:options.persEnc||"utf8"}),ns1=this.n.sub(new BN(1)),iter=0;;iter++){var k=options.k?options.k(iter):new BN(drbg.generate(this.n.byteLength()));if(!((k=this._truncateToN(k,!0)).cmpn(1)<=0||k.cmp(ns1)>=0)){var kp=this.g.mul(k);if(!kp.isInfinity()){var kpX=kp.getX(),r=kpX.umod(this.n);if(0!==r.cmpn(0)){var s=k.invm(this.n).mul(r.mul(key.getPrivate()).iadd(msg));if(0!==(s=s.umod(this.n)).cmpn(0)){var recoveryParam=(kp.getY().isOdd()?1:0)|(0!==kpX.cmp(r)?2:0);return options.canonical&&s.cmp(this.nh)>0&&(s=this.n.sub(s),recoveryParam^=1),new Signature({r:r,s:s,recoveryParam:recoveryParam})}}}}}},EC.prototype.verify=function(msg,signature,key,enc){msg=this._truncateToN(new BN(msg,16)),key=this.keyFromPublic(key,enc);var r=(signature=new Signature(signature,"hex")).r,s=signature.s;if(r.cmpn(1)<0||r.cmp(this.n)>=0)return!1;if(s.cmpn(1)<0||s.cmp(this.n)>=0)return!1;var p,sinv=s.invm(this.n),u1=sinv.mul(msg).umod(this.n),u2=sinv.mul(r).umod(this.n);return this.curve._maxwellTrick?!(p=this.g.jmulAdd(u1,key.getPublic(),u2)).isInfinity()&&p.eqXToP(r):!(p=this.g.mulAdd(u1,key.getPublic(),u2)).isInfinity()&&0===p.getX().umod(this.n).cmp(r)},EC.prototype.recoverPubKey=function(msg,signature,j,enc){assert((3&j)===j,"The recovery param is more than two bits"),signature=new Signature(signature,enc);var n=this.n,e=new BN(msg),r=signature.r,s=signature.s,isYOdd=1&j,isSecondKey=j>>1;if(r.cmp(this.curve.p.umod(this.curve.n))>=0&&isSecondKey)throw new Error("Unable to find sencond key candinate");r=isSecondKey?this.curve.pointFromX(r.add(this.curve.n),isYOdd):this.curve.pointFromX(r,isYOdd);var rInv=signature.r.invm(n),s1=n.sub(e).mul(rInv).umod(n),s2=s.mul(rInv).umod(n);return this.g.mulAdd(s1,r,s2)},EC.prototype.getKeyRecoveryParam=function(e,signature,Q,enc){if(null!==(signature=new Signature(signature,enc)).recoveryParam)return signature.recoveryParam;for(var i=0;i<4;i++){var Qprime;try{Qprime=this.recoverPubKey(e,signature,i)}catch(e){continue}if(Qprime.eq(Q))return i}throw new Error("Unable to find valid recovery factor")}},function(module,exports,__webpack_require__){"use strict";var hash=__webpack_require__(45),utils=__webpack_require__(71),assert=__webpack_require__(9);function HmacDRBG(options){if(!(this instanceof HmacDRBG))return new HmacDRBG(options);this.hash=options.hash,this.predResist=!!options.predResist,this.outLen=this.hash.outSize,this.minEntropy=options.minEntropy||this.hash.hmacStrength,this._reseed=null,this.reseedInterval=null,this.K=null,this.V=null;var entropy=utils.toArray(options.entropy,options.entropyEnc||"hex"),nonce=utils.toArray(options.nonce,options.nonceEnc||"hex"),pers=utils.toArray(options.pers,options.persEnc||"hex");assert(entropy.length>=this.minEntropy/8,"Not enough entropy. Minimum is: "+this.minEntropy+" bits"),this._init(entropy,nonce,pers)}module.exports=HmacDRBG,HmacDRBG.prototype._init=function(entropy,nonce,pers){var seed=entropy.concat(nonce).concat(pers);this.K=new Array(this.outLen/8),this.V=new Array(this.outLen/8);for(var i=0;i<this.V.length;i++)this.K[i]=0,this.V[i]=1;this._update(seed),this._reseed=1,this.reseedInterval=281474976710656},HmacDRBG.prototype._hmac=function(){return new hash.hmac(this.hash,this.K)},HmacDRBG.prototype._update=function(seed){var kmac=this._hmac().update(this.V).update([0]);seed&&(kmac=kmac.update(seed)),this.K=kmac.digest(),this.V=this._hmac().update(this.V).digest(),seed&&(this.K=this._hmac().update(this.V).update([1]).update(seed).digest(),this.V=this._hmac().update(this.V).digest())},HmacDRBG.prototype.reseed=function(entropy,entropyEnc,add,addEnc){"string"!=typeof entropyEnc&&(addEnc=add,add=entropyEnc,entropyEnc=null),entropy=utils.toArray(entropy,entropyEnc),add=utils.toArray(add,addEnc),assert(entropy.length>=this.minEntropy/8,"Not enough entropy. Minimum is: "+this.minEntropy+" bits"),this._update(entropy.concat(add||[])),this._reseed=1},HmacDRBG.prototype.generate=function(len,enc,add,addEnc){if(this._reseed>this.reseedInterval)throw new Error("Reseed is required");"string"!=typeof enc&&(addEnc=add,add=enc,enc=null),add&&(add=utils.toArray(add,addEnc||"hex"),this._update(add));for(var temp=[];temp.length<len;)this.V=this._hmac().update(this.V).digest(),temp=temp.concat(this.V);var res=temp.slice(0,len);return this._update(add),this._reseed++,utils.encode(res,enc)}},function(module,exports,__webpack_require__){"use strict";var BN=__webpack_require__(6),assert=__webpack_require__(8).utils.assert;function KeyPair(ec,options){this.ec=ec,this.priv=null,this.pub=null,options.priv&&this._importPrivate(options.priv,options.privEnc),options.pub&&this._importPublic(options.pub,options.pubEnc)}module.exports=KeyPair,KeyPair.fromPublic=function(ec,pub,enc){return pub instanceof KeyPair?pub:new KeyPair(ec,{pub:pub,pubEnc:enc})},KeyPair.fromPrivate=function(ec,priv,enc){return priv instanceof KeyPair?priv:new KeyPair(ec,{priv:priv,privEnc:enc})},KeyPair.prototype.validate=function(){var pub=this.getPublic();return pub.isInfinity()?{result:!1,reason:"Invalid public key"}:pub.validate()?pub.mul(this.ec.curve.n).isInfinity()?{result:!0,reason:null}:{result:!1,reason:"Public key * N != O"}:{result:!1,reason:"Public key is not a point"}},KeyPair.prototype.getPublic=function(compact,enc){return"string"==typeof compact&&(enc=compact,compact=null),this.pub||(this.pub=this.ec.g.mul(this.priv)),enc?this.pub.encode(enc,compact):this.pub},KeyPair.prototype.getPrivate=function(enc){return"hex"===enc?this.priv.toString(16,2):this.priv},KeyPair.prototype._importPrivate=function(key,enc){this.priv=new BN(key,enc||16),this.priv=this.priv.umod(this.ec.curve.n)},KeyPair.prototype._importPublic=function(key,enc){if(key.x||key.y)return"mont"===this.ec.curve.type?assert(key.x,"Need x coordinate"):"short"!==this.ec.curve.type&&"edwards"!==this.ec.curve.type||assert(key.x&&key.y,"Need both x and y coordinate"),void(this.pub=this.ec.curve.point(key.x,key.y));this.pub=this.ec.curve.decodePoint(key,enc)},KeyPair.prototype.derive=function(pub){return pub.mul(this.priv).getX()},KeyPair.prototype.sign=function(msg,enc,options){return this.ec.sign(msg,this,enc,options)},KeyPair.prototype.verify=function(msg,signature){return this.ec.verify(msg,signature,this)},KeyPair.prototype.inspect=function(){return"<Key priv: "+(this.priv&&this.priv.toString(16,2))+" pub: "+(this.pub&&this.pub.inspect())+" >"}},function(module,exports,__webpack_require__){"use strict";var BN=__webpack_require__(6),utils=__webpack_require__(8).utils,assert=utils.assert;function Signature(options,enc){if(options instanceof Signature)return options;this._importDER(options,enc)||(assert(options.r&&options.s,"Signature without r or s"),this.r=new BN(options.r,16),this.s=new BN(options.s,16),void 0===options.recoveryParam?this.recoveryParam=null:this.recoveryParam=options.recoveryParam)}function Position(){this.place=0}function getLength(buf,p){var initial=buf[p.place++];if(!(128&initial))return initial;for(var octetLen=15&initial,val=0,i=0,off=p.place;i<octetLen;i++,off++)val<<=8,val|=buf[off];return p.place=off,val}function rmPadding(buf){for(var i=0,len=buf.length-1;!buf[i]&&!(128&buf[i+1])&&i<len;)i++;return 0===i?buf:buf.slice(i)}function constructLength(arr,len){if(len<128)arr.push(len);else{var octets=1+(Math.log(len)/Math.LN2>>>3);for(arr.push(128|octets);--octets;)arr.push(len>>>(octets<<3)&255);arr.push(len)}}module.exports=Signature,Signature.prototype._importDER=function(data,enc){data=utils.toArray(data,enc);var p=new Position;if(48!==data[p.place++])return!1;if(getLength(data,p)+p.place!==data.length)return!1;if(2!==data[p.place++])return!1;var rlen=getLength(data,p),r=data.slice(p.place,rlen+p.place);if(p.place+=rlen,2!==data[p.place++])return!1;var slen=getLength(data,p);if(data.length!==slen+p.place)return!1;var s=data.slice(p.place,slen+p.place);return 0===r[0]&&128&r[1]&&(r=r.slice(1)),0===s[0]&&128&s[1]&&(s=s.slice(1)),this.r=new BN(r),this.s=new BN(s),this.recoveryParam=null,!0},Signature.prototype.toDER=function(enc){var r=this.r.toArray(),s=this.s.toArray();for(128&r[0]&&(r=[0].concat(r)),128&s[0]&&(s=[0].concat(s)),r=rmPadding(r),s=rmPadding(s);!(s[0]||128&s[1]);)s=s.slice(1);var arr=[2];constructLength(arr,r.length),(arr=arr.concat(r)).push(2),constructLength(arr,s.length);var backHalf=arr.concat(s),res=[48];return constructLength(res,backHalf.length),res=res.concat(backHalf),utils.encode(res,enc)}},function(module,exports,__webpack_require__){"use strict";var hash=__webpack_require__(45),elliptic=__webpack_require__(8),utils=elliptic.utils,assert=utils.assert,parseBytes=utils.parseBytes,KeyPair=__webpack_require__(173),Signature=__webpack_require__(174);function EDDSA(curve){if(assert("ed25519"===curve,"only tested with ed25519 so far"),!(this instanceof EDDSA))return new EDDSA(curve);curve=elliptic.curves[curve].curve;this.curve=curve,this.g=curve.g,this.g.precompute(curve.n.bitLength()+1),this.pointClass=curve.point().constructor,this.encodingLength=Math.ceil(curve.n.bitLength()/8),this.hash=hash.sha512}module.exports=EDDSA,EDDSA.prototype.sign=function(message,secret){message=parseBytes(message);var key=this.keyFromSecret(secret),r=this.hashInt(key.messagePrefix(),message),R=this.g.mul(r),Rencoded=this.encodePoint(R),s_=this.hashInt(Rencoded,key.pubBytes(),message).mul(key.priv()),S=r.add(s_).umod(this.curve.n);return this.makeSignature({R:R,S:S,Rencoded:Rencoded})},EDDSA.prototype.verify=function(message,sig,pub){message=parseBytes(message),sig=this.makeSignature(sig);var key=this.keyFromPublic(pub),h=this.hashInt(sig.Rencoded(),key.pubBytes(),message),SG=this.g.mul(sig.S());return sig.R().add(key.pub().mul(h)).eq(SG)},EDDSA.prototype.hashInt=function(){for(var hash=this.hash(),i=0;i<arguments.length;i++)hash.update(arguments[i]);return utils.intFromLE(hash.digest()).umod(this.curve.n)},EDDSA.prototype.keyFromPublic=function(pub){return KeyPair.fromPublic(this,pub)},EDDSA.prototype.keyFromSecret=function(secret){return KeyPair.fromSecret(this,secret)},EDDSA.prototype.makeSignature=function(sig){return sig instanceof Signature?sig:new Signature(this,sig)},EDDSA.prototype.encodePoint=function(point){var enc=point.getY().toArray("le",this.encodingLength);return enc[this.encodingLength-1]|=point.getX().isOdd()?128:0,enc},EDDSA.prototype.decodePoint=function(bytes){var lastIx=(bytes=utils.parseBytes(bytes)).length-1,normed=bytes.slice(0,lastIx).concat(-129&bytes[lastIx]),xIsOdd=0!=(128&bytes[lastIx]),y=utils.intFromLE(normed);return this.curve.pointFromY(y,xIsOdd)},EDDSA.prototype.encodeInt=function(num){return num.toArray("le",this.encodingLength)},EDDSA.prototype.decodeInt=function(bytes){return utils.intFromLE(bytes)},EDDSA.prototype.isPoint=function(val){return val instanceof this.pointClass}},function(module,exports,__webpack_require__){"use strict";var utils=__webpack_require__(8).utils,assert=utils.assert,parseBytes=utils.parseBytes,cachedProperty=utils.cachedProperty;function KeyPair(eddsa,params){this.eddsa=eddsa,this._secret=parseBytes(params.secret),eddsa.isPoint(params.pub)?this._pub=params.pub:this._pubBytes=parseBytes(params.pub)}KeyPair.fromPublic=function(eddsa,pub){return pub instanceof KeyPair?pub:new KeyPair(eddsa,{pub:pub})},KeyPair.fromSecret=function(eddsa,secret){return secret instanceof KeyPair?secret:new KeyPair(eddsa,{secret:secret})},KeyPair.prototype.secret=function(){return this._secret},cachedProperty(KeyPair,"pubBytes",(function(){return this.eddsa.encodePoint(this.pub())})),cachedProperty(KeyPair,"pub",(function(){return this._pubBytes?this.eddsa.decodePoint(this._pubBytes):this.eddsa.g.mul(this.priv())})),cachedProperty(KeyPair,"privBytes",(function(){var eddsa=this.eddsa,hash=this.hash(),lastIx=eddsa.encodingLength-1,a=hash.slice(0,eddsa.encodingLength);return a[0]&=248,a[lastIx]&=127,a[lastIx]|=64,a})),cachedProperty(KeyPair,"priv",(function(){return this.eddsa.decodeInt(this.privBytes())})),cachedProperty(KeyPair,"hash",(function(){return this.eddsa.hash().update(this.secret()).digest()})),cachedProperty(KeyPair,"messagePrefix",(function(){return this.hash().slice(this.eddsa.encodingLength)})),KeyPair.prototype.sign=function(message){return assert(this._secret,"KeyPair can only verify"),this.eddsa.sign(message,this)},KeyPair.prototype.verify=function(message,sig){return this.eddsa.verify(message,sig,this)},KeyPair.prototype.getSecret=function(enc){return assert(this._secret,"KeyPair is public only"),utils.encode(this.secret(),enc)},KeyPair.prototype.getPublic=function(enc){return utils.encode(this.pubBytes(),enc)},module.exports=KeyPair},function(module,exports,__webpack_require__){"use strict";var BN=__webpack_require__(6),utils=__webpack_require__(8).utils,assert=utils.assert,cachedProperty=utils.cachedProperty,parseBytes=utils.parseBytes;function Signature(eddsa,sig){this.eddsa=eddsa,"object"!=typeof sig&&(sig=parseBytes(sig)),Array.isArray(sig)&&(sig={R:sig.slice(0,eddsa.encodingLength),S:sig.slice(eddsa.encodingLength)}),assert(sig.R&&sig.S,"Signature without R or S"),eddsa.isPoint(sig.R)&&(this._R=sig.R),sig.S instanceof BN&&(this._S=sig.S),this._Rencoded=Array.isArray(sig.R)?sig.R:sig.Rencoded,this._Sencoded=Array.isArray(sig.S)?sig.S:sig.Sencoded}cachedProperty(Signature,"S",(function(){return this.eddsa.decodeInt(this.Sencoded())})),cachedProperty(Signature,"R",(function(){return this.eddsa.decodePoint(this.Rencoded())})),cachedProperty(Signature,"Rencoded",(function(){return this.eddsa.encodePoint(this.R())})),cachedProperty(Signature,"Sencoded",(function(){return this.eddsa.encodeInt(this.S())})),Signature.prototype.toBytes=function(){return this.Rencoded().concat(this.Sencoded())},Signature.prototype.toHex=function(){return utils.encode(this.toBytes(),"hex").toUpperCase()},module.exports=Signature},function(module,exports,__webpack_require__){"use strict";var asn1=__webpack_require__(25);exports.certificate=__webpack_require__(185);var RSAPrivateKey=asn1.define("RSAPrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("modulus").int(),this.key("publicExponent").int(),this.key("privateExponent").int(),this.key("prime1").int(),this.key("prime2").int(),this.key("exponent1").int(),this.key("exponent2").int(),this.key("coefficient").int())}));exports.RSAPrivateKey=RSAPrivateKey;var RSAPublicKey=asn1.define("RSAPublicKey",(function(){this.seq().obj(this.key("modulus").int(),this.key("publicExponent").int())}));exports.RSAPublicKey=RSAPublicKey;var PublicKey=asn1.define("SubjectPublicKeyInfo",(function(){this.seq().obj(this.key("algorithm").use(AlgorithmIdentifier),this.key("subjectPublicKey").bitstr())}));exports.PublicKey=PublicKey;var AlgorithmIdentifier=asn1.define("AlgorithmIdentifier",(function(){this.seq().obj(this.key("algorithm").objid(),this.key("none").null_().optional(),this.key("curve").objid().optional(),this.key("params").seq().obj(this.key("p").int(),this.key("q").int(),this.key("g").int()).optional())})),PrivateKeyInfo=asn1.define("PrivateKeyInfo",(function(){this.seq().obj(this.key("version").int(),this.key("algorithm").use(AlgorithmIdentifier),this.key("subjectPrivateKey").octstr())}));exports.PrivateKey=PrivateKeyInfo;var EncryptedPrivateKeyInfo=asn1.define("EncryptedPrivateKeyInfo",(function(){this.seq().obj(this.key("algorithm").seq().obj(this.key("id").objid(),this.key("decrypt").seq().obj(this.key("kde").seq().obj(this.key("id").objid(),this.key("kdeparams").seq().obj(this.key("salt").octstr(),this.key("iters").int())),this.key("cipher").seq().obj(this.key("algo").objid(),this.key("iv").octstr()))),this.key("subjectPrivateKey").octstr())}));exports.EncryptedPrivateKey=EncryptedPrivateKeyInfo;var DSAPrivateKey=asn1.define("DSAPrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("p").int(),this.key("q").int(),this.key("g").int(),this.key("pub_key").int(),this.key("priv_key").int())}));exports.DSAPrivateKey=DSAPrivateKey,exports.DSAparam=asn1.define("DSAparam",(function(){this.int()}));var ECPrivateKey=asn1.define("ECPrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("privateKey").octstr(),this.key("parameters").optional().explicit(0).use(ECParameters),this.key("publicKey").optional().explicit(1).bitstr())}));exports.ECPrivateKey=ECPrivateKey;var ECParameters=asn1.define("ECParameters",(function(){this.choice({namedCurve:this.objid()})}));exports.signature=asn1.define("signature",(function(){this.seq().obj(this.key("r").int(),this.key("s").int())}))},function(module,exports,__webpack_require__){var asn1=__webpack_require__(25),inherits=__webpack_require__(1);function Entity(name,body){this.name=name,this.body=body,this.decoders={},this.encoders={}}exports.define=function(name,body){return new Entity(name,body)},Entity.prototype._createNamed=function(base){var named;try{named=__webpack_require__(177).runInThisContext("(function "+this.name+"(entity) {\n  this._initNamed(entity);\n})")}catch(e){named=function(entity){this._initNamed(entity)}}return inherits(named,base),named.prototype._initNamed=function(entity){base.call(this,entity)},new named(this)},Entity.prototype._getDecoder=function(enc){return enc=enc||"der",this.decoders.hasOwnProperty(enc)||(this.decoders[enc]=this._createNamed(asn1.decoders[enc])),this.decoders[enc]},Entity.prototype.decode=function(data,enc,options){return this._getDecoder(enc).decode(data,options)},Entity.prototype._getEncoder=function(enc){return enc=enc||"der",this.encoders.hasOwnProperty(enc)||(this.encoders[enc]=this._createNamed(asn1.encoders[enc])),this.encoders[enc]},Entity.prototype.encode=function(data,enc,reporter){return this._getEncoder(enc).encode(data,reporter)}},function(module,exports){var indexOf=function(xs,item){if(xs.indexOf)return xs.indexOf(item);for(var i=0;i<xs.length;i++)if(xs[i]===item)return i;return-1},Object_keys=function(obj){if(Object.keys)return Object.keys(obj);var res=[];for(var key in obj)res.push(key);return res},forEach=function(xs,fn){if(xs.forEach)return xs.forEach(fn);for(var i=0;i<xs.length;i++)fn(xs[i],i,xs)},defineProp=function(){try{return Object.defineProperty({},"_",{}),function(obj,name,value){Object.defineProperty(obj,name,{writable:!0,enumerable:!1,configurable:!0,value:value})}}catch(e){return function(obj,name,value){obj[name]=value}}}(),globals=["Array","Boolean","Date","Error","EvalError","Function","Infinity","JSON","Math","NaN","Number","Object","RangeError","ReferenceError","RegExp","String","SyntaxError","TypeError","URIError","decodeURI","decodeURIComponent","encodeURI","encodeURIComponent","escape","eval","isFinite","isNaN","parseFloat","parseInt","undefined","unescape"];function Context(){}Context.prototype={};var Script=exports.Script=function(code){if(!(this instanceof Script))return new Script(code);this.code=code};Script.prototype.runInContext=function(context){if(!(context instanceof Context))throw new TypeError("needs a 'context' argument.");var iframe=document.createElement("iframe");iframe.style||(iframe.style={}),iframe.style.display="none",document.body.appendChild(iframe);var win=iframe.contentWindow,wEval=win.eval,wExecScript=win.execScript;!wEval&&wExecScript&&(wExecScript.call(win,"null"),wEval=win.eval),forEach(Object_keys(context),(function(key){win[key]=context[key]})),forEach(globals,(function(key){context[key]&&(win[key]=context[key])}));var winKeys=Object_keys(win),res=wEval.call(win,this.code);return forEach(Object_keys(win),(function(key){(key in context||-1===indexOf(winKeys,key))&&(context[key]=win[key])})),forEach(globals,(function(key){key in context||defineProp(context,key,win[key])})),document.body.removeChild(iframe),res},Script.prototype.runInThisContext=function(){return eval(this.code)},Script.prototype.runInNewContext=function(context){var ctx=Script.createContext(context),res=this.runInContext(ctx);return context&&forEach(Object_keys(ctx),(function(key){context[key]=ctx[key]})),res},forEach(Object_keys(Script.prototype),(function(name){exports[name]=Script[name]=function(code){var s=Script(code);return s[name].apply(s,[].slice.call(arguments,1))}})),exports.isContext=function(context){return context instanceof Context},exports.createScript=function(code){return exports.Script(code)},exports.createContext=Script.createContext=function(context){var copy=new Context;return"object"==typeof context&&forEach(Object_keys(context),(function(key){copy[key]=context[key]})),copy}},function(module,exports,__webpack_require__){var inherits=__webpack_require__(1);function Reporter(options){this._reporterState={obj:null,path:[],options:options||{},errors:[]}}function ReporterError(path,msg){this.path=path,this.rethrow(msg)}exports.Reporter=Reporter,Reporter.prototype.isError=function(obj){return obj instanceof ReporterError},Reporter.prototype.save=function(){var state=this._reporterState;return{obj:state.obj,pathLen:state.path.length}},Reporter.prototype.restore=function(data){var state=this._reporterState;state.obj=data.obj,state.path=state.path.slice(0,data.pathLen)},Reporter.prototype.enterKey=function(key){return this._reporterState.path.push(key)},Reporter.prototype.exitKey=function(index){var state=this._reporterState;state.path=state.path.slice(0,index-1)},Reporter.prototype.leaveKey=function(index,key,value){var state=this._reporterState;this.exitKey(index),null!==state.obj&&(state.obj[key]=value)},Reporter.prototype.path=function(){return this._reporterState.path.join("/")},Reporter.prototype.enterObject=function(){var state=this._reporterState,prev=state.obj;return state.obj={},prev},Reporter.prototype.leaveObject=function(prev){var state=this._reporterState,now=state.obj;return state.obj=prev,now},Reporter.prototype.error=function(msg){var err,state=this._reporterState,inherited=msg instanceof ReporterError;if(err=inherited?msg:new ReporterError(state.path.map((function(elem){return"["+JSON.stringify(elem)+"]"})).join(""),msg.message||msg,msg.stack),!state.options.partial)throw err;return inherited||state.errors.push(err),err},Reporter.prototype.wrapResult=function(result){var state=this._reporterState;return state.options.partial?{result:this.isError(result)?null:result,errors:state.errors}:result},inherits(ReporterError,Error),ReporterError.prototype.rethrow=function(msg){if(this.message=msg+" at: "+(this.path||"(shallow)"),Error.captureStackTrace&&Error.captureStackTrace(this,ReporterError),!this.stack)try{throw new Error(this.message)}catch(e){this.stack=e.stack}return this}},function(module,exports,__webpack_require__){var Reporter=__webpack_require__(26).Reporter,EncoderBuffer=__webpack_require__(26).EncoderBuffer,DecoderBuffer=__webpack_require__(26).DecoderBuffer,assert=__webpack_require__(9),tags=["seq","seqof","set","setof","objid","bool","gentime","utctime","null_","enum","int","objDesc","bitstr","bmpstr","charstr","genstr","graphstr","ia5str","iso646str","numstr","octstr","printstr","t61str","unistr","utf8str","videostr"],methods=["key","obj","use","optional","explicit","implicit","def","choice","any","contains"].concat(tags);function Node(enc,parent){var state={};this._baseState=state,state.enc=enc,state.parent=parent||null,state.children=null,state.tag=null,state.args=null,state.reverseArgs=null,state.choice=null,state.optional=!1,state.any=!1,state.obj=!1,state.use=null,state.useDecoder=null,state.key=null,state.default=null,state.explicit=null,state.implicit=null,state.contains=null,state.parent||(state.children=[],this._wrap())}module.exports=Node;var stateProps=["enc","parent","children","tag","args","reverseArgs","choice","optional","any","obj","use","alteredUse","key","default","explicit","implicit","contains"];Node.prototype.clone=function(){var state=this._baseState,cstate={};stateProps.forEach((function(prop){cstate[prop]=state[prop]}));var res=new this.constructor(cstate.parent);return res._baseState=cstate,res},Node.prototype._wrap=function(){var state=this._baseState;methods.forEach((function(method){this[method]=function(){var clone=new this.constructor(this);return state.children.push(clone),clone[method].apply(clone,arguments)}}),this)},Node.prototype._init=function(body){var state=this._baseState;assert(null===state.parent),body.call(this),state.children=state.children.filter((function(child){return child._baseState.parent===this}),this),assert.equal(state.children.length,1,"Root node can have only one child")},Node.prototype._useArgs=function(args){var state=this._baseState,children=args.filter((function(arg){return arg instanceof this.constructor}),this);args=args.filter((function(arg){return!(arg instanceof this.constructor)}),this),0!==children.length&&(assert(null===state.children),state.children=children,children.forEach((function(child){child._baseState.parent=this}),this)),0!==args.length&&(assert(null===state.args),state.args=args,state.reverseArgs=args.map((function(arg){if("object"!=typeof arg||arg.constructor!==Object)return arg;var res={};return Object.keys(arg).forEach((function(key){key==(0|key)&&(key|=0);var value=arg[key];res[value]=key})),res})))},["_peekTag","_decodeTag","_use","_decodeStr","_decodeObjid","_decodeTime","_decodeNull","_decodeInt","_decodeBool","_decodeList","_encodeComposite","_encodeStr","_encodeObjid","_encodeTime","_encodeNull","_encodeInt","_encodeBool"].forEach((function(method){Node.prototype[method]=function(){var state=this._baseState;throw new Error(method+" not implemented for encoding: "+state.enc)}})),tags.forEach((function(tag){Node.prototype[tag]=function(){var state=this._baseState,args=Array.prototype.slice.call(arguments);return assert(null===state.tag),state.tag=tag,this._useArgs(args),this}})),Node.prototype.use=function(item){assert(item);var state=this._baseState;return assert(null===state.use),state.use=item,this},Node.prototype.optional=function(){return this._baseState.optional=!0,this},Node.prototype.def=function(val){var state=this._baseState;return assert(null===state.default),state.default=val,state.optional=!0,this},Node.prototype.explicit=function(num){var state=this._baseState;return assert(null===state.explicit&&null===state.implicit),state.explicit=num,this},Node.prototype.implicit=function(num){var state=this._baseState;return assert(null===state.explicit&&null===state.implicit),state.implicit=num,this},Node.prototype.obj=function(){var state=this._baseState,args=Array.prototype.slice.call(arguments);return state.obj=!0,0!==args.length&&this._useArgs(args),this},Node.prototype.key=function(newKey){var state=this._baseState;return assert(null===state.key),state.key=newKey,this},Node.prototype.any=function(){return this._baseState.any=!0,this},Node.prototype.choice=function(obj){var state=this._baseState;return assert(null===state.choice),state.choice=obj,this._useArgs(Object.keys(obj).map((function(key){return obj[key]}))),this},Node.prototype.contains=function(item){var state=this._baseState;return assert(null===state.use),state.contains=item,this},Node.prototype._decode=function(input,options){var state=this._baseState;if(null===state.parent)return input.wrapResult(state.children[0]._decode(input,options));var prevObj,result=state.default,present=!0,prevKey=null;if(null!==state.key&&(prevKey=input.enterKey(state.key)),state.optional){var tag=null;if(null!==state.explicit?tag=state.explicit:null!==state.implicit?tag=state.implicit:null!==state.tag&&(tag=state.tag),null!==tag||state.any){if(present=this._peekTag(input,tag,state.any),input.isError(present))return present}else{var save=input.save();try{null===state.choice?this._decodeGeneric(state.tag,input,options):this._decodeChoice(input,options),present=!0}catch(e){present=!1}input.restore(save)}}if(state.obj&&present&&(prevObj=input.enterObject()),present){if(null!==state.explicit){var explicit=this._decodeTag(input,state.explicit);if(input.isError(explicit))return explicit;input=explicit}var start=input.offset;if(null===state.use&&null===state.choice){if(state.any)save=input.save();var body=this._decodeTag(input,null!==state.implicit?state.implicit:state.tag,state.any);if(input.isError(body))return body;state.any?result=input.raw(save):input=body}if(options&&options.track&&null!==state.tag&&options.track(input.path(),start,input.length,"tagged"),options&&options.track&&null!==state.tag&&options.track(input.path(),input.offset,input.length,"content"),result=state.any?result:null===state.choice?this._decodeGeneric(state.tag,input,options):this._decodeChoice(input,options),input.isError(result))return result;if(state.any||null!==state.choice||null===state.children||state.children.forEach((function(child){child._decode(input,options)})),state.contains&&("octstr"===state.tag||"bitstr"===state.tag)){var data=new DecoderBuffer(result);result=this._getUse(state.contains,input._reporterState.obj)._decode(data,options)}}return state.obj&&present&&(result=input.leaveObject(prevObj)),null===state.key||null===result&&!0!==present?null!==prevKey&&input.exitKey(prevKey):input.leaveKey(prevKey,state.key,result),result},Node.prototype._decodeGeneric=function(tag,input,options){var state=this._baseState;return"seq"===tag||"set"===tag?null:"seqof"===tag||"setof"===tag?this._decodeList(input,tag,state.args[0],options):/str$/.test(tag)?this._decodeStr(input,tag,options):"objid"===tag&&state.args?this._decodeObjid(input,state.args[0],state.args[1],options):"objid"===tag?this._decodeObjid(input,null,null,options):"gentime"===tag||"utctime"===tag?this._decodeTime(input,tag,options):"null_"===tag?this._decodeNull(input,options):"bool"===tag?this._decodeBool(input,options):"objDesc"===tag?this._decodeStr(input,tag,options):"int"===tag||"enum"===tag?this._decodeInt(input,state.args&&state.args[0],options):null!==state.use?this._getUse(state.use,input._reporterState.obj)._decode(input,options):input.error("unknown tag: "+tag)},Node.prototype._getUse=function(entity,obj){var state=this._baseState;return state.useDecoder=this._use(entity,obj),assert(null===state.useDecoder._baseState.parent),state.useDecoder=state.useDecoder._baseState.children[0],state.implicit!==state.useDecoder._baseState.implicit&&(state.useDecoder=state.useDecoder.clone(),state.useDecoder._baseState.implicit=state.implicit),state.useDecoder},Node.prototype._decodeChoice=function(input,options){var state=this._baseState,result=null,match=!1;return Object.keys(state.choice).some((function(key){var save=input.save(),node=state.choice[key];try{var value=node._decode(input,options);if(input.isError(value))return!1;result={type:key,value:value},match=!0}catch(e){return input.restore(save),!1}return!0}),this),match?result:input.error("Choice not matched")},Node.prototype._createEncoderBuffer=function(data){return new EncoderBuffer(data,this.reporter)},Node.prototype._encode=function(data,reporter,parent){var state=this._baseState;if(null===state.default||state.default!==data){var result=this._encodeValue(data,reporter,parent);if(void 0!==result&&!this._skipDefault(result,reporter,parent))return result}},Node.prototype._encodeValue=function(data,reporter,parent){var state=this._baseState;if(null===state.parent)return state.children[0]._encode(data,reporter||new Reporter);var result=null;if(this.reporter=reporter,state.optional&&void 0===data){if(null===state.default)return;data=state.default}var content=null,primitive=!1;if(state.any)result=this._createEncoderBuffer(data);else if(state.choice)result=this._encodeChoice(data,reporter);else if(state.contains)content=this._getUse(state.contains,parent)._encode(data,reporter),primitive=!0;else if(state.children)content=state.children.map((function(child){if("null_"===child._baseState.tag)return child._encode(null,reporter,data);if(null===child._baseState.key)return reporter.error("Child should have a key");var prevKey=reporter.enterKey(child._baseState.key);if("object"!=typeof data)return reporter.error("Child expected, but input is not object");var res=child._encode(data[child._baseState.key],reporter,data);return reporter.leaveKey(prevKey),res}),this).filter((function(child){return child})),content=this._createEncoderBuffer(content);else if("seqof"===state.tag||"setof"===state.tag){if(!state.args||1!==state.args.length)return reporter.error("Too many args for : "+state.tag);if(!Array.isArray(data))return reporter.error("seqof/setof, but data is not Array");var child=this.clone();child._baseState.implicit=null,content=this._createEncoderBuffer(data.map((function(item){var state=this._baseState;return this._getUse(state.args[0],data)._encode(item,reporter)}),child))}else null!==state.use?result=this._getUse(state.use,parent)._encode(data,reporter):(content=this._encodePrimitive(state.tag,data),primitive=!0);if(!state.any&&null===state.choice){var tag=null!==state.implicit?state.implicit:state.tag,cls=null===state.implicit?"universal":"context";null===tag?null===state.use&&reporter.error("Tag could be omitted only for .use()"):null===state.use&&(result=this._encodeComposite(tag,primitive,cls,content))}return null!==state.explicit&&(result=this._encodeComposite(state.explicit,!1,"context",result)),result},Node.prototype._encodeChoice=function(data,reporter){var state=this._baseState,node=state.choice[data.type];return node||assert(!1,data.type+" not found in "+JSON.stringify(Object.keys(state.choice))),node._encode(data.value,reporter)},Node.prototype._encodePrimitive=function(tag,data){var state=this._baseState;if(/str$/.test(tag))return this._encodeStr(data,tag);if("objid"===tag&&state.args)return this._encodeObjid(data,state.reverseArgs[0],state.args[1]);if("objid"===tag)return this._encodeObjid(data,null,null);if("gentime"===tag||"utctime"===tag)return this._encodeTime(data,tag);if("null_"===tag)return this._encodeNull();if("int"===tag||"enum"===tag)return this._encodeInt(data,state.args&&state.reverseArgs[0]);if("bool"===tag)return this._encodeBool(data);if("objDesc"===tag)return this._encodeStr(data,tag);throw new Error("Unsupported tag: "+tag)},Node.prototype._isNumstr=function(str){return/^[0-9 ]*$/.test(str)},Node.prototype._isPrintstr=function(str){return/^[A-Za-z0-9 '\(\)\+,\-\.\/:=\?]*$/.test(str)}},function(module,exports,__webpack_require__){var constants=__webpack_require__(76);exports.tagClass={0:"universal",1:"application",2:"context",3:"private"},exports.tagClassByName=constants._reverse(exports.tagClass),exports.tag={0:"end",1:"bool",2:"int",3:"bitstr",4:"octstr",5:"null_",6:"objid",7:"objDesc",8:"external",9:"real",10:"enum",11:"embed",12:"utf8str",13:"relativeOid",16:"seq",17:"set",18:"numstr",19:"printstr",20:"t61str",21:"videostr",22:"ia5str",23:"utctime",24:"gentime",25:"graphstr",26:"iso646str",27:"genstr",28:"unistr",29:"charstr",30:"bmpstr"},exports.tagByName=constants._reverse(exports.tag)},function(module,exports,__webpack_require__){var decoders=exports;decoders.der=__webpack_require__(77),decoders.pem=__webpack_require__(182)},function(module,exports,__webpack_require__){var inherits=__webpack_require__(1),Buffer=__webpack_require__(5).Buffer,DERDecoder=__webpack_require__(77);function PEMDecoder(entity){DERDecoder.call(this,entity),this.enc="pem"}inherits(PEMDecoder,DERDecoder),module.exports=PEMDecoder,PEMDecoder.prototype.decode=function(data,options){for(var lines=data.toString().split(/[\r\n]+/g),label=options.label.toUpperCase(),re=/^-----(BEGIN|END) ([^-]+)-----$/,start=-1,end=-1,i=0;i<lines.length;i++){var match=lines[i].match(re);if(null!==match&&match[2]===label){if(-1!==start){if("END"!==match[1])break;end=i;break}if("BEGIN"!==match[1])break;start=i}}if(-1===start||-1===end)throw new Error("PEM section not found for: "+label);var base64=lines.slice(start+1,end).join("");base64.replace(/[^a-z0-9\+\/=]+/gi,"");var input=new Buffer(base64,"base64");return DERDecoder.prototype.decode.call(this,input,options)}},function(module,exports,__webpack_require__){var encoders=exports;encoders.der=__webpack_require__(78),encoders.pem=__webpack_require__(184)},function(module,exports,__webpack_require__){var inherits=__webpack_require__(1),DEREncoder=__webpack_require__(78);function PEMEncoder(entity){DEREncoder.call(this,entity),this.enc="pem"}inherits(PEMEncoder,DEREncoder),module.exports=PEMEncoder,PEMEncoder.prototype.encode=function(data,options){for(var p=DEREncoder.prototype.encode.call(this,data).toString("base64"),out=["-----BEGIN "+options.label+"-----"],i=0;i<p.length;i+=64)out.push(p.slice(i,i+64));return out.push("-----END "+options.label+"-----"),out.join("\n")}},function(module,exports,__webpack_require__){"use strict";var asn=__webpack_require__(25),Time=asn.define("Time",(function(){this.choice({utcTime:this.utctime(),generalTime:this.gentime()})})),AttributeTypeValue=asn.define("AttributeTypeValue",(function(){this.seq().obj(this.key("type").objid(),this.key("value").any())})),AlgorithmIdentifier=asn.define("AlgorithmIdentifier",(function(){this.seq().obj(this.key("algorithm").objid(),this.key("parameters").optional())})),SubjectPublicKeyInfo=asn.define("SubjectPublicKeyInfo",(function(){this.seq().obj(this.key("algorithm").use(AlgorithmIdentifier),this.key("subjectPublicKey").bitstr())})),RelativeDistinguishedName=asn.define("RelativeDistinguishedName",(function(){this.setof(AttributeTypeValue)})),RDNSequence=asn.define("RDNSequence",(function(){this.seqof(RelativeDistinguishedName)})),Name=asn.define("Name",(function(){this.choice({rdnSequence:this.use(RDNSequence)})})),Validity=asn.define("Validity",(function(){this.seq().obj(this.key("notBefore").use(Time),this.key("notAfter").use(Time))})),Extension=asn.define("Extension",(function(){this.seq().obj(this.key("extnID").objid(),this.key("critical").bool().def(!1),this.key("extnValue").octstr())})),TBSCertificate=asn.define("TBSCertificate",(function(){this.seq().obj(this.key("version").explicit(0).int(),this.key("serialNumber").int(),this.key("signature").use(AlgorithmIdentifier),this.key("issuer").use(Name),this.key("validity").use(Validity),this.key("subject").use(Name),this.key("subjectPublicKeyInfo").use(SubjectPublicKeyInfo),this.key("issuerUniqueID").implicit(1).bitstr().optional(),this.key("subjectUniqueID").implicit(2).bitstr().optional(),this.key("extensions").explicit(3).seqof(Extension).optional())})),X509Certificate=asn.define("X509Certificate",(function(){this.seq().obj(this.key("tbsCertificate").use(TBSCertificate),this.key("signatureAlgorithm").use(AlgorithmIdentifier),this.key("signatureValue").bitstr())}));module.exports=X509Certificate},function(module){module.exports=JSON.parse('{"2.16.840.1.101.3.4.1.1":"aes-128-ecb","2.16.840.1.101.3.4.1.2":"aes-128-cbc","2.16.840.1.101.3.4.1.3":"aes-128-ofb","2.16.840.1.101.3.4.1.4":"aes-128-cfb","2.16.840.1.101.3.4.1.21":"aes-192-ecb","2.16.840.1.101.3.4.1.22":"aes-192-cbc","2.16.840.1.101.3.4.1.23":"aes-192-ofb","2.16.840.1.101.3.4.1.24":"aes-192-cfb","2.16.840.1.101.3.4.1.41":"aes-256-ecb","2.16.840.1.101.3.4.1.42":"aes-256-cbc","2.16.840.1.101.3.4.1.43":"aes-256-ofb","2.16.840.1.101.3.4.1.44":"aes-256-cfb"}')},function(module,exports,__webpack_require__){(function(Buffer){var findProc=/Proc-Type: 4,ENCRYPTED[\n\r]+DEK-Info: AES-((?:128)|(?:192)|(?:256))-CBC,([0-9A-H]+)[\n\r]+([0-9A-z\n\r\+\/\=]+)[\n\r]+/m,startRegex=/^-----BEGIN ((?:.* KEY)|CERTIFICATE)-----/m,fullRegex=/^-----BEGIN ((?:.* KEY)|CERTIFICATE)-----([0-9A-z\n\r\+\/\=]+)-----END \1-----$/m,evp=__webpack_require__(30),ciphers=__webpack_require__(42);module.exports=function(okey,password){var decrypted,key=okey.toString(),match=key.match(findProc);if(match){var suite="aes"+match[1],iv=new Buffer(match[2],"hex"),cipherText=new Buffer(match[3].replace(/[\r\n]/g,""),"base64"),cipherKey=evp(password,iv.slice(0,8),parseInt(match[1],10)).key,out=[],cipher=ciphers.createDecipheriv(suite,cipherKey,iv);out.push(cipher.update(cipherText)),out.push(cipher.final()),decrypted=Buffer.concat(out)}else{var match2=key.match(fullRegex);decrypted=new Buffer(match2[2].replace(/[\r\n]/g,""),"base64")}return{tag:key.match(startRegex)[1],data:decrypted}}}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){(function(Buffer){var BN=__webpack_require__(6),EC=__webpack_require__(8).ec,parseKeys=__webpack_require__(32),curves=__webpack_require__(79);function checkValue(b,q){if(b.cmpn(0)<=0)throw new Error("invalid sig");if(b.cmp(q)>=q)throw new Error("invalid sig")}module.exports=function(sig,hash,key,signType,tag){var pub=parseKeys(key);if("ec"===pub.type){if("ecdsa"!==signType&&"ecdsa/rsa"!==signType)throw new Error("wrong public key type");return function(sig,hash,pub){var curveId=curves[pub.data.algorithm.curve.join(".")];if(!curveId)throw new Error("unknown curve "+pub.data.algorithm.curve.join("."));var curve=new EC(curveId),pubkey=pub.data.subjectPrivateKey.data;return curve.verify(hash,sig,pubkey)}(sig,hash,pub)}if("dsa"===pub.type){if("dsa"!==signType)throw new Error("wrong public key type");return function(sig,hash,pub){var p=pub.data.p,q=pub.data.q,g=pub.data.g,y=pub.data.pub_key,unpacked=parseKeys.signature.decode(sig,"der"),s=unpacked.s,r=unpacked.r;checkValue(s,q),checkValue(r,q);var montp=BN.mont(p),w=s.invm(q);return 0===g.toRed(montp).redPow(new BN(hash).mul(w).mod(q)).fromRed().mul(y.toRed(montp).redPow(r.mul(w).mod(q)).fromRed()).mod(p).mod(q).cmp(r)}(sig,hash,pub)}if("rsa"!==signType&&"ecdsa/rsa"!==signType)throw new Error("wrong public key type");hash=Buffer.concat([tag,hash]);for(var len=pub.modulus.byteLength(),pad=[1],padNum=0;hash.length+pad.length+2<len;)pad.push(255),padNum++;pad.push(0);for(var i=-1;++i<hash.length;)pad.push(hash[i]);pad=new Buffer(pad);var red=BN.mont(pub.modulus);sig=(sig=new BN(sig).toRed(red)).redPow(new BN(pub.publicExponent)),sig=new Buffer(sig.fromRed().toArray());var out=padNum<8?1:0;for(len=Math.min(sig.length,pad.length),sig.length!==pad.length&&(out=1),i=-1;++i<len;)out|=sig[i]^pad[i];return 0===out}}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){(function(Buffer){var elliptic=__webpack_require__(8),BN=__webpack_require__(6);module.exports=function(curve){return new ECDH(curve)};var aliases={secp256k1:{name:"secp256k1",byteLength:32},secp224r1:{name:"p224",byteLength:28},prime256v1:{name:"p256",byteLength:32},prime192v1:{name:"p192",byteLength:24},ed25519:{name:"ed25519",byteLength:32},secp384r1:{name:"p384",byteLength:48},secp521r1:{name:"p521",byteLength:66}};function ECDH(curve){this.curveType=aliases[curve],this.curveType||(this.curveType={name:curve}),this.curve=new elliptic.ec(this.curveType.name),this.keys=void 0}function formatReturnValue(bn,enc,len){Array.isArray(bn)||(bn=bn.toArray());var buf=new Buffer(bn);if(len&&buf.length<len){var zeros=new Buffer(len-buf.length);zeros.fill(0),buf=Buffer.concat([zeros,buf])}return enc?buf.toString(enc):buf}aliases.p224=aliases.secp224r1,aliases.p256=aliases.secp256r1=aliases.prime256v1,aliases.p192=aliases.secp192r1=aliases.prime192v1,aliases.p384=aliases.secp384r1,aliases.p521=aliases.secp521r1,ECDH.prototype.generateKeys=function(enc,format){return this.keys=this.curve.genKeyPair(),this.getPublicKey(enc,format)},ECDH.prototype.computeSecret=function(other,inenc,enc){return inenc=inenc||"utf8",Buffer.isBuffer(other)||(other=new Buffer(other,inenc)),formatReturnValue(this.curve.keyFromPublic(other).getPublic().mul(this.keys.getPrivate()).getX(),enc,this.curveType.byteLength)},ECDH.prototype.getPublicKey=function(enc,format){var key=this.keys.getPublic("compressed"===format,!0);return"hybrid"===format&&(key[key.length-1]%2?key[0]=7:key[0]=6),formatReturnValue(key,enc)},ECDH.prototype.getPrivateKey=function(enc){return formatReturnValue(this.keys.getPrivate(),enc)},ECDH.prototype.setPublicKey=function(pub,enc){return enc=enc||"utf8",Buffer.isBuffer(pub)||(pub=new Buffer(pub,enc)),this.keys._importPublic(pub),this},ECDH.prototype.setPrivateKey=function(priv,enc){enc=enc||"utf8",Buffer.isBuffer(priv)||(priv=new Buffer(priv,enc));var _priv=new BN(priv);return _priv=_priv.toString(16),this.keys._importPrivate(_priv),this}}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){exports.publicEncrypt=__webpack_require__(191),exports.privateDecrypt=__webpack_require__(192),exports.privateEncrypt=function(key,buf){return exports.publicEncrypt(key,buf,!0)},exports.publicDecrypt=function(key,buf){return exports.privateDecrypt(key,buf,!0)}},function(module,exports,__webpack_require__){(function(Buffer){var parseKeys=__webpack_require__(32),randomBytes=__webpack_require__(16),createHash=__webpack_require__(21),mgf=__webpack_require__(80),xor=__webpack_require__(81),bn=__webpack_require__(6),withPublic=__webpack_require__(82),crt=__webpack_require__(44);module.exports=function(public_key,msg,reverse){var padding;padding=public_key.padding?public_key.padding:reverse?1:4;var paddedMsg,key=parseKeys(public_key);if(4===padding)paddedMsg=function(key,msg){var k=key.modulus.byteLength(),mLen=msg.length,iHash=createHash("sha1").update(new Buffer("")).digest(),hLen=iHash.length,hLen2=2*hLen;if(mLen>k-hLen2-2)throw new Error("message too long");var ps=new Buffer(k-mLen-hLen2-2);ps.fill(0);var dblen=k-hLen-1,seed=randomBytes(hLen),maskedDb=xor(Buffer.concat([iHash,ps,new Buffer([1]),msg],dblen),mgf(seed,dblen)),maskedSeed=xor(seed,mgf(maskedDb,hLen));return new bn(Buffer.concat([new Buffer([0]),maskedSeed,maskedDb],k))}(key,msg);else if(1===padding)paddedMsg=function(key,msg,reverse){var ps,mLen=msg.length,k=key.modulus.byteLength();if(mLen>k-11)throw new Error("message too long");reverse?(ps=new Buffer(k-mLen-3)).fill(255):ps=function(len,crypto){var num,out=new Buffer(len),i=0,cache=randomBytes(2*len),cur=0;for(;i<len;)cur===cache.length&&(cache=randomBytes(2*len),cur=0),(num=cache[cur++])&&(out[i++]=num);return out}(k-mLen-3);return new bn(Buffer.concat([new Buffer([0,reverse?1:2]),ps,new Buffer([0]),msg],k))}(key,msg,reverse);else{if(3!==padding)throw new Error("unknown padding");if((paddedMsg=new bn(msg)).cmp(key.modulus)>=0)throw new Error("data too long for modulus")}return reverse?crt(paddedMsg,key):withPublic(paddedMsg,key)}}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){(function(Buffer){var parseKeys=__webpack_require__(32),mgf=__webpack_require__(80),xor=__webpack_require__(81),bn=__webpack_require__(6),crt=__webpack_require__(44),createHash=__webpack_require__(21),withPublic=__webpack_require__(82);module.exports=function(private_key,enc,reverse){var padding;padding=private_key.padding?private_key.padding:reverse?1:4;var msg,key=parseKeys(private_key),k=key.modulus.byteLength();if(enc.length>k||new bn(enc).cmp(key.modulus)>=0)throw new Error("decryption error");msg=reverse?withPublic(new bn(enc),key):crt(enc,key);var zBuffer=new Buffer(k-msg.length);if(zBuffer.fill(0),msg=Buffer.concat([zBuffer,msg],k),4===padding)return function(key,msg){key.modulus;var k=key.modulus.byteLength(),iHash=(msg.length,createHash("sha1").update(new Buffer("")).digest()),hLen=iHash.length;if(0!==msg[0])throw new Error("decryption error");var maskedSeed=msg.slice(1,hLen+1),maskedDb=msg.slice(hLen+1),seed=xor(maskedSeed,mgf(maskedDb,hLen)),db=xor(maskedDb,mgf(seed,k-hLen-1));if(function(a,b){a=new Buffer(a),b=new Buffer(b);var dif=0,len=a.length;a.length!==b.length&&(dif++,len=Math.min(a.length,b.length));var i=-1;for(;++i<len;)dif+=a[i]^b[i];return dif}(iHash,db.slice(0,hLen)))throw new Error("decryption error");var i=hLen;for(;0===db[i];)i++;if(1!==db[i++])throw new Error("decryption error");return db.slice(i)}(key,msg);if(1===padding)return function(key,msg,reverse){var p1=msg.slice(0,2),i=2,status=0;for(;0!==msg[i++];)if(i>=msg.length){status++;break}var ps=msg.slice(2,i-1);msg.slice(i-1,i);("0002"!==p1.toString("hex")&&!reverse||"0001"!==p1.toString("hex")&&reverse)&&status++;ps.length<8&&status++;if(status)throw new Error("decryption error");return msg.slice(i)}(0,msg,reverse);if(3===padding)return msg;throw new Error("unknown padding")}}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){"use strict";(function(global,process){function oldBrowser(){throw new Error("secure random number generation not supported by this browser\nuse chrome, FireFox or Internet Explorer 11")}var safeBuffer=__webpack_require__(4),randombytes=__webpack_require__(16),Buffer=safeBuffer.Buffer,kBufferMaxLength=safeBuffer.kMaxLength,crypto=global.crypto||global.msCrypto,kMaxUint32=Math.pow(2,32)-1;function assertOffset(offset,length){if("number"!=typeof offset||offset!=offset)throw new TypeError("offset must be a number");if(offset>kMaxUint32||offset<0)throw new TypeError("offset must be a uint32");if(offset>kBufferMaxLength||offset>length)throw new RangeError("offset out of range")}function assertSize(size,offset,length){if("number"!=typeof size||size!=size)throw new TypeError("size must be a number");if(size>kMaxUint32||size<0)throw new TypeError("size must be a uint32");if(size+offset>length||size>kBufferMaxLength)throw new RangeError("buffer too small")}function actualFill(buf,offset,size,cb){if(process.browser){var ourBuf=buf.buffer,uint=new Uint8Array(ourBuf,offset,size);return crypto.getRandomValues(uint),cb?void process.nextTick((function(){cb(null,buf)})):buf}if(!cb)return randombytes(size).copy(buf,offset),buf;randombytes(size,(function(err,bytes){if(err)return cb(err);bytes.copy(buf,offset),cb(null,buf)}))}crypto&&crypto.getRandomValues||!process.browser?(exports.randomFill=function(buf,offset,size,cb){if(!(Buffer.isBuffer(buf)||buf instanceof global.Uint8Array))throw new TypeError('"buf" argument must be a Buffer or Uint8Array');if("function"==typeof offset)cb=offset,offset=0,size=buf.length;else if("function"==typeof size)cb=size,size=buf.length-offset;else if("function"!=typeof cb)throw new TypeError('"cb" argument must be a function');return assertOffset(offset,buf.length),assertSize(size,offset,buf.length),actualFill(buf,offset,size,cb)},exports.randomFillSync=function(buf,offset,size){void 0===offset&&(offset=0);if(!(Buffer.isBuffer(buf)||buf instanceof global.Uint8Array))throw new TypeError('"buf" argument must be a Buffer or Uint8Array');assertOffset(offset,buf.length),void 0===size&&(size=buf.length-offset);return assertSize(size,offset,buf.length),actualFill(buf,offset,size)}):(exports.randomFill=oldBrowser,exports.randomFillSync=oldBrowser)}).call(this,__webpack_require__(10),__webpack_require__(12))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return function(){if("function"==typeof ArrayBuffer){var WordArray=CryptoJS.lib.WordArray,superInit=WordArray.init;(WordArray.init=function(typedArray){if(typedArray instanceof ArrayBuffer&&(typedArray=new Uint8Array(typedArray)),(typedArray instanceof Int8Array||"undefined"!=typeof Uint8ClampedArray&&typedArray instanceof Uint8ClampedArray||typedArray instanceof Int16Array||typedArray instanceof Uint16Array||typedArray instanceof Int32Array||typedArray instanceof Uint32Array||typedArray instanceof Float32Array||typedArray instanceof Float64Array)&&(typedArray=new Uint8Array(typedArray.buffer,typedArray.byteOffset,typedArray.byteLength)),typedArray instanceof Uint8Array){for(var typedArrayByteLength=typedArray.byteLength,words=[],i=0;i<typedArrayByteLength;i++)words[i>>>2]|=typedArray[i]<<24-i%4*8;superInit.call(this,words,typedArrayByteLength)}else superInit.apply(this,arguments)}).prototype=WordArray}}(),CryptoJS.lib.WordArray}(__webpack_require__(2))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return function(){var C=CryptoJS,WordArray=C.lib.WordArray,C_enc=C.enc;function swapEndian(word){return word<<8&4278255360|word>>>8&16711935}C_enc.Utf16=C_enc.Utf16BE={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,utf16Chars=[],i=0;i<sigBytes;i+=2){var codePoint=words[i>>>2]>>>16-i%4*8&65535;utf16Chars.push(String.fromCharCode(codePoint))}return utf16Chars.join("")},parse:function(utf16Str){for(var utf16StrLength=utf16Str.length,words=[],i=0;i<utf16StrLength;i++)words[i>>>1]|=utf16Str.charCodeAt(i)<<16-i%2*16;return WordArray.create(words,2*utf16StrLength)}},C_enc.Utf16LE={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,utf16Chars=[],i=0;i<sigBytes;i+=2){var codePoint=swapEndian(words[i>>>2]>>>16-i%4*8&65535);utf16Chars.push(String.fromCharCode(codePoint))}return utf16Chars.join("")},parse:function(utf16Str){for(var utf16StrLength=utf16Str.length,words=[],i=0;i<utf16StrLength;i++)words[i>>>1]|=swapEndian(utf16Str.charCodeAt(i)<<16-i%2*16);return WordArray.create(words,2*utf16StrLength)}}}(),CryptoJS.enc.Utf16}(__webpack_require__(2))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return function(){var C=CryptoJS,WordArray=C.lib.WordArray,C_algo=C.algo,SHA256=C_algo.SHA256,SHA224=C_algo.SHA224=SHA256.extend({_doReset:function(){this._hash=new WordArray.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])},_doFinalize:function(){var hash=SHA256._doFinalize.call(this);return hash.sigBytes-=4,hash}});C.SHA224=SHA256._createHelper(SHA224),C.HmacSHA224=SHA256._createHmacHelper(SHA224)}(),CryptoJS.SHA224}(__webpack_require__(2),__webpack_require__(83))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return C_x64=(C=CryptoJS).x64,X64Word=C_x64.Word,X64WordArray=C_x64.WordArray,C_algo=C.algo,SHA512=C_algo.SHA512,SHA384=C_algo.SHA384=SHA512.extend({_doReset:function(){this._hash=new X64WordArray.init([new X64Word.init(3418070365,3238371032),new X64Word.init(1654270250,914150663),new X64Word.init(2438529370,812702999),new X64Word.init(355462360,4144912697),new X64Word.init(1731405415,4290775857),new X64Word.init(2394180231,1750603025),new X64Word.init(3675008525,1694076839),new X64Word.init(1203062813,3204075428)])},_doFinalize:function(){var hash=SHA512._doFinalize.call(this);return hash.sigBytes-=16,hash}}),C.SHA384=SHA512._createHelper(SHA384),C.HmacSHA384=SHA512._createHmacHelper(SHA384),CryptoJS.SHA384;var C,C_x64,X64Word,X64WordArray,C_algo,SHA512,SHA384}(__webpack_require__(2),__webpack_require__(33),__webpack_require__(84))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return function(Math){var C=CryptoJS,C_lib=C.lib,WordArray=C_lib.WordArray,Hasher=C_lib.Hasher,X64Word=C.x64.Word,C_algo=C.algo,RHO_OFFSETS=[],PI_INDEXES=[],ROUND_CONSTANTS=[];!function(){for(var x=1,y=0,t=0;t<24;t++){RHO_OFFSETS[x+5*y]=(t+1)*(t+2)/2%64;var newY=(2*x+3*y)%5;x=y%5,y=newY}for(x=0;x<5;x++)for(y=0;y<5;y++)PI_INDEXES[x+5*y]=y+(2*x+3*y)%5*5;for(var LFSR=1,i=0;i<24;i++){for(var roundConstantMsw=0,roundConstantLsw=0,j=0;j<7;j++){if(1&LFSR){var bitPosition=(1<<j)-1;bitPosition<32?roundConstantLsw^=1<<bitPosition:roundConstantMsw^=1<<bitPosition-32}128&LFSR?LFSR=LFSR<<1^113:LFSR<<=1}ROUND_CONSTANTS[i]=X64Word.create(roundConstantMsw,roundConstantLsw)}}();var T=[];!function(){for(var i=0;i<25;i++)T[i]=X64Word.create()}();var SHA3=C_algo.SHA3=Hasher.extend({cfg:Hasher.cfg.extend({outputLength:512}),_doReset:function(){for(var state=this._state=[],i=0;i<25;i++)state[i]=new X64Word.init;this.blockSize=(1600-2*this.cfg.outputLength)/32},_doProcessBlock:function(M,offset){for(var state=this._state,nBlockSizeLanes=this.blockSize/2,i=0;i<nBlockSizeLanes;i++){var M2i=M[offset+2*i],M2i1=M[offset+2*i+1];M2i=16711935&(M2i<<8|M2i>>>24)|4278255360&(M2i<<24|M2i>>>8),M2i1=16711935&(M2i1<<8|M2i1>>>24)|4278255360&(M2i1<<24|M2i1>>>8),(lane=state[i]).high^=M2i1,lane.low^=M2i}for(var round=0;round<24;round++){for(var x=0;x<5;x++){for(var tMsw=0,tLsw=0,y=0;y<5;y++)tMsw^=(lane=state[x+5*y]).high,tLsw^=lane.low;var Tx=T[x];Tx.high=tMsw,Tx.low=tLsw}for(x=0;x<5;x++){var Tx4=T[(x+4)%5],Tx1=T[(x+1)%5],Tx1Msw=Tx1.high,Tx1Lsw=Tx1.low;for(tMsw=Tx4.high^(Tx1Msw<<1|Tx1Lsw>>>31),tLsw=Tx4.low^(Tx1Lsw<<1|Tx1Msw>>>31),y=0;y<5;y++)(lane=state[x+5*y]).high^=tMsw,lane.low^=tLsw}for(var laneIndex=1;laneIndex<25;laneIndex++){var laneMsw=(lane=state[laneIndex]).high,laneLsw=lane.low,rhoOffset=RHO_OFFSETS[laneIndex];rhoOffset<32?(tMsw=laneMsw<<rhoOffset|laneLsw>>>32-rhoOffset,tLsw=laneLsw<<rhoOffset|laneMsw>>>32-rhoOffset):(tMsw=laneLsw<<rhoOffset-32|laneMsw>>>64-rhoOffset,tLsw=laneMsw<<rhoOffset-32|laneLsw>>>64-rhoOffset);var TPiLane=T[PI_INDEXES[laneIndex]];TPiLane.high=tMsw,TPiLane.low=tLsw}var T0=T[0],state0=state[0];for(T0.high=state0.high,T0.low=state0.low,x=0;x<5;x++)for(y=0;y<5;y++){var lane=state[laneIndex=x+5*y],TLane=T[laneIndex],Tx1Lane=T[(x+1)%5+5*y],Tx2Lane=T[(x+2)%5+5*y];lane.high=TLane.high^~Tx1Lane.high&Tx2Lane.high,lane.low=TLane.low^~Tx1Lane.low&Tx2Lane.low}lane=state[0];var roundConstant=ROUND_CONSTANTS[round];lane.high^=roundConstant.high,lane.low^=roundConstant.low}},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsLeft=(this._nDataBytes,8*data.sigBytes),blockSizeBits=32*this.blockSize;dataWords[nBitsLeft>>>5]|=1<<24-nBitsLeft%32,dataWords[(Math.ceil((nBitsLeft+1)/blockSizeBits)*blockSizeBits>>>5)-1]|=128,data.sigBytes=4*dataWords.length,this._process();for(var state=this._state,outputLengthBytes=this.cfg.outputLength/8,outputLengthLanes=outputLengthBytes/8,hashWords=[],i=0;i<outputLengthLanes;i++){var lane=state[i],laneMsw=lane.high,laneLsw=lane.low;laneMsw=16711935&(laneMsw<<8|laneMsw>>>24)|4278255360&(laneMsw<<24|laneMsw>>>8),laneLsw=16711935&(laneLsw<<8|laneLsw>>>24)|4278255360&(laneLsw<<24|laneLsw>>>8),hashWords.push(laneLsw),hashWords.push(laneMsw)}return new WordArray.init(hashWords,outputLengthBytes)},clone:function(){for(var clone=Hasher.clone.call(this),state=clone._state=this._state.slice(0),i=0;i<25;i++)state[i]=state[i].clone();return clone}});C.SHA3=Hasher._createHelper(SHA3),C.HmacSHA3=Hasher._createHmacHelper(SHA3)}(Math),CryptoJS.SHA3}(__webpack_require__(2),__webpack_require__(33))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){
/** @preserve
	(c) 2012 by Cdric Mesnil. All rights reserved.

	Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

	    - Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
	    - Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.

	THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
	*/
return function(Math){var C=CryptoJS,C_lib=C.lib,WordArray=C_lib.WordArray,Hasher=C_lib.Hasher,C_algo=C.algo,_zl=WordArray.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),_zr=WordArray.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),_sl=WordArray.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),_sr=WordArray.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),_hl=WordArray.create([0,1518500249,1859775393,2400959708,2840853838]),_hr=WordArray.create([1352829926,1548603684,1836072691,2053994217,0]),RIPEMD160=C_algo.RIPEMD160=Hasher.extend({_doReset:function(){this._hash=WordArray.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(M,offset){for(var i=0;i<16;i++){var offset_i=offset+i,M_offset_i=M[offset_i];M[offset_i]=16711935&(M_offset_i<<8|M_offset_i>>>24)|4278255360&(M_offset_i<<24|M_offset_i>>>8)}var al,bl,cl,dl,el,ar,br,cr,dr,er,t,H=this._hash.words,hl=_hl.words,hr=_hr.words,zl=_zl.words,zr=_zr.words,sl=_sl.words,sr=_sr.words;for(ar=al=H[0],br=bl=H[1],cr=cl=H[2],dr=dl=H[3],er=el=H[4],i=0;i<80;i+=1)t=al+M[offset+zl[i]]|0,t+=i<16?f1(bl,cl,dl)+hl[0]:i<32?f2(bl,cl,dl)+hl[1]:i<48?f3(bl,cl,dl)+hl[2]:i<64?f4(bl,cl,dl)+hl[3]:f5(bl,cl,dl)+hl[4],t=(t=rotl(t|=0,sl[i]))+el|0,al=el,el=dl,dl=rotl(cl,10),cl=bl,bl=t,t=ar+M[offset+zr[i]]|0,t+=i<16?f5(br,cr,dr)+hr[0]:i<32?f4(br,cr,dr)+hr[1]:i<48?f3(br,cr,dr)+hr[2]:i<64?f2(br,cr,dr)+hr[3]:f1(br,cr,dr)+hr[4],t=(t=rotl(t|=0,sr[i]))+er|0,ar=er,er=dr,dr=rotl(cr,10),cr=br,br=t;t=H[1]+cl+dr|0,H[1]=H[2]+dl+er|0,H[2]=H[3]+el+ar|0,H[3]=H[4]+al+br|0,H[4]=H[0]+bl+cr|0,H[0]=t},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsTotal=8*this._nDataBytes,nBitsLeft=8*data.sigBytes;dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32,dataWords[14+(nBitsLeft+64>>>9<<4)]=16711935&(nBitsTotal<<8|nBitsTotal>>>24)|4278255360&(nBitsTotal<<24|nBitsTotal>>>8),data.sigBytes=4*(dataWords.length+1),this._process();for(var hash=this._hash,H=hash.words,i=0;i<5;i++){var H_i=H[i];H[i]=16711935&(H_i<<8|H_i>>>24)|4278255360&(H_i<<24|H_i>>>8)}return hash},clone:function(){var clone=Hasher.clone.call(this);return clone._hash=this._hash.clone(),clone}});function f1(x,y,z){return x^y^z}function f2(x,y,z){return x&y|~x&z}function f3(x,y,z){return(x|~y)^z}function f4(x,y,z){return x&z|y&~z}function f5(x,y,z){return x^(y|~z)}function rotl(x,n){return x<<n|x>>>32-n}C.RIPEMD160=Hasher._createHelper(RIPEMD160),C.HmacRIPEMD160=Hasher._createHmacHelper(RIPEMD160)}(Math),CryptoJS.RIPEMD160}(__webpack_require__(2))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return C_lib=(C=CryptoJS).lib,Base=C_lib.Base,WordArray=C_lib.WordArray,C_algo=C.algo,SHA1=C_algo.SHA1,HMAC=C_algo.HMAC,PBKDF2=C_algo.PBKDF2=Base.extend({cfg:Base.extend({keySize:4,hasher:SHA1,iterations:1}),init:function(cfg){this.cfg=this.cfg.extend(cfg)},compute:function(password,salt){for(var cfg=this.cfg,hmac=HMAC.create(cfg.hasher,password),derivedKey=WordArray.create(),blockIndex=WordArray.create([1]),derivedKeyWords=derivedKey.words,blockIndexWords=blockIndex.words,keySize=cfg.keySize,iterations=cfg.iterations;derivedKeyWords.length<keySize;){var block=hmac.update(salt).finalize(blockIndex);hmac.reset();for(var blockWords=block.words,blockWordsLength=blockWords.length,intermediate=block,i=1;i<iterations;i++){intermediate=hmac.finalize(intermediate),hmac.reset();for(var intermediateWords=intermediate.words,j=0;j<blockWordsLength;j++)blockWords[j]^=intermediateWords[j]}derivedKey.concat(block),blockIndexWords[0]++}return derivedKey.sigBytes=4*keySize,derivedKey}}),C.PBKDF2=function(password,salt,cfg){return PBKDF2.create(cfg).compute(password,salt)},CryptoJS.PBKDF2;var C,C_lib,Base,WordArray,C_algo,SHA1,HMAC,PBKDF2}(__webpack_require__(2),__webpack_require__(46),__webpack_require__(47))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return CryptoJS.mode.CFB=function(){var CFB=CryptoJS.lib.BlockCipherMode.extend();function generateKeystreamAndEncrypt(words,offset,blockSize,cipher){var keystream,iv=this._iv;iv?(keystream=iv.slice(0),this._iv=void 0):keystream=this._prevBlock,cipher.encryptBlock(keystream,0);for(var i=0;i<blockSize;i++)words[offset+i]^=keystream[i]}return CFB.Encryptor=CFB.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize;generateKeystreamAndEncrypt.call(this,words,offset,blockSize,cipher),this._prevBlock=words.slice(offset,offset+blockSize)}}),CFB.Decryptor=CFB.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize,thisBlock=words.slice(offset,offset+blockSize);generateKeystreamAndEncrypt.call(this,words,offset,blockSize,cipher),this._prevBlock=thisBlock}}),CFB}(),CryptoJS.mode.CFB}(__webpack_require__(2),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return CryptoJS.mode.CTR=(CTR=CryptoJS.lib.BlockCipherMode.extend(),Encryptor=CTR.Encryptor=CTR.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize,iv=this._iv,counter=this._counter;iv&&(counter=this._counter=iv.slice(0),this._iv=void 0);var keystream=counter.slice(0);cipher.encryptBlock(keystream,0),counter[blockSize-1]=counter[blockSize-1]+1|0;for(var i=0;i<blockSize;i++)words[offset+i]^=keystream[i]}}),CTR.Decryptor=Encryptor,CTR),CryptoJS.mode.CTR;var CTR,Encryptor}(__webpack_require__(2),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){
/** @preserve
	 * Counter block mode compatible with  Dr Brian Gladman fileenc.c
	 * derived from CryptoJS.mode.CTR
	 * Jan Hruby jhruby.web@gmail.com
	 */
return CryptoJS.mode.CTRGladman=function(){var CTRGladman=CryptoJS.lib.BlockCipherMode.extend();function incWord(word){if(255==(word>>24&255)){var b1=word>>16&255,b2=word>>8&255,b3=255&word;255===b1?(b1=0,255===b2?(b2=0,255===b3?b3=0:++b3):++b2):++b1,word=0,word+=b1<<16,word+=b2<<8,word+=b3}else word+=1<<24;return word}var Encryptor=CTRGladman.Encryptor=CTRGladman.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize,iv=this._iv,counter=this._counter;iv&&(counter=this._counter=iv.slice(0),this._iv=void 0),function(counter){0===(counter[0]=incWord(counter[0]))&&(counter[1]=incWord(counter[1]))}(counter);var keystream=counter.slice(0);cipher.encryptBlock(keystream,0);for(var i=0;i<blockSize;i++)words[offset+i]^=keystream[i]}});return CTRGladman.Decryptor=Encryptor,CTRGladman}(),CryptoJS.mode.CTRGladman}(__webpack_require__(2),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return CryptoJS.mode.OFB=(OFB=CryptoJS.lib.BlockCipherMode.extend(),Encryptor=OFB.Encryptor=OFB.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize,iv=this._iv,keystream=this._keystream;iv&&(keystream=this._keystream=iv.slice(0),this._iv=void 0),cipher.encryptBlock(keystream,0);for(var i=0;i<blockSize;i++)words[offset+i]^=keystream[i]}}),OFB.Decryptor=Encryptor,OFB),CryptoJS.mode.OFB;var OFB,Encryptor}(__webpack_require__(2),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return CryptoJS.mode.ECB=((ECB=CryptoJS.lib.BlockCipherMode.extend()).Encryptor=ECB.extend({processBlock:function(words,offset){this._cipher.encryptBlock(words,offset)}}),ECB.Decryptor=ECB.extend({processBlock:function(words,offset){this._cipher.decryptBlock(words,offset)}}),ECB),CryptoJS.mode.ECB;var ECB}(__webpack_require__(2),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return CryptoJS.pad.AnsiX923={pad:function(data,blockSize){var dataSigBytes=data.sigBytes,blockSizeBytes=4*blockSize,nPaddingBytes=blockSizeBytes-dataSigBytes%blockSizeBytes,lastBytePos=dataSigBytes+nPaddingBytes-1;data.clamp(),data.words[lastBytePos>>>2]|=nPaddingBytes<<24-lastBytePos%4*8,data.sigBytes+=nPaddingBytes},unpad:function(data){var nPaddingBytes=255&data.words[data.sigBytes-1>>>2];data.sigBytes-=nPaddingBytes}},CryptoJS.pad.Ansix923}(__webpack_require__(2),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return CryptoJS.pad.Iso10126={pad:function(data,blockSize){var blockSizeBytes=4*blockSize,nPaddingBytes=blockSizeBytes-data.sigBytes%blockSizeBytes;data.concat(CryptoJS.lib.WordArray.random(nPaddingBytes-1)).concat(CryptoJS.lib.WordArray.create([nPaddingBytes<<24],1))},unpad:function(data){var nPaddingBytes=255&data.words[data.sigBytes-1>>>2];data.sigBytes-=nPaddingBytes}},CryptoJS.pad.Iso10126}(__webpack_require__(2),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return CryptoJS.pad.Iso97971={pad:function(data,blockSize){data.concat(CryptoJS.lib.WordArray.create([2147483648],1)),CryptoJS.pad.ZeroPadding.pad(data,blockSize)},unpad:function(data){CryptoJS.pad.ZeroPadding.unpad(data),data.sigBytes--}},CryptoJS.pad.Iso97971}(__webpack_require__(2),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return CryptoJS.pad.ZeroPadding={pad:function(data,blockSize){var blockSizeBytes=4*blockSize;data.clamp(),data.sigBytes+=blockSizeBytes-(data.sigBytes%blockSizeBytes||blockSizeBytes)},unpad:function(data){var dataWords=data.words,i=data.sigBytes-1;for(i=data.sigBytes-1;i>=0;i--)if(dataWords[i>>>2]>>>24-i%4*8&255){data.sigBytes=i+1;break}}},CryptoJS.pad.ZeroPadding}(__webpack_require__(2),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return CryptoJS.pad.NoPadding={pad:function(){},unpad:function(){}},CryptoJS.pad.NoPadding}(__webpack_require__(2),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return CipherParams=(C=CryptoJS).lib.CipherParams,Hex=C.enc.Hex,C.format.Hex={stringify:function(cipherParams){return cipherParams.ciphertext.toString(Hex)},parse:function(input){var ciphertext=Hex.parse(input);return CipherParams.create({ciphertext:ciphertext})}},CryptoJS.format.Hex;var C,CipherParams,Hex}(__webpack_require__(2),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return function(){var C=CryptoJS,BlockCipher=C.lib.BlockCipher,C_algo=C.algo,SBOX=[],INV_SBOX=[],SUB_MIX_0=[],SUB_MIX_1=[],SUB_MIX_2=[],SUB_MIX_3=[],INV_SUB_MIX_0=[],INV_SUB_MIX_1=[],INV_SUB_MIX_2=[],INV_SUB_MIX_3=[];!function(){for(var d=[],i=0;i<256;i++)d[i]=i<128?i<<1:i<<1^283;var x=0,xi=0;for(i=0;i<256;i++){var sx=xi^xi<<1^xi<<2^xi<<3^xi<<4;sx=sx>>>8^255&sx^99,SBOX[x]=sx,INV_SBOX[sx]=x;var x2=d[x],x4=d[x2],x8=d[x4],t=257*d[sx]^16843008*sx;SUB_MIX_0[x]=t<<24|t>>>8,SUB_MIX_1[x]=t<<16|t>>>16,SUB_MIX_2[x]=t<<8|t>>>24,SUB_MIX_3[x]=t,t=16843009*x8^65537*x4^257*x2^16843008*x,INV_SUB_MIX_0[sx]=t<<24|t>>>8,INV_SUB_MIX_1[sx]=t<<16|t>>>16,INV_SUB_MIX_2[sx]=t<<8|t>>>24,INV_SUB_MIX_3[sx]=t,x?(x=x2^d[d[d[x8^x2]]],xi^=d[d[xi]]):x=xi=1}}();var RCON=[0,1,2,4,8,16,32,64,128,27,54],AES=C_algo.AES=BlockCipher.extend({_doReset:function(){if(!this._nRounds||this._keyPriorReset!==this._key){for(var key=this._keyPriorReset=this._key,keyWords=key.words,keySize=key.sigBytes/4,ksRows=4*((this._nRounds=keySize+6)+1),keySchedule=this._keySchedule=[],ksRow=0;ksRow<ksRows;ksRow++)ksRow<keySize?keySchedule[ksRow]=keyWords[ksRow]:(t=keySchedule[ksRow-1],ksRow%keySize?keySize>6&&ksRow%keySize==4&&(t=SBOX[t>>>24]<<24|SBOX[t>>>16&255]<<16|SBOX[t>>>8&255]<<8|SBOX[255&t]):(t=SBOX[(t=t<<8|t>>>24)>>>24]<<24|SBOX[t>>>16&255]<<16|SBOX[t>>>8&255]<<8|SBOX[255&t],t^=RCON[ksRow/keySize|0]<<24),keySchedule[ksRow]=keySchedule[ksRow-keySize]^t);for(var invKeySchedule=this._invKeySchedule=[],invKsRow=0;invKsRow<ksRows;invKsRow++){if(ksRow=ksRows-invKsRow,invKsRow%4)var t=keySchedule[ksRow];else t=keySchedule[ksRow-4];invKeySchedule[invKsRow]=invKsRow<4||ksRow<=4?t:INV_SUB_MIX_0[SBOX[t>>>24]]^INV_SUB_MIX_1[SBOX[t>>>16&255]]^INV_SUB_MIX_2[SBOX[t>>>8&255]]^INV_SUB_MIX_3[SBOX[255&t]]}}},encryptBlock:function(M,offset){this._doCryptBlock(M,offset,this._keySchedule,SUB_MIX_0,SUB_MIX_1,SUB_MIX_2,SUB_MIX_3,SBOX)},decryptBlock:function(M,offset){var t=M[offset+1];M[offset+1]=M[offset+3],M[offset+3]=t,this._doCryptBlock(M,offset,this._invKeySchedule,INV_SUB_MIX_0,INV_SUB_MIX_1,INV_SUB_MIX_2,INV_SUB_MIX_3,INV_SBOX),t=M[offset+1],M[offset+1]=M[offset+3],M[offset+3]=t},_doCryptBlock:function(M,offset,keySchedule,SUB_MIX_0,SUB_MIX_1,SUB_MIX_2,SUB_MIX_3,SBOX){for(var nRounds=this._nRounds,s0=M[offset]^keySchedule[0],s1=M[offset+1]^keySchedule[1],s2=M[offset+2]^keySchedule[2],s3=M[offset+3]^keySchedule[3],ksRow=4,round=1;round<nRounds;round++){var t0=SUB_MIX_0[s0>>>24]^SUB_MIX_1[s1>>>16&255]^SUB_MIX_2[s2>>>8&255]^SUB_MIX_3[255&s3]^keySchedule[ksRow++],t1=SUB_MIX_0[s1>>>24]^SUB_MIX_1[s2>>>16&255]^SUB_MIX_2[s3>>>8&255]^SUB_MIX_3[255&s0]^keySchedule[ksRow++],t2=SUB_MIX_0[s2>>>24]^SUB_MIX_1[s3>>>16&255]^SUB_MIX_2[s0>>>8&255]^SUB_MIX_3[255&s1]^keySchedule[ksRow++],t3=SUB_MIX_0[s3>>>24]^SUB_MIX_1[s0>>>16&255]^SUB_MIX_2[s1>>>8&255]^SUB_MIX_3[255&s2]^keySchedule[ksRow++];s0=t0,s1=t1,s2=t2,s3=t3}t0=(SBOX[s0>>>24]<<24|SBOX[s1>>>16&255]<<16|SBOX[s2>>>8&255]<<8|SBOX[255&s3])^keySchedule[ksRow++],t1=(SBOX[s1>>>24]<<24|SBOX[s2>>>16&255]<<16|SBOX[s3>>>8&255]<<8|SBOX[255&s0])^keySchedule[ksRow++],t2=(SBOX[s2>>>24]<<24|SBOX[s3>>>16&255]<<16|SBOX[s0>>>8&255]<<8|SBOX[255&s1])^keySchedule[ksRow++],t3=(SBOX[s3>>>24]<<24|SBOX[s0>>>16&255]<<16|SBOX[s1>>>8&255]<<8|SBOX[255&s2])^keySchedule[ksRow++],M[offset]=t0,M[offset+1]=t1,M[offset+2]=t2,M[offset+3]=t3},keySize:8});C.AES=BlockCipher._createHelper(AES)}(),CryptoJS.AES}(__webpack_require__(2),__webpack_require__(18),__webpack_require__(19),__webpack_require__(15),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return function(){var C=CryptoJS,C_lib=C.lib,WordArray=C_lib.WordArray,BlockCipher=C_lib.BlockCipher,C_algo=C.algo,PC1=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],PC2=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],BIT_SHIFTS=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],SBOX_P=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],SBOX_MASK=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],DES=C_algo.DES=BlockCipher.extend({_doReset:function(){for(var keyWords=this._key.words,keyBits=[],i=0;i<56;i++){var keyBitPos=PC1[i]-1;keyBits[i]=keyWords[keyBitPos>>>5]>>>31-keyBitPos%32&1}for(var subKeys=this._subKeys=[],nSubKey=0;nSubKey<16;nSubKey++){var subKey=subKeys[nSubKey]=[],bitShift=BIT_SHIFTS[nSubKey];for(i=0;i<24;i++)subKey[i/6|0]|=keyBits[(PC2[i]-1+bitShift)%28]<<31-i%6,subKey[4+(i/6|0)]|=keyBits[28+(PC2[i+24]-1+bitShift)%28]<<31-i%6;for(subKey[0]=subKey[0]<<1|subKey[0]>>>31,i=1;i<7;i++)subKey[i]=subKey[i]>>>4*(i-1)+3;subKey[7]=subKey[7]<<5|subKey[7]>>>27}var invSubKeys=this._invSubKeys=[];for(i=0;i<16;i++)invSubKeys[i]=subKeys[15-i]},encryptBlock:function(M,offset){this._doCryptBlock(M,offset,this._subKeys)},decryptBlock:function(M,offset){this._doCryptBlock(M,offset,this._invSubKeys)},_doCryptBlock:function(M,offset,subKeys){this._lBlock=M[offset],this._rBlock=M[offset+1],exchangeLR.call(this,4,252645135),exchangeLR.call(this,16,65535),exchangeRL.call(this,2,858993459),exchangeRL.call(this,8,16711935),exchangeLR.call(this,1,1431655765);for(var round=0;round<16;round++){for(var subKey=subKeys[round],lBlock=this._lBlock,rBlock=this._rBlock,f=0,i=0;i<8;i++)f|=SBOX_P[i][((rBlock^subKey[i])&SBOX_MASK[i])>>>0];this._lBlock=rBlock,this._rBlock=lBlock^f}var t=this._lBlock;this._lBlock=this._rBlock,this._rBlock=t,exchangeLR.call(this,1,1431655765),exchangeRL.call(this,8,16711935),exchangeRL.call(this,2,858993459),exchangeLR.call(this,16,65535),exchangeLR.call(this,4,252645135),M[offset]=this._lBlock,M[offset+1]=this._rBlock},keySize:2,ivSize:2,blockSize:2});function exchangeLR(offset,mask){var t=(this._lBlock>>>offset^this._rBlock)&mask;this._rBlock^=t,this._lBlock^=t<<offset}function exchangeRL(offset,mask){var t=(this._rBlock>>>offset^this._lBlock)&mask;this._lBlock^=t,this._rBlock^=t<<offset}C.DES=BlockCipher._createHelper(DES);var TripleDES=C_algo.TripleDES=BlockCipher.extend({_doReset:function(){var keyWords=this._key.words;if(2!==keyWords.length&&4!==keyWords.length&&keyWords.length<6)throw new Error("Invalid key length - 3DES requires the key length to be 64, 128, 192 or >192.");var key1=keyWords.slice(0,2),key2=keyWords.length<4?keyWords.slice(0,2):keyWords.slice(2,4),key3=keyWords.length<6?keyWords.slice(0,2):keyWords.slice(4,6);this._des1=DES.createEncryptor(WordArray.create(key1)),this._des2=DES.createEncryptor(WordArray.create(key2)),this._des3=DES.createEncryptor(WordArray.create(key3))},encryptBlock:function(M,offset){this._des1.encryptBlock(M,offset),this._des2.decryptBlock(M,offset),this._des3.encryptBlock(M,offset)},decryptBlock:function(M,offset){this._des3.decryptBlock(M,offset),this._des2.encryptBlock(M,offset),this._des1.decryptBlock(M,offset)},keySize:6,ivSize:2,blockSize:2});C.TripleDES=BlockCipher._createHelper(TripleDES)}(),CryptoJS.TripleDES}(__webpack_require__(2),__webpack_require__(18),__webpack_require__(19),__webpack_require__(15),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return function(){var C=CryptoJS,StreamCipher=C.lib.StreamCipher,C_algo=C.algo,RC4=C_algo.RC4=StreamCipher.extend({_doReset:function(){for(var key=this._key,keyWords=key.words,keySigBytes=key.sigBytes,S=this._S=[],i=0;i<256;i++)S[i]=i;i=0;for(var j=0;i<256;i++){var keyByteIndex=i%keySigBytes,keyByte=keyWords[keyByteIndex>>>2]>>>24-keyByteIndex%4*8&255;j=(j+S[i]+keyByte)%256;var t=S[i];S[i]=S[j],S[j]=t}this._i=this._j=0},_doProcessBlock:function(M,offset){M[offset]^=generateKeystreamWord.call(this)},keySize:8,ivSize:0});function generateKeystreamWord(){for(var S=this._S,i=this._i,j=this._j,keystreamWord=0,n=0;n<4;n++){j=(j+S[i=(i+1)%256])%256;var t=S[i];S[i]=S[j],S[j]=t,keystreamWord|=S[(S[i]+S[j])%256]<<24-8*n}return this._i=i,this._j=j,keystreamWord}C.RC4=StreamCipher._createHelper(RC4);var RC4Drop=C_algo.RC4Drop=RC4.extend({cfg:RC4.cfg.extend({drop:192}),_doReset:function(){RC4._doReset.call(this);for(var i=this.cfg.drop;i>0;i--)generateKeystreamWord.call(this)}});C.RC4Drop=StreamCipher._createHelper(RC4Drop)}(),CryptoJS.RC4}(__webpack_require__(2),__webpack_require__(18),__webpack_require__(19),__webpack_require__(15),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return function(){var C=CryptoJS,StreamCipher=C.lib.StreamCipher,C_algo=C.algo,S=[],C_=[],G=[],Rabbit=C_algo.Rabbit=StreamCipher.extend({_doReset:function(){for(var K=this._key.words,iv=this.cfg.iv,i=0;i<4;i++)K[i]=16711935&(K[i]<<8|K[i]>>>24)|4278255360&(K[i]<<24|K[i]>>>8);var X=this._X=[K[0],K[3]<<16|K[2]>>>16,K[1],K[0]<<16|K[3]>>>16,K[2],K[1]<<16|K[0]>>>16,K[3],K[2]<<16|K[1]>>>16],C=this._C=[K[2]<<16|K[2]>>>16,4294901760&K[0]|65535&K[1],K[3]<<16|K[3]>>>16,4294901760&K[1]|65535&K[2],K[0]<<16|K[0]>>>16,4294901760&K[2]|65535&K[3],K[1]<<16|K[1]>>>16,4294901760&K[3]|65535&K[0]];for(this._b=0,i=0;i<4;i++)nextState.call(this);for(i=0;i<8;i++)C[i]^=X[i+4&7];if(iv){var IV=iv.words,IV_0=IV[0],IV_1=IV[1],i0=16711935&(IV_0<<8|IV_0>>>24)|4278255360&(IV_0<<24|IV_0>>>8),i2=16711935&(IV_1<<8|IV_1>>>24)|4278255360&(IV_1<<24|IV_1>>>8),i1=i0>>>16|4294901760&i2,i3=i2<<16|65535&i0;for(C[0]^=i0,C[1]^=i1,C[2]^=i2,C[3]^=i3,C[4]^=i0,C[5]^=i1,C[6]^=i2,C[7]^=i3,i=0;i<4;i++)nextState.call(this)}},_doProcessBlock:function(M,offset){var X=this._X;nextState.call(this),S[0]=X[0]^X[5]>>>16^X[3]<<16,S[1]=X[2]^X[7]>>>16^X[5]<<16,S[2]=X[4]^X[1]>>>16^X[7]<<16,S[3]=X[6]^X[3]>>>16^X[1]<<16;for(var i=0;i<4;i++)S[i]=16711935&(S[i]<<8|S[i]>>>24)|4278255360&(S[i]<<24|S[i]>>>8),M[offset+i]^=S[i]},blockSize:4,ivSize:2});function nextState(){for(var X=this._X,C=this._C,i=0;i<8;i++)C_[i]=C[i];for(C[0]=C[0]+1295307597+this._b|0,C[1]=C[1]+3545052371+(C[0]>>>0<C_[0]>>>0?1:0)|0,C[2]=C[2]+886263092+(C[1]>>>0<C_[1]>>>0?1:0)|0,C[3]=C[3]+1295307597+(C[2]>>>0<C_[2]>>>0?1:0)|0,C[4]=C[4]+3545052371+(C[3]>>>0<C_[3]>>>0?1:0)|0,C[5]=C[5]+886263092+(C[4]>>>0<C_[4]>>>0?1:0)|0,C[6]=C[6]+1295307597+(C[5]>>>0<C_[5]>>>0?1:0)|0,C[7]=C[7]+3545052371+(C[6]>>>0<C_[6]>>>0?1:0)|0,this._b=C[7]>>>0<C_[7]>>>0?1:0,i=0;i<8;i++){var gx=X[i]+C[i],ga=65535&gx,gb=gx>>>16,gh=((ga*ga>>>17)+ga*gb>>>15)+gb*gb,gl=((4294901760&gx)*gx|0)+((65535&gx)*gx|0);G[i]=gh^gl}X[0]=G[0]+(G[7]<<16|G[7]>>>16)+(G[6]<<16|G[6]>>>16)|0,X[1]=G[1]+(G[0]<<8|G[0]>>>24)+G[7]|0,X[2]=G[2]+(G[1]<<16|G[1]>>>16)+(G[0]<<16|G[0]>>>16)|0,X[3]=G[3]+(G[2]<<8|G[2]>>>24)+G[1]|0,X[4]=G[4]+(G[3]<<16|G[3]>>>16)+(G[2]<<16|G[2]>>>16)|0,X[5]=G[5]+(G[4]<<8|G[4]>>>24)+G[3]|0,X[6]=G[6]+(G[5]<<16|G[5]>>>16)+(G[4]<<16|G[4]>>>16)|0,X[7]=G[7]+(G[6]<<8|G[6]>>>24)+G[5]|0}C.Rabbit=StreamCipher._createHelper(Rabbit)}(),CryptoJS.Rabbit}(__webpack_require__(2),__webpack_require__(18),__webpack_require__(19),__webpack_require__(15),__webpack_require__(7))},function(module,exports,__webpack_require__){module.exports=function(CryptoJS){return function(){var C=CryptoJS,StreamCipher=C.lib.StreamCipher,C_algo=C.algo,S=[],C_=[],G=[],RabbitLegacy=C_algo.RabbitLegacy=StreamCipher.extend({_doReset:function(){var K=this._key.words,iv=this.cfg.iv,X=this._X=[K[0],K[3]<<16|K[2]>>>16,K[1],K[0]<<16|K[3]>>>16,K[2],K[1]<<16|K[0]>>>16,K[3],K[2]<<16|K[1]>>>16],C=this._C=[K[2]<<16|K[2]>>>16,4294901760&K[0]|65535&K[1],K[3]<<16|K[3]>>>16,4294901760&K[1]|65535&K[2],K[0]<<16|K[0]>>>16,4294901760&K[2]|65535&K[3],K[1]<<16|K[1]>>>16,4294901760&K[3]|65535&K[0]];this._b=0;for(var i=0;i<4;i++)nextState.call(this);for(i=0;i<8;i++)C[i]^=X[i+4&7];if(iv){var IV=iv.words,IV_0=IV[0],IV_1=IV[1],i0=16711935&(IV_0<<8|IV_0>>>24)|4278255360&(IV_0<<24|IV_0>>>8),i2=16711935&(IV_1<<8|IV_1>>>24)|4278255360&(IV_1<<24|IV_1>>>8),i1=i0>>>16|4294901760&i2,i3=i2<<16|65535&i0;for(C[0]^=i0,C[1]^=i1,C[2]^=i2,C[3]^=i3,C[4]^=i0,C[5]^=i1,C[6]^=i2,C[7]^=i3,i=0;i<4;i++)nextState.call(this)}},_doProcessBlock:function(M,offset){var X=this._X;nextState.call(this),S[0]=X[0]^X[5]>>>16^X[3]<<16,S[1]=X[2]^X[7]>>>16^X[5]<<16,S[2]=X[4]^X[1]>>>16^X[7]<<16,S[3]=X[6]^X[3]>>>16^X[1]<<16;for(var i=0;i<4;i++)S[i]=16711935&(S[i]<<8|S[i]>>>24)|4278255360&(S[i]<<24|S[i]>>>8),M[offset+i]^=S[i]},blockSize:4,ivSize:2});function nextState(){for(var X=this._X,C=this._C,i=0;i<8;i++)C_[i]=C[i];for(C[0]=C[0]+1295307597+this._b|0,C[1]=C[1]+3545052371+(C[0]>>>0<C_[0]>>>0?1:0)|0,C[2]=C[2]+886263092+(C[1]>>>0<C_[1]>>>0?1:0)|0,C[3]=C[3]+1295307597+(C[2]>>>0<C_[2]>>>0?1:0)|0,C[4]=C[4]+3545052371+(C[3]>>>0<C_[3]>>>0?1:0)|0,C[5]=C[5]+886263092+(C[4]>>>0<C_[4]>>>0?1:0)|0,C[6]=C[6]+1295307597+(C[5]>>>0<C_[5]>>>0?1:0)|0,C[7]=C[7]+3545052371+(C[6]>>>0<C_[6]>>>0?1:0)|0,this._b=C[7]>>>0<C_[7]>>>0?1:0,i=0;i<8;i++){var gx=X[i]+C[i],ga=65535&gx,gb=gx>>>16,gh=((ga*ga>>>17)+ga*gb>>>15)+gb*gb,gl=((4294901760&gx)*gx|0)+((65535&gx)*gx|0);G[i]=gh^gl}X[0]=G[0]+(G[7]<<16|G[7]>>>16)+(G[6]<<16|G[6]>>>16)|0,X[1]=G[1]+(G[0]<<8|G[0]>>>24)+G[7]|0,X[2]=G[2]+(G[1]<<16|G[1]>>>16)+(G[0]<<16|G[0]>>>16)|0,X[3]=G[3]+(G[2]<<8|G[2]>>>24)+G[1]|0,X[4]=G[4]+(G[3]<<16|G[3]>>>16)+(G[2]<<16|G[2]>>>16)|0,X[5]=G[5]+(G[4]<<8|G[4]>>>24)+G[3]|0,X[6]=G[6]+(G[5]<<16|G[5]>>>16)+(G[4]<<16|G[4]>>>16)|0,X[7]=G[7]+(G[6]<<8|G[6]>>>24)+G[5]|0}C.RabbitLegacy=StreamCipher._createHelper(RabbitLegacy)}(),CryptoJS.RabbitLegacy}(__webpack_require__(2),__webpack_require__(18),__webpack_require__(19),__webpack_require__(15),__webpack_require__(7))},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0);function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}angular.module("rainbow").factory("Conversation",["$log","$rootScope","$interval","$filter","contactService","xmppService","Message","uuid4","utilService","fileStorageService","fileServerService","$q","fileViewerFactory","roomService","pstnConferenceService",function($log,$rootScope,$interval,$filter,contactService,xmppService,Message,uuid4,utilService,fileStorageService,fileServerService,$q,fileViewerFactory,roomService,pstnConferenceService){function Conversation(conversationId){this.id=conversationId,this.dbId=null,this.type=null,this.owner=null,this.contact=null,this.room=null,this.capabilities=null,this.avatar=null,this.presenceStatus=null,this.name=function(){return{}},this.filterName="",this.missedCounter=0,this.missedCalls=0,this.messages=[],this.participantStatuses={},this.draft="",this.status=Conversation.Status.ACTIVE,this.historyIndex=-1,this.historyMessages=[],this.historyDefered=null,this.historyComplete=!1,this.lastModification=void 0,this.creationDate=new Date,this.lastMessageText="",this.lastMessageSender="",this.pip=!0,this.videoCall={status:_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN},this.audioCall=null,this.pstnConferenceSession=null,this.webConferenceSession=null,this.isMutedAudio=!1,this.isMutedVideo=!1,this.infoVisible=!1,this.muted=!1,this.isFavorite=!1,this.lastEditableMsg=null,this.cacheMessages=[]}Conversation.ChatstatesNS="http://jabber.org/protocol/chatstates",Conversation.ReceiptNS="urn:xmpp:receipts",Conversation.AttentionNS="urn:xmpp:attention:0",Conversation.Type={ONE_TO_ONE:0,ROOM:1,BOT:2},Conversation.EventType={NEW:0,IM:1,CAPABILITIES:2,FILE:3},Conversation.Status={ACTIVE:{key:0,value:"active"},INACTIVE:{key:1,value:"inactive"},COMPOSING:{key:2,value:"composing"},PAUSED:{key:3,value:"paused"}},Conversation.createOneToOneConversation=function(participant){$log.info("[Conversation] Create one to one conversation ("+participant.id+")");var conversation=new Conversation(participant.id);return conversation.contact=participant,participant.conversation=conversation,participant.isBot?(conversation.avatar="",conversation.type=Conversation.Type.BOT):(conversation.avatar=participant.avatar?participant.avatar.src:null,conversation.type=Conversation.Type.ONE_TO_ONE),conversation.name=participant.name,participant.displayName&&(conversation.filterName=utilService.removeDiacritis(participant.displayName.toLowerCase())),conversation},Conversation.createRoomConversation=function(room){$log.info("[Conversation] Create room conversation ("+room.jid+")");var conversation=new Conversation(room.jid);return conversation.type=Conversation.Type.ROOM,conversation.room=room,conversation.filterName=utilService.removeDiacritis(room.name.toLowerCase()),conversation.infoVisible=!0,conversation};var randomBase=uuid4.generate(),messageId=0;return Conversation.getUniqueMessageId=function(){var messageToSendID="web_"+randomBase+messageId;return messageId++,messageToSendID},Conversation.stringToStatus=function(status){switch(status){case"composing":return Conversation.Status.COMPOSING;case"paused":return Conversation.Status.PAUSED;default:return Conversation.Status.ACTIVE}},Conversation.prototype.reset=function(){this.messages=[],this.historyIndex=-1,this.historyMessages=[],this.historyComplete=!1,this.currentHistoryId=null,this.lastMessageText=null,this.chatRenderer&&this.chatRenderer.removeAllMessages()},Conversation.prototype.isInCall=function(){return this.pstnConferenceSession?this.pstnConferenceSession.isParticipantConnectedByJid(contactService.userContact.jid):this.webConferenceSession?this.webConferenceSession.isParticipantConnectedByJid(contactService.userContact.jid):this.videoCall&&this.videoCall.status&&"Unknown"!==this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"Unknown"!==this.audioCall.status.value&&"incommingCall"!==this.audioCall.status.value&&"queued"!==this.audioCall.status.value},Conversation.prototype.isNotInCall=function(){return!(this.videoCall&&this.videoCall.status&&"Unknown"!==this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"Unknown"!==this.audioCall.status.value||"busy"===contactService.userContact.status&&""!==contactService.userContact.message)},Conversation.prototype.isActive=function(){return this.videoCall&&this.videoCall.status&&"active"===this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"active"===this.audioCall.status.value},Conversation.prototype.isHeld=function(){return this.videoCall&&this.videoCall.status&&"held"===this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"held"===this.audioCall.status.value},Conversation.prototype.getMessageById=function(messId,searchInCache){if(searchInCache){var foundMsg=this.cacheMessages.find((function(item){return item.id===messId}));if(foundMsg)return foundMsg}return this.messages.find((function(item){return item.id===messId||item.replaceMsgs.length>0&&item.replaceMsgs.find((function(replaceItem){return replaceItem.id===messId}))}))},Conversation.prototype.getMessageByIdInHistory=function(messId){return this.historyMessages.find((function(item){return item.id===messId}))},Conversation.prototype.sendChatMessage=function(data,answeredMsg,alternativeContent,mentions){var unicodeData=$filter("emojiShortToUnicode")(data),xmppMessage=null,that=this,messageToSendID=Conversation.getUniqueMessageId();if(this.type===Conversation.Type.ONE_TO_ONE){var to=this.contact.jid;xmppMessage=$msg({to:to,type:"chat",id:messageToSendID,"xml:lang":contactService.currentLanguage}).c("body",{"xml:lang":contactService.currentLanguage}).t(unicodeData).up().c("request",{xmlns:Conversation.ReceiptNS}).up().c("active",{xmlns:Conversation.ChatstatesNS}).up()}else xmppMessage=$msg({to:this.room.jid,type:"groupchat",id:messageToSendID}).c("body",{"xml:lang":contactService.currentLanguage}).t(unicodeData).up().c("request",{xmlns:Conversation.ReceiptNS}).up().c("active",{xmlns:Conversation.ChatstatesNS}).up();var answeredMsgId=null,answeredMsgDate=null;answeredMsg&&(xmppMessage=xmppMessage.c("answeredMsg",{stamp:answeredMsg.date.getTime()}).t(answeredMsg.id).up(),answeredMsgId=answeredMsg.id,answeredMsgDate=answeredMsg.date),alternativeContent&&(xmppMessage=xmppMessage.c("content",{type:alternativeContent.type}).t(alternativeContent.message).up()),mentions&&mentions.length&&(xmppMessage=xmppMessage.c("mention",{xmlns:Conversation.AttentionNS}),mentions.forEach((function(jidMentioned){xmppMessage=xmppMessage.c("jid",null,jidMentioned)})));var message=null;return(message=this.addChatMessage(contactService.userContact,new Date,unicodeData,messageToSendID,!0,null,null,answeredMsgId,answeredMsgDate,null,alternativeContent,mentions))?(message.serverAckTimer=$interval((function(){message.receiptStatus=Message.ReceiptStatus.ERROR,that.updateMessage(message)}),1e4),xmppService.send(xmppMessage),message):null},Conversation.prototype.sendCorrectedChatMessage=function(originalMessage,data,origMsgId){$log.info("[Conversation] >sendCorrectedChatMessage: origMsgId="+origMsgId),this.sendAckReadMessages();var unicodeData=$filter("emojiShortToUnicode")(data),xmppMessage=null,that=this,messageToSendID=Conversation.getUniqueMessageId();if($log.info("[Conversation] >sendCorrectedChatMessage: messageToSendID="+messageToSendID),this.type===Conversation.Type.ONE_TO_ONE){var to=this.contact.jid;xmppMessage=$msg({to:to,type:"chat",id:messageToSendID,"xml:lang":contactService.currentLanguage}).c("body",{"xml:lang":contactService.currentLanguage}).t(unicodeData).up().c("replace",{id:origMsgId,xmlns:"urn:xmpp:message-correct:0"}).up().c("store",{xmlns:"urn:xmpp:hints"}).up().c("request",{xmlns:Conversation.ReceiptNS}).up().c("active",{xmlns:Conversation.ChatstatesNS}).up()}else xmppMessage=$msg({to:this.room.jid,type:"groupchat",id:messageToSendID}).c("body",{"xml:lang":contactService.currentLanguage}).t(unicodeData).up().c("replace",{id:origMsgId,xmlns:"urn:xmpp:message-correct:0"}).t(unicodeData).up().c("store",{xmlns:"urn:xmpp:hints"}).up().c("request",{xmlns:Conversation.ReceiptNS}).up().c("active",{xmlns:Conversation.ChatstatesNS}).up();return originalMessage?(originalMessage.serverAckTimer=$interval((function(){originalMessage.receiptStatus=Message.ReceiptStatus.ERROR,that.updateMessage(originalMessage)}),1e4),originalMessage.addReplaceMsg(messageToSendID,data),xmppService.send(xmppMessage),messageToSendID):null},Conversation.prototype.sendIsTypingState=function(isTypingState){var xmppMessage=null,messageToSendID=Conversation.getUniqueMessageId(),state=isTypingState?"composing":"active";if(this.type===Conversation.Type.ONE_TO_ONE){var to=this.contact.jid;xmppMessage=$msg({to:to,type:"chat",id:messageToSendID,"xml:lang":contactService.currentLanguage}).c(state,{xmlns:Conversation.ChatstatesNS}).up()}else xmppMessage=$msg({to:this.room.jid,type:"groupchat",id:messageToSendID}).c(state,{xmlns:Conversation.ChatstatesNS}).up();xmppService.send(xmppMessage)},Conversation.prototype.sendRecordingMessage=function(message){var unicodeData=$filter("emojiShortToUnicode")(message),xmppMessage=null,that=this,messageToSendID=Conversation.getUniqueMessageId();if(this.type===Conversation.Type.ONE_TO_ONE){var to=this.contact.jid;xmppMessage=$msg({to:to,type:"chat",id:messageToSendID,"xml:lang":contactService.currentLanguage}).c("body",{"xml:lang":contactService.currentLanguage}).up().c("recording",{xmlns:"jabber:iq:recordingP2P"}).t(unicodeData).up().c("request",{xmlns:Conversation.ReceiptNS}).up().c("active",{xmlns:Conversation.ChatstatesNS}).up()}message=null;return(message=this.addRecordingMessage(contactService.userContact,new Date,unicodeData,messageToSendID))?(message.serverAckTimer=$interval((function(){message.receiptStatus=Message.ReceiptStatus.ERROR,that.updateMessage(message)}),1e4),xmppService.send(xmppMessage),message):null},Conversation.prototype.sendExistingFSMessage=function(message,fileDescriptor){if(!message)return null;var unicodeData=$filter("emojiShortToUnicode")(message.data),xmppMessage=null,messageToSendID=message.id;if(this.type===Conversation.Type.ONE_TO_ONE){var to=this.contact.jid;xmppMessage=$msg({to:to,type:"chat",id:messageToSendID,"xml:lang":contactService.currentLanguage}).c("body",{"xml:lang":contactService.currentLanguage}).t(unicodeData).up().c("request",{xmlns:Conversation.ReceiptNS}).up().c("active",{xmlns:Conversation.ChatstatesNS}).up()}else xmppMessage=$msg({to:this.room.jid,type:"groupchat",id:messageToSendID}).c("body",{"xml:lang":contactService.currentLanguage}).t(unicodeData).up().c("request",{xmlns:Conversation.ReceiptNS}).up().c("active",{xmlns:Conversation.ChatstatesNS}).up();var url=config.restServerUrl+"/api/rainbow/fileserver/v1.0/files/"+fileDescriptor.id;return xmppMessage.c("x",{xmlns:"jabber:x:oob"}).c("url",{},url).c("mime",{},fileDescriptor.typeMIME).c("filename",{},fileDescriptor.fileName).c("size",{},fileDescriptor.size).up(),fileDescriptor.tags&&"voicemail"===fileDescriptor.tags.purpose&&xmppMessage.c("voicemessage",{xmlns:"http://jabber.org/protocol/voicemessage"}).up(),xmppMessage.c("store",{xmlns:"urn:xmpp:hints"}),message.fileId=fileDescriptor.id,message.setReceiptStatus(Message.ReceiptStatus.SENT),this.updateMessage(message),xmppService.send(xmppMessage),message},Conversation.prototype.sendAckReadOrReceivedMessage=function(messageId,status){$log.info("[Conversation] "+this.id+" send "+status+" status for message "+messageId);var to=this.type===Conversation.Type.ONE_TO_ONE?this.contact.jid:this.room.jid,from=contactService.userContact.jid,msg=$msg({to:to,from:from,type:"chat"}).c("received",{xmlns:Conversation.ReceiptNS,event:status,entity:"client",type:"im",id:messageId});this.type!==Conversation.Type.ONE_TO_ONE&&(msg=$msg({to:to,from:from,type:"groupchat"}).c("received",{xmlns:Conversation.ReceiptNS,event:status,entity:"client",type:"muc",id:messageId})),xmppService.send(msg)},Conversation.prototype.sendAckReceivedMessage=function(message){if(!(message.receiptStatus>=Message.ReceiptStatus.UNREAD)){$log.info("[Conversation] "+this.id+" send received ack for message "+message.id);var to=this.type===Conversation.Type.ONE_TO_ONE?this.contact.jid:this.room.jid,from=contactService.userContact.jid,msg=null;msg=this.type===Conversation.Type.ONE_TO_ONE?$msg({to:to,from:from,type:"chat"}).c("received",{xmlns:Conversation.ReceiptNS,event:"received",entity:"client",type:"im",id:message.id}):$msg({to:to,from:from,type:"groupchat"}).c("received",{xmlns:Conversation.ReceiptNS,event:"received",entity:"client",type:"muc",id:message.id}),xmppService.send(msg),message.setReceiptStatus(Message.ReceiptStatus.UNREAD)}},Conversation.prototype.sendAckReadMessage=function(message){if(message.receiptStatus!==Message.ReceiptStatus.READ){$log.info("[Conversation] "+this.id+" send read ack for message "+message.id);var to=this.type===Conversation.Type.ONE_TO_ONE?this.contact.jid:this.room.jid,from=contactService.userContact.jid,msg=$msg({to:to,from:from,type:"chat"}).c("received",{xmlns:Conversation.ReceiptNS,event:"read",entity:"client",type:"im",id:message.id});if(this.type!==Conversation.Type.ONE_TO_ONE&&(msg=$msg({to:to,from:from,type:"groupchat"}).c("received",{xmlns:Conversation.ReceiptNS,event:"read",entity:"client",type:"muc",id:message.id})),xmppService.send(msg),message.setReceiptStatus(Message.ReceiptStatus.READ),message.replaceMsgs&&message.replaceMsgs.length){var that=this;message.replaceMsgs.forEach((function(message){that.sendAckReadOrReceivedMessage(message.id,"read")}))}}},Conversation.prototype.sendAckReadMessages=function(){$log.info("[Conversation] "+this.id+" sendAckReadMessages");var result=!1,that=this;return this.messages.forEach((function(message){message.receiptStatus!==Message.ReceiptStatus.SENT&&message.receiptStatus!==Message.ReceiptStatus.UNREAD||message.side!==Message.Side.LEFT&&message.side!==Message.Side.ADMIN||(that.sendAckReadMessage(message),result=!0)})),result},Conversation.prototype.sendFSMessage=function(file,data,voiceMessageData){$log.debug("[conversation] >sendFSMessage");var currentFileDescriptor,defered=$q.defer(),that=this,fileExtension=file.name.split(".").pop(),fileMimeType=file.type,viewers=[],message="object"===_typeof(data)?data:void 0;return viewers=this.type===Conversation.Type.ONE_TO_ONE?fileViewerFactory([{viewerId:this.contact.dbId,type:"user"}]):fileViewerFactory([{viewerId:this.room.dbId,type:"room"}]),fileStorageService.createFileDescriptor(file.name,fileExtension,file.size,viewers,voiceMessageData).then((function(fileDescriptor){return currentFileDescriptor=fileDescriptor,fileDescriptor.fileToSend=file,fileDescriptor.isImage()&&file.preview&&(fileDescriptor.previewBlob=file.preview),message||(message=that.addFSMessage(fileDescriptor.id,fileMimeType,data,"uploading",voiceMessageData)),message.fileId=fileDescriptor.id,message.fileName=fileDescriptor.fileName,fileDescriptor.state="uploading",$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:fileDescriptor,cancelable:!0}),fileServerService.uploadAFileByChunk(fileDescriptor,file,message,null).then((function(fileDesc){return $log.debug("uploadAFileByChunk success"),$q.resolve(fileDescriptor)}),(function(error){$log.debug("uploadAFileByChunk error"),fileStorageService.deleteFileDescriptor(currentFileDescriptor.id);var msgKey=error.translatedMessage?error.translatedMessage:"Unable to share file";return $rootScope.$broadcast("ON_SHOW_INFO_MESSAGE",{type:"error",messageKey:msgKey}),currentFileDescriptor.state="uploadError",message.receiptStatus=Message.ReceiptStatus.ERROR,message.fileErrorMsg=msgKey,that.updateMessage(message),$q.reject(error)}))})).then((function(fileDescriptor){fileDescriptor.state="uploaded",fileDescriptor.chunkPerformed=0,fileDescriptor.chunkTotalNumber=0,$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:fileDescriptor}),that.sendExistingFSMessage(message,fileDescriptor),defered.resolve(message)}),(function(error){$log.debug("createFileDescriptor error"),defered.reject(error)})),defered.promise},Conversation.prototype.sendEFSMessage=function(fileDescriptor,data,voiceMessage){var that=this,fileExtension=fileDescriptor.extension,viewerType="",viewerOrRoomId=null,message=this.addFSMessage(fileDescriptor.id,fileExtension,data,fileDescriptor.state,voiceMessage);return this.type===Conversation.Type.ONE_TO_ONE?(viewerType="user",viewerOrRoomId=this.contact.dbId):(viewerType="room",viewerOrRoomId=this.room.dbId),fileStorageService.addFileViewer(fileDescriptor.id,viewerOrRoomId,viewerType).then((function(){that.sendExistingFSMessage(message,fileDescriptor)})).catch((function(error){var msgKey=error.translatedMessage?error.translatedMessage:"Unable to share file";$rootScope.$broadcast("ON_SHOW_INFO_MESSAGE",{type:"error",messageKey:msgKey}),message.receiptStatus=Message.ReceiptStatus.ERROR,that.updateMessage(message)})),message},Conversation.prototype.addAdminBubbleMessage=function(from,date,type,messageID){if(this.getMessageById(messageID))return $log.info("[Conversation] "+this.id+" add addAdminBubbleMessage message ("+messageID+") already exists."),null;$log.info("[Conversation] "+this.id+" add addAdminBubbleMessage from "+from.jid+" : "+type);var data=type+"MsgRoom",side=Message.Side.ADMIN,message=Message.create(messageID,date,from,side,data,!1);return message.setReceiptStatus(Message.ReceiptStatus.SENT),this.addMessage(message)},Conversation.prototype.addFTMessage=function(from,date,fileTransfert,messageID){$log.info("[Conversation] "+this.id+" add FT message from "+from.jid+" : "+fileTransfert.message);var side=contactService.isUserContact(from)?"R":"L",message=Message.createFTMessage(messageID,date,from,side,fileTransfert.message,!1,fileTransfert);return this.addMessage(message)},Conversation.prototype.addFSMessage=function(fileId,mime,data,status,voiceMessage){$log.info("[Conversation] "+this.id+" add FS message from me");var messageToSendID=Conversation.getUniqueMessageId(),unicodeData=$filter("emojiShortToUnicode")(data),date=new Date;if($log.info("[Conversation] "+this.id+" add FILE SHARING message from me"),voiceMessage)var message=Message.createVoiceMessage(messageToSendID,date,contactService.userContact,"R",unicodeData,status,fileId,voiceMessage);else message=Message.createFileSharingMessage(messageToSendID,date,contactService.userContact,"R",unicodeData,status,fileId);return message.setReceiptStatus(Message.ReceiptStatus.IN_PROGRESS),this.addMessage(message)},Conversation.prototype.addChatMessage=function(from,date,data,messageID,isSender,isMarkdown,subject,answeredMsgId,answeredMsgDate,additionalContent,alternativeContent,attention){if(this.getMessageById(messageID))return $log.info("[Conversation] "+this.id+" add CHAT message ("+messageID+") already exists."),null;$log.info("[Conversation] "+this.id+" add CHAT message ("+messageID+") from "+from.jid);var side=contactService.isUserContact(from)?"R":"L",message=Message.create(messageID,date,from,side,data,!1,isMarkdown,subject,answeredMsgId,answeredMsgDate,additionalContent,alternativeContent,attention);return isSender?message.setReceiptStatus(Message.ReceiptStatus.IN_PROGRESS):message.setReceiptStatus(Message.ReceiptStatus.SENT),this.addMessage(message)},Conversation.prototype.addRecordingMessage=function(from,date,data,messageID){var message=Message.createRecordingAdminMessage(messageID,date,from,"ADMIN",data);return this.addMessage(message)},Conversation.prototype.addFileMessage=function(from,date,data,messageID){$log.info("[Conversation] "+this.id+" add FILE message from "+from.jid+" : "+data);var side=contactService.isUserContact(from)?"R":"L",message=Message.createFileMessage(messageID,date,from,side,data,!1);return this.addMessage(message)},Conversation.prototype.addFileSharingMessage=function(from,date,data,messageID,fileId,fileName,geoloc,voiceMessage){$log.info("[Conversation] "+this.id+" add FILE SHARING message from "+from.jid+" message ID "+messageID);var side=contactService.isUserContact(from)?"R":"L";if(voiceMessage)var message=Message.createVoiceMessage(messageID,date,from,side,data,!1,fileId,fileName,voiceMessage);else message=Message.createFileSharingMessage(messageID,date,from,side,data,!1,fileId,fileName,geoloc);return this.addMessage(message)},Conversation.prototype.addConferenceMessage=function(from,date,messageID,conferenceDescriptor){if("reminder"===conferenceDescriptor.type){var room=roomService.getRoomByJid(conferenceDescriptor.roomjid),confSession=pstnConferenceService.conferenceSessions[room.getPstnConfEndpointId()];if(confSession&&confSession.isActive()&&confSession.isParticipantConnectedByJid(contactService.userContact.jid))return}$log.info("[Conversation] "+this.id+" add CONFERENCE message from "+from.jid);var message=Message.createConferenceMessage(messageID,date,from,"ADMIN",!1,conferenceDescriptor);return this.addMessage(message)},Conversation.prototype.addWebRTCMessage=function(from,date,data,messageID){if(this.getMessageById(messageID))return $log.info("[Conversation] "+this.id+" add addWebRTCMessage message ("+messageID+") already exists."),null;$log.info("[Conversation] "+this.id+" add WebRTC message from "+from.jid+" : "+data);var side=contactService.isUserContact(from)?Message.Side.RIGHT:Message.Side.LEFT,message=Message.createWebRTCMessage(messageID,date,from,side,data,!1);return this.addMessage(message)},Conversation.prototype.updateMessage=function(message){this.chatRenderer&&this.chatRenderer.updateMessage(message,this.room)},Conversation.prototype.addMessage=function(message){if(this.messages.find((function(item){return item.id===message.id})))return $log.info("[Conversation] "+this.id+" try to add an already stored message with id "+message.id),message;if(message.side===Message.Side.LEFT)message.type===Message.Type.WEBRTC&&(this.missedCalls+=1),this.setStatusMessage(message.from,Conversation.Status.ACTIVE);else{var oldEditableMsg=this.lastEditableMsg;this.lastEditableMsg=message,this.updateMessage(oldEditableMsg)}if(this.messages.push(message),this.chatRenderer&&(this.chatRenderer.appendMessages([message],this.room),this.contact&&this.contact._lastActivityDate)){var daysOffline=Math.abs(new Date-this.contact._lastActivityDate)/1e3/3600/24;if(this.contact.roster&&"offline"===this.contact.status&&daysOffline>=14){var chatRenderer=this.chatRenderer;chatRenderer.displayInfoMessage($filter("translate")("offlineSendMail"),$filter("translate")("warningOfflineSendMail"),(function(action,contact){action?(chatRenderer.sendingInfoMessage($filter("translate")("sendingMail")),contactService.notifyImByEmail(contact).then((function(){chatRenderer.displayInfoMessage($filter("translate")("sendMailSuccess")),$interval((function(){chatRenderer.hideInfoMessage()}),3e3,1)})).catch((function(error){chatRenderer.displayErrorMessage(error),$interval((function(){chatRenderer.hideInfoMessage()}),5e3,1)}))):chatRenderer.hideInfoMessage()}))}}return this.lastModification=new Date,this.room&&(this.room.lastActivityDate=this.lastModification),this.lastMessageText=message.data,$rootScope.$broadcast("ON_CONVERSATION_UPDATED_EVENT",this.id),message},Conversation.prototype.addMessageInHistoryMessages=function(message){if(message&&(this.historyMessages.push(message),message.side===Message.Side.RIGHT&&(!this.lastEditableMsg||message.date.getTime()>this.lastEditableMsg.date.getTime()))){var oldEditableMsg=this.lastEditableMsg;this.lastEditableMsg=message,this.updateMessage(oldEditableMsg)}},Conversation.prototype.addMessageInCacheMessages=function(message){message&&this.cacheMessages.push(message)},Conversation.prototype.removeMessage=function(message){var index=this.messages.lastIndexOf(message);-1!==index&&this.messages.splice(index,1)},Conversation.prototype.sendChatStatus=function(status){if($log.info("[Conversation] "+this.id+" setStatus "+status.value),this.status!==status&&(this.status=status,status!==Conversation.Status.IDLE)){var xmppMessage=null,to="";this.type===Conversation.Type.ONE_TO_ONE?(to=this.contact.jid,xmppMessage=$msg({to:to,type:"chat"}).c(status.value,{xmlns:Conversation.ChatstatesNS})):(to=this.room.jid,xmppMessage=$msg({to:to,type:"groupchat"}).c(status.value,{xmlns:Conversation.ChatstatesNS}));try{xmppService.connection.send(xmppMessage)}catch(error){$log.error("[Conversation] sendChatStatus error "+error)}}},Conversation.prototype.setStatusMessage=function(from,status){$log.info("[Conversation] "+this.id+" add status message from "+from.jid+" : "+status.value),this.participantStatuses[from.jid]=status,this.chatRenderer&&this.chatRenderer.updateStatuses&&this.chatRenderer.updateStatuses()},Conversation.prototype.sendInvitation=function(participant){try{var to=participant.jid,attrs={xmlns:"jabber:x:conference",jid:this.id},invitation=$msg({from:xmppService.connection.jid,to:to}).c("x",attrs);xmppService.connection.send(invitation)}catch(error){$log.error("[Conversation] sendInvitation error "+error)}},Conversation.prototype.ackReadAllMessages=function(){var that=this;this.messages.forEach((function(message){message.receiptStatus!==Message.ReceiptStatus.SENT&&message.receiptStatus!==Message.ReceiptStatus.UNREAD||(message.setReceiptStatus(Message.ReceiptStatus.READ),that.chatRenderer&&that.chatRenderer.updateMessage(message,that.room))}))},Conversation}])},function(module,exports){angular.module("rainbow").factory("Message",["$log","$filter","$interval","ReplaceMsg","roomService",function($log,$filter,$interval,ReplaceMsg,roomService){"use strict";function Message(id,type,date,from,side,data,status,fileId,isMarkdown,subject,fileName,answeredMsgId,answeredMsgDate,geoloc,additionalContent,alternativeContent,voiceMessage,attention){this.id=id,this.index=null,this.type=type,this.date=date,this.from=from,this.side=side,this.data=data,this.status=status,this.receiptStatus=Message.ReceiptStatus.NONE,this.serverAckTimer=null,this.fileId=fileId,this.fileName=fileName,this.isMarkdown=isMarkdown,this.subject=subject,this.answeredMsgId=answeredMsgId,this.answeredMsgDate=answeredMsgDate,this.geoloc=geoloc,this.additionalContent=additionalContent,this.alternativeContent=alternativeContent,this.voiceMessage=voiceMessage,this.attention=attention,this.replaceMsgs=[]}return Message.Type={CHAT:{key:0,value:"Chat"},FILE:{key:1,value:"File"},FS:{key:2,value:"FileSharing"},FT:{key:3,value:"FileTransfert"},WEBRTC:{key:4,value:"WebRTC CAll"},RECORDING:{key:5,value:"Recording"},VM:{key:6,value:"VoiceMessage"}},Message.ReceiptStatus={NONE:0,ERROR:1,IN_PROGRESS:2,SENT:3,UNREAD:4,READ:5},Message.Side={LEFT:"L",RIGHT:"R",ADMIN:"ADMIN"},Message.ReceiptStatusText=["none","ko","inProgress","sent","received","read"],Message.create=function(id,date,from,side,data,status,isMarkdown,subject,answeredMsgId,answeredMsgDate,additionalContent,alternativeContent,attention){var message=$filter("emojiUnicodeToShort")(data);return new Message(id,Message.Type.CHAT,date,from,side,message,status,null,isMarkdown,subject,null,answeredMsgId,answeredMsgDate,null,additionalContent,alternativeContent,null,attention)},Message.createFileSharingMessage=function(id,date,from,side,data,status,fileId,fileName,geoloc){var message=$filter("emojiUnicodeToShort")(data);return new Message(id,Message.Type.FS,date,from,side,message,status,fileId,null,null,fileName,null,null,geoloc)},Message.createVoiceMessage=function(id,date,from,side,data,status,fileId,fileName,voiceMessage){var message=$filter("emojiUnicodeToShort")(data);return new Message(id,Message.Type.VM,date,from,side,message,status,fileId,null,null,fileName,null,null,null,null,voiceMessage)},Message.createConferenceMessage=function(id,date,from,side,status,conferenceDescriptor){var room=roomService.getRoomByJid(conferenceDescriptor.roomjid),headerConferenceMessage="";switch(conferenceDescriptor.type){case"invite":headerConferenceMessage=$filter("translate")("headerConferenceMessage",{sender:from._displayName,firstname:from.firstname,bubblename:room.name});break;case"reminder":headerConferenceMessage=room&&room.owner?$filter("translate")("conferenceReminderMessageforOwner",{sender:from._displayName}):$filter("translate")("conferenceReminderMessage",{sender:from._displayName});break;default:headerConferenceMessage=$filter("translate")("headerConferenceMessage",{sender:from._displayName,firstname:from.firstname,bubblename:room.name})}room.desc&&(headerConferenceMessage+="<br>"+$filter("translate")("conferenceSuject")+room.desc);var message=headerConferenceMessage;return new Message(id,Message.Type.CHAT,date,from,side,message,status)},Message.createFileMessage=function(id,date,from,side,data,status){return new Message(id,Message.Type.FILE,date,from,side,data,status)},Message.createWebRTCMessage=function(id,date,from,side,data,status){return new Message(id,Message.Type.WEBRTC,date,from,side,data,status)},Message.createFTMessage=function(id,date,from,side,data,status,fileTransfert){var message=new Message(id,Message.Type.FT,date,from,side,data,status);return message.fileTransfert=fileTransfert,message},Message.createBubbleAdminMessage=function(id,date,from,type){var data=type+"MsgRoom",side=Message.Side.ADMIN;return Message.create(id,date,from,side,data,!1)},Message.createRecordingAdminMessage=function(id,date,from,type,cmd){var data=type+"Recording";cmd&&(data+=cmd);var side=Message.Side.ADMIN;return new Message(id,Message.Type.RECORDING,date,from,side,data,!1)},Message.prototype.addReplaceMsg=function(messageId,replacedMsgBody){var replacedMsg=ReplaceMsg.create(messageId,replacedMsgBody);this.replaceMsgs.push(replacedMsg)},Message.prototype.isTextModified=function(){return this.replaceMsgs.length>0},Message.prototype.getLastTextModified=function(){return this.replaceMsgs.length>0?this.replaceMsgs[this.replaceMsgs.length-1].body:this.data},Message.prototype.isDeleted=function(){return 0===this.getLastTextModified().length},Message.prototype.setReceiptStatus=function(receiptStatus){return this.serverAckTimer&&receiptStatus>Message.ReceiptStatus.IN_PROGRESS&&($interval.cancel(this.serverAckTimer),this.serverAckTimer=null),receiptStatus>this.receiptStatus&&(this.receiptStatus=receiptStatus,$log.info("[Message] "+this.id+" : "+Message.ReceiptStatusText[receiptStatus])),this},Message}])},function(module,exports){angular.module("rainbow").factory("Room",[function(){"use strict";function Room(dbId,jid,name,topic,date,conferenceEndpoints,history,customdata,conference,avatar,isActive,lastActivityDate,autoRegister,autoAcceptInvitation){this.dbId=dbId,this.jid=jid,this.name=name,this.nameForLogs="",this.desc=topic,this.type=Room.Type.PRIVATE,this.users=[],this.history=history||Room.History.NONE,this.customData=customdata||{},this.ownerContact=null,this.organizers=[],this.members=[],this.avatarContacts=[],this.owner=!1,this.isModerator=!1,this.confEndpoints=conferenceEndpoints||[],this.conference=void 0!==conference?conference:null,this.status="none",this.creationDate=date,this.initPresPromise=null,this.avatar=avatar,this.guestEmails=[],this.isActive=isActive,this.lastActivityDate=lastActivityDate,this.autoRegister=autoRegister,this.autoAcceptInvitation=autoAcceptInvitation,Room.prototype.toString=function(){return"Room "+this.dbId+" "+this.name+" "+this.jid},Room.prototype.updateAvatarInfo=function(){var avatarContacts=[],orderedContacts=this.users.slice();if(!this.avatar){orderedContacts.sort((function(aa,bb){return new Date(aa.date)-new Date(bb.date)}));for(var index=0;index<orderedContacts.length;index++){var contact=orderedContacts[index].contact,status=orderedContacts[index].status;if(contact&&contact.dbId!==this.ownerContact.dbId&&"A"!==contact.initials&&"Anonymous"!==contact.displayName&&!contact.isTerminated&&("accepted"!==status&&"invited"!==status||avatarContacts.push(contact),2===avatarContacts.length))break}this.avatarContacts=avatarContacts}},Room.prototype.isUserOwner=function(contact){return!!contact&&this.ownerContact.jid===contact.jid},Room.prototype.isUserModerator=function(contact){return void 0!==this.getOrganizerFromContactJid(contact.jid)},Room.prototype.isUserStatusAccepted=function(contact){var user=this.getUserByJid(contact.jid);return void 0!==user&&"accepted"===user.status},Room.prototype.isUserStillBelongToRoom=function(userJid){var ownUser=this.getUserByJid(userJid);return!ownUser||"unsubscribed"!==ownUser.status&&"deleted"!==ownUser.status},Room.prototype.getOrganizerFromContactJid=function(contactJid){var user;return this.organizers.forEach((function(organizer){organizer.contact.jid===contactJid&&(user=organizer)})),user},Room.prototype.getUserByJid=function(userJid){for(var i=0;i<this.users.length;i++)if(userJid===this.users[i].contact.jid)return this.users[i];return null},Room.prototype.getPstnConfEndpointId=function(){if(this.confEndpoints&&this.confEndpoints.length)for(var i=0;i<this.confEndpoints.length;i++)if("pstnAudio"===this.confEndpoints[i].mediaType)return this.confEndpoints[i].confEndpointId;return null},Room.prototype.getSFUConfEndpointId=function(){if(this.confEndpoints&&this.confEndpoints.length)for(var i=0;i<this.confEndpoints.length;i++)if("webrtc"===this.confEndpoints[i].mediaType)return this.confEndpoints[i].confEndpointId;return null},Room.prototype.getSFUSharingConfEndpointId=function(){if(this.confEndpoints&&this.confEndpoints.length)for(var i=0;i<this.confEndpoints.length;i++)if("webrtcSharingOnly"===this.confEndpoints[i].mediaType)return this.confEndpoints[i].confEndpointId;return null},Room.prototype.isMyPersonalMeetingRoom=function(){return this.conference&&"pstnAudio"===this.conference.mediaType&&!this.conference.scheduled&&this.conference.personalMeeting&&this.owner},Room.prototype.isMeetingRoom=function(){return this.conference&&"pstnAudio"===this.conference.mediaType},Room.prototype.isWebConferenceRoom=function(){return this.conference&&"pstnAudio"!==this.conference.mediaType&&this.getSFUConfEndpointId()},Room.prototype.isMeetingOrWebConferenceRoom=function(){return this.isMeetingRoom()||this.getSFUConfEndpointId()},Room.prototype.getNameForLogs=function(){if(!this.nameForLogs&&this.name){var temp=this.name.replace(/[^\s](?=.{1,}$)/g,"*");this.nameForLogs=this.name.charAt(0)+temp.substr(1)}return this.nameForLogs},Room.prototype.getInvitedUsers=function(audioUserJids){var audioUserJidsList=[];audioUserJids&&(audioUserJidsList=audioUserJids);var ctrl=this;return this.members.filter((function(user){return!(user.contact.displayName.startsWith("__guest__")||user.contact.displayName.startsWith("__##__guest__##__")||user.contact.displayName.startsWith("Anonymous")||audioUserJidsList.contains(user.contact.jid)||ctrl.isUserModerator(user.contact)||user.contact.isTerminated||"accepted"!==user.status&&"invited"!==user.status)}))},Room.prototype.getAutoRegister=function(){return this.autoRegister?this.autoRegister:"unlock"},Room.prototype.setAutoRegister=function(value){this.autoRegister=value},Room.prototype.setAutoAcceptInvitation=function(value){this.autoAcceptInvitation=value},Room.prototype.getAllAcceptedMembers=function(){return this.members.filter((function(user){return!(user.contact.displayName.startsWith("__guest__")||user.contact.displayName.startsWith("__##__guest__##__")||user.contact.displayName.startsWith("Anonymous")||user.contact.isTerminated||"accepted"!==user.status)}))},Room.prototype.getAllAcceptedUsers=function(){return this.users.filter((function(user){return!(user.contact.displayName.startsWith("__guest__")||user.contact.displayName.startsWith("__##__guest__##__")||user.contact.displayName.startsWith("Anonymous")||user.contact.isTerminated||user.contact.isTv||"accepted"!==user.status)}))}}return Room.Type={PRIVATE:0,PUBLIC:1},Room.Privilege={USER:"user",MODERATOR:"moderator",GUEST:"guest"},Room.History={ALL:"all",NONE:"none"},Room.create=function(dbId,jid,name,topic,date,conferenceEndpoints,history,customdata,conference,avatar,isActive,lastActivityDate,autoRegister,autoAcceptInvitation){return new Room(dbId,jid,name,topic,date,conferenceEndpoints,history,customdata,conference,avatar,isActive,lastActivityDate,autoRegister,autoAcceptInvitation)},Room}])},function(module,exports){!function(){"use strict";angular.module("rainbow").factory("RBNotification",["$log","$rootScope","$notification","$filter","notify",function($log,$rootScope,$notification,$filter,notify){var defaultDelay=8e5,notificationSaver=null;function RBNotification(attr){$log.info("[RBNotification] Create notification"),this.icon=attr.icon,this.displayName=attr.displayName,this.message=attr.body,this.type=attr.type,this.tag=attr.tag,this.title=attr.title,this.tooltip=attr.tooltip,this.delay=attr.delay?attr.delay:defaultDelay,this.focusAction=attr.focusAction,this.sound=null,this.answerAudioButton=null,this.answerVideoButton=null,this.answerSharingButton=null,this.answerAudioButtonDisabled=null,this.answerClick=!1,this.declineClick=!1,this.declineButton=null,this.answerWithIMButton=null,this.answerWithTemplateIMClick=!1,this.bottomRightButton=null,this.handler=null,this.ascope=null,this.isSent=!1}return RBNotification.notifs=[],RBNotification.create=function(attr){var notification=RBNotification.notifs[attr.id];return notification?(notification.update(attr),notification):(notification=new RBNotification(attr),RBNotification.notifs[attr.id]=notification,notification)},RBNotification.hide=function(notificationId){$log.info("[RBNotification] Hide notification");var notification=RBNotification.notifs[notificationId];notification&&notification.handler.close(),delete RBNotification.notifs[notificationId],0===Object.keys(RBNotification.notifs).length&&$rootScope.$broadcast("NOTIFICATION_HIDE_EVENT",this)},RBNotification.createNotificationListener=function(scope){$rootScope.$on("$destroy",$rootScope.$on("NOTIFICATION_SHOW_EVENT",(function(__event,notification){notification.display(scope)})))},RBNotification.prototype.update=function(attr){$log.info("[RBNotification] >update"),this.icon=attr.icon,this.displayName=attr.displayName,this.message=attr.body,this.type=attr.type,this.tag=attr.tag,this.delay=attr.delay?attr.delay:defaultDelay,this.focusAction=attr.focusAction},RBNotification.prototype.send=function(){this.isSent||(this.isSent=!0,$rootScope.$broadcast("NOTIFICATION_SHOW_EVENT",this))},RBNotification.prototype.addAnswerAudioButton=function(attr){this.answerAudioButton=attr},RBNotification.prototype.addDivertedCallButton=function(attr){this.divertedCallButton=attr},RBNotification.prototype.addAnswerVideoButton=function(attr){this.answerVideoButton=attr},RBNotification.prototype.addAnswerSharingButton=function(attr){this.answerSharingButton=attr},RBNotification.prototype.addAnswerAudioButtonDisabled=function(attr){this.answerAudioButtonDisabled=attr},RBNotification.prototype.addDeclineButton=function(attr){this.declineButton=attr},RBNotification.prototype.addAnswerWithIMButton=function(attr){this.answerWithIMButton=attr},RBNotification.prototype.addBottomRightButton=function(attr){this.bottomRightButton=attr},RBNotification.prototype.display=function(scope){if(!$rootScope.appVisible){var _notif=$notification(this.displayName,{tag:this.tag,body:this.message,icon:this.icon,delay:4e3});this.focusAction&&_notif.$on("click",this.focusAction)}this.ascope||(this.ascope=scope.$new(!0),this.ascope.notification=this,this.ascope.showIMTemplates=!1,this.ascope.showPhoneTemplates=!1,this.ascope.answerAudioButtonClick=function(notif){notif.answerClick||(notif.answerAudioButton.action(),notif.answerClick=!0)},this.ascope.divertedCallButtonClick=function(notif){if(notif.ascope.showPhoneTemplates)notif.ascope.showPhoneTemplates=!1,notif.ascope.templatesPhone=[];else{notificationSaver=notif;var templatesPhone=[];notif.divertedCallButton&&Array.isArray(notif.divertedCallButton.choice)&&notif.divertedCallButton.choice.forEach((function(item){templatesPhone.push(item)})),notif.ascope.templatesPhone=templatesPhone,notif.ascope.showPhoneTemplates=!0}},this.ascope.divertedCallWithTemplatePhone=function(template){notificationSaver.divertedCallButton.action(template.phonenumber)},this.ascope.answerVideoButtonClick=function(notif){notif.answerClick||(notif.answerVideoButton.action(),notif.answerClick=!0)},this.ascope.answerSharingButtonClick=function(notif){notif.answerClick||(notif.answerSharingButton.action(),notif.answerClick=!0)},this.ascope.declineButtonClick=function(notif){notif.declineClick||(notif.declineButton.action(),notif.declineClick=!0)},this.ascope.answerWithIMButtonClick=function(notif){if(notif.ascope.showIMTemplates)notif.ascope.showIMTemplates=!1,notif.ascope.templatesIM=[];else{notificationSaver=notif;var templatesIM=[];notif.answerWithIMButton&&Array.isArray(notif.answerWithIMButton.choice)&&notif.answerWithIMButton.choice.forEach((function(item){templatesIM.push(item)})),notif.ascope.templatesIM=templatesIM,notif.ascope.showIMTemplates=!0}},this.ascope.answerWithTemplateIM=function(template){if(!notificationSaver.answerWithTemplateIMClick){if(notificationSaver){var message="";notificationSaver.answerWithIMButton.label!==template.label&&(message=$filter("translate")(template.label)),notificationSaver.answerWithIMButton.action(message)}notificationSaver.answerWithTemplateIMClick=!0}},this.ascope.addBottomRightButtonClick=function(notif){notif.bottomRightButton.action()}),this.handler||(this.handler=notify({container:document.getElementById("leftArea"),position:"left",templateUrl:"notificationCallTemplate.html",message:this.title,duration:this.delay,startTop:80,scope:this.ascope}))},RBNotification}])}()},function(module,exports){angular.module("rainbow").factory("CallLog",[function(){"use strict";function CallLog(id,contact,state,duration,type,read,date,direction,callSubject,isLatestCall){this.id=id,this.contact=contact,this.state=state,this.duration=duration,this.direction=direction,this.callSubject=callSubject,this.isLatestCall=isLatestCall,type="unknown"===type||"audio"===type||"webrtc"===type?CallLog.Type.WEBRTC:"telephone"===type?CallLog.Type.TELEPHONE:CallLog.Type.CONFERENCE,this.type=type,this.read=read,this.date=date}return CallLog.create=function(id,contact,state,duration,type,read,date,direction,callSubject,isLatestCall){return new CallLog(id,contact,state,duration,type,read,date,direction,callSubject,isLatestCall)},CallLog.getNames=function(callLog){var result={firstname:"",lastname:""};return callLog&&callLog.contact&&(result.firstname=callLog.contact.firstname?callLog.contact.firstname.toUpperCase():"",result.lastname=callLog.contact.lastname?callLog.contact.lastname.toUpperCase():"",callLog&&callLog.date&&(result.date=callLog.date.getTime())),result},CallLog.getDate=function(callLog){return callLog&&callLog.date?callLog.date.getTime():0},CallLog.sortByContact=function(callLogA,callLogB){var res=-1;if(callLogA&&callLogA.value.lastname&&callLogB&&callLogB.value.lastname){var str1=callLogA.value.lastname,str2=callLogB.value.lastname;0===(res=str1.localeCompare(str2))&&(str1=callLogA.value.firstname,str2=callLogB.value.firstname,0===(res=str1.localeCompare(str2))&&callLogB.value.date&&callLogA.value.date&&(res=callLogB.value.date-callLogA.value.date))}return res},CallLog.sortByDate=function(callLogA,callLogB){var res=1;return callLogA&&callLogB&&(res=callLogB.value-callLogA.value),res},CallLog.Type={WEBRTC:"webrtc",TELEPHONE:"telephone",CONFERENCE:"conference"},CallLog}])},function(module,exports){!function(){"use strict";angular.module("rainbow").factory("Document",["$log","$filter",function($log,$filter){function Document(publisher,data,timestamp,authorjid,item_id,pub_id){this.publisher=publisher,this.item_id=item_id,this.data=data,this.timestamp=timestamp,this.authorjid=authorjid,this.pub_id=pub_id,$log.debug("[Document] createActu : "+this)}return Document.create=function(publisher,data){return new Document(publisher,data,Date.now(),publisher.jid)},Document.createForSharing=function(publisher,document){return console.log(document.item_id),""===document.item_id?new Document(publisher,"Repost",Date.now(),document.authorjid,document.pub_id):new Document(publisher,"Repost",Date.now(),document.authorjid,document.item_id)},Document.createFromXML=function(publisher,data){return new Document(publisher,data.childNodes[0].childNodes[0].nodeValue,parseInt(data.childNodes[1].childNodes[0].nodeValue,10),data.childNodes[2].childNodes[0].nodeValue,1!==data.childNodes[3].childNodes.length?"":data.childNodes[3].childNodes[0].nodeValue,data.parentNode.attributes.getNamedItem("id").nodeValue)},Document.prototype.messageFilter=function(message){return $filter("quoteFilter")($filter("emojione")($filter("linky")($filter("emojiUnicodeToShort")(message,"_blank"))))},Document.prototype.setPubId=function(pub_id){this.pub_id=pub_id},Document.prototype.setItemId=function(item_id){this.item_id=item_id},Document.prototype.getXML=function(){return[{data:$build("entry").c("data",this.data).up().c("timestamp",this.timestamp).up().c("jidauthor",this.authorjid).up().c("item_id",this.item_id).tree()}]},Document.prototype.getTime=function(format){return moment(this.timestamp).format(format)},Document.prototype.toString=function(){return"(jid:"+this.contact+", id:"+this.pub_id+", data:"+this.data+", tsmp:"+this.timestamp+" )"},Document}])}()},function(module,exports){angular.module("rainbow").factory("Group",[function(){"use strict";function Group(id,name,comment,isFavorite){this.id=id,this.name=name,this.comment=comment||"",this.isFavorite=isFavorite||!1,this.users=[],this.sortedUserList=[]}return Group.createFromData=function(data){return new Group(data.id,data.name,data.comment,data.isFavorite)},Group}])},function(module,exports){angular.module("rainbow").factory("Invitation",["userInfoService",function(userInfoService){"use strict";function Invitation(id,invitedUserId,invitedUserEmail,invitingUserId,invitingUserEmail,requestNotificationLanguage,invitingDate,lastNotificationDate,status,type,inviteToJoinMeeting,invitedPhoneNumber){this.id=id,this.invitedUserId=invitedUserId,this.invitedUserEmail=invitedUserEmail,this.invitedPhoneNumber=invitedPhoneNumber,this.invitingUserId=invitingUserId,this.invitingUserEmail=invitingUserEmail,this.requestNotificationLanguage=requestNotificationLanguage,this.invitingDate=invitingDate,this.lastNotificationDate=lastNotificationDate,this.status=status,this.type=type,this.defaultAvatar=null,this.inviteToJoinMeeting=inviteToJoinMeeting,this.createDefaultAvatar=function(){if(!this.defaultAvatar&&this.invitedUserEmail){var color=userInfoService.computeUserColor(this.invitedUserEmail),initials=this.invitedUserEmail.substring(0,2).toUpperCase();this.defaultAvatar=userInfoService.createDefaultAvatarImage(initials,color)}}}return Invitation.create=function(id,invitedUserId,invitedUserEmail,invitingUserId,invitingUserEmail,requestNotificationLanguage,invitingDate,lastNotificationDate,status,type,inviteToJoinMeeting){return new Invitation(id,invitedUserId,invitedUserEmail,invitingUserId,invitingUserEmail,requestNotificationLanguage,invitingDate,lastNotificationDate,status,type,inviteToJoinMeeting)},Invitation.createFromData=function(invitationData){var invitation=new Invitation(invitationData.id,invitationData.invitedUserId,invitationData.invitedUserEmail,invitationData.invitingUserId,invitationData.invitingUserEmail,invitationData.requestNotificationLanguage,invitationData.invitingDate,invitationData.lastNotificationDate,invitationData.status,invitationData.type,invitationData.inviteToJoinMeeting,invitationData.invitedPhoneNumber);return invitation.createDefaultAvatar(),invitation},Invitation}])},function(module,exports){angular.module("rainbow").factory("VoiceMail",["profileService",function(profileService){"use strict";function VoiceMail(){this.VMFlag=!1,this.VMCounter=0,this.infoMsg="",this.voiceMailFeatureEnabled=profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_VOICE_MAIL),this.setVMFlag=function(flag){this.VMFlag=flag},this.getVMFlag=function(){return this.VMFlag},this.setVMCounter=function(ct){ct>0?(this.VMFlag=!0,this.VMCounter=ct):this.VMCounter=0},this.getVMCounter=function(){return this.VMCounter},this.setInfoMsg=function(msg){this.infoMsg=msg},this.getInfoMsg=function(){return this.infoMsg},this.getDisplayState=function(){return this.voiceMailFeatureEnabled}}return VoiceMail.create=function(){return new VoiceMail},VoiceMail}])},function(module,exports){class VoiceMessage{constructor(id,contact,unread,duration,date,from,jid){this.id=id,this.contact=contact,this.unread=unread,this.duration=duration,this.date=date,this.from=from,this.jid=jid}static VoiceMessageFactory(){return(id,contact,unread,duration,date,from,jid)=>new VoiceMessage(id,contact,unread,duration,date,from,jid)}}angular.module("rainbow").factory("VoiceMessageFactory",VoiceMessage.VoiceMessageFactory)},function(module,exports){angular.module("rainbow").factory("ReplaceMsg",["$filter",function($filter){"use strict";function ReplaceMsg(id,body){this.id=id,this.body=body}return ReplaceMsg.create=function(id,body){return new ReplaceMsg(id,$filter("emojiUnicodeToShort")(body))},ReplaceMsg}])},function(module,exports){angular.module("rainbow").factory("Organisation",[function(){"use strict";function Organisation(id,name,visibility){this.id=id,this.name=name,this.visibility=visibility,this.companies=[]}return Organisation.createFromData=function(data){return new Organisation(data.id,data.name,data.visibility)},Organisation}])},function(module,exports){angular.module("rainbowAdmin").factory("Bot",[function(){"use strict";function Bot(jid,name,id,avatarId,lastAvatarUpdateDate,isBotAvatarCustomized){this.jid=jid,this.name=name,this.id=id,this.avatarId=avatarId||id,this.lastAvatarUpdateDate=lastAvatarUpdateDate,this.isAvatarCustomized=isBotAvatarCustomized}return Bot.create=function(data){return new Bot(data.jid,data.name,data.id,data.avatarId,data.lastAvatarUpdateDate,data.isBotAvatarCustomized)},Bot}])},function(module,exports){angular.module("rainbow").factory("Site",[function(){"use strict";function Site(id,name,status,companyId,settings,isCentrex){this.id=id,this.name=name||"",this.status=status||"",this.companyId=companyId||"",this.settings=settings||"",angular.isDefined(isCentrex)&&(this.isCentrex=isCentrex)}return Site.createFromData=function(data){return new Site(data.id,data.name,data.status,data.companyId,data.settings,data.isCentrex)},Site.create=function(id,name,status,companyId){return new Site(id,name,status,companyId)},Site.StatusValues=["active","alerting","hold","terminated"],Site}])},function(module,exports){angular.module("rainbow").factory("System",[function(){"use strict";function System(id,pbxId,jid_pbxagent,jid_password,pbxMainBundlePrefix,serverPingTimeout,type,status,version,siteId,country,name,jid_pbxagent_password,jid_pbxagent_password_activating,usePbxMainBundlePrefix,pbxNumberingTranslator,isCentrex,isShared,bpId,cloudpbx,hasMediaPillar,isOxoManaged){this.id=id||null,this.type=type||null,this.type!==System.TypeEnum.CLOUD_PBX&&(this.jid_pbxagent=jid_pbxagent||"",this.jid_password=jid_password||"",this.jid_pbxagent_password=jid_pbxagent_password||"",this.jid_pbxagent_password_activating=jid_pbxagent_password_activating||"",this.pbxMainBundlePrefix=pbxMainBundlePrefix||["0"],this.usePbxMainBundlePrefix=!angular.isDefined(usePbxMainBundlePrefix)||usePbxMainBundlePrefix,this.pbxNumberingTranslator=pbxNumberingTranslator||[]),this.country=country||"FRA",this.name=name||"",siteId&&(this.siteId=siteId),pbxId&&(this.pbxId=pbxId),serverPingTimeout&&(this.serverPingTimeout=serverPingTimeout),status&&(this.status=status),version&&(this.version=version),angular.isDefined(isCentrex)&&(this.isCentrex=isCentrex),angular.isDefined(isShared)&&(this.isShared=isShared),bpId&&(this.bpId=bpId),angular.isDefined(hasMediaPillar)&&(this.hasMediaPillar=hasMediaPillar),angular.isDefined(isOxoManaged)&&(this.isOxoManaged=isOxoManaged),cloudpbx?(cloudpbx.domainName&&(this.domainName=cloudpbx.domainName),cloudpbx.numberingDigits&&(this.numberingDigits=cloudpbx.numberingDigits),cloudpbx.numberingPrefix&&(this.numberingPrefix=cloudpbx.numberingPrefix),cloudpbx.outgoingPrefix&&(this.outgoingPrefix=cloudpbx.outgoingPrefix),cloudpbx.externalTrunkId&&(this.externalTrunkId=cloudpbx.externalTrunkId),cloudpbx.installationNumber&&(this.installationNumber=cloudpbx.installationNumber),cloudpbx.installationNumberId&&(this.installationNumberId=cloudpbx.installationNumberId),cloudpbx.language&&(this.language=cloudpbx.language)):(this.numberingDigits=3,this.numberingPrefix="1")}return System.createFromData=function(data){return new System(data.id,data.pbxId,data.jid_pbxagent,data.jid_password,data.pbxMainBundlePrefix,data.serverPingTimeout,data.type,data.status,data.version,data.siteId,data.country,data.name,data.jid_pbxagent_password,data.jid_pbxagent_password_activating,data.usePbxMainBundlePrefix,data.pbxNumberingTranslator,data.isCentrex,data.isShared,data.bpId,data.cloudpbx,data.hasMediaPillar,data.isOxoManaged)},System.create=function(){return new System},System.TypeValues=["oxe","oxo","third_party","cloud_pbx","oxo_managed"],System.TypeEnum={OXE:"oxe",OXO:"oxo",THIRD_PARTY:"third_party",CLOUD_PBX:"cloud_pbx",OXO_MANAGED:"oxo_managed"},System.StatusValues=["created","activating","activated"],System}]),angular.module("rainbow").filter("serverTypeFilter",[function(){"use strict";return function(input){return"oxo"===input?"OXO Connect":"oxe"===input?"OmniPCX Enterprise":"third_party"===input?"Third party PBX":"cloud_pbx"===input?"Cloud PBX":"oxo_managed"===input?"Managed OXO Connect":input}}]),angular.module("rainbow").filter("systemStateFilter",[function(){"use strict";return function(input){return"created"===input?"pending":"activating"===input?"pending":"activated"===input?"systemStatusActivated":"connected"===input?"systemStatusConnected":"disconnected"===input?"systemStatusDisonnected":"degraded"===input?"systemStatusDegraded":void 0}}]),angular.module("rainbow").filter("systemStateColorFilter",[function(){"use strict";return function(input){return"created"===input?"color_blue":"activating"===input?"color_blue":"activated"===input?"color_blue":"connected"===input?"color_green":"disconnected"===input?"color_error":"degraded"===input?"color_warning":void 0}}]),angular.module("rainbow").filter("thirdPartySystemStateFilter",[function(){"use strict";return function(input){return"created"===input?"pending":"activating"===input?"pending":"activated"===input?"systemStatusConnected":void 0}}]),angular.module("rainbow").filter("thirdPartySystemStateColorFilter",[function(){"use strict";return function(input){return"created"===input?"color_blue":"activating"===input?"color_blue":"activated"===input?"color_green":void 0}}]),angular.module("rainbow").filter("cloudPbxStateFilter",[function(){"use strict";return function(input){return"created"===input?"systemStatusConnected":"disconnected"===input?"systemStatusDisonnected":void 0}}]),angular.module("rainbow").filter("cloudPbxStateColorFilter",[function(){"use strict";return function(input){return"created"===input?"color_green":"disconnected"===input?"color_error":void 0}}]),angular.module("rainbow").filter("gatewayStateFilter",[function(){"use strict";return function(input){return"true"===input?"systemStatusConnected":"false"===input?"systemStatusDisonnected":void 0}}]),angular.module("rainbow").filter("gatewayStateColorFilter",[function(){"use strict";return function(input){return"true"===input?"color_green":"false"===input?"color_error":"new_version"===input?"color_warning":void 0}}])},function(module,exports){angular.module("rainbow").factory("SystemsGroup",[function(){"use strict";function SystemsGroup(id,name,companies,systems){this.id=id||null,this.name=name,this.companies=companies||[],this.systems=systems,this.containsSystem=function(systemId){return!!this.systems&&this.systems.some((function(system){return system.systemId===systemId}))}}return SystemsGroup.createFromData=function(data){return new SystemsGroup(data.id,data.name,data.companies,data.systems)},SystemsGroup.create=function(id,name,companies,systems){return new SystemsGroup(id,name,companies,systems)},SystemsGroup}])},function(module,exports){angular.module("rainbow").factory("User",["Subscription","userInfoService",function(Subscription,userInfoService){"use strict";function User(data,noDefaultValues){var _this=this;User.attributes.forEach((function(attribute){data&&angular.isDefined(data[attribute.name])?_this[attribute.name]=data[attribute.name]:!noDefaultValues&&angular.isDefined(attribute.defaultValue)&&(_this[attribute.name]=attribute.defaultValue)})),this.subscriptions=[],this.updateFromData=function(newData){User.attributes.forEach((function(attribute){angular.isDefined(newData[attribute.name])&&(_this[attribute.name]=newData[attribute.name])}))},this.fillSubscriptionMap=function(){var subscriptionMap={};this.subscriptions.forEach((function(subscription){subscriptionMap[subscription.id]=subscription})),this.subscriptionMap=subscriptionMap},this.fillMainSubscriptionField=function(){var exclusiveSubscriptions=this.subscriptions.filter(Subscription.isExclusive).sort(Subscription.subscriptionComparator);exclusiveSubscriptions.length>0&&(this.mainSubscription=exclusiveSubscriptions[exclusiveSubscriptions.length-1],this.mainSubscriptionName=this.mainSubscription.offerName);var optionalSubscriptions=this.subscriptions.filter(Subscription.isOptional);optionalSubscriptions.length>0&&(this.optionalSubscriptionNames=optionalSubscriptions.map((function(optionalSubscription){return optionalSubscription.offerName})).join(", ")),this.subscriptionNames=this.mainSubscriptionName+(this.optionalSubscriptionNames?", "+this.optionalSubscriptionNames:"")},this.getMainSubscription=function(){return this.mainSubscription||this.fillMainSubscriptionField(),this.mainSubscription},this.getOptionalSubscriptions=function(){return this.subscriptions.filter(Subscription.isOptional)},this.getMainSubscriptionName=function(){return this.mainSubscriptionName||this.fillMainSubscriptionField(),this.mainSubscriptionName},this.getOptionalSubscriptionNames=function(){return this.mainSubscriptionName||this.fillMainSubscriptionField(),this.optionalSubscriptionNames},this.hasUserRoleOnly=function(){return 1===this.roles.length&&-1!==this.roles.indexOf(User.RoleValues.USER)},this.isAdmin=function(){return-1!==this.roles.indexOf(User.RoleValues.ADMIN)},this.isOrganizationAdmin=function(){return!!this.isAdmin()&&"organization_admin"===this.adminType},this.isSiteAdmin=function(){return!!this.isAdmin()&&"site_admin"===this.adminType},this.isCompanyAdmin=function(){return!!this.isAdmin()&&"company_admin"===this.adminType},this.isBPAdmin=function(){return this.isBPAdminOperations()||this.isBPAdminFinance()},this.isBPAdminOperations=function(){return-1!==this.roles.indexOf(User.RoleValues.BP_ADMIN_OPERATIONS)},this.isBPAdminFinance=function(){return-1!==this.roles.indexOf(User.RoleValues.BP_ADMIN_FINANCE)},this.isSuperadmin=function(){return-1!==this.roles.indexOf(User.RoleValues.SUPERADMIN)},this.isBusinessAdmin=function(){return-1!==this.roles.indexOf(User.RoleValues.BUSINESS_ADMIN)},this.isPublicChannelsAdmin=function(){return-1!==this.roles.indexOf(User.RoleValues.PUBLIC_CHANNELS_ADMIN)},this.isAllCompanyChannelsAdmin=function(){return-1!==this.roles.indexOf(User.RoleValues.ALL_COMPANY_CHANNELS_ADMIN)},this.isClosedChannelsAdmin=function(){return-1!==this.roles.indexOf(User.RoleValues.CLOSED_CHANNELS_ADMIN)},this.isDirectoryAdmin=function(){return-1!==this.roles.indexOf(User.RoleValues.DIRECTORY_ADMIN)},this.isRainbowTv=function(){return this.isTv||-1!==this.roles.indexOf(User.RoleValues.TV)},this.computeDisplayName=function(){var nameInfo=userInfoService.getNameInformation(this.firstName,this.lastName);this.displayName=nameInfo.displayName,this.initials=nameInfo.initials},this.getPhoneNumbers=function(type,deviceType){return this.phoneNumbers?this.phoneNumbers.filter((function(phoneNumber){return phoneNumber.type===type&&phoneNumber.deviceType===deviceType})):[]},this.getSystemPhoneNumber=function(){return this.phoneNumbers?this.phoneNumbers.find((function(phoneNumber){return angular.isDefined(phoneNumber.systemId)&&phoneNumber.isFromSystem})):void 0},this.isRvcpSubscriber=function(){var userSystemPhoneNumber=this.getSystemPhoneNumber();return userSystemPhoneNumber&&"RVCP Subscriber"===userSystemPhoneNumber.deviceName},this.getActivePhoneNumber=function(type,deviceType){var filteredPhoneNumbers=this.getPhoneNumbers(type,deviceType);if(filteredPhoneNumbers.length>1){var systemPhoneNumber=filteredPhoneNumbers.find((function(phoneNumber){return angular.isDefined(phoneNumber.systemId)}));if(systemPhoneNumber)return systemPhoneNumber}return filteredPhoneNumbers[0]},this.getDdiPhoneNumber=function(type,deviceType){var filteredPhoneNumbers=this.getPhoneNumbers(type,deviceType);if(filteredPhoneNumbers.length>1){var ddiPhoneNumber=filteredPhoneNumbers.find((function(phoneNumber){return phoneNumber.isCloudPbxDDI}));if(ddiPhoneNumber||(ddiPhoneNumber=filteredPhoneNumbers.find((function(phoneNumber){return phoneNumber.isFromSystem}))),ddiPhoneNumber)return ddiPhoneNumber}return filteredPhoneNumbers[0]}}return User.createFromData=function(data,noDefaultValues){data&&data.roles&&data.roles.includes("private_channels_admin")&&data.roles.splice(data.roles.indexOf("private_channels_admin"),1,User.RoleValues.ALL_COMPANY_CHANNELS_ADMIN);var user=new User(data,noDefaultValues);return data.profiles&&(data.profiles.forEach((function(subscriptionData){var subscription=Subscription.createFromData(subscriptionData);subscription.isTerminated()||user.subscriptions.push(subscription)})),user.fillMainSubscriptionField()),user.computeDisplayName(),user},User.create=function(){return new User},User.prune=function(data,userContact){return Object.assign({},data)},User.VisibilityValues=["same_than_company","public","private"],User.FileSharingCustomisationValues=["same_than_company","enabled","disabled"],User.UserTitleNameCustomisationValues=["same_than_company","enabled","disabled"],User.TryNewUiCustomisationValues=["same_than_company","enabled","disabled"],User.SoftphoneOnlyCustomisationValues=["same_than_company","disabled","enabled"],User.RoleValues={USER:"user",GUEST:"guest",SUPERADMIN:"superadmin",SUPPORT:"support",BUSINESS_ADMIN:"business_admin",ADMIN:"admin",BP_ADMIN_OPERATIONS:"bp_admin",BP_ADMIN_FINANCE:"bp_finance",DIRECTORY_ADMIN:"directory_admin",PUBLIC_CHANNELS_ADMIN:"public_channels_admin",ALL_COMPANY_CHANNELS_ADMIN:"all_company_channels_admin",CLOSED_CHANNELS_ADMIN:"closed_channels_admin",TV:"tv"},User.LoginPolicies=[{value:"RAINBOW",label:"rainbowLoginCredentials"},{value:"SAML",label:"ssoLoginCredentialsSAML",isSSO:!0},{value:"OIDC",label:"ssoLoginCredentialsOIDC",isSSO:!0},{value:"DEFAULT",label:"defaultLogin"}],User.attributes=[{name:"id",defaultValue:null},{name:"loginEmail",defaultValue:""},{name:"firstName",defaultValue:""},{name:"lastName",defaultValue:""},{name:"displayName",defaultValue:""},{name:"nickName",defaultValue:""},{name:"title",defaultValue:""},{name:"jobTitle",defaultValue:""},{name:"companyId",defaultValue:""},{name:"companyName",defaultValue:""},{name:"siteId",defaultValue:""},{name:"systemId",defaultValue:""},{name:"accountType",defaultValue:"free"},{name:"country",defaultValue:"FRA"},{name:"timezone",defaultValue:"Europe/Paris"},{name:"emails",defaultValue:[]},{name:"phoneNumbers",defaultValue:[]},{name:"roles",defaultValue:["user"]},{name:"adminType",defaultValue:"company_admin"},{name:"isActive",defaultValue:!1},{name:"isInitialized",defaultValue:!1},{name:"isTv",defaultValue:void 0},{name:"password",defaultValue:void 0},{name:"jid_im",defaultValue:""},{name:"jid_tel",defaultValue:""},{name:"language",defaultValue:"en"},{name:"lastAvatarUpdateDate",defaultValue:null},{name:"visibility",defaultValue:void 0},{name:"authenticationType",defaultValue:void 0},{name:"tags",defaultValue:void 0},{name:"userInfo1",defaultValue:void 0},{name:"userInfo2",defaultValue:void 0},{name:"fileSharingCustomisation",defaultValue:void 0},{name:"userTitleNameCustomisation",defaultValue:void 0},{name:"tryNewUiCustomisation",defaultValue:void 0},{name:"softphoneOnlyCustomisation",defaultValue:void 0}],User}]),angular.module("rainbow").filter("fileSharingCustomisationFilter",[function(){"use strict";return function(input){return"same_than_company"===input?"same_than_company":"enabled"===input?"authorized":"disabled"===input?"notAuthorized":input}}]),angular.module("rainbow").filter("userTitleNameCustomisationFilter",[function(){"use strict";return function(input){return"same_than_company"===input?"same_than_company":"enabled"===input?"authorized":"disabled"===input?"notAuthorized":input}}]),angular.module("rainbow").filter("tryNewUiCustomisationFilter",[function(){"use strict";return function(input){return input&&"same_than_company"!==input?"enabled"===input?"authorized":"disabled"===input?"notAuthorized":input:"same_than_company"}}]),angular.module("rainbow").filter("softphoneOnlyCustomisationFilter",[function(){"use strict";return function(input){return input&&"same_than_company"!==input?"enabled"===input?"softphoneOnly":"disabled"===input?"allServices":input:"same_than_company"}}])},function(module,exports){angular.module("rainbow").factory("Subscription",["Offer",function(Offer){"use strict";function Subscription(id,offerId,offerName,offerDescription,groupName,offerReference,profileId,profileName,maxNumberUsers,numberAssignedUsers,status,syncOngoing,updatingMaxNumberUsers,nbBPLicences,nbAssignedBPUsers,nbLicencesAssignedToECs,nbLicencesUsed,nbFreeLicences,businessModel,canBeSold,isDefault,isExclusive,isPrepaid,prepaidDuration,expirationDate,autoRenew,renewalTermOption,hasConference,hasVoice,isDemo,isChinaOffer){this.id=id,this.offerId=offerId,this.offerName=offerName||"",this.offerDescription=offerDescription||"Rainbow "+this.offerName,this.groupName=groupName||offerName,this.offerReference=offerReference,this.profileId=profileId,this.profileName=profileName,this.maxNumberUsers=maxNumberUsers,this.numberAssignedUsers=numberAssignedUsers,this.status=status,this.syncOngoing=syncOngoing||!1,this.updatingMaxNumberUsers=updatingMaxNumberUsers,void 0!==nbBPLicences&&(this.nbBPLicences=nbBPLicences),void 0!==nbAssignedBPUsers&&(this.nbAssignedBPUsers=nbAssignedBPUsers),void 0!==nbLicencesAssignedToECs&&(this.nbLicencesAssignedToECs=nbLicencesAssignedToECs),void 0!==nbLicencesUsed&&(this.nbLicencesUsed=nbLicencesUsed),void 0!==nbFreeLicences&&(this.nbFreeLicences=nbFreeLicences),this.businessModel=businessModel,this.canBeSold=canBeSold,this.isDefault=isDefault,this.isExclusive=isExclusive,this.isPrepaid=isPrepaid,this.prepaidDuration=prepaidDuration,this.expirationDate=expirationDate,this.autoRenew=autoRenew,this.renewalTermOption=renewalTermOption,this.hasConference=hasConference,this.hasVoice=hasVoice,this.isDemo=void 0===isDemo?!this.isDefault&&!this.canBeSold&&this.offerName.toLowerCase().includes("demo"):isDemo,this.isChinaOffer=isChinaOffer,this.isEnterprise=function(){return this.offerName.toLowerCase().startsWith("enterprise")},this.isBusiness=function(){return this.offerName.toLowerCase().startsWith("business")},this.isEssential=function(){return this.offerName.toLowerCase().startsWith("essential")},this.isTrial=function(){return this.isDemo},this.isTerminated=function(){return"terminated"===this.status},this.isTerminating=function(){return"terminating"===this.status},this.isUserLicense=function(){return this.isDefault||"nb_users"===this.businessModel||"usage"===this.businessModel}}return Subscription.createFromData=function(data){return new Subscription(data.id?data.id:data.subscriptionId,data.offerId,data.offerName,data.offerDescription,data.groupName,data.offerReference,data.profileId,data.profileName,data.maxNumberUsers,data.numberAssignedUsers,data.status,data.syncOngoing,data.updatingMaxNumberUsers,data.nbBPLicences,data.nbAssignedBPUsers,data.nbLicencesAssignedToECs,data.nbLicencesUsed,data.nbFreeLicences,data.businessModel,data.canBeSold,data.isDefault,data.isExclusive,data.isPrepaid,data.prepaidDuration,data.expirationDate,data.autoRenew,data.renewalTermOption,data.hasConference,data.hasVoice,data.isDemo,data.isChinaOffer)},Subscription.subscriptionComparator=function(subscription1,subscription2){var offer1=new Offer(subscription1.offerId,subscription1.offerName,subscription1.offerDescription,subscription1.groupName,subscription1.offerReference,subscription1.profileId,subscription1.canBeSold,subscription1.businessModel,subscription1.isDefault,subscription1.isExclusive,subscription1.isPrepaid,subscription1.prepaidDuration,subscription1.autoSubscribe,subscription1.hasConference,subscription1.hasVoice,subscription1.isDemo,subscription1.isBundle,subscription1.isChinaOffer),offer2=new Offer(subscription2.offerId,subscription2.offerName,subscription2.offerDescription,subscription2.groupName,subscription2.offerReference,subscription2.profileId,subscription2.canBeSold,subscription2.businessModel,subscription2.isDefault,subscription2.isExclusive,subscription2.isPrepaid,subscription2.prepaidDuration,subscription2.autoSubscribe,subscription2.hasConference,subscription2.hasVoice,subscription2.isDemo,subscription2.isBundle,subscription2.isChinaOffer);return Offer.offerComparator(offer1,offer2)},Subscription.isUserLicense=function(subscription){return subscription.isDefault||"nb_users"===subscription.businessModel||"usage"===subscription.businessModel},Subscription.isTvLicense=function(subscription){return"Room"===subscription.groupName},Subscription.excludeTvLicense=function(subscription){return!Subscription.isTvLicense(subscription)},Subscription.isExclusive=function(subscription){return subscription.isDefault||subscription.isExclusive},Subscription.isOptional=function(subscription){return!Subscription.isExclusive(subscription)},Subscription.isConference=function(subscription){return Subscription.isOptional(subscription)&&(subscription.hasConference||"usage"===subscription.businessModel)},Subscription.isNotConference=function(subscription){return Subscription.isOptional(subscription)&&!(subscription.hasConference||"usage"===subscription.businessModel)},Subscription.withLicenses=function(subscription){return subscription.isDefault||"usage"===subscription.businessModel||"nb_users"===subscription.businessModel&&subscription.maxNumberUsers>0},Subscription.isPrepaid=function(subscription){return subscription.isPrepaid},Subscription.isMonthly=function(subscription){return!subscription.isPrepaid},Subscription}])},function(module,exports){angular.module("rainbow").factory("IceServer",[function(){"use strict";function IceServer(id,urls,username,credential){this.id=id,this.urls=urls,this.username=username,this.credential=credential}return IceServer.createFromData=function(data){return new IceServer(data.id,data.urls,data.username,data.credential)},IceServer}])},function(module,exports){angular.module("rainbow").factory("PhoneNumber",[function(){"use strict";function PhoneNumber(id,shortNumber,number,numberE164,pbxUserId,userId,type,deviceType,pbxId,isFromSystem,isMonitored,systemId,country,voiceMailNumber,deviceName,firstName,lastName,internalNumber,isCloudPbxDDI,isCloudPbxDefault,password){this.id=id,this.shortNumber=shortNumber,this.number=number,this.numberE164=numberE164,this.pbxUserId=pbxUserId,this.userId=userId,this.type=type,this.deviceType=deviceType,this.pbxId=pbxId,this.isFromSystem=isFromSystem,this.isMonitored=isMonitored,this.systemId=systemId,this.country=country,this.voiceMailNumber=voiceMailNumber,this.deviceName=deviceName,this.firstName=firstName,this.lastName=lastName,this.internalNumber=internalNumber,angular.isDefined(isCloudPbxDDI)&&(this.isCloudPbxDDI=isCloudPbxDDI),angular.isDefined(isCloudPbxDefault)&&(this.isCloudPbxDefault=isCloudPbxDefault),password&&(this.password=password)}return PhoneNumber.SelectTypeEnum={EXTENSION:"extension",EXTENSION_CLOUD:"extension-cloud",GROUP_CLOUD:"group-cloud",DDI_CLOUD:"ddi-cloud",FREE_DDI_CLOUD:"free-ddi-cloud",FREE_DDI_GROUP_CLOUD:"free-ddi-group-cloud"},PhoneNumber.createFromData=function(data){return new PhoneNumber(data.id?data.id:data.phoneNumberId,data.shortNumber,data.number,data.numberE164,data.pbxUserId,data.userId,data.type,data.deviceType,data.pbxId,data.isFromSystem,data.isMonitored,data.systemId,data.country,data.voiceMailNumber,data.deviceName,data.firstName,data.lastName,data.internalNumber,data.isCloudPbxDDI,data.isCloudPbxDefault,data.password)},PhoneNumber}])},function(module,exports){angular.module("rainbow").service("helpersService",[function(){"use strict";this.chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",this.findIndex=function(array,predicate){return array.findIndex(predicate)},this.checkBrowser=function(browser){return-1!==navigator.userAgent.indexOf(browser)},this.randomString=function(length){length=length||10;for(var rnd,string="";length>0;)rnd=Math.floor(Math.random()*this.chars.length),string+=this.chars.charAt(rnd),length--;return string}}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var crypto_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3);angular.module("rainbow").service("userInfoService",["$q","$log","$interval","$rootScope","settingsService",function($q,$log,$interval,$rootScope,settingsService){var service=this;service.userColors=["#ff4500","#d38700","#348833","#007356","#00b2a9","#00b0e5","#0085ca","#6639b7","#91278a","#cf0072","#a50034","#d20000"],service.getAvatarImage=function(objId,initials,color,size,lastAvatarUpdate){return $q((function(resolve){lastAvatarUpdate=void 0!==lastAvatarUpdate&&lastAvatarUpdate;var defaultAvatarImage=initials?service.createDefaultAvatarImage(initials,color):null;if(lastAvatarUpdate){var serverURL=config.webservices.protocol+"://"+config.webservices.currentServer;$rootScope.cdn&&(serverURL=$rootScope.cdnServer);var imgSrc=serverURL+"/api/avatar/"+objId+"?size="+(size||256);lastAvatarUpdate&&(imgSrc+="&update="+Object(crypto_js__WEBPACK_IMPORTED_MODULE_0__.MD5)(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Latin1.parse(lastAvatarUpdate)).toString(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Hex));var image=new Image;image.onload=function(){var loadedImage=this;$interval((function(){$log.log("[avatarService] Load avatar for "+objId+" success"),resolve(loadedImage)}),1,1)},image.onerror=function(){$interval((function(){$log.warn("[avatarService] Load avatar for "+objId+" failure : use text avatar"),resolve(defaultAvatarImage)}),1,1)},image.src=imgSrc}else resolve(defaultAvatarImage)}))},service.getNameInformation=function(firstName,lastName){var result={displayName:"",initials:""};return 1!==lastName.length&&2!==firstName.length?"FL"===settingsService.getSetting("displayOrder")?(result.displayName=firstName+" "+lastName,result.initials=firstName.charAt(0).toUpperCase()+lastName.charAt(0).toUpperCase()):(result.displayName=lastName+" "+firstName,result.initials=lastName.charAt(0).toUpperCase()+firstName.charAt(0).toUpperCase()):("FL"===settingsService.getSetting("displayOrder")?result.displayName=firstName+" "+lastName:result.displayName=lastName+" "+firstName,result.initials=firstName.charAt(0).toUpperCase()+firstName.charAt(1).toUpperCase()),result},service.createDefaultAvatarImage=function(initials,color){var image=new Image,canvas=document.createElement("canvas");canvas.width=image.width=225,canvas.height=image.height=225;var ctx=canvas.getContext("2d");return ctx.rect(0,0,225,225),ctx.fillStyle=color,ctx.fill(),ctx.font="bold 100px Helvetica",ctx.textAlign="center",ctx.fillStyle="white",ctx.fillText(initials,110,150),image.src=canvas.toDataURL("image/png"),image},service.computeUserColor=function(displayName){try{for(var result={colorIndex:0,color:service.userColors[0]},upperCaseDisplayName=displayName.toUpperCase(),sum=0,i=0;i<upperCaseDisplayName.length;i++)sum+=upperCaseDisplayName.charCodeAt(i);result.colorIndex=sum%12,result.color=service.userColors[result.colorIndex]}catch(error){$log.error("[UserInfoService] computeUserColor failure"),result.colorIndex=1,result.color=service.userColors[result.colorIndex]}return result}}])},function(module,exports){angular.module("rainbow").service("errorHelperService",["$filter",function($filter){"use strict";var service=this;service.ErrorCodeLabels={"-1":"unknownError",0:"errorNoServerResponse",400:"Bad request",4e5:"Bad request",400210:"invalidPhoneNumber",400400:"errorWrongPassword",400500:"invalidFile",400504:"companyNameAlreadyExist",400505:"BPCompanyWithoutPaymentConfigurationData",400506:"NoActiveSubscriptionToOffer",400511:"ActiveDirectoryDomainAlreadyUsed",400552:"BPCompanyAndECCompanyMustNotBeSame",400601:"outboundAndInternalPrefixesCantBeIdentical",400973:"noCreateUserPermission",400975:"userAlreadyExistsInOtherCompany",400983:"userAlreadyExistsInOtherCompany",400990:"noUserFound",400993:"noUserFound",401:"Authorization failure",401102:"Authorization failure",401202:"errorInvalidToken",401500:"errorUnauthorized",401501:"errorLoginForbidden",401510:"errorUnauthorized",401520:"errorUserNotActive",401521:"errorUserNotActive",403:"Forbidden",403e3:"accessDeniedNotRequiredRole",403001:"accessDeniedNotOwner",403034:"cantDeselectDefaultWebRTCGateway",403035:"cantDeleteDefaultWebRTCGateway",403060:"confLockMsg",403072:"errorIsoMd5Mismatch",403200:"notAllowedToChangeRole",403203:"notAllowedToChangeRole",403204:"notAllowedToMoveExistingUserToThisCompany",403205:"notAllowedToManageUser",403301:"notAllowedToManageCompany",403304:"notAllowedToAddAnotherAdmin",403311:"errorRemoveSyncOngoingSubscriptionForbidden",403315:"errorRemoveSubscriptionForbidden",403316:"errorRemoveAdminAllocatedSubscriptionForbidden",403317:"errorRemoveClientAllocatedSubscriptionForbidden",403500:"notAllowedBlacklistedEmail",403501:"notAllowedBlacklistedEmail",403503:"NotAllowedSelfRegistrationEmail",403504:"notAllowedLoggedInUserEmail",403507:"notAllowedSupportEmail",403513:"companyNotABpCompany",403516:"companyNotABpCompany",403517:"companySeenAsTerminated",403518:"companyBpTypeIncompatible",403519:"companyAlreadyLinkedToBp",403520:"companyNotVadBp",403526:"isolatedUser",403531:"resetPasswordBlocked",403532:"resetPasswordForbidden",403608:"errorAssignSubscriptionSyncOngoing",403609:"errorAssignSubscriptionSyncOngoing",403610:"maxSubscriptionAllocationReached",403611:"notAllowedToCreateAnEquipment",403615:"maximumNumberConferenceParticipantsReach",403616:"subscriptionCompanyAdminEssentialAlreadyExists",403617:"roleCompanyAdminEssentialAlreadyExists",403620:"MaximumNumberRoomUsersReach",403621:"MaximumNumberConvUsersReach",403624:"notAllowedRemoveService",403625:"errorAllocatedSubscriptionRemoveForbidden",403626:"restrictedConvAccess",403630:"uploadErrorMaxQuotaReached",403655:"userAlreadyCompanyMember",403700:"errorDeleteSiteWithSystems",403701:"errorDeleteOrganisationLinkedCompany",403702:"errorDeleteCompanyWithSubscriptions",403703:"errorDeleteCompanyWithSites",403704:"errorDeleteCompanyWithUsers",403705:"errorDeleteCompanyStillTerminated",403706:"errorRemoveBusinessPartnerRole",403719:"externalTrunkChangeForbidden",403721:"numberingPlanCantBeUpdated",403722:"outgoingPrefixChangeForbidden",403723:"cannotRemoveCompanyPublicNumber",403724:"notAllowedDeleteCloudPbxWithPublicNumbers",403725:"notAllowedDeleteCloudPbxWithUsedExtensions",404:"resourceNotFound",404e3:"resourceNotFound",404001:"resourceNotFoundUpdateImpossible",404002:"resourceNotFoundDeleteImpossible",404116:"archivedOrDeletedConversation",404300:"noValidOfferReferenceInACTISFile",404301:"offerNotFound",409e3:"userAlreadyCreated",409011:"noMessagesToExport",409552:"internalNumberAlreadyUsed",409555:"sipDeviceAlreadyExistsWithMacAddress",409557:"notAllowedDeleteUserAssociatedToCloudPbx",409600:"userAlreadyExist",409601:"invitationReSentConflict",409602:"userAlreadyNetworkMember",409603:"invitationReSentConflict",409620:"offerAlreadySubscribed",409623:"conferenceOfferAlreadySubscribed",409625:"errorUpdateSyncOngoingSubscriptionForbidden",409800:"companyNotIrBp",409801:"companyNotLinkedToBp",409802:"actisCompanyAdminMismatch",409803:"actisCompanyNameMismatch",413e3:"uploadErrorTooLarge",500:"errorInternalServerError",1001:"extensionNotLinkedToEquipment",1002:"extensionHasNoIdentifier",1003:"extensionDoesNotExist",1004:"extensionLookupFailure",1005:"extensionConflict",1006:"nonUniqueEquipmentForExtension",1007:"userAlreadyAssociatedToExtension",1008:"extensionAssociatedToAnotherUser",1009:"failedToAttachExtension",1010:"userHasNoExtension",1011:"userHasTooManyExtensions",1012:"failedToDetachExtension"},service.portalErrorCodeLabels={massprovisioning:{4e5:"invalidValue",400501:"invalidFile",400502:"invalidColumnName",400504:"invalidFile",400506:"invalidValueInActionColumn",400600:"deviceTypeCannotBeUpdated",400601:"duplicateDeviceIds",400602:"duplicateMacAdresses",400603:"invalidDeviceTypes",400604:"missingDeviceTypeInLines",400605:"invalidEquipment",403610:"errorMaxSubscriptionReached",404600:"deviceDoesNotExist",404601:"noCloudPbxInCompany"},rvcpprovisioning:{403622:"noVoiceLicenceAllocatedToUser",403728:"forbiddenOperationEquipmentHasDevices",409556:"companyHasAlreadyACloudPbx"},authentication:{401102:"Authorization failure",401103:"Authorization failure",401500:"Authorization failure",401520:"Forbidden",401521:"Forbidden",401522:"Forbidden",401523:"Forbidden",401530:"Authorization failure",401600:"Authorization failure",401700:"Authorization failure",403e3:"Authorization failure",5e5:"errorInternalServerError",503e3:"resourceNotFound"}},service.handleErrorMessage=function(response,context){service.getErrorFullMessage(response,context)},service.handleError=function(response,params){var portal=service.getPortal(response),errorDetailsCode=response.status;response.data&&response.data.errorDetailsCode&&(errorDetailsCode=response.data.errorDetailsCode);var error=new Error(service.getDetailedErrorMessage(response));return error.status=response.status,error.fieldErrors=service.getBadRequestFieldErrors(response),error.errorDetailsCode=errorDetailsCode,error.errorDetailsLabel=service.getErrorCodeLabel(errorDetailsCode,portal),error.translatedMessage=service.getTranslatedErrorMessage(response,params,portal),error.portal=portal,error},service.getPortal=function(response){var url=response.config?response.config.url:void 0,res=url?url.match(/api\/rainbow\/(\w+)\//):void 0;return res?res[1]:void 0},service.getBadRequestFieldErrors=function(response){var fieldErrors={};if(400===response.status){if(response.data&&response.data.errorDetails instanceof Array)response.data.errorDetails.forEach((function(details){fieldErrors[details.param]||(fieldErrors[details.param]={ok:!1,message:details.msg,value:details.value})}));else if(response.data&&response.data.errorDetails&&response.data.errorDetails.param){var details=response.data.errorDetails;fieldErrors[details.param]={ok:!1,message:details.msg,value:details.value}}response.data&&400511===response.data.errorDetailsCode&&(fieldErrors.office365Tenant={ok:!1,message:service.ErrorCodeLabels[400511]}),response.data&&400601===response.data.errorDetailsCode&&(fieldErrors.outgoingPrefix={ok:!1,message:service.ErrorCodeLabels[400601]},fieldErrors.numberingPrefix={ok:!1,message:service.ErrorCodeLabels[400601]})}return fieldErrors},service.getErrorMessage=function(response){var errorMessage=service.getStatusErrorMessage(response);return response.data&&response.data.errorMsg&&(errorMessage="",response.data.errorDetails?response.data.errorDetails instanceof Array?errorMessage+="one or more fields are invalid":response.data.errorDetails.msg?errorMessage+=response.data.errorDetails.msg:errorMessage+=response.data.errorDetails:errorMessage+=response.data.errorMsg),errorMessage},service.getStatusErrorMessage=function(response){return 500===response.status?"Internal server error":415===response.status?"Unsupported Media Type":413===response.status?"Request Entity Too Large":404===response.status?"Resource not found":403===response.status?"Access is forbidden":401===response.status?"Authorization failure":400===response.status?"Bad request":response.statusText?response.statusText:"Unknown error"},service.getDetailedErrorMessage=function(response){var errorMessage=service.getErrorMessage(response);return response.data&&response.data.errorDetails&&response.data.errorDetails instanceof Array&&response.data.errorDetails.length>0&&(errorMessage+=" : "+response.data.errorDetails[0].msg),errorMessage},service.getTranslatedErrorMessage=function(response,params,portal){if(500===response.status)return service.getLocalizedError("500");var errorDetailsCode=null;response.data&&response.data.errorDetailsCode&&(errorDetailsCode=response.data.errorDetailsCode);var errorDetailsData=null;return errorDetailsData=response.data&&response.data.errorDetailsData?Object.assign(response.data.errorDetailsData,params):params,service.getTranslatedErrorMessageByDetailsCode(errorDetailsCode,errorDetailsData,service.getErrorMessage(response),portal)},service.getTranslatedErrorMessageByDetailsCode=function(errorDetailsCode,errorDetailsParams,errorInfoMessage,portal){var errorMessage;return errorDetailsCode&&(errorMessage=service.getLocalizedError(errorDetailsCode,errorDetailsParams,portal)),errorMessage||(errorMessage=errorDetailsCode?$filter("translate")("anErrorOccurred",{errorcode:errorDetailsCode}):$filter("translate")("anErrorOccurred"),errorInfoMessage&&(errorMessage+=" ("+$filter("translate")(errorInfoMessage)+")")),errorMessage},service.getLocalizedError=function(errorCode,params,portal){var errorMessage;if(errorCode){var errorLabel=service.getErrorCodeLabel(errorCode,portal);if(errorLabel){var translation=$filter("translate")(errorLabel,params);translation!==errorLabel&&(errorMessage=translation)}}return errorMessage},service.getErrorCodeLabel=function(errorCode,portal){return portal&&service.portalErrorCodeLabels[portal]&&service.portalErrorCodeLabels[portal][errorCode]?service.portalErrorCodeLabels[portal][errorCode]:service.ErrorCodeLabels[errorCode]},service.getErrorFullMessage=function(response,context){var errorMessage=context?context+" failure : ":"";return response&&response.data?(errorMessage+=response.data.errorMsg,response.data.errorDetails&&(errorMessage+=" - ",response.data.errorDetails instanceof Array?response.data.errorDetails.forEach((function(details){errorMessage+=details.msg})):response.data.errorDetails.msg?errorMessage+=JSON.stringify(response.data.errorDetails.msg):errorMessage+=response.data.errorDetails)):errorMessage+="Unknow error - Something goes really wrong",errorMessage}}])},function(module,exports){angular.module("rainbow").service("pushImageHelperService",["$log","$q","$http","authService","errorHelperService",function($log,$q,$http,authService,errorHelperService){"use strict";var service=this;service.pushImage=function(pushServiceURL,avatarImg,params){return $q((function(resolve,reject){var resizePromise=null;if(params&&params.nosize)resizePromise=function(){var image=new Image;return image.src=avatarImg,$q.when(image)};else{var width=params&&params.width?params.width:512,height=params&&params.height?params.height:512;resizePromise=function(){return service.resizeImage(avatarImg,width,height)}}resizePromise().then((function(resizedImage){var binaryData=service.getBinaryData(resizedImage);$http({method:"POST",url:pushServiceURL,headers:authService.getPostHeader("image/"+binaryData.type),data:binaryData.data,transformRequest:[]}).then((function(){$log.info("[pushImageHelperService] pushImage : success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[pushImageHelperService] "+errorHelperService.getErrorFullMessage(response,"pushImage"))}))}))}))},service.resizeImage=function(avatarImg,maxWidth,maxHeight){return $q((function(resolve){var image=new Image;image.src=avatarImg,image.onload=function(){var imageWidth=image.width,imageHeight=image.height;imageWidth>imageHeight?imageWidth>maxWidth&&(imageHeight*=maxWidth/imageWidth,imageWidth=maxWidth):imageHeight>maxHeight&&(imageWidth*=maxHeight/imageHeight,imageHeight=maxHeight);var canvas=document.createElement("canvas");canvas.width=imageWidth,canvas.height=imageHeight,image.width=imageWidth,image.height=imageHeight,canvas.getContext("2d").drawImage(this,0,0,imageWidth,imageHeight);var resizedImage=new Image;resizedImage.src=canvas.toDataURL("image/png"),resolve(resizedImage)}}))},service.getBinaryData=function(image){for(var typeIndex=image.src.indexOf("image/")+6,binaryIndex=image.src.indexOf(";base64,"),binaryData=image.src.slice(binaryIndex+8),imageType=image.src.slice(typeIndex,binaryIndex),binary_string=window.atob(binaryData),len=binary_string.length,bytes=new Uint8Array(len),i=0;i<len;i++)bytes[i]=binary_string.charCodeAt(i);return{type:imageType,data:bytes}}}])},function(module,exports){angular.module("rainbow").service("$localStorage",["$q",function($q){"use strict";this.get=function(keys){for(var result={},i=0;i<keys.length;i++)result[keys[i]]=localStorage.getItem(keys[i]);return $q.when(result)},this.set=function(object){for(var keys=Object.keys(object),i=0;i<keys.length;i++)localStorage.setItem(keys[i],object[keys[i]]);return $q.when()},this.remove=function(keys){for(var i=0;i<keys.length;i++)localStorage.removeItem(keys[i]);return $q.when()}}])},function(module,exports){angular.module("rainbow").service("authService",["$http","$q","$window","$log","$localStorage","$interval","$rootScope","$translate","jwtHelper","settingsService","AuthSettings",function($http,$q,$window,$log,$localStorage,$interval,$rootScope,$translate,jwtHelper,settingsService,AuthSettings){"use strict";var service=this;try{window.SHA256=CryptoJS.SHA256}catch(e){}service.onInit=function(){$log.info("[authService] === INITIALIZATION ==="),service.SSO_LOGIN_POPUP_WINDOW_NAME="Single Sign-On Login",service.login=null,service.token=null,service.jidIm=null,service.jidTel=null,service.jidPwd=null,service.initialized=null,service.renewAppTokenInterval=null,service.renewTokenInterval=null,service.userData=null,service.firstUse=null===localStorage.getItem("firstUse"),service.browserFingerprint=null,service.isGuest=!1,service.logingItself=!1,service.trueLoging=!1,config.appModuleKey||(config.appModuleKey=angular.module("rainbow").moduleIds?angular.module("rainbow").moduleIds.join(""):"default"),service.sdkHostForced=null,service.appToken=null,service.fromSDK=!1,service.firstUseNewVersion=!1;var storedVersion=localStorage.getItem("version");service.getMajorVersion(storedVersion)!==service.getMajorVersion(version)&&(service.firstUseNewVersion=!0),$localStorage.set({version:version})},service.getMajorVersion=function(version){if(!version)return null;var result=/\d+\.\d+/g.exec(version);return result&&result.length>0?result[0]:null},service.registerEventsHandler=function(){service.visibilityHandlerRemoval&&service.visibilityHandlerRemoval(),service.visibilityHandlerRemoval=$rootScope.$on("ON_APP_VISIBLE_CHANGE_EVENT",(function(__event,visible){visible&&service.startTokenSurvey()}))},service.isInitialized=function(){return service.initialized},service.isFirstUse=function(){return service.firstUse},service.getRequestHeader=function(){var headers={Authorization:"Bearer "+service.token,Accept:"application/json"};return service.fromSDK&&service.appToken,headers},service.getRequestHeaderWithRange=function(range){var header=service.getRequestHeader();return header.Range=range,header},service.getPostHeader=function(contentType){var header=service.getRequestHeader(),type=contentType||"application/json";return header["Content-Type"]=type,header},service.getPostHeaderWithRange=function(range,contentType){var header=service.getPostHeader(contentType);return header["Content-Range"]=range,header},service.authenticateOnHost=function(login,password,host,appToken,token){return service.sdkHostForced=host,service.appToken=appToken,service.fromSDK=!0,token?(config.xmpp.currentServer=service.sdkHostForced,config.webservices.currentServer=service.sdkHostForced,config.restServerUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port,service.authenticateWithToken(token)):service.authenticate(login,password,!1)},service.authenticate=function(login,password,rememberMe,authSettings){return $q((function(resolve,reject){if($log.info('[authService] authenticate with "'+login+'"'),service.validateLogin(login))service.getLocalStorageAuthInfo(!1).then((function(){return service.logon(login,password,rememberMe,authSettings)})).then((function(){service.registerEventsHandler(),resolve()})).catch((function(error){$log.error("[authService] authenticate failure -- "+error.message),reject(error)}));else{reject(new RBError('authenticate for login "'+login+'" failure : ',"errorUnauthorized",401500,null))}}))},service.getUserEnvironments=function(login){return config.multiEnvServer?new Promise((function(resolve){config.defaultEnvironment||(config.defaultEnvironment=config.xmpp.server);var url=config.webservices.protocol+"://"+config.multiEnvServer+":"+config.webservices.port+"/api/rainbow/multienvironments/v1.0/environments?loginEmail="+encodeURIComponent(login);$http({method:"GET",url:url,timeout:15e3}).then((function(response){response&&response.data&&response.data.data&&resolve(response.data.data)})).catch((function(error){var errorMessage='getUserEnvironments for login "'+login+'" failure : ';error||(errorMessage+="Ultimate unknown error"),0===error.status||-1===error.status?errorMessage+="No server response":500===error.status&&(errorMessage+=error.data.errorDetails),$log.info("[authService] "+errorMessage),$log.info("[authService] getUserEnvironment -- continue with default environment"),resolve()}))})):Promise.resolve([{environmentApiUrl:"https://"+config.xmpp.server}])},service.getUserAuthenticationSettings=function(login,inAppAuth){return $q((function(resolve,reject){var defaultLoginUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/authentication/v1.0/login";if(inAppAuth){var authSettings=AuthSettings.createFromData([{type:"RAINBOW",loginUrl:defaultLoginUrl}]);resolve(authSettings)}else{var headers={};service.setInformationHeaders(headers),$http({method:"GET",url:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/authentication/v1.0/urls?uid="+encodeURIComponent(login),headers:headers,timeout:15e3}).then((function(response){var authSettings=AuthSettings.createFromData(response.data.data);authSettings.setParameter("uid",(function(){return login})),authSettings.setParameter("x-rainbow-app-auth",service.getRainbowAppAuth.bind(this,config.rainbowApiClientKey,config.appModuleKey)),!$window||-1===$window.location.href.indexOf("localhost")&&-1===$window.location.href.indexOf("openrainbow.red")||authSettings.setParameter("safetyUrl",(function(){return defaultLoginUrl})),resolve(authSettings)}),(function(response){var errorMessage='authenticate for login "'+login+'" failure : ',errorStatus="errorUltimateUnknownError";response||(errorMessage+="Ultimate unknown error"),0===response.status||-1===response.status?(errorMessage+="No server response",errorStatus="errorNoServerResponse"):400===response.status||404===response.status?(errorMessage+=response.data.errorDetails,errorStatus="noMatchingAccount"):500===response.status&&(errorMessage+=response.data.errorDetails,errorStatus="errorInternalServerError"),$log.info("[authService] "+errorMessage),reject(new RBError(errorMessage,errorStatus))}))}}))},service.getBasicAuthorizationCredentials=function(login,password){return $window.btoa(unescape(encodeURIComponent((login||"")+":"+(password||""))))},service.getRainbowAppAuth=function(appId,appSecret,password){return $window.btoa(unescape(encodeURIComponent((appId||"")+":"+SHA256((appSecret||"")+(password||"")))))},service.logon=function(login,password,rememberMe,authSettings){return $q((function(resolve,reject){var headers={Authorization:"Basic "+$window.btoa(unescape(encodeURIComponent(login+":"+password))),Accept:"application/json"};service.setInformationHeaders(headers),config.rainbowApiClientKey&&(headers["x-rainbow-app-auth"]="Basic "+$window.btoa(unescape(encodeURIComponent(config.rainbowApiClientKey+":"+SHA256(config.appModuleKey+password))))),service.fromSDK&&service.appToken&&service.appToken.appID&&(headers["x-rainbow-app-auth"]="Basic "+$window.btoa(unescape(encodeURIComponent(service.appToken.appID+":"+SHA256(service.appToken.appSecret+password)))));var url=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/authentication/v1.0/login";if(authSettings)switch(authSettings.type){case"RAINBOW":url=authSettings.loginUrl;break;case"SAML":case"OIDC":default:authSettings.safetyUrl&&(url=authSettings.safetyUrl)}$http({method:"GET",withCredentials:!0,url:url,headers:headers,timeout:15e3}).then((function(response){$log.info('[authService] authenticate with "'+login+'" success'),$rootScope.disconnected=!1,service.userData=response.data.loggedInUser,service.token=response.data.token,service.userId=response.data.loggedInUser.id,service.login=response.data.loggedInUser.loginEmail,service.jidIm=response.data.loggedInUser.jid_im,service.jidTel=response.data.loggedInUser.jid_tel,service.jidPwd=response.data.loggedInUser.jid_password,service.initialized=response.data.loggedInUser.isInitialized,service.companyId=response.data.loggedInUser.companyId,service.logingItself=!0,service.trueLoging=!0,service.isGuest=response.data.loggedInUser.guestMode,service.creationDate=response.data.loggedInUser.creationDate,service.xmppDomain=service.jidIm.split("@")[1],service.handleUserLanguage(),$localStorage.get(["firstUse"]).then((function(result){"false"!==result.firstUse&&!1!==result.firstUse||(service.firstUse=!1)})),$localStorage.set({firstUse:"false"}),service.rememberMe=rememberMe,rememberMe?($log.info("[authService] store credentials"),$localStorage.set({token:service.token,login:service.login,id:service.userId})):service.removeCredentials(),service.startTokenSurvey(),resolve()}),(function(response){var errorCode,errorData,errorMessage='authenticate for login "'+login+'" failure : ',errorStatus="errorUltimateUnknownError";response||(errorMessage+="Ultimate unknown error"),0===response.status||-1===response.status?(errorMessage+="No server response",errorStatus="errorNoServerResponse"):401===response.status?(service.removeCredentials(),errorMessage+=response.data.errorDetails,errorCode=response.data.errorDetailsCode,401500===response.data.errorDetailsCode?errorStatus=$translate.instant("errorUnauthorized"):401501===response.data.errorDetailsCode&&(errorStatus="errorLoginForbidden",response.data.errorDetailsData&&(errorData={delay:response.data.errorDetailsData.forbiddenDelay}))):500===response.status&&(errorMessage+=response.data.errorDetails,errorStatus="errorInternalServerError"),$log.info("[authService] "+errorMessage),reject(new RBError(errorMessage,errorStatus,errorCode,errorData))}))}))},service.logout=function(){return $q((function(resolve,reject){var authType=localStorage.getItem("authType");service.removeCredentials(),service.authSettings&&service.authSettings.logoutUrl&&authType&&"RAINBOW"!==authType?($log.info("[authService] logout "+authType),service.authSettings.setParameter("token",(function(){return service.token})),resolve(service.authSettings.logoutUrl)):($log.info("[authService] logout"),resolve())}))},service.setInformationHeaders=function(headers){headers["x-rainbow-client"]=service.getInformationHeadersApp(),headers["x-rainbow-client-version"]=service.getInformationHeadersAppVersion()},service.getInformationHeadersApp=function(){return"web_sdk"},service.getInformationHeadersAppVersion=function(){return window.sdkversion?window.sdkversion:"9.9.99"},service.authenticateWithToken=function(strToken,rememberMe){return $q((function(resolve,reject){if(strToken){var decodedToken=jwtHelper.decodeToken(strToken);if(service.token=strToken,service.login=decodedToken.user.loginEmail,service.userId=decodedToken.user.id,decodedToken.saml)var authType="SAML";if(decodedToken.oidc)authType="OIDC";rememberMe||authType&&"RAINBOW"!==authType?($log.info("[authService] store credentials"),$localStorage.set({token:service.token,login:service.login,id:service.userId,authType:authType})):service.removeCredentials(),service.startTokenSurvey().then((function(){return service.getUserData()})).then((function(){return service.getUserAuthenticationSettings(service.login)})).then((function(authSettings){service.authSettings=authSettings})).then((function(){service.registerEventsHandler(),resolve()})).catch((function(error){var errorMessage=error?error.message:"unknown error";$log.error("[authService] authenticateWithToken failure -- "+errorMessage),reject(new Error(errorMessage))}))}else reject(new Error("No token provided"))}))},service.authenticateWithProvidedCredentials=function(token){return token?service.getLocalStorageAuthInfo(!1).then((function(){return service.authenticateWithToken(token,service.rememberMe)})):service.authenticateWithLocalCredentials()},service.authenticateWithLocalCredentials=function(email){return $q((function(resolve,reject){service.getLocalStorageAuthInfo(!0).then((function(){return email&&service.login!==email?$q.reject(new Error("Login account mismatch")):$q.resolve()})).then((function(){return service.startTokenSurvey()})).then((function(){return service.getUserData()})).then((function(){return service.getUserAuthenticationSettings(service.login)})).then((function(authSettings){service.authSettings=authSettings})).then((function(){service.registerEventsHandler(),resolve()})).catch((function(error){$log.error("[authService] authenticateWithLocalCredentials failure -- "+error.message),reject(error)}))}))},service.getLocalStorageAuthInfo=function(getToken){return $q((function(resolve,reject){$localStorage.get(["token","appToken","login","server","support","id","rememberMe","userEnvironment"]).then((function(result){$log.info("[authService] get authentication token"),result.server&&"null"!==result.server&&"undefined"!==result.server?(config.xmpp.currentServer=result.server,config.webservices.currentServer=result.server,"openrainbow.net"===result.server&&(config.appModuleKey=config.dotNetAppModuleKey,config.rainbowApiClientKey=config.dotNetRainbowApiClientKey,config.multiEnvServer="openrainbow.net"),"openrainbow.com"===result.server&&(config.appModuleKey=config.dotComAppModuleKey,config.rainbowApiClientKey=config.dotComRainbowApiClientKey,config.multiEnvServer="openrainbow.com"),config.defaultEnvironment||(config.defaultEnvironment=config.xmpp.currentServer)):service.sdkHostForced?(config.xmpp.currentServer=service.sdkHostForced,config.webservices.currentServer=service.sdkHostForced):(config.xmpp.currentServer=config.xmpp.server,config.webservices.currentServer=config.webservices.server),result.userEnvironment&&(config.defaultEnvironment||(config.defaultEnvironment=config.xmpp.server),$log.info("[authService] getUserEnvironment from local storage -- "+result.userEnvironment),config.xmpp.currentServer=result.userEnvironment,config.xmpp.server=result.userEnvironment,config.webservices.currentServer=result.userEnvironment,config.webservices.server=result.userEnvironment),config.restServerUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port,service.rememberMe=result.rememberMe,service.logingItself=!0,getToken?(service.token=result.token,service.appToken=result.appToken,service.login=result.login,service.userId=result.id,service.token&&service.login?resolve():reject(new Error("No existing token"))):resolve()}))}))},service.startTokenSurvey=function(){return $q((function(resolve,reject){service.startAppTokenSurvey().then((function(){return service.startUserTokenSurvey()})).then((function(){$log.debug("[authService] startTokenSurvey success"),resolve()})).catch((function(error){error&&error.message||(error=new Error("Unknown error")),$log.error("[authService] startTokenSurvey failure -- "+error.message),reject(error)}))}))},service.startUserTokenSurvey=function(first){var decodedToken=jwtHelper.decodeToken(service.token),tokenExpirationTimestamp=1e3*decodedToken.exp,halfTokenDuration=(tokenExpirationTimestamp-1e3*decodedToken.iat)/2,expirationDate=new Date(tokenExpirationTimestamp),tokenExpirationDuration=tokenExpirationTimestamp-(new Date).valueOf();if(first&&$log.info("[authService] on logon"),$log.info("[authService] Extract auth token info (countRenewed: "+decodedToken.countRenewed+", maxTokenRenew: "+decodedToken.maxTokenRenew+", tokenExpirationDuration: "+tokenExpirationDuration+")"),tokenExpirationDuration<0)return $log.info("[authService] auth token has already expired, display login page"),service.renewTokenInterval&&$interval.cancel(service.renewTokenInterval),service.token=null,$rootScope.$broadcast("ON_AUTH_TOKEN_EXPIRE"),$q.reject(new Error("Token expired"));if(tokenExpirationDuration<halfTokenDuration)return $log.info("[authService] auth token will expire in less "+halfTokenDuration/1e3+" seconds, re-new it immediately"),service.renewAuthToken();var usedExpirationDuration=tokenExpirationDuration-halfTokenDuration;return $log.info("[authService] start auth token survey (expirationDate: "+expirationDate+" tokenExpirationDuration: "+tokenExpirationDuration+"ms usedExpirationDuration: "+usedExpirationDuration+"ms)"),service.renewTokenInterval&&$interval.cancel(service.renewTokenInterval),service.renewTokenInterval=$interval((function(){service.renewAuthToken()}),usedExpirationDuration),$q.resolve()},service.renewAuthToken=function(restartTokenSurvey){return $q((function(resolve,reject){$log.info("[authService] re-new authentication token"),$http({method:"GET",url:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/authentication/v1.0/renew",headers:service.getRequestHeader()}).then((function(response){$log.info("[authService] renew authentication token success"),service.token=response.data.token,$localStorage.set({token:service.token}),$rootScope.$broadcast("ON_AUTH_TOKEN_RENEW"),restartTokenSurvey&&!0!==restartTokenSurvey||service.startTokenSurvey(),resolve()}),(function(response){var errorMessage="renew authentication token failure -- "+(response.data&&response.data.errorDetails?response.data.errorDetails:"no details"),error=new Error(errorMessage);error.details="AUTH_TOKEN_EXPIRED",$log.error("[authService] "+errorMessage),service.renewTokenInterval&&$interval.cancel(service.renewTokenInterval),$rootScope.$broadcast("ON_AUTH_TOKEN_EXPIRE"),reject(error)}))}))},service.startAppTokenSurvey=function(){if(!service.appToken||"string"!=typeof service.appToken||!service.appToken.length)return $log.info("[authService] No application token."),$q.resolve();var decodedToken=jwtHelper.decodeToken(service.appToken),tokenExpirationTimestamp=1e3*decodedToken.exp,expirationDate=new Date(tokenExpirationTimestamp),tokenExpirationDuration=tokenExpirationTimestamp-(new Date).valueOf();if($log.info("[authService] Extract application token info (countRenewed: "+decodedToken.countRenewed+", maxTokenRenew: "+decodedToken.maxTokenRenew+")"),tokenExpirationDuration<0)return $log.info("[authService] application token has already expired, re-new it immediately"),service.renewAppToken();if(tokenExpirationDuration<3e4)return $log.info("[authService] application token will expire in less 5 minutes, re-new it immediately"),service.renewAppToken();var usedExpirationDuration=tokenExpirationDuration-24e3;return $log.info("[authService] start application token survey (expirationDate: "+expirationDate+" tokenExpirationDuration: "+tokenExpirationDuration+"ms usedExpirationDuration: "+usedExpirationDuration+"ms)"),service.renewAppTokenInterval&&$interval.cancel(service.renewAppTokenInterval),service.renewAppTokenInterval=$interval((function(){service.renewAppToken()}),usedExpirationDuration),$q.when()},service.renewAppToken=function(){return $q((function(resolve,reject){$log.info("[authService] re-new application token"),$http({method:"GET",url:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/applications/v1.0/authentication/renew",headers:service.getRequestHeader()}).then((function(response){$log.info("[authService] renew application token success"),service.appToken=response.data.token,$localStorage.set({appToken:service.appToken}),$rootScope.$broadcast("ON_APP_TOKEN_RENEW"),service.startAppTokenSurvey(),resolve()}),(function(response){var errorMessage="renew application token failure -- "+(response.data&&response.data.errorDetails?response.data.errorDetails:"no details"),error=new Error(errorMessage);error.details="APP_TOKEN_EXPIRED",$log.error("[authService] "+errorMessage),$interval.cancel(service.renewAppTokenInterval),$rootScope.$broadcast("ON_APP_TOKEN_EXPIRE"),reject(error)}))}))},service.getUserData=function(){return $q((function(resolve,reject){$http({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+service.userId,headers:service.getRequestHeader()}).then((function(response){service.userData=response.data.data,service.login=response.data.data.loginEmail,service.jidIm=response.data.data.jid_im,service.jidTel=response.data.data.jid_tel,service.jidPwd=response.data.data.jid_password,service.initialized=response.data.data.isInitialized,service.companyId=response.data.data.companyId,service.isGuest=response.data.data.guestMode,service.xmppDomain=service.jidIm.split("@")[1],service.handleUserLanguage(),resolve(service.userData)}),(function(error){service.removeCredentials(),reject(new Error("Wrong token -- "+error.message))}))}))},service.getCompanySAMLConfiguration=function(companyId){return $q((function(resolve,reject){$log.debug("[authService] Get assertion configuration for a company"),$http({method:"GET",url:config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/authentication/v1.0/saml/"+companyId+"/metadata.xml",headers:service.getRequestHeader()}).then((function(response){$log.debug("[authService] getCompanySAMLConfiguration success"),resolve(response.data)}),(function(response){$log.error("[authService] getCompanySAMLConfiguration failure -- "+JSON.stringify(response)),reject(response)}))}))},service.getFingerPrint=function(){return $q((function(resolve){if(service.browserFingerprint)resolve(service.browserFingerprint);else{imprint.test(["audio","availableScreenResolution","canvas","colorDepth","cookies","cpuClass","deviceDpi","doNotTrack","indexedDb","installedFonts","language","localStorage","pixelRatio","platform","plugins","processorCores","screenResolution","sessionStorage","timezoneOffset","touchSupport","userAgent","webGl"]).then((function(browserFingerprint){service.browserFingerprint=browserFingerprint,resolve(browserFingerprint)}))}}))},service.handleUserLanguage=function(){var userServerLanguage=service.userData.language;userServerLanguage&&settingsService.setAppliLangageCodeFromServer(userServerLanguage)},service.removeCredentials=function(){$log.info("[authService] remove credentials");var dataToRemove=["token","id","authType","userEnvironment"];service.isGuest&&dataToRemove.push("login"),$localStorage.remove(dataToRemove),$localStorage.set({token:null}),service.isGuest=!1,service.resetUserEnvironment()},service.resetUserEnvironment=function(){settingsService.setSetting("userEnvironment",""),config.defaultEnvironment&&($log.info("[authService] resetUserEnvironment"),config.xmpp.currentServer=config.defaultEnvironment,config.xmpp.server=config.defaultEnvironment,config.webservices.currentServer=config.defaultEnvironment,config.webservices.server=config.defaultEnvironment)},service.validateLogin=function(login){return-1!==login.indexOf("@")},service.onInit()}])},function(module,exports){angular.module("rainbow").service("xmppService",["$rootScope","$log","$q","$interval","authService","helpersService","settingsService","utilService",function($rootScope,$log,$q,$interval,authService,helpersService,settingsService,utilService){"use strict";var service=this;service.disconnectionHandler=null,Strophe.log=function(level,msg){switch(level){case Strophe.LogLevel.WARN:$log.warn(msg);break;case Strophe.LogLevel.ERROR:case Strophe.LogLevel.FATAL:$log.error(msg);break;default:$log.debug(msg)}},service.start=function(stats){$log.info(""),$log.info("[xmppService] === STARTING ===");var startDate=performance.now();service.showBodyMessage="true"===settingsService.getSetting("showBodyMessage"),service.started=!1,service.connected=!1,service.stropheStatus=null,service.presenceStatus="offline";var pingInterval=config.xmpp.pingInterval?config.xmpp.pingInterval:6e4;return this.pingTimeout=2*pingInterval,service.serverURL=config.xmpp.protocol+"://"+config.xmpp.currentServer+":"+config.xmpp.port+"/websocket",service.presenceWaitingList=[],service.jidsToRemove=[],service.fullJid=null,authService.jidIm&&authService.jidPwd?this.connect().then((function(){service.started=!0;var startDuration=Math.round(performance.now()-startDate);stats.push({service:"xmppService",startDuration:startDuration}),$log.info("[xmppService] === STARTED ("+startDuration+" ms) ===")})).catch((function(error){return $log.error("[xmppService] === STARTING FAILURE ("+error.message+") === "),$q.reject(new Error("Starting failure : "+error.message))})):($log.info("Starting failure : No valid XMPP credentials"),$q.reject(new Error("No valid XMPP credentials")))},service.stop=function(){try{return this.disconnect("Stop service").finally((function(){service.connection=null,service.started=!1,service.stropheStatus=null,service.presenceWaitingList=[],service.deferDisconnect=null,service.fullJid=null}))}catch(error){return $log.error("XMPP disconnect error : "+error),service.connection=null,service.started=!1,service.stropheStatus=null,service.presenceWaitingList=[],service.deferDisconnect=null,service.fullJid=null,$q.when()}},service.connect=function(){$log.info("[xmppService] -- ASK CONNECTION --");try{if(service.stropheStatus===Strophe.Status.CONNECTING||service.stropheStatus===Strophe.Status.CONNECTED||service.stropheStatus===Strophe.Status.AUTHENTICATING){$log.info("[xmppService] already connecting");var error=new Error("XMPP service already-connected");return error.details=service.stropheStatus===Strophe.Status.CONNECTING?"XMPP_IN_CONNECTING_STATE":"XMPP_ALREADY_CONNECTED",$q.reject(error)}var deferred=$q.defer();return service.connection=new Strophe.Connection(service.serverURL+"?x-rainbow-client="+authService.getInformationHeadersApp()+"&x-rainbow-client-version="+authService.getInformationHeadersAppVersion()+"&x-rainbow-xmpp-dom="+authService.xmppDomain),service.connection.rawInput=function(data){return service.handleRawXmppMessage(data,"Recv: ")},service.connection.rawOutput=function(data){return service.handleRawXmppMessage(data,"Sent: ")},service.connecting=!0,service.generateRandomFullJid(authService.jidIm).then((function(fullJid){service.fullJid&&(fullJid=service.fullJid),service.connection.connect(fullJid,authService.jidPwd,(function(status,reason){switch(service.stropheStatus=status,reason=angular.isUndefined(reason)?"":reason,status){case Strophe.Status.CONNECTING:$log.info("[xmppService] -- Connecting --"),$rootScope.$broadcast("ON_CONNECTION_STATE_CHANGE_EVENT","inProgress");break;case Strophe.Status.AUTHFAIL:$log.error("[xmppService] -- Authentication failure -- "+reason),deferred.reject(new Error("Authentication failure -- "+reason));break;case Strophe.Status.CONNFAIL:service.connecting&&($log.error("[xmppService] -- Connection failure -- "+reason),deferred.reject(new Error("Connection failure -- "+reason)));break;case Strophe.Status.CONNECTED:$log.info("[xmppService] -- Connected -- "+service.connection.jid),service.connecting=!1,service.connected=!0,service.jid=authService.jidIm,service.fullJid=service.connection.jid,service.connection.addHandler(service.onRosterChanged,"jabber:iq:roster","iq","set"),service.connection.addHandler(service.onMamMessageReceived,Strophe.NS.MAM,"message",null),service.connection.addHandler(service.onMamMessageReceived,Strophe.NS.MAM,"iq",null),service.connection.addHandler(service.onSearchTextMessageReceived,"urn:xmpp:mam:tmp","message",null),service.connection.jingle&&service.connection.jingle.attachHandlers(),service.addPresenceHandler(),service.presenceWaitingList=[],service.connection.ping.addPingHandler((function(ping){var date=new Date;return $log.info("[xmppService] -- Receive keepAlive Ping request ("+date+")"),service.connected&&service.connection.ping.pong(ping),!0})),service.enableCarbon(),deferred.resolve();break;case Strophe.Status.DISCONNECTING:$log.info("[xmppService] -- Disconnecting -- "+reason);break;case Strophe.Status.DISCONNECTED:$log.info("[xmppService] -- Disconnected -- "+service.fullJid),service.started?($rootScope.$broadcast("ON_CONNECTION_STATE_CHANGE_EVENT","disconnected"),-1===service.jidsToRemove.indexOf(service.fullJid)&&(service.jidsToRemove.push(service.fullJid),service.jidsToRemove.forEach((function(jidToRemove){$log.info("[xmppService] -- invalid jid to remove -- "+jidToRemove)}))),service.deferDisconnect?($log.info("[xmppService] -- disable ping connection watcher"),service.connectionWatcherPromise&&$interval.cancel(service.connectionWatcherPromise),service.connected=!1,service.deferDisconnect.resolve()):service.connected&&!service.connecting?($log.error("[xmppService] -- Unexpected disconnection"),service.connecting=!0,service.connected=!1,$rootScope.disconnected=!0,service.disconnectionHandler()):service.connected||service.connecting||!service.fullJid?service.connected||service.connecting||service.fullJid?service.connecting&&deferred.reject(new Error("Connection failure -- "+reason)):($log.error("[xmppService] -- Unexpected disconnection without fullJid"),service.connecting=!0,service.disconnectionHandler()):($log.error("[xmppService] -- Unexpected disconnection with fullJid"),service.connecting=!0,service.disconnectionHandler())):($log.info("[xmppService] -- received disconnect event but service not started !!"),$log.info("[xmppService] -- disable ping connection watcher"),service.connectionWatcherPromise&&$interval.cancel(service.connectionWatcherPromise),$rootScope.disconnected=!0);break;default:$log.error("[xmppService] -- Connection to the xmpp server failure -- "+status+" -- "+reason)}}))})),deferred.promise}catch(error){return $log.error("XMPP service connect error : "+error),$q.reject("catch-connect-error")}},service.handleRawXmppMessage=function(data,direction){if(service.connectionWatcherPromise&&$interval.cancel(service.connectionWatcherPromise),service.connectionWatcherPromise=$interval(service.connectionWatcher,service.pingTimeout),!(data.indexOf("<PHOTO>")>-1)){var log=direction;if(data.indexOf("xmlns='jabber:x:bubble:conference'")>-1&&(data.indexOf("name='invitation'")>-1||data.indexOf("name='conferenceAdd'")>-1||data.indexOf("name='conferenceRemove'")>-1))log+="Hidden content";else if(data.indexOf("xmlns='urn:xmpp:jingle:1'")>-1&&(data.indexOf("displayname")>-1||data.indexOf("number")>-1))log+="Hidden content";else if(data.indexOf("urn:xmpp:janus:1")>-1&&(data.indexOf("displayName")>-1||data.indexOf("displayname")>-1||data.indexOf("number")>-1))log+="Hidden content";else if(data.indexOf("<items node")>-1)log+="[Channel event] Hidden content";else if(data.indexOf("<message")>-1&&(data.indexOf("<body")>-1||data.indexOf("<content>")>-1||data.indexOf(!1)))log+=service.messageBodyDiscretion(data);else{var result=data,dataElem=$(data).find("data");if(dataElem&&"http://jabber.org/protocol/ibb"===dataElem.attr("xmlns")&&(dataElem.html("Encoded file in base 64"),log+=dataElem.html()),!service.showBodyMessage){if(-1!==data.indexOf("<identity")){var firstName=data.indexOf("firstName="),firstNameIndex=data.indexOf("'",firstName);if(-1!==firstName&&-1!==firstNameIndex){var firstNameLastIndex=data.indexOf("'",firstNameIndex+1);firstNameIndex+1!==firstNameLastIndex&&(result=data.substr(0,firstNameIndex+2)+"***"+data.substr(firstNameLastIndex))}var lastName=result.indexOf("lastName="),lastNameIndex=result.indexOf("'",lastName);if(-1!==lastName&&-1!==lastNameIndex){var lastNameLastIndex=result.indexOf("'",lastNameIndex+1);lastNameIndex+1!==lastNameLastIndex&&(result=result.substr(0,lastNameIndex+2)+"***"+result.substr(lastNameLastIndex))}}if(-1!==result.indexOf("<caller_info")||-1!==result.indexOf("<callee_info")){var number=result.indexOf("number="),numberIndex=result.indexOf("'",number);if(-1!==number&&-1!==numberIndex){var numberLastIndex=result.indexOf("'",numberIndex+1);if(numberIndex+1!==numberLastIndex){var numberText=result.substr(numberIndex+1,numberLastIndex-numberIndex-1);result=result.substr(0,numberIndex+1)+utilService.anonymizePhoneNumber(numberText)+result.substr(numberLastIndex)}}}if(-1!==result.indexOf("<caller>")){var caller=result.indexOf("<caller>"),endCaller=result.indexOf("</caller>",caller);-1===(numberText=result.substring(caller+8,endCaller)).indexOf("@")&&-1===numberText.indexOf("janus")&&(result=result.substr(0,caller+8)+utilService.anonymizePhoneNumber(numberText)+result.substr(endCaller))}if(-1!==result.indexOf("<callee>")){var callee=result.indexOf("<callee>"),endCallee=result.indexOf("</callee>",callee);-1===(numberText=result.substring(callee+8,endCallee)).indexOf("@")&&-1===numberText.indexOf("janus")&&(result=result.substr(0,callee+8)+utilService.anonymizePhoneNumber(numberText)+result.substr(endCallee))}if(-1!==result.indexOf("<event")){var message=result.indexOf("<message>"),endMessage=result.indexOf("</message>",message);result=result.substr(0,message+9)+"***"+result.substr(endMessage)}var endpointTel=result.indexOf("endpointTel='");if(-1!==endpointTel){var endEndpointTel=result.indexOf("'",endpointTel+13);numberText=result.substring(endpointTel+13,endEndpointTel);result=result.substr(0,endpointTel+13)+utilService.anonymizePhoneNumber(numberText)+result.substr(endEndpointTel)}var destination=result.indexOf("destination='");if(-1!==destination){var endDestination=result.indexOf("'",destination+13);numberText=result.substring(destination+13,endDestination);result=result.substr(0,destination+13)+utilService.anonymizePhoneNumber(numberText)+result.substr(endDestination)}if(-1!==result.indexOf("<name>")){message=result.indexOf("<name>"),endMessage=result.indexOf("</name>",message);result=result.substr(0,message+6)+"***"+result.substr(endMessage)}}log+=result}$log.debug(log)}},service.messageBodyDiscretion=function(data){return service.showBodyMessage?data:(data=service.messageTagDiscretion("content",data),data=service.messageTagDiscretion("body",data),data=service.messageTagDiscretion("subject",data),data=service.messageTagDiscretion("filename",data))},service.messageTagDiscretion=function(tag,data){var startTagIndex=data.indexOf("<"+tag);if(-1!==startTagIndex){var endTagIndex=data.indexOf(">",startTagIndex),endEmptyTagIndex=data.indexOf("/>",startTagIndex);if(-1!==endTagIndex&&endTagIndex!==endEmptyTagIndex+1)return data.substr(0,endTagIndex+2)+"***"+data.substr(data.indexOf("</"+tag+">")-1)}return data},this.connectionWatcher=function(){try{if($log.error("[xmppService] -- Connection watcher : so bad, no message since "+service.pingTimeout/1e3+" seconds (no ping)"),service.connection){var message=service.stropheStatus===Strophe.Status.CONNECTED?"Have lost connectivity":"Stuck in reconnecting state";$log.info("[xmppService] -- Connection watcher -- "+message),service.stropheStatus=null,service.connection.disconnect("No ping")}}catch(error){$log.error("connectionWatcher error "+error)}},service.disconnect=function(reason){return service.deferDisconnect=$q.defer(),$log.info("[xmppService] -- ASK DISCONNECTION --"),this.connected?service.stropheStatus===Strophe.Status.CONNECTED&&service.connection.disconnect(reason):($log.info("[xmppService] -- disconnect - service is not started"),service.deferDisconnect.resolve()),service.deferDisconnect.promise},service.generateRandomFullJid=function(jid){return service.generateRandomFullJidForWeb(jid)},service.generateRandomFullJidForWeb=function(jid){return $q.when(jid+"/web_sdk_"+version+"_"+helpersService.randomString(8))},service.removeOldConnection=function(){$interval((function(){var disconnectJidPromises=service.jidsToRemove.map((function(jid){if(jid&&""!==jid){if(jid!==service.fullJid)return service.disconnectObsoleteJid(jid).then((function(){$log.info("[xmppService] -- disconnect obsolete jid -- "+jid+" done")}));$log.info("[xmppService] -- ignore disconnect obsolete jid for "+jid)}else $log.info("[xmppService] -- ignore disconnect obsolete jid for empty jid")}));service.jidsToRemove=[],$q.all(disconnectJidPromises).catch((function(error){$log.warn("[xmppService] -- somethings goes wrong during obsolete jid removal -- "+error.message)}))}),1e4,1)},service.disconnectObsoleteJid=function(jid){var iq=$iq({type:"set",id:helpersService.randomString(8),from:service.fullJid}).c("disconnect",{xmlns:"jabber:iq:configuration"}).c("to").t(jid);return service.sendIQ(iq)},this.onRosterChanged=function(iq){try{return angular.element(iq).find("item").each((function(){var jid=Strophe.getBareJidFromJid(angular.element(this).attr("jid")),favorite="favorites"===angular.element(this).find("group").first().text(),sub=angular.element(this).attr("subscription"),ask=angular.element(this).attr("ask");$rootScope.$apply((function(){$rootScope.$broadcast("ON_ROSTER_CHANGED_EVENT",{jid:jid,subscription:sub||"none",favorite:favorite,ask:ask||"none"})}))})),!0}catch(error){return!0}},this.addHistoryHandler=function(handler){this.historyHandler=handler},this.addSearchTextHandler=function(handler){this.searchTextHandler=handler},this.addHistoryCallLogsHandler=function(handler){this.callLogHandler=handler},this.onMamMessageReceived=function(stanza){$log.info("[XmppService] onMamMessageReceived");try{var queryId=angular.element(stanza).find("result").attr("queryid");return queryId||(queryId=angular.element(stanza).find("fin").attr("queryid")),queryId&&0!==queryId.indexOf("tel_")&&service.historyHandler?service.historyHandler(stanza):service.callLogHandler&&service.callLogHandler(stanza),!0}catch(error){return!0}},this.onSearchTextMessageReceived=function(stanza){$log.info("[XmppService] onSearchTextMessageReceived");try{var queryId=angular.element(stanza).find("result").attr("queryid");return queryId||(queryId=angular.element(stanza).find("fin").attr("queryid")),service.searchTextHandler&&service.searchTextHandler(queryId,stanza),!0}catch(error){return $log.warn("[XmppService] onSearchTextMessageReceived error : "+error.message),!0}},this.addPresenceHandler=function(){return $log.info("[xmppService] -- Add presence handler"),this.connection.addHandler(service.onPresence,null,"presence"),$q.when()},this.sendPresence=function(show,message,auth){if(this.connection||service.stropheStatus===Strophe.Status.CONNECTED)try{$log.info("Send presence "+show+" - "+message+" ("+service.jid+")");var presenceIq=$pres();if(presenceIq.c("priority").t("5"),presenceIq.up(),show&&"online"!==show&&presenceIq.c("show").t(show),!message||show&&"online"!==show?message&&presenceIq.up().c("status").t(message):presenceIq.c("status").t(message),!this.connection||!this.connection.send)return void $log.error('Try to send "presence IQ" but no xmpp connection');!0===auth&&(presenceIq.c("application",{xmlns:"jabber:iq:application"}),presenceIq.c("appid").t(config.rainbowApiClientKey).up(),presenceIq.c("userid").t(authService.userId)),this.connection.send(presenceIq)}catch(error){return void $log.error("this.connection.send error : "+error)}else $log.error('[xmppService] Try to send "presence IQ" but no xmpp connection')},this.resetPresence=function(status){$log.info("Reset presence to "+service.presenceStatus+" ("+service.jid+")"),service.sendPresence(status.show,status.status)},this.onPresence=function(presence){try{var fromJid=angular.element(presence).attr("from"),fromBareJid=Strophe.getBareJidFromJid(fromJid),namespace=angular.element(presence).find("x").attr("xmlns"),ptype=angular.element(presence).attr("type"),show=angular.element(presence).find("show").text();if(namespace&&0===namespace.indexOf(Strophe.NS.MUC))return!0;if(angular.element(presence).find("actor").length>0&&"jabber:iq:configuration"===angular.element(presence).find("actor").attr("xmlns")&&(angular.element(presence).find("avatar").length>0?$rootScope.$broadcast("ON_VCARD_UPDATE_EVENT",fromBareJid,"avatar"):angular.element(presence).find("data").length>0&&$rootScope.$broadcast("ON_VCARD_UPDATE_EVENT",fromBareJid,"data"),angular.element(presence).find("x").length&&"vcard-temp:x:update"===angular.element(presence).find("x").attr("xmlns")))return!0;if("error"===ptype)$log.error("Receive error presence message");else if("subscribe"===ptype)$log.info("Receive subscribe from ("+fromBareJid+")"),$rootScope.$broadcast("ON_ROSTER_SUBSCRIBE_EVENT",fromBareJid);else{var presenceElem=$(presence),presenceStatus="offline",presenceMessage="";"unavailable"!==ptype&&(show=presenceElem.find("show").text(),presenceMessage=presenceElem.find("status").text(),presenceStatus=""===show||"chat"===show?"online":"dnd"===show?"dnd":"xa"===show?"xa":"away");var stamp=presenceElem.find("delay").attr("stamp"),presStamp=stamp?new Date(stamp):new Date,until=presenceElem.find("until").text(),eventAttr={jid:fromJid,status:presenceStatus,message:presenceMessage,stamp:presStamp,until:until=until?new Date(until):null};$rootScope.$$listeners&&$rootScope.$$listeners.ON_ROSTER_PRESENCE_CHANGED_EVENT?$rootScope.$broadcast("ON_ROSTER_PRESENCE_CHANGED_EVENT",eventAttr):($log.info("[XMPP Service] Receive presence message but contact service is not ready yet"),service.presenceWaitingList.push(eventAttr))}return!0}catch(error){return!0}},this.getPresenceWaitingList=function(){return service.presenceWaitingList},this.resetPresenceWaitingList=function(){service.presenceWaitingList=[]},this.enableCarbon=function(){var iq=$iq({type:"set"});return iq.c("enable",{xmlns:"urn:xmpp:carbons:2"}),service.sendIQ(iq)},this.send=function(stanza){if(!service.connection&&service.stropheStatus!==Strophe.Status.CONNECTED)return $log.error('[xmppService] Try to send "stanza" but no xmpp connection'),$q.reject(new Error("No XMPP connection"));try{this.connection.send(stanza)}catch(error){return $log.error("[xmppService] this.connection.send error : "+error),$q.when()}return $q.when()},this.sendIQ=function(iq,timeout){if(!this.connection&&service.stropheStatus!==Strophe.Status.CONNECTED)return $log.error('[xmppService] Try to send "iq" but no xmpp connection'),$q.reject(new Error("No XMPP connection"));var defered=$q.defer();try{this.connection.sendIQ(iq,(function(data){defered.resolve(data)}),(function(data){null===data?defered.reject(new Error("XMPP request timeout")):defered.reject(new Error(data.innerHTML))}),timeout&&timeout>1e4?timeout:1e4)}catch(error){return $log.error("[xmppService] this.connection.sendIQ error : "+error),$q.reject(new Error("this.connection.sendIQ error"))}return defered.promise},this.getBareJidFromJid=function(jId){return Strophe.getBareJidFromJid(jId)},this.getResourceFromJid=function(jid){return Strophe.getResourceFromJid(jid)},this.addHandler=function(handler,ns,name,type,id,from,options){return this.connection.addHandler(handler,ns,name,type,id,from,options)},this.deleteHandler=function(handRef){this.connection&&this.connection.deleteHandler(handRef)},this.addFileTransfertHandlers=function(ibbHandler,fileHandler){this.connection.ibb.addIBBHandler(ibbHandler),this.connection.si_filetransfer.addFileHandler(fileHandler)},this.addCallLogsHandler=function(handler){this.rtcStartRef&&(this.connection.deleteHandler(this.rtcStartRef),this.rtcStartRef=null),this.rtcEndRef&&(this.connection.deleteHandler(this.rtcEndRef),this.rtcEndRef=null),this.rtcRingingRef&&(this.connection.deleteHandler(this.rtcRingingRef),this.rtcRingingRef=null),this.rtcStartRef=this.connection.addHandler(handler,null,"message","webrtc-start"),this.rtcEndRef=this.connection.addHandler(handler,null,"message","webrtc-end"),this.rtcRingingRef=this.connection.addHandler(handler,null,"message","webrtc-ringing")},this.addTelephonyCallLogsHandler=function(handler){this.telephonyMessageRef&&(this.connection.deleteHandler(this.telephonyMessageRef),this.telephonyMessageRef=null),this.telephonyIqRef&&(this.connection.deleteHandler(this.telephonyIqRef),this.telephonyIqRef=null),this.telephonyMessageRef=service.connection.addHandler(handler,Strophe.NS.CALLLOG,"message",null),this.telephonyIqRef=service.connection.addHandler(handler,Strophe.NS.CALLLOG,"iq",null)},this.addPubSubPublishHandler=function(handler){service.connection.addHandler(handler,"jabber:client","message","headline",null,"pubsub.demo-all-in-one-dev-1.opentouch.cloud")},this.getIpAddress=function(){return $q((function(resolve,reject){if(RTCPeerConnection){var pc=new RTCPeerConnection({iceServers:[]}),noop=function(){},result=[],timer=setTimeout((function(result){pc.onicecandidate=noop,result.length?resolve(result):reject()}),5e3,result);pc.createDataChannel(""),pc.createOffer(pc.setLocalDescription.bind(pc),noop),pc.onicecandidate=function(ice){if(ice&&ice.candidate&&ice.candidate.candidate){var candidateInfo=/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/.exec(ice.candidate.candidate);if(candidateInfo&&candidateInfo.length>=2){var myIP=candidateInfo[1];$log.info("[xmppService] IP found: "+myIP),result.push(myIP)}}else{if(pc.onicecandidate=noop,clearTimeout(timer),!result.length)return void reject();resolve(result)}}}else reject()}))}}])},function(module,exports,__webpack_require__){angular.module("rainbow").service("contactService",["$q","$rootScope","$translate","$log","$injector","$http","xmppService","authService","Contact","$interval","settingsService","PromiseQueue","companyService","errorHelperService","utilService",function($q,$rootScope,$translate,$log,$injector,$http,xmppService,authService,Contact,$interval,settingsService,PromiseQueue,companyService,errorHelperService,utilService){"use strict";var that=this;that.start=function(stats){$log.info(""),$log.info("[contactService] === STARTING ===");var startDate=performance.now();return $q((function(resolve,reject){if(that.userContact=null,that.contacts=[],that.dbContacts=[],that.jtelContacts={},that.contactPromises=[],that.getOrCreateContactPromises=[],that.networkSize=0,that.started=!1,that.changePasswordInfo=null,that.subscriptionPromiseQueue=PromiseQueue.create(),that.presentationModeActive=!1,that.awayStateActive=!1,that.busyState={status:null,message:null},that.forcedState=!1,that.manualState=!1,that.currentLanguage=settingsService.getSetting("lang"),that.langUpdateEventHandlerCleaner&&that.langUpdateEventHandlerCleaner(),that.langUpdateEventHandlerCleaner=$rootScope.$on("ON_LANGUAGE_UPDATED_EVENT",(function(__event,lang){that.currentLanguage=lang,that.updateContactsLastActivity()})),that.rosterUpdateEventHandlerCleaner&&that.rosterUpdateEventHandlerCleaner(),that.rosterUpdateEventHandlerCleaner=$rootScope.$on("ON_ROSTER_CHANGED_EVENT",that.rosterChangedHandler),that.presenceUpdateEventHandlerCleaner&&that.presenceUpdateEventHandlerCleaner(),that.presenceUpdateEventHandlerCleaner=$rootScope.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",that.contactPresenceChangedHandler),that.calendarPresenceEventHandlerCleaner&&that.calendarPresenceEventHandlerCleaner(),that.calendarPresenceEventHandlerCleaner=$rootScope.$on("ON_CONTACT_CALENDAR_STATUS_CHANGE",that.contactCalendarPresenceChangedHandler),$log.info("[contactService] Create userContact ("+xmppService.jid+")"),that.userContact=new Contact,that.userContact.ask=null,that.userContact.subscription=null,that.userContact.id=xmppService.jid,that.userContact.jid=xmppService.jid,that.userContact.fullJid=xmppService.fullJid,that.userContact.language=that.currentLanguage,that.userContact.updateFromUserData(authService.userData),that.userContact.getAvatar(),that.userContact.updateRichStatus(),that.dbContacts[that.userContact.dbId]=that.userContact,that.contacts[that.userContact.id]=that.userContact,that.jtelContacts[that.userContact.jidtel]=that.userContact,!authService.userData.language){var serverLanguageCode=settingsService.getAppliLanguageCodeForServer();that.updateUserContact({language:serverLanguageCode})}that.getUserSettings().then((function(settings){return that.manageCalendarPresencePrompt(settings),settingsService.settings.activeAlarm=settings.activeAlarm,settingsService.settings.activeNotif=settings.activeNotif,$log.info("[contactService] Get alarm & notif data ("+settingsService.settings.activeAlarm+" / "+settingsService.settings.activeNotif+")"),settingsService.settings.protectionAgainstMailTypeOffline=settings.protectionAgainstMailTypeOffline,$log.info("[contactService] Get mail setting data ("+settingsService.settings.protectionAgainstMailTypeOffline+")"),$q.resolve()})).then((function(){return companyService.getCompanyById(that.userContact.company.id)})).then((function(userCompany){return that.userContact.company=userCompany,that.attachHandlers(),that.getMyNetwork()})).then((function(){return that.updateNetworkWithRosterInfo()})).then((function(){that.appActiveEventHandlerCleaner&&that.appActiveEventHandlerCleaner(),that.appActiveEventHandlerCleaner=$rootScope.$watch("appActive",(function(appActive){return $log.info("[contactService] AppActive changed : "+appActive),!appActive&&that.userContact&&"online"===that.userContact.status&&(that.awayStateActive=!0),appActive&&that.awayStateActive&&(that.awayStateActive=!1),angular.isDefined(appActive)&&that.updatePresence(!0),!0})),that.vcardUpdateEventHandlerCleaner&&that.vcardUpdateEventHandlerCleaner(),that.vcardUpdateEventHandlerCleaner=$rootScope.$on("ON_VCARD_UPDATE_EVENT",that.onVCardChangeEvent),that.getMissedPresenceMessages();var startDuration=Math.round(performance.now()-startDate);stats.push({service:"contactService",startDuration:startDuration}),$log.info("[contactService] === STARTED ("+startDuration+" ms) ==="),that.started=!0,resolve()})).catch((function(error){$log.error("[contactService] === STARTING FAILURE === "+error.message),reject(error)})),that.connectionStateEventHandlerCleaner&&that.connectionStateEventHandlerCleaner(),that.connectionStateEventHandlerCleaner=$rootScope.$on("ON_CONNECTION_STATE_CHANGE_EVENT",that.onConnectionStateChangeEvent),that.contactLastActivityTimerInterval=$interval(that.updateContactsLastActivity,6e4)}))},that.manageCalendarPresencePrompt=function(settings){if(void 0!==settings.promptForCalendarPresence)settingsService.setSetting("disableCalendarPresence",settings.promptForCalendarPresence?"false":"true"),$log.info("[contactService] promptForCalendarPresence -- "+settings.promptForCalendarPresence);else{var promptForCalendarPresence="true"!==settingsService.getSetting("disableCalendarPresence");$log.info("[contactService] MIGRATION NECESSARY -- promptForCalendarPresence : "+promptForCalendarPresence),that.setUserSettings({promptForCalendarPresence:promptForCalendarPresence})}},that.getMyNetwork=function(){return $q((function(resolve,reject){var serverUrl=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/networks?limit=2000";$http({method:"GET",url:serverUrl,headers:authService.getRequestHeader()}).then((function(response){var contactsData=response.data.data;$log.info("[contactService] GetMyNetwork success -- find "+contactsData.length+" contact(s)"),contactsData.forEach((function(contactData){var contact=new Contact;contact.updateFromUserData(contactData),that.contacts[contact.id]=contact,that.dbContacts[contact.dbId]=contact,that.jtelContacts[contact.jidtel]=contact,contact.updateRichStatus(),contact.getAvatar(),that.sendUpdateEvent(contact)})),that.networkSize=contactsData.length,resolve()}),(function(){$log.error("[contactService] GetMyNetwork failure"),reject(new Error("GetMyNetwork failure"))}))}))},that.updateNetworkWithRosterInfo=function(){return $q((function(resolve,reject){xmppService.sendIQ($iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"})).then((function(stanza){$log.info("[contactService] Get rosters info successfully"),$(stanza).find("item").each((function(){var rosterElem=$(this),jid=xmppService.getBareJidFromJid(rosterElem.attr("jid"));if(jid&&jid.length&&!that.isTelJid(jid)){var contact=that.contacts[jid];if(contact){var ask=rosterElem.attr("ask"),subscription=rosterElem.attr("subscription");contact.ask=angular.isDefined(ask)?ask:"none",contact.subscription=angular.isDefined(subscription)?subscription:"none",contact.roster=!0,contact.updateRichStatus(),$log.info("[contactService] Update contact from roster ("+contact.ask+", "+contact.subscription+") "+jid)}}})),resolve()})).catch((function(error){$log.error("[contactService] Get rosters failure : "+error.message),reject(error)}))}))},that.getMissedPresenceMessages=function(){$log.info("[contactService] GetMissedPresenceMessages");try{var list=xmppService.getPresenceWaitingList();if(list.length){for($log.info("[contactService] GetMissedPresenceMessages length "+list.length);list.length>0;){var item=list.pop();that.contactPresenceChangedHandler(null,item)}xmppService.resetPresenceWaitingList()}}catch(error){$log.error("[contactService] GetMissedPresenceMessages error "+error)}},that.attachHandlers=function(){$log.info("[contactService] AttachHandlers"),this.contactConfigRef&&(xmppService.connection.deleteHandler(this.contactConfigRef),this.contactConfigRef=null),this.contactConfigRef=xmppService.connection.addHandler(that.onUserManagementEvent,null,"message","management")},that.stop=function(){return $log.info("[contactService] Stopping"),that.userContact=null,that.contacts=null,that.dbContacts=null,that.started=!1,that.presentationModeActive=!1,that.awayStateActive=!1,that.busyState={status:null,message:null},that.forcedState=!1,that.manualState=!1,$log.info("[contactService] Stopped"),that.vcardUpdateEventHandlerCleaner&&(that.vcardUpdateEventHandlerCleaner(),that.vcardUpdateEventHandlerCleaner=null),that.connectionStateEventHandlerCleaner&&(that.connectionStateEventHandlerCleaner(),that.connectionStateEventHandlerCleaner=null),that.contactLastActivityTimerInterval&&($interval.cancel(that.contactLastActivityTimerInterval),that.contactLastActivityTimerInterval=null),$q.when()},that.onConnectionStateChangeEvent=function(__event,status){if("disconnected"===status&&that.userContact){for(var key in that.userContact.resources={},that.contacts)that.contacts.hasOwnProperty(key)&&!that.contacts[key].isBot&&(that.contacts[key].resources={},"unknown"!==that.contacts[key].status&&"none"!==that.contacts[key].subscription&&(that.contacts[key].status="offline",that.contacts[key].imStatusStamp={}));that.presentationModeActive=!1,that.awayStateActive=!1,that.busyState={status:null,message:null},that.forcedState=!1,that.manualState=!1}},that.onVCardChangeEvent=function(event,jid,type){$log.info("[contactService] onVCardChangeEvent event: "+event+" || status: "+jid+" || type: "+type),$interval((function(){var contact=that.getContactByJid(jid);contact&&("avatar"===type||"data"===type?that.getVCardByDbId(contact.dbId,!0).then((function(){return"avatar"===type?contact.getAvatar(256,!0):$q.when()})).then((function(){that.sendUpdateEvent(contact)})):that.sendUpdateEvent(contact))}),2e3,1)},that.onUserManagementEvent=function(stanza){try{var userSettingsElem=$(stanza).find("usersettings");if(userSettingsElem.length&&"update"===userSettingsElem.attr("action"))return $log.info("[contactService] onUserManagementEvent - should update the presence"),that.sendPresenceFromConfiguration(),!0;var userPasswordElem=$(stanza).find("userpassword");return!userPasswordElem.length||"update"!==userPasswordElem.attr("action")||($log.info("[contactService] onUserManagementEvent - userPassword updated"),that.changePasswordInfo||(that.changePasswordInfo={fromThirdParty:!0}),!0)}catch(error){return!0}},that.updateUserContactFullJid=function(){that.userContact.fullJid=xmppService.fullJid,that.attachHandlers()},this.getMinimumContactByDBId=function(dbId){return $q((function(resolve){resolve(that.createEmptyContactContact(dbId))}))},that.createEmptyContactContact=function(jid){var contact=that.createBasicContact(jid);return contact.initials="?",contact.displayName="Unknown contact",contact.lastname="Unknown contact",contact.firstname="",contact.temp=!0,contact.avatar=new Image,contact.avatar.src="/resources/skins/rainbow/images/conversations/unknownContact.png",contact},that.getContact=function(jid,phoneNumber){var contactId=jid||phoneNumber;return this.isUserContactJid(contactId)?that.userContact:this.contacts[contactId]},that.getOrCreateContact=function(jid,phoneNumber){if(!jid&&!phoneNumber)return $q.reject(new Error("No jid or no phoneNumber"));that.contacts||(that.contacts=[]);var contact=that.getContact(jid,phoneNumber);if(contact)return $q.resolve(contact);if(jid&&-1===jid.indexOf("@"))return $q.reject(new Error("Invalid jid "+jid));var contactId=jid||phoneNumber;return jid?(that.getOrCreateContactPromises[contactId]||(that.getOrCreateContactPromises[contactId]=$q((function(resolve,reject){that.getVCardInfoByJid(jid).then((function(userData){(contact=that.createBasicContact(jid,phoneNumber,!1)).updateFromUserData(userData),contact.updateRichStatus(),contact.getAvatar(),that.contacts[contact.id]=contact,that.dbContacts[contact.dbId]=contact,that.jtelContacts[contact.jidtel]=contact,that.sendUpdateEvent(contact),resolve(contact),delete that.getOrCreateContactPromises[contactId]})).catch((function(error){$log.error("[contactService] getOrCreateContact -- failure -- "+error.message),reject(error),delete that.getOrCreateContactPromises[contactId]}))}))),that.getOrCreateContactPromises[contactId]):$q.resolve(contact=that.createBasicContact(null,phoneNumber))},this.createBasicContact=function(jid,phoneNumber,append){$log.debug("[contactService] CreateContact "+jid+" "+utilService.anonymizePhoneNumber(phoneNumber));var contact=new Contact;if(!jid)return contact.id=phoneNumber,contact.initials="?",contact.displayName=phoneNumber||"Unknown contact",contact.lastname=phoneNumber||"Unknown contact",contact.firstname="",contact.phoneProCan=phoneNumber||"",contact.temp=!0,contact.avatar=new Image,contact.avatar.src="/resources/skins/rainbow/images/conversations/unknownContact.png",contact.setNameUpdatePrio(Contact.NameUpdatePrio.NO_UPDATE_PRIO),contact;var contactId=jid;return contactId||(contactId=phoneNumber,contact.phoneProCan=phoneNumber),contactId||(contactId="anonymous"),contact.jid=jid,contact.id=contactId,contact.ask="none",contact.subscription="none",contact.updateRichStatus(),!1!==append&&(that.contacts[contact.id]=contact),contact},this.getContactByJid=function(jid){var contact=null;return this.isUserContactJid(jid)?contact=that.userContact:this.contacts?contact=this.contacts[jid]:this.contacts=[],contact},this.getContactByEmail=function(email){var contact=null;for(var prop in this.contacts)this.contacts.hasOwnProperty(prop)&&this.contacts[prop].containsEmail(email)&&(contact=this.contacts[prop]);return contact},this.getContacts=function(){var contactArray=[];for(var key in this.contacts)this.contacts.hasOwnProperty(key)&&contactArray.push(this.contacts[key]);return contactArray},this.searchContacts=function(criteria){return this.getContacts().filter((function(contact){return(contact.roster||contact.isBot)&&!contact.isTerminated&&that.contactMatcher(contact,criteria)}))},this.contactMatcher=function(contact,criteria){var displayname=contact.firstname+" "+contact.lastname,queries=criteria.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").split(/[ ]+/),names=displayname.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").split(/[ ]+/);return queries.every((function(query){return names.some((function(name,index){return!(!name.length||0!==name.indexOf(query))&&(names[index]="",!0)}))}))},that.getContactById=function(id){return that.dbContacts[id]},that.getContactByDBId=function(dbId,force){var existingContact=that.dbContacts[dbId];if(!force&&existingContact)return $q.when(existingContact);var existingPromise=that.contactPromises[dbId];if(existingPromise)return $log.debug("[contactService] getContactByDBId for "+dbId+" already lauched"),existingPromise.promise;var defered=$q.defer();that.contactPromises[dbId]=defered;var url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+dbId;return $http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){var user=response.data.data;$log.info("[contactService] GetContactByDBId ("+dbId+") -- "+user.jid_im+" -- success");var contact=existingContact||that.createBasicContact(user.jid_im);contact.updateFromUserData(user),contact.getAvatar(),that.dbContacts[contact.dbId]=contact,that.jtelContacts[contact.jidtel]=contact,defered.resolve(contact),delete that.contactPromises[dbId]}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),delete that.contactPromises[dbId],$log.error("[contactService] "+errorHelperService.getErrorFullMessage(response,"GetContactByDBId"))})),defered.promise},that.completeContactPhoneNumbers=function(contact){return $q((function(resolve,reject){contact.isBot?reject(new Error("No phone numbers for bot contacts")):contact.phoneNumbersInitialized?resolve(contact):that.getContactByDBId(contact.dbId,!0).then((function(updatedContact){resolve(updatedContact)})).catch((function(error){reject(error)}))}))},this.getContactsByJids=function(jids){return $q((function(resolve,reject){$log.info("[contactService] getContactsByJids with ["+jids.join()+"]");var serverUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port;$http({method:"POST",headers:authService.getPostHeader(),url:serverUrl+"/api/rainbow/enduser/v1.0/users/jids?limit=1000",data:{jid_im:jids}}).then((function(response){response.data.data.forEach((function(userData){var contact=that.getContactByJid(userData.jid_im);contact||(contact=new Contact),contact.updateFromUserData(userData),that.contacts[contact.id]=contact,that.dbContacts[contact.dbId]=contact,that.jtelContacts[contact.jidtel]=contact,contact.getAvatar(),contact.temp=!1})),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[contactService] "+errorHelperService.getErrorFullMessage(response,"getContactsByJids"))}))}))},this.getContactsByEmails=function(emails){return $q((function(resolve,reject){$log.info("[contactService] getContactsByEmails with ["+emails.join()+"]");var serverUrl=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/loginemails",lowerCaseEmails=emails.map((function(email){return email.toLowerCase()}));$http({method:"POST",headers:authService.getPostHeader(),url:serverUrl,data:{loginEmail:lowerCaseEmails}}).then((function(response){var contacts={},contactsArray=[];response.data.data.forEach((function(userData){var contact=that.dbContacts[userData.id];contact||(contact=new Contact,that.contacts[contact.id]=contact,that.dbContacts[contact.dbId]=contact,that.jtelContacts[contact.jidtel]=contact),contact.updateFromUserData(userData),contact.getAvatar(),contacts[contact.loginEmail]=contact,contactsArray.push(contact),lowerCaseEmails.splice(lowerCaseEmails.indexOf(contact.loginEmail.toLowerCase()),1)})),resolve({contacts:contacts,contactsArray:contactsArray,emails:lowerCaseEmails})}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[contactService] "+errorHelperService.getErrorFullMessage(response,"getContactsByEmails"))}))}))},that.getUserSettings=function(){return $q((function(resolve){var url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+that.userContact.dbId+"/settings";$http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){$log.info("[contactService] GetUserSettings success");var presence=response.data.data.presence||"online",activeAlarm=response.data.data.activeAlarm||"relax1",activeNotif=response.data.data.activeNotif||"notif1",promptForCalendarPresence=response.data.data.promptForCalendarPresence,protectionAgainstMailTypeOffline=response.data.data.protectionAgainstMailTypeOffline;resolve({presence:presence,activeAlarm:activeAlarm,activeNotif:activeNotif,promptForCalendarPresence:promptForCalendarPresence,protectionAgainstMailTypeOffline:protectionAgainstMailTypeOffline})}),(function(response){$log.error("[contactService] "+errorHelperService.getErrorFullMessage(response,"GetUserSettings")),resolve({presence:"online",activeAlarm:"relax1",activeNotif:"notif1",promptForCalendarPresence:!1})}))}))},that.setUserSettings=function(params){return $q((function(resolve,reject){var url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+that.userContact.dbId+"/settings";$http({method:"PUT",url:url,headers:authService.getRequestHeader(),data:params}).then((function(){$log.info("[contactService] SetUserSettings "+JSON.stringify(params)+" -- success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);$log.error("[contactService] "+errorHelperService.getErrorFullMessage(response,"SetUserSettings")),reject(error)}))}))},that.getVCardByDbId=function(dbId,shouldSkipAvatar){return $q((function(resolve,reject){var url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+dbId;$http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){var user=response.data.data,contact=that.contacts[user.jid_im];contact.updateFromUserData(user),contact.updateRichStatus(that.isUserContactJid(user.jid_im)),shouldSkipAvatar||contact.getAvatar(),that.sendUpdateEvent(contact),resolve(contact)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[contactService] "+errorHelperService.getErrorFullMessage(response,"getVCardByDbId"))}))}))},that.getVCardInfoByJid=function(jid){return $q((function(resolve,reject){var url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/jids/"+jid;$http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){resolve(response.data.data)})).catch((function(response){$log.error("[contactService] "+errorHelperService.getErrorFullMessage(response,"getVCardInfoByJid")),reject(errorHelperService.handleError(response))}))}))},that.getVCardInfoByEmail=function(email){return $q((function(resolve,reject){var url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/loginemails?format=full";$http({method:"POST",url:url,headers:authService.getRequestHeader(),data:{loginEmail:[email]}}).then((function(response){resolve(response.data.data)})).catch((function(response){$log.error("[contactService] "+errorHelperService.getErrorFullMessage(response,"getVCardsByEmail")),reject()}))}))},this.pushAvatarImage=function(avatarImg){var defered=$q.defer(),serverURL=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port;$log.info("[contactService] Push avatar image ");var oldImage=that.userContact.avatar;return that.resizeImage(avatarImg,512,512).then((function(resizedImage){that.userContact.avatar=resizedImage;var binaryData=that.getBinaryData(resizedImage);$http({method:"POST",url:serverURL+"/api/rainbow/enduser/v1.0/users/"+that.userContact.dbId+"/avatar",headers:authService.getPostHeader("image/"+binaryData.type),data:binaryData.data,transformRequest:[]}).then((function(){defered.resolve()}),(function(response){that.userContact.avatar=oldImage;var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[contactService] "+errorHelperService.getErrorFullMessage(response,"pushAvatarImage"))}))})),defered.promise},this.resizeImage=function(avatarImg,maxWidth,maxHeight){var defered=$q.defer(),image=new Image;return image.src=avatarImg,image.onload=function(){var imageWidth=image.width,imageHeight=image.height;imageWidth>imageHeight?imageWidth>maxWidth&&(imageHeight*=maxWidth/imageWidth,imageWidth=maxWidth):imageHeight>maxHeight&&(imageWidth*=maxHeight/imageHeight,imageHeight=maxHeight);var canvas=document.createElement("canvas");canvas.width=imageWidth,canvas.height=imageHeight,image.width=imageWidth,image.height=imageHeight,image.crossOrigin="Anonymous",canvas.getContext("2d").drawImage(this,0,0,imageWidth,imageHeight);var resizedImage=new Image;resizedImage.src=canvas.toDataURL("image/png"),defered.resolve(resizedImage)},defered.promise},this.getBinaryData=function(image){for(var typeIndex=image.src.indexOf("image/")+6,binaryIndex=image.src.indexOf(";base64,"),binaryData=image.src.slice(binaryIndex+8),imageType=image.src.slice(typeIndex,binaryIndex),binary_string=window.atob(binaryData),len=binary_string.length,bytes=new Uint8Array(len),i=0;i<len;i++)bytes[i]=binary_string.charCodeAt(i);return{type:imageType,data:bytes}},this.sendSubscription=function(contact){return"to"===contact.subscribe||"both"===contact.subscribe?$q.when(contact):(that.sendSubscribeInvitation(contact.jid),that.sendSubscribeInvitation(contact.jidtel),$q.when(contact))},that.sendSubscribeInvitation=function(jid){return $log.info("[contactService] Send subscribe invitation to "+jid),xmppService.send($pres({to:jid,type:"subscribe"}))},that.rosterChangedHandler=function(__event,attr){that.subscriptionPromiseQueue.add((function(){return that.rosterChangedHandlerPromise(attr)}))},that.rosterChangedHandlerPromise=function(attr){return that.isTelJid(attr.jid)?($log.debug("[contactService] Contact changed ("+attr.jid+") ignored"),$q.when()):$q((function(resolve){var subscription=attr.subscription,ask=attr.ask,jid_im=attr.jid;that.getOrCreateContact(jid_im).then((function(contact){"remove"===subscription?(contact.ask="none",contact.subscription="none",contact.roster=!1):(contact.ask=ask,contact.subscription=subscription,contact.roster=!0,"both"===subscription&&that.updatePresence(!0)),contact.updateRichStatus(),that.sendUpdateEvent(contact),$rootScope.$broadcast("ON_CONTACT_ROSTER_UPDATE_EVENT"),$log.info("[contactService] rosterChangedHandler - contact "+attr.jid+" changed ("+ask+", "+subscription+") success"),resolve()})).catch((function(error){$log.error("[contactService] rosterChangedHandler - contact "+attr.jid+" failure - "+error.message),resolve()}))}))},this.updateUserContact=function(userData){$log.info("[contactService] updateUserContact");var defered=$q.defer(),portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/";return $http({method:"PUT",url:portalURL+"users/"+authService.userId,headers:authService.getPostHeader(),data:userData}).then((function(response){$log.info("[contactService] updateUserContact successfully"),that.userContact.updateFromUserData(response.data.data),defered.resolve()}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[contactService] "+errorHelperService.getErrorFullMessage(response,"updateUserContact"))})),defered.promise},that.updateUserPassword=function(oldPassword,newPassword,async){var defered=$q.defer();return that.changePasswordInfo={defered:defered,newPassword:newPassword},$http({method:"PUT",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+authService.userId+"/change-password",headers:authService.getPostHeader(),data:{oldPassword:oldPassword,newPassword:newPassword}}).then((function(){$log.info("[contactService] updateUserPasswordRequest -- success"),async||defered.resolve()})).catch((function(response){$log.error("[contactService] "+errorHelperService.getErrorFullMessage(response,"updateUserPasswordRequest")),that.changePasswordInfo=null,defered.reject(errorHelperService.handleError(response))})),defered.promise},this.deleteUserAccount=function(){return $q((function(resolve,reject){$log.info("[contactService] deleteUserAccount"),$http({method:"DELETE",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+that.userContact.dbId,headers:authService.getRequestHeader()}).then((function(){$log.info("[contactService] deleteUserAccount -- success"),resolve()})).catch((function(response){$log.error("[contactService] "+errorHelperService.getErrorFullMessage(response,"deleteUserAccount")),reject(errorHelperService.handleError(response))}))}))},this.isTelJid=function(jid){return 0===jid.indexOf("tel_")},this.getImJid=function(jid){var bareJid=xmppService.getBareJidFromJid(jid);if(this.isTelJid(bareJid)){var contact=this.jtelContacts[bareJid];return contact?contact.jid:($log.warn("[contactService] -- getIMJid("+jid+") -- failure -- no associated contact"),null)}return bareJid},this.getRessourceFromJid=function(jid){var result="";if(jid){var index=jid.indexOf("/");-1!==index&&(result=jid.substr(index+1))}return result},this.isUserContactJid=function(jid){return!(!that.userContact||!jid||0===jid.length)&&jid.startsWith(that.userContact.jid)},this.isUserContact=function(contact){return!(!contact||!contact.jid||0===contact.jid.length)&&(that.userContact?contact.jid.startsWith(that.userContact.jid):contact.jid.startsWith(xmppService.jid))},that.updateContactsLastActivity=function(){that.contacts&&Object.keys(that.contacts).forEach((function(key){that.contacts[key].updateLastActivityMessage()}))},that.updateLastActivity=function(contact){"offline"===contact.status||"away"===contact.status?contact.lastActivityDate=contact.getLastAvailableDate():contact.lastActivityDate=null},this.createBotContact=function(jid,name,id,botAvatarUrl){var contact;return contact=that.contacts[jid]?Contact.updateContactToBot(that.contacts[jid],name,id,botAvatarUrl):Contact.createBotContact(jid,name,id,botAvatarUrl),that.contacts[contact.id]=contact,that.dbContacts[id]=contact,contact},this.contactPresenceChangedHandler=function(__event,attr){if("calendar"!==that.getRessourceFromJid(attr.jid)){var jid_im=that.getImJid(attr.jid);jid_im&&(jid_im.startsWith("room")||that.getOrCreateContact(jid_im).then((function(contact){that.isTelJid(attr.jid)?($log.info("[contactService] Update telephony presence ("+jid_im+") Source = "+contact.getPCGPresenceSource(attr.jid)),$log.info("[contactService] Update telephony presence ("+jid_im+") msg : "+attr.message+" / status : "+attr.status),contact.updateTelephonyStatus(attr,that.isUserContact(contact))):($log.info("[contactService] Update im presence contact ("+jid_im+") : "+attr.status+" "+attr.stamp),that.isUserContact(contact)&&"mode=auto"===attr.message&&"online"!==contact.status&&contact.resources.hasOwnProperty(attr.jid)&&attr.jid!==contact.fullJid&&"EVT_SERVICE_INITIATED"!==contact.telStatus&&"EVT_ESTABLISHED"!==contact.telStatus&&(contact.resources[contact.fullJid]&&"online"===contact.resources[contact.fullJid].show?$log.info("[contactService] Current ressource is already online, ignore message!"):(that.manualState&&($log.info("[contactService] User is in manual state, leave it"),that.setUserContactStatus("online","mode=auto")),that.busyState&&"dnd"===that.busyState.status&&"busy"!==that.userContact.status&&($log.info("[contactService] User is in call, re-update presence state"),$interval((function(){that.updatePresence(!0)}),500,1,!0)))),contact.updateIMStatus(attr,that.isUserContact(contact)),that.updateLastActivity(contact)),that.sendUpdateEvent(contact)})))}},this.contactCalendarPresenceChangedHandler=function(__event,contact){contact.updateCalendarPresenceInfo()},this.setUserContactStatus=function(status,message,withAuthInfo){try{if($log.info("[contactService] Set userContact status : "+status+(message?"("+message+")":"")),xmppService.started)"online"===status?(that.manualState=!1,xmppService.sendPresence(null,message,withAuthInfo)):(that.manualState=!0,"away"===status?xmppService.sendPresence("away",message):"dnd"===status?xmppService.sendPresence("dnd",message):"xa"===status&&xmppService.sendPresence("xa",message));else if("online"===status){$injector.get("serviceLauncher").startServices()}}catch(error){$log.error("[contactService] Set userContact status error : "+error)}},this.sendPresenceFromConfiguration=function(sendAuthInfo){$log.info("(with auth info)");var defered=$q.defer();return that.getUserSettings().then((function(setting){var message="",presence=setting.presence;if("invisible"===presence?presence="xa":"away"===presence&&(presence="xa",message="away"),$log.info("[contactService] sendPresenceFromConfiguration -> getUserSettings are "+presence+" || message : "+message),that.userContact&&that.userContact.resources&&that.userContact.resources[that.userContact.fullJid]){var myRessource=that.userContact.resources[that.userContact.fullJid];myRessource&&(myRessource.show!==presence||"xa"===myRessource.show&&myRessource.status!==message)?that.busyState&&"dnd"===that.busyState.status&&!that.manualState||($log.info("[contactService] sendPresenceFromConfiguration should update my status from "+myRessource.show+" to "+presence+" ("+message+")"),that.setUserContactStatus(presence,message,sendAuthInfo)):$rootScope.$broadcast("ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT")}else $log.info("[contactService] sendPresenceFromConfiguration set initial presence "),that.setUserContactStatus(presence,message,sendAuthInfo);defered.resolve()})).catch((function(){$log.info("[contactService] sendPresenceFromConfiguration failure, send online"),that.setUserContactStatus("online",null,sendAuthInfo),defered.resolve()})),defered.promise},that.updateUserSettings=function(status,message){var presence="online";"xa"===status&&"away"===message?presence="away":"dnd"===status?presence="dnd":"xa"===status&&(presence="invisible"),that.setUserSettings({presence:presence})};var presentationModeIntervalPromise,lastUpdatePresentationMode=null;this.onPresentationModeChangedEvent=function(__event,status){"active"===status?that.presentationModeActive=!0:"disable"===status&&(that.presentationModeActive=!1),null===lastUpdatePresentationMode&&($log.debug("[contactService] onPresentationModeChangedEvent status:"+status+" request presence update"),lastUpdatePresentationMode=that.presentationModeActive,that.updatePresence()),function startUpdatePresentationModeRefreshTimer(){$log.debug("[contactService] startUpdatePresentationModeRefreshTimer"),null!==presentationModeIntervalPromise&&($interval.cancel(presentationModeIntervalPromise),presentationModeIntervalPromise=null),presentationModeIntervalPromise=$interval((function(){$log.debug("[contactService] startUpdatePresentationModeRefreshTimer interval reach"),lastUpdatePresentationMode!==that.presentationModeActive?($log.debug("[contactService] startUpdatePresentationModeRefreshTimer interval - request presence update"),lastUpdatePresentationMode=that.presentationModeActive,that.updatePresence(),startUpdatePresentationModeRefreshTimer()):($log.debug("[contactService] startUpdatePresentationModeRefreshTimer interval - no presence update needed"),lastUpdatePresentationMode=null)}),1e3,1,!0)}()},this.changeMyPresence=function(status){if($log.info("[contactService] changeMyPresence "+status+" "+that.userContact.message),("dnd"!==status||"presentation"!==that.userContact.message)&&"busy"!==status){var message="";"online"===status&&(message="mode=auto"),"away"===status&&(status="xa",message="away"),that.setUserContactStatus(status,message),"online"===status&&$interval((function(){that.manualState=!1,that.updatePresence()}),1e3,1,!0),that.updateUserSettings(status,message)}},this.computeStatusList=function(){var list=[];return that.userContact&&that.userContact.status&&($log.info("[contactService] computeStatusList "+that.userContact.status+" "+that.userContact.message),list="offline"===that.userContact.status?["online"]:"busy"===that.userContact.status?["busy"]:"dnd"===that.userContact.status&&"presentation"===that.userContact.message?["dnd"]:["online","away","xa","dnd"]),list},this.resetBusyState=function(){$log.info("[contactService] resetBusyState"),that.setBusyState(null,null,!0),that.sendPresenceFromConfiguration()},this.setBusyState=function(status,message,noUpdate){$log.info("[contactService] setBusyState -- "+status+" -- "+message),that.busyState={status:status,message:message},noUpdate||that.updatePresence()},$rootScope.$on("$destroy",$rootScope.$on("ON_PRESENTATION_MODE_CHANGED_EVENT",that.onPresentationModeChangedEvent)),this.updatePresence=function(forced){$log.info("[contactService] updatePresence"),that.manualState?($log.info("[contactService] updatePresence manualState"),"away"===that.userContact.status&&that.busyState&&"dnd"===that.busyState.status&&(that.setUserContactStatus("online","mode=auto"),$interval((function(){that.updatePresence()}),1e3,1,!0))):!that.presentationModeActive||that.busyState&&that.busyState.status?that.busyState&&"dnd"===that.busyState.status?($log.info("[contactService] updatePresence dnd "+that.busyState.message),xmppService.sendPresence("dnd",that.busyState.message)):that.awayStateActive?($log.info("[contactService] updatePresence away"),xmppService.sendPresence("away","")):that.userContact&&"online"!==that.userContact.status?($log.info("[contactService] updatePresence online"),that.setUserContactStatus("online")):forced&&that.userContact&&"online"===that.userContact.status&&($log.info("[contactService] updatePresence forced online"),that.setUserContactStatus("online")):($log.info("[contactService] updatePresence dnd presentation"),xmppService.sendPresence("dnd","presentation"))},this.removeContact=function(contact){return $q((function(resolve,reject){if(!contact)return $log.error("[contactService] removeContact : missing contact !"),void reject();$log.info("[contactService] removeContact : "+contact.displayNameForLog()),that.removeContactFromRoster(contact.dbId).then((function(){$log.info("[contactService] removeContact : "+contact.displayNameForLog()+" success"),resolve()})).catch((function(error){$log.error("[contactService] removeContact: "+contact.displayNameForLog()+" failure : "+error.message),reject(error)}))}))},this.removeContactFromRoster=function(dbId){return $q((function(resolve,reject){if(!dbId)return $log.error("[contactService] removeContactFromRoster : missing id !"),void reject();$log.info("[contactService] removeContactFromRoster for id "+dbId);var serverUrl=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/networks/"+dbId;$http({method:"DELETE",url:serverUrl,headers:authService.getRequestHeader()}).then((function(){$log.info("[contactService] removeContactFromRoster success for id "+dbId),resolve()}),(function(response){var errorMessage="removeContactFromRoster failure: no server response";response&&(errorMessage="removeContactFromRoster failure: "+JSON.stringify(response)),$log.error("[contactService] "+errorMessage),reject(new Error(errorMessage))}))}))},this.sendUpdateEvent=function(contact){var event=that.isUserContact(contact)?"ON_USER_CONTACT_UPDATED_EVENT":"ON_CONTACT_UPDATED_EVENT";$rootScope.$broadcast(event,contact)},this.myMobileAvailable=function(){return that.userContact?that.userContact.mobileResource:null},this.notifyImByEmail=function(contact){return $q((function(resolve,reject){$http({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/notifications/emails/offline",headers:authService.getRequestHeader(),data:{userId:contact.dbId}}).then((function(response){var mail="";response.data&&response.data.data&&response.data.data.email&&(mail=response.data.data.email.substr(0,3)+"***"+response.data.data.email.substr(-3)),$log.info("[contactService] notifyImByEmail "+mail+" - success"),resolve()}),(function(response){$log.error("[contactService] notifyImByEmail failure ("+response.data.errorDetailsCode+") : "+response.data.errorDetails.errorMsg),reject(response)}))}))}}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var crypto_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3);angular.module("rainbow").service("botService",["$http","$q","$log","$rootScope","$interval","authService","contactService","conversationService",function($http,$q,$log,$rootScope,$interval,authService,contactService,conversationService){var service=this;service.listeners=[],service.start=function(stats){$log.info("[botService] === STARTING ===");var startDate=performance.now();return $q((function(resolve,reject){service.init(),service.startListeners(),service.getBots().then((function(bots){$log.info(""),service.findEmily(bots),service.unlockWaitingConversations();var startDuration=Math.round(performance.now()-startDate);stats.push({service:"botService",startDuration:startDuration}),$log.info("[botService] === STARTED ("+startDuration+" ms) ==="),$log.info(""),resolve()})).catch((function(error){$log.info("[botService] === STARTING FAILURE === "+error.message),reject()}))}))},service.stop=function(){$log.info("[botService] === STOPPED ===")},service.init=function(){service.emily=null,this.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/"},service.startListeners=function(){service.listeners.push($rootScope.$on("ON_COMPANY_SUPPORT_AVATAR_CHANGE_EVENT",service.onSupportAvatarChange))},service.stopListeners=function(){for(var listener;listener=listeners.pop();)listener()},service.onSupportAvatarChange=function(__event,supportAvatarInfo){$log.info("[botService] Emily avatar has been changed"),supportAvatarInfo.companyId===contactService.userContact.company.id&&service.getEmilyBot().then((function(supportBot){service.updateEmily(supportBot)})).catch((function(error){$log.warn("[botService] Impossible to update Emily - "+error.stack||!1)}))},service.getBots=function(format){return $q((function(resolve,reject){var url=service.portalURL+"bots?format="+(format||"full");$http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){$log.info("[botService] getBots success"),resolve(response.data.data)})).catch((function(response){var errorMessage="getBots failure "+response.data.errorDetails+" with status "+response.status;$log.error("[botService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.getEmilyBot=function(){return $q((function(resolve,reject){var url=service.portalURL+"bots/rainbow-support";$http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){$log.info("[botService] getEmilyBot success"),resolve(response.data.data)})).catch((function(response){var errorMessage="getEmilyBot failure "+response.data.errorDetails+" with status "+response.status;$log.error("[botService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.findEmily=function(bots){bots.forEach((function(bot){"Emily"===bot.name&&($log.info("[botService] Emily is found"),service.updateEmily(bot))}))},service.updateEmily=function(bot){service.emily=service.emily||bot,service.emily.name=bot.name,service.emily.id=bot.id,service.emily.avatarId=bot.avatarId||bot.id,service.emily.lastAvatarUpdateDate=bot.lastAvatarUpdateDate,service.emily.avatarUrl=service.getBotAvatarUrl(service.emily.avatarId,service.emily.lastAvatarUpdateDate),contactService.createBotContact(service.emily.jid,service.emily.name,service.emily.id,service.emily.avatarUrl),$log.info("[botService] Emily contact has been updated")},service.getEmily=function(){return service.emily},service.openConversationWithEmily=function(){return $q((function(resolve,reject){$log.info("[botService] openConversationWithEmily");var botContact=contactService.getContactByJid(service.emily.jid);conversationService.getOrCreateOneToOneConversation(botContact.jid).then((function(conversation){conversationService.setActiveConversation(conversation),resolve(conversation)})).catch((function(){$log.error("[botService] openConversationWithEmily failure"),reject()}))}))},service.unlockWaitingConversations=function(){conversationService.unlockWaitingBotConversations(!0)},service.getBotAvatarImage=function(avatarId,lastAvatarUpdateDate){return $q((function(resolve,reject){$log.info("[botService] getBotAvatarImage");var imgSrc=service.getBotAvatarUrl(avatarId,lastAvatarUpdateDate),image=new Image,nbErrors=0;image.onload=function(){var loadedImage=this;$interval((function(){$log.log("[botService] Load bot avatar "+avatarId+" lastAvatarUpdateDate "+lastAvatarUpdateDate+" success"),resolve(loadedImage)}),1,1)},image.onerror=function(){nbErrors++,$interval((function(){$log.warn("[botService] Load bor avatar "+avatarId+" lastAvatarUpdateDate "+lastAvatarUpdateDate+" failure"),1===nbErrors?($log.warn("[botService] Fallback to default emily avatar"),image.src="/resources/skins/rainbow/images/conversation/icon_headset.png"):reject(new Error("No image found"))}),1,1)},image.src=imgSrc}))},service.getBotAvatarUrl=function(botId,lastAvatarUpdateDate){var serverURL=config.webservices.protocol+"://"+config.webservices.currentServer;$rootScope.cdn&&(serverURL=$rootScope.cdnServer);var imgSrc=serverURL+"/api/avatar/"+botId+"?size=120";return imgSrc+=lastAvatarUpdateDate?"&update="+Object(crypto_js__WEBPACK_IMPORTED_MODULE_0__.MD5)(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Latin1.parse(lastAvatarUpdateDate)).toString(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Hex):"&update="+Date.now()}}])},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0});const call_model_1=__webpack_require__(0);angular.module("rainbow").service("conversationService",["$q","$log","$rootScope","$http","$interval","$translate","xmppService","authService","contactService","Conversation","videoService","telephonyService","roomService","settingsService","ConversationServiceEventHandler","ConversationServiceHistoryHandler","utilService","profileService","SearchTextConvResultsFactory","pstnConferenceService","webConferenceService","webrtcGatewayService",function($q,$log,$rootScope,$http,$interval,$translate,xmppService,authService,contactService,Conversation,videoService,telephonyService,roomService,settingsService,ConversationServiceEventHandler,ConversationServiceHistoryHandler,utilService,profileService,SearchTextConvResultsFactory,pstnConferenceService,webConferenceService,webrtcGatewayService){var service=this;this.started=!1;service.start=stats=>{$log.info(""),$log.info("[conversationService] === STARTING ===");var defered=$q.defer(),startDate=performance.now();return this.pendingMessages={},this.activeConversation=null,this.conversations=[],this.conversationCreationPromise={},this.inCallConversations=[],this.idleConversations=[],this.involvedContactIds=[],this.searchTextResults=SearchTextConvResultsFactory(),this.waitingBotConversations=[],this.botServiceReady=!1,this.isBasicCallAllowed=profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_BASIC_CALL),this.isSecondCallAllowed=profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_SECOND_CALL),this.attachHandlers(),$log.info("[conversationService] getServerConversations"),service.getServerConversations().then(()=>{service.started=!0,service.linkAllActiveCallsToConversations();var startDuration=Math.round(performance.now()-startDate);stats.push({service:"conversationService",startDuration:startDuration}),$log.info("[conversationService] === STARTED ("+startDuration+" ms) ==="),defered.resolve()}).catch(error=>{$log.info("[conversationService] === STARTING FAILURE === "+error.message),defered.reject(error)}),this.contactUpdateEventHandlerCleaner&&($log.warn("[conversationService] already subscribed to event ON_CONTACT_UPDATED_EVENT, rehandle it"),this.contactUpdateEventHandlerCleaner()),this.contactUpdateEventHandlerCleaner=$rootScope.$on("ON_CONTACT_UPDATED_EVENT",this.onContactChangedEvent),this.roomUpdateEventHandlerCleaner&&($log.warn("[conversationService] already subscribed to event "+roomService.ROOM_UPDATE_EVENT+", rehandle it"),this.roomUpdateEventHandlerCleaner()),this.roomUpdateEventHandlerCleaner=$rootScope.$on(roomService.ROOM_UPDATE_EVENT,this.onRoomChangedEvent),this.roomAddConferenceEventHandlerCleaner&&($log.warn("[conversationService] already subscribed to event "+roomService.ROOM_ADD_CONF_ENDPOINT_EVENT+", rehandle it"),this.roomAddConferenceEventHandlerCleaner()),this.roomAddConferenceEventHandlerCleaner=$rootScope.$on(roomService.ROOM_ADD_CONF_ENDPOINT_EVENT,this.onRoomAddConferenceEvent),this.roomHistoryUpdateEventHandlerCleaner&&($log.warn("[conversationService] already subscribed to event "+roomService.ROOM_HISTORY_UPDATE_EVENT+", rehandle it"),this.roomHistoryUpdateEventHandlerCleaner()),this.roomHistoryUpdateEventHandlerCleaner=$rootScope.$on(roomService.ROOM_HISTORY_UPDATE_EVENT,this.onRoomHistoryChangedEvent),this.roomAdminMessageEventHandlerCleaner&&($log.warn("[conversationService] already subscribed to event "+roomService.ROOM_ADMIN_MESSAGE_EVENT+", rehandle it"),this.roomAdminMessageEventHandlerCleaner()),this.roomAdminMessageEventHandlerCleaner=$rootScope.$on(roomService.ROOM_ADMIN_MESSAGE_EVENT,this.onRoomAdminMessageEvent),this.callUpdateEventHandlerCleaner&&($log.warn("[conversationService] already subscribed to event ON_CALL_UPDATED_EVENT, rehandle it"),this.callUpdateEventHandlerCleaner()),this.callUpdateEventHandlerCleaner=$rootScope.$on("ON_CALL_UPDATED_EVENT",this.onCallEvent),this.conversationUpdateEventHandlerCleaner&&($log.warn("[conversationService] already subscribed to event ON_CONVERSATIONS_UPDATED_EVENT, rehandle it"),this.conversationUpdateEventHandlerCleaner()),this.conversationUpdateEventHandlerCleaner=$rootScope.$on("ON_CONVERSATIONS_UPDATED_EVENT",this.onConversationEvent),this.capacityUpdateEventHandlerCleaner&&($log.warn("[conversationService] already subscribed to event ON_UPDATE_MYCONTACT_EVENT, rehandle it"),this.capacityUpdateEventHandlerCleaner()),this.capacityUpdateEventHandlerCleaner=$rootScope.$on("ON_UPDATE_MYCONTACT_EVENT",this.onMyContactChangedEvent),this.telephonyStateEventHandlerCleaner&&($log.warn("[conversationService] already subscribed to event ON_TELEPHONY_STATUS_CHANGED_EVENT, rehandle it"),this.telephonyStateEventHandlerCleaner()),this.telephonyStateEventHandlerCleaner=$rootScope.$on("ON_TELEPHONY_STATUS_CHANGED_EVENT",this.onTelephonyStateChangeEvent),this.conferenceStateEventHandlerCleaner&&($log.warn("[conversationService] already subscribed to event ON_CONFERENCE_STATE_EVENT, rehandle it"),this.conferenceStateEventHandlerCleaner()),this.conferenceStateEventHandlerCleaner=$rootScope.$on("ON_CONFERENCE_STATE_EVENT",this.onConferenceStateChangeEvent),this.conferenceParticipantsEventHandlerCleaner&&($log.warn("[conversationService] already subscribed to event ON_CONFERENCE_PARTICIPANT_EVENT, rehandle it"),this.conferenceParticipantsEventHandlerCleaner()),this.conferenceParticipantsEventHandlerCleaner=$rootScope.$on("ON_CONFERENCE_PARTICIPANT_EVENT",this.onConferenceParticipantChangeEvent),this.reloadCapabilitiesForMyContactEventHandlerCleaner&&($log.warn("[conversationService] already subscribed to event ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT, rehandle it"),this.reloadCapabilitiesForMyContactEventHandlerCleaner()),this.reloadCapabilitiesForMyContactEventHandlerCleaner=$rootScope.$on("ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT",this.onReloadCapabilitiesForMyContactEvent),defered.promise},this.attachHandlers=()=>{this.removeHandlers(),$log.info("[conversationService] attachHandlers"),this.conversationHistoryHandler=ConversationServiceHistoryHandler.create(this),this.conversationServiceEventHandler=ConversationServiceEventHandler.create(this),xmppService.addHistoryHandler(stanza=>service.conversationHistoryHandler.onHistoryMessageReceived(stanza)),xmppService.addSearchTextHandler((queryId,stanza)=>{if($log.info("[conversationService] addSearchTextHandler"),service.searchTextResults.isCurrentQuery(queryId)){$log.info("[conversationService] searchText: queryId are matching");var searchTextItem=service.conversationHistoryHandler.onSearchTextMessageReceived(stanza);searchTextItem&&($log.info("[conversationService] searchText: save item result"),service.searchTextResults.addNewItemResult(searchTextItem.otherJid,searchTextItem))}else $log.info("[conversationService] searchText: queryId are NOT matching : "+queryId)}),this.messageHandlerRef||(this.messageHandlerRef=xmppService.addHandler(stanza=>(service.conversationServiceEventHandler.onChatMessageReceived(stanza),!0),null,"message","chat")),this.messageMucHandlerRef||(this.messageMucHandlerRef=xmppService.addHandler(stanza=>(service.conversationServiceEventHandler.onChatMessageReceived(stanza),!0),null,"message","groupchat")),this.fileMessageHandlerRef||(this.fileMessageHandlerRef=xmppService.addHandler(stanza=>(service.conversationServiceEventHandler.onFileMessageReceived(stanza),!0),null,"message","file")),this.webrtcMessageHandlerRef||(this.webrtcMessageHandlerRef=xmppService.addHandler(stanza=>(service.conversationServiceEventHandler.onWebRTCMessageReceived(stanza),!0),null,"message","webrtc")),this.convMessageHandlerRef||(this.convMessageHandlerRef=xmppService.addHandler(stanza=>(service.conversationServiceEventHandler.onManagementMessageReceived(stanza),!0),null,"message","management")),this.receiptMessageHandlerRef||(this.receiptMessageHandlerRef=xmppService.addHandler(stanza=>(service.conversationServiceEventHandler.onReceiptMessageReceived(stanza),!0),null,"message")),this.audioConfMessageHandlerRef||(this.audioConfMessageHandlerRef=xmppService.addHandler(stanza=>(service.conversationServiceEventHandler.onConferenceMessageReceived(stanza),!0),"jabber:x:audioconference","message","chat"))},this.removeHandlers=()=>{$log.info("[conversationService] removeHandlers "),this.conversationHistoryHandler&&(this.conversationHistoryHandler=null),this.conversationServiceEventHandler&&(this.conversationServiceEventHandler=null),this.messageHandlerRef&&(xmppService.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.fileMessageHandlerRef&&(xmppService.deleteHandler(this.fileMessageHandlerRef),this.fileMessageHandlerRef=null),this.webrtcMessageHandlerRef&&(xmppService.deleteHandler(this.webrtcMessageHandlerRef),this.webrtcMessageHandlerRef=null),this.convMessageHandlerRef&&(xmppService.deleteHandler(this.convMessageHandlerRef),this.convMessageHandlerRef=null),this.receiptMessageHandlerRef&&(xmppService.deleteHandler(this.receiptMessageHandlerRef),this.receiptMessageHandlerRef=null),this.messageMucHandlerRef&&(xmppService.deleteHandler(this.messageMucHandlerRef),this.messageMucHandlerRef=null),this.recordingMessageHandlerRef&&(xmppService.deleteHandler(this.recordingMessageHandlerRef),this.recordingMessageHandlerRef=null),this.audioConfMessageHandlerRef&&(xmppService.deleteHandler(this.audioConfMessageHandlerRef),this.audioConfMessageHandlerRef=null)},service.stop=()=>($log.info("[conversationService] === STOPPING ==="),this.conversations=null,this.messageHandlerRef&&(xmppService.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.fileMessageHandlerRef&&(xmppService.deleteHandler(this.fileMessageHandlerRef),this.fileMessageHandlerRef=null),this.webrtcMessageHandlerRef&&(xmppService.deleteHandler(this.webrtcMessageHandlerRef),this.webrtcMessageHandlerRef=null),this.recordingMessageHandlerRef&&(xmppService.deleteHandler(this.recordingMessageHandlerRef),this.recordingMessageHandlerRef=null),this.audioConfMessageHandlerRef&&(xmppService.deleteHandler(this.audioConfMessageHandlerRef),this.audioConfMessageHandlerRef=null),this.contactUpdateEventHandlerCleaner&&(this.contactUpdateEventHandlerCleaner(),this.contactUpdateEventHandlerCleaner=null),this.roomUpdateEventHandlerCleaner&&(this.roomUpdateEventHandlerCleaner(),this.roomUpdateEventHandlerCleaner=null),this.roomAddConferenceEventHandlerCleaner&&(this.roomAddConferenceEventHandlerCleaner(),this.roomAddConferenceEventHandlerCleaner=null),this.roomAdminMessageEventHandlerCleaner&&(this.roomAdminMessageEventHandlerCleaner(),this.roomAdminMessageEventHandlerCleaner=null),this.callUpdateEventHandlerCleaner&&(this.callUpdateEventHandlerCleaner(),this.callUpdateEventHandlerCleaner=null),this.conversationUpdateEventHandlerCleaner&&(this.conversationUpdateEventHandlerCleaner(),this.conversationUpdateEventHandlerCleaner=null),this.capacityUpdateEventHandlerCleaner&&(this.capacityUpdateEventHandlerCleaner(),this.capacityUpdateEventHandlerCleaner=null),this.telephonyStateEventHandlerCleaner&&(this.telephonyStateEventHandlerCleaner(),this.telephonyStateEventHandlerCleaner=null),this.started=!1,this.isReinit=!1,$log.info("[conversationService] === STOPPED ==="),$q.when()),service.getServerConversations=()=>$q((resolve,reject)=>{$http({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+contactService.userContact.dbId+"/conversations",headers:authService.getRequestHeader()}).then(response=>{$log.info("[conversationService] getServerConversations -- success");var conversationPromises=[];response.data.data.forEach(conversationData=>{$log.info("[conversationService] getServerConversations -- create conversation "+conversationData.jid_im+" "+conversationData.id);var missedImCounter=parseInt(conversationData.unreadMessageNumber,10),conversationPromise=null,muted=!0===conversationData.mute;conversationPromise="user"===conversationData.type?service.getOrCreateOneToOneConversation(conversationData.jid_im,conversationData.id,conversationData.lastMessageDate,conversationData.lastMessageText,missedImCounter,muted,conversationData.creationDate):service.getRoomConversation(conversationData.jid_im,conversationData.id,conversationData.lastMessageDate,conversationData.lastMessageText,missedImCounter,!0,muted,conversationData.creationDate,conversationData.lastMessageSender,conversationData.topic,conversationData.type),conversationPromises.push(conversationPromise)}),$q.all(conversationPromises).then(()=>service.removeOlderConversations()).then(()=>{service.orderConversations(),resolve()}).catch(error=>{var errorMessage="getServerConversations failure: "+error.message;$log.error("[conversationService] "+errorMessage),reject(new Error(errorMessage))})},response=>{var errorMessage="getServerConversations failure: no server response";response&&(errorMessage="getServerConversations failure: "+JSON.stringify(response)),$log.error("[conversationService] "+errorMessage),reject(new Error(errorMessage))})}),this.createServerConversation=conversation=>$q((resolve,reject)=>{if(conversation.dbId)resolve(conversation);else{var url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+contactService.userContact.dbId+"/conversations",data=null;switch(conversation.type){case Conversation.Type.ONE_TO_ONE:data={peerId:conversation.contact.dbId,type:"user"};break;case Conversation.Type.ROOM:data={peerId:conversation.room.dbId,type:"room"};break;case Conversation.Type.BOT:conversation.type=Conversation.Type.ONE_TO_ONE,data={peerId:conversation.contact.dbId,type:"bot"}}$http({method:"POST",url:url,headers:authService.getRequestHeader(),data:data}).then(response=>{conversation.dbId=response.data.data.id,resolve(conversation)}).catch(response=>{var errorMessage="createServerConversation failure: unknown ... ";response.data&&response.data.errorDetails&&(errorMessage="createServerConversation failure: "+response.data.errorDetails),$log.warn("[conversationService] "+errorMessage),reject(new Error(errorMessage))})}}),this.deleteServerConversation=conversationId=>{var defered=$q.defer();return conversationId?($http({method:"DELETE",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+contactService.userContact.dbId+"/conversations/"+conversationId,headers:authService.getRequestHeader()}).then(()=>{$log.info("[conversationService] deleteServerConversation success: "+conversationId),service.orderConversations(),defered.resolve()},response=>{if(404002===response.data.errorDetailsCode)$log.info("[conversationService] deleteServerConversation success: "+conversationId),defered.resolve();else{var errorMessage="deleteServerConversation failure: "+response.data.errorDetails;$log.warn("[conversationService] "+errorMessage),defered.reject(new Error(errorMessage))}}),defered.promise):$q.when()},this.updateServerConversation=conversation=>{var defered=$q.defer();return conversation?($http({method:"PUT",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+contactService.userContact.dbId+"/conversations/"+conversation.dbId,headers:authService.getPostHeader(),data:{mute:conversation.muted}}).then(()=>{$log.info("[conversationService] updateServerConversation success: "+conversation.dbId),defered.resolve()},response=>{var errorMessage="updateServerConversation failure: "+response.data.errorDetails;$log.warn("[conversationService] "+errorMessage),defered.reject(new Error(errorMessage))}),defered.promise):$q.when()},this.ackAllMessages=conversationDbId=>$q((resolve,reject)=>{if(!conversationDbId)return $log.error("[conversationService] ackAllMessages for conversation error -- missing conversation id"),void reject();var conversation=service.getConversationByDbId(conversationDbId);if(!conversation)return $log.error("[conversationService] ackAllMessages for conversation error -- can not find conversation"),void reject();$log.info("[conversationService] ackAllMessages for conversation "+conversationDbId),conversation.ackReadAllMessages(),$http({method:"PUT",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+contactService.userContact.dbId+"/conversations/"+conversationDbId+"/markallread",headers:authService.getPostHeader()}).then(()=>{$log.info("[conversationService] ackAllMessages success: "+conversationDbId),resolve()},response=>{var errorMessage="ackAllMessages failure: "+response.data.errorDetails;$log.warn("[conversationService] "+errorMessage),reject(new Error(errorMessage))})}),this.getConversationAsyncById=(conversationId,type)=>{return this["room"===type?"getRoomConversation":"getOrCreateOneToOneConversation"](conversationId)},this.getOrCreateOneToOneConversation=(conversationId,conversationDbId,lastModification,lastMessageText,missedIMCounter,muted,creationDate)=>{if($log.info("[conversationService] getOrCreateOneToOneConversation "+conversationId+" "+conversationDbId+" "+missedIMCounter),!service.conversationCreationPromise[conversationId]){var conv=service.getConversationById(conversationId);if(conv)return conv.preload=!0,$q.resolve(conv);service.conversationCreationPromise[conversationId]=$q((resolve,reject)=>{contactService.getOrCreateContact(conversationId).then(contact=>{var conversation=Conversation.createOneToOneConversation(contact);return conversation.lastModification=lastModification?new Date(lastModification):void 0,conversation.lastMessageText=lastMessageText,conversation.muted=muted,conversation.creationDate=creationDate?new Date(creationDate):new Date,conversation.preload=!1,service.computeCapabilitiesForContact(contact),conversation.dbId=conversationDbId,conversation.missedCounter=missedIMCounter||0,service.createServerConversation(conversation)}).then(conversation=>{service.conversations[conversation.contact.id]=conversation,service.orderConversations(),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation,Conversation.EventType.NEW),resolve(conversation),delete service.conversationCreationPromise[conversationId]}).catch(error=>{var errorMessage="getOrCreateOneToOneConversation "+conversationId+" failure "+error.message;$log.error("[conversationService] "+errorMessage),reject(new Error(errorMessage)),delete service.conversationCreationPromise[conversationId]})})}return service.conversationCreationPromise[conversationId]},this.getRoomConversation=(roomJid,conversationDbId,lastModification,lastMessageText,missedIMCounter,noError,muted,creationDate,lastMessageSender,topic,type)=>{if($log.info("[conversationService] getRoomConversation "+roomJid),!service.conversationCreationPromise[roomJid]){var conv=service.getConversationById(roomJid);if(conv)return conv.preload=!0,$q.resolve(conv);service.conversationCreationPromise[roomJid]=$q((resolve,reject)=>{$interval(()=>{var room=roomService.getRoomByJid(roomJid);if(room){var conversation=Conversation.createRoomConversation(room);conversation.dbId=conversationDbId,conversation.lastModification=lastModification?new Date(lastModification):void 0,conversation.lastMessageText=lastMessageText,conversation.muted=muted,conversation.creationDate=creationDate?new Date(creationDate):new Date,conversation.preload=!1,conversation.lastMessageSender=lastMessageSender,conversation.room&&topic&&(conversation.room.desc=topic),missedIMCounter&&(conversation.missedCounter=missedIMCounter),conversationDbId?(service.conversations[conversation.id]=conversation,service.getRoomConferences(conversation).then(()=>{$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation,Conversation.EventType.NEW),resolve(conversation),delete service.conversationCreationPromise[roomJid]}).catch(error=>{var errorMessage="getRoomConversation "+roomJid+" failure "+error.message;$log.error("[conversationService] "+errorMessage),reject(new Error(errorMessage)),delete service.conversationCreationPromise[roomJid]})):service.createServerConversation(conversation).then(conversation=>{var room=roomService.getRoomByJid(roomJid);conversation.room=room,service.conversations[conversation.id]=conversation,service.orderConversations(),room&&"unsubscribed"!==room.status&&room.isActive&&roomService.sendInitialRoomPresence(room),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation,Conversation.EventType.NEW),resolve(conversation),delete service.conversationCreationPromise[roomJid]})}else{"bot"!==type&&$log.error("[conversationService] getRoomConversation ("+roomJid+") failure : no such room");var obj={jid:roomJid,conversationDbId:conversationDbId,lastModification:lastModification,lastMessageText:lastMessageText,missedIMCounter:missedIMCounter,muted:muted,creationDate:creationDate};service.waitingBotConversations.push(obj),service.unlockWaitingBotConversations(),resolve(),delete service.conversationCreationPromise[roomJid]}},1,1)})}return service.conversationCreationPromise[roomJid]},service.getRoomConferences=conversation=>$q(resolve=>{var confEndpoints=conversation.room.confEndpoints;confEndpoints&&confEndpoints.forEach(confEndpoint=>{if("pstnAudio"===confEndpoint.mediaType){var conferenceSession=pstnConferenceService.getConferenceSessionById(confEndpoint.confEndpointId);conferenceSession&&(conversation.pstnConferenceSession=conferenceSession)}}),resolve()}),service.updateRoomConferences=()=>{service.getConversations().forEach(conversation=>{if(conversation.room&&conversation.room.confEndpoints){var conferenceSession=pstnConferenceService.getConferenceSessionById(conversation.room.getPstnConfEndpointId());conversation.pstnConferenceSession=conferenceSession||null;var webConfSession=webConferenceService.getConferenceSessionForRoom(conversation.room.confEndpoints);conversation.webConferenceSession=webConfSession||null}else conversation.pstnConferenceSession=null,conversation.webConferenceSession=null})},this.closeConversation=conversation=>$q((resolve,reject)=>{$log.info("[conversationService] closeConversation "+conversation.id),service.deleteServerConversation(conversation.dbId).then(()=>{service.removeConversation(conversation),resolve()}).catch(error=>{reject(error)})}),this.removeConversation=conversation=>{if($log.info("[conversationService] remove conversation "+conversation.id),conversation.videoCall&&conversation.videoCall.status!==call_model_1.Call.Status.UNKNOWN)$log.info("[conversationService] Ignore conversation deletion message for conversation"+conversation.id);else{delete service.conversations[conversation.id],service.orderConversations();var conversations=service.getOrderedConversations();!service.activeConversation||conversations.idle.indexOf(service.activeConversation)>=0||(conversations.idle.length>0?service.setActiveConversation(conversations.idle.first()):conversations.inCall.length>0?service.setActiveConversation(conversations.inCall.first()):service.setActiveConversation(null)),conversation.contact&&(conversation.contact.conversation=null,conversation.contact=null),$rootScope.$broadcast("ON_CONVERSATION_REMOVE_EVENT",conversation)}},this.getConversationByDbId=dbId=>{if(service.conversations)for(var key in service.conversations)if(service.conversations.hasOwnProperty(key)&&service.conversations[key].dbId===dbId)return service.conversations[key];return null},this.getConversationByRoomDbId=roomDbId=>{if(service.conversations)for(var key in service.conversations)if(service.conversations.hasOwnProperty(key)&&service.conversations[key].room&&service.conversations[key].room.dbId===roomDbId)return service.conversations[key];return null},this.removeOlderConversations=()=>{if(!authService.fromSDK){var maxConversations=parseInt(settingsService.getSetting("nbMaxConversations"),10);(!maxConversations||maxConversations<15)&&(settingsService.setSetting("nbMaxConversations",15),maxConversations=15);var orderedConversations=service.getConversations().sort(service.sortFunction);if($log.info("[conversationService] removeOlderConversations -- maxConversations : "+maxConversations),orderedConversations.length>maxConversations){$log.info("[conversationService] removeOlderConversations -- orderedConversations : "+orderedConversations.length);for(var removePromises=[],index=maxConversations;index<orderedConversations.length;index++)removePromises.push(service.closeConversation(orderedConversations[index]));return $q.all(removePromises)}}return $q.when()},this.searchConversations=criteria=>{var queries=utilService.removeDiacritis(criteria.toLowerCase()).trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").split(/[ -]+/);return service.getOrderedConversations().idle.filter(conversation=>{var names=conversation.filterName.trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").split(/[ -]+/);return queries.every(query=>names.some((name,index)=>!(!name.length||-1===name.indexOf(query))&&(names[index]="",!0)))})},this.cleanFile=file=>{let stripScripts=s=>{let div=document.createElement("div");div.innerHTML=s;let scripts=div.getElementsByTagName("script"),i=scripts.length;for(;i--;)scripts[i].parentNode.removeChild(scripts[i]);return div.innerHTML};return new Promise(resolve=>{if("image/svg+xml"===file.type){let reader=new FileReader;reader.addEventListener("loadend",e=>{let elem=e.srcElement,cleanblob=new Blob([stripScripts(elem.result)],{type:"image/svg+xml"}),cleanFile=new File([cleanblob],file.name,{type:"image/svg+xml",lastModified:Date.now()});resolve(cleanFile)}),reader.readAsText(file)}else resolve(file)})},this.sendFSMessage=(conversation,file,data,voiceMessageData)=>__awaiter(this,void 0,void 0,(function*(){try{let cleanFile=file;data&&0!==data.length||(data=cleanFile.name);let message=yield conversation.sendFSMessage(cleanFile,data,voiceMessageData);return service.pendingMessages[message.id]={conversation:conversation,message:message},message}catch(error){var msgKey=error.translatedMessage?error.translatedMessage:"Unable to share file";throw 403153===error.errorDetailsCode&&(msgKey=$translate.instant("fileSharingNoMoreAllowedMsg")),$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"fileTransfer",popupBodyTranslated:msgKey,okLabel:"ok"}),new Error(error)}})),this.sendEFSMessage=(conversation,fileDescriptor,data,voiceMessage)=>{var message=conversation.sendEFSMessage(fileDescriptor,data,voiceMessage);return this.pendingMessages[message.id]={conversation:conversation,message:message},$rootScope.$broadcast("ON_SEND_EFS_MESSAGE",fileDescriptor),message},this.sendChatMessage=(conversation,data,alternativeContent,mentions)=>{var message=conversation.sendChatMessage(data,null,alternativeContent,mentions);return this.pendingMessages[message.id]={conversation:conversation,message:message},message},this.sendAnswerChatMessage=(conversation,data,answeredMsg,mentions)=>{var message=conversation.sendChatMessage(data,answeredMsg,null,mentions);return this.pendingMessages[message.id]={conversation:conversation,message:message},message},this.sendIsTypingState=(conversation,isTypingState)=>{conversation.sendIsTypingState(isTypingState)},this.sendRecordingMessage=(conversation,data)=>{var message=conversation.sendRecordingMessage(data);return this.pendingMessages[message.id]={conversation:conversation,message:message},message},this.sendCorrectedChatMessage=(conversation,data,origMsgId)=>{var originalMessage=conversation.getMessageById(origMsgId);if(originalMessage.from.jid===contactService.userContact.jid)if(conversation.lastEditableMsg.id===originalMessage.id){var sentMessageId=conversation.sendCorrectedChatMessage(originalMessage,data,origMsgId);this.pendingMessages[sentMessageId]={conversation:conversation,message:originalMessage}}else $log.info("[conversationService] sendCorrectedChatMessage forbidden Action - only last sent message can be modified");else $log.info("[conversationService] sendCorrectedChatMessage forbidden Action - only sent messages can be modified")},this.removeAllMessages=conversation=>{$log.info("[conversationService] removeAllMessage "+conversation.id);var defered=$q.defer(),mamRequest={queryid:xmppService.connection.getUniqueId(),with:conversation.id,onComplete:()=>{defered.resolve()}},queryId=xmppService.connection.getUniqueId();return xmppService.connection.mam.delete(queryId,mamRequest),defered.promise},this.removeMessagesFromConversation=(conversation,date,number)=>{$log.info("[conversationService] removeMessagesFromConversation "+conversation.id),$log.info("[conversationService] removing "+number+" messages after "+date);var defered=$q.defer(),mamRequest={queryid:"remove_"+conversation.id,with:conversation.id,start:moment(date).format("YYYY-MM-DDTHH:mm:ss.SSSSSSZ"),max:number,onComplete:()=>{$log.info("[conversationService] MAM Message deleted !!!"),defered.resolve()}};return xmppService.connection.mam.delete(conversation.id,mamRequest),defered.promise},this.sendConversationByEmail=conversation=>{var defered=$q.defer(),userContact=contactService.userContact,url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+userContact.dbId+"/conversations/"+conversation.dbId+"/downloads";return $http({method:"POST",url:url,headers:authService.getRequestHeader(),data:{}}).then(()=>{$log.error("[conversationService] sendConversationByEmail - success"),defered.resolve()},response=>{var error={message:"Impossible to download conversation",messageKey:null};response&&response.data&&409011===response.data.errorDetailsCode&&(error.message="No messages to export for the last 30 days.",error.messageKey="noMessagesToExport"),$log.error("[adminUserService] sendConversationByEmail - "+error.message),defered.reject(error)}),defered.promise},this.getHistoryPage=(conversation,size)=>service.isReinit?($log.debug("[conversationService] getHistoryPage --- service is reinitialising !"),$q.reject(new Error("Service is reinitialising !"))):service.conversationHistoryHandler.getHistoryPage(conversation,size),this.getHistoryPageAroundMsg=(conversation,centeredMsgDate)=>service.conversationHistoryHandler.getHistoryPageAroundMsg(conversation,20,centeredMsgDate+"000"),this.retrieveMsgByDate=(conversation,msgDate)=>($log.debug("[conversationService] >retrieveMsgByDate: "+msgDate),service.conversationHistoryHandler.retrieveMsgByDate(conversation,msgDate+"000")),this.clearSearchText=()=>{$log.debug("[conversationService] - clearSearchText"),this.searchTextResults.clearAll()},this.clearAndGetAllMessagesResults=(searchedText,rooms)=>{$log.debug("[conversationService] - clearAndGetAllMessagesResults"),this.searchTextResults.clearAll(),this.searchTextResults.searchCount();var promisesArray=[];rooms.forEach(room=>{(!room.desc||room.desc&&!room.desc.startsWith("Rainbow_OutlookCreation_InternalUseOnly"))&&promisesArray.push(service.searchTextInRoom(contactService.userContact.jid,room,searchedText,5,service.searchTextResults.searchCounter))}),$q.all(promisesArray).finally(()=>{$log.debug("[conversationService] - ALL SearchText Promises finished"),service.searchTextInConversations(searchedText,100)})},this.searchTextInConversations=(searchedText,limitSize)=>{$log.debug("[conversationService] - searchTextInConversations: "+searchedText);var defered=$q.defer(),queryId=xmppService.connection.getUniqueId();return this.searchTextResults.queryIds.push(queryId),this.searchTextResults.searchedText=searchedText,$log.debug("[conversationService] - searchTextResults QueryId: "+queryId),service.conversationHistoryHandler.searchTextInConversations(queryId,searchedText,limitSize).then(count=>{service.searchTextResults.totalCount+=parseInt(count,10),service.searchTextResults.results.forEach(item=>{if(item.convRes.sort((res1,res2)=>res1.date?res2.date?moment(res1.date).diff(moment(res2.date)):1:-1),!item.isRoom()){service.getConversationTextCount(searchedText,item.otherJid).then(convCount=>{item.totalCount=parseInt(convCount,10)});var contact=contactService.getContactByJid(item.otherJid);contact?(item.contact=contact,contact.avatar||contact.getAvatar()):contactService.getContactsByJids([item.otherJid]).then(()=>{if($log.info("[conversations] getContactsByJids success"),contact=contactService.getContactByJid(item.otherJid))item.contact=contact,contact.avatar||contact.getAvatar();else{$log.info("[conversations] Contact with Id "+item.otherJid+" not Found");var itemIndex=service.searchTextResults.results.indexOf(item);itemIndex>=0&&(service.searchTextResults.results.splice(itemIndex,1),service.searchTextResults.totalCount-=item.totalCount)}})}defered.resolve(parseInt(count,10))})}).catch(error=>{$log.warn("[conversationService] - searchTextInConversations: Error "+error.message),defered.reject(error)}),defered.promise},this.searchTextResultsInConversation=(searchedText,conversation)=>{$log.debug("[conversationService] - searchTextResultsInConversation: "+searchedText);var defered=$q.defer(),queryId=xmppService.connection.getUniqueId();return this.searchTextResults.queryIds.push(queryId),conversation.room?service.searchTextInRoom(contactService.userContact.jid,conversation.room,searchedText,5,this.searchTextResults.searchCounter).then(count=>{var searchTextResult=service.searchTextResults.createNewResult(conversation.id);searchTextResult.totalCount=parseInt(count,10),searchTextResult.conversation=conversation,searchTextResult.room=conversation.room,service.searchTextResults.results.forEach(item=>{item.convRes.sort((res1,res2)=>res1.date?res2.date?moment(res1.date).diff(moment(res2.date)):1:-1)}),service.searchTextResults.totalCount=parseInt(count,10),defered.resolve(parseInt(count,10))}):service.conversationHistoryHandler.searchTextResultsInConversation(queryId,searchedText,conversation.id,5).then(count=>{var searchTextResult=service.searchTextResults.createNewResult(conversation.id);searchTextResult.totalCount=parseInt(count,10),searchTextResult.contact=conversation.contact,searchTextResult.conversation=conversation,service.searchTextResults.results.forEach(item=>{item.convRes.sort((res1,res2)=>res1.date?res2.date?moment(res1.date).diff(moment(res2.date)):1:-1)}),service.searchTextResults.totalCount=parseInt(count,10),defered.resolve(parseInt(count,10))}),defered.promise},this.searchTextMoreResultsInConversation=(searchedText,conversation,messageDate)=>{$log.debug("[conversationService] - searchTextMoreResultsInConversation: "+searchedText);var defered=$q.defer(),queryId=xmppService.connection.getUniqueId();return this.searchTextResults.queryIds.push(queryId),conversation.room?service.conversationHistoryHandler.searchTextMoreResultsInRoom(queryId,searchedText,contactService.userContact.jid,conversation.room.jid,messageDate+"000",5).then(count=>{service.searchTextResults.results.forEach(item=>{item.convRes.sort((res1,res2)=>res1.date?res2.date?moment(res1.date).diff(moment(res2.date)):1:-1)}),defered.resolve(parseInt(count,10))}):service.conversationHistoryHandler.searchTextMoreResultsInConversation(queryId,searchedText,conversation.id,messageDate+"000",5).then(count=>{service.searchTextResults.results.forEach(item=>{item.convRes.sort((res1,res2)=>res1.date?res2.date?moment(res1.date).diff(moment(res2.date)):1:-1)}),defered.resolve(parseInt(count,10))}),defered.promise},this.getConversationTextCount=(searchedText,contactJid)=>{$log.debug("[conversationService] - getConversationTextCount: "+searchedText);var queryId=xmppService.connection.getUniqueId();return this.searchTextResults.queryIds.push(queryId),service.conversationHistoryHandler.getConversationTextCount(queryId,searchedText,contactJid)},this.searchTextInRoom=(userJid,room,searchedText,limitSize,searchCount)=>{$log.debug("[conversationService] - searchTextInRoom: "+searchedText);var defered=$q.defer();if(this.searchTextResults.searchCounter!==searchCount)return $log.debug("[conversationService] - counter has changed - skip promise"),defered.promise;var queryId=xmppService.connection.getUniqueId();return this.searchTextResults.queryIds.push(queryId),service.conversationHistoryHandler.searchTextInRoom(queryId,userJid,room.jid,searchedText,limitSize).then(count=>{$log.info("[conversationService] - searchTextInRoom: Room response received : "+count);var countValue=parseInt(count,10);countValue>0&&(service.searchTextResults.totalCount+=countValue,service.searchTextResults.results.forEach(item=>{item.otherJid===room.jid&&(item.totalCount=parseInt(count,10),item.room=room)})),defered.resolve(count)}).catch(error=>{$log.warn("[conversationService] - searchTextInRoom: Error "+error.message),defered.reject(error)}),defered.promise},this.setActiveConversation=conversation=>($log.debug("[conversationService] - setActiveConversation: "+(conversation?conversation.id:"null")),this.activeConversation=conversation,this.activeConversation),this.setMostRecentConversationActive=()=>{var conversations=service.getConversations().sort(service.sortFunction);return conversations.length>0?this.setActiveConversation(conversations.first()):this.setActiveConversation(null)},this.getActiveConversation=()=>this.activeConversation,this.getConversationById=conversationId=>service.conversations?service.conversations[conversationId]:null,this.getConversations=()=>{var conversationArray=[];for(var key in service.conversations)service.conversations.hasOwnProperty(key)&&conversationArray.push(service.conversations[key]);return conversationArray},this.orderConversations=()=>{service.inCallConversations=[],service.idleConversations=[],service.involvedContactIds=[],Object.keys(service.conversations).forEach(key=>{var conversation=service.conversations[key];if(conversation.type===Conversation.Type.ROOM&&conversation.room.owner&&conversation.room.isMeetingRoom()){var confSession=pstnConferenceService.getConferenceSessionById(conversation.room.getPstnConfEndpointId());if(confSession&&confSession.isActive())return}conversation.isInCall()?service.inCallConversations.push(conversation):service.idleConversations.push(conversation),conversation.type===Conversation.Type.ONE_TO_ONE&&service.involvedContactIds.push(conversation.contact.id)}),service.idleConversations.sort(service.sortFunction),$log.info("[conversationService] orderConversations"),service.idleConversations.forEach(conv=>{let log=conv.id+" || ";log+=conv.lastModification?conv.lastModification.toString():conv.creationDate,$log.info(log)})},this.getOrderedConversations=()=>({inCall:service.inCallConversations,idle:service.idleConversations,contactIds:service.involvedContactIds,favorites:service.favorites}),this.sortFunction=(aa,bb)=>{var aLast=aa.lastModification,aCreation=aa.creationDate,bLast=bb.lastModification,bCreation=bb.creationDate;return(!bLast&&bCreation?bCreation:bLast)-(!aLast&&aCreation?aCreation:aLast)},this.formatDate=date=>moment(date).utc().format("YYYY-MM-DDTHH:mm:ss")+"Z",this.resetConversationMissedCounters=conversation=>{$rootScope.appVisible&&(conversation.missedCounter=0,conversation.missedCalls=0,this.updateMissedCounters())},this.decreaseMissedIMCounterForConversation=conversation=>{conversation.missedCounter>0&&(conversation.missedCounter-=1),this.updateMissedCounters()};var currentMissedIMCounter=0,currentMissedCallCounter=0;this.updateMissedCounters=()=>{var missedIMCounter=0,missedIMDetails=[];Object.keys(service.conversations).forEach(key=>{var conversation=service.conversations[key];0!==conversation.missedCounter&&(missedIMCounter+=conversation.missedCounter,missedIMDetails.push(conversation))}),missedIMCounter===currentMissedIMCounter&&0===currentMissedCallCounter||(currentMissedIMCounter=missedIMCounter,currentMissedCallCounter=0,$rootScope.$broadcast("ON_MISSED_COUNTER_CHANGED_EVENT",{missedIMCounter:missedIMCounter,missedCallCounter:0,missedIMDetails:missedIMDetails}))},this.dropConversationCall=conversation=>{conversation.audioCall&&telephonyService.releaseCall(conversation.audioCall),conversation.videoCall&&(videoService.attachLocalMediaStream(!1),videoService.attachDistantMediaStream(!1),videoService.releaseCall(conversation.videoCall))},this.holdConversationCall=conversation=>{conversation.audioCall&&(telephonyService.holdCall(conversation.audioCall),conversation.videoCall&&(videoService.attachLocalMediaStream(!1),videoService.attachDistantMediaStream(!1),videoService.releaseCall(conversation.videoCall)))},this.retrieveConversationCall=conversation=>{conversation.audioCall&&telephonyService.retrieveCall(conversation.audioCall),conversation.videoCall&&$log.error("Not implemented for the moment")},this.allowDesktopSharing=()=>!1,this.allowAdvancedDesktopSharing=()=>!1,this.updateConversationCall=(conversation,call)=>{call.type===call_model_1.Call.Type.WEBRTC?conversation.videoCall=call:call.type===call_model_1.Call.Type.PHONE&&(conversation.audioCall=call),call.setConversationId(conversation.id),this.computeCapabilitiesForContact(conversation.contact),service.computeCapabilitiesForMyContact()},this.computeCapabilitiesForContact=(contact,skipUpdateConversation)=>{var telephony=!1,webRTC=!1,sharedDesktop=!1,fileTransfert=!1,addMedia=!1,contactStatus=contact.status,fullJid=contact.fullJid,myContact=contactService.userContact;if(contact.jid!==myContact.jid){var isContactInMyCompany=contact.company&&contactService.userContact.company&&"Rainbow"!==contact.company.name&&"Default"!==contact.company.name&&contact.company.name===contactService.userContact.company.name,conversation=this.getConversationById(contact.id);if(videoService.started){var videoCall=conversation?conversation.videoCall:null;videoCall&&videoCall.status!==call_model_1.Call.Status.UNKNOWN||!("unknown"===contactStatus&&isContactInMyCompany||"online"===contactStatus||"online-mobile"===contactStatus||"away"===contactStatus||"busy"===contactStatus&&"audioPhone"===contact.message)||(webRTC=!0,sharedDesktop=!0)}if(telephonyService.started){var phoneNumberAvailable=contact.phonePro||contact.phonePbx&&contact.pbxId||contact.mobilePro||contact.phonePerso||contact.mobilePerso,audioCalls=telephonyService.getActiveCallsForContact(contact);0===audioCalls.length&&phoneNumberAvailable&&(telephony=!0),(0!==audioCalls.length||videoService.getMediaPillarAudioCall())&&fullJid&&(addMedia=!0)}"online"!==contactStatus&&"busy"!==contactStatus&&"away"!==contactStatus&&"dnd"!==contactStatus||(fileTransfert=!0);var capabilities={telephony:telephony,webRTC:webRTC,sharedDesktop:sharedDesktop,fileTransfert:fileTransfert,mediaAvailable:telephony||webRTC,addMedia:addMedia};(contact.isBot||contact.displayName&&-1!==contact.displayName.indexOf("E-HELPER"))&&(capabilities={telephony:!1,webRTC:!1,sharedDesktop:!1,fileTransfert:!1,mediaAvailable:!1,addMedia:!1}),contact.capabilities=capabilities,conversation&&(conversation.capabilities=capabilities,skipUpdateConversation||$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation,Conversation.EventType.CAPABILITIES)),$log.info('[conversationService] update capabilities for contact "'+contact.displayNameForLog()+'" capabilities (tel:'+telephony+", webRTC:"+webRTC+", sharing: "+sharedDesktop+", addMedia: "+addMedia+")")}else this.computeCapabilitiesForMyContact()},this.computeCapabilitiesForMyContact=()=>{var telephony=!1,webRTC=!1,sharedDesktop=!1,myContact=contactService.userContact;if(videoService.started){var isInCallWebRtc=videoService.isUserContactInCall();isInCallWebRtc||"busy"===myContact.status&&("busy"!==myContact.status||"audioPhone"!==myContact.message)||(webRTC=!0,service.allowDesktopSharing()&&(sharedDesktop=!0)),isInCallWebRtc&&videoService.getMediaPillarAudioCall()&&!videoService.getCurrentSharingCall()&&service.allowDesktopSharing()&&(sharedDesktop=!0)}if(telephonyService.started){var calls=telephonyService.getCalls();webrtcGatewayService.isMediaPillarCallSituation()&&Object.keys(videoService.calls).length>=1?telephony=!!(calls.length>=1&&service.isSecondCallAllowed):(0===calls.length&&service.isBasicCallAllowed||1===calls.length&&service.isSecondCallAllowed)&&(telephony=!0)}var capabilities={telephony:telephony,webRTC:webRTC,sharedDesktop:sharedDesktop,mediaAvailable:telephony||webRTC};myContact.capabilities=capabilities,$log.info("[conversationService] update capabilities for my contact : capabilities (tel:"+telephony+", webRTC:"+webRTC+", sharing: "+sharedDesktop+")")},this.onCallEvent=(__event,call)=>{switch(call.type){case call_model_1.Call.Type.WEBRTC:if(webrtcGatewayService.isMediaPillarJid(call.fullJid))return void $rootScope.$broadcast("ON_MPMEDIA_CONVERSATION_CALL_UPDATED_EVENT",{call:call});service.getOrCreateOneToOneConversation(call.contact.id).then(conversation=>{service.updateConversationCall(conversation,call),service.orderConversations(),$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:conversation,call:call})});break;case call_model_1.Call.Type.PHONE:if(call.status===call_model_1.Call.Status.UNKNOWN&&(call.contact&&!telephonyService.getConferenceCallForContact(call.contact)&&videoService.endAllCallsForContact(call.contact),call.isConference&&$interval(()=>{(call.participants||[]).forEach(participantContact=>{participantContact&&0===telephonyService.getActiveCallsForContact(participantContact).length&&videoService.endAllCallsForContact(participantContact)})},1e3,1)),webrtcGatewayService.isMediaPillarCallSituation(call)){if(!call.isSecondary)return void $rootScope.$broadcast("ON_UPDATE_TELEPHONY_ICON_EVENT");if(call.status===call_model_1.Call.Status.RINGING_INCOMMING)return}if(call.status!==call_model_1.Call.Status.UNKNOWN&&null!==call.connectionId)if($log.info("[ConversationService] onCallEvent -- "+call.connectionId+"  -- relevantEquipmentId : "+call.relevantEquipmentId),call.getDeviceIdFromConnectionIdFromCall()!==call.relevantEquipmentId&&call.status!==call_model_1.Call.Status.ACTIVE)return void $rootScope.$broadcast("ON_UPDATE_TELEPHONY_ICON_EVENT");$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:call})}},this.onReloadCapabilitiesForMyContactEvent=__event=>{$log.info("[conversationService] onReloadCapabilitiesForMyContactEvent"),service.computeCapabilitiesForMyContact()},this.onConversationEvent=()=>{service.updateMissedCounters()},this.onContactChangedEvent=(__event,contact)=>{service.computeCapabilitiesForContact(contact),service.computeCapabilitiesForMyContact()},this.onTelephonyStateChangeEvent=__event=>{var conversations=service.getConversations();conversations&&conversations.forEach(conversation=>{conversation.type===Conversation.Type.ONE_TO_ONE&&service.computeCapabilitiesForContact(conversation.contact)}),service.computeCapabilitiesForMyContact()},this.onConferenceStateChangeEvent=()=>{service.updateRoomConferences(),service.orderConversations(),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")},this.onConferenceParticipantChangeEvent=()=>{service.orderConversations(),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")},this.onRoomChangedEvent=(__event,room,action)=>{if(room){var conversation=service.getConversationById(room.jid);conversation&&("remove"===action?service.closeConversation(conversation):conversation.room=room)}},this.onRoomHistoryChangedEvent=(__event,room)=>{if(room){var conversation=service.getConversationById(room.jid);conversation&&conversation.chatRenderer&&(conversation.reset(),conversation.chatRenderer.loadMore())}},this.onRoomAdminMessageEvent=(__event,roomJid,userJid,type,msgId)=>{$log.info("[conversationService] onRoomAdminMessageEvent");var conversation=service.getConversationById(roomJid);conversation&&"welcome"===type&&conversation.room&&conversation.room.ownerContact&&(userJid=conversation.room.ownerContact.jid);var contact=contactService.getContactByJid(userJid);if(conversation&&contact){if(!conversation.room.owner&&"invitation"===type)return;if(conversation.room&&conversation.room.isMeetingRoom())return;service.conversationServiceEventHandler.onRoomAdminMessageReceived(conversation,contact,type,msgId)}},this.onRoomAddConferenceEvent=__event=>{$log.info("[conversationService] onRoomAddConferenceEvent"),service.orderConversations(),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")},this.onMyContactChangedEvent=()=>{service.getOrderedConversations().idle.forEach(conversation=>{conversation.type===Conversation.Type.ONE_TO_ONE&&service.computeCapabilitiesForContact(conversation.contact)}),service.computeCapabilitiesForMyContact()},this.reinit=()=>{var defered=$q.defer();return $log.info("[conversationService] Re-initialize conversation service"),service.activeConversation&&(service.activeConversation.reset(),service.activeConversation=null),delete service.conversations,service.conversations=[],service.conversationCreationPromise||(service.conversationCreationPromise={}),service.botServiceReady=!0,service.isReinit=!0,$log.info("[conversationService] getServerConversations"),service.getServerConversations().then(()=>{service.isReinit=!1,service.linkAllActiveCallsToConversations(),$rootScope.$broadcast("ON_MISSED_COUNTER_CHANGED_EVENT",{missedIMCounter:currentMissedIMCounter,missedCallCounter:currentMissedCallCounter}),defered.resolve()}).catch(()=>{service.isReinit=!1,$interval(()=>{$log.info("[conversationService] getServerConversations failure, try again"),service.getServerConversations().then(()=>{service.linkAllActiveCallsToConversations()})},1e4,1,!0),defered.resolve()}),defered.promise},this.linkAllActiveCallsToConversations=()=>{for(var key in telephonyService.calls)if(telephonyService.calls.hasOwnProperty(key)){var call=telephonyService.calls[key];$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)}for(var key in videoService.calls)if(videoService.calls.hasOwnProperty(key)){call=videoService.calls[key];$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)}},this.unlockWaitingBotConversations=isBotServiceReady=>{isBotServiceReady&&(service.botServiceReady=!0),service.botServiceReady&&(service.botServiceReady=!1,service.waitingBotConversations.forEach((obj,index)=>{var contact=contactService.getContactByJid(obj.jid);contact&&(service.getOrCreateOneToOneConversation(contact.jid,obj.conversationDbId,obj.lastModification,obj.lastMessageText,obj.missedIMCounter,obj.muted,obj.creationDate),service.waitingBotConversations.splice(index,1))}),service.waitingBotConversations=[])}}])},function(module,exports){angular.module("rainbow").factory("ConversationServiceEventHandler",["$q","$log","$rootScope","contactService","xmppService","roomService","Conversation","Message","fileStorageService","fileServerService","webrtcGatewayService",function($q,$log,$rootScope,contactService,xmppService,roomService,Conversation,Message,fileStorageService,fileServerService,webrtcGatewayService){"use strict";function ConversationServiceEventHandler(conversationService){this.conversationService=conversationService}return ConversationServiceEventHandler.create=function(conversationService){return new ConversationServiceEventHandler(conversationService)},ConversationServiceEventHandler.prototype.onChatMessageReceived=function(stanza){$log.info("[ConversationServiceEventHandler] onChatMessageReceived");try{var that=this,stanzaElem=$(stanza);return stanzaElem.find("event").length>0||stanzaElem.find("propose").length>0||stanzaElem.find("received").length>0?$log.info("[ConversationServiceEventHandler] onChatMessageReceived ignore the message"):stanzaElem.find("recording").length>0?($log.info("[ConversationServiceEventHandler] onChatMessageReceived : recording msg case"),this.onRecordingMessageReceived(stanza)):this.extractStanzaData(stanza).then((function(stanzaData){stanzaData.body||stanzaData.oob||stanzaData.conference||stanzaData.replace?that.handleChatMessage(stanzaData):stanzaData.outgoingMessage||contactService.isUserContact(stanzaData.participant)||!stanzaData.status||that.handleStatusMessage(stanzaData.conversation,stanzaData.participant,stanza)})),!0}catch(error){return $log.error("[ConversationServiceEventHandler] onChatMessageReceived ERROR "+error),!0}},ConversationServiceEventHandler.prototype.onConferenceMessageReceived=function(stanza){$log.info("[ConversationServiceEventHandler] onConferenceMessageReceived");try{var that=this;return $(stanza).find("event").length>0?this.extractStanzaData(stanza).then((function(stanzaData){stanzaData.conference&&that.handleChatMessage(stanzaData)})):$log.info("[ConversationServiceEventHandler] onConferenceMessageReceived ignore the message"),!0}catch(error){return $log.error("[ConversationServiceEventHandler] onConferenceMessageReceived ERROR "+error),!0}},ConversationServiceEventHandler.prototype.onFileTransfertReceived=function(fileTransfert){var bareJid=xmppService.getBareJidFromJid(fileTransfert.from),that=this;this.conversationService.getOrCreateOneToOneConversation(bareJid).then((function(conversation){var participant=conversation.contact,messageId=Conversation.getUniqueMessageId(),message=conversation.addFTMessage(participant,new Date,fileTransfert,messageId);conversation.setStatusMessage(participant,Conversation.Status.ACTIVE),conversation===that.conversationService.activeConversation&&$rootScope.appVisible&&"conversations"===$rootScope.activeApplication||(conversation.missedCounter+=1),conversation.sendAckReceivedMessage(message),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation,Conversation.EventType.FILE)}))},ConversationServiceEventHandler.prototype.onRoomAdminMessageReceived=function(conversation,contact,type,msgId){$log.info("[ConversationServiceEventHandler] onRoomAdminMessageReceived");var message=conversation.addAdminBubbleMessage(contact,new Date,type,msgId);conversation.setStatusMessage(contact,Conversation.Status.ACTIVE),conversation.sendAckReceivedMessage(message),conversation===this.conversationService.activeConversation&&$rootScope.appVisible&&"conversations"===$rootScope.activeApplication||(conversation.missedCounter+=1),$rootScope.$broadcast("ON_CONVERSATION_MESSAGE_RECEIVED",message,conversation,!1),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation,Conversation.EventType.IM)},ConversationServiceEventHandler.prototype.onFileMessageReceived=function(stanza){$log.info("[ConversationServiceEventHandler] onFileMessageReceived");try{return this.extractStanzaData(stanza).then((function(stanzaData){if(stanzaData.body){var conversation=stanzaData.conversation;conversation.addFileMessage(stanzaData.participant,stanzaData.date,stanzaData.body,stanzaData.messageId),conversation.setStatusMessage(stanzaData.participant,Conversation.Status.ACTIVE),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation,Conversation.EventType.FILE)}})),!0}catch(error){return $log.error("[ConversationServiceEventHandler] onFileMessageReceived ERROR "+error),!0}},ConversationServiceEventHandler.prototype.onWebRTCMessageReceived=function(stanza){$log.info("[ConversationServiceEventHandler] onWebRTCMessageReceived");try{return angular.element(stanza).find("call_log").length>0?this.extractWebrtcStanzaData(stanza).then((function(stanzaData){if(stanzaData&&stanzaData.body){var conversation=stanzaData.conversation;conversation.addWebRTCMessage(stanzaData.participant,stanzaData.date,stanzaData.body,stanzaData.messageId),conversation.setStatusMessage(stanzaData.participant,Conversation.Status.ACTIVE),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation)}})):this.extractStanzaData(stanza).then((function(stanzaData){if(stanzaData&&stanzaData.body){var conversation=stanzaData.conversation;conversation.addWebRTCMessage(stanzaData.participant,stanzaData.date,stanzaData.body,stanzaData.messageId),conversation.setStatusMessage(stanzaData.participant,Conversation.Status.ACTIVE),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation)}})),!0}catch(error){return $log.error("[ConversationServiceEventHandler] onWebRTCMessageReceived error "+error),!0}},ConversationServiceEventHandler.prototype.onManagementMessageReceived=function(stanza){try{var that=this,stanzaElem=angular.element(stanza),conversationElem=stanzaElem.find("conversation");if(conversationElem){var action=conversationElem.attr("action"),conversationGetterPromise=null;if("create"===action){var jid=xmppService.getBareJidFromJid(conversationElem.find("peer").text()),convType=conversationElem.find("type").text();conversationGetterPromise=this.conversationService.getConversationAsyncById(jid,convType)}else conversationGetterPromise=$q.resolve(this.conversationService.getConversationByDbId(conversationElem.attr("id")));conversationGetterPromise.then((function(conversation){if($log.info("[ConversationServiceEventHandler] onManagementMessageReceived ("+action+" conversation)"),conversation)switch(action){case"create":conversation.dbId=conversationElem.attr("id"),conversation.lastModification=new Date(conversationElem.find("lastMessageDate").text()),conversation.missedCounter=parseInt(conversationElem.find("unreadMessageNumber").text(),10)||0,conversation.muted="true"===conversationElem.find("mute").text(),that.conversationService.favoriteService.updateFavorites(conversation),that.conversationService.orderConversations(),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT");break;case"delete":that.conversationService.removeConversation(conversation)}else if("create"===action){var convId=xmppService.getBareJidFromJid(conversationElem.find("peer").text()),convDbId=conversationElem.attr("id"),lastModification=new Date(conversationElem.find("lastMessageDate").text()),lastMessageText=conversationElem.find("lastMessageText").text(),lastMessageSender=conversationElem.find("lastMessageSender").text(),missedIMCounter=parseInt(conversationElem.find("unreadMessageNumber").text(),10)||0,muted="true"===conversationElem.find("mute").text(),type=conversationElem.find("type").text(),conversationGetter="room"===type?"getRoomConversation":"getOrCreateOneToOneConversation";that.conversationService[conversationGetter](convId).then((function(conv){$log.info("[ConversationServiceEventHandler] onManagementMessageReceived update conversation ("+conv.id+")"),conv.dbId=convDbId,conv.lastModification=lastModification?new Date(lastModification):void 0,conv.lastMessageText=lastMessageText,conv.lastMessageSender=lastMessageSender,conv.muted=muted,conv.preload=!0,conv.missedCounter=missedIMCounter,type===Conversation.Type.BOT&&(conv.type=Conversation.Type.ONE_TO_ONE),that.conversationService.favoriteService.updateFavorites(conv),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conv)}))}}))}if(stanzaElem.find("mute")||stanzaElem.find("unmute")){var muteElem=stanzaElem.find("mute"),mute=!1;muteElem.length&&(mute=!muteElem.text().length||"true"===muteElem.text());var conversationDbId=stanzaElem.find("mute").attr("conversation")||stanzaElem.find("unmute").attr("conversation"),conversation=this.conversationService.getConversationByDbId(conversationDbId);conversation&&($log.info("[ConversationServiceEventHandler] onManagementMessageReceived : mute is changed to "+mute),conversation.muted=mute)}}catch(error){return $log.error("[ConversationServiceEventHandler] onManagementMessageReceived error "+error),!0}return!0},ConversationServiceEventHandler.prototype.onReceiptMessageReceived=function(stanza){$log.info("[ConversationServiceEventHandler] onReceiptMessageReceived");try{var stanzaElement=angular.element(stanza),messageSender=xmppService.getBareJidFromJid(stanzaElement.attr("from")),carbonStanza=stanzaElement.find("message");contactService.isUserContactJid(messageSender)&&carbonStanza.length>0&&(stanzaElement=angular.element(carbonStanza));var recvMessage=stanzaElement.find("received");if(recvMessage.length&&recvMessage.length>0){var messageId=angular.element(recvMessage).attr("id"),entity=angular.element(recvMessage).attr("entity"),event=angular.element(recvMessage).attr("event");if("server"===entity&&"received"===event){var messageInfo=this.conversationService.pendingMessages[messageId];if(messageInfo&&messageInfo.message){var message=messageInfo.message,conversation=messageInfo.conversation;$log.info("[conversationService] Receive server ack ("+conversation.id+", "+message.id+")"),message.setReceiptStatus(Message.ReceiptStatus.SENT),conversation.updateMessage(message),delete this.conversationService.pendingMessages[messageId],$rootScope.$broadcast("ON_CONVERSATION_RECEIPT_RECEIVED",message,conversation,"server")}}else if("client"===entity){var that=this;this.extractStanzaData(stanza).then((function(stanzaData){that.handleReceiptReceiveMessage(stanzaData.conversation,stanza)}))}}else if(stanzaElement.find("mark_as_read").length){var conversationId=stanzaElement.find("mark_as_read").attr("with");if(conversation=this.conversationService.getConversationById(conversationId))switch(stanzaElement.find("mark_as_read").attr("id")){case"all-received":conversation.missedCounter=0;break;case"all-sent":conversation.ackReadAllMessages();break;default:$log.error("[ConversationServiceEventHandler] onReceiptMessageReceived error - unknown read type")}}else stanzaElement.find("voicemessage").length&&$log.debug("[ConversationServiceEventHandler] onReceiptMessageReceived VoiceMessage detected");return!0}catch(error){return $log.error("[ConversationServiceEventHandler] onReceiptMessageReceived error "+error),!0}},ConversationServiceEventHandler.prototype.extractStanzaData=function(stanza){var messageSender=xmppService.getBareJidFromJid(angular.element(stanza).attr("from")),stanzaData={},conversationId=null,resource=null,delay=null,defered=$q.defer(),carbonStanza=angular.element(stanza).find("message");if(contactService.isUserContactJid(messageSender)&&carbonStanza.length>0){var from=xmppService.getBareJidFromJid(angular.element(carbonStanza).attr("from")),fromResource=xmppService.getResourceFromJid(angular.element(carbonStanza).attr("from")),to=xmppService.getBareJidFromJid(angular.element(carbonStanza).attr("to")),toResource=xmppService.getResourceFromJid(angular.element(carbonStanza).attr("to"));if(stanzaData.outgoingMessage=contactService.isUserContactJid(from),stanzaData.body=angular.element(carbonStanza).find("body").text(),stanzaData.participant=stanzaData.outgoingMessage?contactService.userContact:null,stanzaData.messageId=angular.element(carbonStanza).attr("id"),stanzaData.carbon=!0,stanzaData.answeredMsg=angular.element(carbonStanza).find("answeredMsg"),stanzaData.alternativeContent=angular.element(carbonStanza).find("content"),conversationId=stanzaData.outgoingMessage?to:from,resource=stanzaData.outgoingMessage?toResource:fromResource,delay=angular.element(carbonStanza).find("delay"),(oob=angular.element(carbonStanza).find("x[xmlns='jabber:x:oob']"))&&oob.length){var url=angular.element(oob).find("url").text(),mime=angular.element(oob).find("mime").text(),filename=angular.element(oob).find("filename").text(),filesize=angular.element(oob).find("size").text();stanzaData.oob={url:url,mime:mime,filename:filename,filesize:filesize}}if((conference=$(stanza).find("x[xmlns='jabber:x:audioconference']"))&&conference.length){var subject=(conferenceElem=$(conference)).attr("subject"),confendpointid=conferenceElem.attr("confendpointid"),jid=conference.attr("jid"),type=conference.attr("type");stanzaData.conference={type:type,subject:subject,confendpointid:confendpointid,roomjid:jid,ownerjid:conversationId}}if((replace=carbonStanza.find("replace"))&&replace.length){var replaceId=replace.attr("id");stanzaData.replace={id:replaceId}}stanzaData.status=null;var composing=angular.element(stanza).find("composing"),paused=angular.element(stanza).find("paused"),active=angular.element(stanza).find("active");if(composing.length?stanzaData.status="composing":paused.length?stanzaData.status="paused":active.length&&(stanzaData.status="active"),(geoloc=angular.element(carbonStanza).find("geoloc"))&&geoloc.length){var lon=(geolocElem=$(geoloc)).find("lon").text(),lat=geolocElem.find("lat").text();stanzaData.geoloc={lon:lon,lat:lat}}(voiceMessage=angular.element(carbonStanza).find("voicemessage"))&&voiceMessage.length&&(stanzaData.voiceMessage=!0)}else{var stanzaElem=$(stanza);stanzaData.outgoingMessage=!1,stanzaData.body=stanzaElem.find("body").text(),stanzaData.messageId=stanzaElem.attr("id"),stanzaData.carbon=!1,stanzaData.answeredMsg=stanzaElem.find("answeredMsg"),stanzaData.alternativeContent=stanzaElem.find("content"),stanzaData.attention=stanzaElem.find("attention"),conversationId=xmppService.getBareJidFromJid(stanzaElem.attr("from")),resource=xmppService.getResourceFromJid(stanzaElem.attr("from")),delay=stanzaElem.find("delay");var oob,geoloc,voiceMessage,conference,replace,archived="push"===stanzaElem.find("retransmission").attr("source");if((oob=stanzaElem.find("x[xmlns='jabber:x:oob']"))&&oob.length){var oobElem=$(oob);url=oobElem.find("url").text(),mime=oobElem.find("mime").text(),filename=oobElem.find("filename").text(),filesize=oobElem.find("size").text();stanzaData.oob={url:url,mime:mime,filename:filename,filesize:filesize}}if((geoloc=stanzaElem.find("geoloc"))&&geoloc.length){var geolocElem;lon=(geolocElem=$(geoloc)).find("lon").text(),lat=geolocElem.find("lat").text();stanzaData.geoloc={lon:lon,lat:lat}}if((voiceMessage=stanzaElem.find("voicemessage"))&&voiceMessage.length&&(stanzaData.voiceMessage=!0),(conference=stanzaElem.find("x[xmlns='jabber:x:audioconference']"))&&conference.length){var conferenceElem,message=(conferenceElem=$(conference)).attr("message");confendpointid=conferenceElem.attr("confendpointid"),jid=conference.attr("jid"),type=conference.attr("type");if(stanzaData.conference={type:type,message:message,confendpointid:confendpointid,roomjid:jid,ownerjid:conversationId},"reminder"!==type)return $log.debug("[conversationServiceEventHandler] ignored message stanza for conference"),defered.resolve(stanzaData),defered.promise;conversationId=jid}if((replace=stanzaElem.find("replace"))&&replace.length){replaceId=replace.attr("id");stanzaData.replace={id:replaceId}}stanzaData.additionalContent=null;var contents=stanzaElem.find("content[xmlns='urn:xmpp:content']");contents&&contents.each((function(){stanzaData.additionalContent||(stanzaData.additionalContent={});var contentType=$(this).attr("type"),content=$(this).text();"text/markdown"===contentType&&(stanzaData.markdown=!0,stanzaData.body=content),stanzaData.additionalContent[contentType]={type:contentType,message:content}})),(subject=stanzaElem.find("subject"))&&""!==subject.text()&&(stanzaData.subject=subject.text()),stanzaData.status=null;composing=stanzaElem.find("composing"),paused=stanzaElem.find("paused"),active=stanzaElem.find("active");composing.length?stanzaData.status="composing":paused.length?stanzaData.status="paused":active.length&&(stanzaData.status="active")}if(stanzaData.date=new Date,stanzaData.offline=!1,"Offline Storage"===delay.text()&&(stanzaData.date=new Date(delay.attr("stamp")),stanzaData.offline=!0),archived){var conversation=this.conversationService.getConversationById(conversationId);if(conversation)defered.reject();else{var cs=this.conversationService;(conversationId.startsWith("room_")?cs.getRoomConversation(conversationId):cs.getOrCreateOneToOneConversation(conversationId)).then((function(conv){conversation=conv,defered.reject()}))}return defered.promise}var existingConv=this.conversationService.getConversationById(conversationId);if(stanzaData.convReady=existingConv&&null!=existingConv.dbId,stanzaData.body||existingConv||stanzaData.oob||stanzaData.conference)if(0===conversationId.indexOf("room_")){var room=roomService.getRoomByJid(conversationId),emptySubject=(subject=stanzaElem.find("subject")).length&&""===subject.text();room&&"accepted"!==room.status||emptySubject?$log.info("[conversationServiceEvent] extractStanzaData -- ignore this stanza message"):this.conversationService.getRoomConversation(conversationId).then((function(roomConv){return stanzaData.conversation=roomConv,stanzaData.conference&&stanzaData.conference.ownerjid?contactService.getOrCreateContact(stanzaData.conference.ownerjid):(resource&&-1!==resource.indexOf("/")&&(resource=resource.split("/")[0]),contactService.getOrCreateContact(resource))})).then((function(contact){stanzaData.participant=contact,defered.resolve(stanzaData)})).catch((function(error){$log.error("[conversationServiceEventHandler] impossible to fetch conversation "+error.message),defered.reject()}))}else this.conversationService.getOrCreateOneToOneConversation(conversationId).then((function(conv){stanzaData.conversation=conv,stanzaData.participant||(stanzaData.participant=conv.contact),defered.resolve(stanzaData)})).catch((function(error){$log.error("[conversationServiceEventHandler] impossible to fetch conversation "+error.message),defered.reject()}));else if($(stanza).find("deleted")){var deleted=$(stanza).find("deleted")[0];if(deleted&&"all"===deleted.getAttribute("id")){var conv=this.conversationService.getConversationById(deleted.getAttribute("with"));conv&&($log.info("[conversationServiceEventHandler] Remove all messages for conversation "+conv.id),conv.reset())}}else $log.debug("[conversationServiceEventHandler] ignored message stanza"),defered.reject();return defered.promise},ConversationServiceEventHandler.prototype.extractWebrtcStanzaData=function(stanza){$log.debug("[conversationServiceEventHandler] extractWebrtcStanzaData");var that=this;return $q((function(resolve,reject){var stanzaData={};stanzaData.messageId=$(stanza).attr("id"),stanzaData.callerJid=$(stanza).find("caller").text(),stanzaData.calleeJid=$(stanza).find("callee").text(),stanzaData.state=$(stanza).find("state").text();var conversationId=null;if(contactService.isUserContactJid(stanzaData.callerJid)?(conversationId=stanzaData.calleeJid,stanzaData.participant=contactService.userContact):conversationId=stanzaData.callerJid,-1!==conversationId.indexOf("janusgateway"))return $log.debug("[conversationServiceEventHandler] extractWebrtcStanzaData -- ignore Janus message"),reject();if(webrtcGatewayService.isMediaPillarJid(stanzaData.callerJid))return $log.debug("[conversationServiceEventHandler] extractWebrtcStanzaData -- ignore MediaPillar message"),resolve();var duration=0;$(stanza).find("duration")&&(duration=parseInt($(stanza).find("duration").text(),10)),stanzaData.duration=duration>0?"("+moment.duration(duration,"ms").format("h[H] mm[m] ss[s]")+")":0;var date=$(stanza).find("date").text();date&&(date=new Date(date)),stanzaData.date=date,stanzaData.body="","missed"===stanzaData.state?stanzaData.body="missedCall||"+date:"answered"===stanzaData.state&&(stanzaData.body="activeCallMsg||"+date+"||"+stanzaData.duration),that.conversationService.getOrCreateOneToOneConversation(conversationId).then((function(conversation){stanzaData.conversation=conversation,stanzaData.participant||(stanzaData.participant=conversation.contact),resolve(stanzaData)})).catch((function(error){$log.error("[conversationServiceEventHandler] impossible to fetch conversation "+error.message),reject()}))}))},ConversationServiceEventHandler.prototype.handleChatMessage=function(stanzaData){$log.info("[ConversationServiceEventHandler] handleChatMessage");var that=this,conversation=stanzaData.conversation,message=null,body=stanzaData.body;if(stanzaData.oob){var url=stanzaData.oob.url,fileName=stanzaData.oob.filename,fileId=fileStorageService.extractFileIdFromUrl(url);fileStorageService.retrieveAndStoreOneFileDescriptor(fileId).then((function(fileDescriptor){message=conversation.addFileSharingMessage(stanzaData.participant,stanzaData.date,stanzaData.body,stanzaData.messageId,fileId,fileName,stanzaData.geoloc,stanzaData.voiceMessage),that.acknowledgeHandledChatMessage(stanzaData,conversation,message),fileServerService.getBlobThumbnailFromFileDescriptor(fileDescriptor).then((function(blob){var newFileDescriptor=fileStorageService.getFileDescriptorById(fileDescriptor.id);newFileDescriptor.previewBlob=blob,$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:newFileDescriptor.id})})),$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:fileDescriptor.id})})).catch((function(error){$log.info("[ConversationServiceEventHandler] handleChatMessage error "+error)}))}else if(stanzaData.conference){var conferenceDescriptor={type:stanzaData.conference.type,message:stanzaData.conference.subject,confendpointid:stanzaData.conference.confendpointid,roomjid:stanzaData.conference.roomjid};if(conversation=this.conversationService.getConversationById(conferenceDescriptor.roomjid),$rootScope.$broadcast("ROOM_UPDATE_CONFID"),!conversation)return!0;message=conversation.addConferenceMessage(stanzaData.participant,stanzaData.date,stanzaData.messageId,conferenceDescriptor)}else if(stanzaData.replace)(message=conversation.getMessageById(stanzaData.replace.id))&&stanzaData.participant.jid!==message.from.jid?($log.warn("[ConversationServiceEventHandler] handleChatMessage : message Replaced by somebody else - Skip"),message=null):(message||(message=conversation.addChatMessage(stanzaData.participant,stanzaData.date,"",stanzaData.messageId,null,stanzaData.markdown,stanzaData.subject,null,null,stanzaData.additionalContent)),message.addReplaceMsg(stanzaData.messageId,body));else if(body.length>0){var answeredMsgId=stanzaData.answeredMsg?stanzaData.answeredMsg.text():null,answeredMsgDate=stanzaData.answeredMsg?stanzaData.answeredMsg.attr("stamp"):null,alternativeContent=stanzaData.alternativeContent.length>0?{type:stanzaData.alternativeContent.attr("type"),message:stanzaData.alternativeContent.text()}:null,attention=stanzaData.attention&&stanzaData.attention.length;message=conversation.addChatMessage(stanzaData.participant,stanzaData.date,stanzaData.body,stanzaData.messageId,null,stanzaData.markdown,stanzaData.subject,answeredMsgId,answeredMsgDate,stanzaData.additionalContent,alternativeContent,attention)}message&&that.acknowledgeHandledChatMessage(stanzaData,conversation,message)},ConversationServiceEventHandler.prototype.acknowledgeHandledChatMessage=function(stanzaData,conversation,message){if($log.info("[ConversationServiceEventHandler] acknowledgeHandledChatMessage"),!message)return message=conversation.getMessageById(stanzaData.messageId),conversation.room&&message&&message.side===Message.Side.RIGHT&&conversation.sendAckReceivedMessage(message),!0;message.side===Message.Side.LEFT?(conversation===this.conversationService.activeConversation&&"away"!==contactService.userContact.status&&$rootScope.appVisible&&"conversations"===$rootScope.activeApplication?conversation.sendAckReceivedMessage(message):(conversation.sendAckReceivedMessage(message),!stanzaData.offline&&stanzaData.convReady&&(conversation.missedCounter+=1)),message.isTextModified()&&(message.receiptStatus===Message.ReceiptStatus.READ&&conversation.sendAckReadOrReceivedMessage(stanzaData.messageId,"read"),conversation.updateMessage(message))):(stanzaData.carbon?message.setReceiptStatus(Message.ReceiptStatus.SENT):message.setReceiptStatus(Message.ReceiptStatus.IN_PROGRESS),conversation.updateMessage(message)),conversation.setStatusMessage(stanzaData.participant,Conversation.Status.ACTIVE),$rootScope.$broadcast("ON_CONVERSATION_MESSAGE_RECEIVED",message,conversation,stanzaData.carbon),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation)},ConversationServiceEventHandler.prototype.handleReceiptReceiveMessage=function(conversation,stanza){$log.info("[ConversationServiceEventHandler] handleReceiptReceiveMessage");var recvMessage=angular.element(stanza).find("received[xmlns='urn:xmpp:receipts']");if(recvMessage.length){var messageId=angular.element(recvMessage).attr("id"),message=conversation.getMessageById(messageId);if(message){(contactJid=angular.element(stanza).attr("from").split("/")[1])||(contactJid=angular.element(stanza).attr("from"));var event=angular.element(recvMessage).attr("event");(conversation.room&&contactService.isUserContactJid(contactJid)||!conversation.room)&&("received"===event?message.setReceiptStatus(Message.ReceiptStatus.UNREAD):"read"===event&&(message.setReceiptStatus(Message.ReceiptStatus.READ),conversation.missedCounter=0)),contactService.isUserContactJid(contactJid)&&"read"===event&&"L"===message.side&&(conversation.missedCounter=0),conversation.updateMessage(message),$rootScope.$broadcast("ON_CONVERSATION_RECEIPT_RECEIVED",message,conversation,event),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation)}else{var temp=angular.element(stanza).attr("from"),contactJid=(event=angular.element(recvMessage).attr("event"),"");temp&&(contactJid=temp.split("/")[1]),contactJid||(contactJid=temp),contactService.isUserContactJid(contactJid)&&"read"===event&&(conversation.missedCounter=0,$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation))}}},ConversationServiceEventHandler.prototype.handleStatusMessage=function(conversation,participant,stanza){$log.info("[conversationServiceEventHandler] handleStatusMessage ");var status="";status="thread"===angular.element(stanza).children().prop("tagName")?Conversation.stringToStatus(angular.element(angular.element(stanza).children()[1]).prop("tagName")):Conversation.stringToStatus(angular.element(stanza).children().prop("tagName")),conversation.setStatusMessage(participant,status),$rootScope.$broadcast("ON_CONVERSATIONS_STATUS_MESSAGE_EVENT",conversation,participant,status)},ConversationServiceEventHandler.prototype.onRecordingMessageReceived=function(stanza){$log.info("[ConversationServiceEventHandler] onRecordingMessageReceived");try{var msgContent=stanza.textContent;return this.extractStanzaData(stanza).then((function(stanzaData){if("start"===msgContent)(conversation=stanzaData.conversation).addRecordingMessage(stanzaData.participant,stanzaData.date,msgContent,stanzaData.messageId),conversation.setStatusMessage(stanzaData.participant,Conversation.Status.ACTIVE),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation),$rootScope.$broadcast("ON_RECORDING_START_MSG_RECEIVED");else if("stop"===msgContent){var conversation;(conversation=stanzaData.conversation)&&conversation.addRecordingMessage(stanzaData.participant,stanzaData.date,msgContent,stanzaData.messageId),$rootScope.$broadcast("ON_RECORDING_STOP_MSG_RECEIVED")}else"remoteStopVideo"===msgContent?$rootScope.$broadcast("ON_RECORDING_REMOTESTOPVIDEO_MSG_RECEIVED"):"remoteChangeMediaVideo"===msgContent?$rootScope.$broadcast("ON_RECORDING_REMOTECHANGEMEDIAVIDEO_MSG_RECEIVED"):"remoteStopSharing"===msgContent?$rootScope.$broadcast("ON_RECORDING_REMOTESTOPSHARING_MSG_RECEIVED"):"remoteChangeMediaSharing"===msgContent&&$rootScope.$broadcast("ON_RECORDING_REMOTECHANGEMEDIASHARING_MSG_RECEIVED")})),!0}catch(error){return $log.error("[ConversationServiceEventHandler] onRecordingMessageReceived error "+error),!0}},ConversationServiceEventHandler}])},function(module,exports){angular.module("rainbow").factory("ConversationServiceHistoryHandler",["$log","$q","$filter","$rootScope","xmppService","contactService","fileStorageService","fileServerService","Message","SearchTextMsgResultFactory",function($log,$q,$filter,$rootScope,xmppService,contactService,fileStorageService,fileServerService,Message,SearchTextMsgResultFactory){"use strict";function ConversationServiceHistoryHandler(conversationService){this.conversationService=conversationService}return ConversationServiceHistoryHandler.create=function(conversationService){return new ConversationServiceHistoryHandler(conversationService)},ConversationServiceHistoryHandler.prototype.getHistoryPage=function(conversation,nbMessages){var that=this,room=conversation.room;return room&&room.initPresPromise?room.initPresPromise.promise.then((function(){return that.getHistoryPageInternal(conversation,nbMessages)})):this.getHistoryPageInternal(conversation,nbMessages)},ConversationServiceHistoryHandler.prototype.getHistoryPageInternal=function(conversation,size){if(conversation.currentHistoryId&&conversation.currentHistoryId===conversation.historyIndex)return $log.info("[ConversationServiceHistoryHandler] getHistoryPage("+conversation.id+", "+size+", "+conversation.historyIndex+") already asked"),$q.reject();conversation.currentHistoryId=conversation.historyIndex,$log.info("[ConversationServiceHistoryHandler] getHistoryPage("+conversation.id+", "+size+", "+conversation.historyIndex+")");var defered=conversation.historyDefered=$q.defer();if(contactService.isUserContact(conversation.contact))return defered.reject(),defered.promise;if(conversation.historyComplete)return $log.info("[ConversationServiceHistoryHandler] getHistoryPage("+conversation.id+") : already complete"),defered.reject(),defered.promise;var mamRequest={queryid:conversation.id,with:conversation.id,max:size,before:""};return-1!==conversation.historyIndex&&(mamRequest.before=conversation.historyIndex),conversation.room?(mamRequest={queryid:conversation.id,with:contactService.userContact.jid,max:size,before:""},-1!==conversation.historyIndex&&(mamRequest.before=conversation.historyIndex),xmppService.connection.mam.querymuc(conversation.id,conversation.room.jid,mamRequest)):xmppService.connection.mam.query(conversation.id,mamRequest),defered.promise},ConversationServiceHistoryHandler.prototype.retrieveMsgByDate=function(conversation,msgDate){conversation.historyDefered=$q.defer();var defered=$q.defer();if(contactService.isUserContact(conversation.contact))return defered.reject(),defered.promise;var queryId="cache_"+conversation.id;return ConversationServiceHistoryHandler.prototype.getCommonHistoryPageAroundMsg(queryId,conversation,1,msgDate,"after",(function(){$log.info("[ConversationServiceHistoryHandler] retrieveMsgByDate finished"),defered.resolve()})),defered.promise},ConversationServiceHistoryHandler.prototype.getHistoryPageAroundMsg=function(conversation,size,centeredMsgDate){conversation.historyDefered=$q.defer();var defered=$q.defer();return contactService.isUserContact(conversation.contact)?(defered.reject(),defered.promise):(ConversationServiceHistoryHandler.prototype.getCommonHistoryPageAroundMsg(conversation.id,conversation,size+1,centeredMsgDate,"after",(function(){$log.info("[ConversationServiceHistoryHandler] getCommonHistoryPageAroundMsg BEFORE finished"),ConversationServiceHistoryHandler.prototype.getCommonHistoryPageAroundMsg(conversation.id,conversation,size,centeredMsgDate,"before",(function(){$log.info("[ConversationServiceHistoryHandler] getCommonHistoryPageAroundMsg AFTER finished"),defered.resolve()}))})),defered.promise)},ConversationServiceHistoryHandler.prototype.getCommonHistoryPageAroundMsg=function(queryId,conversation,size,centeredMsgDate,order,finishMethod){var mamRequest;($log.info("[ConversationServiceHistoryHandler] getCommonHistoryPageAroundMsg("+queryId+", "+size+", "+conversation.historyIndex+")"),conversation.room)?((mamRequest={queryid:queryId,with:contactService.userContact.jid,max:size,onComplete:finishMethod})[order]=centeredMsgDate,xmppService.connection.mam.querymuc(queryId,conversation.room.jid,mamRequest)):((mamRequest={queryid:queryId,with:conversation.id,max:size,onComplete:finishMethod})[order]=centeredMsgDate,xmppService.connection.mam.query(queryId,mamRequest))},ConversationServiceHistoryHandler.prototype.searchTextInConversations=function(queryId,text,limitSize){$log.info("[ConversationServiceHistoryHandler] searchTextInConversations("+text+")");var defered=$q.defer(),iqId=xmppService.connection.getUniqueId(),iq=$iq({id:iqId,type:"get"}).c("query",{queryid:queryId,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(limitSize).up().c("before").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(text).up().up();return xmppService.sendIQ(iq).then((function(data){$log.info("[ConversationServiceHistoryHandler] sendIq Success: "+text);var count=$(data).find("query").find("set").find("count").text();$log.info("[ConversationServiceHistoryHandler] >searchTextInConversations: count= "+count),defered.resolve(count)})).catch((function(error){$log.info("[ConversationServiceHistoryHandler] sendIq Failure: "+error.message),defered.reject(error)})),defered.promise},ConversationServiceHistoryHandler.prototype.getConversationTextCount=function(queryId,text,contactJid){$log.info("[ConversationServiceHistoryHandler] getConversationTextCount("+text+")");var defered=$q.defer(),iqId=xmppService.connection.getUniqueId(),iq=$iq({id:iqId,type:"get"}).c("query",{queryid:queryId,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t("0").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(text).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(contactJid).up().up();return xmppService.sendIQ(iq).then((function(data){$log.info("[ConversationServiceHistoryHandler] sendIq Success: "+text);var count=$(data).find("query").find("set").find("count").text();$log.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+count),defered.resolve(count)})).catch((function(error){$log.info("[ConversationServiceHistoryHandler] sendIq Failure: "+error.message),defered.reject(error)})),defered.promise},ConversationServiceHistoryHandler.prototype.searchTextResultsInConversation=function(queryId,text,contactJid,limitSize){$log.info("[ConversationServiceHistoryHandler] searchTextResultsInConversation("+text+")");var defered=$q.defer(),iqId=xmppService.connection.getUniqueId(),iq=$iq({id:iqId,type:"get"}).c("query",{queryid:queryId,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(limitSize).up().c("before").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(text).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(contactJid).up().up();return xmppService.sendIQ(iq).then((function(data){$log.info("[ConversationServiceHistoryHandler] sendIq Success: "+text);var count=$(data).find("query").find("set").find("count").text();$log.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+count),defered.resolve(count)})).catch((function(error){$log.info("[ConversationServiceHistoryHandler] sendIq Failure: "+error.message),defered.reject(error)})),defered.promise},ConversationServiceHistoryHandler.prototype.searchTextMoreResultsInConversation=function(queryId,text,contactJid,messageDate,limitSize){$log.info("[ConversationServiceHistoryHandler] searchTextMoreResultsInConversation("+text+")");var defered=$q.defer(),iqId=xmppService.connection.getUniqueId(),iq=$iq({id:iqId,type:"get"}).c("query",{queryid:queryId,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(limitSize).up().c("before").t(messageDate).up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(text).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(contactJid).up().up();return xmppService.sendIQ(iq).then((function(data){$log.info("[ConversationServiceHistoryHandler] sendIq Success: "+text);var count=$(data).find("query").find("set").find("count").text();$log.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+count),defered.resolve(count)})).catch((function(error){$log.info("[ConversationServiceHistoryHandler] sendIq Failure: "+error.message),defered.reject(error)})),defered.promise},ConversationServiceHistoryHandler.prototype.searchTextInRoom=function(queryId,userJid,roomJid,text,limitSize){$log.info("[ConversationServiceHistoryHandler] searchTextInRoom("+text+")");var defered=$q.defer(),iqId=xmppService.connection.getUniqueId(),iq=$iq({to:roomJid,id:iqId,type:"get"}).c("query",{queryid:queryId,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(limitSize).up().c("before").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"with",type:"text-single"}).c("value").t(userJid).up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(text).up().up();return xmppService.sendIQ(iq).then((function(data){$log.info("[ConversationServiceHistoryHandler] sendIq Success: "+text);var count=$(data).find("query").find("set").find("count").text();$log.info("[ConversationServiceHistoryHandler] >searchTextInRoom: count= "+count),defered.resolve(count)})).catch((function(error){$log.info("[ConversationServiceHistoryHandler] >searchTextInRoom: Failure: "+error.message),defered.reject(error)})),defered.promise},ConversationServiceHistoryHandler.prototype.searchTextMoreResultsInRoom=function(queryId,text,contactJid,roomJid,messageDate,limitSize){$log.info("[ConversationServiceHistoryHandler] searchTextMoreResultsInConversation("+text+")");var defered=$q.defer(),iqId=xmppService.connection.getUniqueId(),iq=$iq({to:roomJid,id:iqId,type:"get"}).c("query",{queryid:queryId,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(limitSize).up().c("before").t(messageDate).up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(text).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(contactJid).up().up();return xmppService.sendIQ(iq).then((function(data){$log.info("[ConversationServiceHistoryHandler] sendIq Success: "+text);var count=$(data).find("query").find("set").find("count").text();$log.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+count),defered.resolve(count)})).catch((function(error){$log.info("[ConversationServiceHistoryHandler] sendIq Failure: "+error.message),defered.reject(error)})),defered.promise},ConversationServiceHistoryHandler.prototype.onHistoryMessageReceived=function(stanza){$log.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived");try{var conversation=null,stanzaElem=$(stanza),queryId=stanzaElem.find("result").attr("queryid");if(queryId){if(conversation=this.conversationService.getConversationById(queryId)){if(stanzaElem.find("call_log").length)return this.onWebrtcHistoryMessageReceived(stanza,conversation);var brutJid=stanzaElem.find("forwarded message").attr("from"),roomEvent=!1;if(!(fromJid=brutJid&&0===brutJid.indexOf("room_")?brutJid.split("/")[1]:xmppService.getBareJidFromJid(stanzaElem.find("forwarded message").attr("from")))&&stanzaElem.find("event").length&&(roomEvent=stanzaElem.find("event").attr("name"),fromJid=stanzaElem.find("event").attr("jid"),"welcome"===roomEvent&&conversation.room&&conversation.room.ownerContact&&(fromJid=conversation.room.ownerContact.jid)),!fromJid)return $log.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived - Receive message without valid fromJid information"),!0;var from=contactService.getContactByJid(fromJid),type=stanzaElem.find("forwarded message").attr("type"),messageId=stanzaElem.find("forwarded message").attr("id"),date=new Date(stanzaElem.find("forwarded delay").attr("stamp")),body=stanzaElem.find("forwarded message body").text(),ack=stanzaElem.find("forwarded message ack"),oob=stanzaElem.find("forwarded message x[xmlns='jabber:x:oob']"),conference=stanzaElem.find("forwarded message x[xmlns='jabber:x:bubble:conference:pstn']"),contents=stanzaElem.find("content[xmlns='urn:xmpp:content']"),replace=stanzaElem.find("replace"),answeredMsg=stanzaElem.find("answeredMsg"),alternativeContent=stanzaElem.find("content"),side=contactService.isUserContact(from)?Message.Side.RIGHT:Message.Side.LEFT,geoloc=stanzaElem.find("geoloc"),voiceMessage=stanzaElem.find("voicemessage");if(voiceMessage&&voiceMessage.length)var voiceMessageData=!0;if(geoloc&&geoloc.length)var geolocElem=$(geoloc),geolocData={lon:geolocElem.find("lon").text(),lat:geolocElem.find("lat").text()};if(from||($log.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived missing contact for jid : "+fromJid+", ignore message"),from=contactService.createEmptyContactContact(fromJid)),roomEvent){if($log.info("[ConversationServiceHistoryHandler] ("+conversation.id+") add Room admin event message "+roomEvent),type="admin",conversation.room&&conversation.room.isMeetingRoom()&&("welcome"===roomEvent||"conferenceAdd"===roomEvent||"conferenceRemove"===roomEvent||"invitation"===roomEvent))return!0;if(("conferenceAdd"===roomEvent||"conferenceRemove"===roomEvent)&&conversation.room&&conversation.room.ownerContact){var userJid=stanzaElem.find("event").attr("jid"),user=conversation.room.getUserByJid(userJid);from=user&&user.contact?user.contact:conversation.room.ownerContact}}var message=conversation.getMessageById(messageId);if(message||(message=conversation.historyMessages.find((function(item){return item.id===messageId}))),message)$log.info("[ConversationServiceHistoryHandler] ("+conversation.id+") try to add an already stored message with id "+message.id);else{switch(type){case"file":message=Message.createFileMessage(messageId,date,from,side,body,!1);break;case"webrtc":message=Message.createWebRTCMessage(messageId,date,from,side,body,!1);break;case"admin":message=Message.createBubbleAdminMessage(messageId,date,from,roomEvent);break;case"recording":message=Message.createRecordingAdminMessage(messageId,date,from,"Admin");break;default:if(oob&&oob.length){var oobElem=$(oob),url=oobElem.find("url").text(),fileName=oobElem.find("filename").text(),fileId=fileStorageService.extractFileIdFromUrl(url);message=voiceMessageData?Message.createVoiceMessage(messageId,date,from,side,body,!1,fileId,fileName,voiceMessageData):Message.createFileSharingMessage(messageId,date,from,side,body,!1,fileId,fileName,geolocData),fileStorageService.retrieveAndStoreOneFileDescriptor(fileId).then((function(fileDescriptor){fileDescriptor&&"not_uploaded"===fileDescriptor.state&&(message.receiptStatus=1,message.fileErrorMsg=$filter("translate")("file_notuploaded")),fileServerService.getBlobThumbnailFromFileDescriptor(fileDescriptor).then((function(blob){fileDescriptor.previewBlob=blob,$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:fileDescriptor.id})})),$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:fileDescriptor.id})})).catch((function(error){$log.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived error "+error)}))}else if(conference&&conference.length){var conferenceElem=$(conference),subject=conferenceElem.attr("subject"),confendpointid=conferenceElem.attr("confendpointid"),jid=conference.attr("jid");if("reminder"===conference.attr("type"))return!0;var conferenceDescriptor={subject:subject,confendpointid:confendpointid,roomjid:jid};message=Message.createConferenceMessage(messageId,date,from,side,!1,conferenceDescriptor)}else{var isMarkdown=!1,additionalContent={};if(contents&&contents.each((function(){var contentType=$(this).attr("type"),content=$(this).text();"text/markdown"===contentType&&(isMarkdown=!0,body=content),additionalContent[contentType]={type:contentType,message:content}})),replace&&replace.length){var replacedMsgId=replace.attr("id"),replacedMessage=conversation.getMessageByIdInHistory(replacedMsgId);replacedMessage||(replacedMessage=Message.create(replacedMsgId,date,from,side,body,!1,isMarkdown,null,null,null,additionalContent),message=replacedMessage),from.jid!==replacedMessage.from.jid?($log.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived : message Replaced by somebody else - Skip"),message=null):replacedMessage&&replacedMessage.addReplaceMsg(messageId,body)}else{var answeredMsgId=answeredMsg?answeredMsg.text():null,answeredMsgDate=answeredMsg?answeredMsg.attr("stamp"):null;alternativeContent=alternativeContent?{type:alternativeContent.attr("type"),message:alternativeContent.text()}:null;message=Message.create(messageId,date,from,side,body,!1,isMarkdown,null,answeredMsgId,answeredMsgDate,additionalContent,alternativeContent)}}}message&&(message.receiptStatus="true"===angular.element(ack).attr("read")?5:"true"===angular.element(ack).attr("recv")?4:3,$log.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived : pushing msg inside historyMessages"),conversation.addMessageInHistoryMessages(message))}}else if(queryId.startsWith("cache_")){$log.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived : Query Id for Cached Message");var conversationId=queryId.substr(6);if(conversation=this.conversationService.getConversationById(conversationId)){var fromJid;if($log.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived : Conversation Found"),!(fromJid=(brutJid=stanzaElem.find("forwarded message").attr("from"))&&0===brutJid.indexOf("room_")?brutJid.split("/")[1]:xmppService.getBareJidFromJid(stanzaElem.find("forwarded message").attr("from")))&&stanzaElem.find("event").length&&(roomEvent=stanzaElem.find("event").attr("name"),fromJid=stanzaElem.find("event").attr("jid"),"welcome"===roomEvent&&conversation.room&&conversation.room.ownerContact&&(fromJid=conversation.room.ownerContact.jid)),!fromJid)return $log.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived - Receive message without valid fromJid information"),!0;from=contactService.getContactByJid(fromJid),messageId=stanzaElem.find("forwarded message").attr("id"),date=new Date(stanzaElem.find("forwarded delay").attr("stamp")),body=stanzaElem.find("forwarded message body").text(),side=contactService.isUserContact(from)?Message.Side.RIGHT:Message.Side.LEFT;from||($log.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived missing contact for jid : "+fromJid+", ignore message"),from=contactService.createEmptyContactContact(fromJid)),(message=Message.create(messageId,date,from,side,body,!1,!1))&&conversation.addMessageInCacheMessages(message)}}}else if(queryId=angular.element(stanza).find("fin").attr("queryid"),conversation=this.conversationService.getConversationById(queryId)){conversation.historyComplete="true"===angular.element(stanza).find("fin").attr("complete");var historyIndex=angular.element(stanza).find("fin set first").text();-1===conversation.historyIndex?(conversation.messages.unshift.apply(conversation.messages,conversation.historyMessages),conversation.chatRenderer&&conversation.chatRenderer.prependMessages(conversation.messages,conversation.room)):(conversation.messages.unshift.apply(conversation.messages,conversation.historyMessages),conversation.chatRenderer&&conversation.chatRenderer.prependMessages(conversation.historyMessages,conversation.room)),conversation.historyIndex=historyIndex,conversation.historyMessages=[],angular.isDefined(conversation.messages)&&conversation.messages.length>0?conversation.lastMessageText=conversation.messages[conversation.messages.length-1].data:conversation.lastMessageText="",conversation.historyDefered&&conversation.historyDefered.resolve(conversation)}return!0}catch(error){return $log.error("[ConversationServiceHistoryHandler] onHistoryMessageReceived error : "+error),!0}},ConversationServiceHistoryHandler.prototype.onSearchTextMessageReceived=function(stanza){$log.info("[ConversationServiceHistoryHandler] onSearchTextMessageReceived");try{var otherJid,stanzaElem=$(stanza),fromJid=stanzaElem.find("forwarded message").attr("from"),toJid=stanzaElem.find("forwarded message").attr("to"),isSent=!1,isRoom=!1;if(contactService.isUserContactJid(fromJid)?($log.info("[ConversationServiceHistoryHandler] sent message"),isSent=!0,otherJid=toJid):($log.info("[ConversationServiceHistoryHandler] received message"),isSent=!1,otherJid=fromJid),otherJid&&0===otherJid.indexOf("room_")?(otherJid=otherJid.split("/")[0],isRoom=!0):otherJid=xmppService.getBareJidFromJid(otherJid),!otherJid)return void $log.warn("[ConversationServiceHistoryHandler] onSearchTextMessageReceived - Receive message without valid otherJid information");var messageId=stanzaElem.find("forwarded message").attr("id"),date=new Date(stanzaElem.find("forwarded delay").attr("stamp")),body=stanzaElem.find("forwarded message body").text(),searchMsgResult=SearchTextMsgResultFactory();return searchMsgResult.body=body,searchMsgResult.date=date,searchMsgResult.isRoom=isRoom,searchMsgResult.isSent=isSent,searchMsgResult.messageId=messageId,searchMsgResult.otherJid=otherJid,searchMsgResult}catch(error){return $log.error("[ConversationServiceHistoryHandler] onSearchTextMessageReceived error : "+error),!0}},ConversationServiceHistoryHandler.prototype.onWebrtcHistoryMessageReceived=function(stanza,conversation){console.log("onWebrtcHistoryMessageReceived");try{var stanzaElem=$(stanza),messageId=stanzaElem.find("forwarded message").attr("id"),callerJid=stanzaElem.find("caller").text(),state=stanzaElem.find("state").text(),duration=0;stanzaElem.find("duration")&&(duration=stanzaElem.find("duration").text(),duration=parseInt(duration,10)),duration=duration>0?"("+moment.duration(duration,"ms").format("h[H] mm[m] ss[s]")+")":0;var date=stanzaElem.find("date").text();date=date?new Date(date):new Date(stanzaElem.find("forwarded delay").attr("stamp"));var body="";"missed"===state?body="missedCall||"+date:"answered"===state&&(body="activeCallMsg||"+date+"||"+duration);var message=conversation.getMessageById(messageId);if(message||(message=conversation.historyMessages.find((function(item){return item.id===messageId}))),message)$log.info("[ConversationServiceHistoryHandler] ("+conversation.id+") try to add an already stored message with id "+message.id);else{var from=contactService.getContactByJid(callerJid);from||($log.warn("[ConversationServiceHistoryHandler] onWebrtcHistoryMessageReceived missing contact for jid : "+callerJid+", ignore message"),from=contactService.createEmptyContactContact(callerJid));var side=contactService.isUserContact(from)?Message.Side.RIGHT:Message.Side.LEFT;message=Message.createWebRTCMessage(messageId,date,from,side,body,!1);var ack=stanzaElem.find("forwarded message ack");ack&&(message.receiptStatus="true"===angular.element(ack).attr("read")?5:"true"===angular.element(ack).attr("received")?4:3),conversation.historyMessages.push(message)}return!0}catch(error){return console.error(error),!0}},ConversationServiceHistoryHandler}])},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0});const favorite_1=__webpack_require__(250);class FavoriteService{constructor($http,$log,contactService,authService,roomService,conversationService,xmppService){this.$http=$http,this.$log=$log,this.contactService=contactService,this.authService=authService,this.roomService=roomService,this.conversationService=conversationService,this.xmppService=xmppService,this.favorites=[]}start(stats){return __awaiter(this,void 0,void 0,(function*(){this.$log.info("[favoriteService] === STARTING ===");let startDate=performance.now();this.getServerFavorites(),this.conversationService.favoriteService=this,this.attachHandlers();let startDuration=Math.round(performance.now()-startDate);stats.push({service:"favoriteService",startDuration:startDuration}),this.$log.info(`[favoriteService] === STARTED (${startDuration} ms) ===`)}))}reconnect(){this.getServerFavorites(),this.conversationService.favoriteService=this,this.attachHandlers()}stop(){return __awaiter(this,void 0,void 0,(function*(){this.$log.info("[favoriteService] Stopping"),this.xmppManagementHandler&&(this.xmppService.deleteHandler(this.xmppManagementHandler),this.xmppManagementHandler=null),this.$log.info("[favoriteService] Stopped")}))}getServerFavorites(){return __awaiter(this,void 0,void 0,(function*(){try{let url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.contactService.userContact.dbId}/favorites`,promises=(yield this.$http({method:"GET",url:url,headers:this.authService.getRequestHeader()})).data.data.map(data=>__awaiter(this,void 0,void 0,(function*(){return this.createFavorite(data.id,data.peerId,data.type)}))),favorites=yield Promise.all(promises);return this.favorites=favorites.filter(favorite=>null!==favorite),this.$log.info(`[favoriteService] getServerFavorites -- SUCCESS -- found ${this.favorites.length} favorites`),this.favorites}catch(error){let errorMessage=`getServerFavorites -- FAILURE -- ${error.message}`;throw this.$log.error(`[favoriteService] ${errorMessage}`),new Error(errorMessage)}}))}addServerFavorite(peerId,type){return __awaiter(this,void 0,void 0,(function*(){try{let url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.contactService.userContact.dbId}/favorites`,data={peerId:peerId,type:type};yield this.$http({method:"POST",url:url,headers:this.authService.getRequestHeader(),data:data}),this.$log.info(`[favoriteService] addServerFavorite(${peerId}, ${type}) -- SUCCESS`)}catch(error){let errorMessage=`addServerFavorite(${peerId}, ${type}) -- FAILURE -- ${error.message}`;throw this.$log.error(`[favoriteService] ${errorMessage}`),new Error(errorMessage)}}))}removeServerFavorite(favoriteId){return __awaiter(this,void 0,void 0,(function*(){try{let url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.contactService.userContact.dbId}/favorites/${favoriteId}`;yield this.$http({method:"DELETE",url:url,headers:this.authService.getRequestHeader()}),this.$log.info(`[favoriteService] removeServerFavorite(${favoriteId}) -- SUCCESS`)}catch(error){let errorMessage=`removeServerFavorite(${favoriteId}) -- FAILURE -- ${error.statusText}`;throw this.$log.error(`[favoriteService] ${errorMessage}`),new Error(errorMessage)}}))}toggleFavorite(conversation){let peerId=conversation.contact?conversation.contact.dbId:conversation.room.dbId,type=conversation.contact?conversation.contact.isBot?"bot":"user":"room",favorite=this.favorites.find(favoriteConv=>favoriteConv.peerId===peerId);favorite?this.removeServerFavorite(favorite.id):this.addServerFavorite(peerId,type)}updateFavorites(conversation){let peerId=conversation.contact?conversation.contact.dbId:conversation.room.dbId,favorite=this.favorites.find(favoriteConv=>favoriteConv.peerId===peerId);favorite&&(conversation.isFavorite=!0,favorite.conv=conversation)}getFavorite(peerId){return __awaiter(this,void 0,void 0,(function*(){let favorite=this.favorites.find(favoriteConv=>favoriteConv.peerId===peerId),convGetter=favorite.contact?this.conversationService.getOrCreateOneToOneConversation(favorite.contact.jid):this.conversationService.getRoomConversation(favorite.room.jid);return yield convGetter}))}createFavorite(id,peerId,type){return __awaiter(this,void 0,void 0,(function*(){try{let favorite=new favorite_1.Favorite(id,peerId,type);"room"===type?favorite.room=this.roomService.getRoomById(peerId):favorite.contact=yield this.contactService.getContactByDBId(peerId);let convId=favorite.room?favorite.room.jid:favorite.contact.jid,conv=this.conversationService.getConversationById(convId);return conv&&(conv.isFavorite=!0,favorite.conv=conv),favorite}catch(error){return this.$log.warn(`[favoriteService] createFavorite(${id}, ${peerId}, ${type}) -- FAILURE -- ${error.message}`),null}}))}onXmppEvent(stanza){return __awaiter(this,void 0,void 0,(function*(){try{let favoriteElem=$(stanza).find("favorite");if(favoriteElem){let id=favoriteElem.attr("id"),type=favoriteElem.attr("type"),peerId=favoriteElem.attr("peer_id"),action=favoriteElem.attr("action");if("create"===action){let favorite=this.favorites.find(favoriteConv=>favoriteConv.peerId===peerId);favorite||(favorite=yield this.createFavorite(id,peerId,type),this.favorites.push(favorite),this.sendEvent("ON_FAVORITE_CREATED",{favorite:favorite}))}if("delete"===action){var index=this.favorites.findIndex(fav=>fav.id===id);if(-1!==index){var favorite=this.favorites[index];favorite.conv&&(favorite.conv.isFavorite=!1),this.favorites.splice(index,1),this.sendEvent("ON_FAVORITE_DELETED",{favoriteId:favorite.id})}}}return!0}catch(error){return!0}}))}sendEvent(eventName,detail){let event=new CustomEvent(eventName,{detail:detail});window.dispatchEvent(event)}attachHandlers(){this.xmppManagementHandler&&this.xmppService.deleteHandler(this.xmppManagementHandler),this.xmppManagementHandler=this.xmppService.addHandler(stanza=>(this.onXmppEvent(stanza),!0),null,"message","management")}}exports.FavoriteService=FavoriteService,FavoriteService.$inject=["$http","$log","contactService","authService","roomService","conversationService","xmppService"],angular.module("rainbow").service("favoriteService",FavoriteService)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});exports.Favorite=class{constructor(id,peerId,type){this.id=id,this.peerId=peerId,this.type=type}}},function(module,exports){class VoiceMessageService{constructor($q,$http,$log,$rootScope,$injector,authService,xmppService,contactService,VoiceMessage,Contact,profileService,telephonyService){this.$q=$q,this.$http=$http,this.$log=$log,this.$rootScope=$rootScope,this.$injector=$injector,this.authService=authService,this.xmppService=xmppService,this.contactService=contactService,this.VoiceMessage=VoiceMessage,this.Contact=Contact,this.profileService=profileService,this.telephonyService=telephonyService,this.listeners=[],this.voiceMessageMngtRef=null,this.voiceMessages=[],this.xmpp_message_handler=null,this.unreadVoiceMessageCounter=0}start(stats){return this.$q(resolve=>{if(!this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.TELEPHONY_VOICE_MAIL))return resolve();if(this.contactService.userContact.isCPaaSGuest())return resolve();this.$log.info("[voiceMessageService] === STARTING ===");let startDate=performance.now();this.init();let startDuration=Math.round(performance.now()-startDate);this.$log.info("[voiceMessageService] === STARTED ("+startDuration+" ms) ==="),stats.push({service:"voiceMessageService",startDuration:startDuration}),resolve()})}init(){this.portalURL=config.restServerUrl+"/api/rainbow/telephony/v1.0/",this.voiceMessagesCounters={total:0,unread:0},this.$rootScope.$on("ON_VOICE_MESSAGE_UPDATE_EVENT",(__event,counters)=>{this.voiceMessagesCounters.unread=counters.unreadMessages,this.voiceMessagesCounters.total=counters.totalMessages}),this.attachHandlers(),this.attachListeners()}attachHandlers(){this.$log.info("[voiceMessageService] attachHandlers"),this.voiceMessageMngtRef&&(this.xmppService.connection.deleteHandler(this.voiceMessageMngtRef),this.voiceMessageMngtRef=null),this.voiceMessageMngtRef=this.xmppService.connection.addHandler(stanza=>this.onVoiceMessageManagement(stanza),null,"message","management")}attachListeners(){}stop(){return this.$q(resolve=>{this.$log.info("[voiceMessageService] === STOPPING ==="),this.listeners.forEach(destroyFunction=>{destroyFunction()}),this.voiceMessagesCounters=null,this.$log.info("[voiceMessageService] === STOPPED ==="),resolve()})}onVoiceMessageManagement(stanza){try{let voiceMessageEndpointElem=$(stanza).find("visualvoicemail");if(voiceMessageEndpointElem.length&&"abort"===voiceMessageEndpointElem.attr("action")){let voiceMessageId=voiceMessageEndpointElem.attr("msgid"),errorEndPointElem=voiceMessageEndpointElem.find("error"),voiceMessageErrorCode=errorEndPointElem.attr("errordetailscode"),voiceMessageErrorMessage=errorEndPointElem.attr("errormsq");return this.$log.info("[voiceMessageService] onVoiceMessageManagement - "+voiceMessageId+" - abort - "+voiceMessageErrorMessage),this.$rootScope.$broadcast("ON_VOICE_MESSAGE_CONVERSION_ABORT",{msgId:voiceMessageId,errorCode:voiceMessageErrorCode}),!0}if(voiceMessageEndpointElem.length&&"create"===voiceMessageEndpointElem.attr("action")){let voiceMessageId=voiceMessageEndpointElem.attr("msgid"),urlEndPoint=voiceMessageEndpointElem.find("url").text();return this.$log.info("[voiceMessageService] onVoiceMessageManagement - "+voiceMessageId+" - create - "+urlEndPoint),this.$rootScope.$broadcast("ON_VOICE_MESSAGE_CONVERSION_CREATE",{msgId:voiceMessageId,url:urlEndPoint}),!0}return!0}catch(error){return!0}}getVoiceMessagesList(){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"voicemessages",headers:this.authService.getRequestHeader()}).then(response=>{let voiceMessagesData=response.data.data.voicemessages.voiceMessageList,voiceMessages=[];voiceMessagesData&&voiceMessagesData.forEach(voiceMessageData=>{this.createVoiceMessageFromData(voiceMessageData).then(voiceMessage=>voiceMessages.push(voiceMessage))}),this.$log.info("[voiceMessageService] getVoiceMessagesList success - Messages number : "+voiceMessagesData.length),resolve(voiceMessages)}).catch(err=>{this.voiceMessageErrorHandler("getVoiceMessagesList",reject,err)})})}getVoiceMessagesCounters(){return this.$q((resolve,reject)=>{this.telephonyService.isSipWise()?(this.$log.info("[voiceMessageService] getVoiceMessagesCounters not yet implemented"),resolve(this.voiceMessagesCounters)):this.$http({method:"GET",url:this.portalURL+"voicemessages/counters",headers:this.authService.getRequestHeader()}).then(response=>{let voiceMessageCountersData=response.data.data.voicemessages.counters;this.voiceMessagesCounters.total=parseInt(voiceMessageCountersData.total,10),this.voiceMessagesCounters.unread=parseInt(voiceMessageCountersData.unread,10),this.$log.info("[voiceMessageService] getVoiceMessagesCounters success - total : "+this.voiceMessagesCounters.total+" - unread : "+this.voiceMessagesCounters.unread),resolve(this.voiceMessagesCounters)}).catch(err=>{this.voiceMessageErrorHandler("getVoiceMessagesCounters",reject,err)})})}getVoiceMessagesUnreadCounter(){return this.voiceMessagesCounters.unread}getVoiceMessagesTotalCounter(){return this.voiceMessagesCounters.total}getVoiceMessageFromPBX(voiceMessage){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"voicemessages/"+encodeURIComponent(voiceMessage.id)+"?messageDate="+encodeURIComponent(voiceMessage.date)+"&messageFrom="+encodeURIComponent(voiceMessage.from),headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[voiceMessageService] getVoiceMessageFromPBX success"),resolve()}).catch(err=>{this.voiceMessageErrorHandler("getVoiceMessageFromPBX",reject,err)})})}deleteVoiceMessage(voiceMessageId){return this.$q((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"voicemessages/"+voiceMessageId,headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[voiceMessageService] deleteVoiceMessage success"),resolve()}).catch(err=>{this.voiceMessageErrorHandler("deleteVoiceMessage",reject,err)})})}deleteAllVoiceMessages(){return this.$q((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"voicemessages/all",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[voiceMessageService] deleteAllVoiceMessages success"),resolve()}).catch(err=>{this.voiceMessageErrorHandler("deleteAllVoiceMessages",reject,err)})})}createVoiceMessageFromData(data){return this.$q((resolve,reject)=>{if(data){let foundidentity=data.foundidentity,identityFirstName="",identityLastName="",otherParticipantJid=data.jid,otherParticipantNumber=data.from;otherParticipantJid||otherParticipantNumber?this.contactService.getOrCreateContact(otherParticipantJid,otherParticipantNumber).then(contact=>{if(this.$log.info("[voiceMessageService] createVoiceMessageFromData otherParticipant jid:"+otherParticipantJid+"  Number:"+otherParticipantNumber+" => contact retrieved (temp:"+contact.temp+")"),!otherParticipantJid&&contact.temp){if(foundidentity&&foundidentity.length){var foundFirstName=foundidentity.attr("firstName"),foundLastName=foundidentity.attr("lastName"),foundDisplayName=foundidentity.attr("displayName");identityFirstName=foundFirstName||"",""===(identityLastName=foundLastName||"")&&""===identityFirstName&&foundDisplayName&&0!==foundDisplayName.length&&foundDisplayName!==otherParticipantNumber&&(identityLastName=foundDisplayName),(identityFirstName.length||identityLastName.length)&&(this.$log.debug("[voiceMessageService] createVoiceMessageFromData  xNames updated from directories for contact "+contact.id),contact.updateName(identityFirstName,identityLastName))}else try{var centralizedService=this.$injector.get("centralizedService");centralizedService.outlook.updateContactFromOutlookInfos(contact,otherParticipantNumber,!0).then(updateStatus=>{updateStatus?this.$log.debug("[telephonyService] createVoiceMessageFromData  xNames updated from outlook for contact "+contact.id):this.$log.debug("[telephonyService] createVoiceMessageFromData no update from outlook for contact :"+contact.id)}).catch(err=>{this.$log.debug("[voiceMessageService] createVoiceMessageFromData  no Outlook search available")})}catch(error){}var displayNameisAPhoneNumber=!1;if(this.telephonyService.started)displayNameisAPhoneNumber=contact.displayName.match(/^[0-9A-D #\-\+\*\(\)\./]{1,32}$/)&&this.telephonyService.startAsPhoneNumber(contact.displayName);displayNameisAPhoneNumber&&contact.phoneProCan&&""!==contact.phoneProCan&&(contact.displayName=contact.phoneProCan)}resolve(this.VoiceMessage(data.id,contact,"true"===data.unread,data.length,data.date,data.from,data.jid))}).catch(err=>{this.voiceMessageErrorHandler("getVoiceMessagesList",reject,err),reject("reject")}):reject("neither otherParticipantJid nor otherParticipantNumber")}else reject("no data")})}voiceMessageErrorHandler(methodName,reject,err){err.data?this.$log.error("[voiceMessageService] "+methodName+" -- failure -- "+err.data.errorDetails):this.$log.error("[voiceMessageService] "+methodName+" -- failure -- Server failure"),reject(err)}}VoiceMessageService.$inject=["$q","$http","$log","$rootScope","$injector","authService","xmppService","contactService","VoiceMessageFactory","Contact","profileService","telephonyService"],angular.module("rainbow").service("voiceMessageService",VoiceMessageService)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0);angular.module("rainbow").service("telephonyService",["$q","$interval","$http","$rootScope","$log","xmppService","contactService","authService","TelephonyServiceEventHandler","errorHelperService","VoiceMail","profileService","utilService","videoService","$injector","settingsService",function($q,$interval,$http,$rootScope,$log,xmppService,contactService,authService,TelephonyServiceEventHandler,errorHelperService,VoiceMail,profileService,utilService,videoService,$injector,settingsService){var service=this,listeners=[],CALLSERVICE_NS="urn:xmpp:pbxagent:callservice:1",sipWise=!1;service.start=function(stats){if($log.info("[telephonyService] === STARTING ==="),service.setSipWise("RVCP Subscriber"===contactService.userContact.systDeviceName),service.isSipWise()){$log.info("[telephonyService] starting in sipWise mode"),CALLSERVICE_NS="urn:xmpp:pbxagent:telephony:1";try{service.telephonyServiceEventHandlerSipWise=$injector.get("TelephonyServiceEventHandlerSipWise")}catch(error){var errorMessage=error&&error.message?error.message:"Unknown error",errorStack=error&&error.stack?error.stack:"Unknown stack";$log.error("[telephonyService] injection TelephonyServiceEventHandlerSipWise  exception  -- "+errorMessage+" : "+errorStack)}try{service.telephonyServiceSipWise=$injector.get("telephonyServiceSipWise")}catch(error){errorMessage=error&&error.message?error.message:"Unknown error",errorStack=error&&error.stack?error.stack:"Unknown stack";$log.error("[telephonyService] injection TelephonyServiceSipWise  exception  -- "+errorMessage+" : "+errorStack)}}service.startDate=performance.now(),service.stats=stats,service.calls=[],service.starting=service.started=!1,service.agentStatus={phoneApi:"disconnected",xmppAgent:"stopped",agentVersion:"unknown"},service.voicemailNumber=contactService.userContact.voicemailNumber,service.pbxId=contactService.userContact.pbxId,service.makingCall=!1,service.voiceMail=VoiceMail.create(),service.forwardObject={},service.nomadicObject={},service.nomadicAnswerNotTakedIntoAccount=!1,service.isBasicCallAllowed=profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_BASIC_CALL),service.isSecondCallAllowed=profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_SECOND_CALL),service.isTransferAllowed=profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_TRANSFER_CALL),service.isConferenceAllowed=profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_CONFERENCE_CALL),service.isVMDeflectCallAllowed=profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_DEFLECT_CALL),service.voiceMailFeatureEnabled=profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_VOICE_MAIL),service.isForwardEnabled=profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_CALL_FORWARD),service.isNomadicEnabled=profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_NOMADIC),service.userJidTel=authService.jidTel,service.portalURL=config.restServerUrl+"/api/rainbow/telephony/v1.0/",listeners.push($rootScope.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",service.onTelPresenceChange)),service.isSipWise()?service.telephonyEventHandler=service.telephonyServiceEventHandlerSipWise.create(service):service.telephonyEventHandler=TelephonyServiceEventHandler.create(service),$log.info("[telephonyService] starting on user jidTel: "+service.userJidTel),contactService.userContact&&($log.info("[telephonyService] starting user name: "+contactService.userContact.getNameForLogs()+", full jid: "+contactService.userContact.fullJid),$log.info("[telephonyService] starting phonePbx: "+utilService.anonymizePhoneNumber(contactService.userContact.phonePbx)+", phonePro: "+utilService.anonymizePhoneNumber(contactService.userContact.phonePro)+", voicemailNumber: "+utilService.anonymizePhoneNumber(contactService.userContact.voicemailNumber)+", pbxId: "+contactService.userContact.pbxId)),contactService.userContact&&(contactService.userContact.telStatus?($log.info("[telephonyService] start with my existing telephony presence "+contactService.userContact.telStatus+" of user contact ("+contactService.userContact.jidtel+") "),service.onTelPresenceChange(null,{jid:service.userJidTel+"/phone",status:contactService.userContact.telStatus})):($log.info("[telephonyService] Subscribe and wait for my telephony presence ("+contactService.userContact.jidtel+")"),contactService.sendSubscribeInvitation(contactService.userContact.jidtel)))},service.onTelPresenceChange=function(__event,attr){if(contactService.isTelJid(attr.jid)){var ressourceFromJid=contactService.getRessourceFromJid(attr.jid);if("phone"!==ressourceFromJid&&"pcg2"!==ressourceFromJid)return!0;var jid_im=contactService.getImJid(attr.jid);if(!jid_im)return!0;var status=attr.status;contactService.isUserContactJid(jid_im)&&("unavailable"===status||"offline"===status?($log.info("[telephonyService] received my telephony presence -- "+status),service.starting=service.started=!1,service.telephonyOfflineCallManagement(),$rootScope.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","stopped"),$log.info("[telephonyService] === STOPPED ===")):service.started||service.starting||($log.info("[telephonyService] received my telephony presence -- "+status),service.starting=!0,service.getAgentStatus().then((function(){return service.attachHandlers(),service.isSipWise()?($log.info("[telephonyService] getNomadicStatus -- SipWise BYPASS"),service.getTelephonyState(!1)):service.isNomadicEnabled?service.getNomadicStatus().then((function(){var snapshotSecondary=service.nomadicObject.featureActivated&&service.nomadicObject.modeActivated&&!service.nomadicObject.makeCallInitiatorIsMain;return service.getTelephonyState(snapshotSecondary)})):service.getTelephonyState(!1)})).then((function(){service.isForwardEnabled&&service.getForwardStatus()})).then((function(){var startDuration=Math.round(performance.now()-service.startDate);service.stats.push({service:"telephonyService",startDuration:startDuration}),$log.info("[telephonyService] === STARTED ("+startDuration+" ms) ==="),service.started=!0,service.starting=!1,$rootScope.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","started")})).catch((function(error){service.starting=!1,$log.error("[telephonyService] receive telephony presence but error in initialization - "+(error?error.message:"unknown error"))}))))}return!0},service.launchTelephonyInitilization=function(){contactService.userContact&&contactService.userContact.telStatus?($log.info("[telephonyService] launchTelephonyInitilization telStatus: "+contactService.userContact.telStatus+" => start"),service.onTelPresenceChange(null,{jid:service.userJidTel+"/phone",status:contactService.userContact.telStatus})):$log.info("[telephonyService] launchTelephonyInitilization no tel presence => do nothing")},service.reconnect=function(){$log.info("[telephonyService] reconnect (xmpp reconnection)"),service.starting=service.started=!1,service.telephonyOfflineCallManagement(),$rootScope.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","stopped"),service.attachHandlers()},service.telephonyOfflineCallManagement=function(){$log.info("[telephonyService] telephony Offline Call Management");try{var webrtcGatewayService=$injector.get("webrtcGatewayService");Object.keys(service.calls||[]).forEach((function(key){var call=service.calls[key];call&&(call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING&&call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.QUEUED_INCOMMING||(call.mediaPillarCall&&call.mediaPillarCall.webrtcCallRef&&($log.info("[telephonyService] Offline Call Management: release MP webrtc call for phone call "+call.id+" in state "+call.status.value),videoService.releaseCall(call.mediaPillarCall.webrtcCallRef)),$log.info("[telephonyService] Offline Call Management: stop popup and ringing tone for phone call "+call.id+" in state "+call.status.value),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)),(call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_OUTGOING||call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.QUEUED_OUTGOING)&&webrtcGatewayService.isMediaPillarCallSituation(call)&&call.mediaPillarCall&&call.mediaPillarCall.webrtcCallRef&&($log.info("[telephonyService] Offline Call Management: release MP webrtc call for phone call "+call.id+" in state "+call.status.value),videoService.releaseCall(call.mediaPillarCall.webrtcCallRef)),webrtcGatewayService.isMediaPillarCallSituation(call)&&call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE?($log.info("[telephonyService] Offline Call Management: keep MP call for phone call "+call.id+" in state "+call.status.value),call.pbxConnectionDown=!0):(delete service.calls[call.id],$log.info("[telephonyService] Offline Call Management: phone call deleted: "+call.id+" in state "+call.status.value)))}))}catch(error){var errorMessage=error&&error.message?error.message:"Unknown error",errorStack=error&&error.stack?error.stack:"Unknown stack";$log.error("[telephonyService] telephonyOfflineCallManagement  exception  -- "+errorMessage+" : "+errorStack)}},service.getTelephonyState=function(secondary){if(service.isSipWise())return $log.info("[telephonyService] getTelephonyState -- sipWise snapshot"),service.telephonyServiceSipWise.processSnapshot(service);var iq,defered=$q.defer();return iq=secondary?$iq({type:"get",to:service.userJidTel+"/phone"}).c("callservice",{xmlns:CALLSERVICE_NS}).c("connections",{deviceType:"SECONDARY"}):$iq({type:"get",to:service.userJidTel+"/phone"}).c("callservice",{xmlns:CALLSERVICE_NS}).c("connections"),xmppService.sendIQ(iq,6e4).then((function(data){var errorMessage=service.getErrorMessage(data,"getTelephonyState");if(errorMessage)return $log.info("[telephonyService] getTelephonyState -- failure -- "+errorMessage),defered.reject(new Error(errorMessage)),defered.promise;var existingCalls=angular.element(data).find("connection");if($log.info("[telephonyService] getTelephonyState ("+(secondary?"SECONDARY":"MAIN")+") -- success -- "+existingCalls.length+" existing call(s)"),0===existingCalls.length)return defered.resolve(),defered.promise;var getCallPromises=[];return existingCalls.each((function(){getCallPromises.push(service.createCallFromConnectionElem(this,secondary))})),$q.all(getCallPromises).then((function(){$log.info("[telephonyService] getTelephonyState ("+(secondary?"SECONDARY":"MAIN")+") -- calls creation completed -- "+existingCalls.length+" calls created"),defered.resolve()})).catch((function(error){$log.error("[telephonyService] getTelephonyState -- calls creation failure -- "+error.message),defered.reject(error)})),defered.promise})).catch((function(error){$log.error("[telephonyService] getTelephonyState -- failure -- "+error.message),defered.reject(error)})),defered.promise},service.getAgentStatus=function(){var defered=$q.defer(),toPCG="/phone";service.isSipWise()&&($log.info("[telephonyService] getAgentStatus --- sipWise version"),toPCG="/pcg2");var getAgentIq=$iq({type:"get",to:service.userJidTel+toPCG}).c("pbxagentstatus",{xmlns:"urn:xmpp:pbxagent:monitoring:1"});return xmppService.sendIQ(getAgentIq,6e4).then((function(data){var phoneApi=angular.element(data).find("phoneapi").text(),xmppAgent=angular.element(data).find("xmppagent").text(),agentVersion=angular.element(data).find("version").text(),features=angular.element(data).find("features").text(),type=angular.element(data).find("type").text();if(agentVersion&&(service.agentStatus={phoneApi:phoneApi,xmppAgent:xmppAgent,agentVersion:agentVersion,features:features},type?(service.isOxe=type.toLowerCase().includes("oxe"),service.isOxo=type.toLowerCase().includes("oxo")):(service.isOxe=agentVersion.toLowerCase().includes("oxe"),service.isOxo=agentVersion.toLowerCase().includes("oxo"))),service.isSipWise()&&"RVCP"!==type){service.setSipWise(!1);var errorMessage="getAgentStatus -- sipWise failure : wrong PCG type";$log.error("[telephonyService] "+errorMessage),defered.reject(new Error(errorMessage))}$log.info("[telephonyService] getAgentStatus -- success -- version "+agentVersion+" isOxe:"+service.isOxe+" isOxo:"+service.isOxo),defered.resolve()})).catch((function(error){var errorMessage="getAgentStatus -- failure : "+error.message;$log.error("[telephonyService] "+errorMessage),defered.reject(new Error(errorMessage))})),defered.promise},service.getSnapshotCall=function(callId){return $log.info("[telephonyService] getSnapshotCall"),$q((function(resolve,reject){var iq=$iq({type:"get",to:service.userJidTel+"/phone"}).c("callservice",{xmlns:CALLSERVICE_NS}).c("snapshotCall",{callId:callId});xmppService.sendIQ(iq).then((function(data){console.error(data),resolve()})).catch((function(error){var errorMessage="getSnapshotCall failure : "+error.message;$log.error("[telephonyService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.createCallFromConnectionElem=function(connectionElemObj,secondary){return $q((function(resolve,reject){var connectionElem=angular.element(connectionElemObj),jid=connectionElem.attr("endpointIm"),phoneNumber=connectionElem.attr("endpointTel"),connectionId=connectionElem.attr("callId"),endpointLci=connectionElem.attr("endpointLci"),lci=connectionElem.attr("lci"),participantsElem=connectionElem.find("participant"),identityFirstName=connectionElem.find("identity").attr("firstName"),identityLastName=connectionElem.find("identity").attr("lastName"),firstName="",lastName="";if(jid||phoneNumber||(phoneNumber="****"),profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_PHONE_BOOK)&&0===participantsElem.length&&identityLastName&&identityLastName.length&&(lastName=identityLastName,identityFirstName&&identityFirstName.length&&(firstName=identityFirstName),$log.info("[telephonyService] createCallFromConnectionElem - name resolution for: "+connectionId+" for phoneNumber:"+utilService.anonymizePhoneNumber(phoneNumber)+" with firstname : "+firstName.slice(0,1)+"***")),"LCI_INITIATED"!==lci||secondary&&$injector.get("webrtcGatewayService").IsMediaPillarUserSelected()){(0===participantsElem.length?contactService.getOrCreateContact(jid,phoneNumber):service.getParticipantsFromParticipantsElem(participantsElem)).then((function(response){var callStatus=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE;"LCI_INITIATED"===lci&&(callStatus=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.DIALING),"LCI_HELD"===lci&&"LCI_CONNECTED"===endpointLci&&(callStatus=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.HOLD),"LCI_CONNECTED"===lci&&"LCI_HELD"===endpointLci&&(callStatus=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.PUT_ON_HOLD),"LCI_CONNECTED"===lci&&"LCI_QUEUED"===endpointLci&&(callStatus=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.QUEUED_OUTGOING),"LCI_QUEUED"===lci&&"LCI_CONNECTED"===endpointLci&&(callStatus=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.QUEUED_INCOMMING),"LCI_ALERTING"===lci&&(callStatus=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING);var call=null;0===participantsElem.length?(response&&response.temp&&""!==lastName&&response.updateName(firstName,lastName),call=service.getOrCreateCall(callStatus,connectionId,response),$log.info("[telephonyService] createCallFromConnectionElem - create call for user: "+response.id+" with callId: "+connectionId+" "+lci)):((call=service.getOrCreateCall(callStatus,connectionId)).setParticipants(response),call.isConference=!0,$log.info("[telephonyService] createCallFromConnectionElem - create conference call with callId: "+connectionId+" "+lci));call.relevantEquipmentId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(connectionId),call.isSecondary=secondary,$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve(call)})).catch((function(error){$log.error("[TelephonyService] createCallFromConnectionElem - failure - "+error.message),reject(error)}))}else resolve()}))},service.getParticipantsFromParticipantsElem=function(participants){return $q((function(resolve,reject){var confParticipants=[],participantPromises=[];participants.each((function(){var participantElem=angular.element(this),endpointTel=participantElem.find("endpointTel").text(),endpointIm=participantElem.find("endpointIm").text();endpointIm&&contactService.isUserContactJid(endpointIm)||participantPromises.push($q((function(resolvePromise,rejectPromise){endpointIm||endpointTel||(endpointTel="****"),contactService.getOrCreateContact(endpointIm,endpointTel).then((function(contact){confParticipants.push(contact),resolvePromise()})).catch((function(error){rejectPromise(error)}))})))})),$q.all(participantPromises).then((function(){resolve(confParticipants)}),(function(error){reject(error)}))}))},service.getOrCreateCall=function(status,connectionId,contact){var call=service.calls[_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getIdFromConnectionId(connectionId)];return call?(call.setConnectionId(connectionId),call.startDate=new Date):((call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(status,null,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.PHONE,contact)).setConnectionId(connectionId),service.calls[call.id]=call),call},service.getOrCreateCallSipWise=function(status,callId,legId,deviceId,contact){var call=null;return callId&&(call=service.calls[callId]),call?(call.setConnectionIdSipWise(legId),contact&&call.setContact(contact),deviceId&&call.setDeviceIdSipWise(deviceId),call.startDate=new Date):((call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(status,callId,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.PHONE,contact)).setConnectionIdSipWise(legId),call.setDeviceIdSipWise(deviceId),service.calls[call.id]=call),call},service.attachHandlers=function(){$log.info("[telephonyService] attachHandlers"),0===Object.keys(service.calls||[]).length&&($rootScope.telephonyAreaClass=""),service.messageHandlerRef&&(xmppService.deleteHandler(service.messageHandlerRef),service.messageHandlerRef=null),service.messageHandlerRef=xmppService.addHandler((function(stanza){return service.telephonyEventHandler.onCallserviceMessageReceived(stanza),!0}),CALLSERVICE_NS,"message",null)},service.stop=function(){var listener;for($log.info(""),$log.info("[telephonyService] === STOPPING ==="),service.starting=service.started=!1,service.userJidTel=null,service.calls=null,service.messageHandlerRef&&(xmppService.deleteHandler(service.messageHandlerRef),service.messageHandlerRef=null);listener=listeners.pop();)listener();return $log.info("[telephonyService] === STOPPED ==="),$rootScope.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","stopped"),$q.when()},service.getCallToHangOut=function(){var calls=service.getCalls();if(!calls||0===calls.length)return null;var callStatus=calls[0].status;return 1===calls.length||callStatus===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.DIALING||callStatus===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE||callStatus===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.PUT_ON_HOLD?calls[0]:calls[1]},service.getActiveCall=function(){var activeCall=null;return Object.keys(service.calls||[]).forEach((function(key){var call=service.calls[key];call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE&&(activeCall=call)})),activeCall},service.getCalls=function(){var calls=[];return Object.keys(service.calls||[]).forEach((function(key){var status=service.calls[key].status;status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.DIALING&&status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_OUTGOING&&status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.QUEUED_OUTGOING&&status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE&&status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.HOLD&&status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.PUT_ON_HOLD&&status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ERROR||calls.push(service.calls[key])})),calls},service.getActiveCallsForContact=function(contact){var calls=[];return contact&&contact.jid&&Object.keys(service.calls||[]).forEach((function(key){!service.calls[key].contact||service.calls[key].contact.jid!==contact.jid||service.calls[key].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.DIALING&&service.calls[key].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_OUTGOING&&service.calls[key].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.QUEUED_OUTGOING&&service.calls[key].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE&&service.calls[key].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.HOLD&&service.calls[key].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.PUT_ON_HOLD||calls.push(service.calls[key])})),calls},service.getConferenceCallForContact=function(contact){var conferenceCall=null;return contact&&contact.jid&&Object.keys(service.calls||[]).forEach((function(key){service.calls[key].status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE&&service.calls[key].isConference&&(service.calls[key].participants||[]).some((function(participantContact){return participantContact&&participantContact.jid===contact.jid}))&&(conferenceCall=service.calls[key])})),conferenceCall},service.logMakecallReqData=function(reqData,contact){var reqDataForLogs={};Object.keys(reqData).forEach((function(reqDataProperty){switch(reqDataProperty){case"calleeExtNumber":case"calleeIntNumber":case"calleeShortNumber":reqDataForLogs[reqDataProperty]=utilService.anonymizePhoneNumber(reqData[reqDataProperty]);break;case"calleeDisplayName":contact&&(reqDataForLogs[reqDataProperty]=contact.getNameForLogs());break;default:reqDataForLogs[reqDataProperty]=reqData[reqDataProperty]}})),$log.info("[telephonyService] makeSimpleCall data: "+JSON.stringify(reqDataForLogs))},service.makeCall=function(contact,phoneNumber,callSubject){var activeCall=service.getActiveCall();return service.makingCall?($log.warn("[telephonyService] makeCall failure - makeCall already making a call"),$q.reject()):(service.makingCall=!0,activeCall?service.isSipWise()?"demo"===service.sipWiseMode()?service.telephonyServiceSipWise.makeSimpleCallSipWise(service,contact,phoneNumber):void $log.info("[telephonyService] makeConsultationCall sipWise not implemented"):service.makeConsultationCall(contact,phoneNumber,activeCall.connectionId):service.isSipWise()?service.telephonyServiceSipWise.makeSimpleCallSipWise(service,contact,phoneNumber):service.makeSimpleCall(contact,phoneNumber,callSubject))},service.makeSimpleCall=function(contact,phoneNumber,callSubject){return $q((function(resolve,reject){if($log.info("[telephonyService] makeSimpleCall to "+(contact?contact.getNameForLogs():utilService.anonymizePhoneNumber(phoneNumber))),!service.isBasicCallAllowed){var profileError=new Error("makeSimpleCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),service.makingCall=!1,void reject(profileError)}if($injector.get("webrtcGatewayService").isMediaPillarCallSituation()&&videoService.getWebrtcAudioCall())return $log.info("[telephonyService] makeCall failure - webrtcgateway call not possible when webrtc call already engaged"),service.makingCall=!1,$rootScope.$broadcast("ON_CALL_NOTALLOWED_EVENT","webCallAlreadyProgress"),void reject("webCallAlreadyProgress");var phoneInfo=service.getPhoneInfo(contact,phoneNumber),reqUrl=service.portalURL+"calls",reqData={calleeExtNumber:phoneInfo.longNumber,calleeIntNumber:phoneInfo.internalNumber,calleeShortNumber:phoneInfo.shortNumber,calleePbxId:phoneInfo.pbxId,calleeDisplayName:contact.displayName,callSubject:callSubject,secondaryDeviceMakeCall:angular.isDefined(service.nomadicObject.makeCallInitiatorIsMain)&&!0===service.nomadicObject.featureActivated&&service.isNomadicEnabled?service.nomadicObject.makeCallInitiatorIsMain?"false":"true":void 0};$log.info("[telephonyService] makeSimpleCall POST "+reqUrl),service.logMakecallReqData(reqData,contact),$http({method:"POST",url:reqUrl,headers:authService.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyService] makeSimpleCall success : callee "+utilService.anonymizePhoneNumber(phoneNumber));var call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.DIALING,null,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.PHONE,contact);call.setConnectionId(response.data.data.callId),call.setRelevantEquipmentId(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(call.connectionId)),call.isSecondary=service.nomadicObject&&!service.nomadicObject.makeCallInitiatorIsMain,call.isOwner=!0,service.calls[call.id]=call,$log.info("[telephonyService] makeSimpleCall Call created ("+call+")"),service.makingCall=!1,call.setIsVm(phoneNumber===service.voicemailNumber),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve(call.id)}),(function(response){var call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ERROR,null,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.PHONE,contact);call.errorMessage=response&&"403"===response.errorDetailsCode?"notAllowed":"invalidPhoneNumber",service.calls[call.contact.id]=call,call.autoClear=$interval((function(){service.clearCall(call)}),5e3,1),service.makingCall=!1,$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call);var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"makeCall"))}))}))},service.makeConsultationCall=function(contact,phoneNumber,callId){return $q((function(resolve,reject){if($log.info("[telephonyService] makeConsultationCall to "+(contact?contact.getNameForLogs():utilService.anonymizePhoneNumber(phoneNumber))),!service.isSecondCallAllowed){var profileError=new Error("makeConsultationCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),service.makingCall=!1,void reject(profileError)}var phoneInfo=service.getPhoneInfo(contact,phoneNumber),reqUrl=service.portalURL+"calls/"+encodeURIComponent(callId)+"/consultation",reqData={calleeExtNumber:phoneInfo.longNumber,calleeIntNumber:phoneInfo.internalNumber,calleeShortNumber:phoneInfo.shortNumber,calleePbxId:phoneInfo.pbxId,calleeDisplayName:contact.displayName};$log.info("[telephonyService] makeConsultationCall POST "+reqUrl),$http({method:"POST",url:reqUrl,headers:authService.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyService] makeConsultationCall success : callee "+utilService.anonymizePhoneNumber(phoneNumber));var call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.DIALING,null,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.PHONE,contact);call.setConnectionId(response.data.data.callId),call.setRelevantEquipmentId(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(call.connectionId)),call.isSecondary=service.nomadicObject&&!service.nomadicObject.makeCallInitiatorIsMain,call.isOwner=!0,service.calls[call.id]=call,$log.info("[telephonyService] makeConsultationCall Call created ("+call+")"),service.makingCall=!1,call.setIsVm(phoneNumber===service.voicemailNumber),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve(call.id)}),(function(response){var call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ERROR,null,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.PHONE,contact);call.errorMessage=response&&"403"===response.errorDetailsCode?"notAllowed":"invalidPhoneNumber",service.calls[call.contact.id]=call,call.autoClear=$interval((function(){service.clearCall(call)}),5e3,1),service.makingCall=!1;var error=errorHelperService.handleError(response);service.deleteCallIfInvalid(error,service.calls[_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getIdFromConnectionId(callId)]),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"makeConsultationCall"))}))}))},service.makeCallByPhoneNumber=function(phoneNumber){return $q((function(resolve,reject){if($log.info("[telephonyService] makeCallByPhoneNumber : "+utilService.anonymizePhoneNumber(phoneNumber)),contactService.userContact.phonePro===phoneNumber||contactService.userContact.phoneProCan===phoneNumber||contactService.userContact.phonePbx===phoneNumber){var errorMessage="makeCallByPhoneNumber failure: impossible to call its own phone number";return $log.error("[telephonyService] "+errorMessage),void reject(new Error(errorMessage))}contactService.getOrCreateContact(null,phoneNumber).then((function(contact){return contact,service.makeCall(contact,phoneNumber)})).then((function(){resolve()})).catch((function(error){var _errorMessage="makeCallByPhoneNumber failure "+(error?error.message:"");$log.error("[telephonyService] - callService - "+_errorMessage),reject(new Error(_errorMessage))}))}))},service.getPhoneInfo=function(contact,phoneNumber){var longNumber=phoneNumber,shortNumber="",internalNumber="",pbxId="";return contact&&(phoneNumber===contact.phonePro||phoneNumber===contact.phoneProCan?(longNumber=contact.phoneProCan?contact.phoneProCan:"",shortNumber=contact.phonePbx,pbxId=contact.pbxId,internalNumber=contact.phoneInternalNumber):phoneNumber===contact.phonePbx&&(longNumber="",shortNumber=contact.phonePbx,pbxId=contact.pbxId,internalNumber=contact.phoneInternalNumber)),{longNumber:longNumber,shortNumber:shortNumber,pbxId:pbxId,internalNumber:internalNumber}},service.getErrorMessage=function(data,actionLabel){var errorMessage=actionLabel+" failure : ";if("error"===angular.element(data).attr("type")){var error=angular.element(data).find("error");if(error){var errorType=error.attr("type"),errorCode=error.attr("code");errorType&&(errorMessage+=errorType+" : ","modify"===errorType&&(errorMessage+=error.find("text").text())),errorCode&&"503"===errorCode&&(errorMessage+="Agent error : service unavailable"),$log.error("[telephonyService] "+errorMessage)}else errorMessage+="Unknown error";return errorMessage}return null},service.releaseCall=function(call){return $q((function(resolve,reject){if($log.info("[telephonyService] releaseCall "+call.id),!service.isBasicCallAllowed){var profileError=new Error("releaseCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(call.pbxConnectionDown)return call.mediaPillarCall&&call.mediaPillarCall.webrtcCallRef&&call.mediaPillarCall.webrtcCallRef.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN?($log.info("[telephonyService] releaseCall "+call.id+" with pbx connection down : we release the mediapillar web call: "+call.mediaPillarCall.webrtcCallRef),videoService.releaseCall(call.mediaPillarCall.webrtcCallRef)):$log.info("[telephonyService] releaseCall "+call.id+" with pbx connection down : "+(call.mediaPillarCall?call.mediaPillarCall.webrtcCallRef?"no need to release webrtc call with status "+call.mediaPillarCall.webrtcCallRef:"no MP webrtc call to release":"no MP context!")),$log.info("[telephonyService] releaseCall "+call.id+" with pbx connection down : we remove the phone call"),service.clearCall(call),void resolve(call);if(service.isSipWise())service.telephonyServiceSipWise.releaseCallSipWise(service,call).then((function(theCall){resolve(theCall)}));else{var reqUrl=service.portalURL+"calls/"+encodeURIComponent(call.connectionId);$log.info("[telephonyService] releaseCall DELETE "+reqUrl),$http({method:"DELETE",url:reqUrl,headers:authService.getRequestHeader()}).then((function(){call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),call.startDate=null,call.vm=!1,$log.info("[telephonyService] releaseCall "+call.id+" - success"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),delete service.calls[call.id],resolve(call)}),(function(response){var error=errorHelperService.handleError(response);service.deleteCallIfInvalid(error,call),reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"releaseCall"))}))}}))},service.deleteCallIfInvalid=function(error,call){error&&"telephony"===error.portal&&404100===error.errorDetailsCode&&error.message&&(error.message.toLowerCase().includes("invalid connection identifier")||error.message.toLowerCase().includes("failed to send releasecall"))&&call&&($log.warn("[telephonyService] deleteCallIfInvalid: delete client call non existing on server: "+call.id),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),service.calls[call.id]&&delete service.calls[call.id])},service.answerCall=function(call){return $q((function(resolve,reject){$log.info("[telephonyService] answerCall : "+call.id);var activeCall=service.getActiveCall();if(!service.isBasicCallAllowed){var profileError=new Error("answerCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(call.isMediaPillarCall()&&($injector.get("webrtcGatewayService").isMediaPillarCallSituation(call)&&$rootScope.isDesktopApp)){var MP_context=call.getMediaPillarCall();if(MP_context&&MP_context.webrtcCallRef)return videoService.answerCall(MP_context.webrtcCallRef,"audio"),$log.info("[telephonyService] answer webrtcgateway sending webrtc proceed"),void resolve(call);$log.info("[telephonyService] answer webrtcgateway | Anomaly media Pillar : answer but no webrtcCallref")}service.isSipWise()?service.telephonyServiceSipWise.answerCallSipWise(service,call).then((function(theCall){resolve(theCall)}),(function(error){reject(error)})):call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.QUEUED_INCOMMING&&activeCall&&service.isOxe?service.holdCall(activeCall).catch((function(error){$log.warn("[telephonyService] holdCall (before answerCall) failed on callId:"+activeCall.connectionId+" "+error)})).then((function(){return service.answerCall(call)})).then((function(thecall){resolve(thecall)})).catch((function(error){var errorMessage="answerCall failure : "+error.message;$log.error("[telephonyService] - callService -  "+errorMessage),reject(new Error(errorMessage))})):$http({method:"PUT",url:service.portalURL+"calls/"+encodeURIComponent(call.connectionId)+"/answer",headers:authService.getRequestHeader()}).then((function(response){call.setConnectionId(response.data.data.callId),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),$log.info("[telephonyService] answerCall success : "+utilService.anonymizePhoneNumber(call.contact.phone)+" Call ("+call+")"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve(call)}),(function(response){response.data&&"Device is not able to answer a call"===response.data.errorDetails&&$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{autoClose:!1,okLabel:"close",popupTitle:"warning",popupBody:"deviceDoesntAllowAnswer"}),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN);var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"answerCall"))}))}))},service.holdCall=function(call){return $q((function(resolve,reject){if($log.info("[telephonyService] holdCall : callId: "+call.id+" "+call.contact.displayNameForLog()),call&&call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.HOLD){if(!service.isSecondCallAllowed){var profileError=new Error("holdCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}service.isSipWise()?service.telephonyServiceSipWise.holdCallSipWise(service,call).then((function(theCall){resolve(theCall)}),(function(error){reject(error)})):$http({method:"PUT",url:service.portalURL+"calls/"+encodeURIComponent(call.connectionId)+"/hold",headers:authService.getRequestHeader()}).then((function(response){$log.info("[telephonyService] holdCall success : "+utilService.anonymizePhoneNumber(call.contact.phone)+" Call ("+call+")"),call.setConnectionId(response.data.data.callId),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.HOLD),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve(call)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"holdCall"))}))}else resolve(call)}))},service.retrieveCall=function(call){return $q((function(resolve,reject){if($log.info("[telephonyService] retrieveCall callId: "+call.id+" "+call.contact.displayNameForLog()),!service.isSecondCallAllowed){var profileError=new Error("retrieveCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}var activeCall=service.getActiveCall();if(activeCall)service.holdCall(activeCall).then((function(){return service.retrieveCall(call)})).then((function(thecall){resolve(thecall)})).catch((function(error){var errorMessage="retrieveCall failure : "+error.message;$log.error("[telephonyService] - callService -  "+errorMessage),reject(new Error(errorMessage))}));else{if(service.isSipWise())return void service.telephonyServiceSipWise.retrieveCallSipWise(service,call).then((function(theCall){resolve(theCall)}),(function(error){reject(error)}));$http({method:"PUT",url:service.portalURL+"calls/"+encodeURIComponent(call.connectionId)+"/retrieve",headers:authService.getRequestHeader()}).then((function(response){$log.info("[telephonyService] retrieveCall success : "+utilService.anonymizePhoneNumber(call.contact.phone)+" Call ("+call+")"),call.setConnectionId(response.data.data.callId),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve()}),(function(response){var error=errorHelperService.handleError(response);service.deleteCallIfInvalid(error,call),reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"retrieveCall"))}))}}))},service.deflectCallToVM=function(call){return $q((function(resolve,reject){if(call){if(!service.isVMDeflectCallAllowed){var profileError=new Error("deflectCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}$log.info("[telephonyService] deflectCallToVM "+call.contact.displayNameForLog()),service.isSipWise()?service.telephonyServiceSipWise.deflectCallSipWise(service,call,service.voicemailNumber).then((function(){resolve()}),(function(error){reject(error)})):$http({method:"PUT",url:service.portalURL+"calls/"+encodeURIComponent(call.connectionId)+"/deflect",headers:authService.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:service.voicemailNumber,calleeShortNumber:service.voicemailNumber,calleePbxId:service.pbxId}}).then((function(){$log.info("[telephonyService] deflectCall success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"deflectCallToVM"))}))}else resolve(call)}))},service.deflectCallToNumber=function(call,number){return $q((function(resolve,reject){if(call&&number){var profileError;if(!service.isVMDeflectCallAllowed)return(profileError=new Error("deflectCall failure - Not Allowed")).status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError);if($log.info("[telephonyService] deflectCallToNumber "+call.contact.displayNameForLog()),service.isSipWise()&&"demo"===service.sipWiseMode())service.telephonyServiceSipWise.deflectCallSipWise(service,call,number).then((function(){resolve()}),(function(error){reject(error)}));else(profileError=new Error("deflectCall failure - Not Allowed")).status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),reject(profileError)}else resolve(call)}))},service.transfertCall=function(activeCall,heldCall){return $q((function(resolve,reject){if(activeCall&&heldCall){var profileError;if(!service.isTransferAllowed)return(profileError=new Error("transferCall failure - Not Allowed")).status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError);if($log.info("[telephonyService] transfertCall held("+heldCall.contact.displayName+") to active("+activeCall.contact.displayName+")"),service.isSipWise())return"demo"===service.sipWiseMode()?service.telephonyServiceSipWise.transfertCallSipWise(service,activeCall,heldCall):($log.info("[telephonyService] Transfert sipWise not implemented"),(profileError=new Error("transferCall failure - Not Allowed")).status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError));$http({method:"PUT",url:service.portalURL+"calls/"+encodeURIComponent(activeCall.connectionId)+"/transfer/"+encodeURIComponent(heldCall.connectionId),headers:authService.getRequestHeader()}).then((function(){$log.info("[telephonyService] transferCall success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"transfertCall"))}))}else resolve()}))},service.blindTransfertCall=function(activeCall,calleNumber){return $q((function(resolve,reject){var profileError;if(activeCall&&calleNumber)return service.isTransferAllowed&&service.isSipWise()?"demo"===service.sipWiseMode()?service.telephonyServiceSipWise.blindTransfertCallSipWise(service,activeCall,calleNumber):($log.info("[telephonyService]  blind Transfert sipWise not implemented"),(profileError=new Error("blind transferCall failure - Not Allowed")).status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)):((profileError=new Error("blind transfertCall failure - Not Allowed")).status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError));resolve()}))},service.conferenceCall=function(activeCall,heldCall){return $q((function(resolve,reject){if(activeCall&&heldCall){if(!service.isConferenceAllowed){var profileError=new Error("conferenceCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if($log.info("[telephonyService] conferenceCall "+activeCall.contact.displayName+" and "+heldCall.contact.displayName),service.isSipWise())return"demo"===service.sipWiseMode()?service.telephonyServiceSipWise.conferenceCallSipWise(service,activeCall,heldCall):void $log.info("[telephonyService] Conference sipWise not implemented");$http({method:"PUT",url:service.portalURL+"calls/"+encodeURIComponent(activeCall.connectionId)+"/conference/"+encodeURIComponent(heldCall.connectionId),headers:authService.getRequestHeader()}).then((function(){$log.info("[telephonyService] conferenceCall success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"conferenceCall"))}))}else resolve()}))},service.sipWiseForwardToDevice=function(phoneNumber,destType,forwardType){return $q((function(resolve,reject){if($log.info("[telephonyService] sipWiseforwardToDevice : "+phoneNumber+" / destType = "+destType+" / fwType = "+forwardType),!service.isForwardEnabled){var profileError=new Error("sipWiseforwardToDevice failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(contactService.userContact.phonePro===phoneNumber||contactService.userContact.phoneProCan===phoneNumber||contactService.userContact.phonePbx===phoneNumber){var errorMessage="sipWiseforwardToDevice failure: impossible to forward its own phone number";return $log.error("[telephonyService] "+errorMessage),void reject(new Error(errorMessage))}if(!phoneNumber||!forwardType||""===forwardType||!destType||""===destType){errorMessage="sipWiseforwardToDevice failure: bad parameters";return $log.error("[telephonyService] "+errorMessage),void reject(new Error(errorMessage))}if(!service.isSipWise()){errorMessage="sipWiseforwardToDevice not implemented if not sipWise case";return $log.error("[telephonyService] "+errorMessage),void reject(new Error(errorMessage))}service.telephonyServiceSipWise.forwardToDeviceSipWise(service,phoneNumber,destType,forwardType).then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"forwardToDevice"))}))}))},service.forwardToDevice=function(phoneNumber){return $q((function(resolve,reject){if($log.info("[telephonyService] forwardToDevice : "+phoneNumber),!service.isForwardEnabled){var profileError=new Error("forwardToDevice failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(contactService.userContact.phonePro===phoneNumber||contactService.userContact.phoneProCan===phoneNumber||contactService.userContact.phonePbx===phoneNumber){var errorMessage="forwardToDevice failure: impossible to forward its own phone number";return $log.error("[telephonyService] "+errorMessage),void reject(new Error(errorMessage))}if(service.isSipWise()){if("demo"===service.sipWiseMode())return void contactService.getOrCreateContact(null,phoneNumber).then((function(contact){var phoneInfo=service.getPhoneInfo(contact,phoneNumber),destType="externalNumber";if(""!==phoneInfo.longNumber){destType="externalNumber";phoneNumber=phoneInfo.longNumber}else{destType="internalNumber";phoneNumber=phoneInfo.shortNumber}service.telephonyServiceSipWise.forwardToDeviceSipWise(service,phoneNumber,destType,"immediate").then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"forwardToDevice"))}))}));errorMessage="forwardToDevice : not implemented";return $log.error("[telephonyService] "+errorMessage),void reject(new Error(errorMessage))}contactService.getOrCreateContact(null,phoneNumber).then((function(contact){var phoneInfo=service.getPhoneInfo(contact,phoneNumber);$http({method:"PUT",url:service.portalURL+"forward",headers:authService.getRequestHeader(),data:{calleeExtNumber:phoneInfo.longNumber,calleeIntNumber:phoneInfo.internalNumber,calleeShortNumber:phoneInfo.shortNumber,calleePbxId:phoneInfo.pbxId,calleeDisplayName:contact.displayName}}).then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"forwardToDevice"))}))}))}))},service.forwardToVoicemail=function(){return $q((function(resolve,reject){if($log.info("[telephonyService] forwardToVoicemail"),!service.voiceMailFeatureEnabled||!service.isForwardEnabled){var profileError=new Error("forwardToVoicemail failure - voicemail/forward feature not enabled");return profileError.status=profileError.errorDetailsCode="404",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(service.isSipWise()){if("demo"===service.sipWiseMode()){return void service.telephonyServiceSipWise.forwardToDeviceSipWise(service,service.voicemailNumber,"voicemail","immediate").then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"forwardToVoicemail"))}))}return $log.error("[telephonyService] forwardToVoicemail : not implemented"),void reject(new Error("forwardToVoicemail : not implemented"))}$http({method:"PUT",url:service.portalURL+"forward",headers:authService.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:service.voicemailNumber,calleePbxId:service.pbxId}}).then((function(){$log.info("[telephonyService] forwardToVoicemail success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"forwardToVoicemail"))}))}))},service.cancelForward=function(){return $q((function(resolve,reject){if($log.info("[telephonyService] cancelForward"),!service.isForwardEnabled){var profileError=new Error("cancelForward failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(service.isSipWise()){if("demo"===service.sipWiseMode()){return void service.telephonyServiceSipWise.forwardToDeviceSipWise(service,"dummy","dummy","none").then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"cancelForward"))}))}return $log.error("[telephonyService] cancelForward : not implemented"),void reject(new Error("cancelForward : not implemented"))}contactService.userContact.phonePbx?$http({method:"PUT",url:service.portalURL+"forward",headers:authService.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:"CANCELFORWARD",calleePbxId:service.pbxId}}).then((function(){$log.info("[telephonyService] cancelForward success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"cancelForward"))})):reject()}))},service.getForwardStatus=function(){return $q((function(resolve,reject){if(!service.isForwardEnabled){var profileError=new Error("getForwardStatus failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(service.starting||service.started){if(service.isSipWise())return void("demo"===service.sipWiseMode()?service.telephonyServiceSipWise.getForwardStatusSipWise(service).then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"getForwardStatus"))})):($log.info("[telephonyService] getForwardStatus -- SipWise bypass -- forward status not delivered"),resolve()));$http({method:"GET",url:service.portalURL+"forward",headers:authService.getRequestHeader()}).then((function(){$log.info("[telephonyService] getForwardStatus success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"getForwardStatus"))}))}else reject(new Error("getForwardStatus failure - Telephony not started"))}))},service.getForwardObject=function(){return service.forwardObject},service.nomadicLogin=function(phoneNumber,isUnchangeableNumber,NotTakeIntoAccount){return $q((function(resolve,reject){if(!service.isNomadicEnabled||!service.nomadicObject.featureActivated){var profileError=new Error("nomadicLogin failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(contactService.userContact.phonePro===phoneNumber||contactService.userContact.phoneProCan===phoneNumber||contactService.userContact.phonePbx===phoneNumber){var errorMessage="nomadicLogin failure: impossible to use its own phone number like nomadic phone";return $log.error("[telephonyService] "+errorMessage),void reject(new Error(errorMessage))}$log.info("[telephonyService] nomadicLogin : "+utilService.anonymizePhoneNumber(phoneNumber)),NotTakeIntoAccount=NotTakeIntoAccount||!1,isUnchangeableNumber=isUnchangeableNumber||!1,service.nomadicAnswerNotTakedIntoAccount=NotTakeIntoAccount,contactService.getOrCreateContact(null,phoneNumber).then((function(contact){var phoneInfo=service.getPhoneInfo(contact,phoneNumber);$http({method:"PUT",url:service.portalURL+"nomadic/login",headers:authService.getRequestHeader(),data:{destinationExtNumber:phoneInfo.longNumber,destinationIntNumber:phoneInfo.internalNumber,destinationShortNumber:phoneInfo.shortNumber,destinationRainbowNumber:isUnchangeableNumber?phoneNumber:"",destinationPbxId:phoneInfo.pbxId,destinationDisplayName:contact.displayName,destinationCountry:contact.country}}).then((function(){$log.info("[telephonyService] nomadicLogin success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"nomadicLogin"))}))}))}))},service.nomadicLoginOnOfficePhone=function(){return $q((function(resolve,reject){if(!service.isNomadicEnabled||!service.nomadicObject.featureActivated){var profileError=new Error("nomadicLoginOnOfficePhone failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}$log.info("[telephonyService] nomadicLoginOnOfficePhone"),$http({method:"PUT",url:service.portalURL+"nomadic/login",headers:authService.getRequestHeader()}).then((function(){$log.info("[telephonyService] nomadicLoginOnOfficePhone success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"nomadicLoginOnOfficePhone"))}))}))},service.nomadicLogout=function(){return $q((function(resolve,reject){if(!service.isNomadicEnabled||!service.nomadicObject.featureActivated){var profileError=new Error("nomadicLogout failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}$log.info("[telephonyService] nomadicLogout"),$http({method:"PUT",url:service.portalURL+"nomadic/logout",headers:authService.getRequestHeader()}).then((function(){$log.info("[telephonyService] nomadicLogout success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"nomadicLogout"))}))}))},service.getNomadicStatus=function(){return $q((function(resolve,reject){if(service.isSipWise()){$log.info("[telephonyService] getNomadicStatus -- SipWise bypass Nomadic");resolve()}else{if(!service.isNomadicEnabled){var profileError=new Error("getNomadicStatus failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}service.starting||service.started?$http({method:"GET",url:service.portalURL+"nomadic",headers:authService.getRequestHeader()}).then((function(response){$log.info("[telephonyService] getNomadicStatus success"),service.updateNomadicData(response.data.data),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"getNomadicStatus"))})):reject(new Error("getNomadicStatus failure - Telephony not started"))}}))},service.setNomadicState=function(){return $q((function(resolve,reject){$log.info("[telephonyService] setNomadicState"),$http({method:"PUT",url:service.portalURL+"nomadic/state",headers:authService.getRequestHeader(),data:{makeCallInitiatorIsMain:"true"}}).then((function(){$log.info("[telephonyService] setNomadicState success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"setNomadicState"))}))}))},service.updateNomadicData=function(response){var destination=response.destination?utilService.anonymizePhoneNumber(response.destination):"";$log.info("[telephonyService] updateNomadicData destination: "+destination+" featureActivated: "+response.featureActivated+" makeCallInitiatorIsMain: "+response.makeCallInitiatorIsMain+" modeActivated: "+response.modeActivated+" monodevice: "+contactService.userContact.isVirtualTerm);var nomadicObjectOrg=JSON.parse(JSON.stringify(service.nomadicObject));service.nomadicObject.featureActivated="true"===response.featureActivated,service.nomadicObject.modeActivated="true"===response.modeActivated,service.nomadicObject.destination=response.destination,service.nomadicObject.makeCallInitiatorIsMain="true"===response.makeCallInitiatorIsMain;var makeCallInitiatorIsMainChanged=nomadicObjectOrg.makeCallInitiatorIsMain!==service.nomadicObject.makeCallInitiatorIsMain;service.nomadicAnswerNotTakedIntoAccount||$rootScope.$broadcast("ON_CALL_NOMADIC_EVENT",service.nomadicObject),service.nomadicAnswerNotTakedIntoAccount=!1;var webrtcGatewayService=$injector.get("webrtcGatewayService");if(contactService.userContact.isVirtualTerm&&service.nomadicObject.featureActivated&&service.nomadicObject.modeActivated&&(""===service.nomadicObject.destination||void 0===service.nomadicObject.destination)&&webrtcGatewayService.isMediaPillarConfigured()){var defaultNumber=webrtcGatewayService.getMyMediaPillarRemoteExtension();service.nomadicLogin(defaultNumber)}else if(contactService.userContact.isVirtualTerm&&service.nomadicObject.featureActivated&&service.nomadicObject.modeActivated&&(""===service.nomadicObject.destination||void 0===service.nomadicObject.destination)&&(contactService.userContact.mobileProCan||contactService.userContact.mobilePerso)){defaultNumber=contactService.userContact.mobileProCan?contactService.userContact.mobileProCan:contactService.userContact.mobilePerso;service.nomadicLogin(defaultNumber)}return makeCallInitiatorIsMainChanged},service.getNomadicObject=function(){return service.nomadicObject},service.getNomadicDestination=function(){return service.nomadicObject.destination},service.sendDtmf=function(call,dtmf){return $q((function(resolve,reject){if(call&&dtmf){if($log.info("[telephonyService] sendDtmf for call "+call.id),service.isSipWise())return void service.telephonyServiceSipWise.sendDtmfSipWise(service,call,dtmf).then((function(){resolve()}),(function(error){reject(error)}));$http({method:"PUT",url:service.portalURL+"calls/"+encodeURIComponent(call.connectionId)+"/dtmf",headers:authService.getRequestHeader(),data:{dtmf:dtmf}}).then((function(){$log.info("[telephonyService] sendDtmf success"),$rootScope.$broadcast("ON_DTMF_SENT",dtmf),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"sendDtmf"))}))}else reject()}))},service.clearCall=function(call,nobroadcast){$log.info("[telephonyService] clearCall for call id: "+call.id),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),nobroadcast||$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),call.contact&&delete service.calls[call.contact.id],call.getCurrentCalled()&&call.setCurrentCalled(null)},service.startAsPhoneNumber=function(phoneNumber){var cleanPhoneNumber=phoneNumber.trim().split(".").join(""),match=cleanPhoneNumber.match(/^(\+|\d|#|\*|\(|\)|\.|-|||\s|\/)*$/);return!!match&&match[0]===cleanPhoneNumber},service.updateContactFromOutlookInfos=function(__contact,__phoneNumber,__reload,__mode){return $log.info("[telephonyService] default updateContactFromOutlookInfos"),$q.reject()},service.setSipWise=function(condition){sipWise=condition},service.isSipWise=function(){return sipWise},service.sipWiseMode=function(){var mode=settingsService.getSetting("sipWiseMode");return sipWise||(mode=!1),mode},service.resetAllSipWiseCall=function(){if(service.isSipWise()){var iq=$iq({type:"set",to:service.userJidTel+"/pcg2"}).c("telephony",{xmlns:"urn:xmpp:pbxagent:telephony:1"}).c("service").c("deleteCalls",{forced:"true"});xmppService.sendIQ(iq,6e4).then((function(data){$log.info("[telephonyService] resetAllSipWiseCall : try to reset all ghost calls !"),console.error(data)})).catch((function(error){var errorMessage="resetAllSipWiseCall failure : "+error.message;$log.error("[telephonyService]"+errorMessage)}))}}}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0);angular.module("rainbow").factory("TelephonyServiceEventHandler",["$log","$q","$rootScope","$interval","$injector","contactService","profileService","Contact","PromiseQueue","pstnConferenceService","utilService",function($log,$q,$rootScope,$interval,$injector,contactService,profileService,Contact,PromiseQueue,pstnConferenceService,utilService){function TelephonyServiceEventHandler(telephonyService){this.telephonyService=telephonyService,this.promiseQueue=PromiseQueue.create()}return TelephonyServiceEventHandler.create=function(telephonyService){return new TelephonyServiceEventHandler(telephonyService)},TelephonyServiceEventHandler.CallFailureLabels={DESTNOTOBTAINABLE:"outOfService",DONOTDISTURB:"dnd",TRUNKSBUSY:"trunksbusy",BUSY:"busy"},TelephonyServiceEventHandler.prototype.existingCall=function(callId){var exist=this.telephonyService.calls[callId];return $log.debug("[TelephonyServiceEventHandler] existingCall -- "+callId+" => "+exist),exist},TelephonyServiceEventHandler.prototype.onCallserviceMessageReceived=function(stanza){try{var stanzaElem=$(stanza),that=this;if("Offline Storage"===stanzaElem.find("delay").text())return!0;var actionElem=stanzaElem.find("callservice").children(),tagNames=actionElem.prop("tagName").split(":"),actionElemName=tagNames[tagNames.length-1].toLowerCase(),callId=actionElem.attr("callId"),callIdForLogs=callId?" -- "+callId:"",evtDeviceType=actionElem.attr("deviceType"),displayDeviceType=evtDeviceType?" -- "+evtDeviceType:"",oldCallId=actionElem.attr("oldCallId");oldCallId=oldCallId?" -- old "+oldCallId:"",evtDeviceType||(evtDeviceType="MAIN");var cfgNomadic=this.telephonyService.getNomadicObject(),cfgOfficePhone=!cfgNomadic||(cfgNomadic.makeCallInitiatorIsMain||!cfgNomadic.modeActivated);if(!["messaging","voicemessages","forwarded","nomadicstatus","opendesktop"].includes(actionElemName)&&("MAIN"===evtDeviceType&&!cfgOfficePhone||"SECONDARY"===evtDeviceType&&cfgOfficePhone)&&!that.existingCall(callId))return $log.info("[TelephonyServiceEventHandler] onCallserviceMessageReceived -- "+actionElemName.toUpperCase()+callIdForLogs+oldCallId+displayDeviceType+" => IGNORED"),!0;switch($log.info("[TelephonyServiceEventHandler] onCallserviceMessageReceived -- "+actionElemName.toUpperCase()+callIdForLogs+oldCallId+displayDeviceType),actionElemName){case"initiated":this.promiseQueue.add((function(){return that.onInitiatedEvent(actionElem)}));break;case"originated":this.promiseQueue.add((function(){return that.onOriginatedEvent(actionElem)}));break;case"delivered":this.promiseQueue.add((function(){return that.onDeliveredEvent(actionElem)}));break;case"established":this.promiseQueue.add((function(){return that.onEstablishedEvent(actionElem)}));break;case"retrievecall":this.promiseQueue.add((function(){return that.onRetrieveCallEvent(actionElem)}));break;case"queued":this.promiseQueue.add((function(){return that.onQueuedEvent(actionElem)}));break;case"holdcall":case"held":this.promiseQueue.add((function(){return that.onHeldEvent(actionElem)}));break;case"diverted":this.promiseQueue.add((function(){return that.onDivertedEvent(actionElem)}));break;case"transfercall":case"transferred":this.promiseQueue.add((function(){return that.onTransferEvent(actionElem)}));break;case"conferenced":this.promiseQueue.add((function(){return that.onConferenceEvent(actionElem)}));break;case"connectioncleared":this.promiseQueue.add((function(){return that.onClearCallEvent(actionElem)}));break;case"failed":this.promiseQueue.add((function(){return that.onFailCallEvent(actionElem)}));break;case"voicemessages":this.promiseQueue.add((function(){return that.onVoiceMessageEvent(actionElem)}));break;case"updatecall":this.promiseQueue.add((function(){return that.onUpDateCallEvent(actionElem)}));break;case"forwarded":this.promiseQueue.add((function(){return that.onCallForwardedEvent(actionElem)}));break;case"callsubject":this.promiseQueue.add((function(){return that.onCallSubjectEvent(actionElem)}));break;case"nomadicstatus":this.promiseQueue.add((function(){return that.onCallNomadicEvent(actionElem)}));break;case"opendesktop":$log.info("[TelephonyServiceEventHandler] openDesktop detected ")}return!0}catch(error){return $log.error("[TelephonyServiceEventHandler] onCallserviceMessageReceived -- failure -- "+error.message),!0}},TelephonyServiceEventHandler.prototype.onInitiatedEvent=function(initiatedElem){$log.info("[TelephonyServiceEventHandler] onInitiatedEvent");var that=this;return this.getCall(initiatedElem).then((function(call){try{var deviceState=initiatedElem.attr("deviceState"),newConnectionId=initiatedElem.attr("newCallId");return void 0!==newConnectionId?that.getOrCreateCall(newConnectionId).then((function(newCall){$log.info("[TelephonyServiceEventHandler] onInitiatedEvent : changed call id from "+call.id+" to "+newConnectionId),that.computeCallRelevancy(initiatedElem,newCall),"LCI_CONNECTED"===deviceState?newCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE):newCall.setStatus(call.status),newCall.setContact(call.contact),newCall.isOwner=call.isOwner;var confSession=pstnConferenceService.getConferenceSessionWithConnId(call.connectionId);(confSession&&confSession.setCallId(newConnectionId),call.isMediaPillarCall())&&$injector.get("webrtcGatewayService").replaceCallRefs(newCall,call);that.telephonyService.clearCall(call),that.sendCallUpdateEvent(call),that.sendCallUpdateEvent(newCall),delete that.telephonyService.calls[call.id]})):that.computeCallRelevancy(initiatedElem,call),$q.when()}catch(error){var errorMessage="onInitiatedEvent -- "+error.message;return $log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandler.prototype.onOriginatedEvent=function(originatedElem){$log.info("[TelephonyServiceEventHandler] onOriginatedEvent");var that=this;return this.getCall(originatedElem).then((function(call){try{var jid=originatedElem.attr("endpointIm"),phoneNumber=originatedElem.attr("endpointTel"),newConnectionId=originatedElem.attr("newCallId"),currentCalled={contactPhoneNumber:"",contact:call.contact,participantsPhoneNumbers:null,participants:null};return jid||phoneNumber?currentCalled.contactPhoneNumber=phoneNumber||"":call.contact&&call.contact.temp&&(currentCalled.contactPhoneNumber=call.contact.id),call.setCurrentCalled(currentCalled),void 0!==newConnectionId?that.getOrCreateCall(newConnectionId,jid,phoneNumber).then((function(newCall){$log.info("[TelephonyServiceEventHandler] onOriginatedEvent : changed call id from "+call.id+" to "+newConnectionId),that.computeCallRelevancy(originatedElem,newCall),newCall.setStatus(call.status),newCall.setContact(call.contact),newCall.setCurrentCalled(currentCalled),newCall.isOwner=call.isOwner;var confSession=pstnConferenceService.getConferenceSessionWithConnId(call.connectionId);(confSession&&confSession.setCallId(newConnectionId),call.isMediaPillarCall())&&$injector.get("webrtcGatewayService").replaceCallRefs(newCall,call);that.telephonyService.clearCall(call),that.sendCallUpdateEvent(call),that.sendCallUpdateEvent(newCall),delete that.telephonyService.calls[call.id]})):that.sendCallUpdateEvent(call),$q.when()}catch(error){var errorMessage="onOriginatedEvent -- "+error.message;return $log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandler.prototype.onDeliveredEvent=function(deliveredElem){$log.info("[TelephonyServiceEventHandler] onDeliveredEvent");var that=this;return this.getCall(deliveredElem).then((function(call){try{if(that.computeCallRelevancy(deliveredElem,call),call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.QUEUED_INCOMMING)return $q.resolve();var type=deliveredElem.attr("type"),jid=deliveredElem.attr("endpointIm"),phoneNumber=deliveredElem.attr("endpointTel");return call.setStatus("outgoing"===type?_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_OUTGOING:_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING),call.startDate=null,call.vm=!1,that.updateCallContact(jid,phoneNumber,deliveredElem,call)}catch(error){var errorMessage="onDeliveredEvent -- "+error.message;return $log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandler.prototype.onEstablishedEvent=function(establishedElem){$log.info("[TelephonyServiceEventHandler] onEstablishedEvent");var that=this;return this.getCall(establishedElem).then((function(call){try{that.computeCallRelevancy(establishedElem,call);var jid=establishedElem.attr("endpointIm"),phoneNumber=establishedElem.attr("endpointTel"),connectionId=establishedElem.attr("callId");if(call.contact&&call.contact.id)return call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),call.setConnectionId(connectionId),that.sendCallUpdateEvent(call,establishedElem),that.updateCallContact(jid,phoneNumber,establishedElem,call);if(!(call.participants&&call.participants.length>0))return $log.info("[TelephonyServiceEventHandler] onEstablishedEvent, no call contact / no participants"),jid||phoneNumber||(phoneNumber="****"),contactService.getOrCreateContact(jid,phoneNumber).then((function(contact){return call.setContact(contact),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),currentCalled={contactPhoneNumber:phoneNumber,contact:contact},call.setCurrentCalled(currentCalled),that.sendCallUpdateEvent(call,establishedElem),$q.when()}));for(var contactRecovered=null,i=0;i<call.participants.length&&!contactRecovered;i++)call.participants[i].id===jid?contactRecovered=call.participants[i]:call.currentCalled.participantsPhoneNumbers&&call.currentCalled.participantsPhoneNumbers.length>0&&call.currentCalled.participantsPhoneNumbers[i]===phoneNumber&&(contactRecovered=call.participants[i]);call.participants=[],call.isConference=!1;var currentCalled=call.getCurrentCalled();return contactRecovered?(call.setContact(contactRecovered),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),currentCalled={contactPhoneNumber:phoneNumber,contact:contactRecovered},call.setCurrentCalled(currentCalled),that.sendCallUpdateEvent(call,establishedElem),$q.when()):(jid||phoneNumber||(phoneNumber="****"),contactService.getOrCreateContact(jid,phoneNumber).then((function(contact){return call.setContact(contact),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),currentCalled={contactPhoneNumber:phoneNumber,contact:contact},call.setCurrentCalled(currentCalled),that.sendCallUpdateEvent(call,establishedElem),$q.when()})))}catch(error){var errorMessage="onEstablishedEvent -- "+error.message;return $log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandler.prototype.onRetrieveCallEvent=function(retrieveElem){$log.info("[TelephonyServiceEventHandler] onRetrieveCallEvent");var that=this;return this.getCall(retrieveElem,!0).then((function(call){call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),that.sendCallUpdateEvent(call,retrieveElem)}))},TelephonyServiceEventHandler.prototype.onClearCallEvent=function(clearElem){var that=this,connectionId=clearElem.attr("callId"),callId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getIdFromConnectionId(connectionId);return $log.info("[TelephonyServiceEventHandler] onClearCallEvent, connectionId: "+connectionId),this.telephonyService.calls[callId]?this.getCall(clearElem).then((function(call){that.computeCallRelevancy(clearElem,call),that.telephonyService.clearCall(call,!0),that.sendCallUpdateEvent(call,clearElem)})):($log.info("[TelephonyServiceEventHandler] onClearCallEvent, no call for connectionId: "+connectionId),$q.resolve())},TelephonyServiceEventHandler.prototype.onHeldEvent=function(heldElem){$log.info("[TelephonyServiceEventHandler] onHeldEvent");var that=this;return this.getCall(heldElem,!0).then((function(call){try{var connectionId=heldElem.attr("callId");return _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(call.connectionId)===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(connectionId)?call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.HOLD):call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.PUT_ON_HOLD),that.sendCallUpdateEvent(call,heldElem),$q.when()}catch(error){var errorMessage="onHeldEvent -- "+error.message;return $log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandler.prototype.onQueuedEvent=function(queuedElem){$log.info("[TelephonyServiceEventHandler] onQueuedEvent");var that=this,cause=queuedElem.attr("cause");return"PARK"===cause?($log.warn("[TelephonyServiceEventHandler] onQueuedEvent - ignore PARK cause"),$q.when()):"NEWCALL"===cause?($log.warn("[TelephonyServiceEventHandler] onQueuedEvent - ignore NEWCALL cause"),$q.when()):"CAMPON"!==cause&&this.telephonyService.isOxe?($log.warn("[TelephonyServiceEventHandler] onQueuedEvent - ignore cause not CAMPON  (for oxe attendant res monoLine)"),$q.when()):this.getCall(queuedElem).then((function(call){try{that.computeCallRelevancy(queuedElem,call);var type=queuedElem.attr("type"),jid=queuedElem.attr("endpointIm"),phoneNumber=queuedElem.attr("endpointTel"),status="outgoing"===type?_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.QUEUED_OUTGOING:_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.QUEUED_INCOMMING;return call.setStatus(status),call.startDate=null,call.vm=!1,call.relevantEquipmentId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(call.connectionId),that.updateCallContact(jid,phoneNumber,queuedElem,call)}catch(error){var errorMessage="onQueuedEvent -- "+error.message;return $log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandler.prototype.onDivertedEvent=function(divertedElem){$log.info("[TelephonyServiceEventHandler] onDivertedEvent");var oldConnectionId=divertedElem.attr("oldCallId"),oldCallId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getIdFromConnectionId(oldConnectionId),call=this.telephonyService.calls[oldCallId];return call?(this.computeCallRelevancy(divertedElem,call),$injector.get("webrtcGatewayService").isMediaPillarCallCase()?call.isSecondary?this.telephonyService.clearCall(call):this.telephonyService.clearCall(call,!0):this.telephonyService.clearCall(call),this.sendCallUpdateEvent(call,divertedElem),$q.when()):($log.warn("[TelephonyServiceEventHandler] onDivertedEvent - receive divertedEvent on unknown call --- ignored"),$q.when())},TelephonyServiceEventHandler.prototype.onTransferEvent=function(transferElem){$log.info("[TelephonyServiceEventHandler] onTransferEvent");var that=this,activeConnectionId=transferElem.attr("activeCallId"),heldConnectionId=transferElem.attr("heldCallId"),newConnectionId=transferElem.attr("newCallId"),activeCallId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getIdFromConnectionId(activeConnectionId),activeCall=this.telephonyService.calls[activeCallId];if(heldConnectionId){var heldCallId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getIdFromConnectionId(heldConnectionId),heldCall=this.telephonyService.calls[heldCallId];heldCall&&heldCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),activeCall&&activeCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),heldCall&&that.sendCallUpdateEvent(heldCall),activeCall&&that.sendCallUpdateEvent(activeCall)}if(newConnectionId){var jid=transferElem.attr("newEndpointIm"),phoneNumber=transferElem.attr("newEndpointTel"),deviceState=transferElem.attr("deviceState");deviceState||(deviceState=transferElem.attr("deviceStatus"));var deviceType=transferElem.attr("deviceType");return deviceType||(deviceType="MAIN"),activeCall&&(activeCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),that.sendCallUpdateEvent(activeCall)),jid||phoneNumber||(phoneNumber="****"),this.getOrCreateCall(newConnectionId,jid,phoneNumber).then((function(newCall){return deviceState&&"LCI_ALERTING"===deviceState?newCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING):newCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),newCall.relevantEquipmentId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(newConnectionId),newCall.isSecondary=deviceType&&"SECONDARY"===deviceType,that.updateCallContact(jid,phoneNumber,transferElem,newCall)}))}return $q.resolve()},TelephonyServiceEventHandler.prototype.onConferenceEvent=function(conferencedElem){$log.info("[TelephonyServiceEventHandler] onConferenceEvent");var that=this,primaryOldConnectionId=conferencedElem.find("primaryOldCallId").text(),secondaryOldConnectionId=conferencedElem.find("secondaryOldCallId").text(),newConnectionId=conferencedElem.find("newCallId").text(),primaryOldCallId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getIdFromConnectionId(primaryOldConnectionId),secondaryOldCallId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getIdFromConnectionId(secondaryOldConnectionId),primaryOldCall=this.telephonyService.calls[primaryOldCallId],secondaryOldCall=this.telephonyService.calls[secondaryOldCallId],confParticipants=[],participantPromises=[],confParticipantsPhoneNumbers=[];return conferencedElem.find("participant").each((function(){var participantElem=angular.element(this),endpointTel=participantElem.find("endpointTel").text(),endpointIm=participantElem.find("endpointIm").text();endpointIm&&contactService.isUserContactJid(endpointIm)||participantPromises.push($q((function(resolve,reject){endpointIm||endpointTel||(endpointTel="****"),!endpointIm&&primaryOldCall&&primaryOldCall.contact&&primaryOldCall.currentCalled.contactPhoneNumber===endpointTel?(confParticipants.push(primaryOldCall.contact),confParticipantsPhoneNumbers.push(endpointTel),resolve()):!endpointIm&&secondaryOldCall&&secondaryOldCall.contact&&secondaryOldCall.currentCalled.contactPhoneNumber===endpointTel?(confParticipants.push(secondaryOldCall.contact),confParticipantsPhoneNumbers.push(endpointTel),resolve()):contactService.getOrCreateContact(endpointIm,endpointTel).then((function(contact){confParticipants.push(contact),confParticipantsPhoneNumbers.push(endpointTel),that.telephonyService.updateContactFromOutlookInfos(contact,endpointTel).then((function(updateStatus){updateStatus?$log.debug("[TelephonyServiceEventHandler] on conferenced, update from outlook for contact :"+contact.displayNameMD5):$log.debug("[TelephonyServiceEventHandler] on conferenced, no update from outlook for contact :"+contact.displayNameMD5)}),(function(){$log.debug("[TelephonyServiceEventHandler] on conferenced, no Outlook search available")})).finally((function(){resolve()}))})).catch((function(error){$log.error("[TelephonyServiceEventHandler] onConferenceEvent - Impossible to get contact - "+error.message),resolve()}))})))})),$q.all(participantPromises).finally((function(){var isSecondaryDevice=!1;primaryOldCall&&(isSecondaryDevice=isSecondaryDevice||primaryOldCall.isSecondary),secondaryOldCall&&(isSecondaryDevice=isSecondaryDevice||secondaryOldCall.isSecondary);var newConferenceCall=that.createConferenceCall(newConnectionId,confParticipants),currentCalled=newConferenceCall.getCurrentCalled();currentCalled.participants=confParticipants,currentCalled.participantsPhoneNumbers=confParticipantsPhoneNumbers,newConferenceCall.setCurrentCalled(currentCalled),newConferenceCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),newConferenceCall.relevantEquipmentId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(newConnectionId),newConferenceCall.isSecondary=isSecondaryDevice,$log.debug("[TelephonyServiceEventHandler] on conferenced, create new call: "+newConferenceCall),that.sendCallUpdateEvent(newConferenceCall),primaryOldCall&&(primaryOldCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),$log.debug("[TelephonyServiceEventHandler] on conferenced, updated primaryOldCall: "+primaryOldCall),that.sendCallUpdateEvent(primaryOldCall)),secondaryOldCall&&(secondaryOldCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),$log.debug("[TelephonyServiceEventHandler] on conferenced, updated secondaryOldCall: "+secondaryOldCall),that.sendCallUpdateEvent(secondaryOldCall))}))},TelephonyServiceEventHandler.prototype.onVoiceMessageEvent=function(messagingElem){$log.info("[TelephonyServiceEventHandler] onVoiceMessageEvent");var voiceMessageCounters=messagingElem.find("voiceMessagesCounters");if(voiceMessageCounters){var totalMessages=voiceMessageCounters.attr("totalVoiceMessages"),unreadMessages=voiceMessageCounters.attr("unreadVoiceMessages"),counters={};counters.totalMessages=Number(totalMessages),counters.unreadMessages=Number(unreadMessages),$log.info("[TelephonyServiceEventHandler] onVoiceMessageEvent - Messages total : "+counters.totalMessages+" - Messages Unread : "+counters.unreadMessages),$rootScope.$broadcast("ON_VOICE_MESSAGE_UPDATE_EVENT",counters)}return $q.when()},TelephonyServiceEventHandler.prototype.onUpDateCallEvent=function(updatecallElem){$log.info("[TelephonyServiceEventHandler] onUpDateCallEvent");var that=this;return this.getCall(updatecallElem).then((function(call){var jid=updatecallElem.attr("endpointIm"),phoneNumber=updatecallElem.attr("endpointTel"),firstName="",lastName="",identityFirstName=updatecallElem.find("identity").attr("firstName"),identityLastName=updatecallElem.find("identity").attr("lastName"),identityDisplayName=updatecallElem.find("identity").attr("displayName"),contactUpdateDone=!1;if(!config.permitSearchFromPhoneBook&&!profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_PHONE_BOOK))return $log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent xnames not allowed for the user profile => IGNORED event"),$q.when();if(identityLastName&&identityLastName.length)lastName=identityLastName,identityFirstName&&identityFirstName.length&&(firstName=identityFirstName),$log.info("[TelephonyServiceEventHandler] onUpDateCallEvent received for call "+call.id+" for phoneNumber:"+utilService.anonymizePhoneNumber(phoneNumber)+" with name : "+firstName.slice(0,1)+"***");else{if(!identityDisplayName||!identityDisplayName.length||identityDisplayName===phoneNumber)return $log.info("[TelephonyServiceEventHandler] onUpDateCallEvent xnames not available => IGNORED event"),$q.when();lastName=identityDisplayName,$log.info("[TelephonyServiceEventHandler] onUpDateCallEvent only displayName available")}return contactService.getOrCreateContact(jid,phoneNumber).then((function(contact){if(contact.temp){if(contact.updateName(firstName,lastName),call.contact&&call.contact.id){var currentCalled={contactPhoneNumber:phoneNumber,contact:contact};call.contact.id===contact.id&&call.contact.displayName!==phoneNumber&&call.contact.getNameUpdatePrio()!==Contact.NameUpdatePrio.OUTLOOK_UPDATE_PRIO||(contact.setNameUpdatePrio(Contact.NameUpdatePrio.SERVER_UPDATE_PRIO),call.setContact(contact),call.setCurrentCalled(currentCalled),contactUpdateDone=!0,$log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent xnames updated for "+phoneNumber+" with contact : "+contact.displayNameMD5))}else if(call.participants&&call.participants.length>0){currentCalled=call.getCurrentCalled();for(var i=0;i<call.participants.length;i++)call.participants[i].temp?call.participants[i].phoneProCan&&call.participants[i].phoneProCan===phoneNumber&&($log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent temp participant "+call.participants[i].displayNameMD5+" updated with : "+contact.displayNameMD5),call.participants[i]=contact,call.participants[i].setNameUpdatePrio(Contact.NameUpdatePrio.SERVER_UPDATE_PRIO),currentCalled.participantsPhoneNumbers[i]=phoneNumber,currentCalled.participants[i]=contact,contactUpdateDone=!0):$log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent STRANGE former participant was a rainbow: "+call.participants[i].displayNameMD5);call.setCurrentCalled(currentCalled)}}else if(call.contact&&call.contact.id){currentCalled={contactPhoneNumber:phoneNumber,contact:contact};call.contact.id!==contact.id&&(call.contact.temp&&(call.contact.updateName(firstName,lastName),call.contact.setNameUpdatePrio(Contact.NameUpdatePrio.SERVER_UPDATE_PRIO)),call.setContact(contact),call.setCurrentCalled(currentCalled),contactUpdateDone=!0,$log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent call update with rainbow contact : "+contact.displayNameMD5))}else if(call.participants&&call.participants.length>0){for(currentCalled=call.getCurrentCalled(),i=0;i<call.participants.length;i++)call.participants[i].temp?call.participants[i].phoneProCan&&call.participants[i].phoneProCan===phoneNumber&&($log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent temp participant "+call.participants[i].displayNameMD5+" updated with : "+contact.displayNameMD5),call.participants[i]=contact,call.setParticipants(call.participants),currentCalled.participantsPhoneNumbers[i]=phoneNumber,currentCalled.participants[i]=contact,contactUpdateDone=!0):call.participants[i].jid===jid?(currentCalled.participantsPhoneNumbers[i]=phoneNumber,currentCalled.participants[i]=call.participants[i],contactUpdateDone=!0,$log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent rainbow participant "+call.participants[i].displayNameMD5+" updated with the same : "+contact.displayNameMD5)):$log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent other participant not updated : "+call.participants[i].displayNameMD5+" vs "+contact.displayNameMD5);call.setCurrentCalled(currentCalled)}contactUpdateDone?$interval((function(){that.sendCallUpdateEvent(call,updatecallElem)}),300,1):$log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent, no update needed for call : "+call.id)}))}))},TelephonyServiceEventHandler.prototype.onFailCallEvent=function(failedElem){$log.info("[TelephonyServiceEventHandler] onFailCallEvent");var cause=failedElem.attr("cause"),that=this;return this.getCall(failedElem).then((function(call){call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ERROR),call.errorMessage=TelephonyServiceEventHandler.CallFailureLabels[cause],call.errorMessage||(call.errorMessage=cause),that.sendCallUpdateEvent(call,failedElem)}))},TelephonyServiceEventHandler.prototype.onCallNomadicEvent=function(nomadicElem){if($log.info("[TelephonyServiceEventHandler] onCallNomadicEvent"),!this.telephonyService.started&&!this.telephonyService.starting)return $log.info("[TelephonyServiceEventHandler] onCallNomadicEvent on uninitialized telephony => relaunch telephony initialization"),this.telephonyService.launchTelephonyInitilization(),$q.when();var response={destination:nomadicElem.attr("destination"),featureActivated:nomadicElem.attr("featureActivated"),makeCallInitiatorIsMain:nomadicElem.attr("makeCallInitiatorIsMain"),modeActivated:nomadicElem.attr("modeActivated")};if(this.telephonyService.updateNomadicData(response)){var snapshotSecondary=this.telephonyService.nomadicObject.featureActivated&&this.telephonyService.nomadicObject.modeActivated&&!this.telephonyService.nomadicObject.makeCallInitiatorIsMain;this.telephonyService.getTelephonyState(snapshotSecondary)}return $q.when()},TelephonyServiceEventHandler.prototype.onCallForwardedEvent=function(forwardElem){var forwardType=forwardElem.attr("forwardType"),forwardTo=forwardElem.attr("forwardTo");return $log.info("[TelephonyServiceEventHandler] onCallForwardedEvent forwardType: "+forwardType+" forwardTo: "+forwardTo),$rootScope.$broadcast("ON_CALL_FORWARDED_EVENT",{forwardType:forwardType,forwardTo:forwardTo}),this.telephonyService.forwardObject.forwardType=forwardType,this.telephonyService.forwardObject.forwardTo=forwardTo,$q.when()},TelephonyServiceEventHandler.prototype.onCallSubjectEvent=function(callElem){$log.info("[TelephonyServiceEventHandler] onCallSubjectEvent");var that=this;return this.getCall(callElem).then((function(call){try{call.subject=callElem.find("subject").text(),call.subject&&($log.info("[TelephonyServiceEventHandler] subject display"+call.subject),that.sendCallUpdateEvent(call))}catch(error){var errorMessage="onCallSubjectEvent -- "+error.message;$log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandler.prototype.computeCallRelevancy=function(elem,call){var newCallId=elem.attr("newCallId"),connectionId=newCallId||elem.attr("callId"),deviceType=elem.attr("deviceType"),equipmentId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(connectionId),nomadicInfo=this.telephonyService.getNomadicObject(),makeCallInitiatorIsMain=nomadicInfo.makeCallInitiatorIsMain;deviceType||(deviceType="MAIN"),nomadicInfo.modeActivated||(makeCallInitiatorIsMain=!0),"MAIN"===deviceType&&makeCallInitiatorIsMain&&(call.relevantEquipmentId=equipmentId,call.connectionId=connectionId),"SECONDARY"!==deviceType||makeCallInitiatorIsMain||(call.relevantEquipmentId=equipmentId,call.connectionId=connectionId),call.isSecondary=deviceType&&"SECONDARY"===deviceType&&!makeCallInitiatorIsMain,$log.info("[TelephonyServiceEventHandler] computeCallRelevancy -- relevantEquipmentId: "+call.relevantEquipmentId+" connectionId: "+call.connectionId+" isSecondary: "+call.isSecondary)},TelephonyServiceEventHandler.prototype.getCall=function(elem,doNotUseEqtIdFromElem){var that=this;return $q((function(resolve){var jid=elem.attr("endpointIm"),phoneNumber=elem.attr("endpointTel"),connectionId=elem.attr("callId");that.getOrCreateCall(connectionId,jid,phoneNumber,doNotUseEqtIdFromElem).then((function(call){resolve(call)}))}))},TelephonyServiceEventHandler.prototype.getOrCreateCall=function(connectionId,jid,phoneNumber,doNotUseEqtIdFromElem){var that=this;if(doNotUseEqtIdFromElem){var orgConnectionId=connectionId;connectionId=Object.keys(this.telephonyService.calls||[]).find((function(callConnectionId){return _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getCallIdFromConnectionId(callConnectionId)===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getCallIdFromConnectionId(connectionId)})),$log.debug("[TelephonyServiceEventHandler] getOrCreateCall - HOLD/RETRIEVE search call with callId: "+_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getCallIdFromConnectionId(orgConnectionId)+" from connection id: "+orgConnectionId+" => found connectionId: "+connectionId)}if(!connectionId)return $q.reject("no connection id");var call=this.telephonyService.calls[connectionId];return call?($log.debug("[TelephonyServiceEventHandler] getOrCreateCall - "+connectionId+" - "+utilService.anonymizePhoneNumber(phoneNumber)+" - "+jid+" => found call: "+call),$q.when(call)):($log.debug("[TelephonyServiceEventHandler] getOrCreateCall - "+connectionId+" - "+utilService.anonymizePhoneNumber(phoneNumber)+" - "+jid+" => not found : create call..."),$q((function(resolve){jid||phoneNumber?contactService.getOrCreateContact(jid,phoneNumber).then((function(contact){resolve(that.telephonyService.getOrCreateCall(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN,connectionId,contact))})):resolve(that.telephonyService.getOrCreateCall(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN,connectionId))})))},TelephonyServiceEventHandler.prototype.createConferenceCall=function(connectionId,participants){var conferenceCall=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN,null,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.PHONE);return conferenceCall.setConnectionId(connectionId),conferenceCall.isConference=!0,conferenceCall.setParticipants(participants),this.telephonyService.calls[conferenceCall.id]=conferenceCall,conferenceCall},TelephonyServiceEventHandler.prototype.sendCallUpdateEvent=function(call,elem){var infoEvt=this.extractInfoEvent(elem);$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call,infoEvt)},TelephonyServiceEventHandler.prototype.extractInfoEvent=function(elem){var infoEvent={actionElemName:"",cause:""};if(elem&&null!==elem){var tagNames=elem.prop("tagName").split(":");infoEvent.actionElemName=tagNames[tagNames.length-1].toLowerCase(),infoEvent.cause=elem.attr("cause"),infoEvent.cause=infoEvent.cause?infoEvent.cause:""}else infoEvent=null;return infoEvent},TelephonyServiceEventHandler.prototype.analyzeContactChange=function(jid,phoneNumber,call){var updateContact=!1,searchOutlook=!1;return jid||phoneNumber?call.isConference?void 0:call.contact?(""!==jid?call.contact.id!==jid&&(updateContact=!0,searchOutlook=!1):call.contact.temp?call.contact.id!==phoneNumber?(updateContact=!0,searchOutlook=!0):call.contact.displayName===phoneNumber&&(updateContact=!1,searchOutlook=!0):""!==call.getCurrentCalled().contactPhoneNumber&&""!==phoneNumber&&call.getCurrentCalled().contactPhoneNumber!==phoneNumber&&(updateContact=!0,searchOutlook=!0),updateContact||searchOutlook?{updateContactToBeDone:updateContact,searchOutlookToBeDone:searchOutlook}:null):{updateContactToBeDone:!0,searchOutlookToBeDone:!0}:null},TelephonyServiceEventHandler.prototype.updateCallContact=function(jid,phoneNumber,actionElem,call){var that=this,tagNames=actionElem.prop("tagName").split(":"),actionElemName=tagNames[tagNames.length-1].toLowerCase();try{var updateAnalyse=that.analyzeContactChange(jid,phoneNumber,call);return call.isConference||""===phoneNumber||call.setCurrentCalledContactNumber(phoneNumber),updateAnalyse?contactService.getOrCreateContact(jid,phoneNumber).then((function(contact){return updateAnalyse.searchOutlookToBeDone?that.telephonyService.updateContactFromOutlookInfos(contact,phoneNumber).then((function(updateStatus){updateStatus?($log.debug("[TelephonyServiceEventHandler] on "+actionElemName+", update from outlook for contact :"+contact.displayNameMD5),that.makeUpdateContact(call,contact,phoneNumber,actionElemName)):($log.debug("[TelephonyServiceEventHandler] on "+actionElemName+", no update from outlook for contact :"+contact.displayNameMD5),updateAnalyse.updateContactToBeDone?($log.debug("[TelephonyServiceEventHandler] on "+actionElemName+", update contact :"+contact.displayNameMD5),that.makeUpdateContact(call,contact,phoneNumber,actionElemName)):that.sendCallUpdateEvent(call,actionElem))}),(function(){$log.debug("[TelephonyServiceEventHandler] on "+actionElemName+", no Outlook search available"),updateAnalyse.updateContactToBeDone?($log.debug("[TelephonyServiceEventHandler] on "+actionElemName+", update contact :"+contact.displayNameMD5),that.makeUpdateContact(call,contact,phoneNumber,actionElemName)):that.sendCallUpdateEvent(call,actionElem)})):($log.debug("[TelephonyServiceEventHandler] on "+actionElemName+", update contact :"+contact.displayNameMD5),that.makeUpdateContact(call,contact,phoneNumber,actionElemName),$q.when())})).catch((function(error){if(error){var errorMessage="updateCallContact -- "+error.message;$log.error("[TelephonyServiceEventHandler] "+errorMessage)}return $log.debug("[TelephonyServiceEventHandler] on "+actionElemName+", no Outlook search available"),that.sendCallUpdateEvent(call,actionElem),$q.when()})):(that.sendCallUpdateEvent(call,actionElem),$q.when())}catch(error){var errorMessage="updateCallContact -- "+error.message;return $log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}},TelephonyServiceEventHandler.prototype.makeUpdateContact=function(call,contact,phoneNumber,actionElemName){var that=this;call.setContact(contact);var currentCalled={contactPhoneNumber:phoneNumber,contact:contact};call.setCurrentCalled(currentCalled),"delivered"===actionElemName&&call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING?$interval((function(){that.sendCallUpdateEvent(call)}),300,1):that.sendCallUpdateEvent(call)},TelephonyServiceEventHandler}])},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0});class DirectoryService{constructor($rootScope,$log,$http,$injector,contactService,authService,orderByFilter,conversationService,errorHelperService,profileService,utilService){this.$rootScope=$rootScope,this.$log=$log,this.$http=$http,this.$injector=$injector,this.contactService=contactService,this.authService=authService,this.orderByFilter=orderByFilter,this.conversationService=conversationService,this.errorHelperService=errorHelperService,this.profileService=profileService,this.utilService=utilService,this.started=!1,this.centralizedService=null}start(stats){return __awaiter(this,void 0,void 0,(function*(){this.$log.info("[DirectoryService] === STARTING ===");let startDate=performance.now();try{this.centralizedService=this.$injector.get("centralizedService")}catch(error){}let startDuration=Math.round(performance.now()-startDate);stats.push({service:"directoryService",startDuration:startDuration}),this.started=!0,this.$log.info("[DirectoryService] === STARTED ("+startDuration+" ms) ===")}))}stop(){return __awaiter(this,void 0,void 0,(function*(){this.$log.info("[DirectoryService] Stopping"),this.started=!1,this.$log.info("[DirectoryService] Stopped")}))}search(searchText,addRosters=!1,limit=20,companyId="",excludeCompanyId=null){return __awaiter(this,void 0,void 0,(function*(){this.$log.info("[DirectoryService] searchContact with text "+this.utilService.anonymizeString(searchText));let searchType=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.SEARCH_BY_TAGS)?"search=":"displayName=",serverUrl=config.restServerUrl+"/api/rainbow/search/v1.0/users?limit="+limit+"&"+searchType+encodeURIComponent(searchText);companyId&&(serverUrl+="&companyId="+encodeURIComponent(companyId)),excludeCompanyId&&(serverUrl+="&excludeCompanyId="+encodeURIComponent(excludeCompanyId));try{const contactsData=(yield this.$http({method:"GET",url:serverUrl,headers:this.authService.getRequestHeader()})).data.data;this.$log.info("[DirectoryService] search find "+contactsData.length+" contact(s)");let contacts=[];if(contactsData.forEach(contactData=>{if(this.contactService.isUserContactJid(contactData.jid_im))return;let contact=this.contactService.getContactByJid(contactData.jid_im);contact||((contact=this.contactService.createBasicContact(contactData.jid_im)).updateFromUserData(contactData),contact.getAvatar(),this.contactService.dbContacts[contactData.id]=contact,this.contactService.jtelContacts[contact.jidtel]=contact),contact.tags=contactData.tags,contact.dbId=contactData.id,contact.updateRichStatus(),this.conversationService.computeCapabilitiesForContact(contact,!1),contacts.push(contact)}),addRosters){let rosterContacts=this.contactService.searchContacts(searchText);contacts=contacts.concat(rosterContacts.filter(item=>item.roster&&contacts.indexOf(item)<0))}return contacts=this.orderByFilter(contacts,"_displayName",!1)}catch(error){let e=error;throw error&&error.data&&(e=this.errorHelperService.handleError(error),this.$log.error("[DirectoryService] search - "+e.message),401===error.data.errorCode&&this.$rootScope.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT")),e}}))}searchUserByLogin(loginEmail){return __awaiter(this,void 0,void 0,(function*(){this.$log.info('[DirectoryService] searchUserByLogin with "'+loginEmail+'"');const serverUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/enduser/v1.0/";try{const userArray=(yield this.$http({method:"POST",url:serverUrl+"users/loginEmails",headers:this.authService.getPostHeader(),data:{loginEmail:[loginEmail]}})).data.data;if(1===userArray.length){let contact=yield this.contactService.getOrCreateContact(userArray[0].jid_im);return contact.loginEmail=loginEmail,contact}}catch(error){let e=error;throw error&&error.data&&(e=this.errorHelperService.handleError(error),this.$log.error("[DirectoryService] searchUserByLogin - "+e.message),401===error.data.errorCode&&this.$rootScope.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT")),e}}))}searchUserByJid(jid){return __awaiter(this,void 0,void 0,(function*(){this.$log.info('[DirectoryService] searchUserByJid with "'+jid+'"');const serverUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/enduser/v1.0/users/jids/";try{const user=(yield this.$http({method:"GET",url:serverUrl+encodeURIComponent(jid),headers:this.authService.getRequestHeader()})).data;if(user){let contact=yield this.contactService.getOrCreateContact(jid);return contact.updateFromUserData(user.data),contact}}catch(error){let e=error;throw error&&error.data&&(e=this.errorHelperService.handleError(error),this.$log.error("[DirectoryService] searchUserByJid - "+e.message),401===error.data.errorCode&&this.$rootScope.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT")),e}}))}searchAllContacts(searchText,limit=20,companyId="",addRosters=!0,addOutlook=!0){return __awaiter(this,void 0,void 0,(function*(){this.$log.info("[DirectoryService] searchAllContacts with text "+searchText);try{let contacts=[];addRosters&&(contacts=this.contactService.searchContacts(searchText));const rainbowContacts=yield this.search(searchText,!1,limit,companyId);if(contacts=contacts.concat(rainbowContacts.filter(item=>!item.roster||contacts.indexOf(item)<0)),addOutlook&&this.centralizedService){const[outlookContactsByEmail,outlookContactsByName]=yield Promise.all([this.searchOutlookUsersByEmail(searchText),this.searchOutlookUsersByName(searchText)]),outlookResults=this.centralizedService.outlook.mergeOutlookContact(outlookContactsByEmail,outlookContactsByName);contacts=contacts.concat(outlookResults)}return contacts}catch(error){throw this.$log.error("[DirectoryService] searchAllContacts - Unable to search all contacts"),error}}))}searchOutlookUsersByName(searchPattern){return __awaiter(this,void 0,void 0,(function*(){if(this.centralizedService)try{return yield this.centralizedService.outlook.searchByNameWithAvatar(searchPattern,2)}catch(_a){return this.$log.warn("[DirectoryService] searchOutlookUsersByName - Outlook service unavailable"),[]}}))}searchOutlookUsersByEmail(searchPattern){return __awaiter(this,void 0,void 0,(function*(){if(this.centralizedService&&this.centralizedService.outlook)try{return yield this.centralizedService.outlook.searchByEmailWithAvatar(searchPattern,2)}catch(_a){return this.$log.warn("[DirectoryService] searchOutlookUsersByEmail - Outlook service unavailable"),[]}}))}}exports.DirectoryService=DirectoryService,DirectoryService.$inject=["$rootScope","$log","$http","$injector","contactService","authService","orderByFilter","conversationService","errorHelperService","profileService","utilService"],angular.module("rainbow").service("directoryService",DirectoryService)},function(module,exports){angular.module("rainbow").service("invitationService",["$q","$log","$http","$rootScope","authService","Invitation","contactService","xmppService","errorHelperService","settingsService",function($q,$log,$http,$rootScope,authService,Invitation,contactService,xmppService,errorHelperService,settingsService){"use strict";var service=this;service.start=function(stats){$log.info(""),$log.info("[invitationService] === STARTING ===");var startDate=performance.now();service.receivedInvitations={},service.sentInvitations={},service.acceptedInvitationsArray=[],service.sentInvitationsArray=[],service.receivedInvitationsArray=[],service.listeners=[],service.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/",service.attachHandlers(),service.getAllSentInvitations(),service.getAllReceivedInvitations();var startDuration=Math.round(performance.now()-startDate);return stats.push({service:"invitationService",startDuration:startDuration}),$log.info("[invitationService] === STARTED ("+startDuration+" ms) ==="),service.listeners.push($rootScope.$on("ON_ROSTER_CHANGED_EVENT",service.getAllSentInvitations)),$q.when()},service.stop=function(){var listener;if($log.info(""),$log.info("[invitationService] === STOPPING ==="),service.listeners)for(;listener=service.listeners.pop();)listener();return $log.info("[invitationService] === STOPPED ==="),$q.when()},service.attachHandlers=function(){$log.info("[invitationService] attachHandlers"),service.contactConfigRef&&(xmppService.connection.deleteHandler(service.contactConfigRef),service.contactConfigRef=null),service.contactConfigRef=xmppService.connection.addHandler(service.onInvitationsUpdate,null,"message","management")},service.onInvitationsUpdate=function(stanza){var userInviteElem=$(stanza).find("userinvite");if(userInviteElem.length){var id=userInviteElem.attr("id"),type=userInviteElem.attr("type"),action=userInviteElem.attr("action");switch(type){case"received":service.handleReceivedInvitation(id,action);break;case"sent":service.handleSentInvitation(id,action);break;default:$log.warn("[invitationService] onInvitationsUpdate - received unexpected type - "+type)}}return!0},service.handleReceivedInvitation=function(id,action){$log.info("[invitationService] handleReceivedInvitation"),"delete"===action?(delete service.receivedInvitations[id],service.updateReceivedInvitationsArray()):service.getServerInvitation(id).then((function(invitation){var updateInvitation=null,status="none";switch(invitation.status){case"pending":service.receivedInvitations[invitation.id]=invitation,updateInvitation=invitation,status="ask";break;case"accepted":case"auto-accepted":service.receivedInvitations[invitation.id]=invitation,$rootScope.$broadcast("ON_INVITATION_ACCEPTED",invitation.invitingUserId),invitation.invitingUserId&&contactService.getContactByDBId(invitation.invitingUserId,!0).then((function(contact){$rootScope.$broadcast("ON_CONTACT_UPDATED_EVENT",contact)}));break;default:delete service.receivedInvitations[invitation.id],status="unknown"}invitation.invitingUserId?service.updateContactInvitationStatus(invitation.invitingUserId,status,updateInvitation).then((function(){service.updateReceivedInvitationsArray()})):service.updateReceivedInvitationsArray(),$rootScope.$broadcast("ON_INVITATION_CHANGED",invitation)}))},service.handleSentInvitation=function(id,action){return $q((function(resolve){$log.info("[invitationService] handleSentInvitation"),"delete"===action?(delete service.sentInvitations[id],service.updateReceivedInvitationsArray(),resolve()):(service.getServerInvitation(id).then((function(invitation){var contactStatus=null;switch(invitation.status){case"pending":service.sentInvitations[invitation.id]=invitation,contactStatus="wait";break;case"accepted":case"auto-accepted":$rootScope.$broadcast("ON_INVITATION_ACCEPTED",invitation.invitedUserId),invitation.invitedUserId&&contactService.getContactByDBId(invitation.invitedUserId,!0).then((function(contact){$rootScope.$broadcast("ON_CONTACT_UPDATED_EVENT",contact)}));break;default:delete service.sentInvitations[invitation.id],contactStatus="unknown"}invitation.invitedUserId?service.updateContactInvitationStatus(invitation.invitedUserId,contactStatus,invitation).then((function(){service.updateSentInvitationsArray(),resolve()})):(service.updateSentInvitationsArray(),resolve())})),"resend"===action&&$rootScope.$broadcast("ON_INVITATIONS_RE_SEND",id))}))},service.updateReceivedInvitationsArray=function(){for(var key in service.receivedInvitationsArray=[],service.acceptedInvitationsArray=[],service.receivedInvitations)if(service.receivedInvitations.hasOwnProperty(key)){var invitation=service.receivedInvitations[key];switch(invitation.status){case"pending":service.receivedInvitationsArray.push(invitation);break;case"accepted":case"auto-accepted":service.acceptedInvitationsArray.push(invitation)}}service.receivedInvitationsArray.sort(service.sortInvitationArray),service.acceptedInvitationsArray=service.acceptedInvitationsArray.filter((function(acceptedInvitation){var lastInvite=moment(acceptedInvitation.lastNotificationDate);return moment.duration(moment().diff(lastInvite)).asHours()<168})),service.acceptedInvitationsArray.sort(service.sortInvitationArray),$rootScope.$broadcast("ON_INVITATIONS_NUMBER_UPDATED")},service.updateSentInvitationsArray=function(){for(var key in service.sentInvitationsArray=[],service.sentInvitations)service.sentInvitations.hasOwnProperty(key)&&service.sentInvitationsArray.push(service.sentInvitations[key]);service.sentInvitationsArray.sort(service.sortInvitationArray),$rootScope.$broadcast("ON_INVITATIONS_NUMBER_UPDATED")},service.getServerInvitation=function(invitationId){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+contactService.userContact.dbId+"/invitations/"+invitationId,headers:authService.getRequestHeader()}).then((function(response){$log.info("[invitationService] getServerInvitation success");var receivedInvitation=Invitation.createFromData(response.data.data);resolve(receivedInvitation)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[invitationService] "+errorHelperService.getErrorFullMessage(response,"getServerInvitation"))}))}))},service.getReceivedInvitations=function(){return service.receivedInvitationsArray},service.getAcceptedInvitations=function(){return service.acceptedInvitationsArray},service.getSentInvitations=function(){return service.sentInvitationsArray},service.getInvitationsNumberForCounter=function(){return service.receivedInvitationsArray.length},service.getAllInvitationsNumber=function(){return service.receivedInvitationsArray.length+service.sentInvitationsArray.length+service.acceptedInvitationsArray.length},service.getInvitation=function(invitationId){var invitationFound=service.receivedInvitations[invitationId];return invitationFound||(invitationFound=service.acceptedInvitationsArray[invitationId]),invitationFound||(invitationFound=service.sentInvitations[invitationId]),invitationFound},service.joinContactInvitation=function(contact,customMessage){return $q((function(resolve,reject){$log.info("[invitationService] joinContactInvitation contact ("+contact.jid+")"),customMessage=customMessage||"",$http({method:"POST",url:service.portalURL+contactService.userContact.dbId+"/invitations",headers:authService.getRequestHeader(),data:{invitedUserId:contact.dbId,customMessage:customMessage}}).then((function(){$log.info("[invitationService] joinContactInvitation - success ("+contact.jid+")"),"unknown"===contact.status&&service.updateContactInvitationStatus(contact.dbId,"wait"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[invitationService] "+errorHelperService.getErrorFullMessage(response,"joinContactInvitation"))}))}))},service.sendInvitationByEmail=function(email,customMessage){return $q((function(resolve,reject){var lang=settingsService.getAppliLanguageCodeForServer();$log.info("[invitationService] sendInvitationByEmail"),$http({method:"POST",url:service.portalURL+contactService.userContact.dbId+"/invitations",headers:authService.getRequestHeader(),data:{email:email,lang:lang,customMessage:customMessage}}).then((function(){$log.info("[invitationService] sendInvitationByEmail - success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[invitationService] "+errorHelperService.getErrorFullMessage(response,"sendInvitationByEmail"))}))}))},service.cancelOneSendInvitation=function(invitation){return $q((function(resolve,reject){$http({method:"POST",url:service.portalURL+invitation.invitingUserId+"/invitations/"+invitation.id+"/cancel",headers:authService.getRequestHeader()}).then((function(){$log.info("[invitationService] cancelOneSendInvitation success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[invitationService] "+errorHelperService.getErrorFullMessage(response,"cancelOneSendInvitation"))}))}))},service.reSendInvitation=function(invitationId){return $q((function(resolve,reject){$http({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+contactService.userContact.dbId+"/invitations/"+invitationId+"/re-send",headers:authService.getRequestHeader()}).then((function(){$log.info("[invitationService] reSendInvitation "+invitationId+" - success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[invitationService] "+errorHelperService.getErrorFullMessage(response,"reSendInvitation"))}))}))},service.sendInvitationsParBulk=function(listOfMails){return!listOfMails.length||listOfMails.length>100?($log.error("[invitationService] sendInvitationsParBulk mail list length not correct"),$q.reject()):$q((function(resolve,reject){$http({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+contactService.userContact.dbId+"/invitations/bulk",headers:authService.getRequestHeader(),data:{emails:listOfMails}}).then((function(){$log.info("[invitationService] sendInvitationsParBulk - success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[invitationService] "+errorHelperService.getErrorFullMessage(response,"sendInvitationsParBulk"))}))}))},service.acceptInvitation=function(invitation){return $q((function(resolve,reject){$http({method:"POST",url:service.portalURL+invitation.invitedUserId+"/invitations/"+invitation.id+"/accept",headers:authService.getRequestHeader()}).then((function(){$log.info("[invitationService] acceptInvitation success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);error.errorDetailsCode&&409605===error.errorDetailsCode?contactService.getContactByDBId(invitation.invitingUserId,!0).then((function(contact){$rootScope.$broadcast("ON_CONTACT_UPDATED_EVENT",contact)})):(reject(error),$log.error("[invitationService] "+errorHelperService.getErrorFullMessage(response,"acceptInvitation")))}))}))},service.declineInvitation=function(invitation){return $q((function(resolve,reject){$http({method:"POST",url:service.portalURL+invitation.invitedUserId+"/invitations/"+invitation.id+"/decline",headers:authService.getRequestHeader()}).then((function(){$log.info("[invitationService] declineInvitation success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[invitationService] "+errorHelperService.getErrorFullMessage(response,"declineInvitation"))}))}))},service.updateContactInvitationStatus=function(contactDBId,status,invitation){return $q((function(resolve){contactService.getContactByDBId(contactDBId).then((function(contact){switch(status){case"ask":contact.status="unknown",contact.ask="ask",contact.invitation=invitation;break;case"wait":contact.status="wait",contact.ask="subscribe",contact.invitation=invitation;break;default:contact.ask="none",contact.invitation=null}contact.updateRichStatus(),resolve()}))}))},service.sortInvitationArray=function(invitA,invitB){return new Date(invitB.lastNotificationDate)-new Date(invitA.lastNotificationDate)},service.getAllReceivedInvitations=function(){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+contactService.userContact.dbId+"/invitations/received?format=full&status=pending&status=accepted&status=auto-accepted&limit=500",headers:authService.getRequestHeader()}).then((function(response){var invitationsData=response.data.data;$log.info("[invitationService] getAllReceivedInvitations success (find "+invitationsData.length+" invitations)"),service.receivedInvitations={},service.acceptedInvitations={},invitationsData.forEach((function(invitationData){if("pending"===invitationData.status&&"registration"!==invitationData.type){var invitation=Invitation.createFromData(invitationData);service.receivedInvitations[invitationData.id]=invitation,invitationData.invitingUserId&&service.updateContactInvitationStatus(invitationData.invitingUserId,"ask",invitation)}else"accepted"!==invitationData.status&&"auto-accepted"!==invitationData.status||(service.receivedInvitations[invitationData.id]=Invitation.createFromData(invitationData))})),service.updateReceivedInvitationsArray(),resolve(service.receivedInvitations)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[invitationService] "+errorHelperService.getErrorFullMessage(response,"getAllReceivedInvitations"))}))}))},service.getAllSentInvitations=function(){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+contactService.userContact.dbId+"/invitations/sent?format=full&status=pending&limit=500",headers:authService.getRequestHeader()}).then((function(response){var invitationsData=response.data.data;$log.info("[invitationService] getAllSentInvitations success (find "+invitationsData.length+" invitations)"),service.sentInvitations={},invitationsData.forEach((function(invitationData){if("pending"===invitationData.status&&!invitationData.inviteToJoinMeeting){var sentInvitation=Invitation.createFromData(invitationData);service.sentInvitations[invitationData.id]=sentInvitation,void 0!==sentInvitation.invitedUserId&&service.updateContactInvitationStatus(sentInvitation.invitedUserId,"wait",sentInvitation)}})),service.updateSentInvitationsArray(),resolve(service.sentInvitations)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[invitationService] "+errorHelperService.getErrorFullMessage(response,"getAllSentInvitations"))}))}))}}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var crypto_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3);angular.module("rainbow").service("roomService",["$q","$log","$rootScope","$http","$filter","$interval","authService","contactService","fileStorageService","xmppService","Room","utilService","profileService","errorHelperService","helpersService","orderByFilter","$translate","settingsService",function($q,$log,$rootScope,$http,$filter,$interval,authService,contactService,fileStorageService,xmppService,Room,utilService,profileService,errorHelperService,helpersService,orderByFilter,$translate,settingsService){var service=this;service.ROOM_UPDATE_EVENT="ROOM_UPDATE_EVENT",service.ROOM_AVATAR_UPDATE_EVENT="ROOM_AVATAR_UPDATE_EVENT",service.ROOM_HISTORY_UPDATE_EVENT="ROOM_HISTORY_UPDATE_EVENT",service.ROOM_ADMIN_MESSAGE_EVENT="ROOM_ADMIN_MESSAGE_EVENT",service.ROOM_INVITATION="ROOM_INVITATION",service.ROOM_ADD_CONF_ENDPOINT_EVENT="ROOM_ADD_CONF_ENDPOINT_EVENT",service.ROOM_REMOVE_CONF_ENDPOINT_EVENT="ROOM_REMOVE_CONF_ENDPOINT_EVENT",service.ROOM_ADD_USERS_EVENT="ROOM_ADD_USERS_EVENT",service.ROOM_DELETE_USERS_EVENT="ROOM_DELETE_USERS_EVENT",service.RoomUserStatus={INVITED:"invited",ACCEPTED:"accepted",UNSUBSCRIBED:"unsubscribed",REJECTED:"rejected",DELETED:"deleted"},service.listeners=[],service.start=function(stats){return $q((function(resolve){var startDate=performance.now();$log.info(""),$log.info("[roomService] === STARTING ==="),service.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/",service.invitationCounter=0,service.meetingInvitationCounter=0,service.rooms={},service.roomsByJids={},service.roomsInProgress={},service.contactsInProgress={},service.updateLater={},service.maxRoomsUsers=profileService.getFeatureLimitMax(profileService.FeaturesEnum.BUBBLE_PARTICIPANT_COUNT),service.personalAudioRoomId="",service.currentPersonalAudioRoomId="",service.openInviteIdByRoomId={},service.attachHandlers(),service.getServerRooms().then((function(){service.computeInvitationCounter(),service.retrieveOpenInviteData(),profileService.isFeatureEnabled(profileService.FeaturesEnum.CONFERENCE_ALLOWED)&&(service.retrievePersonalAudioRoom(),service.retrieveCurrentPersonalAudioRoom());var startDuration=Math.round(performance.now()-startDate);stats.push({service:"roomService",startDuration:startDuration}),$log.info("[roomService] === STARTED ("+startDuration+" ms) ==="),resolve()})).catch((function(error){$log.error("[roomService] === STARTING FAILURE === "+error.message),service.computeInvitationCounter(),service.reconnect(),resolve()}))}))},service.stop=function(){return $log.info(""),$log.info("[roomService] === STOPPING ==="),service.listeners.forEach((function(listener){listener()})),service.rooms={},service.roomsByJids={},$log.info("[roomService] === STOPPED ==="),$q.when()},service.attachHandlers=function(){$log.info("[roomService] attachHandlers"),this.roomPresenceRef&&(xmppService.connection.deleteHandler(this.roomPresenceRef),this.roomPresenceRef=null),this.roomPresenceRef=xmppService.connection.addHandler(service.onRoomPresence,"http://jabber.org/protocol/muc#user","presence"),this.roomMessageRef&&(xmppService.connection.deleteHandler(this.roomMessageRef),this.roomMessageRef=null),this.roomMessageRef=xmppService.connection.addHandler(service.onRoomMessage,"jabber:x:conference","message"),this.roomInfoMessageRef&&(xmppService.connection.deleteHandler(this.roomInfoMessageRef),this.roomInfoMessageRef=null),this.roomInfoMessageRef=xmppService.connection.addHandler(service.onRoomInfoMessage,null,"message","groupchat"),this.roomMessageConfigRef&&(xmppService.connection.deleteHandler(this.roomMessageConfigRef),this.roomMessageConfigRef=null),this.roomMessageConfigRef=xmppService.connection.addHandler(service.onRoomMessageConfig,null,"message","management"),this.roomHistoryInfoRef&&(xmppService.connection.deleteHandler(this.roomHistoryInfoRef),this.roomHistoryInfoRef=null),this.roomHistoryInfoRef=xmppService.connection.addHandler(service.onRoomHistoryInfoMessage,"jabber:iq:notification","message"),this.roomNotificationRef&&(xmppService.connection.deleteHandler(this.roomNotificationRef),this.roomNotificationRef=null),this.roomNotificationRef=xmppService.connection.addHandler(service.onRoomNotificationMessage,"jabber:x:bubble:conference","message"),service.listeners.forEach((function(listener){listener()})),service.listeners.push($rootScope.$on("ON_CONNECTION_STATE_CHANGE_EVENT",service.onConnectionStateChange))},service.reconnect=function(){$log.info("[roomService] reconnect"),service.attachHandlers(),service.getServerRooms().then((function(){service.computeInvitationCounter(),service.retrieveOpenInviteData(),$log.info("[roomService] reconnect success")})).catch((function(error){$log.error("[roomService] reconnect failure -- "+error.message)}))},service.onConnectionStateChange=function(__event,status){$log.info("[roomService] onConnectionStateChange status:"+status),"disconnected"===status&&service.rooms&&Object.keys(service.rooms).forEach((function(key){var room=service.rooms[key];room&&(room.initPresInterval&&($log.info("[roomService] onConnectionStateChange cancel initPresence retryer for room: "+room.jid+" "+room.getNameForLogs()),$interval.cancel(room.initPresInterval),room.initPresInterval=null),room.initPresPromise&&($log.info("[roomService] onConnectionStateChange remove initPresPromise for room: "+room.jid+" "+room.getNameForLogs()),room.initPresPromise=null))}))},service.getRooms=function(){var roomArray=[];return Object.keys(service.rooms).forEach((function(key){roomArray.push(service.rooms[key])})),roomArray},service.searchRooms=function(criteria){var queries=criteria.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").split(/[ ]+/);return service.getRooms().filter((function(room){if("accepted"!==room.status)return!1;room.filterName=room.name.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"");var names=room.filterName.split(/[ -]+/);return queries.every((function(query){return names.some((function(name,index){return!(!name.length||-1===name.indexOf(query))&&(names[index]="",!0)}))}))}))},service.getMyRooms=function(){return service.getRooms().filter((function(room){return room.owner}))},service.getRoomById=function(roomId){return service.rooms[roomId]},service.getRoomByJid=function(jid){return service.roomsByJids[jid]},service.computeInvitationCounter=function(){service.invitationCounter=0,service.meetingInvitationCounter=0,Object.keys(service.rooms).forEach((function(key){var room=service.rooms[key];"invited"===room.status&&(room.isMeetingRoom()?service.meetingInvitationCounter+=1:service.invitationCounter+=1)}))},service.getOrderedRooms=function(order){return"lastActivityDate"===order?orderByFilter(service.getRooms(),service.getLastActivityDate,!0,service.sortByDate):"creationDate"===order?orderByFilter(service.getRooms(),service.getCreationDate,!0,service.sortByDate):orderByFilter(service.getRooms(),service.getName,!1,service.sortByName)},service.getMyOrderedRooms=function(order){return"lastActivityDate"===order?orderByFilter(service.getMyRooms(),service.getLastActivityDate,!0,service.sortByDate):"creationDate"===order?orderByFilter(service.getMyRooms(),service.getCreationDate,!0,service.sortByDate):orderByFilter(service.getMyRooms(),service.getName,!1,service.sortByName)},service.updateRoomFromServer=function(room){$log.info("updateRoomFromServer(".concat(room.dbId,")"));var defer=$q.defer();return $http({method:"GET",url:service.portalURL+"rooms/"+room.dbId+"?format=full",headers:authService.getRequestHeader()}).then((function(response){var roomData=response.data.data;return service.getAllRoomsParticipants([roomData])})).then((function(){service.updateRoomData(room,roomData),defer.resolve()})).catch((function(error){$log.error("updateRoomFromServer -- FAILURE -- ".concat(error.message)),defer.reject(error)})),defer.promise},service.updateRoomData=function(room,newRoomData){if(room.name=newRoomData.name,room.desc=newRoomData.topic,room.users=[],newRoomData.users.forEach((function(userData){var contact=contactService.getContactById(userData.userId);contact&&(room.users.push({contact:contact,status:userData.status,date:new Date(userData.additionDate),privilege:userData.privilege}),contactService.isUserContact(contact)&&(room.status=userData.status))})),service.refreshMemberAndOrganizerLists(room),room.isModerator=room.status!==service.RoomUserStatus.UNSUBSCRIBED&&room.isUserModerator(contactService.userContact),newRoomData.lastAvatarUpdateDate&&newRoomData.lastAvatarUpdateDate!==room.lastAvatarUpdate){room.lastAvatarUpdate=newRoomData.lastAvatarUpdateDate;var avatarServerUrl=$rootScope.cdn?$rootScope.cdnServer:config.restServerUrl,updateToken=Object(crypto_js__WEBPACK_IMPORTED_MODULE_0__.MD5)(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Latin1.parse(room.lastAvatarUpdate)).toString(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Hex);room.avatar="".concat(avatarServerUrl,"/api/room-avatar/").concat(room.dbId,"?size=512&update=").concat(updateToken)}room.updateAvatarInfo(),room.guestEmails=newRoomData.guestEmails,room.confEndpoints=newRoomData.confEndpoints},service.getServerRoom=function(roomId){return $q((function(resolve,reject){$log.info("[roomService] getServerRoom("+roomId+")"),$http({method:"GET",url:service.portalURL+"rooms/"+roomId+"?format=full",headers:authService.getRequestHeader()}).then((function(response){var roomData=response.data.data;return $log.info("[roomService] getServerRoom("+roomId+") successfully"),service.getAllRoomsParticipants([roomData])})).then((function(roomsData){var room=service.createRoomFromData(roomsData[0]);resolve(room)}),(function(response){var msg=response.data?response.data.errorDetails:response.data,errorMessage="getServerRoom("+roomId+") failure: "+msg;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.getServerRoomByJid=function(roomJid){return $q((function(resolve,reject){$log.info("[roomService] getServerRoomByJid("+roomJid+")"),$http({method:"GET",url:service.portalURL+"rooms/jids/"+roomJid+"?format=full",headers:authService.getRequestHeader()}).then((function(response){var roomData=response.data.data;return $log.info("[roomService] getServerRoomByJid("+roomJid+") successfully"),service.getAllRoomsParticipants([roomData])})).then((function(roomsData){var room=service.createRoomFromData(roomsData[0]);resolve(room)}),(function(response){var msg=response.data?response.data.errorDetails:response.data,errorMessage="getServerRoomByJid("+roomJid+") failure: "+msg;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.getServerRooms=function(){var getAllRooms=function getAllRooms(page,limit,rooms){return $q((function(resolve,reject){(function(page,max,rooms){return $q((function(resolve,reject){$http({method:"GET",headers:authService.getRequestHeader(),url:service.portalURL+"rooms?format=full&userId="+contactService.userContact.dbId+"&status=invited&status=accepted&status=unsubscribed&offset="+page+"&limit="+max}).then((function(response){rooms=rooms.concat(response.data.data),$log.info("[roomService] getServerRooms retrieved "+response.data.data.length+" rooms, total "+rooms.length+", existing "+response.data.total),resolve({rooms:rooms,finished:rooms.length===response.data.total})})).catch((function(err){reject(err)}))}))})(page,limit,rooms).then((function(response){response.finished?($log.info("[roomService] getServerRooms no need to loop again. All rooms retrieved..."),resolve(response.rooms)):(page+=limit,$log.info("[roomService] getServerRooms need another loop to get more rooms... ["+response.rooms.length+"]"),getAllRooms(page,limit,response.rooms).then((function(_rooms){resolve(_rooms)})).catch((function(err){reject(err)})))})).catch((function(err){reject(err)}))}))};return $q((function(resolve,reject){getAllRooms(0,1e3,[]).then((function(response){var roomsData=response;return $log.info("[roomService] getServerRooms successfully: find "+roomsData.length+" room(s)"),service.getAllRoomsParticipants(roomsData)})).then((function(roomsData){roomsData.forEach((function(roomData){service.createRoomFromData(roomData)})),resolve()})).catch((function(response){var errorMessage="getServerRooms failure: "+(response.data?response.data.errorDetails:response.message);$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.getAllRoomsParticipants=function(roomsData){var defered=$q.defer(),getAllUsers=function getAllUsers(roomData,page,limit,users){return $q((function(resolve,reject){(function(roomData,page,max,users){return $q((function(resolve,reject){$http({method:"GET",headers:authService.getRequestHeader(),url:service.portalURL+"rooms/"+roomData.id+"/users?format=full&offset="+page+"&limit="+max}).then((function(response){users=users.concat(response.data.data),$log.info("[roomService] getAllRoomsParticipants retrieved "+response.data.data.length+" users, total "+users.length+", existing "+response.data.total),resolve({users:users,finished:users.length===response.data.total})})).catch((function(err){reject(err)}))}))})(roomData,page,limit,users).then((function(response){response.finished?($log.info("[roomService] getAllRoomsParticipants no need to loop again. All users retrieved..."),resolve(response.users)):(page+=limit,$log.info("[roomService] getAllRoomsParticipants need another loop to get more users... ["+response.users.length+"]"),getAllUsers(roomData,page,limit,response.users).then((function(_users){resolve(_users)})).catch((function(err){reject(err)})))})).catch((function(err){reject(err)}))}))},startDate=performance.now(),participantsJids={},roomDataPromises=[];return roomsData.forEach((function(roomData){var myProm=$q.defer();if(roomDataPromises.push(myProm.promise),roomData.activeUsersCounter&&roomData.users.length<roomData.activeUsersCounter){getAllUsers(roomData,0,100,[]).then((function(usr){roomData.users=usr,roomData.users.forEach((function(userData){var contact=contactService.getContactByJid(userData.jid_im);participantsJids[userData.jid_im]||contact&&!contact.temp||(participantsJids[userData.jid_im]=userData.jid_im)})),myProm.resolve(roomData)})).catch((function(err){myProm.reject(err)}))}else roomData.users.forEach((function(userData){var contact=contactService.getContactByJid(userData.jid_im);participantsJids[userData.jid_im]||contact&&!contact.temp||(participantsJids[userData.jid_im]=userData.jid_im)})),myProm.resolve(roomData)})),$q.all(roomDataPromises).then((function(){var participantsJidsArray=Object.keys(participantsJids);return participantsJidsArray.length?contactService.getContactsByJids(participantsJidsArray).then((function(){var endDate=performance.now();$log.info("[roomService] getAllRoomsParticipants - get "+participantsJidsArray.length+" participants in "+Math.round(endDate-startDate)+" milliseconds."),defered.resolve(roomsData)})):($log.info("[roomService] getAllRoomsParticipants - nothing to get, all known."),void defered.resolve(roomsData))})).catch((function(error){var errorMessage="getAllRoomsParticipants failure: "+error.message;$log.error("[roomService] "+errorMessage),defered.reject(error)})),defered.promise},service.createRoomFromData=function(roomData){var room=Room.create(roomData.id,roomData.jid,roomData.name,roomData.topic,roomData.creationDate,roomData.confEndpoints,roomData.history,roomData.customData,roomData.conference,roomData.avatar,roomData.isActive,roomData.lastActivityDate,roomData.autoRegister),owner=contactService.dbContacts[roomData.creator];if(!owner)return $log.error("[roomService] createRoomFromData -- failure -- Impossible to find owner of room "+roomData.name+" --- ignored"),room;room.ownerContact=owner,room.owner=owner.jid===contactService.userContact.jid,roomData.users.forEach((function(userData){var contact=contactService.getContactById(userData.userId);contact&&(room.users.push({contact:contact,status:userData.status,date:new Date(userData.additionDate),privilege:userData.privilege}),contactService.isUserContact(contact)&&(room.status=userData.status))})),room.guestEmails=roomData.guestEmails,service.refreshMemberAndOrganizerLists(room);var ownUser=room.getUserByJid(contactService.userContact.jid);if(room.isModerator=ownUser&&ownUser.status!==service.RoomUserStatus.UNSUBSCRIBED&&room.isUserModerator(contactService.userContact),service.rooms[room.dbId]&&service.rooms[room.dbId].initPresPromise&&(room.initPresPromise=service.rooms[room.dbId].initPresPromise,room.initPresInterval=service.rooms[room.dbId].initPresInterval),room.updateAvatarInfo(),roomData.lastAvatarUpdateDate){var url=config.restServerUrl;$rootScope.cdn&&(url=$rootScope.cdnServer),room.avatar=url+"/api/room-avatar/"+roomData.id+"?size=512&update="+Object(crypto_js__WEBPACK_IMPORTED_MODULE_0__.MD5)(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Latin1.parse(roomData.lastAvatarUpdateDate)).toString(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Hex)}return service.rooms[room.dbId]=room,service.roomsByJids[room.jid]=room,$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room),"accepted"===room.status&&room.isActive&&service.sendInitialRoomPresenceSync(room),room},service.refreshMemberAndOrganizerLists=function(room){room.organizers=[],room.members=[],room.users.forEach((function(user){user.status!==service.RoomUserStatus.ACCEPTED&&user.status!==service.RoomUserStatus.INVITED&&user.contact.jid!==room.ownerContact.jid||(user.privilege===Room.Privilege.MODERATOR?room.organizers.push(user):room.members.push(user))}))},service.equalContactsArrayByDbId=function(contactsA,contactsB){if(contactsA===contactsB)return!0;if(null===contactsA||null===contactsB)return!1;if(contactsA.length!==contactsB.length)return!1;for(var i=0;i<contactsA.length;++i)if(contactsA[i].dbId!==contactsB[i].dbId)return!1;return!0},service.getOrCreateRoomWithContacts=function(newContacts,newEmails){return $q((function(resolve){var foundRoom=null,participants=[].concat([contactService.userContact],newContacts).sort(service.sortObjectByProperty("dbId"));if(service.getMyRooms().some((function(room){return!(!room||room.status!==service.RoomUserStatus.ACCEPTED||!service.equalContactsArrayByDbId(room.users.map((function(user){return user.contact})).sort(service.sortObjectByProperty("dbId")),participants))&&(foundRoom=room,$log.debug("[roomService] getOrCreateRoomWithContacts - Found Room "+room.getNameForLogs()),!0)})),foundRoom)newEmails.length?service.addRoomUsers(foundRoom,null,newEmails).then((function(){resolve(foundRoom)})):resolve(foundRoom);else{for(var roomNameRoot=contactService.userContact.initials+" "+$filter("translate")("bubble")+" ",escalatedRooms=service.getMyRooms().filter((function(room){return room&&0===room.name.indexOf(roomNameRoot)})),compareRoom=function(room){return room&&room.name===tempRoomName},roomName=null,index=1;!roomName;){var tempRoomName=roomNameRoot+index.toString();escalatedRooms.sort(service.sortObjectByProperty("name")).some(compareRoom)||(roomName=tempRoomName),index++}service.createRoomWithContacts(roomName,"",newContacts,newEmails).then((function(room){resolve(room)}))}}))},service.createRoomWithContacts=function(roomName,topic,contacts,emails){return $q((function(resolve,reject){service.createRoom(roomName,topic,!0,null,!0,null,!0).then((function(room){return service.addRoomUsers(room,contacts,emails)})).then((function(room){resolve(room)})).catch((function(error){var errorMessage="createRoomWithContacts failure: "+error.message;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.setAvatarRoom=function(roomData,roomAvatar){var defered=$q.defer();return roomAvatar?(service.resizeImage(roomAvatar,512,512).then((function(resizedImage){var binaryData=service.getBinaryData(resizedImage);$http({method:"POST",url:service.portalURL+"rooms/"+roomData.id+"/avatar",headers:authService.getPostHeader("image/"+binaryData.type),data:binaryData.data,transformRequest:[]}).then((function(result){$log.info("[roomService] setAvatarRoom success: "+result.data.status);var url=config.restServerUrl;$rootScope.cdn&&(url=$rootScope.cdnServer),roomData.avatar=url+"/api/room-avatar/"+roomData.id+"?size=512&rand="+helpersService.randomString(),defered.resolve(roomData)}),(function(response){var error=errorHelperService.handleError(response);$log.error("[roomService] "+errorHelperService.getErrorFullMessage(response,"setAvatarRoom")),defered.reject(error)}))})),defered.promise):(defered.resolve(roomData),defered.promise)},service.deleteAvatarRoom=function(roomId){return $q((function(resolve,reject){$http({method:"DELETE",url:service.portalURL+"rooms/"+roomId+"/avatar",headers:authService.getRequestHeader()}).then((function(){$log.info("[roomService] avatar room sucessfully deleted"),resolve()})).catch((function(err){reject(err)}))}))},service.resizeImage=function(avatarImg,maxWidth,maxHeight){var defered=$q.defer(),image=new Image;return image.src=avatarImg,image.onload=function(){var imageWidth=image.width,imageHeight=image.height;imageWidth>imageHeight?imageWidth>maxWidth&&(imageHeight*=maxWidth/imageWidth,imageWidth=maxWidth):imageHeight>maxHeight&&(imageWidth*=maxHeight/imageHeight,imageHeight=maxHeight);var canvas=document.createElement("canvas");canvas.width=imageWidth,canvas.height=imageHeight,image.width=imageWidth,image.height=imageHeight,canvas.getContext("2d").drawImage(this,0,0,imageWidth,imageHeight);var resizedImage=new Image;resizedImage.src=canvas.toDataURL("image/png"),defered.resolve(resizedImage)},defered.promise},service.getBinaryData=function(image){for(var typeIndex=image.src.indexOf("image/")+6,binaryIndex=image.src.indexOf(";base64,"),binaryData=image.src.slice(binaryIndex+8),imageType=image.src.slice(typeIndex,binaryIndex),binary_string=window.atob(binaryData),len=binary_string.length,bytes=new Uint8Array(len),i=0;i<len;i++)bytes[i]=binary_string.charCodeAt(i);return{type:imageType,data:bytes}},service.pushContactInRoom=function(user,room){return $q((function(resolve){contactService.getContactByDBId(user.userId).then((function(contact){room.users.push({contact:contact,status:user.status,date:new Date(user.additionDate),privilege:user.privilege}),contactService.isUserContact(contact)&&(room.status=user.status),$log.info("[roomService] pushContactInRoom success"),resolve()})).catch((function(error){$log.info("[roomService] pushContactInRoom failure : "+error.message),resolve()}))}))},service.addRoomUser=function(room,contact,reason,privilege,withoutInvitation){return $q((function(resolve,reject){if(room.users.some((function(user){return(user.status===service.RoomUserStatus.INVITED||user.status===service.RoomUserStatus.ACCEPTED||user.status===service.RoomUserStatus.REJECTED)&&user.contact.dbId===contact.dbId})))return $log.debug("[roomService] user: "+contact.dbId+" already invited or accepted, will not be added"),void resolve(room);if(room.users.filter((function(user){return user.status!==service.RoomUserStatus.DELETED})).length>=service.maxRoomsUsers){var profileError=new Error("addRoomUser failure - Not Allowed : Participants max limit has been reached: "+service.maxRoomsUsers);return profileError.status=profileError.errorDetailsCode="403",$log.error("[roomService] "+profileError.message),void reject(profileError)}var userStatus=service.RoomUserStatus.INVITED;"boolean"==typeof withoutInvitation&&withoutInvitation&&(userStatus=service.RoomUserStatus.ACCEPTED);var userReason=reason||"JustForFun",userPrivilege=privilege||Room.Privilege.USER;$http({method:"POST",url:service.portalURL+"rooms/"+room.dbId+"/users",headers:authService.getPostHeader(),data:{userId:contact.dbId,privilege:userPrivilege,reason:userReason,status:userStatus}}).then((function(response){$log.info("[roomService] addRoomUser "+contact.displayNameForLog()+" to room "+room.dbId+"("+room.getNameForLogs()+") success");var userData=response.data.data,user=room.getUserByJid(userData.jid_im);user?(user.status=userData.status,user.date=new Date,user.privilege=userData.privilege):room.users.push({contact:contact,status:userStatus,date:new Date,privilege:userPrivilege}),service.refreshMemberAndOrganizerLists(room),$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room),resolve(room)}),(function(response){var errorMessage="addRoomUser "+contact.displayNameForLog()+" to room "+room.dbId+"("+room.getNameForLogs()+") failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.addRoomUsers=function(room,contacts,emails){return $q((function(resolve,reject){var addRoomUserPromises=[];contacts.forEach((function(contact){room.users.some((function(user){if(user.contact.dbId===contact.dbId){switch(user.status){case service.RoomUserStatus.UNSUBSCRIBED:addRoomUserPromises.push(service.ownerReinviteRejectedUser(room,contact));break;case service.RoomUserStatus.DELETED:addRoomUserPromises.push(service.ownerReinviteDeletedUser(room,contact));break;case service.RoomUserStatus.REJECTED:addRoomUserPromises.push(service.ownerReinviteRejectedUser(room,contact))}return!0}return!1}))||addRoomUserPromises.push(service.addRoomUser(room,contact))})),$q.all(addRoomUserPromises).then((function(){$log.info("[roomService] addRoomUsers success"),$rootScope.$broadcast(service.ROOM_ADD_USERS_EVENT,room),resolve(room)})).then((function(){service.inviteGuestEmailToJoinRoom(room,emails)})).catch((function(error){var errorMessage="addRoomUsers failure: "+error.message;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.deleteRoomUsers=function(room,contacts){return $q((function(resolve,reject){var deleteRoomUserPromises=[];contacts.forEach((function(contact){room.users.some((function(user){return user.contact.dbId===contact.dbId}))&&deleteRoomUserPromises.push(service.ownerDeletesUserFromRoom(room,contact))})),$q.all(deleteRoomUserPromises).then((function(){$log.info("[roomService] deleteRoomUsers success"),$rootScope.$broadcast(service.ROOM_DELETE_USERS_EVENT,room),resolve(room)})).catch((function(error){var errorMessage="deleteRoomUsers failure: "+error.message;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.addRoomAndroidTVs=function(room,contactAndroidTVs){return $q((function(resolve,reject){var addRoomAndroidTVPromises=[];contactAndroidTVs.forEach((function(contactAndroidTV){addRoomAndroidTVPromises.push(service.addRoomAndroidTV(room,contactAndroidTV))})),$q.all(addRoomAndroidTVPromises).then((function(){$log.info("[roomService] addRoomAndroidTVs success"),$rootScope.$broadcast(service.ROOM_ADD_USERS_EVENT,room),resolve(room)})).catch((function(error){var errorMessage="addRoomAndroidTVs failure: "+error.message;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.addRoomAndroidTV=function(room,contact){return $q((function(resolve,reject){$http({method:"POST",url:service.portalURL+"rooms/"+room.dbId+"/users",headers:authService.getPostHeader(),data:{userId:contact.dbId,privilege:"moderator",reason:"androidtv",status:"accepted"}}).then((function(response){$log.info("[roomService] addRoomAndroidTV "+contact.displayNameForLog()+" to room "+room.dbId+"("+room.getNameForLogs()+") success");var userData=response.data.data,user=room.getUserByJid(userData.jid_im);user?(user.status=userData.status,user.date=new Date,user.privilege=userData.privilege):room.users.push({contact:contact,status:"accepted",date:new Date,privilege:"moderator"}),service.refreshMemberAndOrganizerLists(room),$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room),resolve(room)}),(function(response){var errorMessage="addRoomAndroidTV "+contact.displayNameForLog()+" to room "+room.dbId+"("+room.getNameForLogs()+") failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.sendInitialRoomPresence=function(room,attempt){var attemptInfo=attempt?" -- attempt "+attempt:"";$log.info("[roomService] sendInitialRoomPresence "+attemptInfo+" -- "+room.getNameForLogs()+" -- "+room.dbId);var presenceIq=$pres({to:room.jid+"/"+xmppService.fullJid});presenceIq.c("x",{xmlns:"http://jabber.org/protocol/muc"}).c("history",{maxchars:"0"}),xmppService.send(presenceIq)},service.sendInitialRoomPresenceSync=function(room){if(room.initPresPromise)return room.initPresPromise.promise;var defered=room.initPresPromise=$q.defer();service.sendInitialRoomPresence(room,"0");var attemptNumber=0;return room.initPresInterval=$interval((function(){attemptNumber<5?service.sendInitialRoomPresence(room,++attemptNumber):($log.error("[roomService] sendInitialRoomPresenceSync : no response after "+attemptNumber+" retries => clean presence promise and interval for "+room.getNameForLogs()+" -- "+room.jid),room.initPresPromise=null,room=service.rooms[room.id],$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room))}),7500,6),defered.promise},service.sendPresenceWithResponseWait=function(room){if(room.initPresPromiseReceived)return service.sendInitialRoomPresence(room),$q.when(room);var defered=room.initPresPromise=$q.defer();return service.sendInitialRoomPresence(room),defered.promise},service.sendUnavailableRoomPresence=function(room){var presenceIq=$pres({to:room.jid+"/"+contactService.userContact.jid,type:"unavailable"});presenceIq.c("x",{xmlns:"http://jabber.org/protocol/muc"}),xmppService.send(presenceIq)},service.createRoom=function(roomName,roomDesc,withHistory,roomAvatar,disableNotifications,mediaType,createConversation,autoAcceptInvitation){var roomNameForLogs=roomName.charAt(0)+"***"+roomName.slice(-1);return $log.info('[roomService] createRoom "'+roomNameForLogs+'"'),$q((function(resolve,reject){(void 0===disableNotifications||disableNotifications&&"boolean"!=typeof disableNotifications)&&(disableNotifications=!0),createConversation=angular.isDefined(createConversation)?createConversation:"true";var data={name:roomName,topic:roomDesc,history:withHistory?"all":"none",disableNotifications:disableNotifications,createConversation:createConversation,autoAcceptInvitation:!!autoAcceptInvitation};mediaType&&(data.mediaType=mediaType),$http({method:"POST",url:service.portalURL+"rooms/",headers:authService.getPostHeader(),data:data}).then((function(response){var roomData=response.data.data;return service.setAvatarRoom(roomData,roomAvatar)})).then((function(roomData){service.rooms[roomData.id]&&($log.info('[roomService] createRoom -- room "'+roomNameForLogs+'" already exists'),resolve(service.rooms[roomData.id]));var room=Room.create(roomData.id,roomData.jid,roomData.name,roomData.topic,roomData.creationDate,roomData.confEndpoints,roomData.history,roomData.customData,roomData.conference,roomData.avatar,roomData.isActive,null,null,roomData.autoAcceptInvitation);room.ownerContact=contactService.userContact,room.owner=!0,room.isModerator=!0,room.status="accepted",service.rooms[room.dbId]=room,service.roomsByJids[room.jid]=room,$log.info('[roomService] createRoom "'+roomNameForLogs+'" -- success'),resolve(service.sendInitialRoomPresenceSync(room))})).catch((function(error){var message=error;error&&error.data&&(message=error.data.errorDetailsCode+" "+error.data.errorDetails),$log.error('[roomService] createRoom "'+roomNameForLogs+'" -- failure : '+message),reject(error)}))}))},service.updateRoomUser=function(room,contact,status,privilege){var data={};return status&&(data.status=status),privilege&&(data.privilege=privilege),$q((function(resolve,reject){$http({method:"PUT",url:service.portalURL+"rooms/"+room.dbId+"/users/"+contact.dbId,headers:authService.getPostHeader(),data:data}).then((function(response){$log.info("[roomService] updateRoomUser "+contact.displayNameForLog()+" to room "+room.dbId+"("+room.getNameForLogs()+") success");var userData=response.data.data;room.users.forEach((function(user){user.contact.jid===userData.jid_im&&(user.privilege=userData.privilege,user.status=userData.status)})),service.refreshMemberAndOrganizerLists(room),$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room),resolve(room)}),(function(response){var errorMessage="updateRoomUser "+contact.displayNameForLog()+" to room "+room.dbId+"("+room.getNameForLogs()+") failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.ownerArchiveRoom=function(room){return $log.info("[roomService] ownerArchiveRoom"),$q((function(resolve,reject){var unsubscribeRoomUserPromises=[];room.users.forEach((function(user){contactService.isUserContact(user.contact)||user.status===service.RoomUserStatus.DELETED||user.status===service.RoomUserStatus.REJECTED||unsubscribeRoomUserPromises.push(service.unsubscribeUserFromRoom(room,user.contact))})),$q.all(unsubscribeRoomUserPromises).then((function(){$log.info("[roomService] unsubscribe all other users successfully"),service.unsubscribeMeFromRoom(room).then((function(){$log.info("[roomService] ownerArchiveRoom successfully"),resolve(room)}))})).catch((function(error){var errorMessage="ownerArchiveRoom failure: "+error.message;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.unsubscribeUserFromRoom=function(room,contact){return service.updateRoomUser(room,contact,service.RoomUserStatus.UNSUBSCRIBED)},service.ownerDeletesUserFromRoom=function(room,contact){return $log.info("[roomService] ownerDeletesUserFromRoom"),$q((function(resolve,reject){var userId=contact.dbId;$http({method:"DELETE",url:service.portalURL+"rooms/"+room.dbId+"/users/"+userId,headers:authService.getRequestHeader()}).then((function(){$log.info("[roomService] ownerDeletesUserFromRoom "+userId+" from room "+room.dbId+"("+room.getNameForLogs()+") success"),$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room),resolve(room)}),(function(response){var errorMessage="ownerDeletesUserFromRoom "+userId+" from room "+room.dbId+"("+room.getNameForLogs()+") failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.ownerReinviteRejectedUser=function(room,contact,reason,privilege,withoutInvitation){return $q((function(resolve,reject){service.ownerDeletesUserFromRoom(room,contact).then((function(){service.addRoomUser(room,contact,reason,privilege,withoutInvitation).then((function(){$log.info("[roomService] ownerReinviteRejectedUser "+contact.dbId+" from room "+room.dbId+"("+room.getNameForLogs()+") success"),resolve(room)}))})).catch((function(error){var errorMessage="ownerReinviteRejectedUser failure: "+error.message;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.ownerReinviteDeletedUser=function(room,contact,reason,privilege,withoutInvitation){return $q((function(resolve,reject){service.addRoomUser(room,contact,reason,privilege,withoutInvitation).then((function(){$log.info("[roomService] ownerReinviteDeletedUser "+contact.dbId+" from room "+room.dbId+"("+room.getNameForLogs()+") success"),resolve(room)})).catch((function(error){var errorMessage="ownerReinviteDeletedUser failure: "+error.message;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.ownerDeleteRoom=function(room){return $q((function(resolve,reject){var roomId=room.dbId;roomId?$http({method:"DELETE",url:service.portalURL+"rooms/"+roomId,headers:authService.getRequestHeader()}).then((function(){$log.info("[roomService] ownerDeleteRoom "+room.dbId+"("+room.getNameForLogs()+") success"),delete service.rooms[room.dbId],$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room),resolve(room)}),(function(response){var errorMessage="ownerDeleteRoom ("+roomId+") failure: unknown error occurred";response&&response.data&&(errorMessage="ownerDeleteRoom ("+roomId+") failure: "+response.data.errorDetails),response&&404===response.status&&($log.info("[roomService] ownerDeleteRoom "+room.dbId+"("+room.getNameForLogs()+") not found, deleting it from local storage"),delete service.rooms[room.dbId],$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room)),$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))})):$log.error("[roomService] ownerDeleteRoom failure because the roomId is empty ...")}))},service.ownerUpdateRoom=function(roomData){return $log.info("[roomService] ownerUpdateRoom"),$q((function(resolve,reject){var _room={name:roomData.name,topic:roomData.desc,visibility:roomData.type?"public":"private"};$http({method:"PUT",url:service.portalURL+"rooms/"+roomData.dbId,headers:authService.getPostHeader(),data:_room}).then((function(response){var room=response.data.data;service.rooms[room.id].desc=room.topic,service.rooms[room.id].type="private"===room.visibility?Room.Type.PRIVATE:Room.Type.PUBLIC,$log.info("[roomService] ownerUpdateRoom successfully ("+room.id+", "+room.jid+")"),resolve(service.rooms[room.id])}),(function(response){var errorMessage="ownerUpdateRoom failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.changeRoomOwner=function(room,newOwnerContact){return $log.info("[roomService] changeRoomOwner"),$q((function(resolve,reject){if(!room||!newOwnerContact){var msg="changeRoomOwner error: - missing room or new owner";return $log.error("[roomService] "+msg),void reject(new Error(msg))}var roomData={owner:newOwnerContact.dbId},confEndpointId=room.confEndpoints&&room.confEndpoints.length?room.confEndpoints[0].confEndpointId:"";service.deleteRoomConferenceEndPoint(room,confEndpointId).then((function(){$http({method:"PUT",url:service.portalURL+"rooms/"+room.dbId,headers:authService.getPostHeader(),data:roomData}).then((function(){room.ownerContact=newOwnerContact,room.owner=newOwnerContact.jid===contactService.userContact.jid,$log.info("[roomService] changeRoomOwner successfully ("+room.dbId+")"),resolve(service.rooms[room.dbId])}),(function(response){var errorMessage="changeRoomOwner failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))})).catch((function(error){$log.error("[roomService] changeRoomOwner error"),reject(error)}))}))},service.ownerUpdateRoomCustomData=function(roomData){return $log.info("[roomService] ownerUpdateRoomCustomData"),$q((function(resolve,reject){var _customData={customData:roomData.customData};$http({method:"PUT",url:service.portalURL+"rooms/"+roomData.dbId+"/custom-data",headers:authService.getPostHeader(),data:_customData}).then((function(response){var data=response.data.data;$log.info("[roomService] ownerUpdateRoomCustomData successfully got ("+JSON.stringify(data,null,4)+")"),resolve(data.customData||{})}),(function(response){var errorMessage="ownerUpdateRoomCustomData failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.ownerUpdateRoomNameAndDescription=function(roomData){return $log.info("[roomService] ownerUpdateRoomNameAndDescription"),$q((function(resolve,reject){var _room={name:roomData.name,topic:roomData.desc,visibility:roomData.type?"public":"private"};$http({method:"PUT",url:service.portalURL+"rooms/"+roomData.dbId,headers:authService.getPostHeader(),data:_room}).then((function(response){var room=response.data.data;service.rooms[room.id].desc=room.topic,service.rooms[room.id].type="private"===room.visibility?Room.Type.PRIVATE:Room.Type.PUBLIC,(room.conference||room.confEndpoints)&&(service.rooms[room.id].conference=room.conference?room.conference:null,service.rooms[room.id].confEndpoints=room.confEndpoints?room.confEndpoints:[]),$log.info("[roomService] ownerUpdateRoomNameAndDescription successfully ("+room.id+", "+room.jid+")"),resolve(service.rooms[room.id])}),(function(response){var errorMessage="ownerUpdateRoomNameAndDescription failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.ownerUpdateAutoRegister=function(roomData){return $log.info("[roomService] ownerUpdateAutoRegister"),$q((function(resolve,reject){var _room={autoRegister:roomData.getAutoRegister()};$http({method:"PUT",url:service.portalURL+"rooms/"+roomData.dbId,headers:authService.getPostHeader(),data:_room}).then((function(response){var room=response.data.data;service.rooms[room.id].setAutoRegister(room.autoRegister),service.rooms[room.id].desc=room.topic,service.rooms[room.id].type="private"===room.visibility?Room.Type.PRIVATE:Room.Type.PUBLIC,(room.conference||room.confEndpoints)&&(service.rooms[room.id].conference=room.conference?room.conference:null,service.rooms[room.id].confEndpoints=room.confEndpoints?room.confEndpoints:[]),$log.info("[roomService] ownerUpdateAutoRegister successfully ("+room.id+", "+room.jid+")"),resolve(service.rooms[room.id])}),(function(response){var errorMessage="ownerUpdateAutoRegister failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.updateMyRoomUser=function(room,status){return $q((function(resolve,reject){$http({method:"PUT",url:service.portalURL+"rooms/"+room.dbId+"/users/"+contactService.userContact.dbId,headers:authService.getPostHeader(),data:{status:status}}).then((function(){$log.info("[roomService] updateMyRoomUser "+contactService.userContact.displayNameForLog()+" to room "+room.dbId+"("+room.getNameForLogs()+") success"),resolve(room)}),(function(response){var errorMessage="updateMyRoomUser "+contactService.userContact.displayNameForLog()+" to room "+room.dbId+"("+room.getNameForLogs()+") failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.unsubscribeMeFromRoom=function(room){return service.updateMyRoomUser(room,service.RoomUserStatus.UNSUBSCRIBED)},service.participantCloseRoom=function(room){return $log.info("[roomService] participantCloseRoom"),$q((function(resolve,reject){var userId=contactService.userContact.dbId;$http({method:"DELETE",url:service.portalURL+"rooms/"+room.dbId+"/users/"+userId,headers:authService.getRequestHeader()}).then((function(){$log.info("[roomService] participantCloseRoom "+userId+" from room "+room.dbId+"("+room.getNameForLogs()+") success"),delete service.rooms[room.dbId],$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room),resolve(room)}),(function(response){var errorMessage="participantCloseRoom "+userId+" from room "+room.dbId+"("+room.getNameForLogs()+") failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.acceptRoomInvitation=function(room){return service.updateMyRoomUser(room,service.RoomUserStatus.ACCEPTED)},service.declineRoomInvitation=function(room){return service.updateMyRoomUser(room,service.RoomUserStatus.REJECTED)},service.getRoomConferenceEndPoint=function(room,conferenceEndPointId){return $log.info("[roomService] getRoomConferenceEndPoint"),$q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"rooms/"+room.dbId+"/conference/"+conferenceEndPointId,headers:authService.getRequestHeader()}).then((function(response){var conferenceData=response.data.data;$log.info("[roomService] getRoomConferenceEndPoint "+conferenceEndPointId+" from room "+room.dbId+"success"),resolve(conferenceData)}),(function(response){var errorMessage="getRoomConferenceEndPoint "+conferenceEndPointId+" from room "+room.dbId+"failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.addRoomConferenceEndPoint=function(room,conferenceEndPoint,mediaType,createConversation){$log.info("[roomService] addRoomConferenceEndPoint");var defered=$q.defer();if(null===conferenceEndPoint||angular.isUndefined(conferenceEndPoint)){var err=new Error("No ConferenceEndPoint to associate with Room");defered.reject(err)}var alreadyAttached=!1;room.confEndpoints.forEach((function(endpoint){endpoint.confEndpointId===conferenceEndPoint.id&&(alreadyAttached=!0)})),alreadyAttached&&($log.info("[roomService] addRoomConferenceEndPoint : already attached to room !"),defered.resolve(room));var deleteConfEndpointPromises=[];return mediaType&&"pstnAudio"===mediaType&&Object.keys(service.rooms).forEach((function(key){service.rooms[key].conference&&!service.rooms[key].conference.scheduled&&service.rooms[key].getPstnConfEndpointId()===conferenceEndPoint.id&&deleteConfEndpointPromises.push(service.deleteRoomConferenceEndPoint(service.rooms[key],conferenceEndPoint.id))})),$q.all(deleteConfEndpointPromises).finally((function(){createConversation=angular.isDefined(createConversation)?createConversation:"true",$http({method:"POST",url:service.portalURL+"rooms/"+room.dbId+"/conferences",headers:authService.getPostHeader(),data:{confId:conferenceEndPoint.id,createConversation:createConversation}}).then((function(response){var conferenceData=response.data.data;$log.debug("[roomService] addRoomConferenceEndPoint response data:"+JSON.stringify(conferenceData)),room.confEndpoints.push(conferenceData),$log.info("[roomService] addRoomConferenceEndPoint "+conferenceEndPoint.id+" to room "+room.dbId+"success"),$rootScope.$broadcast(service.ROOM_ADD_CONF_ENDPOINT_EVENT,room),defered.resolve(room)}),(function(errorResponse){var error=errorHelperService.handleError(errorResponse);$log.error("[roomService] addRoomConferenceEndPoint "+error.message),defered.reject(error)}))})),defered.promise},service.deleteRoomConferenceEndPoint=function(room,conferenceEndPointId){return $log.info("[roomService] deleteRoomConferenceEndPoint"),$q((function(resolve,reject){if(!room||!conferenceEndPointId)return $log.info("[roomService] deleteRoomConferenceEndPoint : missing parameters "),void resolve();var roomHasConfEndpoint=!1;if(room.confEndpoints&&room.confEndpoints.length)for(var i=0;i<room.confEndpoints.length;i++)if(room.confEndpoints[i].confEndpointId===conferenceEndPointId){roomHasConfEndpoint=!0;break}if(!roomHasConfEndpoint)return $log.info("[roomService] deleteRoomConferenceEndPoint : room has no such conference attached"),void resolve();$http({method:"DELETE",url:service.portalURL+"rooms/"+room.dbId+"/conferences/"+conferenceEndPointId,headers:authService.getRequestHeader()}).then((function(response){var conferenceData=response.data.data;$log.info("[roomService] deleteRoomConferenceEndPoint "+conferenceEndPointId+" from room "+room.dbId+"success"),room.confEndpoints=conferenceData,$rootScope.$broadcast(service.ROOM_REMOVE_CONF_ENDPOINT_EVENT,room),resolve()}),(function(response){var errorMessage="deleteRoomConferenceEndPoint "+conferenceEndPointId+" from room "+room.dbId+"failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),404===response.status?(room.confEndpoints=[],$rootScope.$broadcast(service.ROOM_REMOVE_CONF_ENDPOINT_EVENT,room),resolve(response.status)):reject(new Error(errorMessage))}))}))},service.inviteGuestEmailToJoinRoom=function(room,emails){return $log.info("[roomService] inviteGuestEmailToJoinRoom"),emails&&emails.length?$q((function(resolve,reject){$http({method:"POST",url:service.portalURL+"rooms/"+room.dbId+"/invitations",headers:authService.getRequestHeader(),data:{scenario:"chat",emails:emails,lang:authService.userData.language}}).then((function(response){room.guestEmails=response.data.data.guestEmails,$rootScope.$broadcast("ROOM_UPDATE_EVENT",room),resolve(room)})).catch((function(errorResponse){var error=errorHelperService.handleError(errorResponse);$log.error("[roomService] inviteGuestEmailToJoinRoom "+error.message),reject(error)}))})):$q.resolve(room)},service.ownerCancelGuestFromRoom=function(room,emails){return $log.info("[roomService] ownerCancelGuestFromRoom"),emails&&emails.length?$q((function(resolve,reject){$http({method:"POST",url:service.portalURL+"rooms/"+room.dbId+"/invitations/cancel",headers:authService.getRequestHeader(),data:{scenario:"chat",emails:emails,lang:authService.userData.language}}).then((function(response){room.guestEmails=response.data.guestEmails,$rootScope.$broadcast("ROOM_UPDATE_EVENT",room),resolve(room)})).catch((function(errorResponse){var error=errorHelperService.handleError(errorResponse);$log.error("[roomService] ownerCancelGuestFromRoom "+error.message),reject(error)}))})):$q.resolve(room)},service.notifyRoomUsersJoinConference=function(room,users,emails,noMail,update){return $log.info("[roomService] notifyRoomUsersJoinConference"),noMail=angular.isDefined(noMail)?noMail:"false",update=angular.isDefined(update)?update:"false",$q((function(resolve,reject){var conferenceEndPointId=room.getPstnConfEndpointId();if(conferenceEndPointId){var instantMessage=room.desc;$http({method:"POST",url:service.portalURL+"rooms/"+room.dbId+"/invitations",headers:authService.getPostHeader(),data:{scenario:"pstn-conference",confId:conferenceEndPointId,noMail:noMail.toString(),update:update.toString(),users:users?users.map((function(user){return user.dbId})):void 0,emails:emails,instantMessage:instantMessage,lang:authService.userData.language}}).then((function(){$log.info("[roomService] notifyRoomUsersJoinConference "+conferenceEndPointId+" from room "+room.dbId+"success"),service.rooms[room.dbId].guestEmails=emails,$rootScope.$broadcast("ROOM_UPDATE_EVENT",service.rooms[room.dbId]),resolve(service.rooms[room.dbId])}),(function(response){var errorMessage="notifyRoomUsersJoinConference "+conferenceEndPointId+" from room "+room.dbId+"failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}else resolve(room)}))},service.notifyUsersCancelConference=function(room,users,emails,noMail){return $log.debug("[roomService] notifyUsersCancelConference"),noMail=angular.isDefined(noMail)?noMail:"false",$q((function(resolve,reject){var conferenceEndPointId=room.getPstnConfEndpointId();conferenceEndPointId?$http({method:"DELETE",url:service.portalURL+"rooms/"+room.dbId+"/invitations",headers:authService.getPostHeader(),data:{scenario:"pstn-conference",confId:conferenceEndPointId,noMail:noMail.toString(),users:users?users.map((function(user){return user.dbId})):void 0,emails:emails,lang:authService.userData.language}}).then((function(){$log.info("[roomService] notifyUsersCancelConference "+conferenceEndPointId+" from room "+room.dbId+"success"),service.rooms[room.dbId].guestEmails=service.rooms[room.dbId].guestEmails.filter((function(email){return-1===emails.indexOf(email)})),$rootScope.$broadcast("ROOM_UPDATE_EVENT",service.rooms[room.dbId]),resolve(service.rooms[room.dbId])}),(function(response){var errorMessage="notifyUsersCancelConference "+conferenceEndPointId+" from room "+room.dbId+"failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))})):resolve(room)}))},service.getRoomByConferenceEndpointId=function(conferenceEndpointId){return $log.info("[roomService] getRoomFromConferenceEndpointId"),$q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"rooms?userId="+contactService.userContact.dbId+"&confId="+conferenceEndpointId+"&format=full",headers:authService.getRequestHeader()}).then((function(response){$log.info("[roomService] getRoomFromConferenceEndpointId -- "+conferenceEndpointId+" -- success");var roomData=response.data.data;roomData.length?service.getRoomById(roomData[0].id)?resolve(service.getRoomById(roomData[0].id)):(service.createRoomFromData(roomData[0]),resolve(service.getRoomById(roomData[0].id))):($log.info("[roomService] getRoomFromConferenceEndpointId -- no room with confId "+conferenceEndpointId),reject())}),(function(response){var errorMessage="getRoomFromConferenceEndpointId -- "+conferenceEndpointId+" -- failure: "+response.data.errorDetails;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.onRoomMessage=function(stanza){$log.info("[roomService] onRoomMessage");try{if(angular.element(stanza).find("event").length>0&&("conferenceAdd"===angular.element(stanza).find("event").attr("name")||"conferenceRemove"===angular.element(stanza).find("event").attr("name")||"invitation"===angular.element(stanza).find("event").attr("name")))return!0;var roomId=angular.element(stanza).find("x").attr("thread");return service.getServerRoom(roomId).then((function(room){room.isMeetingRoom()&&$rootScope.$broadcast("MEETING_CREATED_EVENT",room),service.computeInvitationCounter(),$rootScope.$broadcast(service.ROOM_INVITATION,room),$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room)})).catch((function(error){$log.error("[roomService] onRoomMessage failure :  impossible to get associated room : "+error.message)})),!0}catch(error){return $log.error("[roomService] onRoomMessage error "+error),!0}},service.onRoomNotificationMessage=function(stanza){try{var stanzaElem=$(stanza),xElem=stanzaElem.find("x");if(stanzaElem.find("event").length&&xElem.length){var eventName=stanzaElem.find("event").attr("name");if(!eventName||"invitation"!==eventName)return!0;var roomId=$(xElem[0]).attr("roomid");return roomId?($log.info("[roomService] onRoomNotificationMessage : room event message with roomId "+roomId+" and event name "+eventName),service.getServerRoom(roomId).then((function(room){room.isMeetingRoom()&&$rootScope.$broadcast("MEETING_CREATED_EVENT",room),"true"===settingsService.getSetting("autoAcceptRoomInvite")?service.acceptRoomInvitation(room):(service.computeInvitationCounter(),$rootScope.$broadcast(service.ROOM_INVITATION,room),$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room),"accepted"===room.status&&room.confEndpoints&&room.confEndpoints.length&&"webrtc"===room.confEndpoints[0].mediaType&&$rootScope.$broadcast("ON_CONFERENCE_STARTED_INVITATION",room),$log.info("[roomService] onRoomNotificationMessage -- get server room success for roomId "+room.dbId+" and roomJid"+room.jid_im+" and name "+room.getNameForLogs()))})).catch((function(error){$log.error("[roomService] onRoomNotificationMessage failure :  impossible to get associated room : "+error.message)})),!0):($log.info("[roomService] onRoomNotificationMessage error -- missing roomId"),!0)}}catch(error){return $log.error("[roomService] onRoomNotificationMessage error "+error),!0}},service.onRoomInfoMessage=function(stanza){$log.info("[roomService] onRoomInfoMessage");try{if(angular.element(stanza).find("event").length>0){$log.info("[roomService] onRoomInfoMessage : room event message");var fromJid=angular.element(stanza).attr("from"),roomBareJid=xmppService.getBareJidFromJid(fromJid),userJid=angular.element(stanza).find("event").attr("jid"),eventName=angular.element(stanza).find("event").attr("name"),msgId=angular.element(stanza).attr("id");if($log.info("[roomService] onRoomInfoMessage : room event message with parameters "+roomBareJid+" || "+userJid+" || "+eventName+" || "+msgId),roomBareJid&&userJid&&eventName&&msgId){var user=(room=service.getRoomByJid(roomBareJid)).getUserByJid(userJid);switch(user&&"deleted"!==user.status&&$rootScope.$broadcast(service.ROOM_ADMIN_MESSAGE_EVENT,roomBareJid,userJid,eventName,msgId),eventName){case"conferenceAdd":$interval((function(){service.getServerRoom(room.dbId).then((function(updatedRoom){var info=updatedRoom.confEndpoints&&updatedRoom.confEndpoints[0]?updatedRoom.confEndpoints[0].confEndpointId:void 0;updatedRoom.getPstnConfEndpointId()&&updatedRoom.isMeetingRoom()&&(service.currentPersonalAudioRoomId=updatedRoom.dbId),$log.info("[roomService] onRoomInfoMessage : conferenceAdd event with conferenceObject related to room : "+info),$rootScope.$broadcast("ROOM_UPDATE_CONFID",updatedRoom),$rootScope.$broadcast("ROOM_ADD_CONF_ENDPOINT_EVENT",updatedRoom),$rootScope.$broadcast("ON_CONFERENCE_STARTED_INVITATION",updatedRoom,user)}))}),2e3,1);break;case"conferenceRemove":$interval((function(){service.getServerRoom(room.dbId).then((function(updatedRoom){room.getPstnConfEndpointId()&&!updatedRoom.getPstnConfEndpointId()&&(service.currentPersonalAudioRoomId=""),$log.info("[roomService] onRoomInfoMessage : conferenceRemove event"),$rootScope.$broadcast("ROOM_REMOVE_CONF_ENDPOINT_EVENT",updatedRoom),$rootScope.$broadcast("ON_CONFERENCE_ENDED_INVITATION",updatedRoom)}))}),2e3,1);break;case"invitation":!room.isUserModerator(contactService.userContact)||user&&user.status!==service.RoomUserStatus.DELETED||service.getServerRoom(room.dbId).then((function(updatedRoom){$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,updatedRoom)}))}}}else if(angular.element(stanza).find("subject").length>0){fromJid=angular.element(stanza).attr("from");var fromBareJid=xmppService.getBareJidFromJid(fromJid),room=service.getRoomByJid(fromBareJid),topic=angular.element(stanza).find("subject").text();room&&topic&&($log.info("[roomService] onRoomInfoMessage : update subject of room"),room.desc=topic,$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room))}return!0}catch(error){return $log.error("[roomService] onRoomInfoMessage error "+error),!0}},service.onRoomHistoryInfoMessage=function(stanza){var changedElem=$(stanza).find("changed");if(changedElem.length>0){var roomId=changedElem.attr("with"),room=service.getRoomByJid(roomId);$log.debug("[roomService] onRoomHistoryInfoMessage with "+roomId),$rootScope.$broadcast(service.ROOM_HISTORY_UPDATE_EVENT,room)}return!0},service.onRoomMessageConfig=function(stanza){try{var stanzaElem=$(stanza),roomElem=stanzaElem.find("room"),delayElem=stanzaElem.find("delay");if("management"===stanzaElem.attr("type")&&roomElem.length>0){var roomId=roomElem.attr("roomid"),userId=roomElem.attr("userjid"),status=roomElem.attr("status"),topic=roomElem.attr("topic"),name=roomElem.attr("name"),lastAvatarUpdateDate=roomElem.attr("lastAvatarUpdateDate"),avatarElem=stanzaElem.find("avatar"),avatarType=null;avatarElem.length>0&&(avatarType="delete"===avatarElem.attr("action")?"delete":"update");var privilege=roomElem.attr("privilege"),customData=roomElem.attr("customData"),room=service.getRoomById(roomId);if($log.info("[roomService] onRoomMessageConfig -- management -- "+roomId),delayElem.length>0&&"Offline Storage"===delayElem.text())return $log.info("[roomService] onRoomMessageConfig -- management delay msg skipped --"),!0;var guestsElem=roomElem.find("guests");if(guestsElem.length>0&&($log.info("[roomService] onRoomMessageConfig -- "+roomId+" -- update guests list"),"update"===guestsElem.attr("action")&&(room.guestEmails=[],$(guestsElem).find("email").each((function(__index,emailElem){room.guestEmails.push(emailElem.textContent)})))),room&&status)(user=room.getUserByJid(userId))?user&&($log.info("[roomService] onRoomMessageConfig update user status"),service.updateUserStatus(room,user,status)):($log.info("[roomService] onRoomMessageConfig room exists, but user not. Update the room"),service.getServerRoom(roomId).then((function(){room.updateAvatarInfo()})));else if(room&&name)$log.info("[roomService] onRoomMessageConfig update Room name or topic"),room.name=name,room.desc=topic||"",service.roomsByJids[room.jid].name=name,service.rooms[room.dbId].name=name,service.roomsByJids[room.jid].desc=topic||"",service.rooms[room.dbId].desc=topic||"",$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room,"rename");else if(room&&customData){$log.info("[roomService] onRoomMessageConfig update Room customData");var extractedContent=utilService.extractHtmlContent(customData);try{customData=JSON.parse(extractedContent)}catch(err){$log.error("[roomService] onRoomMessageConfig update Room Parsing error:",err),customData={}}room.customData=customData,service.roomsByJids[room.jid].customData=customData,service.rooms[room.dbId].customData=customData,$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room)}else if(room&&(lastAvatarUpdateDate||avatarType))$log.info("[roomService] onRoomMessageConfig "+avatarType+" avatar"),service.getServerRoom(room.dbId).then((function(roomToUpdate){roomToUpdate.updateAvatarInfo(),$rootScope.$broadcast(service.ROOM_AVATAR_UPDATE_EVENT,room)}));else if(room&&privilege){var user;if($log.info("[roomService] onRoomMessageConfig update user's privilege "+privilege),(user=userId?room.getUserByJid(userId):null)&&user.contact&&user.contact.jid!==contactService.userContact.jid&&"owner"!==privilege?("moderator"===privilege?user.privilege=Room.Privilege.MODERATOR:"user"===privilege&&(user.privilege=Room.Privilege.USER),contactService.getVCardByDbId(user.contact.dbId).then((function(){service.refreshMemberAndOrganizerLists(room),$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room)}))):service.getServerRoom(room.dbId).then((function(roomToUpdate){service.refreshMemberAndOrganizerLists(roomToUpdate),$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,roomToUpdate)})),"owner"===privilege&&user&&user.contact&&user.contact.jid===contactService.userContact.jid){var message=$translate.instant("promotedToOwner",{name:_escape(room.name)});$rootScope.$broadcast("GLOBAL_NOTIFY_MESSAGE_EVENT",message)}}else void 0===room&&roomId&&!service.roomsInProgress[roomId]&&"deleted"!==status&&"rejected"!==status?(service.roomsInProgress[roomId]=!0,$log.info("[roomService] onRoomMessageConfig -- room does not exist, create new one"),service.getServerRoom(roomId).then((function(newRoom){delete service.roomsInProgress[roomId],$log.info("[roomService] onRoomMessageConfig -- sendInitialRoomPresence to the new room"),service.sendInitialRoomPresence(newRoom),service.updateLater[roomId]&&(delete service.updateLater[roomId],$log.info("[roomService] onRoomMessageConfig -- later update of the new room"),service.getServerRoom(roomId).then((function(roomToUpdate){roomToUpdate.updateAvatarInfo()})))}))):service.roomsInProgress[roomId]&&(service.updateLater[roomId]=roomId)}var openinviteElem=stanzaElem.find("openinvite");if("management"===stanzaElem.attr("type")&&openinviteElem.length>0){$log.info("[roomService] onRoomMessageConfig -- openinvite");var openInviteAction=openinviteElem.attr("action"),openInviteId=(roomId=openinviteElem.find("roomid").text(),openinviteElem.find("openinviteid").text()),roomType=openinviteElem.find("roomType").text();switch(openInviteAction){case"update":Object.keys(service.openInviteIdByRoomId).forEach((function(key){service.openInviteIdByRoomId[key]&&service.openInviteIdByRoomId[key].openInviteId===openInviteId&&key!==roomId&&($log.info("[roomService] onRoomMessageConfig -- openinviteId removed from "+key),service.openInviteIdByRoomId[key]={})}));case"create":roomId&&openInviteId&&(service.openInviteIdByRoomId[roomId]={},service.openInviteIdByRoomId[roomId].roomType=roomType,service.openInviteIdByRoomId[roomId].openInviteId=openInviteId,service.openInviteIdByRoomId[roomId].openInviteLink=config.webUrl.replace("web","meet")+"/"+openInviteId,$log.info("[roomService] onRoomMessageConfig -- openinviteId "+openInviteId+" assigned to room "+roomId),$rootScope.$broadcast("ON_OPEN_INVITE_ID_UPDATED_EVENT",service.rooms[roomId]),"personal_audio_room"===roomType&&$rootScope.$broadcast("ON_PERSONAL_MEETING_OPEN_INVITE_ID_UPDATED_EVENT"));break;case"delete":Object.keys(service.openInviteIdByRoomId).forEach((function(key){service.openInviteIdByRoomId[key]&&service.openInviteIdByRoomId[key].openInviteId===openInviteId&&key===roomId&&($log.info("[roomService] onRoomMessageConfig -- openinviteId removed from "+key),service.openInviteIdByRoomId[key]={},$rootScope.$broadcast("ON_OPEN_INVITE_ID_DELETED_EVENT",service.rooms[roomId]))}));break;default:$log.info("[roomService] onRoomMessageConfig -- openinviteId - unkown action : "+openInviteAction)}}var meetingElem=stanzaElem.find("meeting");if("management"===stanzaElem.attr("type")&&meetingElem.length>0){$log.debug("[roomService] onRoomMessageConfig -- management meeting event");var meetingAction=meetingElem.attr("action");switch(roomId=meetingElem.find("roomid").length?meetingElem.find("roomid").text():-1,meetingAction){case"saved":service.currentPersonalAudioRoomId="",$log.debug("meeting saved: "+roomId),$rootScope.$broadcast("ON_MEETING_SAVED_EVENT",roomId);break;case"deleted":$log.debug("meeting deleted: "+roomId),service.currentPersonalAudioRoomId="",$rootScope.$broadcast("ON_MEETING_DELETED_EVENT",roomId);break;case"created":$log.debug("meeting created: "+roomId),service.personalAudioRoomId=roomId,service.currentPersonalAudioRoomId=roomId,$rootScope.$broadcast("ON_MEETING_CREATED_EVENT",roomId);break;case"updated":$log.debug("meeting updated: "+roomId),service.personalAudioRoomId=roomId,service.currentPersonalAudioRoomId=roomId,$rootScope.$broadcast("ON_MEETING_UPDATED_EVENT",roomId)}}return!0}catch(error){return $log.info("[roomService] onRoomMessageConfig  -- failure -- "+error.message),!0}},service.onRoomPresence=function(stanza){try{var stanzaElem=angular.element(stanza),fromJid=stanzaElem.attr("from"),fromRoomBareJid=xmppService.getBareJidFromJid(fromJid),fromUserJid=xmppService.getResourceFromJid(fromJid),statusElems=stanzaElem.find("status"),statusCode=null;statusElems.each((function(__index,statusElem){"332"===$(statusElem).attr("code")&&(statusCode="332"),"338"===$(statusElem).attr("code")&&(statusCode="338"),"339"===$(statusElem).attr("code")&&(statusCode="339")}));var room=service.getRoomByJid(fromRoomBareJid);return room&&("338"===statusCode?($log.info("[roomService] onRoomPresence - "+room.dbId+"- Deactivated"),room.isActive=!1,$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room)):"339"===statusCode?($log.info("[roomService] onRoomPresence - "+room.dbId+"- Reactivated"),service.sendInitialRoomPresenceSync(room),room.isActive=!0,$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room)):($log.info("[roomService] onRoomPresence -- "+room.dbId),-1!==fromUserJid.indexOf("/")&&(fromUserJid=xmppService.getBareJidFromJid(fromUserJid)),contactService.isUserContactJid(fromUserJid)?"332"===statusCode?($log.error("[roomService] disconnected from room "+room.getNameForLogs()+" because of a system shutdown"),service.sendInitialRoomPresenceSync(room)):room.initPresPromise&&($log.info("[roomService] onRoomPresence - initPresPromise resolved"),room.initPresPromise.resolve(room),room.initPresInterval&&$interval.cancel(room.initPresInterval),room.initPresPromise=null,$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room),room.initPresPromiseReceived=!0):room.dbId&&!service.rooms[room.dbId]&&service.getServerRoom(room.dbId))),!0}catch(error){return $log.error("[roomService] onRoomPresence error "+error),!0}},service.updateUserStatus=function(room,user,status){if($log.info("[roomService] "+user.status+" || "+status),contactService.isUserContactJid(user.contact.jid)&&user.status!==status)switch($log.info("[roomService] my new status "+status),status){case"deleted":delete service.roomsByJids[room.jid],delete service.rooms[room.dbId],$log.info("[roomService] deleteRoom successfully ("+room.dbId+")"),service.sendUnavailableRoomPresence(room),service.computeInvitationCounter(),room.isMeetingRoom()&&$rootScope.$broadcast("MEETING_DELETE_EVENT",room),$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room,"remove");break;case"unsubscribed":$log.info("[roomService] unsubscribed successfully ("+room.dbId+")"),service.sendUnavailableRoomPresence(room),room.status=service.RoomUserStatus.UNSUBSCRIBED,user.status=status,room.updateAvatarInfo(),room.isModerator=!1,service.computeInvitationCounter(),$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room);break;case"accepted":room.status=service.RoomUserStatus.ACCEPTED,user.status=status,fileStorageService.retrieveReceivedFilesForRoom(room.dbId).then((function(){service.sendInitialRoomPresenceSync(room),room.updateAvatarInfo(),service.computeInvitationCounter(),$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room),service.getServerRoom(room.dbId).then((function(room){$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room),room.confEndpoints&&room.confEndpoints.length&&"webrtc"===room.confEndpoints[0].mediaType&&$rootScope.$broadcast("ON_CONFERENCE_STARTED_INVITATION",room)})).catch((function(){$log.warn("[roomService] getServerRoom "+room.dbId+" failed")}))}));break;case"rejected":delete service.roomsByJids[room.jid],delete service.rooms[room.dbId],room.status=service.RoomUserStatus.REJECTED,user.status=status,service.computeInvitationCounter(),$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room)}else user&&!contactService.isUserContactJid(user.contact.jid)&&($log.info("[roomService] Update user with status "+status),user.status===service.RoomUserStatus.DELETED&&status===service.RoomUserStatus.ACCEPTED&&(user.date=new Date,user.privilege===Room.Privilege.MODERATOR&&(user.privilege=Room.Privilege.USER)),user.status=status,room.updateAvatarInfo(),service.refreshMemberAndOrganizerLists(room),$rootScope.$broadcast(service.ROOM_UPDATE_EVENT,room))},service.findRoomsWithConfId=function(confId){return service.getRooms().filter((function(room){return!(!room.confEndpoints||!room.confEndpoints.length)&&room.confEndpoints.some((function(confEndpoint){return confEndpoint.confEndpointId===confId}))}))},service.removeConfIdInAllRooms=function(rooms){var actionPromises=[];return rooms.forEach((function(room){room.confEndpoints&&room.confEndpoints.length>0&&actionPromises.push(service.deleteRoomConferenceEndPoint(room,room.confEndpoints[0].confEndpointId))})),$q.all(actionPromises)},service.getCreationDate=function(room){return room.creationDate?moment(room.creationDate):moment()},service.getLastActivityDate=function(room){return room.lastActivityDate?moment(room.lastActivityDate):room.creationDate?moment(room.creationDate):moment()},service.sortByDate=function(dateA,dateB){var res=1;return dateA&&dateB&&(res=dateA.value-dateB.value),res},service.resetOpenInviteId=function(roomId){return new Promise((function(resolve,reject){var serverUrl=service.portalURL+"users/"+contactService.userContact.dbId+"/public-links/reset";$http({method:"PUT",url:serverUrl,headers:authService.getRequestHeader(),data:{roomId:roomId}}).then((function(response){var openInviteData=response.data.data;openInviteData&&openInviteData.openInviteId&&openInviteData.roomId&&($log.info("[roomService] resetOpenInviteId success - openinviteId "+openInviteData.openInviteId+" bound to room "+roomId),service.openInviteIdByRoomId[openInviteData.roomId]={},service.openInviteIdByRoomId[openInviteData.roomId].roomType=openInviteData.roomType,service.openInviteIdByRoomId[openInviteData.roomId].openInviteId=openInviteData.openInviteId,service.openInviteIdByRoomId[openInviteData.roomId].openInviteLink=config.webUrl.replace("web","meet")+"/"+openInviteData.openInviteId),resolve(openInviteData.openInviteId)}),(function(){$log.error("[contactService] resetOpenInviteId failure"),reject(new Error("resetOpenInviteId failure"))}))}))},service.bindOpenInviteIdToRoom=function(room){return new Promise((function(resolve,reject){var url=service.portalURL+"users/"+room.ownerContact.dbId+"/public-links/bind",data={roomId:room.dbId};$http({method:"POST",url:url,headers:authService.getPostHeader(),data:data}).then((function(response){var openInviteData=response.data.data;openInviteData&&openInviteData.roomId&&openInviteData.roomType&&openInviteData.openInviteId&&($log.info("[roomService] createRoomOpenInviteId -- SUCCESS - room "+openInviteData.roomId+" with type "+openInviteData.roomType+" bound to openInviteId "+openInviteData.openInviteId),service.openInviteIdByRoomId[openInviteData.roomId]={},service.openInviteIdByRoomId[openInviteData.roomId].roomType=openInviteData.roomType,service.openInviteIdByRoomId[openInviteData.roomId].openInviteId=openInviteData.openInviteId,service.openInviteIdByRoomId[openInviteData.roomId].openInviteLink=config.webUrl.replace("web","meet")+"/"+openInviteData.openInviteId),resolve(service.rooms[room.dbId])})).catch((function(error){var errorMessage="createRoomOpenInviteId -- FAILURE -- "+error.message;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.unbindOpenInviteFromRoom=function(roomId){return $q((function(resolve,reject){$http({method:"PUT",url:service.portalURL+"users/"+contactService.userContact.dbId+"/public-links/unbind",headers:authService.getRequestHeader(),data:{roomId:roomId}}).then((function(){$log.info("[roomService] openInvite successfully unbound"),resolve()}),(function(){$log.error("[roomService] unbindOpenInvite failure"),reject(new Error("unbindOpenInvite failure"))}))}))},service.joinRoomUsingOpenInviteId=function(openInviteId){return $q((function(resolve,reject){$http({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/rooms/open-invites",headers:authService.getRequestHeader(),data:{openInviteId:openInviteId}}).then((function(response){var openInvitesData=response.data.data;openInvitesData&&openInvitesData.roomId?resolve(openInvitesData.roomId):reject()})).catch((function(err){var error=errorHelperService.handleError(err);$log.error("[roomService] Error retrieveRoomFromOpenInvite"),reject(error)}))}))},service.retrieveOpenInviteData=function(type,roomId){return $log.debug("[roomService] retrieveOpenInviteData - type: "+type+" - roomId: "+roomId),new Promise((function(resolve,reject){var urlParams="";roomId&&(urlParams+="?roomId="+roomId),type&&(urlParams+=urlParams?"&type="+type:"?type="+type);var url=service.portalURL+"users/"+contactService.userContact.dbId+"/public-links"+urlParams;$http({method:"GET",url:url,headers:authService.getPostHeader()}).then((function(response){var openInviteData=response.data.data;openInviteData&&openInviteData.length?($log.debug("[roomService] retrieveOpenInviteData -- SUCCESS - found "+openInviteData.length),openInviteData.forEach((function(openInvitePair){openInvitePair.roomId&&(service.openInviteIdByRoomId[openInvitePair.roomId]={},service.openInviteIdByRoomId[openInvitePair.roomId].roomType=openInvitePair.roomType,service.openInviteIdByRoomId[openInvitePair.roomId].openInviteId=openInvitePair.openInviteId,service.openInviteIdByRoomId[openInvitePair.roomId].openInviteLink=config.webUrl.replace("web","meet")+"/"+openInvitePair.openInviteId,$log.debug("[roomService] retrieveOpenInviteData - openInviteId "+openInvitePair.openInviteId+" set for room "+openInvitePair.roomId))})),resolve(openInviteData)):($log.debug("[roomService] retrieveOpenInviteData -- FAILURE - none found"),reject())})).catch((function(error){var errorMessage="retrieveOpenInviteData -- FAILURE -- "+error.message;$log.error("[roomService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.retrievePersonalAudioRoom=function(){var force=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!force&&service.personalAudioRoomId&&service.getRoomById(service.personalAudioRoomId))return $log.debug("[roomService] retrievePersonalAudioRoom from service data"),service.getRoomById(service.personalAudioRoomId);var defer=$q.defer();$log.debug("[roomService] retrievePersonalAudioRoom from server");var url=service.portalURL+"meetings/personal";return $http({method:"GET",url:url,headers:authService.getPostHeader()}).then((function(response){var meetingRoomData=response.data.data;if(meetingRoomData.id){service.personalAudioRoomId=meetingRoomData.id;var room=service.getRoomById(meetingRoomData.id);room?service.updateRoomData(room,meetingRoomData):service.createRoomFromData(meetingRoomData),defer.resolve(service.getRoomById(meetingRoomData.id))}else{var error=new Error("Wrong data from server");defer.reject(error)}})).catch((function(error){var errorMessage="retrievePersonalAudioRoom -- FAILURE -- ".concat(error.message);$log.error("[roomService] ".concat(errorMessage)),defer.reject(new Error(errorMessage))})),defer.promise},service.retrieveCurrentPersonalAudioRoom=function(){var force=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!force&&service.currentPersonalAudioRoomId&&service.getRoomById(service.currentPersonalAudioRoomId))return $log.debug("[roomService] retrieveCurrentPersonalAudioRoom from service data"),service.getRoomById(service.currentPersonalAudioRoomId);var defer=$q.defer();return $log.debug("[roomService] retrieveCurrentPersonalAudioRoom from server"),$http({method:"GET",url:"".concat(service.portalURL,"meetings/current"),headers:authService.getPostHeader()}).then((function(response){var meetingRoomData=response.data.data;if(meetingRoomData.id){service.currentPersonalAudioRoomId=meetingRoomData.id;var room=service.getRoomById(meetingRoomData.id);room?service.updateRoomData(room,meetingRoomData):service.createRoomFromData(meetingRoomData),defer.resolve(service.getRoomById(meetingRoomData.id))}else{var error=new Error("Wrong data from server");defer.reject(error)}})).catch((function(error){var errorMessage="retrieveCurrentPersonalAudioRoom -- FAILURE -- ".concat(error.message);$log.info("[roomService] ".concat(errorMessage)),defer.reject(new Error(errorMessage))})),defer.promise},service.reUseMeetingRoom=function(roomId){$log.debug("[roomService] reUseMeetingRoom - ".concat(roomId));var defer=$q.defer();if(!roomId){var error=new Error("reUseMeetingRoom - missing parameter");this.logger.error(error.message),defer.reject(error)}return $http({method:"PUT",url:"".concat(service.portalURL,"meetings/").concat(roomId,"/reuse"),headers:authService.getPostHeader()}).then((function(response){var meetingRoomData=response.data.data;if(meetingRoomData.id){var room=service.getRoomById(meetingRoomData.id);room?service.updateRoomData(room,meetingRoomData):service.createRoomFromData(meetingRoomData),defer.resolve(service.getRoomById(meetingRoomData.id))}else{var error=new Error("Wrong data from server");defer.reject(error)}})).catch((function(error){var errorMessage="reUseMeetingRoom -- FAILURE -- ".concat(error.message);$log.error("[roomService] ".concat(errorMessage)),defer.reject(new Error(errorMessage))})),defer.promise},service.deletePersonalMeetingRoom=function(){$log.debug("[roomService] deletePersonalMeetingRoom");var defer=$q.defer();return $http({method:"PUT",url:"".concat(service.portalURL,"meetings/delete"),headers:authService.getPostHeader()}).then((function(response){var meetingRoomData=response.data.data;if(meetingRoomData.id){var room=service.getRoomById(meetingRoomData.id);room?service.updateRoomData(room,meetingRoomData):service.createRoomFromData(meetingRoomData),service.currentPersonalAudioRoomId=meetingRoomData.id,service.personalAudioRoomId=meetingRoomData.id,$rootScope.$broadcast("ON_MEETING_CREATED_EVENT",meetingRoomData.id),defer.resolve(service.getRoomById(meetingRoomData.id))}else{var error=new Error("Wrong data from server");defer.reject(error)}})).catch((function(error){var errorMessage="deletePersonalMeetingRoom -- FAILURE -- ".concat(error.message);$log.error("[roomService] ".concat(errorMessage)),defer.reject(new Error(errorMessage))})),defer.promise},service.saveCurrentPersonalMeetingRoom=function(newName){$log.debug("[roomService] saveCurrentPersonalMeetingRoom");var defer=$q.defer();return $http({method:"PUT",url:"".concat(service.portalURL,"meetings/save"),headers:authService.getPostHeader(),data:{name:newName}}).then((function(response){var meetingRoomData=response.data.data;if(meetingRoomData.id){service.currentPersonalAudioRoomId=meetingRoomData.id;var room=service.getRoomById(meetingRoomData.id);room?service.updateRoomData(room,meetingRoomData):service.createRoomFromData(meetingRoomData),service.currentPersonalAudioRoomId=meetingRoomData.id,service.personalAudioRoomId=meetingRoomData.id,$rootScope.$broadcast("ON_MEETING_CREATED_EVENT",meetingRoomData.id),defer.resolve(service.getRoomById(meetingRoomData.id))}else{var error=new Error("Wrong data from server");defer.reject(error)}})).catch((function(error){var errorMessage="saveCurrentPersonalMeetingRoom -- FAILURE -- ".concat(error.message);throw $log.error("[roomService] ".concat(errorMessage)),new Error(errorMessage)})),defer.promise},service.getPersonalAudioRoomOpenInviteIdLink=function(){return service.getOpenInviteIdLinkForRoom(service.personalAudioRoomId)},service.getOpenInviteIdLinkForRoom=function(roomId){return service.openInviteIdByRoomId[roomId]?service.openInviteIdByRoomId[roomId].openInviteLink:null},service.getOpenInviteIdForRoom=function(roomId){return service.openInviteIdByRoomId[roomId]?service.openInviteIdByRoomId[roomId].openInviteId:null},service.getName=function(room){return room.name},service.sortByName=function(nameA,nameB){return nameA&&nameB&&"string"===nameA.type&&"string"===nameB.type&&nameA.value&&nameB.value?nameA.value.localeCompare(nameB.value):-1},service.sortObjectByProperty=function(property_name){return function(a,b){return a[property_name]<b[property_name]?-1:a[property_name]>b[property_name]?1:0}}}])},function(module,exports){!function(){"use strict";angular.module("rainbow").service("groupService",["$q","$rootScope","$log","$http","authService","contactService","xmppService","Group","usersService","utilService",function($q,$rootScope,$log,$http,authService,contactService,xmppService,Group,usersService,utilService){var service=this;this.started=!1,service.ON_REMOVE_GROUP_USER_EVENT="ON_REMOVE_GROUP_USER_EVENT",service.ON_ADD_GROUP_USER_EVENT="ON_ADD_GROUP_USER_EVENT",service.ON_GROUP_USERS_UPDATE_EVENT="ON_GROUP_USERS_UPDATE_EVENT",service.ON_CREATED_GROUP_EVENT="ON_CREATED_GROUP_EVENT",service.ON_UPDATE_GROUP_EVENT="ON_UPDATE_GROUP_EVENT",service.ON_REMOVED_GROUP_EVENT="ON_REMOVED_GROUP_EVENT",this.start=function(){$log.info(""),$log.info("[groupService] === STARTING ==="),service.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+authService.userId+"/";var defered=$q.defer();return service.$q=$q,service.groups=null,contactService.userContact.isCPaaSGuest()?defered.resolve():(this.attachHandlers(),this.getGroups(),service.started=!0,$log.info("[groupService] === STARTED ==="),defered.resolve(),defered.promise)},this.stop=function(){return $log.info("[groupService] === STOPPING ==="),service.conversations=null,service.groups=null,this.groupMessageHandlerRef&&(xmppService.deleteHandler(this.groupMessageHandlerRef),this.groupMessageHandlerRef=null),this.started=!1,$log.info("[groupService] === STOPPED ==="),$q.when()},this.getGroups=function(){return service.groups?$q.when(service.groups):service.getRemoteGroups()},service.getGroupsAsArray=function(){var groupsArray=[];for(var key in service.groups)service.groups.hasOwnProperty(key)&&groupsArray.push(service.groups[key]);return groupsArray},this.searchGroups=function(criteria){var queries=criteria.toLowerCase().trim().split(/[ ]+/);return service.groups.filter((function(group){var names=group.name.toLowerCase().trim().split(/[ ]+/);return queries.every((function(query){return names.some((function(name,index){return!(!name.length||0!==utilService.removeDiacritis(name).indexOf(utilService.removeDiacritis(query)))&&(names[index]="",group._displayName=utilService.removeDiacritis(group.name),!0)}))}))}))},this.getRemoteGroups=function(){$log.info("[groupService] getGroups");var defered=$q.defer();return $http({method:"GET",url:service.portalURL+"groups?format=full",headers:authService.getRequestHeader()}).then((function(response){var data=response.data.data;$log.info("[groupService] getGroups success (find "+response.data.total+" group(s))"),service.groups=[];var usersPromises=[];return data.forEach((function(groupData){var group=Group.createFromData(groupData);service.groups.push(group),angular.forEach(groupData.users,(function(user_id){usersPromises=contactService.getContactByDBId(user_id).then((function(contact){contact&&group.users.push(contact)}))})),service.logGroupUsers(group),service.sortUsersInGroup(group)})),$q.all(usersPromises)}),(function(response){var errorMessage="getGroups"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})).then((function(){defered.resolve(service.groups)})),defered.promise};var addGroupUserAct=function(group_id,user_id){return $q((function(resolve){service.groups.some((function(group){return group.id===group_id&&(group.users.some((function(user){return user_id===user.dbId}))?(resolve(group),$rootScope.$broadcast(service.ON_ADD_GROUP_USER_EVENT,group_id,user_id),!0):(contactService.getContactByDBId(user_id).then((function(contact){group.users.push(contact),service.sortUsersInGroup(group);var Wgroups=[group];contact.getGroups()?contact.getGroups().push(group):contact.setGroups(Wgroups),$rootScope.$broadcast(service.ON_ADD_GROUP_USER_EVENT,group_id,user_id),resolve(group)})),!0))}))||($rootScope.$broadcast(service.ON_ADD_GROUP_USER_EVENT,group_id,user_id),resolve())}))};this.getGroup=function(group_id){$log.info("[groupService] getGroup  for "+group_id);var defered=$q.defer(),group=null;return $http({method:"GET",url:service.portalURL+"groups/"+group_id,headers:authService.getRequestHeader()}).then((function(response){var groupData=response.data.data,usersPromises=[];return group=Group.createFromData(groupData),$log.info("[groupService] getGroup success for "+group.name+" : "+group.id),service.groups.some((function(item,index){return item.id===groupData.id&&(service.groups[index]=group,angular.forEach(groupData.users,(function(user){usersPromises=contactService.getContactByDBId(user.id).then((function(contact){contact&&(service.groups[index].users.push(contact),service.sortUsersInGroup(service.groups[index]))}))})),!0)}))||(service.groups.push(group),angular.forEach(groupData.users,(function(user){usersPromises=contactService.getContactByDBId(user.id).then((function(contact){if(contact){group.users.push(contact),service.sortUsersInGroup(group);var Wgroups=[group];contact.getGroups()?contact.getGroups().push(group):contact.setGroups(Wgroups)}}))}))),$q.all(usersPromises)}),(function(response){var errorMessage="getGroup"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})).then((function(){defered.resolve(group)})),defered.promise},this.addGroup=function(group){$log.info("[groupService] addGroup : "+group.name);var defered=$q.defer();return $http({method:"POST",url:service.portalURL+"groups",headers:authService.getPostHeader(),data:{name:group.name,comment:group.comment,isFavorite:group.isFavorite}}).then((function(response){$log.info("[groupService] addGroup success for : "+group.name);var groupData=response.data.data,new_group=Group.createFromData(groupData);defered.resolve(new_group)}),(function(response){var errorMessage="addGroup"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})),defered.promise};var removeGroupAct=function(group_id){angular.forEach(service.groups,(function(group,index){group.id===group_id&&service.groups.splice(index,1)}))};this.removeGroup=function(group_id){$log.info("[groupService] removeGroup : "+group_id);var defered=$q.defer();return $http({method:"DELETE",url:service.portalURL+"groups/"+group_id,headers:authService.getRequestHeader()}).then((function(){$log.info("[groupService] removeGroup success for : "+group_id),removeGroupAct(group_id),defered.resolve()}),(function(response){var errorMessage="removeGroup"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})),defered.promise},this.updateGroup=function(group){$log.info("[groupService] updateGroup for : "+group.name);var defered=$q.defer();return $http({method:"PUT",url:service.portalURL+"groups/"+group.id,headers:authService.getRequestHeader(),data:{name:group.name,comment:group.comment,isFavorite:group.isFavorite}}).then((function(){$log.info("[groupService] updateGroup success for : "+group.name),defered.resolve()}),(function(response){var error=service.handleErrorMessage(response,"updateGroup");defered.reject(error),$log.error("[groupService] "+error.message)})),defered.promise},this.getGroupUsers=function(group_id){$log.info("[groupService] getGroupUsers : "+group_id);var defered=$q.defer();return $http({method:"GET",url:service.portalURL+"groups/"+group_id+"/users",headers:authService.getRequestHeader()}).then((function(response){var data=response.data.data;$log.info("[groupService] getGroupUsers success for "+group_id+" (find "+response.data.total+" users(s))"),defered.resolve(data.users)}),(function(response){var errorMessage="getGroupUsers"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})),defered.promise},this.addGroupUser=function(group,user){$log.info("[groupService] addGroupUser");var defered=service.$q.defer();return group.users.some((function(item){return user.dbId===item.dbId}))?($log.info("[groupService] addGroupUser - user: "+user.id+" already exist in group: "+group.name+" - no remote action"),void defered.resolve()):($http({method:"POST",url:service.portalURL+"groups/"+group.id+"/users/"+user.dbId,headers:authService.getPostHeader()}).then((function(response){$log.info("[groupService] addGroupUser success: "+user.id+"/"+group.name),addGroupUserAct(group.id,user.dbId).then((function(updatedGroup){if(updatedGroup)defered.resolve(updatedGroup);else{var groupData=response.data.data,newGroup=Group.createFromData(groupData);defered.resolve(newGroup)}})),$rootScope.$broadcast(service.ON_GROUP_USERS_UPDATE_EVENT)}),(function(response){var errorMessage="addGroupUser"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})),defered.promise)};var removeGroupUserAct=function(group_id,user_id){angular.forEach(service.groups,(function(group){group.id===group_id&&(angular.forEach(group.users,(function(user_item,index){user_item.dbId===user_id&&(group.users.splice(index,1),user_item.getGroups()&&angular.forEach(user_item.getGroups(),(function(user_group_item,g_index){user_group_item.id===group_id&&user_item.getGroups().splice(g_index,1)})))})),service.sortUsersInGroup(group))}))};this.getGroupById=function(group_id){var result=null;return angular.forEach(service.groups,(function(group){group.id===group_id&&(result=group)})),result},this.removeGroupUser=function(group_id,user){$log.info("[groupService] removeGroupUser : "+group_id+"/"+user.id);var defered=$q.defer();return $http({method:"DELETE",url:service.portalURL+"groups/"+group_id+"/users/"+user.dbId,headers:authService.getRequestHeader()}).then((function(){$log.info("[groupService] removeGroupUser success : "+group_id+"/"+user.id),removeGroupUserAct(group_id,user.dbId);var group=service.getGroupById(group_id);$rootScope.$broadcast(service.ON_GROUP_USERS_UPDATE_EVENT),defered.resolve(group)}),(function(response){var errorMessage="removeGroupUser"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})),defered.promise},this.getUserGroups=function(user){if(!user)return $log.info("[groupService] getUserGroups for unknown user !"),$q.when();$log.info("[groupService] getUserGroups for user : "+user.id);var defered=$q.defer(),userGroups=user.getGroups();return userGroups?$q.when(userGroups):($http({method:"GET",url:service.portalURL+"groups?userId="+user.dbId,headers:authService.getRequestHeader()}).then((function(response){var data=response.data.data;$log.info("[groupService] getUserGroups success (find "+response.data.total+" group(s))");var groups=[];data.forEach((function(groupData){var group=Group.createFromData(groupData);groups.push(group)})),user.setGroups(groups),service.logUserGroups(user.displayNameForLog(),groups),defered.resolve(groups)}),(function(response){var errorMessage="getUserGroups"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})),defered.promise)},this.getGroupFromName=function(group_name){$log.info("[groupService] getGroupFromName : "+group_name);var defered=$q.defer();return this.getGroups().then((function(groups){var group=null;groups.forEach((function(item){item.name===group_name&&(group=item)})),defered.resolve(group)})),defered.promise},this.sortUsersInGroup=function(group){group&&(group.sortedUserList=usersService.getFilterAndOrderUsersGroupedByOrderLabelAndUpdateActivity(group.users,$rootScope.orderType,$rootScope.filterType,!0))},this.searchLocalGroup=function(searchText){var groupNamesMatches=[];return $log.info("[groupService] searchLocalGroup with text "+searchText),searchText&&service.groups.forEach((function(gr){gr.name.toLowerCase().indexOf(searchText.toLowerCase().toString())>=0&&groupNamesMatches.push(gr)})),groupNamesMatches},this.extractStanzaData=function(stanza){var defered=$q.defer(),stanzaData={outgoingMessage:!1};return stanzaData.body=angular.element(stanza)[0].firstChild,stanzaData.messageId=angular.element(stanza).attr("id"),defered.resolve(stanzaData),defered.promise},this.onGroupMessageReceived=function(stanza){try{return this.extractStanzaData(stanza).then((function(stanzaData){if(stanzaData.body&&"group"===stanzaData.body.tagName){var action=stanzaData.body.getAttribute("action"),scope=stanzaData.body.getAttribute("scope"),group_id=stanzaData.body.getAttribute("id");switch(scope){case"group":switch(action){case"create":service.getGroup(group_id),$rootScope.$broadcast(service.ON_CREATED_GROUP_EVENT,group_id);break;case"update":var name=stanzaData.body.getAttribute("name"),comment=stanzaData.body.getAttribute("comment"),isFavorite="true"===stanzaData.body.getAttribute("isFavorite");$rootScope.$broadcast(service.ON_UPDATE_GROUP_EVENT,group_id,name,comment,isFavorite);break;case"delete":removeGroupAct(group_id),$rootScope.$broadcast(service.ON_REMOVED_GROUP_EVENT,group_id)}break;case"user":var user_id=stanzaData.body.getAttribute("userId");switch(action){case"create":addGroupUserAct(group_id,user_id);break;case"delete":removeGroupUserAct(group_id,user_id),$rootScope.$broadcast(service.ON_REMOVE_GROUP_USER_EVENT,group_id,user_id)}}}})),!0}catch(error){return!0}},this.attachHandlers=function(){service.removeHandlers(),service.groupMessageHandlerRef||(service.groupMessageHandlerRef=xmppService.addHandler((function(stanza){return service.onGroupMessageReceived(stanza)}),null,"message","management"))},this.removeHandlers=function(){service.groupMessageHandlerRef&&(xmppService.deleteHandler(service.groupMessageHandlerRef),service.groupMessageHandlerRef=null)},this.handleBadRequest=function(message,response){if(400===response.status&&response.data.errorDetails&&response.data.errorDetails.length>0){var fieldErrors={};response.data.errorDetails.forEach((function(details){fieldErrors[details.param]=details.msg}));var error=new Error(message+" failure: BadRequest");return error.fieldErrors=fieldErrors,error}return null},this.handleErrorMessage=function(response){var errorMessage=" failure: ";return 500===response.status&&(errorMessage+="Internal server error"),403===response.status?errorMessage+="Access is forbidden for the current user":404===response.status?errorMessage+=response.data.errorMsg:response.data&&response.data.errorDetails&&(errorMessage+=response.data.errorDetails),errorMessage},this.logUserGroups=function(ownername,groups){var groupsNameContent="";groups&&0!==groups.length&&(groups.forEach((function(gr){gr.name&&(groupsNameContent+=" "+gr.name)})),$log.info("[groupService] logUserGroups for "+ownername+":"+groupsNameContent))},this.logGroupUsers=function(group){var UserNameContent;group&&group.users&&0!==group.users.length&&(UserNameContent=group.users.map((function(user){return user.displayNameForLog()})).join(" / "),$log.info("[groupService] logGroupUsers for "+group.name+": "+UserNameContent))}}])}()},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const call_model_1=__webpack_require__(0),TO_PILLAR_POLLING_MIN=3e5,TO_PILLAR_POLLING_MAX=9e5,TO_PILLAR_POLLING_STEP=TO_PILLAR_POLLING_MAX/500;var MPCallState;!function(MPCallState){MPCallState[MPCallState.Unknow=0]="Unknow",MPCallState[MPCallState.Free=1]="Free",MPCallState[MPCallState.WaitWebrtc=2]="WaitWebrtc",MPCallState[MPCallState.WaitTelephony=3]="WaitTelephony",MPCallState[MPCallState.CallOffer=4]="CallOffer",MPCallState[MPCallState.CallOnGoing=5]="CallOnGoing",MPCallState[MPCallState.CallActive=6]="CallActive",MPCallState[MPCallState.CallActiveNoWebMedia=7]="CallActiveNoWebMedia",MPCallState[MPCallState.TelCallReleasing=8]="TelCallReleasing",MPCallState[MPCallState.WebCallReleasing=9]="WebCallReleasing",MPCallState[MPCallState.RemoteControled=10]="RemoteControled",MPCallState[MPCallState.AnomalyCCS=11]="AnomalyCCS"}(MPCallState||(MPCallState={}));class WebrtcGatewayService{constructor($q,$rootScope,$log,$http,authService,$interval,xmppService,videoService,errorHelperService,contactService,profileService,uuid4,telephonyService,settingsService){this.$q=$q,this.$rootScope=$rootScope,this.$log=$log,this.$http=$http,this.authService=authService,this.$interval=$interval,this.xmppService=xmppService,this.videoService=videoService,this.errorHelperService=errorHelperService,this.contactService=contactService,this.profileService=profileService,this.uuid4=uuid4,this.telephonyService=telephonyService,this.settingsService=settingsService,this.started=!1,this.listeners=[],this.myContact=null,this.mediaPillarContact=null,this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.mediaPillarJid="",this.evtQueue=[],this.SEM=0,this.fakeMediaPillarJid="00a241586a984a869c73719007b27921@demo-all-in-one-dev-1.opentouch.cloud",this.TO_transition=15e3,this.TO_transition_long=3e4,this.TO_NoWebMedia=6e4,this.TO_NoWebMediaNotel=5e3,this.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MIN,this.mediaPillarKeepAliveSuspend=!1}start(stats){let startDate=performance.now();return this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.portalURL=config.restServerUrl+"/api/rainbow/mediapillar/v1.0/mediapillars",this.myContact=this.contactService.userContact,this.mediaPillarContact=null,this.mediaPillarCallContext={callState:MPCallState.Free,keepAlive_TO:null,callState_TO:null,isOutgoingCall3PCC:!1,telephonyCallRefs:[],webrtcCallRef:null,mediaPillarJid:"",rainbowPhoneNumber:"",remoteExtension:"",previousCallConnectionId:null,previousCallStatus:null,updateContactFlag:!1},this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.TELEPHONY_WEBRTC_PSTN_CALLING)?(this.$log.info("[WebrtcGatewayService] === STARTING ==="),this.started=!0,this.SEM=0,this.resetEvtAutomaton(),this.getMediaPillarData().then(mediaPillarJid=>{this.mediaPillarContact=this.createMediaPillarContact(mediaPillarJid),this.mediaPillarCallContext.mediaPillarJid=mediaPillarJid,this.$log.info("[WebrtcGatewayService] Pillar remoteExtension used : "+this.mediaPillarCallContext.remoteExtension),""!==this.mediaPillarCallContext.remoteExtension?this.mediaPillarConfigured=!0:(this.$log.warn("[WebrtcGatewayService] no remoteExtention available "),this.mediaPillarConfigured=!1),this.mediaPillarConfigured&&this.dummyRegisterMediaPillarCall().then(()=>{this.mediaPillarAlive=!0,this.$log.info("[WebrtcGatewayService] Pseudo media pillar register OK with extension "+this.mediaPillarCallContext.remoteExtension),this.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",this.mediaPillarAlive)}).catch(error=>{this.mediaPillarAlive=!1,this.$log.info("[WebrtcGatewayService] Pseudo media pillar register KO"),this.$log.info("[WebrtcGatewayService] Initial polling activated on starting issue"),this.mediaPillarKeepAlivePolling("START",TO_PILLAR_POLLING_MIN),this.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",this.mediaPillarAlive)}),this.listeners.push(this.$rootScope.$on("ON_CONNECTION_STATE_CHANGE_EVENT",(event,status)=>{"disconnected"===status?(this.$log.info("[WebrtcGatewayService] onConnectionStateChangeEvent : disconnected then MP keepalive suspended"),this.mediaPillarKeepAliveSuspend=!0):"connected"===status&&(this.$log.info("[WebrtcGatewayService] onConnectionStateChangeEvent : connected then keepalive as necessary"),this.mediaPillarKeepAliveSuspend=!1,this.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MIN)})),this.listeners.push(this.$rootScope.$on("ON_CALL_UPDATED_EVENT",(event,call,infoEvt)=>{this.onCallEvent(event,call,infoEvt)})),this.listeners.push(this.$rootScope.$on("ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT",(event,call)=>{this.onRemoteCtrlCall(event,call)}));var startDuration=Math.round(performance.now()-startDate);stats.push({service:"WebrtcGatewayService",startDuration:startDuration}),this.$log.info("[WebrtcGatewayService] === STARTED ("+startDuration+" ms) ===")}).catch(error=>{this.mediaPillarCallContext.mediaPillarJid="",this.mediaPillarCallContext.rainbowPhoneNumber="",this.mediaPillarCallContext.remoteExtension="",this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.$log.info("[WebrtcGatewayService] === STARTING FAILURE === "+error.message)})):this.$log.info("[WebrtcGatewayService] === NO WEBRTCGATEWAY ENVOLVED === "),this.$q.when()}stop(){return this.$log.info("[WebrtcGatewayService] === STOPPING ==="),this.started=!1,this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.mediaPillarKeepAlivePolling("STOP",0),this.mediaPillarCallContext&&(this.releaseMediaPillarCallContext(),this.mediaPillarCallContext.callState=MPCallState.Unknow,this.mediaPillarCallContext.mediaPillarJid="",this.mediaPillarCallContext.rainbowPhoneNumber="",this.mediaPillarCallContext.remoteExtension=""),this.listeners&&this.listeners.forEach(unregisterListener=>{unregisterListener()}),this.$log.info("[WebrtcGatewayService] === STOPPED ==="),this.$q.resolve()}onCallEvent(__event,call,infoEvt){if(this.isMediaPillarCallCase()){if(this.SEM++,this.$log.info("[WebrtcGatewayService] onCallEvent IN("+this.SEM+") state = "+this.mediaPillarCallContext.callState),this.$log.info("[WebrtcGatewayService] onCallEvent "+this.mediaPillarCallContext.callState+" --- "+call.type.value+"("+call.id+","+call.status.value+")"),infoEvt&&null!==infoEvt&&(this.$log.info("[WebrtcGatewayService] onCallEvent tel infoEvt : Evt = "+infoEvt.actionElemName+" / cause = "+infoEvt.cause),"updatecall"===infoEvt.actionElemName&&(this.mediaPillarCallContext.updateContactFlag=!0,this.$log.info("[WebrtcGatewayService] updateContactFlag = true"))),call.connectionId===this.mediaPillarCallContext.previousCallConnectionId&&call.status===this.mediaPillarCallContext.previousCallStatus&&!this.mediaPillarCallContext.updateContactFlag)return this.mediaPillarCallContext.previousCallConnectionId=call.connectionId,this.mediaPillarCallContext.previousCallStatus=call.status,this.$log.info("[WebrtcGatewayService] onCallEvent | DEBOUNCE EVT"),this.SEM--,void this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+")");if(call.type.value===call_model_1.Call.Type.PHONE.value&&null===call.id)return this.mediaPillarCallContext.previousCallConnectionId=call.connectionId,this.mediaPillarCallContext.previousCallStatus=call.status,this.$log.info("[WebrtcGatewayService] onCallEvent | FILTER EVT null/error"),this.SEM--,void this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+")");if(this.mediaPillarCallContext.previousCallConnectionId=call.connectionId,this.mediaPillarCallContext.previousCallStatus=call.status,this.evtQueue.push(call),this.evtQueue.length>1)return this.SEM--,void this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+") evt pushed = "+call.status.value);for(;this.evtQueue.length;){try{this.processEvt(this.evtQueue[0])}catch(error){this.$log.error("[WebrtcGatewayService] onCallEvent queue processing | call : "+this.evtQueue[0].status.value+" Error : "+error)}this.evtQueue.splice(0,1)}this.SEM--,this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+") state = "+this.mediaPillarCallContext.callState),0!==this.SEM&&(this.$log.error("[WebrtcGatewayService] onCallEvent OUT | Unmanaged Eventing Reentrancy Situation"),this.resetEvtAutomaton(),this.SEM=0)}}processEvt(call){if(this.$log.info("[WebrtcGatewayService] processEvt | process "+call.type.value+"("+call.id+","+call.status.value+") in MPcontextCallstate = "+this.mediaPillarCallContext.callState),call.type.value===call_model_1.Call.Type.PHONE.value){var telCallsNumber=this.telephonyService.getCalls().length;if((()=>{let ignoreEvt=!1;return call.status===call_model_1.Call.Status.DIALING&&(call.isSecondary=!0),call.isSecondary?call.status===call_model_1.Call.Status.UNKNOWN||call.status===call_model_1.Call.Status.RINGING_INCOMMING||call.status===call_model_1.Call.Status.QUEUED_INCOMMING||call.status===call_model_1.Call.Status.ACTIVE?(this.addTelCallRefs(call),ignoreEvt=!1):this.mediaPillarCallContext.callState===MPCallState.RemoteControled?(this.$log.info("[WebrtcGatewayService] processEvt |  RemoteControled state for call : "+call.id+" then ignore"),ignoreEvt=!0):(this.addTelCallRefs(call),this.mediaPillarCallContext.telephonyCallRefs.length>1?(this.$log.info("[WebrtcGatewayService] processEvt |  nthCall : "+this.mediaPillarCallContext.telephonyCallRefs.length+" then ignore"),ignoreEvt=!0):ignoreEvt):(this.$log.info("[WebrtcGatewayService] processEvt | NOT SECONDARY then ignore"),ignoreEvt=!0)})())this.$log.info("[WebrtcGatewayService] processEvt |  call("+call.id+" / SEC "+call.isSecondary+", "+call.status.value+") -> EVT IGNORED"),this.$log.info("[WebrtcGatewayService] processEvt |  telephonyCallRefs.length = "+this.mediaPillarCallContext.telephonyCallRefs.length),this.$log.info("[WebrtcGatewayService] processEvt |  calls.length = "+telCallsNumber);else switch(this.$log.info("[WebrtcGatewayService] processEvt |  call("+call.id+" / SEC "+call.isSecondary+", "+call.status.value+") -> EVT PROCESSED"),this.$log.info("[WebrtcGatewayService] processEvt |  telephonyCallRefs.length = "+this.mediaPillarCallContext.telephonyCallRefs.length),this.$log.info("[WebrtcGatewayService] processEvt |  calls.length = "+telCallsNumber),call.status){case call_model_1.Call.Status.RINGING_INCOMMING:this.onTelCallIncomming(call);break;case call_model_1.Call.Status.DIALING:this.onTelCallDialling(call);break;case call_model_1.Call.Status.RINGING_OUTGOING:this.onTelCallOutgoing(call);break;case call_model_1.Call.Status.ACTIVE:this.onTelCallActive(call);break;case call_model_1.Call.Status.UNKNOWN:this.onTelCallReleasing(call)}}else if(this.isMediaPillarJid(this.xmppService.getBareJidFromJid(call.fullJid)))switch(call.status){case call_model_1.Call.Status.RINGING_INCOMMING:this.onWebrtcCallIncomming(call);break;case call_model_1.Call.Status.CONNECTING:this.onWebrtcCallConnecting(call);break;case call_model_1.Call.Status.ACTIVE:this.onWebrtcCallActive(call);break;case call_model_1.Call.Status.ANSWERING:this.onWebrtcCallAnswering(call);break;case call_model_1.Call.Status.UNKNOWN:this.onWebrtcCallReleasing(call)}else this.$log.info("[WebrtcGatewayService] processEvt | process call("+call.id+","+call.status.value+") -> Not a webrtcgateway case")}releaseMediaPillarCallContext(){this.mediaPillarCallContext.callState=MPCallState.Free,this.stopCallStateTimeOut(),this.mediaPillarCallContext.isOutgoingCall3PCC=!1,this.mediaPillarCallContext.updateContactFlag=!1,this.mediaPillarCallContext.telephonyCallRefs.length>0&&this.$log.warn("[WebrtcGatewayService] releaseMediaPillarCallContext | reset context but telephonyCallRefs not empty !"),null!==this.mediaPillarCallContext.webrtcCallRef&&this.$log.warn("[WebrtcGatewayService] releaseMediaPillarCallContext | reset context but webrtcCallRef not null !"),this.mediaPillarCallContext.telephonyCallRefs=[],this.mediaPillarCallContext.webrtcCallRef=null,this.mediaPillarCallContext.previousCallConnectionId=null,this.mediaPillarCallContext.previousCallStatus="",this.$log.log("[WebrtcGatewayService] releaseMediaPillarCallContext | =====  mediaPillarCallContext RELEASED  ===== ")}resetEvtAutomaton(){this.evtQueue=[]}stopCallStateTimeOut(){this.mediaPillarCallContext.callState_TO&&this.$interval.cancel(this.mediaPillarCallContext.callState_TO),this.mediaPillarCallContext.callState_TO=null}onRemoteCtrlCall(__event,call){this.$log.info("[WebrtcGatewayService] onRemoteCtrlCall for call "+call.id+" in previous state: "+this.mediaPillarCallContext.callState+": => Becomes REMOTECONTROLED"),this.mediaPillarCallContext.callState=MPCallState.RemoteControled,this.stopCallStateTimeOut()}addTelCallRefs(callRef){if(null==callRef)return void this.$log.warn("[WebrtcGatewayService] addTelCallRefs | ANOMALY callRef not valid");let alreadyIn=!1;for(var i=0;i<this.mediaPillarCallContext.telephonyCallRefs.length;i++)this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs[i].id===callRef.id&&(alreadyIn=!0);alreadyIn||this.mediaPillarCallContext.telephonyCallRefs.push(callRef)}removeTelCallRefs(callRef){if(null==callRef)return void this.$log.warn("[WebrtcGatewayService] removeTelCallRefs | ANOMALY callRef not valid");let i=0;for(;i<this.mediaPillarCallContext.telephonyCallRefs.length;)this.mediaPillarCallContext.telephonyCallRefs[i].id===callRef.id?(this.mediaPillarCallContext.telephonyCallRefs.splice(i,1),0===i&&this.mediaPillarCallContext.telephonyCallRefs.length&&(this.mediaPillarCallContext.telephonyCallRefs[0].setMediaPillarCall(this.getMediaPillarCallContext()),this.$log.log("[WebrtcGatewayService] removeTelCallRefs | master MP call becomes : "+this.mediaPillarCallContext.telephonyCallRefs[0].id))):i++}putAsMasterTelCallRefs(callRef){if(null==callRef)return void this.$log.warn("[WebrtcGatewayService] putAsMasterTelCallRefs | ANOMALY callRef not valid");let i=-1;for(var j=0;j<this.mediaPillarCallContext.telephonyCallRefs.length;j++)this.mediaPillarCallContext.telephonyCallRefs[j].id===callRef.id&&(i=j);if(this.$log.log("[WebrtcGatewayService] putAsMasterTelCallRefs | master MP call is : "+callRef.id),0!==i)if(-1!==i){let replace=this.mediaPillarCallContext.telephonyCallRefs[0];this.mediaPillarCallContext.telephonyCallRefs[0]=callRef,this.mediaPillarCallContext.telephonyCallRefs[i]=replace,callRef.setMediaPillarCall(this.getMediaPillarCallContext())}else this.$log.warn("[WebrtcGatewayService] putAsMasterTelCallRefs | Anomaly call not in telephonyCallRefs")}isMasterTelCallRefs(callRef){return null==callRef?(this.$log.warn("[WebrtcGatewayService] isMasterTelCallRefs | ANOMALY callRef not valid"),!1):0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs[0].id===callRef.id}isInTelCallRefs(callRef){if(null==callRef)return void this.$log.warn("[WebrtcGatewayService] isInTelCallRefs | ANOMALY callRef not valid");let i=-1;for(var j=0;j<this.mediaPillarCallContext.telephonyCallRefs.length;j++)this.mediaPillarCallContext.telephonyCallRefs[j].id===callRef.id&&(i=j);return-1!==i}replaceCallRefs(newCallRef,oldCallRef){if(null==newCallRef||null==oldCallRef)return void this.$log.warn("[WebrtcGatewayService] replaceCallRefs | ANOMALY callRef not valid");let flagNewAlreadyExist=!1,flagNewLinked=newCallRef.isMediaPillarCall(),flagOldLinked=oldCallRef.isMediaPillarCall();this.isInTelCallRefs(newCallRef)&&(flagNewAlreadyExist=!0,this.$log.warn("[WebrtcGatewayService] replaceCallRefs | ANOMALY newcallRef already existing"),this.removeTelCallRefs(newCallRef));let i=-1;for(var j=0;j<this.mediaPillarCallContext.telephonyCallRefs.length;j++)this.mediaPillarCallContext.telephonyCallRefs[j].id===oldCallRef.id&&(i=j);-1!==i?(this.mediaPillarCallContext.telephonyCallRefs[i]=newCallRef,flagOldLinked&&newCallRef.setMediaPillarCall(this.getMediaPillarCallContext()),oldCallRef.setMediaPillarCall(null),0===i&&this.$log.log("[WebrtcGatewayService] replaceCallRefs | master MP call becomes : "+this.mediaPillarCallContext.telephonyCallRefs[0].id)):(this.$log.warn("[WebrtcGatewayService] replaceCallRefs | ANOMALY oldCallRef not found"),flagNewAlreadyExist&&(this.addTelCallRefs(newCallRef),flagNewLinked&&newCallRef.setMediaPillarCall(this.getMediaPillarCallContext())))}automatonDefenseTimout(call){let actionLevel=0;if(null!=call)if(call.type.value===call_model_1.Call.Type.PHONE.value)switch(this.$log.log("[WebrtcGatewayService] automatonDefenseTimout | transition telcall call="+call.id+" evt="+call.status.value+" then timout"),call.status){case call_model_1.Call.Status.RINGING_OUTGOING:case call_model_1.Call.Status.RINGING_INCOMMING:break;default:this.mediaPillarCallContext.callState!==MPCallState.CallActive&&this.mediaPillarCallContext.callState!==MPCallState.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==MPCallState.CallOffer&&this.mediaPillarCallContext.callState!==MPCallState.CallOnGoing&&(actionLevel=2)}else if(this.isMediaPillarJid(this.xmppService.getBareJidFromJid(call.fullJid)))switch(this.$log.log("[WebrtcGatewayService] automatonDefenseTimout | transition webrtc "+call.status.value+" then timout"),call.status){case call_model_1.Call.Status.ACTIVE:break;default:this.mediaPillarCallContext.callState!==MPCallState.CallActive&&this.mediaPillarCallContext.callState!==MPCallState.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==MPCallState.CallOffer&&this.mediaPillarCallContext.callState!==MPCallState.CallOnGoing&&(actionLevel=3)}else this.$log.warn("[WebrtcGatewayService] automatonDefenseTimout | anomaly transition webrtc call but Not a webrtcgateway case"),actionLevel=2;else this.mediaPillarCallContext.callState!==MPCallState.CallActive&&this.mediaPillarCallContext.callState!==MPCallState.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==MPCallState.RemoteControled&&this.mediaPillarCallContext.callState!==MPCallState.CallOffer&&this.mediaPillarCallContext.callState!==MPCallState.CallOnGoing&&(this.$log.log("[WebrtcGatewayService] automatonDefenseTimout | anomaly timout in unexpected state"),actionLevel=2);switch(0!==actionLevel&&this.$log.warn("[WebrtcGatewayService] automatonDefenseTimout | actionlevel "+actionLevel),actionLevel){case 0:break;case 1:this.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MIN,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING);break;case 2:this.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MIN,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.releaseMediaPillarCallContext();break;case 3:this.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MIN,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.MediaPillarReleaseWebrtcCall(),this.releaseMediaPillarCallContext();break;default:this.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MIN,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.MediaPillarCallTerminator()}this.mediaPillarCallContext.callState!==MPCallState.Free&&(this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(null)},this.TO_transition,1))}onTelCallIncomming(call){if(this.mediaPillarCallContext.telephonyCallRefs.length>1&&this.mediaPillarCallContext.callState!==MPCallState.Free&&this.mediaPillarCallContext.callState!==MPCallState.WaitTelephony&&this.mediaPillarCallContext.callState!==MPCallState.WaitWebrtc)return this.$log.info("[WebrtcGatewayService] onTelCallIncomming | nth calls BUT trig the GUI & link the call"),call.setMediaPillarCall(this.getMediaPillarCallContext()),this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ON_CONVERSATION_CALL_UPDATED_EVENT for call = "+call.id),this.mediaPillarCallContext.updateContactFlag=!0,void this.$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:call});switch(this.$log.info("[WebrtcGatewayService] onTelCallIncomming | mediapilaryse as necessary for call "+call.id),this.mediaPillaryseTheCall(call,null)){case"Ok":if(this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1),!this.isMediaPillarOutgoingCall()&&this.mediaPillarCallContext.callState===MPCallState.CallOffer&&this.mediaPillarCallContext.webrtcCallRef)for(var i=0;i<this.mediaPillarCallContext.telephonyCallRefs.length;i++)this.mediaPillarCallContext.telephonyCallRefs[i].status!==call_model_1.Call.Status.RINGING_INCOMMING&&this.mediaPillarCallContext.telephonyCallRefs[i].status!==call_model_1.Call.Status.QUEUED_INCOMMING||(this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ON_CONVERSATION_CALL_UPDATED_EVENT for call = "+call.id),this.mediaPillarCallContext.updateContactFlag=!0,this.$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:this.mediaPillarCallContext.telephonyCallRefs[i]}));break;case"Update":this.stopCallStateTimeOut(),this.isMediaPillarOutgoingCall()||!this.mediaPillarCallContext.webrtcCallRef||call.status!==call_model_1.Call.Status.RINGING_INCOMMING&&call.status!==call_model_1.Call.Status.QUEUED_INCOMMING?this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ignore update call"):(this.$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:call}),this.$log.info("[WebrtcGatewayService] onTelCallIncomming | update call"));break;case"Ignore":this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ignore evt");break;default:this.$log.error("[WebrtcGatewayService] onTelCallIncomming | media Pillar call anomaly "+status)}}onTelCallDialling(call){if(this.mediaPillarCallContext.callState===MPCallState.Free||this.mediaPillarCallContext.callState===MPCallState.WaitTelephony)switch(this.mediaPillarCallContext.isOutgoingCall3PCC=!0,this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1),this.mediaPillaryseTheCall(call,null)){case"Ok":this.mediaPillarCallContext.webrtcCallRef&&this.mediaPillarCallContext.callState===MPCallState.CallOffer&&(this.videoService.answerCall(this.mediaPillarCallContext.webrtcCallRef,"audio"),this.$log.info("[WebrtcGatewayService] onTelCallDialling | outgoing3PCC then send webrtc proceed")),this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1);break;case"Ignore":case"Update":this.$log.info("[WebrtcGatewayService] onTelCallDialling | ignore evt");break;default:this.$log.error("[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly "+status),this.MediaPillarCallTerminator()}else this.mediaPillarCallContext.callState===MPCallState.CallOffer||this.mediaPillarCallContext.callState===MPCallState.CallOnGoing?(this.$log.warn("[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly, on state : "+this.mediaPillarCallContext.callState),this.$log.info("[WebrtcGatewayService] onTelCallDialling | ignored , on state : "+this.mediaPillarCallContext.callState)):(this.$log.warn("[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly, MP context not compatible"),this.MediaPillarCallTerminator())}onTelCallOutgoing(call){this.isMediaPillarOutgoingCall()?(this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition_long,1)):(this.$log.warn("[WebrtcGatewayService] onTelCallOutgoing | media Pillar, not a 1st 3PCC outgoing call then ignore & release MP CallContext"),this.releaseMediaPillarCallContext())}onTelCallActive(call){switch(this.mediaPillarCallContext.callState){case MPCallState.CallOnGoing:this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState=MPCallState.CallActive;break;case MPCallState.TelCallReleasing:this.$log.warn("[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state = "+this.mediaPillarCallContext.callState),this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar , RE-ACTIVATION"),this.stopCallStateTimeOut(),call.setMediaPillarCall(this.getMediaPillarCallContext()),this.mediaPillarCallContext.callState=MPCallState.CallActive;break;case MPCallState.CallActive:this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar , ignore tel active on state CallActive ");break;case MPCallState.WebCallReleasing:this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state WebCallReleasing then releaseMediaPillarCallContext"),this.releaseMediaPillarCallContext();break;case MPCallState.Free:this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state = 1 ; probably call taken on deskphone ; ignore active & release call context "),this.releaseMediaPillarCallContext();break;default:this.$log.info("[WebrtcGatewayService] onTelCallActive | Anomaly media Pillar recv tel active on state = "+this.mediaPillarCallContext.callState)}}onTelCallReleasing(call){this.telephonyService.getCalls().length;if(this.mediaPillarCallContext.telephonyCallRefs.length>1)return call.setMediaPillarCall(null),this.removeTelCallRefs(call),void this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+call.id+" -- postpone mediaPillarCallContext release ;  remaining calls = "+this.mediaPillarCallContext.telephonyCallRefs.length);this.isMediaPillarReleasableCall()?(call.setMediaPillarCall(null),this.removeTelCallRefs(call),this.mediaPillarCallContext.webrtcCallRef&&this.mediaPillarCallContext.callState!==MPCallState.WebCallReleasing&&this.mediaPillarCallContext.callState!==MPCallState.RemoteControled?this.mediaPillarCallContext.callState!==MPCallState.TelCallReleasing?(this.mediaPillarCallContext.callState=MPCallState.TelCallReleasing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1),this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+call.id+" -- wait web release: state = "+this.mediaPillarCallContext.callState)):this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+call.id+" -- ignore telrelease on state = "+this.mediaPillarCallContext.callState):this.mediaPillarCallContext.callState!==MPCallState.Free&&(this.releaseMediaPillarCallContext(),this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+call.id+" -- release MP context"))):(this.$log.warn("[WebrtcGatewayService] onTelCallReleasing | media Pillar call release anomaly on state = "+this.mediaPillarCallContext.callState),this.MediaPillarCallTerminator())}onWebrtcCallIncomming(call){if(this.mediaPillarCallContext.webrtcCallRef)this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming -- "+call.id+" --- ignored other incomming");else{if(this.mediaPillarCallContext.callState===MPCallState.WebCallReleasing&&0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs[0].status!==call_model_1.Call.Status.UNKNOWN)return this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming -- "+call.id+" --- re propose during established tel call"),this.mediaPillarCallContext.webrtcCallRef=call,this.videoService.answerCall(this.mediaPillarCallContext.webrtcCallRef,"audio"),this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1),void(this.mediaPillarCallContext.callState=MPCallState.CallOnGoing);switch(this.mediaPillaryseTheCall(null,call)){case"Ok":if(this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1),this.isMediaPillarOutgoingCall())this.videoService.answerCall(this.mediaPillarCallContext.webrtcCallRef,"audio"),this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming | outgoing3PCC then send webrtc proceed");else if(this.mediaPillarCallContext.callState===MPCallState.CallOffer)for(var i=0;i<this.mediaPillarCallContext.telephonyCallRefs.length;i++)this.mediaPillarCallContext.telephonyCallRefs[i].status!==call_model_1.Call.Status.RINGING_INCOMMING&&this.mediaPillarCallContext.telephonyCallRefs[i].status!==call_model_1.Call.Status.QUEUED_INCOMMING||(this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming | ON_CONVERSATION_CALL_UPDATED_EVENT for call = "+this.mediaPillarCallContext.telephonyCallRefs[i].id),this.$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:this.mediaPillarCallContext.telephonyCallRefs[i]}));break;case"Ignore":break;default:this.$log.error("[WebrtcGatewayService] onWebrtcCallIncomming | media Pillar call anomaly "+status)}}}onWebrtcCallConnecting(call){return this.mediaPillarCallContext.callState===MPCallState.CallActive?(this.$log.info("[WebrtcGatewayService] onWebrtcCallConnecting -- media Pillar call reconnecting attempts"),this.mediaPillarCallContext.callState=MPCallState.CallActiveNoWebMedia,this.stopCallStateTimeOut(),void(this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.timeOutCallActiveNoWebMedia()},this.TO_NoWebMedia,1))):this.mediaPillarCallContext.callState===MPCallState.TelCallReleasing?(this.$log.info("[WebrtcGatewayService] onWebrtcCallConnecting -- media Pillar webrtc call reconnecting while TelCallReleasing"),this.mediaPillarCallContext.callState=MPCallState.CallActiveNoWebMedia,this.stopCallStateTimeOut(),void(this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.timeOutCallActiveNoWebMedia()},this.TO_NoWebMediaNotel,1))):void 0}onWebrtcCallActive(call){this.mediaPillarCallContext.callState===MPCallState.CallActiveNoWebMedia&&(this.$log.info("[WebrtcGatewayService] onWebrtcCallConnecting -- media Pillar call reconnected"),this.mediaPillarCallContext.callState=MPCallState.CallActive,this.stopCallStateTimeOut())}onWebrtcCallAnswering(call){this.mediaPillarCallContext.callState=MPCallState.CallOnGoing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1)}onWebrtcCallReleasing(call){this.isMediaPillarReleasableCall()?(call.setMediaPillarCall(null),this.mediaPillarCallContext.webrtcCallRef=null,0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.callState!==MPCallState.TelCallReleasing&&this.mediaPillarCallContext.callState!==MPCallState.RemoteControled?this.mediaPillarCallContext.callState!==MPCallState.WebCallReleasing?(this.mediaPillarCallContext.callState=MPCallState.WebCallReleasing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1),this.releasePbxCallIfPbxConnectionDown(),this.$log.info("[WebrtcGatewayService] onWebrtcCallReleasing -- "+call.id+" -- wait tel release: state = "+this.mediaPillarCallContext.callState)):this.$log.info("[WebrtcGatewayService] onWebrtcCallReleasing -- "+call.id+" -- ignore webrelease on state = "+this.mediaPillarCallContext.callState):(this.releaseMediaPillarCallContext(),this.$log.info("[WebrtcGatewayService] onWebrtcCallReleasing -- "+call.id+" -- release MP context"))):(this.$log.warn("[WebrtcGatewayService] onWebrtcCallReleasing | media Pillar call release anomaly on state = "+this.mediaPillarCallContext.callState),this.MediaPillarCallTerminator())}releasePbxCallIfPbxConnectionDown(){let activePbxCall=this.getActivePbxCall();activePbxCall&&activePbxCall.pbxConnectionDown&&(this.$log.info("[WebrtcGatewayService] releasePbxCallIfPbxConnectionDown | release call"+activePbxCall),this.telephonyService.releaseCall(activePbxCall),activePbxCall.mediaPillarCall=null)}mediaPillarMakeCall(phoneNumber,contact){this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall");let mediaPillarJid=this.getMyMediaPillarJid();if(phoneNumber.length>6&&contact&&(phoneNumber=contact.phonePbx),this.videoService.makingCall=!0,""!==mediaPillarJid){var call,id="web_"+this.uuid4.generate();if(contact&&null!==contact)(call=call_model_1.Call.create(call_model_1.Call.Status.DIALING,id,call_model_1.Call.Type.WEBRTC,contact)).fullJid=mediaPillarJid,this.mediaPillarStartCall(call,phoneNumber,mediaPillarJid);else(call=call_model_1.Call.create(call_model_1.Call.Status.DIALING,id,call_model_1.Call.Type.WEBRTC,this.mediaPillarContact)).fullJid=mediaPillarJid,this.mediaPillarStartCall(call,phoneNumber,mediaPillarJid)}else this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall ANOMALY no mediaPillarJid")}mediaPillarStartCall(call,phoneNumber,mediaPillarJid){this.$log.info("[WebrtcGatewayService] mediaPillarStartCall for phone number "+phoneNumber),this.initiateMediaPillarCall(call).then(()=>{this.dummyRegisterMediaPillarCall().then(()=>{this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall for number "+phoneNumber),this.videoService.makeJingleCall(call,mediaPillarJid,phoneNumber)}).catch(error=>{this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall ANOMALY dummyRegisterMediaPillarCall then abort call"),this.abortCall(call)})}).catch(error=>{this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall ANOMALY initiateMediaPillarCall then abort call"),this.abortCall(call)})}abortCall(call){this.videoService.makingCall=!1,call&&this.videoService.removeCallObject(call),this.videoService.resetToSafeState()}initiateMediaPillarCall(call){return this.$q((resolve,reject)=>{this.$log.info("[WebrtcGatewayService] initiateMediaPillarCall");var mediaToGet=["audio"];this.videoService.getBrowserMedia(mediaToGet).then(stream=>{call.isInitiator=!0,this.videoService.localStreams.push(stream),this.videoService.calls[call.id]=call,call.localMedia=call.localMedia|call_model_1.Call.Media.AUDIO,this.contactService.setBusyState("dnd",this.videoService.calculatePresenceMessage(call)),this.$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve()}).catch(error=>{this.$log.info("[WebrtcGatewayService]   | initate call failure : "+JSON.stringify({error:error.message})),mediaToGet.indexOf("sharing")>=0||-1===error.toString().indexOf("getUserMedia")||this.videoService.openErrorPopup(),reject(error)})})}dummyRegisterMediaPillarCall(){return this.$q((resolve,reject)=>{var xmppIq=$iq({from:this.myContact.fullJid,to:this.mediaPillarCallContext.mediaPillarJid,type:"set"}).c("mediapillar",{xmlns:"urn:xmpp:janus:1"}).c("register").c("jidIm").t(this.contactService.userContact.jid).up().c("jidTel").t(this.contactService.userContact.jidtel).up().c("number").t(this.mediaPillarCallContext.rainbowPhoneNumber).up().c("displayName").t(this.myContact.displayName).up().c("secret").t(this.mediaPillarCallContext.rainbowPhoneNumber).up();this.xmppService.sendIQ(xmppIq).then(data=>{resolve()}).catch(error=>{this.IsMediaPillarUserSelected()&&this.$log.warn("[WebrtcGatewayService] dummyRegisterMediaPillarCall -- register failure -- "+error.message),reject(error)})})}getMediaPillarData(){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/data",headers:this.authService.getRequestHeader()}).then(response=>{if(this.$log.log("[WebrtcGatewayService] getMediaPillarData success"),response.data&&response.data.data){let prefix=response.data.data.prefix,rainbowPhoneNumber=response.data.data.rainbowPhoneNumber;prefix&&rainbowPhoneNumber&&(this.mediaPillarCallContext.rainbowPhoneNumber=rainbowPhoneNumber,this.mediaPillarCallContext.remoteExtension=prefix+rainbowPhoneNumber);let jid=response.data.data.jid_im;jid&&-1===jid.indexOf("/")&&(jid+="/mediapillar"),resolve(jid)}else this.$log.error("[WebrtcGatewayService] getMediaPillarData success -- missing data"),reject(new Error("[WebrtcGatewayService] getMediaPillarData -- missing data in response"))}).catch(errorResponse=>{let error=this.errorHelperService.handleError(errorResponse);this.$log.info("[WebrtcGatewayService] getMediaPillarData error -- "+error.message),reject(error)})})}mediaPillarKeepAlivePolling(cmd,timer){if(this.started)switch(cmd){case"START":this.mediaPillarCallContext&&this.mediaPillarCallContext.keepAlive_TO&&(this.$interval.cancel(this.mediaPillarCallContext.keepAlive_TO),this.mediaPillarCallContext.keepAlive_TO=null),this.mediaPillarCallContext.keepAlive_TO=this.$interval(()=>{this.mediaPillarKeepAlive()},timer,1);break;case"STOP":this.mediaPillarCallContext&&this.mediaPillarCallContext.keepAlive_TO&&this.$interval.cancel(this.mediaPillarCallContext.keepAlive_TO),this.mediaPillarCallContext.keepAlive_TO=null;break;default:this.$log.error("[WebrtcGatewayService] mediaPillarKeepAlivePolling cmd error : "+cmd)}}mediaPillarUserSelectAndPolling(selected){this.started&&(this.$log.log("[WebrtcGatewayService] mediaPillarUserSelectAndPolling : "+selected),selected?(this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.mediaPillarKeepAlive()):this.mediaPillarAlive&&this.mediaPillarKeepAlivePolling("STOP",0))}mediaPillarKeepAlive(){if(this.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive"),this.mediaPillarKeepAliveSuspend)this.$log.info("[WebrtcGatewayService] KeepAlive suspended");else{let newSampleMediaPillarState=!1;this.dummyRegisterMediaPillarCall().then(()=>{newSampleMediaPillarState=!0,this.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive webrtcgateway is UP")}).catch(error=>{newSampleMediaPillarState=!1,this.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive webrtcgateway is DOWN")}).finally(()=>{this.mediaPillarAlive!==newSampleMediaPillarState&&(this.mediaPillarAlive=newSampleMediaPillarState,this.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",this.mediaPillarAlive),this.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive ON_WEBRTCGATEWAY_STATE_CHG")),this.mediaPillarAlive?this.TO_PILLAR_POLLING<TO_PILLAR_POLLING_MAX?this.TO_PILLAR_POLLING+=TO_PILLAR_POLLING_STEP:this.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MAX:(this.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MIN,this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING)),this.IsMediaPillarUserSelected()&&this.mediaPillarAlive&&this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING)})}}forceMPpooling(){this.started&&(this.$log.log("[WebrtcGatewayService] forceMPpooling "),this.TO_PILLAR_POLLING=TO_PILLAR_POLLING_MIN,this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",this.mediaPillarAlive))}getMyMediaPillarJid(){return this.$log.info("[WebrtcGatewayService] getMyMediaPillarJid : "+this.mediaPillarCallContext.mediaPillarJid),this.mediaPillarCallContext.mediaPillarJid}getMyMediaPillarRemoteExtension(){return this.mediaPillarCallContext.remoteExtension}shouldUseMediaPillar(){this.isMediaPillarAvailable()&&this.IsMediaPillarUserSelected();return void 0!==config.devMediaPillarEnabled&&config.devMediaPillarEnabled||!1,!1}isMediaPillarConfigured(){return this.mediaPillarConfigured&&this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.TELEPHONY_WEBRTC_PSTN_CALLING)}isMediaPillarAvailable(){var available=this.isMediaPillarConfigured();return available=available&&this.mediaPillarAlive}IsMediaPillarUserSelected(){return!this.telephonyService.nomadicObject.makeCallInitiatorIsMain&&this.telephonyService.getNomadicDestination()===this.getMyMediaPillarRemoteExtension()}isMediaPillarJid(fromJid){let indexMPinJid=-1;return!!fromJid&&0===(indexMPinJid=fromJid.search("mp_"))}isMediaPillarCallCase(){return this.isMediaPillarAvailable()&&this.IsMediaPillarUserSelected()}isMediaPillarCallSituation(call){var MP_situation=this.isMediaPillarCallCase();if(call)if(call.type===call_model_1.Call.Type.WEBRTC)MP_situation=MP_situation&&this.isMediaPillarJid(call.fullJid);else if(this.telephonyService.getCalls().length<=1&&this.mediaPillarCallContext.telephonyCallRefs.length<=1)switch(call.status){case call_model_1.Call.Status.RINGING_INCOMMING:case call_model_1.Call.Status.RINGING_OUTGOING:case call_model_1.Call.Status.QUEUED_INCOMMING:case call_model_1.Call.Status.DIALING:case call_model_1.Call.Status.RELEASING:break;default:MP_situation=!!call.mediaPillarCall&&(MP_situation&&this.isInTelCallRefs(call))}else switch(call.status){case call_model_1.Call.Status.RINGING_INCOMMING:case call_model_1.Call.Status.RINGING_OUTGOING:case call_model_1.Call.Status.QUEUED_INCOMMING:case call_model_1.Call.Status.DIALING:case call_model_1.Call.Status.RELEASING:break;default:MP_situation=!!call.mediaPillarCall&&((MP_situation=MP_situation&&call.mediaPillarCall.telephonyCallRefs.length>=1)&&this.isInTelCallRefs(call))}return MP_situation}mediaPillaryseTheCall(telephonyCall,webrtcCall){if(this.mediaPillarCallContext.callState!==MPCallState.Free){if(telephonyCall&&this.mediaPillarCallContext.updateContactFlag)return this.$log.info("[WebrtcGatewayService] mediaPillaryseTheCall | only Update"),telephonyCall.setMediaPillarCall(this.getMediaPillarCallContext()),"Update";if(telephonyCall&&this.mediaPillarCallContext.callState===MPCallState.TelCallReleasing&&telephonyCall.status===call_model_1.Call.Status.RINGING_INCOMMING)return this.$log.info("[WebrtcGatewayService] mediaPillaryseTheCall |  transfer managed as Update"),telephonyCall.setMediaPillarCall(this.getMediaPillarCallContext()),this.mediaPillarCallContext.callState=MPCallState.CallOffer,"Update";if(webrtcCall&&this.mediaPillarCallContext.callState!==MPCallState.WaitWebrtc)return this.$log.info("[WebrtcGatewayService] mediaPillaryseTheCall | only Ignore"),"Ignore"}var status="";if(!telephonyCall&&!webrtcCall)return"NoCallRef";if(telephonyCall&&webrtcCall)return"toManyCallRef";if(telephonyCall){switch(this.mediaPillarCallContext.callState){case MPCallState.Free:this.mediaPillarCallContext.callState=MPCallState.WaitWebrtc,status="Ok";break;case MPCallState.WaitTelephony:this.mediaPillarCallContext.callState=MPCallState.CallOffer,status="Ok";break;case MPCallState.WaitWebrtc:this.mediaPillarCallContext.telephonyCallRefs.length>1?(this.$log.info("[WebrtcGatewayService] mediaPillaryseTheCall but 2nd incomming in WaitWebrtc| only Ignore"),telephonyCall.setMediaPillarCall(this.getMediaPillarCallContext()),status="Ignore"):(this.mediaPillarCallContext.callState=MPCallState.AnomalyCCS,status="Ano_inTel_contextCallState_"+this.mediaPillarCallContext.callState,this.$log.info("[WebrtcGatewayService] mediaPillaryseTheCall again in WaitWebrtc"));break;default:this.mediaPillarCallContext.callState=MPCallState.AnomalyCCS,status="Ano_inTel_contextCallState_"+this.mediaPillarCallContext.callState}"Ok"===status&&(this.putAsMasterTelCallRefs(telephonyCall),telephonyCall.setMediaPillarCall(this.getMediaPillarCallContext()))}else if(webrtcCall){switch(this.mediaPillarCallContext.webrtcCallRef=webrtcCall,this.mediaPillarCallContext.callState){case MPCallState.Free:this.mediaPillarCallContext.callState=MPCallState.WaitTelephony,status="Ok";break;case MPCallState.WaitWebrtc:this.mediaPillarCallContext.callState=MPCallState.CallOffer,status="Ok";break;default:this.mediaPillarCallContext.callState=MPCallState.AnomalyCCS,status="Ano_inWrtc_contextCallState_"+this.mediaPillarCallContext.callState}"Ok"===status&&webrtcCall.setMediaPillarCall(this.getMediaPillarCallContext())}return status}getMediaPillarCallContext(){return this.mediaPillarCallContext}isMediaPillarOutgoingCall(){var compatibleCallState;switch(this.mediaPillarCallContext.callState){case MPCallState.WaitWebrtc:case MPCallState.WaitTelephony:case MPCallState.CallOffer:case MPCallState.CallOnGoing:case MPCallState.CallActive:case MPCallState.CallActiveNoWebMedia:case MPCallState.TelCallReleasing:case MPCallState.WebCallReleasing:compatibleCallState=!0;break;default:compatibleCallState=!1}return compatibleCallState&&this.mediaPillarCallContext.isOutgoingCall3PCC}isMediaPillarReleasableCall(){var compatibleCallState;switch(this.mediaPillarCallContext.callState){case MPCallState.AnomalyCCS:case MPCallState.Unknow:compatibleCallState=!1;break;default:compatibleCallState=!0}return compatibleCallState}MediaPillarReleaseWebrtcCall(){this.mediaPillarCallContext.webrtcCallRef&&(this.mediaPillarCallContext.webrtcCallRef.mediaPillarCall=null,this.videoService.releaseCall(this.mediaPillarCallContext.webrtcCallRef))}timeOutCallActiveNoWebMedia(){this.$log.info("[WebrtcGatewayService] timeOutCallActiveNoWebMedia"),this.mediaPillarCallContext.callState===MPCallState.CallActiveNoWebMedia&&(this.MediaPillarCallTerminator(),this.mediaPillarKeepAlive(),this.$log.info("[WebrtcGatewayService] timeOutCallActiveNoWebMedia noWebMedia then release calls if existing & force keepalive"))}MediaPillarCallTerminator(){0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs.forEach(callRef=>{null!==callRef&&callRef.type.value===call_model_1.Call.Type.PHONE.value&&(callRef.mediaPillarCall=null,this.telephonyService.releaseCall(callRef),this.$log.info("[WebrtcGatewayService] MediaPillarCallTerminator | release call"+callRef))}),this.MediaPillarReleaseWebrtcCall(),this.releaseMediaPillarCallContext(),this.resetEvtAutomaton(),this.TO_PILLAR_POLLING+=TO_PILLAR_POLLING_MIN,this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.$log.warn("[WebrtcGatewayService] MediaPillarCallTerminator | Full cleaning")}createMediaPillarContact(jid){this.$log.info("[webrtcGatewayService] createMediaPillarContact -- "+jid);let contact=this.contactService.createBasicContact(jid);return contact.displayName="mediaPillar",contact.avatar=new Image,contact.avatar.src="/resources/skins/rainbow/images/conversations/unknownContact.png",contact}muteAudio(pbxCall,muted,conversation){if(pbxCall){if(this.isMediaPillarCallCase()){let webrtcCall=this.mediaPillarCallContext.webrtcCallRef;if(webrtcCall){var session=this.xmppService.connection.jingle.sessions[webrtcCall.id];if(session){session.muteAudio(muted),webrtcCall.isMuted=muted,conversation&&(conversation.isMutedAudio=muted),pbxCall.isMuted=muted,this.$log.info("[webrtcGatewayService] muteAudio conversation: "+(conversation?conversation.id:"undefined")+" / pbxcall: "+pbxCall.id+"-- "+(muted?"mute":"unumute"));let eventData={call:pbxCall};conversation&&(eventData.conversation=conversation),this.$rootScope.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",eventData)}else this.$log.error("[webrtcGatewayService] muteAudio "+pbxCall.id+" -- failure: no session")}}}else this.$log.error("[webrtcGatewayService] muteAudio - trying to mute a non existing call !")}getActivePbxCall(){return this.isMediaPillarCallCase()&&this.mediaPillarCallContext?this.mediaPillarCallContext.telephonyCallRefs.find(pxbCall=>pxbCall.status===call_model_1.Call.Status.ACTIVE):null}}WebrtcGatewayService.$inject=["$q","$rootScope","$log","$http","authService","$interval","xmppService","videoService","errorHelperService","contactService","profileService","uuid4","telephonyService","settingsService"],angular.module("rainbow").service("webrtcGatewayService",WebrtcGatewayService)},function(module,exports){angular.module("rainbow").service("callLogService",["$q","$log","$rootScope","$interval","contactService","xmppService","CallLog","orderByFilter","profileService","$injector","telephonyService","webrtcGatewayService","utilService",function($q,$log,$rootScope,$interval,contactService,xmppService,CallLog,orderByFilter,profileService,$injector,telephonyService,webrtcGatewayService,utilService){"use strict";var that=this;this.started=!1,this.callLogs=[],this.orderByNameCallLogs=[],this.orderByDateCallLogs=[],this.orderByDateCallLogsBruts=[],this.simplifiedCallLogs=[],this.callLogsPromises=[],this.callLogNamespace="jabber:iq:telephony:call_log",this.callLogAckNamespace="urn:xmpp:telephony:call_log:receipts",this.callLogNotificationsNamespace="jabber:iq:notification:telephony:call_log",this.callLogHandlerRef=null,this.callLogMessageAckRef=null,this.callLogNotificationRef=null,this.numberMissedCalls=0,this.lastTimestamp=null,this.callLogsHistory=[],this.telephonyCallLog={},this.telephonyCallLogHistory={},this.deferedObject=null,this.callLogComplete=!1,this.callLogIndex=-1,this.start=function(stats){return $log.info(""),$log.info("[callLogService] === STARTING ==="),this.attachHandlers(),$interval((function(){var startDate=performance.now();that.getCallLogHistoryPage().then((function(){var startDuration=Math.round(performance.now()-startDate);stats.push({service:"callLogService",startDuration:startDuration}),$log.info("[callLogService] === STARTED ("+startDuration+" ms) ==="),that.started=!0})).catch((function(){$log.error("[callLogService] === STARTING FAILURE ===")}))}),3e3,1,!0),$q.when()},this.stop=function(){return $log.info("[callLogService] Stopping"),this.started=!1,this.callLogs=[],this.callLogsPromises=[],this.callLogHandlerRef=null,this.callLogMessageAckRef=null,this.orderByNameCallLogs=[],this.orderByDateCallLogs=[],this.orderByDateCallLogsBruts=[],this.simplifiedCallLogs=[],this.numberMissedCalls=0,this.lastTimestamp=null,this.telephonyCallLog={},this.telephonyCallLogHistory={},this.callLogComplete=!1,this.callLogIndex=-1,this.callLogsHistory=[],$log.info("[callLogService] Stopped"),$q.when()},this.attachHandlers=function(){$log.info("[callLogService] attachHandlers"),that.callLogHandlerRef&&(xmppService.connection.deleteHandler(that.callLogHandlerRef),that.callLogHandlerRef=null),that.callLogMessageAckRef&&(xmppService.connection.deleteHandler(that.callLogMessageAckRef),that.callLogMessageAckRef=null),that.callLogNotificationRef&&(xmppService.connection.deleteHandler(that.callLogNotificationRef),that.callLogNotificationRef=null),that.callLogHandlerRef=xmppService.connection.addHandler(that.onCallLogMessageReceived,that.callLogNamespace,null,null),that.callLogMessageAckRef=xmppService.connection.addHandler(that.onCallLogAckReceived,that.callLogAckNamespace,null,null),that.callLogNotificationRef=xmppService.connection.addHandler(that.callLogNotificationReceived,that.callLogNotificationsNamespace,null,null),that.started&&that.lastTimestamp&&$interval((function(){that.getCallLogHistoryPage(that.lastTimestamp)}),1e3,1,!0)},this.getCallLogHistoryPage=function(useAfter){$log.info("[callLogService] getCallLogHistoryPage");var userContact=contactService.userContact,msg=$iq({from:userContact.jid,type:"set"}).c("query",{xmlns:this.callLogNamespace});return msg.c("set",{xmlns:"http://jabber.org/protocol/rsm"}),msg.c("max").t(75).up(),useAfter?msg.c("after").t(useAfter).up():msg.c("before").t("").up(),msg.up(),msg.up(),xmppService.sendIQ(msg),$q.when()},this.deleteOneCallLog=function(id){$log.info("[callLogService] deleteOneCallLog "+id);var userContact=contactService.userContact,msg=$iq({from:userContact.jid,to:userContact.jid,type:"set"}).c("delete",{xmlns:this.callLogNamespace,call_id:id});xmppService.sendIQ(msg)},this.deleteCallLogsForContact=function(jid){$log.info("[callLogService] deleteCallLogsForContact "+jid);var userContact=contactService.userContact,msg=$iq({from:userContact.jid,to:userContact.jid,type:"set"}).c("delete",{xmlns:this.callLogNamespace,peer:jid});xmppService.sendIQ(msg)},this.deleteAllCallLogs=function(){$log.info("[callLogService] deleteAllCallLogs");var userContact=contactService.userContact,msg=$iq({from:userContact.jid,to:userContact.jid,type:"set"}).c("delete",{xmlns:this.callLogNamespace});xmppService.sendIQ(msg)},this.markCallLogAsRead=function(id){$log.info("[callLogService] markCallLogAsRead "+id);var userContact=contactService.userContact,msg=$msg({from:userContact.jid,to:userContact.jid}).c("read",{xmlns:this.callLogAckNamespace,call_id:id});xmppService.sendIQ(msg)},this.markAllCallsLogsAsRead=function(){$log.info("[callLogService] markAllCallsLogsAsRead ");for(var userContact=contactService.userContact,i=0;i<that.callLogs.length;i++)if(!that.callLogs[i].read){var msg=$msg({from:userContact.jid,to:userContact.jid}).c("read",{xmlns:this.callLogAckNamespace,call_id:that.callLogs[i].id});xmppService.sendIQ(msg)}},this.onCallLogMessageReceived=function(stanza){try{$(stanza).find("call_log").length>0?that.callLogsPromises.push(that.createCallLogFromMessage(stanza)):$(stanza).find("count").length>0&&$(stanza).find("query").length>0?(that.lastTimestamp=$(stanza).find("last").text(),$log.info("[callLogService] onCallLogMessageReceived : all call logs received"),$q.all(that.callLogsPromises).finally((function(){$log.info("[callLogService] onCallLogMessageReceived : all call logs are ready"),that.callLogsPromises=[],that.orderCallLogsFunction(),$rootScope.$broadcast("ON_CALL_LOG_UPDATED");var num=that.getMissedCallLogCounter();num!==that.numberMissedCalls&&(that.numberMissedCalls=num,$rootScope.$broadcast("ON_CALL_LOG_ACK_UPDATED"))}))):$log.info("[callLogService] onCallLogMessageReceived : ignored !")}catch(error){return $log.error("[callLogService] onCallLogMessageReceived "+error),!0}return!0},this.onCallLogAckReceived=function(stanza){try{if($log.info("[callLogService] onCallLogAckReceived"),$(stanza).find("read").length>0){var msgId=$(stanza).find("read").attr("call_id");that.callLogAckUpdate(msgId);var num=that.getMissedCallLogCounter();num!==that.numberMissedCalls&&(that.numberMissedCalls=num,$rootScope.$broadcast("ON_CALL_LOG_ACK_UPDATED"))}}catch(error){return $log.error("[callLogService] onCallLogAckReceived "+error),!0}return!0},this.callLogNotificationReceived=function(stanza){$log.info("[callLogService] callLogNotificationReceived");try{if($(stanza).find("deleted_call_log").length>0){$log.info("[callLogService] callLogNotificationReceived : deleted IQ");var peer=$(stanza).find("deleted_call_log").attr("peer");peer?that.removeCallLogsForUser(peer):that.resetCallLogs()}else $(stanza).find("updated_call_log").length>0&&($log.info("[callLogService] callLogNotificationReceived : Update call-logs"),that.callLogsPromises.push(that.createCallLogFromMessage(stanza)),$q.all(that.callLogsPromises).finally((function(){$log.info("[callLogService] callLogNotificationReceived : update is done"),that.callLogsPromises=[],that.orderCallLogsFunction(),$rootScope.$broadcast("ON_CALL_LOG_UPDATED");var num=that.getMissedCallLogCounter();num!==that.numberMissedCalls&&(that.numberMissedCalls=num,$rootScope.$broadcast("ON_CALL_LOG_ACK_UPDATED"))})))}catch(error){return $log.error("[callLogService] callLogNotificationReceived ERROR "+error),!0}return!0},this.removeCallLogsForUser=function(jid){jid.endsWith("@_")&&(jid=jid.substring(0,jid.length-2)),$log.info("[callLogService] removeCallLogsForUser with jid: "+jid);for(var newLogs=[],i=0;i<that.callLogs.length;i++)(!that.callLogs[i].contact||that.callLogs[i].contact.jid!==jid&&that.callLogs[i].contact.id!==jid)&&newLogs.push(that.callLogs[i]);that.callLogs=newLogs,that.orderCallLogsFunction(),$rootScope.$broadcast("ON_CALL_LOG_UPDATED");var num=that.getMissedCallLogCounter();num!==that.numberMissedCalls&&(that.numberMissedCalls=num,$rootScope.$broadcast("ON_CALL_LOG_ACK_UPDATED"))},this.createCallLogFromMessage=function(message){var defered=$q.defer(),messageElem=$(message),otherParticipantJid=null,otherParticipantNumber=null,direction="",id=messageElem.find("call_id").text(),callerJid=messageElem.find("caller").text(),calleeJid=messageElem.find("callee").text(),state=messageElem.find("state").text(),duration=parseInt(messageElem.find("duration").text(),10),callSubject=messageElem.find("subject").text(),foundidentity="",identityFirstName="",identityLastName="",type="webrtc";if(callerJid&&-1!==callerJid.indexOf("janusgateway")||calleeJid&&-1!==calleeJid.indexOf("janusgateway"))return $log.info("[callLogService] createCallLogFromMessage ignore janusgateway call-logs"),void $q.when();if(callerJid&&webrtcGatewayService.isMediaPillarJid(callerJid)||calleeJid&&webrtcGatewayService.isMediaPillarJid(calleeJid))return $log.info("[callLogService] createCallLogFromMessage ignore janusgateway call-logs"),void $q.when();var typeCall=messageElem.find("call_log").attr("type");typeCall||(typeCall=messageElem.find("type").text());var read="true"===messageElem.find("ack").attr("read"),date=messageElem.find("delay").attr("stamp"),conference="conference"===messageElem.find("call_log").attr("service");return(profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_PHONE_BOOK)||config.permitSearchFromPhoneBook)&&(foundidentity=messageElem.find("identity")),duration=duration>0?moment.duration(duration,"ms").format("h[H] mm[m] ss[s]"):0,date&&(date=new Date(date)),conference?(otherParticipantJid=callerJid,type="conference",direction=contactService.isUserContactJid(callerJid)?"outgoing":"incoming",-1===otherParticipantJid.indexOf("@")&&(otherParticipantNumber=otherParticipantJid,otherParticipantJid=null)):("phone"===typeCall&&(type="telephone"),contactService.isUserContactJid(callerJid)?(otherParticipantJid=calleeJid,direction="outgoing"):(otherParticipantJid=callerJid,direction="incoming"),-1===otherParticipantJid.indexOf("@")&&(otherParticipantNumber=otherParticipantJid,otherParticipantJid=null,type="telephone")),otherParticipantJid||otherParticipantNumber?contactService.getOrCreateContact(otherParticipantJid,otherParticipantNumber).then((function(contact){if($log.info("[callLogService] createCallLogFromMessage otherParticipant jid:"+otherParticipantJid+"  Number:"+utilService.anonymizePhoneNumber(otherParticipantNumber)+" => contact retrieved (temp:"+contact.temp+")"),!conference&&!otherParticipantJid&&contact.temp){if(foundidentity&&foundidentity.length){var foundFirstName=foundidentity.attr("firstName"),foundLastName=foundidentity.attr("lastName"),foundDisplayName=foundidentity.attr("displayName");identityFirstName=foundFirstName||"",""===(identityLastName=foundLastName||"")&&""===identityFirstName&&foundDisplayName&&0!==foundDisplayName.length&&foundDisplayName!==otherParticipantNumber&&(identityLastName=foundDisplayName),(identityFirstName.length||identityLastName.length)&&($log.debug("[callLogService] createCallLogFromMessage  xNames updated from directories for contact "+contact.id),contact.updateName(identityFirstName,identityLastName))}else try{var centralizedService=$injector.get("centralizedService");centralizedService.outlook.updateContactFromOutlookInfos(contact,otherParticipantNumber,!0).then((function(updateStatus){updateStatus?$log.debug("[callLogService] createCallLogFromMessage  xNames updated from outlook for contact "+contact.id):$log.debug("[callLogService] createCallLogFromMessage no update from outlook for contact :"+contact.id)}),(function(){$log.debug("[callLogService] createCallLogFromMessage  no Outlook search available")}))}catch(error){}var displayNameisAPhoneNumber=!1;if(telephonyService.started)displayNameisAPhoneNumber=contact.displayName.match(/^[0-9A-D #\-\+\*\(\)\./]{1,32}$/)&&telephonyService.startAsPhoneNumber(contact.displayName);displayNameisAPhoneNumber&&contact.phoneProCan&&""!==contact.phoneProCan&&(contact.displayName=contact.phoneProCan)}var callLog=CallLog.create(id,contact,state,duration,type,read,date,direction,callSubject);that.logAlreadyExists(callLog)||"failed"===state||"ongoing"===state?$log.info("[callLogService] createCallLogFromMessage ignore call log with id: "+id+", state: "+state):that.callLogs.push(callLog),$log.info("[callLogService] createCallLogFromMessage success"),defered.resolve(callLog)})).catch((function(error){$log.error("[callLogService] createCallLogFromMessage error "+error),defered.resolve()})):($log.info("[callLogService] createCallLogFromMessage  No jid or no phoneNumber "),defered.resolve()),defered.promise},this.getOrderByNameCallLogs=function(){return that.orderByNameCallLogs},this.getOrderByDateCallLogs=function(){return 0!==that.orderByDateCallLogs.length&&(that.orderByDateCallLogs[0].isLatestCall=!0,that.orderByDateCallLogs[1]&&(that.orderByDateCallLogs[1].isLatestCall=!1)),that.orderByDateCallLogs},this.getOrderByDateCallLogsBruts=function(){return that.orderByDateCallLogsBruts},this.getSimplifiedCallLogs=function(){return that.simplifiedCallLogs},this.orderCallLogsFunction=function(){$log.info("[callLogService] orderByFunction"),that.orderByNameCallLogs=orderByFilter(that.callLogs,CallLog.getNames,!1,CallLog.sortByContact),that.orderByDateCallLogsBruts=orderByFilter(that.callLogs,CallLog.getDate,!1,CallLog.sortByDate),that.simplifiedCallLogs=that.simplifyCallLogs(that.orderByDateCallLogsBruts),that.orderByNameCallLogs=that.fusionInformation(that.orderByNameCallLogs),that.orderByDateCallLogs=that.fusionInformation(that.orderByDateCallLogsBruts)},this.simplifyCallLogs=function(callLogs){for(var result=[],i=0;i<callLogs.length;i++)result[i]={},result[i].contact=callLogs[i].contact.id,result[i].contactDisplayName=callLogs[i].contact.displayName,result[i].contactInitials=callLogs[i].contact.initials,result[i].id=callLogs[i].id,result[i].state=callLogs[i].state,result[i].duration=callLogs[i].duration,result[i].direction=callLogs[i].direction,result[i].type=callLogs[i].type,result[i].read=callLogs[i].read,result[i].date=callLogs[i].date;return result},this.fusionInformation=function(callLogs){for(var passed={},current=0,fusion=[],i=0;i<callLogs.length;i++){var log=callLogs[i],jid=log.contact.jid;if(log.contact.jid||(jid=log.contact.id),"conference"!==log.type)if(0!==i)if(passed[jid]){var element=fusion[passed[jid]-1];element.editable&&(element.isMissed&&"missed"===log.state&&"incoming"===log.direction?element.count++:element.isNotAnswered&&"missed"===log.state&&"outgoing"===log.direction?element.count++:element.editable=!1)}else current++,passed[jid]=current+1,fusion[current]=log,fusion[current].count=1,fusion[current].editable=!0,"missed"===log.state&&"incoming"===log.direction?fusion[current].isMissed=!0:"missed"===log.state&&"outgoing"===log.direction&&(fusion[current].isNotAnswered=!0);else passed[jid]=1,fusion[current]=log,fusion[current].count=1,fusion[current].editable=!0,"missed"===log.state&&"incoming"===log.direction?fusion[current].isMissed=!0:"missed"===log.state&&"outgoing"===log.direction&&(fusion[current].isNotAnswered=!0);else 0!==i&&current++,fusion[current]=log,fusion[current].count=1,fusion[current].editable=!1}return fusion},this.callLogAckUpdate=function(id){that.callLogs.forEach((function(callLog){callLog.id!==id||(callLog.read=!0)}))},this.getMissedCallLogCounter=function(){var num=0;return that.callLogs.forEach((function(callLog){callLog.read||"missed"!==callLog.state||"incoming"!==callLog.direction||num++})),num},this.getNumberMissedCalls=function(){return that.numberMissedCalls},this.resetCallLogs=function(){$log.info("[callLogService] resetCallLogs"),that.callLogs=[],that.getCallLogHistoryPage()},this.logAlreadyExists=function(log){var i;for(i=0;i<that.callLogs.length;i++)if(that.callLogs[i].id===log.id)return!0;return!1}}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0);angular.module("rainbow").service("videoService",["$q","$rootScope","$window","$log","$http","$interval","xmppService","contactService","browserService","gRTCStatsService","fRTCStatsService","platformService","gaService","settingsService","authService","VideoServiceEventHandler","extensionSharingService",function($q,$rootScope,$window,$log,$http,$interval,xmppService,contactService,browserService,gRTCStatsService,fRTCStatsService,platformService,gaService,settingsService,authService,VideoServiceEventHandler,extensionSharingService){var that=this;this.started=!1,this.connected=!1,this.RTC=null,this.videoEventHandler=null,this.config=null,this.companyConfig=null,this.calls={},this.localStream=null,this.autoreleaseTimeout=null,this.callsStats={},this.localStreams=[],this.makingCall=!1,this.reconnectCall=!1,this.statsInterval=null,this.audioProfileChanging=!1,this.reverseAudioCallInitiated=!1,this.alreadyAttaching=!1;var listeners=[];this.callsStatsSimplified={},this.allowDesktopSharing=function(){return!1},this.allowAdvancedDesktopSharing=function(){return!1},this.getDesktopSharingSource=function(){return null},this.askToAddSharing=function(__conversation_id){return!1},this.askToStartSharing=function(__contact_id,__media){return!1},this.isNativeApplication=function(){return!1},this.start=function(stats){$log.webrtc("[videoService] SERVICE | === STARTING ===");var startDate=performance.now();if(this.RTC=that.getBrowserMethodHandler(),this.RTC){that.started=!0,that.connected=!0,that.setWebrtcConfiguration();var startDuration=Math.round(performance.now()-startDate);stats.push({service:"videoService",startDuration:startDuration}),$log.info("[videoService] SERVICE | === STARTED ("+startDuration+" ms) ===")}else $log.error("[videoService] SERVICE | === STARTING FAILURE ===  webRTC capable browser is really required !");return listeners.push($rootScope.$on("ON_CONNECTION_STATE_CHANGE_EVENT",that.onConnectionStateChangeEvent)),listeners.push($rootScope.$on("ON_INPUT_DEVICE_CHANGED_EVENT",that.onAudioProfileChangeEvent)),listeners.push($rootScope.$on("ON_VIDEO_INPUT_DEVICE_CHANGED_EVENT",that.onVideoInputChangeEvent)),this.attachHandlers(),$q.when()},this.stop=function(){try{if(this.started){var listener;for($log.webrtc("[videoService] SERVICE | === STOPPING ==="),this.started=!1;listener=listeners.pop();)listener();for(var key in that.removeHandlers(),that.config=null,that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];that.removeCallObject(call)}xmppService.connection.jingle.terminate(),that.connected=!1,that.reconnectCall=!1,that.makingCall=!1,that.statsInterval&&window.clearInterval(that.statsInterval),$log.webrtc("SERVICE | === STOPPED ===")}return $q.when()}catch(error){return $log.webrtc("[videoService] SERVICE | === STOPPING ERROR : "+error),$q.when()}},this.attachHandlers=function(){this.removeHandlers(),$log.info("[videoService] attachHandlers"),this.videoEventHandler=VideoServiceEventHandler.create(this)},this.removeHandlers=function(){$log.info("[videoService] removeHandlers"),this.videoEventHandler&&(this.videoEventHandler=null)},this.setIceConfig=function(){return $log.webrtc("[videoService] setIceConfig"),$q((function(resolve,reject){if(that.config)return $log.webrtc("[videoService] setIceConfig from stored variable"),xmppService.connection.jingle.ice_config=that.config,resolve();that.getIceConfig().then((function(config){that.config=config,"true"===settingsService.getSetting("enableDSCP")&&($log.webrtc("[videoService] setWebrtcConfiguration - DSCP is enabled"),that.config.enableDSCP=!0),"true"===settingsService.getSetting("dtx")&&($log.webrtc("[videoService] setWebrtcConfiguration - DTX is enabled"),that.config.dtx=!0),"true"===settingsService.getSetting("simulcast")&&($log.webrtc("[videoService] setWebrtcConfiguration - Simulcasting is enabled"),that.config.simulcast=!0),"true"===settingsService.getSetting("unifiedPlan")&&($log.webrtc("[videoService] setWebrtcConfiguration - unifiedPlan is enabled"),that.config.unifiedPlan=!0),"true"===settingsService.getSetting("debugWebRTC")&&($log.webrtc("[videoService] setWebrtcConfiguration - unifiedPlan is enabled"),that.config.debugWeRTC=!0),xmppService.connection.jingle.ice_config=that.config,settingsService.setIceConfig(that.config),$log.webrtc("[videoService] setIceConfig from server success !"),resolve()})).catch((function(error){$log.error("[videoService] setIceConfig from server ERROR : "+error),-1!==error.status&&that.openErrorPopup("IceConfigurationFailed"),reject()}))}))},this.setCompanyWebrtcConfig=function(){return $log.webrtc("[videoService] setCompanyWebrtcConfig"),$q((function(resolve,reject){if(that.companyConfig)return $log.webrtc("[videoService] setCompanyWebrtcConfig from stored variable"),xmppService.connection.jingle.company_config=that.companyConfig,that.setVideoQualityConfigurationForCompany(),resolve();that.getCompanyWebrtcConfig().then((function(config){that.companyConfig=config,xmppService.connection.jingle.company_config=that.companyConfig,that.setVideoQualityConfigurationForCompany(),$log.webrtc("[videoService] setCompanyWebrtcConfig from server success !"),resolve()})).catch((function(error){$log.error("[videoService] setCompanyWebrtcConfig from server ERROR : "+error),reject()}))}))},this.setWebrtcConfiguration=function(){return $q((function(resolve){var promises=[];promises.push(that.setIceConfig()),promises.push(that.setCompanyWebrtcConfig()),$q.all(promises).then((function(){$log.webrtc("[videoService] setWebrtcConfiguration -- done"),resolve()}))}))},this.onConnectionStateChangeEvent=function(__event,status){try{if("disconnected"===status){for(var key in $log.info("MEDIA   | onConnectionStateChangeEvent : disconnected"),that.connected=!1,that.config=null,that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];that.reconnectCall=!0,call&&call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN&&($log.webrtc("INFO    | onConnectionStateChangeEvent : disconnected -> call goes to connecting state"),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.CONNECTING),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)),that.statsInterval&&window.clearInterval(that.statsInterval)}}else if("connected"===status){for(var key in $log.info("MEDIA   | onConnectionStateChangeEvent : connected"),that.attachHandlers(),that.setWebrtcConfiguration(),that.connected=!0,that.statsInterval&&(window.clearInterval(that.statsInterval),that.statsinterval=null),that.calls)if(that.calls.hasOwnProperty(key)){call=that.calls[key];var session=xmppService.connection.jingle.sessions[call.id];that.reconnectCall&&session&&session.peerconnection&&($log.info("MEDIA   | onConnectionStateChangeEvent : connected - start reconnection on session "+call.id),session.me=contactService.userContact.fullJid,session.isInitiator&&(session.initiator=session.me),session.connection=xmppService.connection,contactService.setBusyState("dnd",that.calculatePresenceMessage(call)),session.reconnectSession())}that.reconnectCall=!1}}catch(error){$log.info("MEDIA   | onConnectionStateChangeEvent : disconnected error : "+error)}},that.isUserContactInCall=function(){for(var key in that.calls){if(that.calls.hasOwnProperty(key))if(that.calls[key].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN)return!0}return!1},this.getCurrentActiveSession=function(){for(var key in that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];if(call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN)return xmppService.connection.jingle.sessions[call.id]}return null},that.getMediaPillarAudioCall=function(){for(var key in that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];if(call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN&&call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO&&call.isMediaPillarCall())return call}return null},that.getWebrtcAudioCall=function(){for(var key in that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];if(call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN&&call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO&&!call.isMediaPillarCall())return call}return null},that.getMediaPillarSession=function(){var mediaPillarAudioCall=that.getMediaPillarAudioCall();return mediaPillarAudioCall?xmppService.connection.jingle.sessions[mediaPillarAudioCall.id]:null},that.getCurrentSharingCall=function(){for(var key in that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];if(call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN&&(call.localMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING||call.remoteMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING))return call}return null},that.endAllCallsForContact=function(contact){if(contact)for(var key in $log.webrtc("[videoService] endAllCallsForContact "+contact.jid),that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN&&call.contact&&call.contact.jid===contact.jid&&that.releaseCall(call)}},that.onVideoInputChangeEvent=function(){for(var key in $log.webrtc("MEDIA   | onVideoInputChangeEvent"),that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];xmppService.connection.jingle.sessions[call.id]&&call.localMedia&&call.localMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO+_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO&&($log.webrtc("MEDIA   | audio + video call, renegotiate the profile"),that.escalateToVideoCall(call,!0))}},that.onAudioProfileChangeEvent=function(){if($log.webrtc("MEDIA   | onAudioProfileChangeEvent"),that.audioProfileChanging)$log.webrtc("MEDIA   | onAudioProfileChangeEvent -- already changing");else for(var key in that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];xmppService.connection.jingle.sessions[call.id]&&call.localMedia&&(that.audioProfileChanging=!0,$interval((function(currentCall){that.audioProfileChanging=!1,that.renegotiateCurrentCall(currentCall)}),500,1,!0,call))}},this.renegotiateCurrentCall=function(call){call.localMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO||call.localMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO+_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING?($log.webrtc("MEDIA   | renegotiate the audio profile"),that.addAudioToCall(call,!0)):call.localMedia!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO+_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO&&call.localMedia!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO+_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING+_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO||($log.webrtc("MEDIA   | audio + video call, renegotiate the profile"),that.addVideoToCall(call,!0))},this.getCallByJid=function(jid){var result=null;if(!jid)return result;for(var key in $log.webrtc("[videoService] getCallByJid "+jid),that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];if(call.contact&&call.contact.jid===jid){result=call;break}}return result},this.resetAudioOutputElement=function(){platformService.allowDevicesManagement()&&!this.audioProfileChanging&&($("#globalAudioTag").length?($log.webrtc("[videoService] resetAudioOutputElement"),this.audioProfileChanging=!0,platformService.getCurrentSpeaker().then((function(device){var sinkId="default";device&&device.id&&(sinkId=device.id);var anotherSink="default";"default"!==sinkId&&DetectRTC.audioOutputDevices.forEach((function(output){"default"!==output.deviceId&&"communications"!==output.deviceId&&output.deviceId!==sinkId&&(anotherSink=output.deviceId)})),$("#globalAudioTag")[0].setSinkId(anotherSink).then((function(){$log.webrtc("[videoService] resetAudioOutputElement sinkId is "+$("#globalAudioTag")[0].sinkId),"default"!==sinkId?$("#globalAudioTag")[0].setSinkId(sinkId).then((function(){$log.webrtc("[videoService] resetAudioOutputElement sinkId is "+$("#globalAudioTag")[0].sinkId),that.audioProfileChanging=!1,$("#globalAudioTag")[0].load&&$("#globalAudioTag")[0].load()})).catch((function(){that.audioProfileChanging=!1})):that.audioProfileChanging=!1})).catch((function(error){$log.warn("[videoService] resetAudioOutputElement globalAudioTag error "+error),that.audioProfileChanging=!1})),$interval((function(){$("#largevideo")[0]&&$("#largevideo")[0].setSinkId(anotherSink).then((function(){$log.webrtc("[videoService] resetAudioOutputElement largevideo "+$("#largevideo")[0].sinkId),"default"!==sinkId&&$("#largevideo")[0].setSinkId(sinkId).then((function(){$log.webrtc("[videoService] resetAudioOutputElement largevideo "+$("#largevideo")[0].sinkId)})).catch((function(error){$log.warn("[videoService] resetAudioOutputElement largevideo error "+error)}))})).catch((function(error){$log.warn("[videoService] resetAudioOutputElement largevideo error "+error)})),$("#p2pSecondVideo")[0]&&$("#p2pSecondVideo")[0].setSinkId(anotherSink).then((function(){"default"!==sinkId&&$("#p2pSecondVideo")[0].setSinkId(sinkId).then((function(){$log.webrtc("[videoService] resetAudioOutputElement p2pSecondVideo "+$("#p2pSecondVideo")[0].sinkId)})).catch((function(error){$log.warn("[videoService] resetAudioOutputElement p2pSecondVideo error "+error)}))})).catch((function(error){$log.warn("[videoService] resetAudioOutputElement p2pSecondVideo error "+error)}))}),3e3,1)})).catch((function(){$log.webrtc("[videoService] resetAudioOutputElement getCurrentSpeaker error"),that.audioProfileChanging=!1}))):$log.warn("[videoService] resetAudioOutputElement -- missing global audio tag !"))},this.disableAudioVideoMedia=function(session,sessionId){if(session?$log.webrtc("MEDIA   | disableAudioVideoMedia for session "+JSON.stringify({sid:session.sid})):sessionId?$log.webrtc("MEDIA   | disableAudioVideoMedia no session, sessionId: "+sessionId):$log.webrtc("MEDIA   | disableAudioVideoMedia no session, no session Id"),!session&&!sessionId){var localStreamsLength=that.localStreams.length;if(that.localStreams.length>0)for(that.localStreams.forEach((function(stream){stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),stream=null}));that.localStreams.length>0;){that.localStreams.pop();null}$log.webrtc("MEDIA   | disableAudioVideoMedia : All local streams stopped and removed: "+localStreamsLength)}if(session){if(session.localStreams.length>0){var sessionStreamsLength=session.localStreams.length;for(session.localStreams.forEach((function(stream){stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),stream=null})),that.localStreams=that.localStreams.filter((function(localStream){return!session.localStreams.includes(localStream)}));session.localStreams.length>0;){session.localStreams.pop();null}$log.webrtc("MEDIA   | disableAudioVideoMedia : Session streams stopped and removed: "+sessionStreamsLength+". Remaining local streams: "+that.localStreams.length)}}else if(sessionId){var streams=that.localStreams.filter((function(localStream){return localStream.callId===sessionId}));if(streams){sessionStreamsLength=streams.length;streams.forEach((function(stream){stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),that.localStreams.splice(that.localStreams.indexOf(stream),1),stream=null})),$log.webrtc("MEDIA   | disableAudioVideoMedia : Locals streams for sessionId "+sessionId+" stopped and removed: "+sessionStreamsLength+". Remaining local streams: "+that.localStreams.length)}}that.statsInterval&&(window.clearInterval(that.statsInterval),that.statsinterval=null)},this.clearSrcObjectsFromElements=function(){this.RTC.clearMediaStream(angular.element("#largevideo"),null),this.RTC.clearMediaStream(angular.element("#globalVideoTag"),null),this.RTC.clearMediaStream(angular.element("#globalAudioTag"),null)},this.attachDistantMediaStreamsUnifiedPlan=function(call){var sess=xmppService.connection.jingle.sessions[call.id];sess.remoteStreamsObject[0]&&($log.webrtc("attachDistantMediaStreamsUnifiedPlan audio track for element globalAudioTag "+sess.remoteStreamsObject[0].id),this.RTC.attachMediaStream(angular.element("#globalAudioTag"),sess.remoteStreamsObject[0])),sess.remoteStreamsObject[1]&&sess.remoteStreamsObject[2]?(this.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),sess.remoteStreamsObject[2],sess.remoteStreamsObject[2].id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0),this.RTC.attachMediaStreamIfNeeded(angular.element("#p2pSecondVideo"),sess.remoteStreamsObject[1],sess.remoteStreamsObject[2].id),angular.element("#p2pSecondVideo")[0]&&(angular.element("#p2pSecondVideo")[0].muted=!0,angular.element("#p2pSecondVideo")[0].volume=0)):sess.remoteStreamsObject[1]?(this.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),sess.remoteStreamsObject[1],sess.remoteStreamsObject[1].id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0)):sess.remoteStreamsObject[2]&&(this.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),sess.remoteStreamsObject[2],sess.remoteStreamsObject[2].id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0))},this.attachDistantMediaStreams=function(attach,call){if(attach){if(that.alreadyAttaching)return;if(that.alreadyAttaching=!0,call.unifiedPlanActivated)return that.attachDistantMediaStreamsUnifiedPlan(call),void(that.alreadyAttaching=!1);var sess=xmppService.connection.jingle.sessions[call.id];if(sess.remoteStreams){var mainRemoteTrack,secondRemoteTrack;if(sess.remoteStreams.length>1)sess.remoteStreams[0].getAudioTracks().length?(secondRemoteTrack=sess.remoteStreams[0],mainRemoteTrack=sess.remoteStreams[1]):(mainRemoteTrack=sess.remoteStreams[0],secondRemoteTrack=sess.remoteStreams[1]),mainRemoteTrack.getVideoTracks().length>0&&($log.webrtc("attachDistantMediaStreams video track for element largevideo "+mainRemoteTrack.id),that.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),mainRemoteTrack,mainRemoteTrack.id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0)),mainRemoteTrack.getAudioTracks().length>0&&($log.webrtc("attachDistantMediaStreams audio track for element globalAudioTag "+mainRemoteTrack.id),that.RTC.attachMediaStream(angular.element("#globalAudioTag"),mainRemoteTrack)),secondRemoteTrack.getVideoTracks().length>0&&($log.webrtc("attachDistantMediaStreams video track for element p2pSecondVideo "+secondRemoteTrack.id),that.RTC.attachMediaStreamIfNeeded(angular.element("#p2pSecondVideo"),secondRemoteTrack,secondRemoteTrack.id),angular.element("#p2pSecondVideo")[0]&&(angular.element("#p2pSecondVideo")[0].muted=!0,angular.element("#p2pSecondVideo")[0].volume=0)),secondRemoteTrack.getAudioTracks().length>0&&($log.webrtc("attachDistantMediaStreams audio track for element globalAudioTag "+secondRemoteTrack.id),that.RTC.attachMediaStream(angular.element("#globalAudioTag"),secondRemoteTrack));else sess.remoteStreams.forEach((function(track){track.getVideoTracks().length>0&&($log.webrtc("attachDistantMediaStreams video track"),that.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),track,track.id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0),that.RTC.attachMediaStreamIfNeeded(angular.element("#p2pSecondVideo"),track,track.id),angular.element("#p2pSecondVideo")[0]&&(angular.element("#p2pSecondVideo")[0].muted=!0,angular.element("#p2pSecondVideo")[0].volume=0)),track.getAudioTracks().length>0&&($log.webrtc("attachDistantMediaStreams audio track"),that.RTC.attachMediaStream(angular.element("#globalAudioTag"),track))}));that.alreadyAttaching=!1}}else that.isUserContactInCall()||(this.RTC.clearMediaStream(angular.element("#largevideo"),null),this.RTC.clearMediaStream(angular.element("#globalVideoTag"),null),this.RTC.clearMediaStream(angular.element("#globalAudioTag"),null))},this.attachLocalMediaStreams=function(attach){if($log.webrtc("attachLocalMediaStreams "+attach),attach){if(this.localStreams&&this.localStreams.length){var firstVideoStream=!1;this.localStreams.forEach((function(track){track.getVideoTracks().length&&track.getAudioTracks().length?(firstVideoStream?that.RTC.attachMediaStreamIfNeeded($("#minivideo2"),track,track.id):(firstVideoStream=!0,that.RTC.attachMediaStreamIfNeeded($("#minivideo"),track,track.id)),that.RTC.attachMediaStreamIfNeeded($("#callVideoPip"),track,track.id)):track.getVideoTracks().length&&(firstVideoStream?that.RTC.attachMediaStreamIfNeeded($("#minivideo2"),track,track.id):(firstVideoStream=!0,that.RTC.attachMediaStreamIfNeeded($("#minivideo"),track,track.id)),that.RTC.attachMediaStreamIfNeeded($("#callSharingPip"),track,track.id))}))}$("#callVideoPip")[0]&&($("#callVideoPip")[0].volume=0),$("#minivideo")[0]&&($("#minivideo")[0].volume=0),$("#minivideo2")[0]&&($("#minivideo2")[0].volume=0),$("#callSharingPip")[0]&&($("#callSharingPip")[0].volume=0)}else this.RTC.clearMediaStream($("#minivideo"),null),this.RTC.clearMediaStream($("#minivideo2"),null),this.RTC.clearMediaStream($("#callVideoPip"),null),this.RTC.clearMediaStream($("#callSharingPip"),null)},this.pushInLocalStreams=function(stream,callId){stream.callId=callId,that.localStreams.push(stream)},this.openErrorPopup=function(msg){msg||(msg="cameraNotAvailable"),$rootScope.$broadcast("ON_WEBRTC_CALL_ERROR_EVENT",msg)},this.openCalendarBusyPopup=function(id){$rootScope.$broadcast("ON_WEBRTC_CALENDAR_BUSY_EVENT",id)},this.makeVideoCall=function(contact){that.makeCall(contact,"videoOnly")},this.makeCall=function(contact,theMedia,message){$log.webrtc("MEDIA   | makeCall to "+JSON.stringify({displayName:contact.displayNameForLog(),resources:contact.resources})),that.makingCall?$log.info("MEDIA   | makeCall already making a call !"):(that.makingCall=!0,this.videoEventHandler.sendProposition(contact,theMedia,message))},this.makeJingleCall=function(call,mediaPillarJid,phoneNumber){$log.webrtc("MEDIA   | makeJingleCall"),that.setWebrtcConfiguration().then((function(){var localType="";call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO&&(localType="audio"),call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO&&(localType=localType?"audio+video":"video"),mediaPillarJid&&""!==mediaPillarJid&&$log.webrtc("MEDIA   | makeJingleCall in mediaPillar case for number : "+phoneNumber),mediaPillarJid&&""!==mediaPillarJid&&phoneNumber&&""!==phoneNumber?(localType="sip",xmppService.connection.jingle.initiate(mediaPillarJid,xmppService.connection.jid,localType,that.localStreams,call.id,null,phoneNumber)):xmppService.connection.jingle.initiate(call.fullJid,xmppService.connection.jid,localType,that.localStreams,call.id,null,null,call.unifiedPlanActivated),call.status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.CONNECTING,$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)})).catch((function(error){$log.webrtc("MEDIA   | makeCall failure : "+JSON.stringify({error:error.message})),that.makingCall=!1,call&&that.removeCallObject(call),that.resetToSafeState()}))},this.makeJingleSharingCall=function(call){$log.webrtc("MEDIA   | makeJingleSharingCall - make desktop sharing call");var type="sharing";call.localMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING&&(type="sharing-only"),that.setWebrtcConfiguration().then((function(){$log.webrtc("SHARING | getUserMedia success");var mediaPillarSession=that.getMediaPillarSession(),callStreams=mediaPillarSession?that.localStreams.filter((function(localStream){return!(mediaPillarSession.localStreams&&mediaPillarSession.localStreams.includes(localStream))})):that.localStreams;xmppService.connection.jingle.initiate(call.fullJid,xmppService.connection.jid,type,callStreams,call.id,null,null,call.unifiedPlanActivated),call.status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.CONNECTING,$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)})).catch((function(error){that.makingCall=!1,call&&that.removeCallObject(call),that.resetToSafeState(),$log.webrtc("MEDIA   | makeJingleSharingCall failure : "+JSON.stringify({error:error.message}))}))},this.startDesktopSharing=function(contact,media){that.makingCall?$log.info("MEDIA   | startDesktopSharing already making a call !"):(that.makingCall=!0,!that.askToStartSharing(contact.jid,media)&&that.makeDesktopSharingCall(contact,media))},this.startSharingCancelled=function(){that.makingCall=!1},this.makeDesktopSharingCall=function(contact,media){media||(media="sharing"),that.makingCall=!0,$log.webrtc("MEDIA   | makeDesktopSharingCall - trying to start a desktop sharing call with media "+media),this.videoEventHandler.sendProposition(contact,media)},this.answerJingleCall=function(call){$log.webrtc("MEDIA   | answerJingleCall "+call.id);var mediaToGet=[],localType="audio";call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO&&mediaToGet.push("audio"),call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO&&(mediaToGet.push("video"),localType="audio+video"),call.localMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO&&(localType="video");var mediaConstraints={};call.isInConversationWithMobile()&&(mediaConstraints=that.getMobileMediaConstraints("video")),that.setWebrtcConfiguration().then((function(){that.getBrowserMedia(mediaToGet,mediaConstraints.fixedVideoWidth,mediaConstraints.fixedVideoHeight,mediaConstraints.fixedFrameRate).then((function(stream){var session=xmppService.connection.jingle.sessions[call.id];stream?(that.pushInLocalStreams(stream,call.id),session.addStream(that.localStreams[0]),session.localStreams.push(that.localStreams[0])):localType=null,session.localType=localType,session.sendAnswer(),session.accept(),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)})).catch((function(error){$log.webrtc("MEDIA   | answerJingleCall failure for : "+call+" failure : "+error.message),-1!==error.toString().indexOf("getUserMedia")&&(that.releaseCall(call),that.openErrorPopup()),that.resetToSafeState()}))}))},this.answerCall=function(call,type){this.videoEventHandler.acceptProposition(call,type)},this.rejectCall=function(call,__reason){call?(that.makingCall=!1,that.autoreleaseTimeout&&$interval.cancel(that.autoreleaseTimeout),xmppService.connection.jingle.sessions[call.id]?that.releaseCall(call):call.isInitiator?this.videoEventHandler.retractProposition(call):this.videoEventHandler.rejectProposition(call,__reason)):$log.webrtc("MEDIA   | rejectCall - trying to rejectCall a non existing call !")},this.releaseCall=function(call,reason,text){call?(that.makingCall=!1,this.execute("releaseCall",(function(){$log.webrtc("MEDIA   | releaseCall : "+call);try{var session=xmppService.connection.jingle.sessions[call.id];that.disableAudioVideoMedia(session),contactService.resetBusyState(),that.autoreleaseTimeout&&$interval.cancel(that.autoreleaseTimeout),that.createOrUpdateStatisticsForCall(call.id),that.callsStats[call.id]&&delete that.callsStats[call.id],that.callsStatsSimplified[call.id]&&delete that.callsStatsSimplified[call.id],that.removeCallObject(call,reason,text),that.displayWebRTCStats(call.id),that.isUserContactInCall()||that.clearSrcObjectsFromElements()}catch(error){$log.webrtc("MEDIA   | releaseCall ERROR"),$log.error(error),that.createOrUpdateStatisticsForCall(call.id),that.callsStats[call.id]&&delete that.callsStats[call.id],that.callsStatsSimplified[call.id]&&delete that.callsStatsSimplified[call.id],that.resetToSafeState(),that.displayWebRTCStats(call.id),that.removeCallObject(call)}}))):$log.webrtc("MEDIA   | releaseCall - trying to release a non existing call !")},this.askToAddDesktopSharing=function(conversation){$log.webrtc("MEDIA   | askToAddDesktopSharing - Desktop sharing escalation"),!that.askToAddSharing(conversation.id)&&that.addSharingToCall(conversation.videoCall)},this.addAudioToCall=function(call,mediaModify){$log.webrtc("MEDIA   | addAudioToCall");var session=xmppService.connection.jingle.sessions[call.id];session.isRenegotiating=!0;this.getBrowserMedia(["audio"]).then((function(stream){that.stopActiveAudioVideoStreams(session),that.pushInLocalStreams(stream,call.id);for(var i=0;i<that.localStreams.length;i++)session.removeStream(that.localStreams[i]);var type=mediaModify?"contentModify":"contentAdd";that.updateCurrentCall(call,session,"audio",type)})).catch((function(error){$log.webrtc("MEDIA   | addAudioToCall failure : "+error),that.releaseCall(call),that.resetToSafeState()}))},this.addSharingToCall=function(call){$log.webrtc("MEDIA   | addSharingToCall - Desktop sharing escalation");var session=xmppService.connection.jingle.sessions[call.id];session.isRenegotiating=!0;var mediaConstraints={};call.isInConversationWithMobile()&&(mediaConstraints=that.getMobileMediaConstraints("sharing")),this.getBrowserMedia(["sharing"],null,null,mediaConstraints.fixedFrameRate).then((function(stream){for(var i=0;i<that.localStreams.length;i++)session.removeStream(that.localStreams[i]),session.localStreams[i]=null;session.localStreams=[],that.pushInLocalStreams(stream,call.id);for(i=0;i<that.localStreams.length;i++)session.removeStream(that.localStreams[i]);that.updateCurrentCall(call,session,"sharing","contentAdd")})).catch((function(error){$log.webrtc("MEDIA   | addSharingToCall failure : "+error),session.isRenegotiating=!1,-1!==error.toString().indexOf("getUserMedia")&&that.openErrorPopup()}))},this.addVideoToCall=function(call,mediaModify){$log.webrtc("MEDIA   | addVideoToCall");var session=xmppService.connection.jingle.sessions[call.id];session.isRenegotiating=!0;var mediaConstraints={};call.isInConversationWithMobile()&&(mediaConstraints=that.getMobileMediaConstraints("video")),that.getBrowserMedia(["audio","video"],mediaConstraints.fixedVideoWidth,mediaConstraints.fixedVideoHeight,mediaConstraints.fixedFrameRate).then((function(stream){that.stopActiveAudioVideoStreams(session),that.pushInLocalStreams(stream,call.id);for(var i=0;i<that.localStreams.length;i++)session.removeStream(that.localStreams[i]);var type=mediaModify?"contentModify":"contentAdd";that.updateCurrentCall(call,session,"video",type)})).catch((function(error){$log.webrtc("MEDIA   | addVideoToCall failure for : "+call+" failure : "+error.message),-1!==error.toString().indexOf("getUserMedia")?($log.info("addVideoToCall impossible, no webcam plugged"),that.openErrorPopup()):(that.releaseCall(call),that.resetToSafeState())}))},this.removeSharingFromCall=function(call){$log.webrtc("MEDIA   | removeSharingFromCall");var session=xmppService.connection.jingle.sessions[call.id];this.stopAllActiveStreams(session);var mediaToGet=["audio"];call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO&&mediaToGet.push("video"),session.isRenegotiating=!0,that.getBrowserMedia(mediaToGet).then((function(stream){that.pushInLocalStreams(stream,call.id),that.updateCurrentCall(call,session,"sharing","contentRemove")})).catch((function(error){$log.webrtc("MEDIA   | removeSharingFromCall failure for : "+call+" failure : "+error.message),-1!==error.toString().indexOf("getUserMedia")&&that.openErrorPopup(),that.releaseCall(call),that.resetToSafeState()}))},this.removeVideoFromCall=function(call){$log.webrtc("MEDIA   | removeVideoFromCall"),this.reverseAudioCallInitiated=!0;var session=xmppService.connection.jingle.sessions[call.id];this.stopActiveAudioVideoStreams(session),this.localStreams.forEach((function(stream){session.removeStream(stream)}));session.isRenegotiating=!0,that.getBrowserMedia(["audio"]).then((function(stream){that.pushInLocalStreams(stream,call.id),that.updateCurrentCall(call,session,"video","contentRemove")})).catch((function(error){$log.webrtc("MEDIA   | removeVideoFromCall failure for : "+call+" failure : "+error),-1!==error.toString().indexOf("getUserMedia")&&that.openErrorPopup(),that.releaseCall(call),that.resetToSafeState()}))},this.calculatePresenceMessage=function(call){var message="audio";return call&&call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO&&(message="video"),call&&call.remoteMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO&&(message="video"),call&&call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING&&(message="sharing"),call&&call.remoteMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING&&(message="sharing"),message},this.calculateAudioState=function(data){var audioState=0;return data.availableIncomingAudioBandwidth&&(audioState=data.availableIncomingAudioBandwidth<15&&data.availableIncomingAudioBandwidth>0?1:data.availableIncomingAudioBandwidth>=15&&data.availableIncomingAudioBandwidth<30?2:3),audioState},this.calculateVideoState=function(data){var videoState=0;return data.availableIncomingVideoBandwidth&&(videoState=data.availableIncomingVideoBandwidth<300?1:data.availableIncomingVideoBandwidth>=300&&data.availableIncomingVideoBandwidth<500?2:3),videoState},this.execute=function(action,actionHandler,parameter){this.started||"releaseCall"===action?actionHandler(parameter):$log.webrtc("MEDIA   | "+action+" failure : videoService is not started")},this.getOrCreateCallByCallId=function(callId){var call=that.calls[callId];if(!call){var sess=xmppService.connection.jingle.sessions[callId],peerJid=xmppService.getBareJidFromJid(sess.peerjid),contact=contactService.getContactByJid(peerJid);call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN,callId,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.WEBRTC,contact),that.calls[call.id]=call}return call},this.getCallByContact=function(contact){for(var key in this.calls)if(this.calls.hasOwnProperty(key)){var call=that.calls[key];if(call.contact&&contact.jid===call.contact.jid)return call}return null},this.removeCallObject=function(call,reason,text){try{if(call){$log.debug("removeCallObject Call id: "+call.id),call.status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN;var session=xmppService.connection.jingle.sessions?xmppService.connection.jingle.sessions[call.id]:null;that.disableAudioVideoMedia(session,call.id),delete that.calls[call.id],$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),session&&xmppService.connection.jingle.terminate(call.id,reason,text)}}catch(error){$log.error("removeCallObject error "+error)}},this.updateRemoteTypeMedia=function(remoteType,call){switch(remoteType){case"audio":call.remoteMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO;break;case"video":call.remoteMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO;break;case"audio+video":call.remoteMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO;break;case"sharing":call.remoteMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO;break;case"sharing-only":call.remoteMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING;break;default:call.remoteMedia=null}$log.debug("REMOTE TYPE || REMOTE MEDIA  "+call.remoteMedia)},this.checkStreamAndStatus=function(stream,contact){return stream&&(0===stream.getAudioTracks().length&&0===stream.getVideoTracks().length||!1===stream.active)?(that.openErrorPopup(),!1):!(contact.capabilities&&!contact.capabilities.webRTC)||($log.webrtc("MEDIA   | initSharedDesktop failure : remote contact is no more available"),stream.stop&&stream.stop(),that.openErrorPopup("remoteUserNoMoreAvailable"),!1)},this.displayWebRTCStats=function(callId){try{var streams=null,i=0;if(gRTCStatsService.hasStatsForCall(callId)){if($log.webrtc("STATS   | Bundle policy used: "+gRTCStatsService.getBundlePolicyForCall(callId)),0===(streams=gRTCStatsService.getStreamsDetailsFromCall(callId)).length)$log.webrtc("STATS   | No channel information available for call "+callId);else for(i=0;i<streams.length;i++)$log.webrtc("STATS   | "+streams[i].id+": "+JSON.stringify(streams[i].streams));var codecs=gRTCStatsService.getCodecDetailsFromCall(callId);$log.webrtc("STATS   | codecs used: "+JSON.stringify(codecs)),gaService.trackCodecsUsed(codecs.codec.audio,codecs.codec.video)}else if(fRTCStatsService.hasStatsForCall(callId))if($log.webrtc("STATS   | Bundle policy used: "+fRTCStatsService.getBundlePolicyForCall(callId)),0===(streams=fRTCStatsService.getStreamsDetailsFromCall(callId)).length)$log.webrtc("STATS   | No channel information available for call "+callId);else for(i=0;i<streams.length;i++)$log.webrtc("STATS   | "+streams[i].id+": "+JSON.stringify(streams[i].streams))}catch(error){$log.error("[videoService] displayWebRTCStats error : "+error)}},this.muteAudio=function(conversation,state){var call=conversation.videoCall;if(call){$log.webrtc("MEDIA   | mute audio: "+call+" | state: "+state),conversation.isMutedAudio=state,call.isMuted=state;var session=xmppService.connection.jingle.sessions[call.id];session?(session.muteAudio(state),$rootScope.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{conversation:conversation,call:call})):$log.webrtc("MEDIA   | muteAudio - trying to mute a non existing session !")}else $log.webrtc("MEDIA   | muteAudio - trying to mute a non existing call !")},this.muteVideo=function(conversation,state){var call=conversation.videoCall;if(call){$log.webrtc("MEDIA   | muteVideo: "+call);var session=xmppService.connection.jingle.sessions[call.id];session&&(session.muteVideo(state),session.sendMute(state)),$rootScope.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{conversation:conversation,call:call})}else $log.webrtc("MEDIA   | muteVideo - trying to mute a non existing call !")},this.stopAllActiveStreams=function(session){this.stopActiveAudioVideoStreams(session,!0)},this.stopActiveAudioVideoStreams=function(session,stopAll){if(that.localStreams.length>0)if(that.localStreams.forEach((function(stream){(stream.getAudioTracks().length||stopAll)&&(stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),stream=null)})),stopAll)for(;that.localStreams.length;){that.localStreams.pop();null}else for(var i=0;i<that.localStreams.length;i++)if(that.localStreams[i]&&that.localStreams[i].getAudioTracks().length){that.localStreams.splice(i,1);null}if(session&&session.localStreams){if(session.localStreams.forEach((function(stream){(stream.getAudioTracks().length||stopAll)&&(stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),session.removeStream(stream))})),stopAll)for(;session.localStreams.length;){session.localStreams.pop();null}session.localStreams=[]}session&&xmppService.connection.jingle.localStream&&session.removeStream(xmppService.connection.jingle.localStream)},this.resetToSafeState=function(){$log.webrtc("MEDIA   | resetToSafeState"),that.autoreleaseTimeout&&$interval.cancel(that.autoreleaseTimeout),(that.localStream||that.localStreams.length)&&that.disableAudioVideoMedia(),contactService.resetBusyState()},this.vidRes={1080:[1920,1080],720:[1280,720],360:[640,360],180:[320,180],960:[960,720],640:[640,480],320:[320,240]},this.getMobileMediaConstraints=function(type){return this.mobileVideoQualityConfiguration[type]},this.setVideoQualityConfigurationForCompany=function(){this.companyConfig&&this.companyConfig.video&&(this.videoQualityConfiguration.video.fixedVideoHeight=this.companyConfig.video.height?this.companyConfig.video.height.ideal:this.videoQualityConfiguration.video.fixedVideoHeight,this.videoQualityConfiguration.video.fixedVideoWidth=this.companyConfig.video.width?this.companyConfig.video.width:this.videoQualityConfiguration.video.fixedVideoWidth,this.videoQualityConfiguration.video.fixedFrameRate=this.companyConfig.video.frameRate?this.companyConfig.video.frameRate:this.videoQualityConfiguration.video.fixedFrameRate)},this.videoQualityConfiguration={video:{fixedFrameRate:30,fixedVideoWidth:1280,fixedVideoHeight:720},sharing:{fixedFrameRate:8,fixedVideoWidth:1920,fixedVideoHeight:1080}},this.mobileVideoQualityConfiguration={video:{fixedFrameRate:20,fixedVideoWidth:640,fixedVideoHeight:480},sharing:{fixedFrameRate:8,fixedVideoWidth:1920,fixedVideoHeight:1080}},this.minFirefoxWebRTCVersion=45,this.minChromeWebRTCVersion=42,this.minEdgeWebRTCVersion=25,this.firefoxPreferedSharing="screen",this.getBrowserMedia=function(userMedia,fixedVideoWidth,fixedVideoHeight,fixedFrameRate){return userMedia&&0!==userMedia.length?new Promise((function(resolve,reject){var deferred=$q.defer(),shouldGetDisplayMedia=!1,constraints={audio:!1,video:!1},width=fixedVideoWidth||that.videoQualityConfiguration.video.fixedVideoWidth,height=fixedVideoHeight||that.videoQualityConfiguration.video.fixedVideoHeight,promises=[];if(platformService.allowDevicesManagement()){if(userMedia.indexOf("audio")>=0){var microphoneDeferred=$q.defer();platformService.getCurrentMicrophone().then((function(microphone){constraints.audio=!microphone||{optional:[{sourceId:microphone.id}]},microphoneDeferred.resolve(constraints);var mic="default";microphone&&(mic="id - "+microphone.id+" and label "+microphone.label),$log.info("[VideoService] GetUserMedia for microphone "+mic)})),promises.push(microphoneDeferred.promise)}if(userMedia.indexOf("video")>=0){var frameRate=fixedFrameRate||that.videoQualityConfiguration.video.fixedFrameRate,cameraDeferred=$q.defer();platformService.getCurrentCamera().then((function(camera){camera&&"default"!==camera.id?constraints.video={width:width,height:height,frameRate:frameRate,deviceId:{exact:camera.id}}:constraints.video={width:width,height:height,frameRate:frameRate},cameraDeferred.resolve(constraints);var cam="default";camera&&(cam="id - "+camera.id+" and label "+camera.label),$log.info("[VideoService] GetUserMedia for camera "+cam)})),promises.push(cameraDeferred.promise)}}else userMedia.indexOf("audio")>=0&&(constraints.audio=!0),userMedia.indexOf("video")>=0&&(constraints.video={width:width,height:height});if(userMedia.indexOf("sharing")>=0){frameRate=fixedFrameRate||8;if(extensionSharingService.extensionFound)constraints.video={mandatory:{chromeMediaSource:"desktop",maxWidth:1920,maxHeight:1080,maxFrameRate:frameRate}},promises.push(extensionSharingService.getStreamToShareFromExtension(constraints));else if(!that.isNativeApplication()&&"chrome"===adapter.default.browserDetails.browser&&adapter.default.browserDetails.version>=73)shouldGetDisplayMedia=!0,constraints={},constraints={video:{chromeMediaSource:"desktop",width:1920,height:1080,frameRate:frameRate}};else if("firefox"===adapter.default.browserDetails.browser)constraints.video={mediaSource:that.firefoxPreferedSharing};else{var sharingSources=that.getDesktopSharingSource(),chromeMediaSource=sharingSources&&sharingSources.chromeMediaSource?sharingSources.chromeMediaSource:"desktop",chromeMediaSourceId=sharingSources&&sharingSources.chromeMediaSourceId?sharingSources.chromeMediaSourceId:null;constraints.video={mandatory:{chromeMediaSource:chromeMediaSource,maxWidth:1920,minWidth:1920,maxHeight:1080,minHeight:1080,maxFrameRate:frameRate}},chromeMediaSourceId&&(constraints.video.mandatory.chromeMediaSourceId=chromeMediaSourceId)}}$q.all(promises).then((function(){deferred.resolve(constraints)})).catch((function(){deferred.resolve()})),deferred.promise.then((function(constraint){if($log.info("[VideoService] GetUserMedia with constraint "+JSON.stringify(constraint)),constraint)try{shouldGetDisplayMedia?navigator.mediaDevices.getDisplayMedia(constraint).then((function(stream){$log.webrtc("MEDIA   | getDisplayMedia success"),stream.getVideoTracks().length&&$log.info("[videoService] getDisplayMedia video stream kind "+stream.getVideoTracks()[0].kind+", id "+stream.getVideoTracks()[0].id+", label "+stream.getVideoTracks()[0].label+", readyState "+stream.getVideoTracks()[0].readyState+", enabled "+stream.getVideoTracks()[0].enabled),stream&&(0===stream.getAudioTracks().length&&0===stream.getVideoTracks().length||!1===stream.active)&&($log.webrtc("Stream has no active audio or video tracks"),gaService.trackGetUserMediaErrorNoTrack(),reject(new Error("getDisplayMedia failure : Stream has no active audio or video tracks"))),stream.getVideoTracks()[0].onended=function(){$log.info("Stop screensharing in chrome has been triggered"),$rootScope.$broadcast("ON_CHROME_STOP_SCREEN_SHARING_TRIGGERED")},resolve(stream),gaService.trackGetUserMediaSuccess()})).catch((function(error){$log.webrtc("MEDIA   | getDisplayMedia failure: "+error),gaService.trackGetUserMediaError(),$rootScope.$broadcast("ON_WEBRTC_GETUSERMEDIA_ERROR",error),reject(new Error("getDisplayMedia failure "+error))})):navigator.mediaDevices.getUserMedia(constraint).then((function(stream){$log.webrtc("MEDIA   | getUserMedia success"),stream.getAudioTracks().length&&$log.info("[videoService] getUserMedia audio stream kind "+stream.getAudioTracks()[0].kind+", id "+stream.getAudioTracks()[0].id+", label "+stream.getAudioTracks()[0].label+", readyState "+stream.getAudioTracks()[0].readyState+", enabled "+stream.getAudioTracks()[0].enabled),stream.getVideoTracks().length&&$log.info("[videoService] getUserMedia video stream kind "+stream.getVideoTracks()[0].kind+", id "+stream.getVideoTracks()[0].id+", label "+stream.getVideoTracks()[0].label+", readyState "+stream.getVideoTracks()[0].readyState+", enabled "+stream.getVideoTracks()[0].enabled),stream&&(0===stream.getAudioTracks().length&&0===stream.getVideoTracks().length||!1===stream.active)&&($log.webrtc("Stream has no active audio or video tracks"),gaService.trackGetUserMediaErrorNoTrack(),reject(new Error("getUserMedia failure : Stream has no active audio or video tracks"))),extensionSharingService.extensionFound&&userMedia.indexOf("sharing")>=0&&(stream.getVideoTracks()[0].onended=function(){$log.info("Stop screensharing in chrome has been triggered"),$rootScope.$broadcast("ON_CHROME_STOP_SCREEN_SHARING_TRIGGERED")}),stream&&stream.getAudioTracks().length&&(stream.getAudioTracks()[0].onended=function(event){$log.error("audio stream track ended"),console.log(this),console.log(event)}),resolve(stream),gaService.trackGetUserMediaSuccess()})).catch((function(error){$log.webrtc("MEDIA   | getUserMedia failure: "+error),gaService.trackGetUserMediaError(),$rootScope.$broadcast("ON_WEBRTC_GETUSERMEDIA_ERROR",error),reject(new Error("getUserMedia failure "+error))}))}catch(err){$log.webrtc("MEDIA   | getUserMedia failure: "+err),gaService.trackGetUserMediaError(),reject(new Error("getUserMedia failure "+err))}else reject({message:"getUserMedia cancelled"})}))})):$q.when()},this.getBrowserMethodHandler=function(){var version="",returnValue=null;if(navigator.mozGetUserMedia&&$window.mozRTCPeerConnection){if(version=browserService.extractBrowserVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1),$log.webrtc("BROWSER | Detect Firefox navigator (version "+version+")"),version<this.minFirefoxWebRTCVersion)return $log.webrtc("BROWSER | Firefox navigator is not WebRTC capable before version "+this.minFirefoxWebRTCVersion),returnValue;returnValue={browser:"firefox",attachMediaStream:function(element,stream){element&&element[0]&&(element[0].mozSrcObject=stream,element[0].srcObject=stream,element[0].play())},pc_constraints:{},clearMediaStream:function(element){try{angular.isDefined(element[0])&&(element[0].pause(),element[0].mozSrcObject=null,element[0].srcObject=null,element[0].uniqueId=null)}catch(err){$log.webrtc("BROWSER | clearMediaStream failure "+err)}},attachMediaStreamIfNeeded:function(element,stream,uniqueId){$log.webrtc("BROWSER | attachMediaStreamIfNeeded for ID "+uniqueId),element&&element[0]&&(element[0].uniqueId!==uniqueId||!element[0].mozSrcObject&&!element[0].srcObject)&&(element[0].uniqueId=uniqueId,that.RTC.attachMediaStream(element,stream))}}}else if(navigator.webkitGetUserMedia&&$window.webkitRTCPeerConnection){if(version=browserService.extractBrowserVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2),$log.webrtc("BROWSER | Detect Chrome navigator (version "+version+")"),version<this.minChromeWebRTCVersion)return $log.webrtc("BROWSER | Chrome navigator is not WebRTC capable before version "+this.minChromeWebRTCVersion),returnValue;returnValue={browser:"chrome",attachMediaStream:function(element,stream){$log.webrtc("BROWSER | attachMediaStream to element"),element&&element[0]&&(element[0].srcObject=stream),$interval((function(){element&&element[0]&&element[0].load&&element[0].load()}),1e3,1)},pc_constraints:{},clearMediaStream:function(element){angular.isDefined(element[0])&&(element[0].pause(),element[0].srcObject=null,element[0].uniqueId=null)},attachMediaStreamIfNeeded:function(element,stream,uniqueId){$log.webrtc("BROWSER | attachMediaStreamIfNeeded for ID "+uniqueId),!element||!element[0]||element[0].uniqueId===uniqueId&&element[0].srcObject||(element[0].uniqueId=uniqueId,that.RTC.attachMediaStream(element,stream))}}}else window.RTCPeerConnection&&navigator.userAgent.match(/AppleWebKit\/(\d+)\./)&&(returnValue={browser:"safari",attachMediaStream:function(element,stream){element&&element[0]&&(element[0].setAttribute("playsinline",!0),element[0].srcObject=stream,element[0].play())},pc_constraints:{},clearMediaStream:function(element){try{angular.isDefined(element[0])&&(element[0].pause(),element[0].srcObject=null,element[0].uniqueId=null)}catch(err){$log.webrtc("BROWSER | clearMediaStream failure "+err)}},attachMediaStreamIfNeeded:function(element,stream,uniqueId){$log.webrtc("BROWSER | attachMediaStreamIfNeeded for ID "+uniqueId),!element||!element[0]||element[0].uniqueId===uniqueId&&element[0].srcObject||(element[0].uniqueId=uniqueId,that.RTC.attachMediaStream(element,stream))}});return returnValue},this.getIceConfig=function(){return $q((function(resolve,reject){var portalURL=config.restServerUrl+"/api/rainbow/geolocation/v1.0/";$http({method:"GET",url:portalURL+"settings/iceservers?nbServers=2",headers:authService.getRequestHeader()}).then((function(result){$log.info("[videoService] getIceConfig success");var iceServers=result.data.data;iceServers.forEach((function(element){delete element.id}),this),resolve({iceServers:iceServers})})).catch((function(error){$log.error("[videoService] getIceConfig failure -- "+error.message),reject(error)}))}))},this.getCompanyWebrtcConfig=function(){return $q((function(resolve,reject){var apiURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/settings/webrtc";$http({method:"GET",url:apiURL,headers:authService.getRequestHeader()}).then((function(result){$log.info("[videoService] getCompanyWebrtcConfig success");var config=result.data.data;resolve(config)})).catch((function(error){var msg=error&&error.data?error.data.errorDetails:"Unknown error";if(error&&error.data&&400100==error.data.errorDetailsCode)return $log.info("[videoService] getCompanyWebrtcConfig -- "+msg),resolve({});$log.error("[videoService] getCompanyWebrtcConfig failure -- "+msg),reject(error)}))}))},this.calculateNewCallType=function(call,session,type,action){var result=session.localType;return"contentAdd"===action&&("video"===type?(result=call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING?"sharing+video":"video",call.localMedia=call.localMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO):"sharing"===type?(result=call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO?"sharing+video":"sharing",call.localMedia=call.localMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING):"audio"===type&&(call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING?(result="sharing",call.localMedia=call.localMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO):(result="audio",call.localMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO))),"contentRemove"===action&&("video"===type?call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING?(result="sharing",call.localMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING):(result="audio",call.localMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO):"sharing"===type&&(call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO?(result="video",call.localMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO):(result="audio",call.localMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO))),"contentModify"===action&&call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO&&!(call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING)&&(result="video"),$log.info("[videoService] calculateNewCallType for type "+type+" and action "+action+" with result "+result),result},this.updateCurrentCall=function(call,session,type,action){$log.info("[videoService] updateCurrentCall for type "+type+" and action "+action);for(var newType=this.calculateNewCallType(call,session,type,action),i=0;i<that.localStreams.length;i++)"chrome"===adapter.default.browserDetails.browser?session.addStream(that.localStreams[i]):session.replaceStream(that.localStreams[i]),session.localStreams.push(that.localStreams[i]);switch(action){case"contentAdd":session.contentAdd(newType);break;case"contentRemove":session.contentRemove(newType);break;case"contentModify":session.contentModify(newType)}contactService.setBusyState("dnd",that.calculatePresenceMessage(call)),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),$rootScope.$broadcast("ON_WEBRTC_CALL_ESCALATION",call)},this.createOrUpdateStatisticsForCall=function(callId){var call=this.calls[callId];if(call){var metrics=[];if(this.callsStats[callId])return this.callsStats[callId].RainMetrics&&this.callsStats[callId].push(this.callsStats[callId].RainMetrics),metrics.push({connectionId:callId,stats:this.callsStats[callId]}),void this.updateStatisticsForCall(this.callsStats[callId].id,callId,call.contact.dbId,"ended",metrics);$log.info("[videoService] createOrUpdateStatisticsForCall "+callId),this.callsStats[callId]={},metrics.push({connectionId:callId,stats:this.callsStats[callId]}),this.createStatisticsForSession(callId,call.contact.dbId,"pending",metrics).then((function(id){that.callsStats[callId].id=id,$log.info("[videoService] createOrUpdateStatisticsForCall success for session "+callId+" with id "+id)})).catch((function(error){$log.error("[videoService] createOrUpdateStatisticsForCall "+error.message)}))}else $log.warn("[videoService] createOrUpdateStatisticsForCall -- missing call "+callId)},this.createStatisticsForSession=function(callId,peerId,callState,metrics){return $q((function(resolve,reject){$log.info("[videoService] createStatisticsForSession "+callId);var portalURL=config.restServerUrl+"/api/rainbow/metrics/v1.0/";$http({method:"POST",url:portalURL+"webrtcmetrics",headers:authService.getRequestHeader(),data:{callId:callId,peerId:peerId,callState:callState}}).then((function(response){$log.info("[videoService] createStatisticsForSession success"),response&&response.data&&response.data.data&&response.data.data.id&&(that.callsStats[callId]||(that.callsStats[callId]={}),resolve(response.data.data.id))}),(function(response){$log.error("[videoService] createStatisticsForSession failure "+response.errorMsg),reject(new Error(response.errorMsg))}))}))},this.updateStatisticsForCall=function(id,callId,peerId,callState,metrics){if($log.info("[videoService] updateStatisticsForCall "+callId),id){var portalURL=config.restServerUrl+"/api/rainbow/metrics/v1.0/";$http({method:"POST",url:portalURL+"webrtcmetrics/"+id+"/metrics",headers:authService.getRequestHeader(),data:{metrics:metrics}}).then((function(){$log.info("[videoService] updateStatisticsForCall success"),"ended"===callState&&($log.info("[videoService] updateStatisticsForCall -- update call state with "+callState),$http({method:"PUT",url:portalURL+"webrtcmetrics/"+id,headers:authService.getRequestHeader(),data:{callState:callState}}).then((function(){$log.info("[videoService] updateStatisticsForCall -- update call state success")}),(function(response){$log.error("[videoService] updateStatisticsForCall failure "+response.errorMsg)})))}),(function(response){$log.error("[videoService] updateStatisticsForCall failure "+response.errorMsg)}))}else $log.warn("[videoService] updateStatisticsForCall -- missing id for callId "+callId)},this.sendDTMF=function(dialString,call,skipHandle){var session=xmppService.connection.jingle.sessions[call.id];if(session&&session.peerconnection){var audioDtmfSender=session.peerconnection.getSenders().find((function(sender){return sender.dtmf&&sender.track&&sender.track.enabled&&"audio"===sender.track.kind})),dtmfSender=audioDtmfSender?audioDtmfSender.dtmf:null;dtmfSender?($log.debug("[videoService] sendDTMF: dtmf sender found on webrtc session for call id "+call.id+" dialstring: "+dialString),dtmfSender.ontonechange=skipHandle?this.silentToneChangeEventHandle:this.handleToneChangeEvent,dtmfSender.insertDTMF(dialString)):$log.error("[videoService] sendDTMF: no dtmf sender found on webrtc session for call id "+call.id)}else $log.error("[videoService] sendDTMF: no webrtc session found for call id "+call.id)},this.handleToneChangeEvent=function(event){""!==event.tone&&($log.debug("[videoService] Dtmf Tone played: "+event.tone),$rootScope.$broadcast("ON_DTMF_SENT",event.tone))},this.silentToneChangeEventHandle=function(event){$log.debug("[videoService] Dtmf Tone played: "+event.tone)},angular.element(document).bind("transportreplace.jingle",(function(__event,callId){$log.webrtc("JINGLE  | transportreplace.jingle "+callId);var sess=xmppService.connection.jingle.sessions[callId];sess?sess.sendAnswer(void 0,"transport-accept"):$log.warn("JINGLE  | transportreplace.jingle no such session !")})),angular.element(document).bind("callactive.jingle",(function(__event,callId){$log.webrtc("JINGLE  | callactive "+callId)})),angular.element(document).bind("remotestreamadded.jingle",(function(__event,sid,hasAudioTracks){$log.webrtc("JINGLE  | remoteStreamadded "+sid);var sess=xmppService.connection.jingle.sessions[sid];if(sess&&sess.remoteStreams&&!sess.confId){var call=that.calls[sid];call&&that.attachDistantMediaStreams(!0,call),$rootScope.$broadcast("ON_WEBRTC_REMOTE_STREAM_ADDED",sess.remoteStreams)}hasAudioTracks&&that.resetAudioOutputElement()})),angular.element(document).bind("remotestreamremoved.jingle",(function(__event,sid){$log.webrtc("JINGLE  | remotestreamremoved "+sid)})),angular.element(document).bind("callaccepted.jingle",(function(__event,sid){$log.webrtc("JINGLE  | callaccepted "+sid);var call=that.calls[sid],sess=xmppService.connection.jingle.sessions[sid];call&&sess&&(that.statsInterval&&($log.webrtc("JINGLE  | remove getStats interval"),window.clearInterval(that.statsInterval),that.statsinterval=null),that.createOrUpdateStatisticsForCall(call.id),$log.webrtc("JINGLE  | start getStats interval"),that.statsInterval=sess.getStats(5e3)),call&&call.status.key!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE.key&&($log.webrtc("INFO    | call has been accepted. Set current call to ACTIVE state"),angular.element(document).trigger("callactive.jingle",[sid]))})),angular.element(document).bind("nostuncandidates.jingle",(function(__event,sid){$log.webrtc("JINGLE  | nostuncandidates "+sid),gaService.trackICENoSTUNCandidate()})),angular.element(document).bind("ringing.jingle",(function(__event,sid){$log.webrtc("JINGLE  | callremoteringing "+sid)})),angular.element(document).bind("mediafailure.jingle",(function(){$log.webrtc("JINGLE  | callmediafailure")})),angular.element(document).bind("mute.jingle",(function(__event,sid){$log.webrtc("JINGLE  | mute "+sid);var call=that.calls[sid];call.isRemoteVideoMuted=!0,$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)})),angular.element(document).bind("unmute.jingle",(function(__event,sid){$log.webrtc("JINGLE  | unmute "+sid);var call=that.calls[sid];call.isRemoteVideoMuted=!1,$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)})),angular.element(document).bind("hold.jingle",(function(__event,sid){$log.webrtc("JINGLE  | hold "+sid);var session=xmppService.connection.jingle.sessions[sid];session?(session.muteAudio(!0),$rootScope.$broadcast("ON_HOLD_TONE_EVENT","hold")):$log.webrtc("MEDIA   | hold - received on a non existing session !")})),angular.element(document).bind("unhold.jingle",(function(__event,sid){$log.webrtc("JINGLE  | unhold "+sid);var session=xmppService.connection.jingle.sessions[sid];session?(session.muteAudio(!1),$rootScope.$broadcast("ON_HOLD_TONE_EVENT","unhold")):$log.webrtc("MEDIA   | unhold - received on a non existing session !")})),angular.element(document).bind("remoteIceFailed.jingle",(function(sid){$log.webrtc("JINGLE  | remoteIceFailed "+sid),that.openErrorPopup("IceConnectionFailed")})),angular.element(document).bind("mediamodified.jingle",(function(__event,sid,mediaType){$log.webrtc("JINGLE  | mediamodified "+sid),that.videoEventHandler.mediaModified(sid,mediaType)})),angular.element(document).bind("statsChrome.jingle",(function(__event,sid,items){for(var i=0;i<items.length;++i)switch(items[i].type){case"googComponent":gRTCStatsService.addStreamToCall(sid,items[i]);break;case"ssrc":gRTCStatsService.addSSRCToStream(sid,items[i])}})),angular.element(document).bind("statsFirefox.jingle",(function(__event,sid,items){for(var i=0;i<items.length;++i)switch(items[i].type){case"inboundrtp":case"outboundrtp":fRTCStatsService.addStreamToCall(sid,items[i]);break;case"candidatepair":fRTCStatsService.addCandidatePairToCall(sid,items[i])}})),angular.element(document).bind("webrtcFirefoxStats.jingle",(function(__event,sid,data){if(that.callsStats.sid||(that.callsStats.sid={}),that.callsStats[sid]||(that.callsStats[sid]={}),that.calls[sid]){var currentStats=that.callsStats[sid];currentStats&&(data.videoReceived?currentStats.video=data:currentStats.audio=data,that.callsStats[sid]=currentStats)}})),angular.element(document).bind("webrtcConnectionType.jingle",(function(__event,sid,connectionType){var activeCall=that.calls[sid];connectionType&&($log.webrtc("STATS   | Local candidate ("+connectionType.localAddress+") type is "+connectionType.localCandidateType),$log.webrtc("STATS   | Remote candidate  ("+connectionType.remoteAddress+") type is "+connectionType.remoteCandidateType),activeCall&&activeCall.isInitiator&&gaService.trackICEUsed(connectionType.localCandidateTypee,connectionType.remoteCandidateType),connectionType.networkType&&($log.webrtc("STATS   | Network type is "+connectionType.networkType),activeCall&&activeCall.isInitiator&&gaService.trackICETopology(connectionType.networkType)))})),angular.element(document).bind("webrtcSessionStats.jingle",(function(__event,sid,data){that.callsStats.sid||(that.callsStats.sid={}),that.callsStats[sid]||(that.callsStats[sid]={});var id=that.callsStats[sid].id;that.callsStats[sid]=data,that.callsStats[sid].id=id}))}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0);angular.module("rainbow").factory("VideoServiceEventHandler",["$log","$rootScope","$interval","contactService","xmppService","profileService","gaService","uuid4",function($log,$rootScope,$interval,contactService,xmppService,profileService,gaService,uuid4){function VideoServiceEventHandler(videoService){this.videoService=videoService,this.nameSpace="urn:xmpp:jingle-message:0"}return VideoServiceEventHandler.create=function(videoService){return new VideoServiceEventHandler(videoService)},VideoServiceEventHandler.prototype.setRemoteTypeMedia=function(remoteType,call){call.remoteMedia=0;for(var i=0;i<remoteType.length;i++)switch(remoteType[i]){case"audio":call.remoteMedia=call.remoteMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO;break;case"video":call.remoteMedia=call.remoteMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO;break;case"sharing":call.remoteMedia=call.remoteMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING;break;default:call.remoteMedia=null}$log.debug("REMOTE TYPE || REMOTE MEDIA  "+call.remoteMedia)},VideoServiceEventHandler.prototype.setLocalTypeMedia=function(localType,call){call.localMedia=0;for(var i=0;i<localType.length;i++)switch(localType[i]){case"audio":call.localMedia=call.localMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO;break;case"video":call.localMedia=call.localMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO;break;case"sharing":call.localMedia=call.localMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING;break;default:call.localMedia=null}$log.debug("LOCAL TYPE || LOCAL MEDIA  "+call.localMedia)},VideoServiceEventHandler.prototype.sendProposition=function(contact,media,message){$log.info("[VideoServiceEventHandler]   | sendProposition to "+JSON.stringify({displayName:contact.displayNameForLog(),resources:contact.resources}));var that=this,mediaToGet=["audio"],secondMediaToGet=[];"video"===media?mediaToGet.push("video"):"videoOnly"===media?mediaToGet=["video"]:"sharing"===media?(mediaToGet=["sharing"],secondMediaToGet=["audio"]):"sharingOnly"===media&&(mediaToGet=["sharing"]);var id="web_"+uuid4.generate(),call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.DIALING,id,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.WEBRTC,contact);this.videoService.getBrowserMedia(mediaToGet).then((function(stream){that.videoService.getBrowserMedia(secondMediaToGet).then((function(extraStream){if(that.videoService.makingCall&&that.videoService.started){call.isInitiator=!0,stream.callId=id,that.videoService.localStreams.push(stream),extraStream&&(extraStream.callId=id,that.videoService.localStreams.push(extraStream),mediaToGet.push(secondMediaToGet.pop())),that.videoService.calls[call.id]=call,that.setLocalTypeMedia(mediaToGet,call);var idPropose="web_"+uuid4.generate(),xmppMessage=$msg({from:contactService.userContact.fullJid,to:contact.jid,id:idPropose});xmppMessage.c("propose",{xmlns:that.nameSpace,id:id}),message&&xmppMessage.c("subject",{xmlns:"urn:xmpp:jingle-subject:0"}).t(message).up(),xmppMessage.c("description",{xmlns:"urn:xmpp:jingle:apps:rtp:1",media:mediaToGet[0]}).up(),mediaToGet[1]&&(xmppMessage=xmppMessage.c("description",{xmlns:"urn:xmpp:jingle:apps:rtp:1",media:mediaToGet[1]}).up()),profileService.isFeatureEnabled(profileService.FeaturesEnum.WEBRTC_UNIFIED_PLAN)&&(xmppMessage=xmppMessage.c("unifiedplan",{xmlns:"urn:xmpp:jingle:apps:jsep:1"}).up()),xmppService.send(xmppMessage),that.videoService.makingCall=!1,contactService.setBusyState("dnd",that.videoService.calculatePresenceMessage(call)),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),that.videoService.autoreleaseTimeout&&$interval.cancel(that.videoService.autoreleaseTimeout),that.videoService.autoreleaseTimeout=$interval((function(_call){$log.webrtc("MEDIA   | send proposition : no response after 30 seconds : release the call"),call&&that.videoService.rejectCall(_call)}),3e4,1,!0,call)}else $log.warn("[VideoServiceEventHandler]   | sendProposition -- call should no longer be made !"),that.videoService.makingCall=!1,stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),stream=null,extraStream&&(extraStream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),extraStream.stop&&extraStream.stop(),extraStream=null)})).catch((function(error){$log.info("[VideoServiceEventHandler]   | sendProposition failure : "+JSON.stringify({error:error.message})),that.videoService.makingCall=!1,-1!==error.toString().indexOf("getUserMedia")&&that.videoService.openErrorPopup(),that.videoService.removeCallObject(call),that.videoService.isUserContactInCall()||that.videoService.resetToSafeState(),that.videoService.autoreleaseTimeout&&$interval.cancel(that.videoService.autoreleaseTimeout)}))})).catch((function(error){$log.info("[VideoServiceEventHandler]   | sendProposition failure : "+JSON.stringify({error:error.message})),that.videoService.makingCall=!1,mediaToGet.indexOf("sharing")>=0||-1===error.toString().indexOf("getUserMedia")||that.videoService.openErrorPopup(),that.videoService.removeCallObject(call),that.videoService.isUserContactInCall()||that.videoService.resetToSafeState()}))},VideoServiceEventHandler.prototype.retractProposition=function(call){$log.info("[VideoServiceEventHandler]   | retractProposition for call "+call.id);var idRetract="web_"+uuid4.generate(),xmppMessage=$msg({from:contactService.userContact.fullJid,to:call.contact.jid,id:idRetract}).c("retract",{xmlns:this.nameSpace,id:call.id});xmppService.send(xmppMessage),contactService.resetBusyState(),this.videoService.removeCallObject(call)},VideoServiceEventHandler.prototype.acceptProposition=function(call,type){if(call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ANSWERING){$log.info("[VideoServiceEventHandler]   | acceptProposition for call "+call.id),call.status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ANSWERING;var idAccept="web_"+uuid4.generate(),xmppMessage=$msg({from:contactService.userContact.fullJid,to:contactService.userContact.jid,id:idAccept}).c("accept",{xmlns:this.nameSpace,id:call.id});xmppService.send(xmppMessage);var idProceed="web_"+uuid4.generate();xmppMessage=$msg({from:contactService.userContact.fullJid,to:call.fullJid,id:idProceed}).c("proceed",{xmlns:this.nameSpace,id:call.id}),call.unifiedPlanActivated&&(xmppMessage=xmppMessage.c("unifiedplan",{xmlns:"urn:xmpp:jingle:apps:jsep:1"}).up(),xmppService.connection.jingle.jid2session[call.fullJid]={unifiedPlan:!0}),xmppService.send(xmppMessage);var mediaToGet=["audio"];type&&"video"===type&&mediaToGet.push("video"),call.remoteMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO&&(mediaToGet=["video"]),call.remoteMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING&&(mediaToGet=[]),this.setLocalTypeMedia(mediaToGet,call),contactService.setBusyState("dnd",this.videoService.calculatePresenceMessage(call)),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call);var that=this;that.videoService.autoreleaseTimeout&&$interval.cancel(that.videoService.autoreleaseTimeout),that.videoService.autoreleaseTimeout=$interval((function(_call){_call&&(null!==call.getMediaPillarCall()?$log.warn("[webrtcgateway/VideoServiceEventHandler] | acceptProposition autoreleaseTimeout after 45 s : remove the call :"+_call.id):$log.webrtc("[VideoServiceEventHandler] | acceptProposition autoreleaseTimeout after 45 s : remove the call "+_call.id),that.videoService.removeCallObject(_call),contactService.resetBusyState())}),45e3,1,!0,call)}else $log.warn("[VideoServiceEventHandler]   | acceptProposition for call "+call.id+" -- ignored! Already answering")},VideoServiceEventHandler.prototype.rejectProposition=function(call,__reason){$log.info("[VideoServiceEventHandler]   | rejectProposition for call "+call.id);var idRejectToMe="web_"+uuid4.generate(),xmppMessage=$msg({from:contactService.userContact.fullJid,to:contactService.userContact.jid,id:idRejectToMe}).c("reject",{xmlns:this.nameSpace,id:call.id});xmppService.send(xmppMessage);var mediaPillarContext=call.getMediaPillarCall(),otherJid=mediaPillarContext&&mediaPillarContext.mediaPillarJid?mediaPillarContext.mediaPillarJid:call.contact.jid,idRejectToDistant="web_"+uuid4.generate();otherJid?(xmppMessage=$msg({from:contactService.userContact.fullJid,to:otherJid,id:idRejectToDistant}).c("reject",{xmlns:this.nameSpace,id:call.id,reason:__reason}),xmppService.send(xmppMessage)):$log.error("[VideoServiceEventHandler] | rejectProposition -- missing other JID !"),call&&(call.status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN,delete this.videoService.calls[call.id],$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)),this.videoService.setWebrtcConfiguration(),this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout)},VideoServiceEventHandler.prototype.onMessageReceived=function(stanza){var that=this;try{$rootScope.$apply((function(){$log.info("[VideoServiceEventHandler]   | onMessageReceived");var temp=$(stanza);temp.find("error").length>0||temp.find("delay").length>0||$(stanza).find("service-unavailable").length>0?that.onMessageReceivedError():temp.find("propose").length>0?that.onPropositionReceived(stanza):temp.find("retract").length>0?that.onRetractReceived(stanza):temp.find("reject").length>0?that.onRejectReceived(stanza):temp.find("accept").length>0?that.onAcceptReceived(stanza):temp.find("proceed").length>0&&that.onProceedReceived(stanza)}))}catch(error){return $log.error("[VideoServiceEventHandler]   | onMessageReceived error "+error),!0}return!0},VideoServiceEventHandler.prototype.onMessageReceivedError=function(stanza){$log.info("[VideoServiceEventHandler]   | onMessageReceivedError");var id=$(stanza).find("propose").attr("id"),call=this.videoService.calls[id];call&&$log.error("[VideoServiceEventHandler]   | onMessageReceivedError call is in "+call.status.value+" state")},VideoServiceEventHandler.prototype.onPropositionReceived=function(stanza){var id=$(stanza).find("propose").attr("id");$log.info("[VideoServiceEventHandler]   | onPropositionReceived for ID "+id);var call=this.videoService.calls[id],that=this;if(call){if($(stanza).find("subject").length>0){var subject=$(stanza).find("subject")[0];$log.debug("[VideoServiceEventHandler]   | onPropositionReceived subject Detected: "+subject.textContent),call.setSubject(subject.textContent)}call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING),that.videoService.config.unifiedPlan&&(call.unifiedPlanActivated=!0);remoteMedia=[];for(var length=$(stanza).find("description").length,i=0;i<length;i++){var description=$(stanza).find("description")[i];remoteMedia.push($(description).attr("media"))}this.setRemoteTypeMedia(remoteMedia,call),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),that.videoService.autoreleaseTimeout&&$interval.cancel(that.videoService.autoreleaseTimeout),that.videoService.autoreleaseTimeout=$interval((function(_call){_call&&($log.webrtc("[VideoServiceEventHandler]   | onPropositionReceived autoreleaseTimeout after 2 min : remove the call "+_call.id),that.videoService.removeCallObject(_call))}),12e4,1,!0,call)}else{var jid=$(stanza).attr("from"),remoteMedia=[],peerJid=xmppService.getBareJidFromJid(jid);(call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN,id,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.WEBRTC)).fullJid=jid,that.videoService.calls[call.id]=call,that.videoService.config.unifiedPlan&&(call.unifiedPlanActivated=!0),profileService.isFeatureEnabled(profileService.FeaturesEnum.WEBRTC_UNIFIED_PLAN)&&$(stanza).find("unifiedplan").length&&(call.unifiedPlanActivated=!0),contactService.getOrCreateContact(peerJid).then((function(contact){for(var length=$(stanza).find("description").length,i=0;i<length;i++){var description=$(stanza).find("description")[i];remoteMedia.push($(description).attr("media"))}if(that.videoService.calls[call.id]){if(call.contact=contact,$(stanza).find("subject").length>0){var subject=$(stanza).find("subject")[0];$log.debug("[VideoServiceEventHandler]   | onPropositionReceived subject Detected: "+subject.textContent),call.setSubject(subject.textContent)}call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING),that.setRemoteTypeMedia(remoteMedia,call),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),that.videoService.autoreleaseTimeout&&$interval.cancel(that.videoService.autoreleaseTimeout),that.videoService.autoreleaseTimeout=$interval((function(_call){_call&&($log.webrtc("[VideoServiceEventHandler]   | onPropositionReceived autoreleaseTimeout after 2 min : remove the call "+_call.id),that.videoService.removeCallObject(_call))}),12e4,1,!0,call)}})).catch((function(error){$log.error("[VideoServiceEventHandler]   | onPropositionReceived error "+error),that.videoService.removeCallObject(call)}))}},VideoServiceEventHandler.prototype.onRetractReceived=function(stanza){$log.info("[VideoServiceEventHandler]   | onRetractReceveid");var id=$(stanza).find("retract").attr("id"),call=this.videoService.calls[id];call&&(call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ANSWERING&&contactService.resetBusyState(),this.videoService.removeCallObject(call)),this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout)},VideoServiceEventHandler.prototype.onRejectReceived=function(stanza){$log.info("[VideoServiceEventHandler]   | onRejectReceived");var id=$(stanza).find("reject").attr("id"),call=this.videoService.calls[id],fullJid=$(stanza).attr("from"),calendarBusy="calendarBusy"===$(stanza).find("reject").attr("reason");this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout),call&&(call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING&&(null!==call.getMediaPillarCall()&&$rootScope.$broadcast("ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT",call),this.videoService.removeCallObject(call)),call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.DIALING&&(contactService.resetBusyState(),this.videoService.removeCallObject(call)),call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE&&call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.CONNECTING||call.fullJid&&call.fullJid===fullJid&&(contactService.resetBusyState(),this.videoService.removeCallObject(call))),calendarBusy&&this.videoService.openCalendarBusyPopup(call.contact.id)},VideoServiceEventHandler.prototype.onAcceptReceived=function(stanza){$log.info("[VideoServiceEventHandler]   | onAcceptReceived");var id=$(stanza).find("accept").attr("id"),call=this.videoService.calls[id],fullJid=$(stanza).attr("from");call&&fullJid!==contactService.userContact.fullJid&&(null!==call.getMediaPillarCall()&&$rootScope.$broadcast("ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT",call),this.videoService.removeCallObject(call)),fullJid!==contactService.userContact.fullJid&&this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout)},VideoServiceEventHandler.prototype.onProceedReceived=function(stanza){$log.info("[VideoServiceEventHandler]   | onProceedReceived"),this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout);var id=$(stanza).find("proceed").attr("id"),call=this.videoService.calls[id],fullJid=$(stanza).attr("from");if(call.fullJid=fullJid,this.videoService.config.unifiedPlan&&(call.unifiedPlanActivated=!0),$(stanza).find("unifiedplan").length&&(call.unifiedPlanActivated=!0),call.isInConversationWithMobile()&&call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO){var that=this,mediaToGet=[],mediaConstraints=that.videoService.getMobileMediaConstraints("video");mediaToGet=["audio","video"],call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO||(mediaToGet=["video"]),that.videoService.getBrowserMedia(mediaToGet,mediaConstraints.fixedVideoWidth,mediaConstraints.fixedVideoHeight,mediaConstraints.fixedFrameRate).then((function(stream){$log.info("[VideoServiceEventHandler]   | onProceedReceived --\x3e renegociate video quality"),call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO&&that.videoService.stopActiveAudioVideoStreams(null,!0),that.videoService.localStreams.push(stream),that.videoService.makeJingleCall(call)})).catch((function(error){$log.info("[VideoServiceEventHandler]   | onProceedReceived "+call+" failure : "+error.message),-1!==error.toString().indexOf("getUserMedia")?($log.info("onProceedReceived impossible, no webcam plugged"),that.videoService.openErrorPopup()):(that.videoService.releaseCall(call),that.videoService.resetToSafeState())}))}else call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING?this.videoService.makeJingleSharingCall(call):this.videoService.makeJingleCall(call)},VideoServiceEventHandler.prototype.incomingCall=function(callId){$log.info("[VideoServiceEventHandler] incomingCall "+callId);var that=this,call=null,sess=xmppService.connection.jingle.sessions[callId];if(sess&&sess.peerjid){var peerJid=xmppService.getBareJidFromJid(sess.peerjid),contact=contactService.getContactByJid(peerJid);call=this.videoService.getCallByJid(contact.jid)}call?(sess.sendRinging(),$interval((function(_call){that.videoService.answerJingleCall(_call)}),350,1,!0,call),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout),this.videoService.statsInterval&&($log.info("[VideoServiceEventHandler] remove getStats interval"),window.clearInterval(this.videoService.statsInterval),this.videoService.statsinterval=null),that.videoService.createOrUpdateStatisticsForCall(call.id),$log.info("[VideoServiceEventHandler] start getStats interval"),this.videoService.statsInterval=sess.getStats(5e3)):($log.warn("[VideoServiceEventHandler] incomingCall no such call ! Terminate the session "),contactService.resetBusyState(),sess&&sess.terminate())},VideoServiceEventHandler.prototype.activeCall=function(callId){$log.info("[VideoServiceEventHandler] activeCall "+callId);var sess=xmppService.connection.jingle.sessions[callId];this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout);var call=this.videoService.calls[callId];this.videoService.updateRemoteTypeMedia(sess.remoteType,call),call&&call.status.key!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RELEASING.key&&call.status.key!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN.key&&(call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)),call.isInitiator&&gaService.trackCallSuccessNumber(sess.localType)},VideoServiceEventHandler.prototype.terminatedCall=function(callId,callReason){0===Object.keys(xmppService.connection.jingle.sessions).length&&$log.webrtc("INFO    | all calls terminated");var call=this.videoService.calls[callId];call||0===this.videoService.calls.length?("busy"===callReason&&this.videoService.openErrorPopup("remoteUserNoMoreAvailable"),this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout),this.videoService.disableAudioVideoMedia(null,callId),this.videoService.createOrUpdateStatisticsForCall(callId),this.videoService.callsStats[callId]&&delete this.videoService.callsStats[callId],call&&("cancel"!==callReason&&gaService.trackCallDuration((new Date).getTime()-call.startDate.getTime()),this.videoService.removeCallObject(call)),$interval((function(){contactService.resetBusyState()}),1e3,1,!0),this.videoService.statsInterval&&(window.clearInterval(this.videoService.statsInterval),this.videoService.statsinterval=null),this.videoService.displayWebRTCStats(callId),this.videoService.isUserContactInCall()||this.videoService.clearSrcObjectsFromElements()):$log.webrtc("INFO    | terminatedCall : no call with "+callId+" exists.")},VideoServiceEventHandler.prototype.onJingleError=function(sid){sid&&this.videoService.calls[sid]&&this.videoService.calls[sid].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE&&(this.videoService.removeCallObject(this.calls[sid]),this.videoService.resetToSafeState(),this.videoService.openErrorPopup("IceConnectionFailed"))},VideoServiceEventHandler.prototype.iceConnectionStateChange=function(sid,sess){$log.info("[VideoServiceEventHandler] iceConnectionStateChange for "+sid);var that=this,activeCall=null,call=that.videoService.calls[sess.sid];try{if(sess.peerconnection&&"stable"===sess.peerconnection.signalingState&&"connected"===sess.peerconnection.iceConnectionState){$log.webrtc("INFO    | ICE Connection established successfully"),angular.element("#globalAudioTag")[0]&&$log.info("[VideoServiceEventHandler] sinkId for globalAudioTag is "+angular.element("#globalAudioTag")[0].sinkId),that.videoService.reconnectCall=!1,(activeCall=that.videoService.calls[sid])&&activeCall.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE&&($log.webrtc("INFO    | ICE Connection : call is active now !"),this.activeCall(sid)),sess.isRenegotiating&&($log.webrtc("INFO    | Renegotiating done"),sess.isRenegotiating=!1,$rootScope.$broadcast("ON_WEBRTC_CALL_ESCALATION",activeCall),$rootScope.$broadcast("ON_WEBRTC_CALL_ESCALATION_SUCCESS",activeCall)),sess.autoReconnectTimer&&($interval.cancel(sess.autoReconnectTimer),sess.autoReconnectTimer=null),gaService.endNegotiationTime();var negotiationTime=gaService.negotiationTime();negotiationTime&&($log.webrtc("INFO    | negotiation time: "+negotiationTime+"ms"),gaService.trackNegotiationTime()),activeCall&&activeCall.isInitiator&&gaService.trackICESuccess(sid)}sess.peerconnection&&"stable"===sess.peerconnection.signalingState&&"completed"===sess.peerconnection.iceConnectionState&&($log.webrtc("INFO    | ICE Connection completed successfully"),that.videoService.reconnectCall=!1,(activeCall=that.videoService.calls[sid])&&activeCall.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE&&($log.webrtc("INFO    | ICE Connection : call is active now !"),this.activeCall(sid)),sess.isRenegotiating&&($log.webrtc("INFO    | Renegotiating done"),sess.isRenegotiating=!1,$rootScope.$broadcast("ON_WEBRTC_CALL_ESCALATION",activeCall),$rootScope.$broadcast("ON_WEBRTC_CALL_ESCALATION_SUCCESS",activeCall))),sess.peerconnection&&"stable"===sess.peerconnection.signalingState&&"disconnected"===sess.peerconnection.iceConnectionState&&($log.webrtc("INFO    | signalingState disconnected"),call&&call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN&&($log.webrtc("INFO    | iceConnectionStateChange go to connecting state"),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.CONNECTING),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)),that.videoService.connected||(that.videoService.reconnectCall=!0),sess.autoReconnectTimer||(console.error("arm autoReconnectTimer"),sess.autoReconnectTimer=$interval((function(session){console.error("autoReconnectTimer -- execute"),that.videoService.connected&&(console.error("autoReconnectTimer -- network OK, proceed with reconnect"),session.reconnectSession())}),1e3,1,!0,sess))),sess.peerconnection&&"stable"===sess.peerconnection.signalingState&&"failed"===sess.peerconnection.iceConnectionState&&($log.webrtc("INFO    | signalingState FAILED"),call&&call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN&&($log.webrtc("INFO    | iceConnectionStateChange go to connecting state"),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.CONNECTING),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),$rootScope.$broadcast("ON_RECORDING_CNXLOST_EVENT")),that.videoService.connected||(that.videoService.reconnectCall=!0),that.videoService.connected&&(console.error("[videoServiceEventHandler] signalingState FAILED -- network OK, proceed with reconnect"),session.reconnectSession()))}catch(error){try{$log.error("JINGLE  | iceconnectionstatechange error "+error),call?that.videoService.removeCallObject(call,"unsupported-applications"):xmppService.connection.jingle.terminate(null,"unsupported-applications"),contactService.resetBusyState()}catch(err){$log.error("JINGLE  | iceconnectionstatechange error "+err),contactService.resetBusyState()}}},VideoServiceEventHandler.prototype.mediaModified=function(sid,mediaType){$log.info("[VideoServiceEventHandler] mediaModified "+sid);var call=this.videoService.calls[sid];xmppService.connection.jingle.sessions[sid].isRenegotiating=!0,call.remoteMedia="sharing"===mediaType?_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING:"video"===mediaType?_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO:"sharing+video"===mediaType?_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING:_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO,contactService.setBusyState("dnd",this.videoService.calculatePresenceMessage(call)),$rootScope.$broadcast("ON_WEBRTC_CALL_ESCALATION",call)},VideoServiceEventHandler}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0);angular.module("rainbow").service("webrtcServiceEventHandler",["$log","$q","$rootScope","videoService","webConferenceService","xmppService","contactService",function($log,$q,$rootScope,videoService,webConferenceService,xmppService,contactService){var service=this;this.nameSpace="urn:xmpp:jingle-message:0",this.messageHandlerRef=null,this.started=!1,this.start=function(){return this.started=!0,this.attachHandlers(),$q.when()},this.stop=function(){return this.started=!1,service.removeHandlers(),$q.when()},this.attachHandlers=function(){this.removeHandlers(),$log.info("[webrtcServiceEventHandler] attachHandlers"),this.messageHandlerRef||(this.messageHandlerRef=xmppService.addHandler((function(stanza){try{return service.onMessageReceived(stanza),!0}catch(err){return $log.error("[webrtcServiceEventHandler] caught error "+err),!0}}),service.nameSpace,"message"))},this.removeHandlers=function(){$log.info("[webrtcServiceEventHandler] removeHandlers"),this.messageHandlerRef&&(xmppService.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null)},this.onMessageReceived=function(stanza){var fromJid=$(stanza).attr("from"),bareJid=xmppService.getBareJidFromJid(fromJid),conferenceSessionId=$(stanza).find("propose").find("conference").attr("id");if(webConferenceService.getConferenceSessionById(conferenceSessionId))try{if($log.info("[webrtcServiceEventHandler]   | onMessageReceived"),$(stanza).find("propose").length>0){var id=$(stanza).find("propose").attr("id"),xmppMessage=$msg({from:contactService.userContact.fullJid,to:contactService.userContact.jid}).c("accept",{xmlns:this.nameSpace,id:id});xmppService.send(xmppMessage);xmppMessage=$msg({from:contactService.userContact.fullJid,to:bareJid}).c("proceed",{xmlns:this.nameSpace,id:id});return xmppService.send(xmppMessage),!0}}catch(error){return videoService.videoEventHandler.onMessageReceived(stanza)}return videoService.videoEventHandler.onMessageReceived(stanza)},this.checkSessionAudioSentHealthStatus=function(sid){$log.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- 0 audio packets sent !");var call=videoService.calls[sid];if(call&&!call.isInCallWithMediaPillar()){if(call.status.key===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE.key&&call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO&&!call.isMuted){if(videoService.callsStatsSimplified[sid].numberOfErrorAudioSent+=1,videoService.callsStatsSimplified[sid].numberOfErrorAudioSent%2)return void $log.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- ingore");var session=xmppService.connection.jingle.sessions[call.id];session&&!session.isRenegotiating&&($log.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- renego P2P call"),videoService.renegotiateCurrentCall(call)),$rootScope.$broadcast("ON_WEBRTC_CALL_AUDIO_ISSUE",!0)}}else{var confSession=webConferenceService.getActiveConferenceSession();if(confSession&&confSession.id&&confSession.active&&"connected"===confSession.status){var audioSession=webConferenceService.getRemoteAudioSession(confSession.id);if(audioSession&&audioSession.sid===sid){if(videoService.callsStatsSimplified[sid].numberOfErrorAudioSent+=1,videoService.callsStatsSimplified[sid].numberOfErrorAudioSent%2)return void $log.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- ingore");$log.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- renego SFU conference"),webConferenceService.onAudioProfileChangeEvent()}}}},this.checkSessionAudioReceivedHealthStatus=function(sid){$log.info("[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- user hears nothing !");var call=videoService.calls[sid];if(call&&!call.isInCallWithMediaPillar())call.status.key===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE.key&&call.remoteMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO&&(videoService.callsStatsSimplified[sid].errorAudioReceived=1,$log.info("[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- reset output device"),videoService.resetAudioOutputElement());else{var confSession=webConferenceService.getActiveConferenceSession();if(confSession&&confSession.id&&confSession.active&&"connected"===confSession.status){var audioSession=webConferenceService.getRemoteAudioSession(confSession.id);audioSession&&audioSession.sid===sid&&(videoService.callsStatsSimplified[sid].errorAudioReceived=1,$log.info("[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- renego SFU conference"),videoService.resetAudioOutputElement())}}},angular.element(document).bind("callincoming.jingle",(function(__event,sessId){$log.webrtc("webrtcServiceEventHandler  | callincoming.jingle "+sessId);var session=xmppService.connection.jingle.sessions[sessId];session&&session.confId?webConferenceService.onIncomingCall(sessId):videoService.videoEventHandler.incomingCall(sessId)})),angular.element(document).bind("callterminated.jingle",(function(__event,sessId,reason){$rootScope.$apply((function(){var callReason=reason||"";($log.webrtc("webrtcServiceEventHandler  | callterminated "+sessId+" reason: "+callReason),"multi-device"===reason)?webConferenceService.onConferenceCallSwitched(sessId):videoService.calls[sessId]?videoService.videoEventHandler.terminatedCall(sessId,callReason):webConferenceService.onTerminatedCall(sessId)}))})),angular.element(document).bind("iceconnectionstatechange.jingle",(function(__event,sid,sess){sess.peerconnection?($log.webrtc("JINGLE  | iceconnectionstatechange "+sid+" "+sess.peerconnection.iceConnectionState+"|"+sess.peerconnection.signalingState),videoService.calls[sid]?videoService.videoEventHandler.iceConnectionStateChange(sid,sess):webConferenceService.onIceConnectionStateChange(sid,sess)):$log.webrtc("JINGLE  | iceconnectionstatechange - peerConnection does not exist anymore !!!")})),angular.element(document).bind("error.jingle",(function(__event,obj){$log.error("JINGLE  | callerror"),obj&&obj.error&&$log.error(JSON.stringify(obj.error));var sid=obj.sid;sid&&(videoService.calls[sid]?videoService.videoEventHandler.onJingleError(sid):webConferenceService.onJingleError(sid))})),angular.element(document).bind("webrtcSessionBitRate.jingle",(function(__event,sid,data){videoService.config.debugWeRTC&&$rootScope.$broadcast("ON_WEBRTC_CALL_BITRATE",sid,data)})),angular.element(document).bind("webrtcSessionStatsSimplyfied.jingle",(function(__event,sid,data){videoService.callsStatsSimplified[sid]||(videoService.callsStatsSimplified[sid]={},videoService.callsStatsSimplified[sid].numberOfErrorAudioSent=0,videoService.callsStatsSimplified[sid].errorAudioReceived=0),data.numberOfErrorAudioSent=videoService.callsStatsSimplified[sid].numberOfErrorAudioSent,data.errorAudioReceived=videoService.callsStatsSimplified[sid].errorAudioReceived,videoService.callsStatsSimplified[sid]=data,$log.info("[videoService] on webrtcSessionStatsSimplyfied for session "+sid+" : "+JSON.stringify(data)),"chrome"===adapter.default.browserDetails.browser&&adapter.default.browserDetails.version<71&&(0===data.packetsAudioSent||0===data.audioInputLevel?service.checkSessionAudioSentHealthStatus(sid):(videoService.callsStatsSimplified[sid].numberOfErrorAudioSent&&$rootScope.$broadcast("ON_WEBRTC_CALL_AUDIO_ISSUE",!1),videoService.callsStatsSimplified[sid].numberOfErrorAudioSent=0)),data.packetsAudioReceived&&0===data.audioOutputLevel&&0===data.errorAudioReceived&&service.checkSessionAudioReceivedHealthStatus(sid)}))}])},function(module,exports){angular.module("rainbow").service("settingsService",["$rootScope","$translate","$localStorage",function($rootScope,$translate,$localStorage){"use strict";var service=this;service.initialize=function(){$localStorage.get(["redirectVoIP"]).then((function(result){null!==result.redirectVoIP?service.redirectVoIP="true"===result.redirectVoIP:(service.setRedirectVoIP(!1),service.redirectVoIP=!1)})),service.automaticHookOff=!1,service.automaticHookOffTime=0,service.defaultLanguage={label:"English",settingCode:"en",code:"en",isoCode:"en",codeMoment:"en",unicode:"1f1ec-1f1e7",beta:!1},service.languages=[service.defaultLanguage,{label:"Franais",settingCode:"fr",code:"fr",isoCode:"fr",codeMoment:"fr",unicode:"1f1eb-1f1f7",beta:!1},{label:"Deutsch",settingCode:"de",code:"de",isoCode:"de",codeMoment:"de",unicode:"1f1e9-1f1ea",beta:!1},{label:"Espaol",settingCode:"es-es",code:"es-es",isoCode:"es-ES",codeMoment:"es",unicode:"1f1ea-1f1f8",beta:!1},{label:"Suomi",settingCode:"fi",code:"fi",isoCode:"fi",codeMoment:"fi",unicode:"1f1eb-1f1ee",beta:!0},{label:"Italiano",settingCode:"it",code:"it",isoCode:"it",codeMoment:"it",unicode:"1f1ee-1f1f9",beta:!1},{label:"",settingCode:"he",code:"he",isoCode:"he",codeMoment:"he",unicode:"1f1ee-1f1f1",beta:!1},{label:"",settingCode:"ja",code:"ja",isoCode:"ja",codeMoment:"ja",unicode:"1f1ef-1f1f5",beta:!1},{label:"",settingCode:"ko",code:"ko",isoCode:"ko",codeMoment:"ko",unicode:"1f1f0-1f1f7",beta:!1},{label:"Nederlands",settingCode:"nl",code:"nl",isoCode:"nl",codeMoment:"nl",unicode:"1F1F3-1F1F1",beta:!1},{label:"Nynorsk",settingCode:"no",code:"no",isoCode:"no",codeMoment:"nn",unicode:"1F1F3-1F1F4",beta:!0},{label:"Portugus do Brasil",settingCode:"pt-br",code:"pt-BR",isoCode:"pt-BR",codeMoment:"pt-br",unicode:"1F1E7-1F1F7",beta:!1},{label:"Portugus",settingCode:"pt-pt",code:"pt-PT",isoCode:"pt-PT",codeMoment:"pt",unicode:"1F1F5-1F1F9",beta:!1},{label:"Polski",settingCode:"pl",code:"pl",isoCode:"pl",codeMoment:"pl",unicode:"1F1F5-1F1F1",beta:!0},{label:"Svenskt",settingCode:"sv-se",code:"sv-SE",isoCode:"sv-SE",codeMoment:"sv",unicode:"1F1F8-1F1EA",beta:!0},{label:"Trke",settingCode:"tr",code:"tr",isoCode:"tr",codeMoment:"tr",unicode:"1f1f9-1f1f7",beta:!1},{label:"",settingCode:"zh-cn",code:"zh-cn",isoCode:"zh-CN",codeMoment:"zh-cn",unicode:"1f1e8-1f1f3",beta:!1},{label:"",settingCode:"zh-tw",code:"zh-TW",isoCode:"zh-TW",codeMoment:"zh-tw",unicode:"1F1F9-1F1FC",beta:!1},{label:"",settingCode:"ar",code:"ar",isoCode:"ar",codeMoment:"ar",unicode:"060006FF",beta:!1}],service.languageCodes=service.getAvailableLanguages().map((function(language){return language.settingCode})),service.settings={init:!0,lang:"en",imSound:"true",imNotif:"true",notifReminder:"gentle",displayOrder:"FL",nbMaxConversations:"100",skin:"rainbow",microphone:"default",headsetMicrophone:null,speakerphoneMicrophone:null,customMicrophone:null,headsetDeviceName:null,speakerphoneDeviceName:null,speaker:"default",headsetSpeaker:null,speakerphoneSpeaker:null,customSpeaker:null,ringingSpeaker:"default",ringingSpeakerName:"",camera:"default",cameraUsed:"",audioProfile:"handfree",currentDevice:null,iceConfig:null,sdk:!1,userWiewOrderType:"lastname",userWiewFilterType:"all",one2oneColors:"true",accessibleColors:"false",autoStartAnimatedGif:"false",translationMsg:"false",newUI:"false",autoAcceptRoomInvite:"false",server:null,activeAlarm:"relax1",activeNotif:"stairs",devMode:"false",hasSecondRinger:"false",validationMode:"false",disableCalendarPresence:"false",giphy:"false",deviceList:"[]",displayFilesType:"document-cell--as-grid",handFreeInputDeviceName:null,handFreeOutputDeviceName:null,customSpeakerName:null,customMicrophoneName:null,showBodyMessage:"false",bubblesFilterType:"all",bubblesOrderType:"lastActivityDate",suggestionDisplayed:"null",protectionAgainstMailTypeOffline:!1,channelMarkdown:"false",chrisPrankMode:"true",joinSfuSound:"true",guideTourDisplayed:"null",searchFilterValue:"NoFiltering",enableSingleSignOnWebAuthPopup:"false",enableDSCP:!1,dtx:!1,simulcast:!1,debugWebRTC:!1,unifiedPlan:!1,sipWiseMode:"false",lastInactiveBubbleShownDate:null,userEnvironment:""},$localStorage.get(Object.keys(service.settings)).then((function(settings){settings.nbMaxConversations?parseInt(settings.nbMaxConversations,10)<15&&service.setSetting("nbMaxConversations",15):settings.nbMaxConversations=service.settings.nbMaxConversations;if(settings.skin||(settings.skin=service.settings.skin),$rootScope.default_language&&(settings.lang=getMappedLanguage($rootScope.default_language),service.setSetting("lang",settings.lang)),"default"===settings.headsetMicrophone&&(settings.headsetMicrophone=null),"default"===settings.headsetSpeaker&&(settings.headsetSpeaker=null),"default"===settings.speakerphoneMicrophone&&(settings.speakerphoneMicrophone=null),"default"===settings.speakerphoneSpeaker&&(settings.speakerphoneSpeaker=null),"default"===settings.customMicrophone&&(settings.customMicrophone=null),"default"===settings.customSpeaker&&(settings.customSpeaker=null),null===settings.init){var preferredLanguage=navigator.languages?navigator.languages[0]:navigator.language||navigator.userLanguage;service.settings.lang=settings.lang?settings.lang:getMappedLanguage(preferredLanguage),$localStorage.set(service.settings)}else Object.keys(settings).forEach((function(item){null!==settings[item]&&(service.settings[item]=settings[item])}));var currentLanguage=service.getAppliLanguage();$translate.use(currentLanguage.code),moment.locale(currentLanguage.codeMoment)}))},service.getSetting=function(key){return service.settings[key]},service.setSetting=function(key,value){service.settings[key]=value,$localStorage.set(service.settings)},service.removeSetting=function(key){service.settings[key]=void 0,$localStorage.remove([key])},service.getAvailableLanguages=function(){return service.languages.filter((function(language){return!1===language.beta||config.betaLanguages}))},service.getAppliLanguage=function(){var language=service.getAvailableLanguages().filter((function(item){return item.settingCode===service.settings.lang}))[0];return language||service.defaultLanguage},service.setAppliLanguageCode=function(lang,save){save?service.setSetting("lang",lang):service.settings.lang=lang;var language=service.getAppliLanguage();moment.locale(language.codeMoment),$translate.use(language.code).then((function(){$rootScope.$broadcast("ON_LANGUAGE_UPDATED_EVENT",lang)}))},service.getAppliLanguageCodeForServer=function(){var langArray=service.settings.lang.split("-");return 1===langArray.length?service.settings.lang:langArray[0]+"-"+langArray[1].toUpperCase()},service.setAppliLangageCodeFromServer=function(serverCode){var langArray=serverCode.split("-"),clientCode=langArray[0];clientCode&&(clientCode=clientCode.toLowerCase()),2===langArray.length&&(clientCode+="-"+langArray[1].toLowerCase()),clientCode=getMappedLanguage(clientCode),clientCode=service.languageCodes.indexOf(clientCode)>=0?clientCode:"en",service.setAppliLanguageCode(clientCode)},service.getLanguageByIsoCode=function(isoCode){return service.languages.find((function(lang){return lang.isoCode===isoCode}))},service.getBestLanguageForIsoCode=function(isoCode){var language=service.getLanguageByIsoCode(isoCode);if(!language){if(-1!==isoCode.indexOf("-")){var isoLanguageWithoutCountry=isoCode.split("-")[0];language=service.getLanguageByIsoCode(isoLanguageWithoutCountry)}language||(language=service.getLanguageByIsoCode("en"))}return language},service.getRedirectVoIP=function(){return service.redirectVoIP},service.setRedirectVoIP=function(isActivated){$localStorage.set({redirectVoIP:isActivated}),service.redirectVoIP=isActivated},service.isAutomaticHookOff=function(){return service.automaticHookOff},service.setAutomaticHookOff=function(isActivated){service.automaticHookOff=isActivated},service.getAutomaticHookOffTime=function(){return service.automaticHookOffTime},service.setAutomaticHookOffTime=function(millisecondes){service.automaticHookOffTime=millisecondes},service.setIceConfig=function(iceConfig){service.settings.iceConfig=iceConfig},service.forceTurn=function(turnOn){config.turnOn=turnOn;var message=turnOn?"Debug mode : Only use turn servers":"Normal mode : use stun and turn servers";$rootScope.$broadcast("ON_SETTING_FORCE_TURN_EVENT",message)},service.enableRemoteConsole=function(channelId){var script=document.createElement("script");script.src="//console.re/connector.js",script.id="consolerescript",script.setAttribute("data-channel",channelId),script.onreadystatechange=script.onload=function(){app.remoteConsole.info=!0,app.remoteConsole.debug=!0,app.remoteConsole.log=!0,console.re.info("Connected")},document.getElementsByTagName("head")[0].appendChild(script)};var getMappedLanguage=function(codedLanguage){var lang="en";if(codedLanguage)switch(codedLanguage.split("-")[0]){case"ar":lang="ar";break;case"en":lang="en";break;case"fr":lang="fr";break;case"de":lang="de";break;case"es":lang="es-es";break;case"fi":lang="fi";break;case"it":lang="it";break;case"he":lang="he";break;case"ja":lang="ja";break;case"ko":lang="ko";break;case"nl":lang="nl";break;case"no":lang="no";break;case"pt":lang="pt-br"===codedLanguage.toLowerCase()?"pt-br":"pt-pt";break;case"pl":lang="pl";break;case"sv":lang="sv-se";break;case"tr":lang="tr";break;case"zh":lang=["zh-cn","zh-tw"].indexOf(codedLanguage.toLowerCase())>=0?codedLanguage.toLowerCase():"zh-cn";break;default:lang="en"}return lang};service.initialize()}])},function(module,exports){class FeedChannel{constructor(){this.messages=[],this.complete=!1,this.pageIndex=0,this.isLoading=!1,this.type="AGGREGATE"}}class ChannelService{constructor($q,$http,$log,$interval,$rootScope,authService,xmppService,contactService,Channel,roomService,Contact,profileService){this.$q=$q,this.$http=$http,this.$log=$log,this.$interval=$interval,this.$rootScope=$rootScope,this.authService=authService,this.xmppService=xmppService,this.contactService=contactService,this.Channel=Channel,this.roomService=roomService,this.Contact=Contact,this.profileService=profileService,this.listeners=[],this.isStarted=!1,this.channels={},this.channelsList=[],this.LIST_EVENT_TYPE={ADD:0,UPDATE:1,REMOVE:2,DELETE:3,SUBSCRIBE:4,UNSUBSCRIBE:5,CREATE:6},this.USER_ROLE={NONE:"none",OWNER:"owner",PUBLISHER:"publisher",MEMBER:"member"},this.MESSAGE_ACTION={ADD:0,RETRACT:1},this.xmpp_message_handler=null,this.xmpp_management_handler=null,this.notificationCounter=0,this.messageCounter=0,this.invitationCounter=0,this.CHANNEL_UPDATE_EVENT="CHANNEL_UPDATE_EVENT",this.CHANNEL_MESSAGE_RECEIVED="CHANNEL_MESSAGE_RECEIVED",this.CHANNEL_USERS_UPDATE_EVENT="CHANNEL_USERS_UPDATE_EVENT",this.CHANNEL_NOTIFICATION_NUMBER_UPDATED="CHANNEL_NOTIFICATION_NUMBER_UPDATED",this.CHANNEL_USER_SUBSCRIPTION_EVENT="CHANNEL_USER_SUBSCRIPTION_EVENT"}start(stats){return this.$q(resolve=>{this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CHANNEL_ACTIVATED)||resolve(),this.contactService.userContact.isCPaaSGuest()&&resolve(),this.$log.info("[channelService] === STARTING ===");let startDate=performance.now();this.feedChannel=new FeedChannel,this.portalURL=config.restServerUrl+"/api/rainbow/channels/v1.0/channels",resolve(),this.getMyChannels().then(()=>{let startDuration=Math.round(performance.now()-startDate);this.$log.info("[channelService] === STARTED ("+startDuration+" ms) ==="),stats.push({service:"channelService",startDuration:startDuration}),this.attachHandlers(),this.attachListeners(),this.isStarted=!0,this.$rootScope.$broadcast("ON_CHANNEL_SERVICE_STARTED")}).catch(error=>{this.$log.info("[channelService] === STARTING FAILURE === "+error.message)})})}attachHandlers(){this.$log.info("[channelService] attachHandlers"),this.xmpp_message_handler&&(this.xmppService.connection.deleteHandler(this.xmpp_message_handler),this.xmpp_message_handler=null),this.xmpp_management_handler&&(this.xmppService.connection.deleteHandler(this.xmpp_management_handler),this.xmpp_management_handler=null),this.xmpp_message_handler=this.xmppService.connection.addHandler(stanza=>this.onChannelMessageReceived(stanza),null,"message","headline"),this.xmpp_management_handler=this.xmppService.connection.addHandler(stanza=>this.onChannelManagementReceived(stanza),null,"message","management")}attachListeners(){this.listeners.push(this.$rootScope.$on(this.CHANNEL_USERS_UPDATE_EVENT,(_event,channelId,users)=>this.usersUpdateHandler(_event,channelId,users)))}stop(){return this.$q(resolve=>{this.$log.info("[channelService] === STOPPING ==="),this.listeners.forEach(destroyFunction=>{destroyFunction()}),this.channels={},this.channelsList=[],this.feedChannel=null,this.notificationCounter=0,this.$log.info("[channelService] === STOPPED ==="),resolve()})}reconnect(){return this.$q(resolve=>{this.$log.info("[channelService] reconnect"),this.stop(),this.start([]),resolve()})}removeChannelFromCache(channelId){return this.$q((resolve,reject)=>{let channelToRemove=this.getChannelFromCache(channelId);if(channelToRemove){let channelName=channelToRemove.name;channelToRemove.invited&&this.decrementInvitationCounter(),delete this.channels[channelId],this.updateChannelsList(),this.feedChannel.messages=[],this.retrieveLatests().then(()=>{resolve(channelName)}).catch(err=>{reject(err)})}})}onChannelMessageReceived(stanza){try{return this.$rootScope.$apply(()=>{let eventNode=angular.element(stanza).find("event");if(eventNode&&"http://jabber.org/protocol/pubsub#event"===eventNode.attr("xmlns")){this.$log.info("[channelService] onChannelMessageReceived ");let items=eventNode.find("items"),item=items.find("item"),retract=items.find("retract");if(1===item.length)this.onNewMessage(item);else if(1===retract.length){let messageId=retract.attr("id"),channelId=items.attr("node").split(":")[0];this.onRetractMessage(channelId,messageId)}}}),!0}catch(err){return this.$log.error("[channelService] onChannelMessageReceived -- failure -- "+err.message),!0}}onNewMessage(item){let entry=item.find("entry"),messageId=item.attr("id"),channelId=entry.attr("channelId"),action=entry.attr("creation")?"modify":"new";this.$log.info("[channelService] onChannelMessageReceived -- "+action+" message "+messageId+" on channel "+channelId);let message={id:messageId,displayId:messageId+"-"+entry.attr("timestamp"),channelId:channelId,from:entry.attr("from"),fromDetails:null,new:!1,entry:{type:entry.find("type").length?entry.find("type")[0].textContent:"",message:entry.find("message").length?entry.find("message")[0].textContent:"",title:entry.find("title").length?entry.find("title")[0].textContent:"",url:entry.find("url").length?entry.find("url")[0].textContent:"",images:[],attachments:[],video:null},modified:"modify"===action,timestamp:new Date(entry.attr("timestamp"))};message.entry.message=message.entry.message.replace(/<a/gi,"<a target='_blank' rel='noopener noreferrer' ");let imagesElem=item.find("images");0!==imagesElem.length&&imagesElem.find("id").each((index,image)=>{message.entry.images.push({id:image.textContent})});let attachmentsElem=item.find("attachments");0!==attachmentsElem.length&&attachmentsElem.find("id").each((index,attachment)=>{message.entry.attachments.push({id:attachment.textContent})});let videoElem=item.find("video");0!==videoElem.length&&(message.entry.video={provider:videoElem.find("provider")[0].textContent,id:videoElem.find("id")[0].textContent});let channel=this.getChannelFromCache(channelId);this.contactService.getOrCreateContact(message.from).then(author=>{if(message.fromDetails={displayName:author.displayName,id:author.dbId,avatar:author.avatar},message.fromContact=author,"new"===action)channel.loaded&&channel.messages.unshift(message),this.feedChannel.messages.unshift(message),this.contactService.userContact.jid!==message.from&&(message.new=!0,this.incrementMessagesCounter()),this.$rootScope.$broadcast(this.CHANNEL_MESSAGE_RECEIVED,this.MESSAGE_ACTION.ADD,message);else{let channelMessageIndex=channel.messages.findIndex(mess=>mess.id===messageId),feedMessageIndex=this.feedChannel.messages.findIndex(mess=>mess.id===messageId);-1!==channelMessageIndex&&channel.messages.splice(channelMessageIndex,1,message),-1!==feedMessageIndex&&this.feedChannel.messages.splice(feedMessageIndex,1,message)}})}onRetractMessage(channelId,messageId){this.$log.info("[channelService] onChannelMessageReceived -- retract message "+messageId+" on channel "+channelId);let channel=this.getChannelFromCache(channelId),messageIndex=channel.messages.findIndex(message=>message.id===messageId);if(-1!==messageIndex){channel.messages[messageIndex].new&&this.decrementMessagesCounter(),channel.messages.splice(messageIndex,1)}let messageListIndex=this.feedChannel.messages.findIndex(message=>message.id===messageId);-1!==messageListIndex&&this.feedChannel.messages.splice(messageListIndex,1),this.$rootScope.$broadcast(this.CHANNEL_MESSAGE_RECEIVED,this.MESSAGE_ACTION.RETRACT,messageId)}onChannelManagementReceived(stanza){try{return this.$rootScope.$apply(()=>{let channelElem=angular.element(stanza).find("channel");if(channelElem&&channelElem.length>0){let channelId=channelElem.attr("channelid"),channel=this.getChannelFromCache(channelId);if(channel){let avatarElem=channelElem.find("avatar"),nameElem=channelElem.find("name"),topicElem=channelElem.find("topic"),categoryElem=channelElem.find("category");avatarElem&&avatarElem.length>0&&this.onAvatarChange(channelId,avatarElem),nameElem&&nameElem.length>0&&(channel.name=nameElem.text()),topicElem&&topicElem.length>0&&(channel.topic=topicElem.text()),categoryElem&&categoryElem.length>0&&(channel.category=categoryElem.text())}let action=channelElem.attr("action");switch(this.$log.info("[channelService] onChannelManagementReceived -- "+action+" event received on channel "+channelId),action){case"add":this.onAddToChannel(channelId);break;case"update":this.onUpdateToChannel(channelId);break;case"remove":this.onRemovedFromChannel(channelId);break;case"subscribe":this.onSubscribeToChannel(channelId,channelElem.attr("subscribers"));break;case"unsubscribe":this.onUnsubscribeToChannel(channelId,channelElem.attr("subscribers"));break;case"delete":this.onDeleteChannel(channelId)}}let channelSubscriptionElem=angular.element(stanza).find("channel-subscription");if(channelSubscriptionElem&&channelSubscriptionElem.length>0){let channelId=channelSubscriptionElem.attr("channelid"),action=channelSubscriptionElem.attr("action"),userId=channelSubscriptionElem.attr("id"),subscribers=channelSubscriptionElem.attr("subscribers");switch(this.getChannelFromCache(channelId).subscribers_count=Number.parseInt(subscribers),this.$log.info("[channelService] onChannelManagementReceived -- subscription-"+action+" event received on channel "+channelId),action){case"subscribe":this.onUserSubscribeEvent(channelId,userId);break;case"unsubscribe":this.onUserUnsubscribeEvent(channelId,userId)}}}),!0}catch(err){return this.$log.error("[channels] onChannelManagementReceived -- failure -- "+err.message),!0}}onAvatarChange(channelId,avatar){let action=avatar.attr("action"),updateDate=avatar.attr("lastAvatarUpdateDate")?new Date(avatar.attr("lastAvatarUpdateDate")):null;if(this.$log.info("[channelService] onChannelManagementReceived -- "+action+" avatar for "+channelId),"delete"===action||"update"===action){let channel=this.getChannelFromCache(channelId);channel.lastAvatarUpdateDate=updateDate,null!==updateDate&&(channel.avatar=config.restServerUrl+"/api/channel-avatar/"+channelId+"?size=256&ts="+new Date(updateDate).getTime())}}onUpdateToChannel(channelId){this.getChannelFromCache(channelId);this.getChannel(channelId).then(newChannel=>{newChannel.invited&&(this.addChannelToCache(newChannel),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.ADD,newChannel.id))})}onAddToChannel(channelId){let channel=this.getChannelFromCache(channelId);this.getChannel(channelId).then(newChannel=>{channel||newChannel.invited?!channel&&newChannel.invited?(this.addChannelToCache(newChannel),this.incrementInvitationCounter(),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,newChannel.id)):channel&&newChannel.userRole!==this.USER_ROLE.NONE&&(channel.userRole=newChannel.userRole,this.feedChannel.messages=[],this.retrieveLatests().then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,channelId)})):(this.addChannelToCache(newChannel),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.ADD,newChannel.id))})}onRemovedFromChannel(channelId){this.removeChannelFromCache(channelId).then(channelName=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.DELETE,channelId)})}onSubscribeToChannel(channelId,subscribersInfo){let channel=this.getChannelFromCache(channelId),subscribers=Number.parseInt(subscribersInfo);channel?(channel.invited=!1,channel.subscribed=!0,channel.subscribers_count=subscribers,this.feedChannel.messages=[],this.retrieveLatests().then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,channelId)})):this.getChannel(channelId).then(newChannel=>(this.addChannelToCache(newChannel),this.feedChannel.messages=[],this.retrieveLatests())).then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,channelId)})}onUnsubscribeToChannel(channelId,subscribersInfo){let subscribers=Number.parseInt(subscribersInfo),channel=this.getChannelFromCache(channelId);channel.subscribers_count=subscribers,channel.subscribed=!1,this.feedChannel.messages=[],this.retrieveLatests().then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.UNSUBSCRIBE,channelId)})}onDeleteChannel(channelId){this.removeChannelFromCache(channelId).then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.DELETE,channelId)})}onUserSubscribeEvent(channelId,userId){this.$rootScope.$broadcast(this.CHANNEL_USER_SUBSCRIPTION_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,channelId,userId)}onUserUnsubscribeEvent(channelId,userId){this.$rootScope.$broadcast(this.CHANNEL_USER_SUBSCRIPTION_EVENT,this.LIST_EVENT_TYPE.UNSUBSCRIBE,channelId,userId)}getChannelNextPage(channel,reset=!1){return this.$q((resolve,reject)=>{let logChannelName="AGGREGATE"===channel.type?"feedChannel":channel.id;if(channel.isLoading)return this.$log.info("[channelService] getChannelNextPage("+logChannelName+", "+channel.pageIndex+") -- ignored (isLoading)"),resolve();channel.isLoading=!0,reset&&(channel.pageIndex=0);channel.messages.length;let askedMessagesNumber=(channel.pageIndex+1)*ChannelService.PAGE_SIZE;if(askedMessagesNumber<=channel.messages.length)this.$log.info("[channelService] getChannelNextPage("+logChannelName+", "+channel.pageIndex+") -- success from cache"),channel.pageIndex+=1,channel.isLoading=!1,resolve({messages:channel.messages,nbMessages:askedMessagesNumber});else if(channel.complete)this.$log.info("[channelService] getChannelNextPage("+logChannelName+", "+channel.pageIndex+") -- success from cache (complete)"),channel.isLoading=!1,resolve({messages:channel.messages,nbMessages:channel.messages.length});else{let messages=channel.messages,lastMessageDate=messages.length?messages[messages.length-1].timestamp:null;this.getChannelMessages(channel,lastMessageDate).then(nbMessages=>{nbMessages<ChannelService.PAGE_SIZE&&(channel.complete=!0),this.$log.info("[channelService] getChannelNextPage("+logChannelName+", "+channel.pageIndex+") -- success from server "+(channel.complete?"(complete)":"")+" -- retreive "+nbMessages+" message(s)"),channel.pageIndex+=1,channel.loaded=!0,channel.isLoading=!1,resolve({messages:channel.messages,nbMessages:channel.messages.length})}).catch(error=>{channel.isLoading=!1,this.channelErrorHandler("getChannelNextPage("+logChannelName+", "+channel.pageIndex+")",reject,error)})}})}getChannelPublishers(channel){return this.$q((resolve,reject)=>{if(channel.publishersRetreived)return resolve();this.getChannelUsers(channel.id,{format:"full",types:"owner publisher"}).then(usersData=>{usersData.data.forEach(userData=>{let contact=this.contactService.getContactByJid(userData.jid_im);contact||((contact=new this.Contact).updateFromUserData(userData),contact.updateRichStatus(),this.contactService.contacts[contact.id]=contact,this.contactService.dbContacts[contact.dbId]=contact,this.contactService.jtelContacts[contact.jidtel]=contact),channel.users.push(contact)}),channel.publishersRetreived=!0,this.$log.info("[channelService] getChannelPublishers ("+channel.id+") -- success -- find "+usersData.length+" publisher(s)"),resolve()}).catch(err=>{this.channelErrorHandler("getChannelPublishers ("+channel.id+")",reject,err)})})}getChannelMessages(channel,beforeDate){return this.$q((resolve,reject)=>{let provider=null;(provider="AGGREGATE"===channel.type?this.getLatestMessages(10,beforeDate):this.getChannelItems(channel.id,ChannelService.PAGE_SIZE,beforeDate)).then(messages=>{messages.forEach(message=>{"null"===message.entry.images&&(message.entry.images=[]),"null"!==message.entry.attachments&&void 0!==message.entry.attachments||(message.entry.attachments=[]),message.entry.attachments instanceof Array||(message.entry.attachments=[message.entry.attachments]),message.entry.message&&(message.entry.message=message.entry.message.replace(/<a/gi,"<a target='_blank' rel='noopener noreferrer' "));message.entry.message&&message.entry.message;this.contactService.getOrCreateContact(message.from).then(contact=>{message.fromDetails={displayName:contact.displayName,id:contact.dbId,avatar:contact.avatar},message.fromContact=contact})}),channel.messages.push.apply(channel.messages,messages),resolve(messages.length)})})}getMyChannels(){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"?format=full",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[channelService] getMyChannels -- success"),response.data.data.forEach(channelData=>{let channel=this.Channel(channelData);channel.invited&&this.incrementInvitationCounter(),(channel.subscribed||channel.invited)&&(this.channels[channel.id]=channel)}),this.updateChannelsList(),resolve(this.channelsList)}).catch(err=>{this.channelErrorHandler("getMyChannels",reject,err)})})}createChannel(name,mode,topic="",category="globalnews",autoProvisionning=!1,max_items=100){return this.$q((resolve,reject)=>{let url=this.portalURL+(autoProvisionning?"?auto_provisioning=true":""),data={name:name,mode:mode,topic:topic,category:category,max_items:max_items};this.$http({method:"POST",url:url,headers:this.authService.getPostHeader(),data:data}).then(response=>{this.$log.info("[channelService] createChannel -- "+mode+" -- success");let channel=this.Channel(response.data.data);resolve(channel)}).catch(err=>{this.channelErrorHandler("createChannel -- "+name+" -- "+mode,reject,err)})})}deleteChannel(channelId){return this.$q((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+channelId,headers:this.authService.getPostHeader()}).then(response=>{this.$log.info("[channelService] deleteChannel -- "+channelId+" -- success"),resolve(response)}).catch(err=>{this.channelErrorHandler("deleteChannel ("+channelId+")",reject,err)})})}findChannels(filter){return this.$q((resolve,reject)=>{let query="?sortOrder="+(filter.sortOrder&&1===filter.sortOrder?"1":"-1");void 0!==filter.subscribed&&(query+="&subscribed="+filter.subscribed),filter.name&&(query+="&name="+filter.name),filter.topic&&(query+="&topic="+filter.topic),filter.limit&&(query+="&limit="+filter.limit),filter.offset&&(query+="&offset="+filter.offset),filter.sortField&&(query+="&sortField="+filter.sortField),filter.category&&(query+="&category="+filter.category),this.$http({method:"GET",url:this.portalURL+"/search"+query,headers:this.authService.getRequestHeader()}).then(response=>{let channels=[];response.data.data.forEach(channelData=>{channels.push(this.Channel(channelData))}),resolve(channels)}).catch(err=>{this.channelErrorHandler("findChannels ("+query+")",reject,err)})})}browseChannels(filter){return this.$q((resolve,reject)=>{let query="?sortOrder="+(filter.sortOrder&&1===filter.sortOrder?"1":"-1");filter.category&&(query+="&category="+filter.category),filter.excluded_category&&(query+="&excluded_category="+filter.excluded_category),void 0!==filter.subscribed&&(query+="&subscribed="+filter.subscribed),filter.limit&&(query+="&limit="+filter.limit),filter.offset&&(query+="&offset="+filter.offset),filter.sortField&&(query+="&sortField="+filter.sortField),this.$http({method:"GET",url:this.portalURL+"/browse"+query,headers:this.authService.getRequestHeader()}).then(response=>{let channels=[];response.data.data.forEach(channelData=>{channels.push(this.Channel(channelData))}),resolve(channels)}).catch(err=>{this.channelErrorHandler("browseChannels ("+query+")",reject,err)})})}getChannel(channelId){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/"+channelId,headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[channelService] getChannel -- "+channelId+" -- success");let channel=this.Channel(response.data.data);resolve(channel)}).catch(err=>{this.channelErrorHandler("getChannel ("+channelId+")",reject,err)})})}getChannelFromCache(channelId){let channel=this.channels[channelId];return void 0!==channel?channel:null}publishToChannel(channelId,itemId,type,message,title,url,images,video,attachments){return this.$q((resolve,reject)=>{let data={type:type,title:title||"",message:message||"",images:images||[],attachments:attachments||[]},queryParam=itemId?"?itemId="+itemId:"";video&&(data.video=video),this.$http({method:"POST",url:this.portalURL+"/"+channelId+"/publish"+queryParam,headers:this.authService.getRequestHeader(),data:data}).then(response=>{this.$log.info("[channelService] publishToChannel -- "+channelId+" -- "+type+" -- success"),resolve(response)}).catch(err=>{this.channelErrorHandler("publishToChannel ("+channelId+")",reject,err)})})}subscribeToChannel(channel){return this.$q((resolve,reject)=>{this.$http({method:"POST",url:this.portalURL+"/"+channel.id+"/subscribe",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[channelService] subscribeToChannel -- "+channel.id+" -- success"),channel.subscribed=!0,channel.users_count+=1,resolve(response)}).catch(err=>{this.channelErrorHandler("subscribeToChannel ("+channel.id+")",reject,err)})})}unsubscribeToChannel(channel){return this.$q((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+channel.id+"/subscribe",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[channelService] unsubscribeToChannel -- success"),channel.subscribed=!1,channel.users_count-=1,resolve(response)}).catch(err=>{this.channelErrorHandler("unsubscribeToChannel",reject,err)})})}updateChannel(channelId,options){return this.$q((resolve,reject)=>{this.$http({method:"PUT",url:this.portalURL+"/"+channelId,headers:this.authService.getPostHeader(),data:options}).then(response=>{let channel=this.getChannelFromCache(channelId);channel.name=response.data.data.name,channel.topic=response.data.data.topic,channel.category=response.data.data.category,this.$log.info("[channelService] updateChannel ( "+channelId+") -- success"),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.UPDATE,channel.id),resolve(channel)}).catch(err=>{this.channelErrorHandler("updateChannel ("+channelId+")",reject,err)})})}getChannelItems(channelId,maxMessages,beforeDate=null,afterDate=null){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/"+channelId+"/items",headers:this.authService.getRequestHeader(),params:{max:maxMessages,before:beforeDate,after:afterDate}}).then(response=>{this.$log.info("[channelService] getChannelItems -- success"),this.chewReceivedItems(response.data.data.items),resolve(response.data.data.items)}).catch(err=>{this.channelErrorHandler("getChannelItems",reject,err)})})}deleteChannelItem(channelId,itemId){return this.$q((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+channelId+"/items/"+itemId,headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[channelService] deleteChannelItem ("+channelId+") -- success"),resolve()}).catch(err=>{this.channelErrorHandler("deleteChannelItem ("+channelId+")",reject,err)})})}getChannelUsers(channelId,options){return this.$q((resolve,reject)=>{let data={};options&&(options.format&&"string"==typeof options.format&&options.format.length&&(data.format=options.format),options.types&&"string"==typeof options.types&&options.types.length&&(data.types=options.types),options.limit&&"number"==typeof options.limit&&options.limit>0&&(data.limit=options.limit),options.offset&&"number"==typeof options.offset&&options.offset>0&&(data.offset=options.offset),options.sortField&&"string"==typeof options.sortField&&options.sortField.length&&(data.sortField=options.sortField),!options.sortOrder||"-1"!==options.sortOrder&&"1"!==options.sortOrder||(data.sortOrder=options.sortOrder)),this.$http({method:"GET",url:this.portalURL+"/"+channelId+"/users",headers:this.authService.getRequestHeader(),params:data}).then(response=>{this.$log.info("[channelService] getChannelUsers ("+channelId+") -- success"),resolve(response.data)}).catch(err=>{this.channelErrorHandler("getChannelUsers ("+channelId+")",reject,err)})})}searchUsersByName(channelId,displayName,options){return options.displayName=displayName,this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/"+channelId+"/users/search",headers:this.authService.getRequestHeader(),params:options}).then(response=>{this.$log.info("[channelService] searchUsersByName ("+channelId+" -- success"),resolve(response.data.data)}).catch(err=>{this.channelErrorHandler("searchUsersByName ("+channelId+")",reject,err)})})}deleteChannelAvatar(channelId){return this.$q((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+channelId+"/avatar",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[channelService] deleteChannelAvatar "+channelId+" -- success"),resolve(response)}).catch(err=>{this.channelErrorHandler("deleteChannelAvatar "+channelId,reject,err)})})}uploadChannelAvatar(channelId,avatar,avatarSize){return this.$q((resolve,reject)=>{this.roomService.resizeImage(avatar,avatarSize,avatarSize).then(resizedImage=>{var binaryData=this.roomService.getBinaryData(resizedImage);this.$http({method:"POST",url:this.portalURL+"/"+channelId+"/avatar",headers:this.authService.getPostHeader("image/"+binaryData.type),data:binaryData.data,transformRequest:[]}).then(response=>{this.$log.info("[channelService] uploadChannelAvatar "+channelId+" -- success"),resolve(response)}).catch(err=>{this.channelErrorHandler("uploadChannelAvatar",reject,err)})})})}updateChannelUsers(channelId,users,userType){return this.$q((resolve,reject)=>{let members=users.map(user=>({id:user.dbId,type:userType}));this.$http({method:"PUT",url:this.portalURL+"/"+channelId+"/users",headers:this.authService.getRequestHeader(),data:{data:members}}).then(response=>{this.$log.info("[channelService] updateChannelUsers -- success");let usersLists=response.data.data;this.$rootScope.$broadcast(this.CHANNEL_USERS_UPDATE_EVENT,channelId,usersLists),resolve(usersLists)}).catch(err=>{this.channelErrorHandler("updateChannelUsers",reject,err)})})}usersUpdateHandler(_event,channelId,users){let channel=this.getChannelFromCache(channelId);if(null!==users&&(channel.users_count+=users.added.length-users.removed.length,channel.users.length)){for(let i=0;i<users.added.length;i++)this.contactService.getContactByDBId(users.added[i]).then(contact=>{channel.users.push(contact)});for(let i=0;i<users.removed.length;i++)for(let j=channel.users.length-1;j>=0;j--)if(channel.users[j].dbId===users.removed[i]){channel.users.splice(j,1);break}}}retrieveUsers(channel){if(this.$log.info("Retrieving users"),0===channel.users.length&&channel.userRole===this.USER_ROLE.OWNER){let publishers,owner=this.contactService.userContact;return owner.type="owner",this.getChannelUsers(channel.id,{format:"full",types:"publisher",limit:19}).then(pubs=>(publishers=pubs.data.length?pubs.data:[]).length<19?this.getChannelUsers(channel.id,{format:"full",types:"member",limit:19-publishers.length}):[]).then(members=>{publishers.push.apply(publishers,members.data);const users=publishers;return this.usersToContacts(users).then(contacts=>(channel.users=contacts,channel.users.unshift(owner),contacts))})}return this.$q.resolve(null)}usersToContacts(users){if(null!==users){let userPromises=[];for(let i=0;i<users.length;i++){let user=this.Contact.create(users[i].jid_im,users[i].firstName,users[i].lastName,users[i].company,users[i].loginEmail);user.dbId=users[i].id,user.lastAvatarUpdateDate=users[i].lastAvatarUpdateDate,user.type=users[i].type||users[i].affiliation,userPromises.push(user.getAvatar())}return this.$q.all(userPromises).then(contacts=>contacts)}}retrieveMessages(channel){return channel.messageRetrieved?this.$q.resolve(null):this.getChannelItems(channel.id,100,null,null).then(messages=>{channel.messages=messages;let authorPromises=[];var uniqueAuthors=Array.from(new Set(channel.messages.map(msg=>msg.from)));for(let i=0;i<uniqueAuthors.length;i++){let contact=this.contactService.getOrCreateContact(uniqueAuthors[i]);authorPromises.push(contact)}return this.$q.all(authorPromises).then(authors=>{for(let i=0;i<channel.messages.length;i++){let contact=authors.find(author=>author.id===channel.messages[i].from);channel.messages[i].fromDetails={displayName:contact.displayName,id:contact.dbId,avatar:contact.avatar},channel.messages[i].fromContact=contact}return channel.messageRetrieved=!0,this.$q.resolve(channel.messages)})})}retrieveLatests(beforeDate=null){return this.getLatestMessages(10,beforeDate,null).then(messages=>(this.feedChannel.messages.push.apply(this.feedChannel.messages,messages),messages.length))}incrementMessagesCounter(){this.messageCounter+=1,this.updateNotificationCounter()}decrementMessagesCounter(){this.messageCounter-=1,this.updateNotificationCounter()}incrementInvitationCounter(){this.invitationCounter+=1,this.updateNotificationCounter()}decrementInvitationCounter(){this.invitationCounter-=1,this.updateNotificationCounter()}ackMessages(){this.messageCounter=0,this.updateNotificationCounter(),this.feedChannel.messages.forEach(message=>{message.new=!1})}ackMessage(messageId){this.feedChannel.messages.forEach(message=>{message.id===messageId&&(message.new=!1)}),this.decrementMessagesCounter()}updateNotificationCounter(){this.notificationCounter=this.messageCounter+this.invitationCounter,this.notificationCounter<0&&(this.notificationCounter=0),this.$rootScope.$broadcast(this.CHANNEL_NOTIFICATION_NUMBER_UPDATED,this.notificationCounter)}removeAllUsersFromChannel(channelId){return this.$q((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+channelId+"/users",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[channelService] Removed all users from channel -- success"),this.$rootScope.$broadcast(this.CHANNEL_USERS_UPDATE_EVENT,channelId,null),resolve(response)}).catch(err=>{this.channelErrorHandler("removeAllUsersFromChannel",reject,err)})})}getPortalInfos(){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:config.restServerUrl+"/api/rainbow/channels/v1.0/about",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[channelService] successfully retrieved portal infos -- success"),resolve(response.data)}).catch(err=>{this.channelErrorHandler("getPortalInfos",reject,err)})})}getLatestMessages(maxMessages,beforeDate=null,afterDate=null){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/latest-items",headers:this.authService.getRequestHeader(),params:{max:maxMessages,before:beforeDate,after:afterDate}}).then(response=>{this.chewReceivedItems(response.data.data.items),resolve(response.data.data.items)}).catch(err=>{this.channelErrorHandler("getLatestMessages",reject,err)})})}acceptInvitation(channelId){return this.$q((resolve,reject)=>{this.$http({method:"PUT",url:this.portalURL+"/"+channelId+"/accept",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[channelService] acceptInvitation ("+channelId+") -- success"),this.decrementInvitationCounter(),resolve(response)}).catch(err=>{this.channelErrorHandler("acceptInvitation",reject,err)})})}declineInvitation(channelId){return this.$q((resolve,reject)=>{this.$http({method:"PUT",url:this.portalURL+"/"+channelId+"/decline",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[channelService] declineInvitation ("+channelId+") -- success"),this.decrementInvitationCounter(),resolve(response)}).catch(err=>{this.channelErrorHandler("declineInvitation",reject,err)})})}chewReceivedItems(items){items.forEach(item=>{"urn:xmpp:channels:simple"===item.type&&(item.entry={message:item.message},delete item.message),item.displayId=item.id+"-"+item.timestamp,item.modified=void 0!==item.creation})}updateChannelsList(){this.channelsList=Object.keys(this.channels).map(key=>this.channels[key])}addChannelToCache(channel){this.channels[channel.id]=channel,this.updateChannelsList()}channelErrorHandler(methodName,reject,err){let error=null;err.data?(this.$log.error("[channelService] "+methodName+" -- failure -- "+err.data.errorDetails),error=new RBError(err.data.errorMsg,err.data.errorDetails,err.data.errorDetailsCode)):(this.$log.error("[channelService] "+methodName+" -- failure -- Server failure"),error=new RBError("Server failure")),reject(error)}}ChannelService.PAGE_SIZE=10,ChannelService.$inject=["$q","$http","$log","$interval","$rootScope","authService","xmppService","contactService","Channel","roomService","Contact","profileService"],angular.module("rainbow").service("channelService",ChannelService)},function(module,exports){},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var crypto_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3);angular.module("rainbow").service("companyService",["$q","$log","$http","$rootScope","authService","errorHelperService","userInfoService","Company",function($q,$log,$http,$rootScope,authService,errorHelperService,userInfoService,Company){var service=this,listeners=[];service.start=function(stats){$log.info(""),$log.info("[companyService] === STARTING ===");var startDate=performance.now();service.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/",service.companies={};var startDuration=Math.round(performance.now()-startDate);return stats.push({service:"companyService",startDuration:startDuration}),$log.info("[companyService] === STARTED ("+startDuration+" ms) ==="),listeners.push($rootScope.$on("ON_COMPANY_CHANGE_EVENT",(function(__event,companyId){service.getCompanyById(companyId,!0)}))),$q.when()},service.stop=function(){var listener;for($log.info(""),$log.info("[companyService] === STOPPING ===");listener=listeners.pop();)listener();return $log.info("[companyService] === STOPPED ==="),service.companies={},$q.when()},service.searchCompanies=function(searchText,hasBP,isBP,bpType){return $q((function(resolve,reject){var url=service.portalURL+"companies?name="+searchText+"&format=full";null!=hasBP&&(url+="&hasBP="+hasBP),null!=isBP&&(url+="&isBP="+isBP),bpType&&(url+="&bpType="+bpType),$http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){var companiesData=response.data.data,companies=[];angular.forEach(companiesData,(function(companyData){if("Default"!==companyData.name&&"Rainbow"!==companyData.name&&"active"===companyData.status){var company=service.companies[companyData.id];company||(company=Company.createFromData(companyData),service.companies[company.id]=company,service.getCompanyLogo(company)),companies.push(company)}})),$log.info("[companyService] searchCompanies with criteria '"+searchText+"' - success - found "+companiesData.length+" companies : returns "+companies.length+" companies"),resolve(companies)}),(function(response){var error=errorHelperService.handleError(response);$log.error("[companyService] "+errorHelperService.getErrorFullMessage(response,"searchCompanies")),reject(error)}))}))},service.getCompanyById=function(companyId,update){return $q((function(resolve,reject){if(!companyId)return $log.error("[companyService] getCompanyById -- missing companyId"),void reject(new Error("[companyService] getCompanyById -- missing companyId"));var company=service.companies[companyId];company&&!update?($log.info("[companyService] getCompanyById (cache) "+companyId+" - success"),resolve(company)):$http({method:"GET",url:service.portalURL+"companies/"+companyId,headers:authService.getRequestHeader()}).then((function(response){var companyData=response.data.data;company?(company.updateFromData(companyData),$log.info("[companyService] getCompanyById (update) "+companyId+" - success")):(company=Company.createFromData(companyData),service.companies[company.id]=company,$log.info("[companyService] getCompanyById "+companyId+" - success")),service.getCompanyLogo(company),service.getCompanyBanner(company),resolve(company)}),(function(response){var error=errorHelperService.handleError(response);$log.error("[companyService] "+errorHelperService.getErrorFullMessage(response,"getCompanyById")),reject(error)}))}))},service.getAdministratorIds=function(companyId){return $q((function(resolve,reject){var serverUrl=service.portalURL+"companies/"+companyId+"/administrators";$http({method:"GET",url:serverUrl,headers:authService.getRequestHeader()}).then((function(response){var data=response.data.data,administratorIds=[];data.forEach((function(userData){administratorIds.push(userData.id)})),$log.info("[companyService] getAdministratorIds success)"),resolve(administratorIds)}),(function(response){var error=errorHelperService.handleError(response);$log.error("[companyService] "+errorHelperService.getErrorFullMessage(response,"getAdministratorIds")),reject(error)}))}))},service.getCompanyLogo=function(company){return $q((function(resolve,reject){var companyColor=userInfoService.computeUserColor(company.name),companyInitials=company.name.substr(0,1);userInfoService.getAvatarImage(company.id,companyInitials,companyColor.color,130,company.lastAvatarUpdateDate).then((function(companyLogo){company.logo=companyLogo,$rootScope.$broadcast("ON_COMPANY_LOGO_UPDATED",company.id),$log.info("[companyService] getCompanyLogo - "+company.getNameForLogs()+" - success"),resolve(companyLogo)})).catch((function(error){$log.error("[companyService] getCompanyLogo - failure - "+error.message),reject(error)}))}))},service.getCompanyBanner=function(company){return $q((function(resolve){var image=new Image;if(company.lastBannerUpdateDate){var serverURL=config.webservices.protocol+"://"+config.webservices.currentServer;$rootScope.cdn&&(serverURL=$rootScope.cdnServer);var imgSrc=serverURL+"/api/banner/"+company.id+"?size=831";imgSrc+="&update="+Object(crypto_js__WEBPACK_IMPORTED_MODULE_0__.MD5)(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Latin1.parse(company.lastBannerUpdateDate)).toString(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Hex),image.onload=function(){var loadedBannerImage=this;$rootScope.$apply((function(){company.banner=loadedBannerImage,$rootScope.$broadcast("ON_COMPANY_BANNER_UPDATED",company.id),$log.log("[companyService] Load banner for "+company.getNameForLogs()+" success"),resolve(loadedBannerImage)}))},image.onerror=function(){$rootScope.$apply((function(){$log.warn("[companyService] Load banner for "+company.getNameForLogs()+" failure"),resolve(null)}))},image.src=imgSrc}else window.rainbowSDK?image=null:image.src="/cache/images/company-banner-01.svg",company.banner=image,$rootScope.$broadcast("ON_COMPANY_BANNER_UPDATED",company.id),$log.log("[companyService] Load default banner for "+company.getNameForLogs()+" success"),resolve(image)}))}}])},function(module,exports){!function(){"use strict";angular.module("rainbow").service("browserService",[function(){this.extractBrowserVersion=function(uastring,expr,pos){var match=uastring.match(expr);return match&&match.length>=pos&&parseInt(match[pos],10)}}])}()},function(module,exports){angular.module("rainbow").service("gRTCStatsService",[function(){"use strict";var calls={};this.resetStatsForAllCalls=function(){calls={}},this.resetStatsForCall=function(callid){callid in calls&&delete calls[callid]},this.getCalls=function(){return calls},this.nbCalls=function(){return Object.keys(calls).length},this.hasStatsForCall=function(callid){return callid in calls},this.addStreamToCall=function(callid,stream){callid in calls||(calls[callid]={});var call=calls[callid];call[stream.id]={},call[stream.id].stream=stream},this.nbStreamsInACall=function(callid){return callid in calls?Object.keys(calls[callid]).length:0},this.getBundlePolicyForCall=function(callid){if(!(callid in calls))return"unknown";var call=calls[callid],nbActiveStream=0,nbTotalStreams=this.nbStreamsInACall(callid);for(var componentID in call)"selectedCandidatePairId"in call[componentID].stream&&nbActiveStream++;if(4===nbTotalStreams)switch(nbActiveStream){case 0:return"failed";case 1:return"max-bundle";case 2:return"balanced";case 4:return"max-compat";default:return"unknown"}else{if(2!==nbTotalStreams)return"unknown";switch(nbActiveStream){case 0:return"failed";case 1:return"max-bundle";case 2:return"max-compat";default:return"unknown"}}},this.addSSRCToStream=function(callid,ssrc){var call,stream=null;"ssrc"===ssrc.type&&callid in calls&&(call=calls[callid],ssrc.transportId in call&&((stream=call[ssrc.transportId]).ssrc||(stream.ssrc={}),stream.ssrc[ssrc.ssrc]=ssrc))},this.hasSSRCInStream=function(callid,streamid,ssrcid){var call,stream;return callid in calls&&(streamid in(call=calls[callid])&&(!!(stream=call[streamid]).ssrc&&ssrcid in stream.ssrc))},this.getSSRCMediaType=function(callid,streamid,ssrcid){var call,stream;return callid in calls&&streamid in(call=calls[callid])&&(stream=call[streamid]).ssrc&&ssrcid in stream.ssrc?stream.ssrc[ssrcid].mediaType:"unknown"},this.getSSRCDirection=function(callid,streamid,ssrcid){var call,stream,ssrc;return callid in calls&&streamid in(call=calls[callid])&&(stream=call[streamid]).ssrc&&ssrcid in stream.ssrc?(ssrc=stream.ssrc[ssrcid],getDirection(ssrc.id)):"unknown"},this.getSSRCAudioCodecName=function(callid,streamid,ssrcid){var call,stream;return callid in calls&&streamid in(call=calls[callid])&&(stream=call[streamid]).ssrc&&ssrcid in stream.ssrc?stream.ssrc[ssrcid].googCodecName:"unknown"},this.isSSRCFlowing=function(callid,streamid,ssrcid){var call,stream,ssrc;if(!(callid in calls))return!1;if(!(streamid in(call=calls[callid])))return!1;if(!(stream=call[streamid]).ssrc)return!1;if(!(ssrcid in stream.ssrc))return!1;ssrc=stream.ssrc[ssrcid];return("IN"===getDirection(ssrc.id)?parseInt(ssrc.bytesReceived,10):parseInt(ssrc.bytesSent,10))>0},this.getStreamsDetailsFromCall=function(callid){var call=null,stream=null;if(!(callid in calls))return[];call=calls[callid];var streams=[];for(var streamid in call)if(call.hasOwnProperty(streamid)){stream=call[streamid];var audioResult="no",videoResult="no",hasAudioIN=!1,hasVideoIN=!1,hasAudioOUT=!1,hasVideoOUT=!1;for(var ssrcid in stream.ssrc)if(stream.ssrc&&stream.ssrc.hasOwnProperty&&stream.ssrc.hasOwnProperty(ssrcid)){var type=this.getSSRCMediaType(callid,streamid,ssrcid),direction=this.getSSRCDirection(callid,streamid,ssrcid),isFlowing=this.isSSRCFlowing(callid,streamid,ssrcid);"audio"===type&&"IN"===direction&&isFlowing?hasAudioIN=!0:"audio"===type&&"OUT"===direction&&isFlowing?hasAudioOUT=!0:"video"===type&&"IN"===direction&&isFlowing?hasVideoIN=!0:"video"===type&&"OUT"===direction&&isFlowing&&(hasVideoOUT=!0)}hasAudioIN&&hasAudioOUT?audioResult="IN|OUT":hasAudioIN?audioResult="IN":hasAudioOUT&&(audioResult="OUT"),hasVideoIN&&hasVideoOUT?videoResult="IN|OUT":hasVideoIN?videoResult="IN":hasVideoOUT&&(videoResult="OUT"),hasAudioIN||hasAudioOUT||hasVideoIN||hasVideoOUT?streams.push({id:streamid,streams:{audio:audioResult,video:videoResult}}):streams.push({id:streamid,streams:{}})}return streams},this.getCodecDetailsFromCall=function(callid){var call=null,stream=null,audioCodec="-",videoCodec="-",codecs={codec:{audio:audioCodec,video:videoCodec}};if(!(callid in calls))return codecs;for(var streamid in call=calls[callid])if(call.hasOwnProperty(streamid))for(var ssrcid in(stream=call[streamid]).ssrc)"audio"===stream.ssrc[ssrcid].mediaType&&(audioCodec=this.getSSRCAudioCodecName(callid,streamid,ssrcid)),"video"===stream.ssrc[ssrcid].mediaType&&(videoCodec=this.getSSRCAudioCodecName(callid,streamid,ssrcid));return codecs.codec.audio=audioCodec,codecs.codec.video=videoCodec,codecs};var getDirection=function(id){return id.indexOf("recv")>-1?"IN":"OUT"}}])},function(module,exports){angular.module("rainbow").service("fRTCStatsService",[function(){"use strict";var calls={};this.getCalls=function(){return calls},this.nbCalls=function(){return Object.keys(calls).length},this.addStreamToCall=function(callid,stream){if(!stream.isRemote){callid in calls||(calls[callid]={});var call=calls[callid];call.streams||(call.streams={}),call.streams[stream.id]={},call.streams[stream.id]=stream}},this.nbStreamsInACall=function(callid){return callid in calls?Object.keys(calls[callid].streams).length:0},this.resetStatsForAllCalls=function(){calls={}},this.resetStatsForCall=function(callid){callid in calls&&delete calls[callid]},this.hasStatsForCall=function(callid){return callid in calls},this.hasSSRCInStream=function(callid,streamid,ssrcid){var call;return callid in calls&&(!!(call=calls[callid]).streams&&(streamid in call.streams&&call.streams[streamid].ssrc===ssrcid))},this.hasStreamInCall=function(callid,streamid){return callid in calls&&streamid in calls[callid].streams},this.getSSRCMediaType=function(callid,streamid){var call;return callid in calls&&streamid in(call=calls[callid]).streams?call.streams[streamid].mediaType:"unknown"},this.getStreamsDetailsFromCall=function(callid){var call=null;if(!(callid in calls))return[];call=calls[callid];var streams=[];for(var streamid in call.streams)if(call.streams.hasOwnProperty(streamid)){var type=this.getSSRCMediaType(callid,streamid),direction=getDirection(streamid);"audio"===type?streams.push({id:streamid,streams:{audio:direction}}):"video"===type&&streams.push({id:streamid,streams:{video:direction}})}return streams},this.addCandidatePairToCall=function(callid,candidatePair){var call=null,hasAlreadyThisCandidatePair=!1;if(callid in calls){(call=calls[callid]).candidatesPairs||(call.candidatesPairs=[]);for(var i=0;i<call.candidatesPairs.length;i++)if(call.candidatesPairs[i].id===candidatePair.id){hasAlreadyThisCandidatePair=!0;break}!hasAlreadyThisCandidatePair&&"succeeded"===candidatePair.state&&candidatePair.selected&&call.candidatesPairs.push(candidatePair)}},this.getNbCandidatePairs=function(callid){var call,nbCandidatePairs=0;return callid in calls?((call=calls[callid]).candidatesPairs&&(nbCandidatePairs=call.candidatesPairs.length),nbCandidatePairs):nbCandidatePairs},this.getBundlePolicyForCall=function(callid){var policy="unknown";if(!(callid in calls))return policy;switch(this.getNbCandidatePairs(callid)){case 0:policy="failed";break;case 1:policy="max-bundle";break;case 2:policy=this.nbStreamsInACall(callid)>2?"balanced":"max-compat";break;default:policy="max-compat"}return policy};var getDirection=function(id){return id.indexOf("inbound")>-1?"IN":"OUT"}}])},function(module,exports){angular.module("rainbow").service("platformService",["$log","$rootScope","$window","$interval","settingsService","$q","$filter","$http","authService","errorHelperService",function($log,$rootScope,$window,$interval,settingsService,$q,$filter,$http,authService,errorHelperService){"use strict";var service=this,listeners=[];service.$q=$q,this.isWin=navigator.platform.toUpperCase().indexOf("WIN")>=0,service.start=function(stats){return $q((function(resolve,__reject){var startDate=performance.now();$log.info(""),$log.info("[platformService] === STARTING ==="),service.languages=["en","fr","es","de","it"],listeners.push($rootScope.$on("$translateChangeSuccess",(function(){service.fixDeviceLabels()}))),listeners.push($rootScope.$on("ON_INPUT_DEVICE_CHANGED_EVENT",onAudioInputChange)),listeners.push($rootScope.$on("ON_OUTPUT_DEVICE_CHANGED_EVENT",updateOutputDevice)),listeners.push($rootScope.$on("ON_CONNECTION_STATE_CHANGE_EVENT",service.onAuthenticationStatusChangedEvent)),service.isAskingMedia=!1,service.hasAudioPermission=!1,service.hasVideoPermission=!1,service.stopWatcher(),$interval(service.startWatcher,2e3,1);var startDuration=Math.round(performance.now()-startDate);stats.push({service:"platformService",startDuration:startDuration}),$log.info("[platformService] === STARTED ("+startDuration+" ms) ==="),resolve()}))},service.stop=function(){return $log.info("[platformService] === STOPPING ==="),listeners.forEach((function(listener){listener()})),service.stopWatcher(),this.mediaDevicesLength=0,this.mediaDevices=[],$log.info("[platformService] === STOPPED ==="),$q.when()},service.onAuthenticationStatusChangedEvent=function(__event,status){"connected"===status&&(!service.allowDevicesManagement()||!angular.element("#globalAudioTag")[0]||angular.element("#globalAudioTag")[0].sinkId&&"default"!==angular.element("#globalAudioTag")[0].sinkId||($log.info("[platformService] onAuthenticationStatusChangedEvent -- update global audio tag"),service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)}))),service.testGetUserMedia())},this.audioDevices=0,this.videoDevices=0,this.detectRTCLoaded=function(){service.hasAudioPermission=DetectRTC.isWebsiteHasMicrophonePermissions,service.hasVideoPermission=DetectRTC.isWebsiteHasWebcamPermissions,service.fixDeviceLabels();var shouldAskAudio=!1,shouldAskVideo=!1,shouldAskMedia=service.shouldAskGetUserMedia();(DetectRTC.audioInputDevices&&DetectRTC.audioInputDevices.length||DetectRTC.audioOutputDevices&&DetectRTC.audioOutputDevices.length)&&(!service.hasAudioPermission||shouldAskMedia.audio?shouldAskAudio=!0:_isWebsiteHasMicrophonePermissions=!0),DetectRTC.videoInputDevices&&DetectRTC.videoInputDevices.length&&(!service.hasVideoPermission||shouldAskMedia.video?shouldAskVideo=!0:_isWebsiteHasWebcamPermissions=!0),shouldAskAudio||shouldAskVideo?service.isAskingMedia||(service.isAskingMedia=!0,service.getUserMedia(shouldAskAudio,shouldAskVideo)):(service.fixDeviceLabels(),updateHeadsetDevices().then((function(){service.isDesktop()&&service.updateNewDesktopDevicesIds(),updateAvailability(),service.audioDevices!==DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length&&(service.audioDevices=DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length,service.audioMediaDeviceUpdated()),service.videoDevices!==DetectRTC.videoInputDevices.length&&(service.videoDevices=DetectRTC.videoInputDevices.length,service.videoMediaDeviceUpdated()),angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){mediaDevice&&$log.info("[PlatformService] DetectRTC.MediaDevices device "+mediaDevice.id+" with kind "+mediaDevice.kind+" with label "+mediaDevice.label)})),service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)})),service.newDevice&&service.checkAndUpdateHandFreeProfile(),service.startWatcher()})))},this.testGetUserMedia=function(){if(service.hasAudioPermission){var startDate=performance.now();service.getCurrentMicrophone().then((function(microphone){var constraints={},mic="default";microphone?(constraints.audio={optional:[{sourceId:microphone.id}]},mic="id - "+microphone.id+" and label "+microphone.label):constraints.audio=!0,$log.info("[PlatformService] testGetUserMedia -- getUserMedia for Mic "+mic),navigator.mediaDevices.getUserMedia(constraints).then((function(stream){var completeStartDuration=Math.round(performance.now()-startDate);$log.info("[PlatformService] testGetUserMedia -- getUserMedia success for time : "+completeStartDuration+" ms"),angular.forEach(stream.getTracks(),(function(mediaStreamTrack){$log.info("[PlatformService] testGetUserMedia mediaStreamTrack -- "+mediaStreamTrack.label),mediaStreamTrack.stop()})),service.isAskingMedia=!1})).catch((function(error){$log.info("[PlatformService] testGetUserMedia -- getUserMedia error "+error),service.isAskingMedia=!1}))}))}else $log.info("[PlatformService] testGetUserMedia -- no audio permission given")},this.shouldAskGetUserMedia=function(){var result={audio:!1,video:!1};return angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){mediaDevice&&mediaDevice.label&&-1!==mediaDevice.label.indexOf("invoke getUserMedia")&&("audioinput"===mediaDevice.kind||"audiooutput"===mediaDevice.kind?result.audio=!0:result.video=!0)})),$log.info("[platformService] shouldAskGetUserMedia : audio "+result.audio+" and video "+result.video),result},this.updateNewDesktopDevicesIds=function(){var handFreeInputDeviceName=settingsService.getSetting("handFreeInputDeviceName"),handFreeOutputDeviceName=settingsService.getSetting("handFreeOutputDeviceName"),headsetDeviceName=settingsService.getSetting("headsetDeviceName"),customMicrophoneName=settingsService.getSetting("customMicrophoneName"),customSpeakerName=settingsService.getSetting("customSpeakerName"),cameraUsed=settingsService.getSetting("cameraUsed"),secondRinging=settingsService.getSetting("ringingSpeakerName");(handFreeInputDeviceName||handFreeOutputDeviceName||headsetDeviceName||customMicrophoneName||customSpeakerName)&&angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){"audioinput"===mediaDevice.kind?(mediaDevice.normalizedLabel===headsetDeviceName&&settingsService.setSetting("headsetMicrophone",mediaDevice.id),mediaDevice.normalizedLabel===handFreeInputDeviceName&&settingsService.setSetting("microphone",mediaDevice.id),mediaDevice.normalizedLabel===customMicrophoneName&&settingsService.setSetting("customMicrophone",mediaDevice.id)):"audiooutput"===mediaDevice.kind&&(mediaDevice.normalizedLabel===headsetDeviceName&&settingsService.setSetting("headsetSpeaker",mediaDevice.id),mediaDevice.normalizedLabel===handFreeOutputDeviceName&&settingsService.setSetting("speaker",mediaDevice.id),mediaDevice.normalizedLabel===customSpeakerName&&settingsService.setSetting("customSpeaker",mediaDevice.id))})),cameraUsed&&angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){"videoinput"===mediaDevice.kind&&mediaDevice.label===cameraUsed&&settingsService.setSetting("camera",mediaDevice.id)})),secondRinging&&angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){"audiooutput"===mediaDevice.kind&&mediaDevice.normalizedLabel===secondRinging&&settingsService.setSetting("ringingSpeaker",mediaDevice.id)}))},this.mediaDevicesLength=0,this.mediaDevices=[],this.newDevice=null,this.devicesWatcher=function(){navigator.mediaDevices.enumerateDevices().then((function(devices){(service.mediaDevicesLength!==devices.length||service.checkForIdChange(devices))&&($log.debug("[platformService] MediaDevices count changed ! from "+service.mediaDevicesLength+" to "+devices.length),$log.debug("[platformService] MediaDevices brut devices list "+JSON.stringify(devices)),devices.length-service.mediaDevicesLength==1?service.newDevice=service.getNewDevice(service.mediaDevices,devices):service.newDevice=null,service.mediaDevicesLength=devices.length,service.mediaDevices=devices,service.stopWatcher(),DetectRTC.load(service.detectRTCLoaded))}))},service.checkAndUpdateHandFreeProfile=function(){$log.info("[platformService] checkAndUpdateHandFreeProfile");var activeProfile=service.getActiveAudioProfile();1===activeProfile.key&&!0===activeProfile.available&&service.getCurrentSpeaker().then((function(speaker){speaker&&speaker.groupId===service.newDevice.groupId&&($log.info("[platformService] checkAndUpdateHandFreeProfile -- should update the Jack Mic"),$rootScope.$broadcast("ON_HANDFREE_JACK_MICROPHONE_EVENT",service.newDevice))}))},service.checkForIdChange=function(devices){var changed=!1;return service.mediaDevices.length&&angular.forEach(service.mediaDevices,(function(device){if("default"!==device.deviceId&&"communications"!==device.deviceId){for(var found=!1,i=0;i<devices.length;i++)device.deviceId===devices[i].deviceId&&(found=!0);found||(changed=!0)}})),changed&&$log.info("[platformService] checkForIdChange "+changed),changed},service.getNewDevice=function(oldDevices,newDevices){var newDevice=null;return newDevices.length&&angular.forEach(newDevices,(function(device){if("default"!==device.deviceId&&"communications"!==device.deviceId){for(var found=!1,i=0;i<oldDevices.length;i++)device.deviceId===oldDevices[i].deviceId&&(found=!0);found||"audioinput"!==device.kind||(newDevice=device)}})),newDevice},service.tryToGetUserMediaForEachDevice=function(){if($log.info("[platformService] tryToGetUserMediaForEachDevice"),DetectRTC.audioInputDevices&&DetectRTC.audioInputDevices.length){for(var chain=$q.when(),i=0;i<DetectRTC.audioInputDevices.length;i++)!function(index){var device=DetectRTC.audioInputDevices[index];chain=chain.then((function(){return service.getUserMediaForAudioDevice(device.id)}))}(i);chain=chain.finally((function(){if($log.info("[platformService] tryToGetUserMediaForEachDevice finally -- has audio permission "+service.hasAudioPermission),service.hasAudioPermission)service.loadDetectRTC();else{_isWebsiteHasMicrophonePermissions=!1,_isWebsiteHasWebcamPermissions=!1,service.isAskingMedia=!1;$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"information",popupBody:"devicePermission",okLabel:"ok"}),service.startWatcher()}}))}else $log.warn("[platformService] tryToGetUserMediaForEachDevice -- no audio devices found, restart the watcher"),service.startWatcher()},service.getUserMediaForAudioDevice=function(id){return $q((function(resolve){if(service.hasAudioPermission)return $log.info("[platformService] getUserMediaForAudioDevice for id: "+id+" no longer needed !"),void resolve();if(!id)return $log.info("[platformService] getUserMediaForAudioDevice missing id !"),void resolve();$log.info("[platformService] getUserMediaForAudioDevice for id: "+id);var constraints={};constraints.audio={optional:[{sourceId:id}]},navigator.mediaDevices.getUserMedia(constraints).then((function(stream){$log.info("[platformService] getUserMediaForAudioDevice for id: "+id+" success"),angular.forEach(stream.getAudioTracks(),(function(mediaStreamTrack){mediaStreamTrack.stop()})),service.hasAudioPermission=!0,_isWebsiteHasMicrophonePermissions=!0,service.hasVideoPermission=!0,_isWebsiteHasWebcamPermissions=!0,resolve()})).catch((function(error){$log.info("[platformService] getUserMediaForAudioDevice for id: "+id+" failed with error "+error),resolve()}))}))},service.getUserMedia=function(audio,video){$log.info("[platformService] getUserMedia audio: "+audio+" and video: "+video),navigator.mediaDevices.getUserMedia({audio:audio,video:video}).then((function(stream){$log.info("[platformService] getUserMedia audio: "+audio+" and video: "+video+" -- success!"),angular.forEach(stream.getAudioTracks(),(function(mediaStreamTrack){mediaStreamTrack.stop()})),angular.forEach(stream.getVideoTracks(),(function(mediaStreamTrack){mediaStreamTrack.stop()})),audio&&(service.hasAudioPermission=!0,_isWebsiteHasMicrophonePermissions=!0),video&&(service.hasVideoPermission=!0,_isWebsiteHasWebcamPermissions=!0),stream=null,service.loadDetectRTC()})).catch((function(error){$log.error("[platformService] getUserMedia -- error -- "+error),service.tryToGetUserMediaForEachDevice()}))},service.loadDetectRTC=function(){DetectRTC.load((function(){service.fixDeviceLabels(),updateHeadsetDevices().then((function(){service.isDesktop()&&service.updateNewDesktopDevicesIds(),updateAvailability(),service.isAskingMedia=!1,service.audioDevices!==DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length&&(service.audioDevices=DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length,service.audioMediaDeviceUpdated()),service.videoDevices!==DetectRTC.videoInputDevices.length&&(service.videoDevices=DetectRTC.videoInputDevices.length,service.videoMediaDeviceUpdated()),angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){mediaDevice&&$log.info("[PlatformService] DetectRTC.MediaDevices device "+mediaDevice.id+" with kind "+mediaDevice.kind+" with label "+mediaDevice.label)})),service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)})),service.startWatcher()}))}))},service.getWhatsNew=function(){return $q((function(resolve){var url=config.restServerUrl+"/api/rainbow/enduser/v1.0/settings/changelogs";$http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){$log.info("[adminPlatformService] getWhatsNew -- success");var data=response.data.data.changeLog.split("%"),whatsNew={};data.forEach((function(markdown,index){whatsNew[service.languages[index]]=markdown})),Object.keys(whatsNew).forEach((function(key){0===whatsNew[key].length&&(whatsNew[key]=whatsNew.en)})),whatsNew.en||(whatsNew={en:"",fr:"",es:"",de:"",it:""}),resolve(whatsNew)}),(function(response){resolve({en:"",fr:"",es:"",de:"",it:""}),$log.error("[adminPlatformService] "+errorHelperService.getErrorFullMessage(response,"getWhatsNew"))}))}))},service.getAvailableLanguage=function(lang){var mainLang=lang.split("-")[0],realLang=service.languages.find((function(language){return language===mainLang}));return realLang||"en"},this.isDesktop=function(){return navigator.userAgent.indexOf(" Rainbow/")>=0},this.allowDevicesManagement=function(){return $window.chrome||this.isDesktop()};var _isWebsiteHasWebcamPermissions=!1;this.isWebsiteHasWebcamPermissions=function(){return!!service.allowDevicesManagement()&&_isWebsiteHasWebcamPermissions};var _isWebsiteHasMicrophonePermissions=!1;this.isWebsiteHasMicrophonePermissions=function(){return!!service.allowDevicesManagement()&&_isWebsiteHasMicrophonePermissions};var audioProfile={HANDFREE:{key:1,value:"handfree",available:!1},HEADSET:{key:2,value:"headset",available:!1},SPEAKERPHONE:{key:3,value:"speakerphone",available:!1},CUSTOM:{key:4,value:"custom",available:!1}};this.audioProfileEnum=audioProfile,this.getAudioProfiles=function(){return audioProfile},this.currentAudioProfile=audioProfile.HANDFREE,this.getCurrentAudioProfile=function(){var profile=null;switch(settingsService.getSetting("audioProfile")){case audioProfile.HEADSET.value:profile=audioProfile.HEADSET;break;case audioProfile.HANDFREE.value:profile=audioProfile.HANDFREE;break;case audioProfile.SPEAKERPHONE.value:profile=audioProfile.SPEAKERPHONE;break;case audioProfile.CUSTOM.value:profile=audioProfile.CUSTOM;break;default:profile=audioProfile.HANDFREE,settingsService.setSetting("audioProfile",profile.value)}return profile},this.getActiveAudioProfile=function(){var profile=this.getCurrentAudioProfile();return profile.key===audioProfile.HANDFREE.key||profile.available?profile:audioProfile.HANDFREE},this.setCurrentAudioProfile=function(profile){profile&&(service.currentAudioProfile=profile)},this.isHandfreeAvailable=function(){return service.isHandfreeMicrophoneAvailable()&&service.isHandfreeSpeakerAvailable()},this.isHeadsetAvailable=function(){return service.isHeadsetMicrophoneAvailable()&&service.isHeadsetSpeakerAvailable()},this.isSpeakerphoneAvailable=function(){return service.isSpeakerphoneMicrophoneAvailable()&&service.isSpeakerphoneSpeakerAvailable()},this.isCustomAvailable=function(){return service.isCustomMicrophoneAvailable()&&service.isCustomSpeakerAvailable()},this.getCurrentMicrophone=function(){if("sdk"===settingsService.getSetting("apiMode")){var microphone=service.getMicrophoneForSDK();if(microphone)return microphone}switch(service.getActiveAudioProfile()){case audioProfile.SPEAKERPHONE:return service.getSpeakerphoneMicrophone();case audioProfile.CUSTOM:return service.getCustomMicrophone();case audioProfile.HEADSET:return service.getHeadsetMicrophone();default:return service.getHandfreeMicrophone()}},this.getMicrophoneForSDK=function(){var deferred=$q.defer();return service.getMicrophones().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,settingsService.getSetting("microphone")))})),deferred.promise},this.getSecondRingerStatusFromSettings=function(){return settingsService.getSetting("hasSecondRinger")},this.setSecondRingerStatusFromSettings=function(val){return settingsService.setSetting("hasSecondRinger",val)},this.getHandfreeMicrophoneFromSettings=function(){return settingsService.getSetting("microphone")},this.getHandfreeMicrophone=function(){var deferred=$q.defer();return service.getMicrophones().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getHandfreeMicrophoneFromSettings()))})),deferred.promise},this.getHeadsetMicrophoneFromSettings=function(){return settingsService.getSetting("headsetMicrophone")},this.getHeadsetMicrophone=function(){var deferred=$q.defer();return service.getMicrophones().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getHeadsetMicrophoneFromSettings()))})),deferred.promise},this.getHeadsetDeviceName=function(){var deferred=$q.defer();return deferred.resolve(settingsService.getSetting("headsetDeviceName")),deferred.promise},this.getSpeakerphoneMicrophoneFromSettings=function(){return settingsService.getSetting("speakerphoneMicrophone")},this.getSpeakerphoneMicrophone=function(){var deferred=$q.defer();return service.getMicrophones().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getSpeakerphoneMicrophoneFromSettings()))})),deferred.promise},this.getSpeakerphoneDeviceName=function(){var deferred=$q.defer();return deferred.resolve(settingsService.getSetting("speakerphoneDeviceName")),deferred.promise},this.getCustomMicrophoneFromSettings=function(){return settingsService.getSetting("customMicrophone")},this.getCustomMicrophone=function(){var deferred=$q.defer();return service.getMicrophones().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getCustomMicrophoneFromSettings()))})),deferred.promise},this.getMicrophones=function(){var deferred=$q.defer();return this.allowDevicesManagement()||deferred.resolve([]),service.getAudioInputDevices().then((function(devices){deferred.resolve(devices&&devices.constructor===Array&&_isWebsiteHasMicrophonePermissions?devices:[])})).catch((function(error){return $log.info("[PlatformService] === SERVICES FAILURE === : "+error.message),deferred.reject(error),deferred.promise})),deferred.promise},this.isHandfreeMicrophoneAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getHandfreeMicrophoneFromSettings(),"audioinput")},this.isHeadsetMicrophoneAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getHeadsetMicrophoneFromSettings(),"audioinput")},this.isSpeakerphoneMicrophoneAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getSpeakerphoneMicrophoneFromSettings(),"audioinput")},this.isCustomMicrophoneAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getCustomMicrophoneFromSettings(),"audioinput")},this.getCurrentSpeaker=function(){if("sdk"===settingsService.getSetting("apiMode")){var speaker=service.getSpeakerForSDK();if(speaker)return speaker}switch(service.getActiveAudioProfile()){case audioProfile.SPEAKERPHONE:return service.getSpeakerphoneSpeaker();case audioProfile.CUSTOM:return service.getCustomSpeaker();case audioProfile.HEADSET:return service.getHeadsetSpeaker();default:return service.getHandfreeSpeaker()}},this.getSpeakerForSDK=function(){var deferred=$q.defer();return service.getSpeakers().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,settingsService.getSetting("speaker")))})),deferred.promise},this.getHandfreeSpeakerFromSettings=function(){return settingsService.getSetting("speaker")},this.getHandfreeSpeaker=function(){var deferred=$q.defer();return service.getSpeakers().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getHandfreeSpeakerFromSettings(),!0))})),deferred.promise},this.getHeadsetSpeakerFromSettings=function(){return settingsService.getSetting("headsetSpeaker")},this.getHeadsetSpeaker=function(){var deferred=$q.defer();return service.getSpeakers().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getHeadsetSpeakerFromSettings()))})),deferred.promise},this.getSpeakerphoneSpeakerFromSettings=function(){return settingsService.getSetting("speakerphoneSpeaker")},this.getSpeakerphoneSpeaker=function(){var deferred=$q.defer();return service.getSpeakers().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getSpeakerphoneSpeakerFromSettings()))})),deferred.promise},this.getCustomSpeakerFromSettings=function(){return settingsService.getSetting("customSpeaker")},this.getCustomSpeaker=function(){var deferred=$q.defer();return service.getSpeakers().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getCustomSpeakerFromSettings()))})),deferred.promise},this.getRingingSpeakerFromSettings=function(){return settingsService.getSetting("ringingSpeaker")},this.getRingingSpeaker=function(){var deferred=$q.defer();return service.getSpeakers().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getRingingSpeakerFromSettings()))})),deferred.promise},this.setSpeakerForElement=function(element,sinkId){var defered=$q.defer();if(!element||!element.setSinkId)return $log.warn("[platformService] setSpeakerForElement -- missing element"),$q.when();if(this.allowDevicesManagement()){if(sinkId===element.sinkId)return $q.when();element.id&&$log.log("[platformService] setSpeakerForElement "+element.id+" with "+sinkId),element.setSinkId(sinkId).then((function(){$log.log("[platformService] Success, audio output device attached: "+sinkId),angular.element("#globalAudioTag")[0]&&$log.log("[platformService] sinkId for globalAudioTag is "+angular.element("#globalAudioTag")[0].sinkId),defered.resolve()})).catch((function(error){var errorMessage=error;"SecurityError"===error.name&&(errorMessage="[platformService] You need to use HTTPS for selecting audio output device: "+error),$log.error("[platformService] "+errorMessage),defered.resolve()}))}else $log.warn("[platformService] Browser does not support output device selection."),defered.resolve();return defered.promise},this.getSpeakers=function(){var deferred=$q.defer();return service.allowDevicesManagement()||deferred.resolve([]),service.getAudioOutputDevices().then((function(devices){deferred.resolve(devices&&devices.constructor===Array&&_isWebsiteHasMicrophonePermissions?devices:[])})).catch((function(error){return $log.info("[PlatformService] === SERVICES FAILURE === : "+error.message),deferred.reject(error),deferred.promise})),deferred.promise},this.isHandfreeSpeakerAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getHandfreeSpeakerFromSettings(),"audiooutput")};var _handfreeAvailibilityStatus=!1;this.isHeadsetSpeakerAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getHeadsetSpeakerFromSettings(),"audiooutput")};var _headsetAvailibilityStatus=null;this.isSpeakerphoneSpeakerAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getSpeakerphoneSpeakerFromSettings(),"audiooutput")};var _speakerphoneAvailibilityStatus=!1;this.isCustomSpeakerAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getCustomSpeakerFromSettings(),"audiooutput")};var _customAvailibilityStatus=!1;function onAudioInputChange(){updateAvailability(),service.isAskingMedia?$log.info("[PlatformService] onAudioInputChange -- already asking media -- ignore"):(service.isAskingMedia=!0,$interval(service.testGetUserMedia,2e3,1))}function updateAvailability(){var isAvailable;isAvailable=service.isHandfreeAvailable(),_handfreeAvailibilityStatus!==isAvailable&&($log.info("[PlatformService] Handfree is now "+(isAvailable?"available":"unavailable")),_handfreeAvailibilityStatus=isAvailable,audioProfile.HANDFREE.available=isAvailable,$rootScope.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",isAvailable),$rootScope.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),isAvailable||service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)}))),function(isAvailable){if(_headsetAvailibilityStatus!==isAvailable){if($log.info("[PlatformService] Headset is now "+(isAvailable?"available":"unavailable")),_headsetAvailibilityStatus=isAvailable,audioProfile.HEADSET.available=isAvailable,isAvailable)settingsService.getSetting("audioProfile")===audioProfile.HANDFREE.value&&(settingsService.setSetting("audioProfile",audioProfile.HEADSET.value),service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)})));else settingsService.getSetting("audioProfile")===audioProfile.HEADSET.value&&settingsService.setSetting("audioProfile",audioProfile.HANDFREE.value),service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)}));$rootScope.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",isAvailable),$rootScope.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT")}}(service.isHeadsetAvailable()),function(isAvailable){_speakerphoneAvailibilityStatus!==isAvailable&&($log.info("[PlatformService] Speakerphone is now "+(isAvailable?"available":"unavailable")),_speakerphoneAvailibilityStatus=isAvailable,audioProfile.SPEAKERPHONE.available=isAvailable,$rootScope.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",isAvailable),$rootScope.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),isAvailable||service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)})))}(service.isSpeakerphoneAvailable()),function(isAvailable){_customAvailibilityStatus!==isAvailable&&($log.info("[PlatformService] Custom is now "+(isAvailable?"available":"unavailable")),_customAvailibilityStatus=isAvailable,audioProfile.CUSTOM.available=isAvailable,$rootScope.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",isAvailable),$rootScope.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),isAvailable||service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)})))}(service.isCustomAvailable())}function updateOutputDevice(__event,device_id){updateAvailability(),$log.info("[PlatformService] updateOutputDevice "+device_id),service.allowDevicesManagement()&&device_id&&updateCurrentOutputDevice(device_id)}var currentUpdatingDeviceId="";function updateCurrentOutputDevice(device_id){$log.info("[PlatformService] updateCurrentOutputDevice "+device_id),angular.element("#globalAudioTag")[0]&&angular.element("#globalAudioTag")[0].sinkId!==device_id&&currentUpdatingDeviceId!==device_id?(currentUpdatingDeviceId=device_id,$log.info("[PlatformService] updateCurrentOutputDevice current ID "+angular.element("#globalAudioTag")[0].sinkId+" new id "+device_id),service.setSpeakerForElement(angular.element("#globalAudioTag")[0],"default").then((function(){service.setSpeakerForElement(angular.element("#globalAudioTag")[0],device_id),currentUpdatingDeviceId=""})).catch((function(){currentUpdatingDeviceId=""}))):$log.info("[PlatformService] updateCurrentOutputDevice -- ignored ")}var microphones=[],speakers=[],allDevices=[],headsetDevices=[],speakerphoneDevices=[],firstDeviceUpdateHeadset=!0,handfreeSupportedDevices=["realtek","soundmax","high definition audio","nomachine"];service.arrayContains=function(array,textSearched){return array.some((function(element){return textSearched.indexOf(element)>-1}))},service.getDeviceType=function(deviceLabel){return deviceLabel=deviceLabel.toLowerCase(),service.arrayContains(handfreeSupportedDevices,deviceLabel)?audioProfile.HANDFREE:audioProfile.HEADSET},this.normalizeAnyLabel=function(anyDevice){return anyDevice?("default"===anyDevice.id||"communications"===anyDevice.id||anyDevice.normalizedLabel||(service.isWin?-1!==anyDevice.label.indexOf("Realtek Audio")||-1!==anyDevice.label.indexOf("Realtek(R) Audio")?anyDevice.normalizedLabel=anyDevice.label:anyDevice.normalizedLabel=anyDevice.label.substring(anyDevice.label.indexOf("(")+1,anyDevice.label.indexOf(")")):anyDevice.normalizedLabel=anyDevice.label),anyDevice):null};var updateHeadsetDevices=function(){var deferred=$q.defer();return service.getMicrophones().then((function(devices){return microphones=devices,service.getSpeakers()})).then((function(devices){speakers=devices;var _headsetDevices=[];angular.forEach(microphones,(function(microphone){"default"!==microphone.id&&"communications"!==microphone.id&&(microphone=service.normalizeAnyLabel(microphone),_headsetDevices.some((function(device){return device.microphone.normalizedLabel===microphone.normalizedLabel}))||angular.forEach(speakers,(function(speaker){if(speaker=service.normalizeAnyLabel(speaker),microphone.normalizedLabel===speaker.normalizedLabel&&service.getDeviceType(microphone.normalizedLabel)===audioProfile.HEADSET){var _device={label:microphone.normalizedLabel,microphone:microphone,speaker:speaker};_headsetDevices.push(_device),firstDeviceUpdateHeadset&&allDevices.push(_device)}})))}));var headSetName=settingsService.getSetting("headsetDeviceName");headSetName&&"null"!==headSetName||!_headsetDevices.length||(headSetName=_headsetDevices[0].label,settingsService.setSetting("headsetDeviceName",_headsetDevices[0].label),settingsService.setSetting("headsetMicrophone",_headsetDevices[0].microphone.id),settingsService.setSetting("headsetSpeaker",_headsetDevices[0].speaker.id));var ringingSpeakerName=settingsService.getSetting("ringingSpeakerName");if((!ringingSpeakerName||"null"===ringingSpeakerName)&&speakers.length)for(var i=0;i<speakers.length;i++)if("default"!==speakers[i].id&&"communications"!==speakers[i].id){settingsService.setSetting("ringingSpeakerName",speakers[i].normalizedLabel),settingsService.setSetting("ringingSpeaker",speakers[i].id);break}var newHeadsetDevices=[];firstDeviceUpdateHeadset||(angular.forEach(_headsetDevices,(function(newDevice){headsetDevices.some((function(oldDevice){return oldDevice.label===newDevice.label}))||(newHeadsetDevices.push(newDevice),allDevices.push(newDevice))})),newHeadsetDevices.length>0&&($log.info("[PlatformService] hotplugged headset(s): "+(newHeadsetDevices.length>1?newHeadsetDevices.reduce((function(deviceA,deviceB){return{label:deviceA.Label+", "+deviceB.Label}})).label:newHeadsetDevices[0].label)),$rootScope.$broadcast("ON_AUDIO_HOTPLUG_DEVICES_CHANGED_EVENT",{devices:newHeadsetDevices,action:"add"})));var disconnectedDevices=[];!firstDeviceUpdateHeadset&&headsetDevices.length>_headsetDevices.length&&(angular.forEach(headsetDevices,(function(newDevice){if(!_headsetDevices.some((function(oldDevice){return oldDevice.label===newDevice.label}))){disconnectedDevices.push(newDevice);var index=allDevices.map((function(dev){return dev.label})).indexOf(newDevice.label);allDevices.splice(index,1)}})),disconnectedDevices.length>0&&($log.info("[PlatformService] unplugged headset(s): "+(disconnectedDevices.length>1?disconnectedDevices.reduce((function(deviceA,deviceB){return{label:deviceA.Label+", "+deviceB.Label}})).label:disconnectedDevices[0].label)),$rootScope.$broadcast("ON_AUDIO_HOTPLUG_DEVICES_CHANGED_EVENT",{devices:disconnectedDevices,action:"remove"}))),firstDeviceUpdateHeadset=!1,headsetDevices=_headsetDevices,deferred.resolve(_headsetDevices)})),deferred.promise};this.getHeadsetDevices=function(){return headsetDevices};var watcher;this.getSpeakerphoneDevices=function(){return speakerphoneDevices},this.getAllDevices=function(){return allDevices},this.getHandFreeDevice=function(){var deferred=$q.defer();return service.getHandfreeMicrophone().then((function(microphone){var curMic=microphone;service.getHandfreeSpeaker().then((function(speaker){var curSpeak=speaker;(!service.handFreeDevice||service.handFreeDevice.microphone&&service.handFreeDevice.microphone.id!==curMic.id||service.handFreeDevice.speaker&&service.handFreeDevice.speaker.id!==curSpeak.id)&&(service.handFreeDevice={label:"",microphone:curMic,speaker:curSpeak,profile:audioProfile.HANDFREE}),deferred.resolve(service.handFreeDevice)}))})),deferred.promise},this.getCustomDevice=function(){var deferred=$q.defer();return service.getCustomMicrophone().then((function(microphone){var curMic=microphone;service.getCustomSpeaker().then((function(speaker){var curSpeak=speaker;(!service.customDevice||service.customDevice.microphone&&service.customDevice.microphone.id!==curMic.id||service.customDevice.speaker&&service.customDevice.speaker.id!==curSpeak.id)&&(service.customDevice={label:"",microphone:curMic,speaker:curSpeak,profile:audioProfile.CUSTOM}),deferred.resolve(service.customDevice)}))})),deferred.promise},this.getAvailableDevices=function(){var deferred=$q.defer(),res=[];return service.getHandFreeDevice().then((function(device){res.push(device),headsetDevices.forEach((function(elem){elem.profile=audioProfile.HEADSET,res.push(elem)})),speakerphoneDevices.forEach((function(elem){elem.profile=audioProfile.SPEAKERPHONE,res.push(elem)})),service.getCustomDevice().then((function(customDevice){res.push(customDevice),deferred.resolve(res)}))})),deferred.promise},this.getStoredDeviceList=function(){return settingsService.getSetting("deviceList")},this.saveDeviceList=function(devices){for(var deviceLabelList=[],i=0;i<devices.length;i++)deviceLabelList[i]=devices[i].label;settingsService.setSetting("deviceList",angular.toJson(deviceLabelList))},this.getCurrentCamera=function(){var deferred=$q.defer();return service.getCameras().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,settingsService.getSetting("camera")))})),deferred.promise},this.getCameraForSDK=function(){return{id:settingsService.getSetting("camera")}},this.getCameras=function(){var deferred=$q.defer();return this.allowDevicesManagement()||deferred.resolve([]),service.getVideoInputDevices().then((function(devices){deferred.resolve(devices&&devices.constructor===Array&&_isWebsiteHasWebcamPermissions?devices:[])})).catch((function(error){return $log.info("[PlatformService] === SERVICES FAILURE === : "+error.message),deferred.reject(error),deferred.promise})),deferred.promise},this.isDeviceAvailable=function(devices,id,kind){var current_device=devices.find((function(device){return device.kind===kind&&device.deviceId===id}));return angular.isDefined(current_device)},this.getDeviceWithId=function(devices,id,isSpeaker){if(devices.constructor!==Array)return null;var current_device=null;"default"!==id&&"communications"!==id||(isSpeaker?(default_device=service.mediaDevices.find((function(device){return device.deviceId===id&&"audioinput"===device.kind})))&&(current_device=devices.find((function(device){return"default"!==device.id&&"communications"!==device.id&&default_device.groupId===device.groupId}))):(default_device=devices.find((function(device){return device.id===id})))&&(current_device=devices.find((function(device){return"default"!==device.id&&"communications"!==device.id&&default_device.groupId===device.groupId}))));if(current_device)return current_device;if(!(current_device=devices.find((function(device){return device.id===id})))){var default_device;if(isSpeaker)(default_device=service.mediaDevices.find((function(device){return"default"===device.deviceId&&"audioinput"===device.kind})))&&(current_device=devices.find((function(device){return"default"!==device.id&&"communications"!==device.id&&default_device.groupId===device.groupId})));current_device||(default_device=devices.find((function(device){return"default"===device.id})))&&(current_device=devices.find((function(device){return"default"!==device.id&&"communications"!==device.id&&default_device.groupId===device.groupId})))}return current_device||(devices.length>0?devices[0]:null)},this.startWatcher=function(){if(service.allowDevicesManagement()){if(angular.isDefined(watcher))return;watcher=$interval(service.devicesWatcher,1e3)}},this.stopWatcher=function(){angular.isDefined(watcher)&&($interval.cancel(watcher),watcher=void 0)},this.capitalizeFirstLetter=function(string){return string.charAt(0).toUpperCase()+string.slice(1)},this.fixDeviceLabels=function(){angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){mediaDevice&&("default"!==mediaDevice.id||mediaDevice.label&&"Default"!==mediaDevice.label?mediaDevice.id.length<64&&"Please invoke getUserMedia once."===mediaDevice.label&&(mediaDevice.label=service.capitalizeFirstLetter(mediaDevice.id)):mediaDevice.label=service.findAndUpdateDefaultDeviceLabel(mediaDevice.kind,mediaDevice.groupId),$log.info("[PlatformService] fixDeviceLabels || update device "+mediaDevice.id+" with kind "+mediaDevice.kind+" with label "+mediaDevice.label))}))},this.findAndUpdateDefaultDeviceLabel=function(kind,groupId){for(var label="audioinput"===kind?$filter("translate")("yourComputerMicrophoneDevice"):$filter("translate")("yourComputerSpeakerDevice"),i=0;i<DetectRTC.MediaDevices.length;i++)if("default"!==DetectRTC.MediaDevices[i].id&&DetectRTC.MediaDevices[i].kind===kind&&DetectRTC.MediaDevices[i].groupId===groupId){label=label+" - "+DetectRTC.MediaDevices[i].label;break}return label},this.updatePermissions=function(){var result=!1;return angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){mediaDevice&&mediaDevice.id.length>=64&&("Please invoke getUserMedia once."===mediaDevice.label?result=!0:("videoinput"!==mediaDevice.kind||_isWebsiteHasWebcamPermissions||(_isWebsiteHasWebcamPermissions=!0),"audioinput"!==mediaDevice.kind||_isWebsiteHasMicrophonePermissions||(_isWebsiteHasMicrophonePermissions=!0)))})),result},this.isGetUserMediaRequested=function(){return(!_isWebsiteHasWebcamPermissions||!_isWebsiteHasMicrophonePermissions)&&service.updatePermissions(DetectRTC.MediaDevices)},this.audioMediaDeviceUpdated=function(){service.fixDeviceLabels(),$rootScope.$broadcast("ON_USER_AUDIO_MEDIA_CHANGED_EVENT")},this.videoMediaDeviceUpdated=function(){service.fixDeviceLabels(),$rootScope.$broadcast("ON_USER_VIDEO_MEDIA_CHANGED_EVENT")};var removeDuplicates=function(devices){var result=[];return angular.forEach(devices,(function(device){result.some((function(item){return item.id===device.id}))||result.push(device)})),result};this.getAudioInputDevices=function(){return $q.when(removeDuplicates(DetectRTC.audioInputDevices))},this.getAudioOutputDevices=function(){var deferred=$q.defer();return deferred.resolve(removeDuplicates(DetectRTC.audioOutputDevices)),deferred.promise},this.getVideoInputDevices=function(){var deferred=$q.defer();return deferred.resolve(removeDuplicates(DetectRTC.videoInputDevices)),deferred.promise}}])},function(module,exports){angular.module("rainbow").service("gaService",[function(){"use strict";var analytics_ICEFailed={category:"webrtc",action:"CallsSuccessRate",label:"error_failed"},analytics_ICESuccess={category:"webrtc",action:"CallsSuccessRate",label:"success"},analytics_ICENoSTUNCandidate={category:"webrtc",action:"CallsSuccessRate",label:"error_no_stun_candidate"},analytics_ICEUsed={category:"webrtc",action:"ICEDistribution"},analytics_ICETopology={category:"webrtc",action:"ICETopology"},analytics_NegotiationTime={category:"webrtc",action:"ICENegotiation",label:"DurationMs"},analytics_GetUserMedia={category:"webrtc",action:"GetUserMediaRate",label:"success"},analytics_GetUserMediaErrorNoTrack={category:"webrtc",action:"GetUserMediaRate",label:"error_no_Track"},analytics_GetUserMediaError={category:"webrtc",action:"GetUserMediaRate",label:"error"},analytics_CodecsUsed={category:"webrtc",action:"CodecsDistribution"},analytics_NbSuccessCall={category:"webrtc",action:"CallsDistribution"},analytics_CallsDuration={category:"webrtc",action:"CallsDurationRange"},analytics_DragAndDrop={category:"ux",action:"dragAndDrop"},analytics_InviteFromProvider={category:"invitations",action:"inviteFromProvider"},_startNegotiationTime=null,_endNegotiationTime=null,_pendingComputation=!1,_lastICESuccessTracked=null,_lastICEFailedTracked=null,_ga=null;this.provideGA=function(ga){_ga=ga},this.hasGA=function(){return null!==_ga},this.trackICEUsed=function(local,remote){if(_ga){var localICEUsed="",remoteICEUsed="";switch(local){case"local":localICEUsed="host";break;case"peerreflexive":case"prflx":case"serverreflexive":localICEUsed="stun";break;case"relayed":localICEUsed="relay";break;default:localICEUsed=local}switch(remote){case"local":remoteICEUsed="host";break;case"peerreflexive":case"prflx":case"serverreflexive":remoteICEUsed="stun";break;case"relayed":remoteICEUsed="relay";break;default:remoteICEUsed=remote}_ga.send("event",analytics_ICEUsed.category,analytics_ICEUsed.action,localICEUsed+"|"+remoteICEUsed)}},this.trackICEFailed=function(sid){_ga&&sid&&_lastICEFailedTracked!==sid&&(_ga.send("event",analytics_ICEFailed.category,analytics_ICEFailed.action,analytics_ICEFailed.label),_lastICEFailedTracked=sid)},this.trackICESuccess=function(sid){_ga&&sid&&_lastICESuccessTracked!==sid&&(_ga.send("event",analytics_ICESuccess.category,analytics_ICESuccess.action,analytics_ICESuccess.label),_lastICESuccessTracked=sid)},this.trackICENoSTUNCandidate=function(){_ga&&_ga.send("event",analytics_ICENoSTUNCandidate.category,analytics_ICENoSTUNCandidate.action,analytics_ICENoSTUNCandidate.label)},this.trackICETopology=function(topology){_ga&&_ga.send("event",analytics_ICETopology.category,analytics_ICETopology.action,topology)},this.trackGetUserMediaSuccess=function(){_ga&&_ga.send("event",analytics_GetUserMedia.category,analytics_GetUserMedia.action,analytics_GetUserMedia.label)},this.trackGetUserMediaErrorNoTrack=function(){_ga&&_ga.send("event",analytics_GetUserMediaErrorNoTrack.category,analytics_GetUserMediaErrorNoTrack.action,analytics_GetUserMediaErrorNoTrack.label)},this.trackGetUserMediaError=function(){_ga&&_ga.send("event",analytics_GetUserMediaError.category,analytics_GetUserMediaError.action,analytics_GetUserMediaError.label)},this.trackCodecsUsed=function(audioCodec,videoCodec){_ga&&_ga.send("event",analytics_CodecsUsed.category,analytics_CodecsUsed.action,audioCodec+"|"+videoCodec)},this.negotiationTime=function(){return _endNegotiationTime&&_startNegotiationTime?_endNegotiationTime<_startNegotiationTime?null:_endNegotiationTime-_startNegotiationTime:null},this.startNegotiationTime=function(time){_startNegotiationTime=time||(new Date).getTime(),_pendingComputation=!0},this.endNegotiationTime=function(time){_pendingComputation&&(_endNegotiationTime=time||(new Date).getTime(),_pendingComputation=!1)},this.trackNegotiationTime=function(){if(_ga){var duration=this.negotiationTime();duration&&_ga.send("event",analytics_NegotiationTime.category,analytics_NegotiationTime.action,analytics_NegotiationTime.label,duration),_endNegotiationTime=null,_startNegotiationTime=null}},this.resetProvider=function(){_ga=null},this.trackCallSuccessNumber=function(type){type&&type.length>0&&_ga&&_ga.send("event",analytics_NbSuccessCall.category,analytics_NbSuccessCall.action,type)},this.trackCallDuration=function(durationMs){if(_ga&&angular.isDefined(durationMs)&&durationMs>=0){var durationCategoryLabel="",durationInSeconds=Math.round(durationMs/1e3);durationCategoryLabel=durationInSeconds<15?"very_short_less_15s":durationInSeconds<30?"very_short_less_30s":durationInSeconds<60?"short_less_60s":durationInSeconds<120?"short_less_120s":durationInSeconds<300?"short_less_300s":durationInSeconds<600?"normal_less_600s":durationInSeconds<1200?"normal_less_1200s":durationInSeconds<1800?"normal_less_1800s":durationInSeconds<3600?"long_less_3600s":"long_more_3600s",_ga.send("event",analytics_CallsDuration.category,analytics_CallsDuration.action,durationCategoryLabel)}},this.trackDragAndDrop=function(type){_ga&&_ga.send("event",analytics_DragAndDrop.category,analytics_DragAndDrop.action,type)},this.inviteContactsFromProvider=function(provider,number){_ga&&_ga.send("event",analytics_InviteFromProvider.category,analytics_InviteFromProvider.action,provider,number)}}])},function(module,exports){angular.module("rainbow").service("countryService",["$http","$q","$log","$translate","authService",function($http,$q,$log,$translate,authService){"use strict";var service=this;service.datacenters=[{name:"France","alpha-3":"FRA","alpha-2":"FR",region:"Europe"},{name:"Germany","alpha-3":"DEU","alpha-2":"DE",region:"Europe"},{name:"Canada","alpha-3":"CAN","alpha-2":"CA",region:"America"},{name:"Singapore","alpha-3":"SGP","alpha-2":"SG",region:"Asia-Pacific"}],service.countries=[{name:"Australia","alpha-3":"AUS","country-code":"036","alpha-2":"AU"},{name:"Austria","alpha-3":"AUT","country-code":"040","alpha-2":"AT"},{name:"Belgium","alpha-3":"BEL","country-code":"056","alpha-2":"BE"},{name:"Brazil","alpha-3":"BRA","country-code":"076","alpha-2":"BR"},{name:"Canada","alpha-3":"CAN","country-code":"124","alpha-2":"CA"},{name:"China","alpha-3":"CHN","country-code":"156","alpha-2":"CN"},{name:"Czech Republic","alpha-3":"CZE","country-code":"203","alpha-2":"CZ"},{name:"Denmark","alpha-3":"DNK","country-code":"208","alpha-2":"DK"},{name:"Finland","alpha-3":"FIN","country-code":"246","alpha-2":"FI"},{name:"France","alpha-3":"FRA","country-code":"250",default:!0,"alpha-2":"FR"},{name:"Germany","alpha-3":"DEU","country-code":"276","alpha-2":"DE"},{name:"Hong Kong","alpha-3":"HKG","country-code":"344","alpha-2":"HK"},{name:"Ireland","alpha-3":"IRL","country-code":"372","alpha-2":"IE"},{name:"Israel","alpha-3":"ISR","country-code":"376","alpha-2":"IL"},{name:"Italy","alpha-3":"ITA","country-code":"380","alpha-2":"IT"},{name:"Mexico","alpha-3":"MEX","country-code":"484","alpha-2":"MX"},{name:"Netherlands","alpha-3":"NLD","country-code":"528","alpha-2":"NL"},{name:"Norway","alpha-3":"NOR","country-code":"578","alpha-2":"NO"},{name:"Poland","alpha-3":"POL","country-code":"616","alpha-2":"PL"},{name:"Portugal","alpha-3":"PRT","country-code":"620","alpha-2":"PT"},{name:"Russia","alpha-3":"RUS","country-code":"643","alpha-2":"RU"},{name:"South Africa","alpha-3":"ZAF","country-code":"710","alpha-2":"ZA"},{name:"South Korea","alpha-3":"KOR","country-code":"410","alpha-2":"KR"},{name:"Spain","alpha-3":"ESP","country-code":"724","alpha-2":"ES"},{name:"Sweden","alpha-3":"SWE","country-code":"752","alpha-2":"SE"},{name:"Switzerland","alpha-3":"CHE","country-code":"756","alpha-2":"CH"},{name:"Taiwan","alpha-3":"TWN","country-code":"158","alpha-2":"TW"},{name:"Turkey","alpha-3":"TUR","country-code":"792","alpha-2":"TR"},{name:"United Kingdom","alpha-3":"GBR","country-code":"826","alpha-2":"GB"},{name:"United States of America","alpha-3":"USA","country-code":"840","alpha-2":"US"},{name:"Afghanistan","alpha-3":"AFG","country-code":"004","alpha-2":"AF"},{name:"Albania","alpha-3":"ALB","country-code":"008","alpha-2":"AL"},{name:"Algeria","alpha-3":"DZA","country-code":"012","alpha-2":"DZ"},{name:"Andorra","alpha-3":"AND","country-code":"020","alpha-2":"AD"},{name:"Angola","alpha-3":"AGO","country-code":"024","alpha-2":"AO"},{name:"Anguilla","alpha-3":"AIA","country-code":"660","alpha-2":"AI"},{name:"Antigua and Barbuda","alpha-3":"ATG","country-code":"028","alpha-2":"AG"},{name:"Argentina","alpha-3":"ARG","country-code":"032","alpha-2":"AR"},{name:"Armenia","alpha-3":"ARM","country-code":"051","alpha-2":"AM"},{name:"Aruba","alpha-3":"ABW","country-code":"533","alpha-2":"AW"},{name:"Azerbaijan","alpha-3":"AZE","country-code":"031","alpha-2":"AZ"},{name:"Bahamas","alpha-3":"BHS","country-code":"044","alpha-2":"BS"},{name:"Bahrain","alpha-3":"BHR","country-code":"048","alpha-2":"BH"},{name:"Bangladesh","alpha-3":"BGD","country-code":"050","alpha-2":"BD"},{name:"Barbados","alpha-3":"BRB","country-code":"052","alpha-2":"BB"},{name:"Belarus","alpha-3":"BLR","country-code":"112","alpha-2":"BY"},{name:"Belize","alpha-3":"BLZ","country-code":"084","alpha-2":"BZ"},{name:"Benin","alpha-3":"BEN","country-code":"204","alpha-2":"BJ"},{name:"Bermuda","alpha-3":"BMU","country-code":"060","alpha-2":"BM"},{name:"Bhutan","alpha-3":"BTN","country-code":"064","alpha-2":"BT"},{name:"Bolivia","alpha-3":"BOL","country-code":"068","alpha-2":"BO"},{name:"Bosnia and Herzegovina","alpha-3":"BIH","country-code":"070","alpha-2":"BA"},{name:"Botswana","alpha-3":"BWA","country-code":"072","alpha-2":"BW"},{name:"British Virgin Islands","alpha-3":"VGB","country-code":"092","alpha-2":"VG"},{name:"Brunei Darussalam","alpha-3":"BRN","country-code":"096","alpha-2":"BN"},{name:"Bulgaria","alpha-3":"BGR","country-code":"100","alpha-2":"BG"},{name:"Burkina Faso","alpha-3":"BFA","country-code":"854","alpha-2":"BF"},{name:"Burundi","alpha-3":"BDI","country-code":"108","alpha-2":"BI"},{name:"Cambodia","alpha-3":"KHM","country-code":"116","alpha-2":"KH"},{name:"Cameroon","alpha-3":"CMR","country-code":"120","alpha-2":"CM"},{name:"Cape Verde","alpha-3":"CPV","country-code":"132","alpha-2":"CV"},{name:"Cayman Islands","alpha-3":"CYM","country-code":"136","alpha-2":"KY"},{name:"Central African Republic","alpha-3":"CAF","country-code":"140","alpha-2":"CF"},{name:"Chad","alpha-3":"TCD","country-code":"148","alpha-2":"TD"},{name:"Chile","alpha-3":"CHL","country-code":"152","alpha-2":"CL"},{name:"Colombia","alpha-3":"COL","country-code":"170","alpha-2":"CO"},{name:"Comoros","alpha-3":"COM","country-code":"174","alpha-2":"KM"},{name:"Congo","alpha-3":"COG","country-code":"178","alpha-2":"CG"},{name:"Congo, Democratic Republic of","alpha-3":"COD","country-code":"180","alpha-2":"CD"},{name:"Costa Rica","alpha-3":"CRI","country-code":"188","alpha-2":"CR"},{name:"Ivory Coast","alpha-3":"CIV","country-code":"384","alpha-2":"CI"},{name:"Croatia","alpha-3":"HRV","country-code":"191","alpha-2":"HR"},{name:"Cyprus","alpha-3":"CYP","country-code":"196","alpha-2":"CY"},{name:"Djibouti","alpha-3":"DJI","country-code":"262","alpha-2":"DJ"},{name:"Dominica","alpha-3":"DMA","country-code":"212","alpha-2":"DM"},{name:"Dominican Republic","alpha-3":"DOM","country-code":"214","alpha-2":"DO"},{name:"Ecuador","alpha-3":"ECU","country-code":"218","alpha-2":"EC"},{name:"El Salvador","alpha-3":"SLV","country-code":"222","alpha-2":"SV"},{name:"Egypt","alpha-3":"EGY","country-code":"818","alpha-2":"EG"},{name:"Eritrea","alpha-3":"ERI","country-code":"232","alpha-2":"ER"},{name:"Estonia","alpha-3":"EST","country-code":"233","alpha-2":"EE"},{name:"Ethiopia","alpha-3":"ETH","country-code":"231","alpha-2":"ET"},{name:"Fiji","alpha-3":"FJI","country-code":"242","alpha-2":"FJ"},{name:"French Guiana","alpha-3":"GUF","country-code":"254","alpha-2":"GF"},{name:"French Polynesia","alpha-3":"PYF","country-code":"258","alpha-2":"PF"},{name:"Gabon","alpha-3":"GAB","country-code":"266","alpha-2":"GA"},{name:"Gambia","alpha-3":"GMB","country-code":"270","alpha-2":"GM"},{name:"Georgia","alpha-3":"GEO","country-code":"268","alpha-2":"GE"},{name:"Ghana","alpha-3":"GHA","country-code":"288","alpha-2":"GH"},{name:"Greece","alpha-3":"GRC","country-code":"300","alpha-2":"GR"},{name:"Grenada","alpha-3":"GRD","country-code":"308","alpha-2":"GD"},{name:"Guadeloupe","alpha-3":"GLP","country-code":"312","alpha-2":"GP"},{name:"Guatemala","alpha-3":"GTM","country-code":"320","alpha-2":"GT"},{name:"Guinea","alpha-3":"GIN","country-code":"324","alpha-2":"GN"},{name:"Guyana","alpha-3":"GUY","country-code":"328","alpha-2":"GY"},{name:"Haiti","alpha-3":"HTI","country-code":"332","alpha-2":"HT"},{name:"Honduras","alpha-3":"HND","country-code":"340","alpha-2":"HN"},{name:"Hungary","alpha-3":"HUN","country-code":"348","alpha-2":"HU"},{name:"Iceland","alpha-3":"ISL","country-code":"352","alpha-2":"IS"},{name:"India","alpha-3":"IND","country-code":"356","alpha-2":"IN"},{name:"Indonesia","alpha-3":"IDN","country-code":"360","alpha-2":"ID"},{name:"Iraq","alpha-3":"IRQ","country-code":"368","alpha-2":"IQ"},{name:"Jamaica","alpha-3":"JAM","country-code":"388","alpha-2":"JM"},{name:"Japan","alpha-3":"JPN","country-code":"392","alpha-2":"JP"},{name:"Jordan","alpha-3":"JOR","country-code":"400","alpha-2":"JO"},{name:"Kazakhstan","alpha-3":"KAZ","country-code":"398","alpha-2":"KZ"},{name:"Kenya","alpha-3":"KEN","country-code":"404","alpha-2":"KE"},{name:"Kuwait","alpha-3":"KWT","country-code":"414","alpha-2":"KW"},{name:"Kyrgyzstan","alpha-3":"KGZ","country-code":"417","alpha-2":"KG"},{name:"Latvia","alpha-3":"LVA","country-code":"428","alpha-2":"LV"},{name:"Lebanon","alpha-3":"LBN","country-code":"422","alpha-2":"LB"},{name:"Lesotho","alpha-3":"LSO","country-code":"426","alpha-2":"LS"},{name:"Liberia","alpha-3":"LBR","country-code":"430","alpha-2":"LR"},{name:"Libya","alpha-3":"LBY","country-code":"434","alpha-2":"LY"},{name:"Liechtenstein","alpha-3":"LIE","country-code":"438","alpha-2":"LI"},{name:"Lithuania","alpha-3":"LTU","country-code":"440","alpha-2":"LT"},{name:"Luxembourg","alpha-3":"LUX","country-code":"442","alpha-2":"LU"},{name:"Macao","alpha-3":"MAC","country-code":"446","alpha-2":"MO"},{name:"Macedonia","alpha-3":"MKD","country-code":"807","alpha-2":"MK"},{name:"Madagascar","alpha-3":"MDG","country-code":"450","alpha-2":"MG"},{name:"Malawi","alpha-3":"MWI","country-code":"454","alpha-2":"MW"},{name:"Malaysia","alpha-3":"MYS","country-code":"458","alpha-2":"MY"},{name:"Maldives","alpha-3":"MDV","country-code":"462","alpha-2":"MV"},{name:"Mali","alpha-3":"MLI","country-code":"466","alpha-2":"ML"},{name:"Malta","alpha-3":"MLT","country-code":"470","alpha-2":"MT"},{name:"Mauritius","alpha-3":"MUS","country-code":"480","alpha-2":"MU"},{name:"Mayotte","alpha-3":"MYT","country-code":"175","alpha-2":"YT"},{name:"Moldova","alpha-3":"MDA","country-code":"498","alpha-2":"MD"},{name:"Monaco","alpha-3":"MCO","country-code":"492","alpha-2":"MC"},{name:"Mongolia","alpha-3":"MNG","country-code":"496","alpha-2":"MN"},{name:"Montenegro","alpha-3":"MNE","country-code":"499","alpha-2":"ME"},{name:"Montserrat","alpha-3":"MSR","country-code":"500","alpha-2":"MS"},{name:"Morocco","alpha-3":"MAR","country-code":"504","alpha-2":"MA"},{name:"Mozambique","alpha-3":"MOZ","country-code":"508","alpha-2":"MZ"},{name:"Myanmar","alpha-3":"MMR","country-code":"104","alpha-2":"MM"},{name:"Namibia","alpha-3":"NAM","country-code":"516","alpha-2":"NA"},{name:"Nepal","alpha-3":"NPL","country-code":"524","alpha-2":"NP"},{name:"New Zealand","alpha-3":"NZL","country-code":"554","alpha-2":"NZ"},{name:"Nicaragua","alpha-3":"NIC","country-code":"558","alpha-2":"NI"},{name:"Niger","alpha-3":"NER","country-code":"562","alpha-2":"NE"},{name:"Nigeria","alpha-3":"NGA","country-code":"566","alpha-2":"NG"},{name:"Oman","alpha-3":"OMN","country-code":"512","alpha-2":"OM"},{name:"Pakistan","alpha-3":"PAK","country-code":"586","alpha-2":"PK"},{name:"Palestine","alpha-3":"PSE","country-code":"275","alpha-2":"PS"},{name:"Panama","alpha-3":"PAN","country-code":"591","alpha-2":"PA"},{name:"Paraguay","alpha-3":"PRY","country-code":"600","alpha-2":"PY"},{name:"Peru","alpha-3":"PER","country-code":"604","alpha-2":"PE"},{name:"Philippines","alpha-3":"PHL","country-code":"608","alpha-2":"PH"},{name:"Puerto Rico","alpha-3":"PRI","country-code":"630","alpha-2":"PR"},{name:"Qatar","alpha-3":"QAT","country-code":"634","alpha-2":"QA"},{name:"Romania","alpha-3":"ROU","country-code":"642","alpha-2":"RO"},{name:"Rwanda","alpha-3":"RWA","country-code":"646","alpha-2":"RW"},{name:"Saint Kitts and Nevis","alpha-3":"KNA","country-code":"659","alpha-2":"KN"},{name:"Saint Lucia","alpha-3":"LCA","country-code":"662","alpha-2":"LC"},{name:"Saint Vincent and the Grenadines","alpha-3":"VCT","country-code":"670","alpha-2":"VC"},{name:"Saudi Arabia","alpha-3":"SAU","country-code":"682","alpha-2":"SA"},{name:"Senegal","alpha-3":"SEN","country-code":"686","alpha-2":"SN"},{name:"Serbia","alpha-3":"SRB","country-code":"688","alpha-2":"RS"},{name:"Sierra Leone","alpha-3":"SLE","country-code":"694","alpha-2":"SL"},{name:"Singapore","alpha-3":"SGP","country-code":"702","alpha-2":"SG"},{name:"Slovakia","alpha-3":"SVK","country-code":"703","alpha-2":"SK"},{name:"Slovenia","alpha-3":"SVN","country-code":"705","alpha-2":"SI"},{name:"South Sudan","alpha-3":"SSD","country-code":"728","alpha-2":"SS"},{name:"Sri Lanka","alpha-3":"LKA","country-code":"144","alpha-2":"LK"},{name:"Sudan","alpha-3":"SDN","country-code":"729","alpha-2":"SD"},{name:"Swaziland","alpha-3":"SWZ","country-code":"748","alpha-2":"SZ"},{name:"Tajikistan","alpha-3":"TJK","country-code":"762","alpha-2":"TJ"},{name:"Tanzania","alpha-3":"TZA","country-code":"834","alpha-2":"TZ"},{name:"Thailand","alpha-3":"THA","country-code":"764","alpha-2":"TH"},{name:"Togo","alpha-3":"TGO","country-code":"768","alpha-2":"TG"},{name:"Trinidad and Tobago","alpha-3":"TTO","country-code":"780","alpha-2":"TT"},{name:"Tunisia","alpha-3":"TUN","country-code":"788","alpha-2":"TN"},{name:"Turkmenistan","alpha-3":"TKM","country-code":"795","alpha-2":"TM"},{name:"Turks and Caicos Islands","alpha-3":"TCA","country-code":"796","alpha-2":"TC"},{name:"Uganda","alpha-3":"UGA","country-code":"800","alpha-2":"UG"},{name:"Ukraine","alpha-3":"UKR","country-code":"804","alpha-2":"UA"},{name:"United Arab Emirates","alpha-3":"ARE","country-code":"784","alpha-2":"AE"},{name:"Virgin Islands, US","alpha-3":"VIR","country-code":"850","alpha-2":"VI"},{name:"Uruguay","alpha-3":"URY","country-code":"858","alpha-2":"UY"},{name:"Uzbekistan","alpha-3":"UZB","country-code":"860","alpha-2":"UZ"},{name:"Venezuela","alpha-3":"VEN","country-code":"862","alpha-2":"VE"},{name:"Vietnam","alpha-3":"VNM","country-code":"704","alpha-2":"VN"},{name:"Zambia","alpha-3":"ZMB","country-code":"894","alpha-2":"ZM"},{name:"Zimbabwe","alpha-3":"ZWE","country-code":"716","alpha-2":"ZW"}],service.statesOfCanada={AB:"Alberta",BC:"British Columbia",MB:"Manitoba",NB:"New Brunswick",NL:"Newfoundland and Labrador",NS:"Nova Scotia",NT:"Northwest Territories",NU:"Nunavut",ON:"Ontario",PE:"Prince Edward Island",QC:"Quebec",SK:"Saskatchewan",YT:"Yukon"},service.statesOfAmerica={AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",AA:"Armed Forces America",AE:"Armed Forces",AP:"Armed Forces Pacific",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",FL:"Florida",GA:"Georgia",GU:"Guam",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",PR:"Puerto Rico",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VI:"Virgin Islands",VA:"Virginia",WA:"Washington",DC:"Washington DC",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming"},service.countryToLanguageMapping={ad:"ca",ae:"ar",af:"fa,ps",ag:"en",ai:"en",al:"sq",am:"hy",an:"nl,en",ao:"pt",ar:"es",as:"en,sm",at:"de",au:"en",aw:"nl,pap",ax:"sv",ba:"bs,hr,sr",bb:"en",bd:"bn",be:"nl,fr,de",bf:"fr",bh:"ar",bi:"fr",bj:"fr",bl:"fr",bm:"en",bn:"ms",bo:"es,qu,ay",br:"pt",bs:"en",bt:"dz",bv:"no",bw:"en,tn",by:"be,ru",bz:"en",ca:"en,fr",cc:"en",cd:"fr",cf:"fr",cg:"fr",ch:"de,fr,it,rm",ci:"fr",ck:"en,rar",cl:"es",cm:"fr,en",cn:"zh",co:"es",cr:"es",cu:"es",cv:"pt",cx:"en",cy:"el,tr",cz:"cs","// de":"de",dj:"fr,ar,so",dk:"da",dm:"en",do:"es",dz:"ar",ec:"es",ee:"et",eg:"ar",eh:"ar,es,fr",er:"ti,ar,en",es:"ast,ca,es,eu,gl",et:"am,om",fi:"fi,sv,se",fj:"en",fk:"en",fm:"en",ga:"fr",gb:"en,ga,cy,gd,kw",gd:"en",ge:"ka",gf:"fr",gg:"en",gh:"en",gi:"en",gl:"kl,da",gm:"en",gn:"fr",gp:"fr",gq:"es,fr,pt",gr:"el",gs:"en",gt:"es",gu:"en,ch",gw:"pt",gy:"en",hk:"zh,en",hm:"en",hn:"es",ht:"fr,ht",ie:"en,ga",il:"he",im:"en",in:"hi,en",io:"en",iq:"ar,ku",ir:"fa",it:"it,de,fr",je:"en",jm:"en",jo:"ar",jp:"ja",ke:"sw,en",kg:"ky,ru",kh:"km",ki:"en",km:"ar,fr",kn:"en",kp:"ko",kr:"ko,en",kw:"ar",ky:"en",kz:"kk,ru",la:"lo",lb:"ar,fr",lc:"en",li:"de",lk:"si,ta",lr:"en",ls:"en,st",lu:"lb,fr,de",ly:"ar",ma:"ar",mc:"fr",md:"ru,uk,ro",me:"srp,sq,bs,hr,sr",mf:"fr",mg:"mg,fr",mh:"en,mh",ml:"fr",mm:"my",mo:"zh,pt",mp:"ch",mq:"fr",mr:"ar,fr",ms:"en",mt:"mt,en",mu:"mfe,fr,en",mv:"dv",mw:"en,ny",mx:"es",my:"ms",mz:"pt",na:"en,sf,de",nc:"fr",ne:"fr",nf:"en,pih",ng:"en",ni:"es",no:"nb,nn,no,se",np:"ne",nr:"na,en",nu:"niu,en",nz:"mi,en",om:"ar",pa:"es",pe:"es",pf:"fr",pg:"en,tpi,ho",ph:"en,tl",pk:"en,ur",pm:"fr",pn:"en,pih",pr:"es,en",ps:"ar,he",pw:"en,pau,ja,sov,tox",py:"es,gn",qa:"ar",re:"fr",rs:"sr",rw:"rw,fr,en",sa:"ar",sb:"en",sc:"fr,en,crs",sd:"ar,en",se:"sv",sg:"en,ms,zh,ta",sh:"en",si:"sl",sj:"no",sl:"en",sm:"it",sn:"fr",so:"so,ar",sr:"nl",st:"pt",ss:"en",sv:"es",sy:"ar",sz:"en,ss",tc:"en",td:"fr,ar",tf:"fr",tg:"fr",tj:"tg,ru",tk:"tkl,en,sm",tl:"pt,tet",tm:"tk",tn:"ar",to:"en",tt:"en",tv:"en",tw:"zh",tz:"sw,en",ua:"uk",ug:"en,sw",um:"en",us:"en",uy:"es",uz:"uz,kaa",va:"it",vc:"en",ve:"es",vg:"en",vi:"en",vn:"vi",vu:"bi,en,fr",wf:"fr",ws:"sm,en",ye:"ar",yt:"fr",za:"zu,xh,af,st,tn,en",zm:"en",zw:"en,sn,nd "},service.init=function(){this.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/"},service.start=function(stats){$log.info(""),$log.info("[countryService] === STARTING ===");var startDate=performance.now();return $q((function(resolve,__reject){service.init(),service.getAvailableCountries().then((function(availableCountries){service.countries=availableCountries.map((function(country){var entry={name:country.fullname,"alpha-3":country.isoAlpha3Code,"alpha-2":country.isoAlpha2Code};return"FRA"===country.isoAlpha3Code&&(entry.default=!0),entry}))})).catch((function(error){$log.info("[countryService] === warning === "+error.message)})).finally((function(){var startDuration=Math.round(performance.now()-startDate);stats.push({service:"countryService",startDuration:startDuration}),$log.info("[countryService] === STARTED ("+startDuration+" ms) === "+service.countries.length+" countries"),$log.info(""),resolve()}))}))},service.stop=function(){$log.info("[countryService] STOPPED")},service.getAvailableCountries=function(){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"countries",headers:authService.getRequestHeader()}).then((function(response){resolve(response.data.data)})).catch((function(response){var errorMessage=response.data?response.data.errorDetails||response.data.errorMsg:response.message;$log.error("[countryService] getAvailableCountries failure -- "+errorMessage+" - status "+response.status),reject(new Error(errorMessage))}))}))},service.getCountries=function(){var countries=service.countries.map(service.translateCountryName);return countries.sort(service.sortByCountryName),countries},service.sortByCountryName=function(country1,country2){return country1.name.localeCompare(country2.name,$translate.use())},service.translateCountryName=function(country){var label=service.getCountryLabel(country["alpha-2"]);if(label){var name=$translate.instant(label);name&&name!==label&&(country.name=name)}return country},service.getCountryStates=function(country){return country&&"USA"===country["alpha-3"]?service.statesOfAmerica:country&&"CAN"===country["alpha-3"]?service.statesOfCanada:{}},service.getCountry=function(countryCode,defaulted){if(!countryCode)return defaulted?service.getDefaultCountry():null;var countries=service.countries.filter((function(country){return country["alpha-3"]===countryCode}));return countries.length>0?countries[0]:null},service.getDefaultCountry=function(){var countries=service.countries.filter((function(country){return!0===country.default}));return countries.length>0?countries[0]:service.countries[0]},service.getCountryName=function(countryCode){return service.getCountry(countryCode)?service.getCountry(countryCode).name:null},service.getCountryCode=function(country){return country?country["alpha-3"]:null},service.getStateName=function(country,state){return country&&state?"USA"===country?service.statesOfAmerica[state]:"CAN"===country?service.statesOfCanada[state]:void 0:""},service.getDefaultState=function(country){return country&&"USA"===country["alpha-3"]?"AL":country&&"CAN"===country["alpha-3"]?"AB":null},service.getAlpha2Code=function(alpha3Code){if(!alpha3Code)return null;var countries=service.countries.filter((function(country){return country["alpha-3"]===alpha3Code}));return countries.length>0?countries[0]["alpha-2"]:null},service.getCountryLabel=function(alphaCode){if(3===alphaCode.length)var alpha2Code=service.getAlpha2Code(alphaCode);else alpha2Code=alphaCode;return alpha2Code?"country"+alpha2Code:null},service.getDataCenterLabel=function(datacenterLocation,companyCountry){var label=service.getRegionLabel(datacenterLocation.name);if(datacenterLocation.country===companyCountry)label=service.getCountryLabel(datacenterLocation.country);else{var datacenter=service.datacenters.find((function(dc){return dc["alpha-3"]===datacenterLocation.country}));datacenter&&(label=service.getRegionLabel(datacenter.region))}return label},service.getRegionLabel=function(regionName){return regionName},service.mapCountryToLanguages=function(countryAlpha2Code){if(countryAlpha2Code){var countryCode=countryAlpha2Code.toLowerCase();return void 0!==service.countryToLanguageMapping[countryCode]?service.countryToLanguageMapping[countryCode].split(","):[countryCode]}}}]),angular.module("rainbow").filter("countryFilter",["countryService",function(countryService){"use strict";return function(input){return countryService.getCountryName(input)}}])},function(module,exports){angular.module("rainbow").service("usersService",["$q","$log","$rootScope","contactService",function($q,$log,$rootScope,contactService){"use strict";var that=this,listeners=[];this.started=!1,this.start=function(stats){$log.info("[usersService] === STARTING ==="),that.started=!0;var startDate=performance.now();$log.info("[usersService] start"),that.contactsInRoster=that.getAllRosterContacts(),that.lastNameList=that.orderContacts("lastname"),that.firstNameList=that.orderContacts("firstname"),that.companyNameList=that.orderContacts("company"),listeners.push($rootScope.$on("ON_CONTACT_ROSTER_UPDATE_EVENT",that.onContactUpdatedEvent));var startDuration=Math.round(performance.now()-startDate);return stats.push({service:"usersService",startDuration:startDuration}),$log.info("[usersService] === STARTED ("+startDuration+" ms) ==="),$q.when()},this.stop=function(){var listener;for($log.info("[usersService] === STOPPING ==="),that.started&&(that.started=!1);listener=listeners.pop();)listener();return $log.info("[usersService] === STOPPED ==="),$q.when()},this.onContactUpdatedEvent=function(){$log.info("[usersService] onContactUpdatedEvent");var newRosterList=that.getAllRosterContacts();newRosterList.length-that.contactsInRoster.length!=0&&($log.info("[usersService] onContactUpdatedEvent - update all user lists"),that.contactsInRoster=newRosterList,that.lastNameList=that.orderContacts("lastname"),that.firstNameList=that.orderContacts("firstname"),that.companyNameList=that.orderContacts("company"),$rootScope.$broadcast("ON_USER_SERVICE_ROSTER_UPDATE_EVENT"))},this.getLastNameList=function(){return that.lastNameList},this.getFirstNameList=function(){return that.firstNameList},this.getCompanyNameList=function(){return that.companyNameList},this.getAllRosterContacts=function(){return contactService.getContacts().filter((function(contact){return contact.displayName&&contact.roster}))},this.addSeparators=function(users,sortByMember){var result=[],label="",paramExtractor=null;return paramExtractor="company"!==sortByMember?function(user){return user[sortByMember].charAt(0)}:function(user){return user.company.name},users.forEach((function(user){var sortString=paramExtractor(user).toUpperCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"");label!==sortString&&(label=sortString,result.push({value:label,type:"separator",id:label})),result.push(user)})),result},this.orderContacts=function(criteria){var orderedUsers=that.getOrderedUsers(that.contactsInRoster,criteria);return that.addSeparators(orderedUsers,criteria)},this.getFilterAndOrderUsersGroupedByOrderLabel=function(users,orderType,filterType,isGroup){isGroup=Boolean(!0&isGroup);var listOrderUsers=that.getFilterAndOrderUsers(users,orderType,filterType,isGroup);return"firstname"===orderType?that.addSeparators(listOrderUsers,"firstname"):"company"===orderType?that.addSeparators(listOrderUsers,"company"):that.addSeparators(listOrderUsers,"lastname")},this.getFilterAndOrderUsersGroupedByOrderLabelAndUpdateActivity=function(users,orderType,filterType,isGroup){isGroup=Boolean(!0&isGroup);var listOrderUsers=that.getFilterAndOrderUsers(users,orderType,filterType,isGroup);return"firstname"===orderType?that.addSeparators(listOrderUsers,"firstname"):"company"===orderType?that.addSeparators(listOrderUsers,"company"):that.addSeparators(listOrderUsers,"lastname")},this.getFilterAndOrderUsers=function(users,orderType,filterType,isGroup){var listFilteredUsers=that.getFilteredUsers(users,filterType,isGroup);return that.getOrderedUsers(listFilteredUsers,orderType)},this.getFilteredUsers=function(contactList,filter,isGroup){var contacts;return contacts=(contacts=contactList.filter((function(contact){if("separator"===contact.type)return!0;var isExistingContact=contact.displayName&&contact.roster||isGroup,isContactOnline="offline"!==contact.status&&"wait"!==contact.status&&"xa"!==contact.status&&"unknown"!==contact.status,isContactPending="wait"===contact.status,isContactTerminated=contact.isTerminated;return"online"===filter?isExistingContact&&isContactOnline:"offline"===filter?isExistingContact&&!isContactOnline&&!isContactTerminated:"pending"===filter?isExistingContact&&isContactPending:"all"===filter?isExistingContact&&!isContactTerminated:isExistingContact}))).filter((function(contact,index){return!!("separator"!==contact.type||contacts[index+1]&&"separator"!==contacts[index+1].type)}))},this.getOrderedUsers=function(contactList,orderType){return contactList.sort((function(aa,bb){var sortName;if("lastname"===orderType)return 0===(sortName=aa.lastname.localeCompare(bb.lastname))?aa.firstname.localeCompare(bb.firstname):sortName;if("firstname"===orderType)return 0===(sortName=aa.firstname.localeCompare(bb.firstname))?aa.lastname.localeCompare(bb.lastname):sortName;if("company"===orderType){var sortCompany=aa.company.name.localeCompare(bb.company.name);return 0===sortCompany?aa.lastname.localeCompare(bb.lastname):sortCompany}return 0}))}}])},function(module,exports){angular.module("rainbow").service("utilService",["$log",function($log){"use strict";var defaultDiacriticsRemovalMap=[{base:"A",letters:/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},{base:"AA",letters:/[\uA732]/g},{base:"AE",letters:/[\u00C6\u01FC\u01E2]/g},{base:"AO",letters:/[\uA734]/g},{base:"AU",letters:/[\uA736]/g},{base:"AV",letters:/[\uA738\uA73A]/g},{base:"AY",letters:/[\uA73C]/g},{base:"B",letters:/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},{base:"C",letters:/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},{base:"D",letters:/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},{base:"DZ",letters:/[\u01F1\u01C4]/g},{base:"Dz",letters:/[\u01F2\u01C5]/g},{base:"E",letters:/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},{base:"F",letters:/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},{base:"G",letters:/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},{base:"H",letters:/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},{base:"I",letters:/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},{base:"J",letters:/[\u004A\u24BF\uFF2A\u0134\u0248]/g},{base:"K",letters:/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},{base:"L",letters:/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},{base:"LJ",letters:/[\u01C7]/g},{base:"Lj",letters:/[\u01C8]/g},{base:"M",letters:/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},{base:"N",letters:/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},{base:"NJ",letters:/[\u01CA]/g},{base:"Nj",letters:/[\u01CB]/g},{base:"O",letters:/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},{base:"OI",letters:/[\u01A2]/g},{base:"OO",letters:/[\uA74E]/g},{base:"OU",letters:/[\u0222]/g},{base:"P",letters:/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},{base:"Q",letters:/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},{base:"R",letters:/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},{base:"S",letters:/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},{base:"T",letters:/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},{base:"TZ",letters:/[\uA728]/g},{base:"U",letters:/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},{base:"V",letters:/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},{base:"VY",letters:/[\uA760]/g},{base:"W",letters:/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},{base:"X",letters:/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},{base:"Y",letters:/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},{base:"Z",letters:/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},{base:"a",letters:/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g},{base:"aa",letters:/[\uA733]/g},{base:"ae",letters:/[\u00E6\u01FD\u01E3]/g},{base:"ao",letters:/[\uA735]/g},{base:"au",letters:/[\uA737]/g},{base:"av",letters:/[\uA739\uA73B]/g},{base:"ay",letters:/[\uA73D]/g},{base:"b",letters:/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},{base:"c",letters:/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},{base:"d",letters:/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},{base:"dz",letters:/[\u01F3\u01C6]/g},{base:"e",letters:/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},{base:"f",letters:/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},{base:"g",letters:/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},{base:"h",letters:/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},{base:"hv",letters:/[\u0195]/g},{base:"i",letters:/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},{base:"j",letters:/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},{base:"k",letters:/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},{base:"l",letters:/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},{base:"lj",letters:/[\u01C9]/g},{base:"m",letters:/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},{base:"n",letters:/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},{base:"nj",letters:/[\u01CC]/g},{base:"o",letters:/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},{base:"oi",letters:/[\u01A3]/g},{base:"ou",letters:/[\u0223]/g},{base:"oo",letters:/[\uA74F]/g},{base:"p",letters:/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},{base:"q",letters:/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},{base:"r",letters:/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},{base:"s",letters:/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},{base:"t",letters:/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},{base:"tz",letters:/[\uA729]/g},{base:"u",letters:/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},{base:"v",letters:/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},{base:"vy",letters:/[\uA761]/g},{base:"w",letters:/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},{base:"x",letters:/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},{base:"y",letters:/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},{base:"z",letters:/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}];this.removeDiacritis=function(str){for(var i=0;i<defaultDiacriticsRemovalMap.length;i++)str=str.replace(defaultDiacriticsRemovalMap[i].letters,defaultDiacriticsRemovalMap[i].base);return str},this.escapeHtml=function(unsafe){return unsafe.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},this.extractHtmlContent=function(html){var parser=new DOMParser,content="{}";try{content=parser.parseFromString(html,"text/html").documentElement.textContent}catch(e){$log.error("[utilService] error in extractHtmlContent:",e),content="{}"}return content},this.sortAlphaNum=function(nameA,nameB){var reA=/[^a-zA-Z]/g,reN=/[^0-9]/g,aA=nameA.replace(reA,""),bA=nameB.replace(reA,"");if(aA===bA){var aN=parseInt(nameA.replace(reN,""),10),bN=parseInt(nameB.replace(reN,""),10);return aN===bN?0:aN>bN?1:-1}return aA>bA?1:-1},this.anonymizePhoneNumber=function(number){if(null==number)return null;if(config&&config.debug)return number;var result="";return 0===number.indexOf("+")&&(result="+"),result=number.length>4?result+"*".repeat(number.length-4-result.length)+number.slice(number.length-4):number},this.anonymizeString=function(inputString){if(null==inputString)return null;if(config&&config.debug)return inputString;var result="";return result=inputString.length>4?result+"*".repeat(inputString.length-4-result.length)+inputString.slice(inputString.length-4):inputString},this.bytesToSize=function(bytes){if(0==bytes)return"0 Byte";var i=parseInt(Math.floor(Math.log(bytes)/Math.log(1024)));return Math.round(bytes/Math.pow(1024,i),2)+" "+["Bytes","KB","MB","GB","TB"][i]}}])},function(module,exports){},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const crypto_js_1=__webpack_require__(3),crypto_js_2=__webpack_require__(3);class LocalImage{constructor(fd,blob){blob&&(this.url=URL.createObjectURL(blob)),this.fd=fd}release(){URL.revokeObjectURL(this.url)}}class FileServerService{constructor($q,$http,$log,authService,fileStorageService,TransfertPromiseQueue,FileDescriptorEventHandler,xmppService,errorHelperService,$rootScope,$interval){this.$q=$q,this.$http=$http,this.$log=$log,this.authService=authService,this.fileStorageService=fileStorageService,this.TransfertPromiseQueue=TransfertPromiseQueue,this.FileDescriptorEventHandler=FileDescriptorEventHandler,this.xmppService=xmppService,this.errorHelperService=errorHelperService,this.$rootScope=$rootScope,this.$interval=$interval,this.ONE_KILOBYTE=1024,this.ONE_MEGABYTE=1048576,this.ONE_GIGABYTE=1073741824,this.started=!1,this.thumbnailPromises=[]}start(stats){this.$log.info("[FileServerService] === STARTING ===");let startDate=performance.now();return this.started=!1,this.portalURL=config.restServerUrl+"/api/rainbow/fileserver/v1.0/files",this.getServercapabilities().then(()=>{this.attachHandlers(),this.transfertPromiseQueue=this.TransfertPromiseQueue.create();var startDuration=Math.round(performance.now()-startDate);stats.push({service:"FileServerService",startDuration:startDuration}),this.$log.info("[FileServerService] === STARTED ("+startDuration+" ms) ===")}).catch(error=>{this.$log.error("[FileServerService] === STARTING FAILURE === "+error.message)}),this.$q.when()}stop(){return this.$log.info("[FileServerService] === STOPPING ==="),this.started&&(this.started=!1),this.$log.info("[FileServerService] === STOPPED ==="),this.$q.when()}attachHandlers(){this.removeHandlers(),this.fileDescriptorEventHandler=this.FileDescriptorEventHandler.create(this),this.fileMessageHandlerRef||(this.fileMessageHandlerRef=this.xmppService.addHandler(stanza=>(this.$interval(()=>{this.fileDescriptorEventHandler.onManagementMessageReceived(stanza)},250,1),!0),null,"message","management"))}removeHandlers(){this.fileDescriptorEventHandler=void 0,this.fileMessageHandlerRef=void 0}getLocalImage(fileDescriptorId,thumbnail,forced=!0){return this.$q((resolve,reject)=>{let fileDescriptor=this.fileStorageService.getFileDescriptorById(fileDescriptorId);(fileDescriptor?this.$q.resolve(fileDescriptor):this.fileStorageService.retrieveAndStoreOneFileDescriptor(fileDescriptorId)).then(aFileDescriptor=>{let fileLoader=null;(fileLoader=thumbnail&&aFileDescriptor.previewBlob&&!forced?this.$q.resolve(aFileDescriptor.previewBlob):thumbnail?this.getLargeBlobThumbnail(aFileDescriptor):this.getBlobFromFileDescriptor(aFileDescriptor,!1,null)).then(blob=>{resolve(new LocalImage(aFileDescriptor,blob))})}).catch(error=>{new LocalImage(null,null).url="/resources/skins/rainbow/images/wizard/chrome.png",this.$log.error(`[fileServerService] getFileLocalURL -- no file descriptor found with ${fileDescriptorId} + " id.`),resolve(null)})})}getLargeBlobThumbnail(fileDescriptor){let url=fileDescriptor.url+"?thumbnail500=true";return this.getBlobFromUrl(url,fileDescriptor.typeMIME,fileDescriptor.size,fileDescriptor.fileName)}getPartialDataFromServer(url,minRange,maxRange,index){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:url,headers:this.authService.getRequestHeaderWithRange("bytes="+minRange+"-"+maxRange),responseType:"arraybuffer"}).then(response=>{resolve({data:response.data,index:index})},errorResponse=>{let error=this.errorHelperService.handleError(errorResponse),errorDataObj=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(errorResponse.data))),translatedErrorMessage=this.errorHelperService.getLocalizedError(errorDataObj.errorDetailsCode);this.$log.error(translatedErrorMessage),reject(error)})})}getFileStorageService(){return this.fileStorageService}getBlobThumbnailFromFileDescriptor(fileDescriptor,large=!1){if(fileDescriptor.thumbnail.isThumbnailAvailable()||fileDescriptor.isImage()&&fileDescriptor.size<20*this.ONE_KILOBYTE){var existingPromise=this.thumbnailPromises[fileDescriptor.id];if(existingPromise)return this.$log.info("[FileServerService] getBlobThumbnailFromFileDescriptor "+fileDescriptor.id+" already lauched"),existingPromise.promise;var defered=this.$q.defer();this.thumbnailPromises[fileDescriptor.id]=defered;let url=fileDescriptor.url;return fileDescriptor.thumbnail.isThumbnailAvailable()&&(fileDescriptor.size>=20*this.ONE_KILOBYTE||fileDescriptor.isPDF())?url+="?thumbnail500=true":fileDescriptor.uploadedDate&&(url+="?update="+crypto_js_1.MD5(crypto_js_2.enc.Latin1.parse(fileDescriptor.uploadedDate)).toString(crypto_js_2.enc.Hex)),this.getBlobFromUrl(url,fileDescriptor.typeMIME,fileDescriptor.size,fileDescriptor.fileName).then(blob=>{fileDescriptor.previewBlob=blob,this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"download",fileDesc:fileDescriptor}),this.thumbnailPromises[fileDescriptor.id]&&this.thumbnailPromises[fileDescriptor.id].resolve(blob),delete this.thumbnailPromises[fileDescriptor.id],defered.resolve(blob)}).catch(error=>{this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"download",message:error.message,fileDesc:fileDescriptor}),delete this.thumbnailPromises[fileDescriptor.id],defered.reject(error)}),defered.promise}return this.$q.reject("No available thumbnail")}getBlobFromFileDescriptor(fd,cancelable=!0,actionOnPartialResponse){if(!fd)return this.$log.warn("[FileServerService] getBlobFromFileDescriptor : missing file descriptor"),this.$q.reject();if(this.$log.info("[FileServerService] getBlobFromFileDescriptor: "+fd.id),"uploaded"!==fd.state)return this.$log.warn("[FileServerService] getBlobFromFileDescriptor : file is not in uploaded state="+fd.state),this.$q.reject();let url=fd.url;fd.uploadedDate&&(url+="?update="+crypto_js_1.MD5(crypto_js_2.enc.Latin1.parse(fd.uploadedDate)).toString(crypto_js_2.enc.Hex));let range=this.ONE_MEGABYTE;if(this.capabilities.maxChunkSizeDownload&&0!==fd.size&&fd.size>range){fd.size>=100*range&&(range=fd.size/100+this.ONE_KILOBYTE,this.$log.debug("[FileServerService] changing chunk size: "+range));var defered=this.$q.defer();let blobArray=new Array,promiseArray=[];fd.state="downloading",fd.chunkTotalNumber=Math.ceil(fd.size/range),fd.chunkPerformed=0,fd.chunkPerformedPercent=0,this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{type:"download",fileDesc:fd,cancelable:cancelable}),this.$log.info("[FileServerService] getBlobFromFileDescriptor: need to download "+fd.chunkTotalNumber+" chunks");for(let i=0,minRange=0,maxRange=range-1,repetition=Math.ceil(fd.size/range);repetition>0;i++,repetition--,minRange+=range,maxRange+=range)maxRange=maxRange<fd.size?maxRange:fd.size,promiseArray.push(()=>{var promiseArrayDeferred=this.$q.defer();return this.getPartialDataFromServer(url,minRange,maxRange,i).then(response=>(fd.chunkPerformed++,fd.chunkPerformedPercent=100*fd.chunkPerformed/fd.chunkTotalNumber,this.$log.info("[FileServerService] getBlobFromFileDescriptor : chunk downloaded="+fd.chunkPerformed),blobArray[response.index]=response.data,this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{type:"download",fileDesc:fd,cancelable:cancelable}),actionOnPartialResponse?actionOnPartialResponse(response,fd.id).then(()=>promiseArrayDeferred.resolve(response.data)):promiseArrayDeferred.resolve(response))).catch(error=>{this.$log.info("[FileServerService] error on chunk download="+error),promiseArrayDeferred.reject(error)}),promiseArrayDeferred.promise});var promisesCompletion=()=>{let blob=new Blob(blobArray,{type:fd.typeMIME});this.$log.info("[FileServerService] getBlobFromFileDescriptor success"),fd.state="uploaded",fd.chunkPerformed=0,fd.chunkTotalNumber=0,fd.chunkPerformedPercent=0,this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{type:"download",fileDesc:fd}),defered.resolve(blob)};return this.transfertPromiseQueue.addPromiseArray(fd.id,promiseArray,promisesCompletion,errorResponse=>{let error=this.errorHelperService.handleError(errorResponse);fd.state="uploaded",fd.chunkPerformed=0,fd.chunkTotalNumber=0,fd.chunkPerformedPercent=0;let errorDataObj=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(errorResponse.data))),translatedErrorMessage=this.errorHelperService.getLocalizedError(errorDataObj.errorDetailsCode);this.$log.error(translatedErrorMessage),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"download",message:translatedErrorMessage||error.message,fileDesc:fd}),defered.reject(error)}),defered.promise}return fd.state="downloading",fd.chunkTotalNumber=1,fd.chunkPerformed=0,fd.chunkPerformedPercent=0,this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:fd,cancelable:!1}),this.getBlobFromUrl(url,fd.typeMIME,fd.size,fd.fileName).then(blob=>(fd.state="uploaded",this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:fd}),this.$q.resolve(blob))).catch(error=>(fd.state="uploaded",this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:fd}),this.$log.info("[FileServerService] arrayPromise : error "+error.message),this.$q.reject(error)))}getBlobFromUrl(url,mime,fileSize,fileName){return this.$log.debug("[FileServerService] >getBlobFromUrl: "+url),this.$q((resolve,reject)=>{this.$http({method:"GET",url:url,headers:this.authService.getRequestHeader(),responseType:"arraybuffer"}).then(response=>{let blob=new Blob([response.data],{type:mime});this.$log.debug("[FileServerService] getBlobFromUrl success"),resolve(blob)},errorResponse=>{let error=this.errorHelperService.handleError(errorResponse);this.$log.error("[FileServerService] "+error.translatedMessage),reject(error)})})}getBlobUrlAndOrientationByFileDescriptorId(id){return this.$q((resolve,reject)=>{let fileDescriptor=this.fileStorageService.getFileDescriptorById(id);fileDescriptor?this.getBlobFromFileDescriptor(fileDescriptor,!1,null).then(blob=>{let result={};if(result.blobUrl=URL.createObjectURL(blob),result.id=id,fileDescriptor.orientation)return result.orientation=fileDescriptor.orientation,void resolve(result);this.setImageOrientationForFileDescriptor(fileDescriptor,blob).then(orientation=>{result.orientation=orientation,resolve(result)}).catch(()=>{resolve(result)})}).catch(error=>{reject(error)}):(this.$log.error("[FileServerService] getBlobUrlAndOrientationById no file descriptor found for ID "+id),reject(new Error("[FileServerService] getBlobUrlAndOrientationById no file descriptor found")))})}setImageOrientationForFileDescriptor(fileDescriptor,blob){return this.$q((resolve,reject)=>{if(fileDescriptor&&fileDescriptor.isImage()){var reader=new FileReader;reader.onload=e=>{fileDescriptor.orientation=1;var arrayBuffer=e.target.result,view=new DataView(arrayBuffer);if(65496===view.getUint16(0,!1)){for(var length=view.byteLength,offset=2;offset<length;){if(view.getUint16(offset+2,!1)<=8)return void reject();var marker=view.getUint16(offset,!1);if(offset+=2,65505===marker){if(1165519206!==view.getUint32(offset+=2,!1))return void reject();var little=18761===view.getUint16(offset+=6,!1);offset+=view.getUint32(offset+4,little);var tags=view.getUint16(offset,little);offset+=2;for(var i=0;i<tags;i++)if(274===view.getUint16(offset+12*i,little)){var orientation=view.getUint16(offset+12*i+8,little);return fileDescriptor.orientation=orientation,void resolve(orientation)}}else{if(65280!=(65280&marker))break;offset+=view.getUint16(offset,!1)}}reject()}else reject()},reader.readAsArrayBuffer(blob)}else reject()})}uploadAFile(fileId,file,mime){return this.$q((resolve,reject)=>{let fileDescriptor=this.fileStorageService.getFileDescriptorById(fileId);fileDescriptor&&(fileDescriptor.state="uploading"),this.$http({method:"PUT",url:this.portalURL+"/"+fileId,headers:this.authService.getPostHeader("application/octet-stream"),data:file,uploadEventHandlers:{progress:e=>{this.$log.log(e)}}}).then(response=>{let newFileDescriptor=this.fileStorageService.getFileDescriptorById(fileId);newFileDescriptor&&(newFileDescriptor.state="uploaded"),this.$log.info("[FileServerService] uploadAFile success"),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"upload",fileDesc:newFileDescriptor}),this.fileStorageService.orderDocuments(),resolve(newFileDescriptor)},errorResponse=>{let error=this.errorHelperService.handleError(errorResponse);this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",fileDesc:fileDescriptor}),reject(error),this.$log.error("[FileServerService] "+error.message)})})}sendPartialDataToServer(fileId,filePart,initialSize,minRange,maxRange,index){return this.$q((resolve,reject)=>{this.$http({method:"PUT",url:this.portalURL+"/"+fileId+"/parts/"+index,headers:this.authService.getPostHeaderWithRange("bytes "+minRange+"-"+maxRange+"/"+initialSize,"application/octet-stream"),data:filePart,uploadEventHandlers:{progress:e=>{this.$log.log(e)}}}).then(response=>{let chunkResponse=response.data.data;this.$log.info("[FileServerService] sendPartialDataToServer success"),resolve(chunkResponse)},errorResponse=>{let error=this.errorHelperService.handleError(errorResponse);reject(error),this.$log.error("[FileServerService] "+error.message)})})}calculateMd5(blob,callback){var reader=new FileReader;reader.readAsBinaryString(blob),reader.onloadend=()=>{callback(crypto_js_1.MD5(crypto_js_2.enc.Latin1.parse(reader.result)).toString(crypto_js_2.enc.Hex))}}uploadAFileByChunk(fileDescriptor,file,message,progressCallback){this.$log.info("[FileServerService] >uploadAFileByChunk");let range=this.ONE_MEGABYTE;if(range<file.size){file.size>=100*range&&(range=Math.round(file.size/100+this.ONE_KILOBYTE),this.$log.debug("[FileServerService] changing chunk size: "+range));var defered=this.$q.defer();fileDescriptor.chunkTotalNumber=Math.ceil(file.size/range),fileDescriptor.chunkPerformed=0,fileDescriptor.chunkPerformedPercent=0,fileDescriptor.state="uploading",this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:fileDescriptor,cancelable:!0});let promiseArray=[];for(let i=0,minRange=0,maxRange=range-1,repetition=Math.ceil(file.size/range);repetition>0;i++,repetition--,minRange+=range,maxRange+=range){let max=maxRange<file.size?maxRange:file.size,blob=file.slice(minRange,max+1);promiseArray.push(()=>{var promiseArrayDeferred=this.$q.defer();return this.calculateMd5(blob,blobChecksum=>{this.$log.info("[FileServerService] sendPartialDataToServer calculated checksum="+blobChecksum),this.sendPartialDataToServer(fileDescriptor.id,blob,file.size,minRange,max,i).then(response=>{if(this.$log.info("[FileServerService] sendPartialDataToServer md5sum="+response.md5sum),!response.md5sum.localeCompare(blobChecksum))return fileDescriptor.chunkPerformed++,fileDescriptor.chunkPerformedPercent=100*fileDescriptor.chunkPerformed/fileDescriptor.chunkTotalNumber,progressCallback&&progressCallback(message,fileDescriptor),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:fileDescriptor,cancelable:!0}),promiseArrayDeferred.resolve(response);this.$log.error("[FileServerService] Wrong Checksum for chunk detected: "+response.md5sum+"/"+blobChecksum);promiseArrayDeferred.reject({errorDetailsCode:500,message:"Wrong Checksum for chunk"})}).catch(error=>{this.$log.info("[FileServerService] error on chunk upload="+error),promiseArrayDeferred.reject(error)})}),promiseArrayDeferred.promise})}return this.transfertPromiseQueue.addPromiseArray(fileDescriptor.id,promiseArray,()=>{this.$http({method:"PUT",url:this.portalURL+"/"+fileDescriptor.id+"/parts/end",headers:this.authService.getPostHeader("application/octet-stream"),uploadEventHandlers:{progress:e=>{this.$log.log(e)}}}).then(response=>{this.$log.info("[FileServerService] uploadAFileByChunk success"),fileDescriptor.state="uploaded",fileDescriptor.chunkPerformed=0,fileDescriptor.chunkTotalNumber=0,fileDescriptor.chunkPerformedPercent=0,progressCallback&&progressCallback(message,fileDescriptor),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"upload",fileDesc:fileDescriptor}),this.fileStorageService.orderDocuments(),this.fileStorageService.retrieveUserConsumption(),defered.resolve(fileDescriptor)},errorResponse=>{let error=this.errorHelperService.handleError(errorResponse);this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",fileDesc:fileDescriptor}),defered.reject(error)})},errorResponse=>{let error=this.errorHelperService.handleError(errorResponse);this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",fileDesc:fileDescriptor}),defered.reject(error)}),defered.promise}return progressCallback&&progressCallback(message,fileDescriptor),this.uploadAFile(fileDescriptor.id,file,fileDescriptor.typeMIME).then(response=>(this.$log.info("[FileServerService] uploadAFile success"),progressCallback&&progressCallback(message,fileDescriptor),this.fileStorageService.retrieveUserConsumption(),this.$q.resolve(fileDescriptor)))}isTransferInProgress(){return this.transfertPromiseQueue.isTransferInProgress()}cancelAllTransfers(){this.transfertPromiseQueue.cancelAllTransfers()}cancelCurrentFiletransfer(id){this.transfertPromiseQueue.cancelCurrentFiletransfer(id)}getServercapabilities(){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:config.restServerUrl+"/api/rainbow/fileserver/v1.0/capabilities",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[FileServerService] getServercapabilities -- success"),this.capabilities=response.data.data,resolve(this.capabilities)},errorResponse=>{let error=this.errorHelperService.handleError(errorResponse);this.$log.error("[FileServerService] getServercapabilities "+error.message),reject(error)})})}getBlobFromUrlWithOptimization(url,mime,fileSize=0,fileName="",uploadedDate=""){return 0!==uploadedDate.length&&(url+="?update="+crypto_js_1.MD5(crypto_js_2.enc.Latin1.parse(uploadedDate)).toString(crypto_js_2.enc.Hex)),this.$q((resolve,reject)=>{if(this.capabilities.maxChunkSizeDownload&&0!==fileSize&&fileSize>this.capabilities.maxChunkSizeDownload){let range=this.capabilities.maxChunkSizeDownload;range>this.ONE_MEGABYTE&&(range=this.ONE_MEGABYTE);let minRange=0,maxRange=range-1,repetition=Math.ceil(fileSize/range),blobArray=new Array(repetition);this.$log.debug("[FileServerService] getBlobFromUrlWithOptimization : "+repetition+" chunks to be downloaded");let promiseArray=[];for(let i=0;repetition>0;i++,repetition--,minRange+=range,maxRange+=range)promiseArray.push(this.getPartialDataFromServer(url,minRange,maxRange,i).then(response=>(blobArray[response.index]=response.data,response.data)));this.$q.all(promiseArray).then(()=>{let blob=new Blob(blobArray,{type:mime});this.$log.debug("[FileServerService] getBlobFromUrlWithOptimization success"),resolve(blob)},errorResponse=>{let error=this.errorHelperService.handleError(errorResponse),errorDataObj=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(errorResponse.data))),translatedErrorMessage=this.errorHelperService.getLocalizedError(errorDataObj.errorDetailsCode);this.$log.error(translatedErrorMessage),reject(error)})}else this.getBlobFromUrl(url,mime,fileSize,fileName).then(blob=>{resolve(blob)}).catch(error=>{reject(error)})})}getBlobUrlFromUrl(url,mime,filesize=0,fileName=""){return this.$q((resolve,reject)=>{this.getBlobFromUrlWithOptimization(url,mime,filesize,fileName).then(blob=>{resolve(URL.createObjectURL(blob))}).catch(error=>{reject(error)})})}}FileServerService.$inject=["$q","$http","$log","authService","fileStorageService","TransfertPromiseQueue","FileDescriptorEventHandler","xmppService","errorHelperService","$rootScope","$interval"],angular.module("rainbow").service("fileServerService",FileServerService)},function(module,exports){class FileStorageService{constructor($injector,$q,$http,$log,$rootScope,authService,fileViewerFactory,errorHelperService,orderByFilter,contactService,helpersService,fileViewerElementFactory,fileDescriptorFactory){this.$injector=$injector,this.$q=$q,this.$http=$http,this.$log=$log,this.$rootScope=$rootScope,this.authService=authService,this.fileViewerFactory=fileViewerFactory,this.errorHelperService=errorHelperService,this.orderByFilter=orderByFilter,this.contactService=contactService,this.helpersService=helpersService,this.fileViewerElementFactory=fileViewerElementFactory,this.fileDescriptorFactory=fileDescriptorFactory,this.started=!1,this.listeners=[],this.rotationValues={1:"rotate(0deg)",3:"rotate(180deg)",6:"rotate(90deg)",8:"rotate(270deg)"}}start(stats){this.$log.info("[FileStorageService] === STARTING ===");let startDate=performance.now();return this.started=!1,this.portalURL=config.restServerUrl+"/api/rainbow/filestorage/v1.0/files",this.fileDescriptors=[],this.voiceMessageFileDescriptors=[],this.fileDescriptorsByDate=[],this.fileDescriptorsByName=[],this.fileDescriptorsBySize=[],this.receivedFileDescriptors=[],this.receivedFileDescriptorsByName=[],this.receivedFileDescriptorsByDate=[],this.receivedFileDescriptorsBySize=[],this.consumptionData={},this.channelService=this.$injector.get("channelService"),this.retrieveFileDescriptorsListPerOwner().then(()=>this.retrieveReceivedFiles(this.contactService.userContact.dbId)).then(()=>(this.orderDocuments(),this.retrieveUserConsumption())).then(()=>{this.started=!0;var startDuration=Math.round(performance.now()-startDate);stats.push({service:"FileStorageService",startDuration:startDuration}),this.$log.info("[FileStorageService] === STARTED ("+startDuration+" ms) ===")}).catch(error=>{this.$log.error("[FileStorageService] === STARTING === failure -- "+error.message)}),this.retrieveVoiceMessageFileDescriptorsListPerOwner().then(()=>{this.$log.info("[FileStorageService] === STARTED (retrieveVoiceMessageFileDescriptorsListPerOwner)")}).catch(error=>{this.$log.error("[FileStorageService] === STARTING === failure -- (retrieveVoiceMessageFileDescriptorsListPerOwner)")}),this.listeners.push(this.$rootScope.$on("ROOM_UPDATE_EVENT",(__event,room,action)=>{action&&"remove"===action&&(this.$log.info("[FileStorageService] ROOM_UPDATE_EVENT REMOVED for roomId="+room.dbId),this.removeRoomFileViewer(room))})),this.$q.when()}stop(){return this.$log.info("[FileStorageService] === STOPPING ==="),this.started&&(this.started=!1),this.listeners&&this.listeners.forEach(unregisterListener=>{unregisterListener()}),this.$log.info("[FileStorageService] === STOPPED ==="),this.$q.when()}reinit(isBlocking){return this.$q((resolve,reject)=>{if(!isBlocking)return this.$log.info("[FileStorageService] === reinit not blocking ==="),resolve(),void this.reinitInternal();this.$log.info("[FileStorageService] === reinit blocking ==="),this.reinitInternal().then(()=>{resolve()}).catch(()=>{reject()})})}reinitInternal(){return this.$q((resolve,reject)=>{this.retrieveFileDescriptorsListPerOwner().then(()=>this.retrieveReceivedFiles(this.contactService.userContact.dbId)).then(()=>{this.orderDocuments(),this.$log.info("[FileStorageService] reinitInternal done"),resolve()}).catch(error=>{this.$log.error("[FileStorageService] reinitInternal failure -- "+error.message),reject()})})}removeRoomFileViewer(room){let fileDesc;this.$log.info("[FileStorageService] >removeRoomFileViewer: "+room.dbId);do{if(fileDesc=this.getFileDescriptorByViewerId(room.dbId)){var viewerFound=fileDesc.viewers.find(element=>element.viewerId===room.dbId);viewerFound&&(this.$log.info("[FileStorageService] >viewer found delete it"),fileDesc.viewers.splice(fileDesc.viewers.indexOf(viewerFound),1))}}while(fileDesc)}getFileDescriptorByViewerId(id){for(let fileDescriptor of this.fileDescriptors)for(let viewer of fileDescriptor.viewers)if(viewer.viewerId===id)return fileDescriptor;for(let fileDescriptor of this.receivedFileDescriptors)if(fileDescriptor.id===id)return fileDescriptor;return null}getFileDescriptorById(id){for(let fileDescriptor of this.fileDescriptors)if(fileDescriptor.id===id)return fileDescriptor;for(let fileDescriptor of this.receivedFileDescriptors)if(fileDescriptor.id===id)return fileDescriptor;return null}getCompleteFileDescriptorById(id){return this.$q((resolve,reject)=>{let fileDescriptor;if(this.fileDescriptors.some(fd=>fd.id===id&&(fileDescriptor=fd,!0))){let promiseArray=[];for(let viewer of fileDescriptor.viewers)"user"===viewer.type&&promiseArray.push(this.contactService.getContactByDBId(viewer.viewerId).then(contact=>(viewer.contact=contact,viewer)).catch(error=>{this.$log.error("[FileStorageService] "+error),reject(error)}));this.$q.all(promiseArray).then(()=>{resolve(fileDescriptor)}).catch(error=>{this.$log.error("[FileStorageService] "+error),reject(error)})}else reject()})}getDocuments(){return this.fileDescriptors}getReceivedDocuments(){return this.receivedFileDescriptors}getDocumentsByName(received){return received?this.receivedFileDescriptorsByName:this.fileDescriptorsByName}getDocumentsByDate(received){return received?this.receivedFileDescriptorsByDate:this.fileDescriptorsByDate}getDocumentsBySize(received){return received?this.receivedFileDescriptorsBySize:this.fileDescriptorsBySize}getReceivedFilesFromContact(dbId){return this.receivedFileDescriptorsByDate.filter(file=>file.ownerId===dbId)}getSentFilesToContact(dbId){return this.fileDescriptorsByDate.filter(file=>{for(let i=0;i<file.viewers.length;i++)if(file.viewers[i].viewerId===dbId)return!0;return!1})}getReceivedFilesForRoom(dbId){return this.receivedFileDescriptorsByDate.filter(file=>{for(let i=0;i<file.viewers.length;i++)if(file.viewers[i].viewerId===dbId&&file.ownerId!==this.contactService.userContact.dbId)return!0;return!1})}getConsumptionData(){return this.consumptionData}getVoiceMessageFileDescriptorByMsgId(msgId){return this.voiceMessageFileDescriptors.find(file=>null!==file.tags&&file.tags.msgId===msgId)}createFileDescriptor(name,extension,size,viewers,voiceMessageData=null){return this.$q((resolve,reject)=>{let data={fileName:name,extension:extension,size:size,viewers:viewers};voiceMessageData&&(data.voicemessage=!0,data.encoding=!0,data.duration=voiceMessageData.duration),this.$http({method:"POST",url:this.portalURL,headers:this.authService.getRequestHeader(),data:data}).then(response=>{const fileDescriptor=this.createFileDescriptorFromData(response.data.data);this.$log.info("[FileStorageService] createFileDescriptor -- "+fileDescriptor.id+" -- success"),fileDescriptor&&this.fileDescriptors.push(fileDescriptor),this.orderDocuments(),resolve(fileDescriptor)}).catch(errorResponse=>{const error=this.errorHelperService.handleError(errorResponse,"createFileDescriptor");403153===error.errorDetailsCode&&(this.contactService.userContact.fileSharingEnabled=!1),this.$log.error("[FileStorageService] "+error.message),reject(error)})})}createFileDescriptorFromData(data){if(data){let viewers=[];if(data.viewers)for(let viewerData of data.viewers)viewers.push(this.fileViewerElementFactory(viewerData.viewerId,viewerData.type,viewerData.contact,this.contactService,this.channelService));let url=data.url;url||(url=config.restServerUrl+"/api/rainbow/fileserver/v1.0/files/"+data.id);var state="unknown";state=data.isUploaded?"uploaded":"not_uploaded";var virusScanState="unknown";virusScanState=null===data.isClean?"notScanned":!0===data.isClean?"isClean":"isInfected";var voiceMessage=!1;return data.tags&&"voicemail"===data.tags.purpose&&(voiceMessage=!0),this.fileDescriptorFactory(data.id,url,data.ownerId,data.fileName,data.extension,data.typeMIME,data.size,data.registrationDate,data.uploadedDate,data.dateToSort,viewers,state,data.thumbnail,data.orientation,data.tags,virusScanState,voiceMessage)}}deleteFileDescriptor(id){return this.$q((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+id,headers:this.authService.getRequestHeader()}).then(()=>{this.$log.info("[FileStorageService] deleteFileDescriptor -- success"),this.deleteFileDescriptorFromCache(id,!1),this.$rootScope.$broadcast("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:id}),this.retrieveUserConsumption(),resolve(void 0)}).catch(errorResponse=>{let error=this.errorHelperService.handleError(errorResponse,"deleteFileDescriptor");reject(error),this.$log.error("[FileStorageService] "+error.message)})})}deleteAllFileDescriptor(){return this.$q((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"/all",headers:this.authService.getRequestHeader()}).then(()=>{this.$log.info("[FileStorageService] deleteAllFileDescriptor -- success"),this.deleteAllFilesDescriptorsFromCache(),this.retrieveUserConsumption(),resolve()}).catch(errorResponse=>{let error=this.errorHelperService.handleError(errorResponse,"deleteAllFileDescriptor");this.$log.error("[FileStorageService]"+error.message),reject(error)})})}retrieveFileDescriptorsListPerOwner(){return this.fileDescriptors||(this.fileDescriptors=[]),this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"?format=full&limit=1000",headers:this.authService.getRequestHeader()}).then(response=>{this.fileDescriptors=[];let fileDescriptorsData=response.data.data;fileDescriptorsData||resolve();let limit=response.data.limit,total=response.data.total,getAllFileDescriptorPromise=null;if(total<=limit)getAllFileDescriptorPromise=this.$q.resolve([]);else{let offset=limit,requestCount=total/limit,requestArray=[];for(let index=1;index<requestCount;index++)requestArray.push(this.retrieveFileDescriptorsListPerOwnerwithOffset(offset,limit)),offset+=limit;getAllFileDescriptorPromise=this.$q.all(requestArray)}getAllFileDescriptorPromise.then(responsesData=>{responsesData.forEach(responseData=>{fileDescriptorsData=fileDescriptorsData.concat(responseData)});for(let fileDescriptorData of fileDescriptorsData){let fileDescriptor=this.createFileDescriptorFromData(fileDescriptorData);"not_uploaded"===fileDescriptor.state?(this.$log.info("[FileStorageService] file "+fileDescriptor.fileName+" not uploaded"),fileDescriptor.ownerId===this.contactService.userContact.dbId?(this.$log.info("[FileStorageService] file "+fileDescriptor.fileName+" is our property, we can delete it"),this.deleteFileDescriptor(fileDescriptor.id)):this.$log.info("[FileStorageService] file "+fileDescriptor.fileName+" is NOT our property, we CANNOT delete it")):this.fileDescriptors.push(fileDescriptor)}this.$log.info("[FileStorageService] retrieveFileDescriptorsListPerOwner -- success"),resolve(this.fileDescriptors)})}).catch(errorResponse=>{let error=this.errorHelperService.handleError(errorResponse,"retrieveFileDescriptorsListPerOwner");reject(error),this.$log.error("[FileStorageService] "+error.message)})})}retrieveVoiceMessageFileDescriptorsListPerOwner(){return this.voiceMessageFileDescriptors||(this.voiceMessageFileDescriptors=[]),this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"?format=full&path=/voice-messages",headers:this.authService.getRequestHeader()}).then(response=>{this.voiceMessageFileDescriptors=[];let fileDescriptorsData=response.data.data;fileDescriptorsData||resolve();for(let fileDescriptorData of fileDescriptorsData){let fileDescriptor=this.createFileDescriptorFromData(fileDescriptorData);"not_uploaded"===fileDescriptor.state?(this.$log.info("[FileStorageService] file "+fileDescriptor.fileName+" not uploaded"),fileDescriptor.ownerId===this.contactService.userContact.dbId?(this.$log.info("[FileStorageService] file "+fileDescriptor.fileName+" is our property, we can delete it"),this.deleteFileDescriptor(fileDescriptor.id)):this.$log.info("[FileStorageService] file "+fileDescriptor.fileName+" is NOT our property, we CANNOT delete it")):this.voiceMessageFileDescriptors.push(fileDescriptor)}this.$log.info("[FileStorageService] retrieveVoiceMessageFileDescriptorsListPerOwner -- success"),resolve(this.voiceMessageFileDescriptors)}).catch(errorResponse=>{let error=this.errorHelperService.handleError(errorResponse,"retrieveVoiceMessageFileDescriptorsListPerOwner");reject(error),this.$log.error("[FileStorageService] "+error.message)})})}retrieveFileDescriptorsListPerOwnerwithOffset(offset,limit){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"?format=full&limit="+limit+"&offset="+offset,headers:this.authService.getRequestHeader()}).then(response=>{resolve(response.data.data)})})}retrieveFilesReceivedFromPeer(userId,peerId){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/viewers/"+userId+"?ownerId="+peerId+"&format=full",headers:this.authService.getRequestHeader()}).then(response=>{let receivedFileDescriptors=[],fileDescriptorsData=response.data.data;if(fileDescriptorsData)for(let fileDescriptorData of fileDescriptorsData){let fileDescriptor=this.createFileDescriptorFromData(fileDescriptorData);receivedFileDescriptors.push(fileDescriptor)}this.$log.info("[FileStorageService] retrieveFilesReceivedFromPeer success"),resolve(receivedFileDescriptors)}).catch(errorResponse=>{let error=this.errorHelperService.handleError(errorResponse,"retrieveFilesReceivedFromPeer");this.$log.error("[FileStorageService] "+error.message),reject(error)})})}retrieveSentFiles(peerId){return this.$log.info("[FileStorageService] >retrieveSentFiles"),this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"?format=full&viewerId="+peerId,headers:this.authService.getRequestHeader()}).then(response=>{let sentFilesDescriptors=[],fileDescriptorsData=response.data.data;if(fileDescriptorsData)for(let fileDescriptorData of fileDescriptorsData){let fileDescriptor=this.createFileDescriptorFromData(fileDescriptorData);"not_uploaded"===fileDescriptor.state?this.$log.warn("[FileStorageService] file "+fileDescriptor.fileName+" not uploaded"):sentFilesDescriptors.push(fileDescriptor)}this.$log.info("[FileStorageService] retrieveSentFiles success"),resolve(sentFilesDescriptors)}).catch(errorResponse=>{let error=this.errorHelperService.handleError(errorResponse,"retrieveSentFiles");this.$log.error("[FileStorageService] "+error.message),reject(error)})})}retrieveReceivedFilesForRoom(roomId){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/viewers/"+roomId+"?format=full",headers:this.authService.getRequestHeader()}).then(response=>{let fileDescriptorsData=response.data.data,result=[];fileDescriptorsData?(fileDescriptorsData.forEach(fileDescriptorData=>{if(fileDescriptorData.ownerId!==this.contactService.userContact.dbId){fileDescriptorData.viewers=[];let newFileDesc=this.createFileDescriptorFromData(fileDescriptorData);result.push(newFileDesc),this.receivedFileDescriptors.find(fd=>fd.id===fileDescriptorData.id)||this.receivedFileDescriptors.push(newFileDesc)}}),resolve(result)):resolve(result)}).catch(errorResponse=>{let error=this.errorHelperService.handleError(errorResponse,"retrieveReceivedFilesForRoom");this.$log.error("[FileStorageService] "+error.message),reject(error)})})}retrieveReceivedFiles(viewerId){return this.receivedFileDescriptors||(this.receivedFileDescriptors=[]),this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/viewers/"+viewerId+"?format=full&limit=1000",headers:this.authService.getRequestHeader()}).then(response=>{this.receivedFileDescriptors=[];let fileDescriptorsData=response.data.data;if(!fileDescriptorsData)return void resolve();let limit=response.data.limit,total=response.data.total,getReceivedFileDescriptorPromise=null;if(total<=limit)getReceivedFileDescriptorPromise=this.$q.resolve([]);else{let offset=limit,requestCount=total/limit,requestArray=[];for(let index=1;index<requestCount;index++)requestArray.push(this.retrieveReceivedFilesWithOffset(viewerId,offset,limit)),offset+=limit;getReceivedFileDescriptorPromise=this.$q.all(requestArray)}getReceivedFileDescriptorPromise.then(responsesData=>{responsesData.forEach(responseData=>{fileDescriptorsData=fileDescriptorsData.concat(responseData)});for(let fileDescriptorItem of fileDescriptorsData){let fileDescriptor=this.createFileDescriptorFromData(fileDescriptorItem);if(fileDescriptor.ownerId!==this.contactService.userContact.dbId){let oldFileDesc=this.getFileDescriptorById(fileDescriptor.id);oldFileDesc&&(fileDescriptor.previewBlob=oldFileDesc.previewBlob),this.receivedFileDescriptors.push(fileDescriptor)}}this.orderReceivedDocuments(),this.$log.info("[FileStorageService] retrieveReceivedFiles -- success"),resolve(this.receivedFileDescriptors)})}).catch(errorResponse=>{let error=this.errorHelperService.handleError(errorResponse,"retrieveReceivedFiles");this.$log.error("[FileStorageService] "+error.message),reject(error)})})}retrieveReceivedFilesWithOffset(viewerId,offset,limit){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/viewers/"+viewerId+"?format=full&limit="+limit+"&offset="+offset,headers:this.authService.getRequestHeader()}).then(response=>{resolve(response.data.data)})})}retrieveUserConsumption(){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:config.restServerUrl+"/api/rainbow/filestorage/v1.0/users/consumption",headers:this.authService.getRequestHeader()}).then(response=>{this.consumptionData=response.data.data,this.$log.info("[FileStorageService] retrieveUserConsumption success"),this.$rootScope.$broadcast("ON_CONSUMPTION_DATA_UPDATED_EVENT"),resolve(this.consumptionData)}).catch(errorResponse=>{let error=this.errorHelperService.handleError(errorResponse,"retrieveUserConsumption");this.$log.error("[FileStorageService] "+error.message),reject(error)})})}deleteFileViewer(viewerId,fileId){return this.$q((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+fileId+"/viewers/"+viewerId,headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[FileStorageService] deleteFileViewer "+response.statusText);let fd=this.getFileDescriptorById(fileId);if(fd){let index=-1;for(let i=0;i<fd.viewers.length;i++)if(fd.viewers[i].viewerId===viewerId){index=i;break}-1!==index&&fd.viewers.splice(index,1)}resolve()},errorResponse=>{let error=this.errorHelperService.handleError(errorResponse,"deleteFileViewer");reject(error),this.$log.error("[FileStorageService] "+error.message)})})}addFileViewer(fileId,viewerId,viewerType){let fileDescriptor=this.getFileDescriptorById(fileId);return fileDescriptor&&fileDescriptor.isAlreadyFileViewer(viewerId)?this.$q.resolve(fileDescriptor):this.$q((resolve,reject)=>{this.$http({method:"POST",url:this.portalURL+"/"+fileId+"/viewers",headers:this.authService.getRequestHeader(),data:{viewerId:viewerId,type:viewerType}}).then(response=>{this.$log.info("[FileStorageService] addFileViewer success");let fd=this.getFileDescriptorById(fileId);if(fd){var viewerAdded=this.fileViewerFactory([{viewerId:response.data.data.viewerId,type:response.data.data.type}])[0];"user"===viewerAdded.type?this.contactService.getContactByDBId(viewerId).then(contact=>{viewerAdded.contact=contact,fd.viewers.push(viewerAdded),resolve(fd)}).catch(error=>{this.$log.error("[FileStorageService] "+error),reject(error)}):(fd.viewers.push(viewerAdded),resolve(fd))}},errorResponse=>{const error=this.errorHelperService.handleError(errorResponse,"addFileViewer");reject(error),this.$log.error("[FileStorageService] "+error.message)})})}copyFileToUserCloudStorage(fileId){return this.$q((resolve,reject)=>{this.$http({method:"POST",url:this.portalURL+"/"+fileId+"/copy",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[FileStorageService] copyFileToUserCloudStorage | copyFile "+fileId+" -- success"),this.retrieveAndStoreOneFileDescriptor(response.data.data.id,!0).then(fileDescriptor=>{resolve(fileDescriptor)}).catch(error=>{reject(error)})}).catch(errorResponse=>{let error=this.errorHelperService.handleError(errorResponse,"copyFileToUserCloudStorage");this.$log.error("[FileStorageService] copyFileToUserCloudStorage "+error.message),reject(error)})})}retrieveOneFileDescriptor(fileId){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/"+fileId+"?format=full",headers:this.authService.getRequestHeader()}).then(response=>{let fileDescriptor=this.createFileDescriptorFromData(response.data.data);this.$log.info("[FileStorageService] getOneFileDescriptor "+fileId+" -- success"),resolve(fileDescriptor)}).catch(errorResponse=>{let error=this.errorHelperService.handleError(errorResponse,"getOneFileDescriptor");this.$log.error("[FileStorageService] "+error.message),reject(error)})})}retrieveAndStoreOneFileDescriptor(fileId,forceRetrieve){let fileDescriptor=this.getFileDescriptorById(fileId);return fileDescriptor&&!forceRetrieve?(this.$log.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- return existing fileDescriptor "+fileId),this.$q.resolve(fileDescriptor)):this.retrieveOneFileDescriptor(fileId).then(retrievedFileDescriptor=>{fileDescriptor&&fileDescriptor.isImage()&&(retrievedFileDescriptor.previewBlob=fileDescriptor.previewBlob);let oldFileDescriptorIndex=this.helpersService.findIndex(this.fileDescriptors,_fileDescriptor=>_fileDescriptor.id===retrievedFileDescriptor.id);oldFileDescriptorIndex>-1&&this.fileDescriptors.splice(oldFileDescriptorIndex,1);let oldReceivedFileDescriptorIndex=this.helpersService.findIndex(this.receivedFileDescriptors,_fileDescriptor=>_fileDescriptor.id===retrievedFileDescriptor.id);if(oldReceivedFileDescriptorIndex>-1&&this.receivedFileDescriptors.splice(oldReceivedFileDescriptorIndex,1),retrievedFileDescriptor.ownerId===this.contactService.userContact.dbId)this.fileDescriptors.push(retrievedFileDescriptor),this.$log.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- fileDescriptor "+retrievedFileDescriptor.id+" -- now stored in my files");else{this.receivedFileDescriptors.push(retrievedFileDescriptor),this.$log.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- fileDescriptor "+retrievedFileDescriptor.id+" -- now stored in received files"),this.$rootScope.$broadcast("ON_MESSAGE_WITH_FILE_RECEIVED_EVENT")}return this.orderDocuments(),this.$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:retrievedFileDescriptor.id}),this.$q.resolve(retrievedFileDescriptor)}).catch(errorResponse=>{this.$log.warn("[FileStorageService] Error on getting FileDescriptor: "+errorResponse.errorDetailsCode);let error=this.errorHelperService.handleError(errorResponse,"retrieveAndStoreOneFileDescriptor");return error.status>=400&&error.status<500&&fileDescriptor&&(404===error.status&&this.deleteFileDescriptorFromCache(fileDescriptor.id,!0),this.orderDocuments(),this.$log.debug("[FileStorageService] Sending ON_FILE_REMOVED_FROM_STORE_EVENT"),this.$rootScope.$broadcast("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:fileDescriptor.id})),this.$q.reject(errorResponse)})}deleteFileDescriptorFromCache(id,forceDelete){this.$log.info("[FileStorageService] deleteFileDescriptorFromCache "+id);for(let index=0;index<this.receivedFileDescriptors.length;index++)if(this.receivedFileDescriptors[index].id===id){this.receivedFileDescriptors.splice(index,1);break}for(let index=0;index<this.fileDescriptors.length;index++)if(this.fileDescriptors[index].id===id){forceDelete?this.fileDescriptors.splice(index,1):this.fileDescriptors[index].state="deleted";break}this.orderDocuments()}deleteAllFilesDescriptorsFromCache(){this.$log.info("[FileStorageService] deleteAllFilesDesceiptorsFromCache"),this.fileDescriptors.forEach(fileDescriptor=>{fileDescriptor.state="deleted",this.receivedFileDescriptors.forEach((receivedFileDescriptor,index)=>{receivedFileDescriptor.id===fileDescriptor.id&&this.receivedFileDescriptors.splice(index,1)})}),this.fileDescriptors=[],this.orderDocuments()}orderDocuments(){this.$log.debug("[FileStorageService] orderDocuments: "+this.fileDescriptors.length),this.replaceOrderedByFilter(this.fileDescriptorsByDate,this.fileDescriptors,this.getDate,!1,this.sortByDate),this.replaceOrderedByFilter(this.fileDescriptorsByName,this.fileDescriptors,this.getName,!1,this.sortByName),this.replaceOrderedByFilter(this.fileDescriptorsBySize,this.fileDescriptors,this.getSize,!1,this.sortBySize),this.orderReceivedDocuments()}orderReceivedDocuments(){this.$log.debug("[FileStorageService] orderReceivedDocuments: "+this.receivedFileDescriptors.length),this.replaceOrderedByFilter(this.receivedFileDescriptorsByName,this.receivedFileDescriptors,this.getName,!1,this.sortByName),this.replaceOrderedByFilter(this.receivedFileDescriptorsByDate,this.receivedFileDescriptors,this.getDate,!1,this.sortByDate),this.replaceOrderedByFilter(this.receivedFileDescriptorsBySize,this.receivedFileDescriptors,this.getSize,!1,this.sortBySize)}orderDocumentsForRoom(documents){return this.orderByFilter(documents,this.getDate,!1,this.sortByDate)}replaceOrderedByFilter(resultArray,originalArray,filterFct,flag,sortFct){this.$log.debug("[FileStorageService] replaceOrderedByFilter"),resultArray.length=0;let orderedArrayResult=this.orderByFilter(originalArray,filterFct,flag,sortFct);for(let fileResult of orderedArrayResult)"deleted"!==fileResult.state&&resultArray.push(fileResult)}getName(file){let date,result={name:"",date:""};return file.fileName&&(result.name=file.fileName),date=file.uploadedDate?new Date(file.uploadedDate):file.registrationDate?new Date(file.registrationDate):new Date(file.dateToSort),result.date=date.getTime(),result}getDate(file){let date;return(date=file.uploadedDate?new Date(file.uploadedDate):file.registrationDate?new Date(file.registrationDate):new Date(file.dateToSort)).getTime()}getSize(file){let result={name:"",size:""};return file.name&&(result.name=file.fileName),result.size=file.size,result}sortByName(fileA,fileB){let res=-1;return fileA.value.name&&fileB.value.name&&0===(res=fileA.value.name.localeCompare(fileB.value.name))&&(res=fileB.value.date-fileA.value.date),res}sortBySize(fileA,fileB){let res=-1;return fileA.value.size&&fileB.value.size&&(res=fileB.value.size-fileA.value.size),res}sortByDate(fileA,fileB){let res=1;return fileA&&fileB&&(res=fileB.value-fileA.value),res}extractFileIdFromUrl(url){let parts=url.split("/");return parts.pop()||parts.pop()}retrieveAndStoreOneVoiceMessageFileDescriptor(fileId){this.retrieveOneFileDescriptor(fileId).then(retrievedFileDescriptor=>{if(retrievedFileDescriptor.tags&&"/voice-messages"===retrievedFileDescriptor.tags.path){if(void 0!==this.voiceMessageFileDescriptors.find(file=>file.id===fileId)){let fileDescriptorIndex=this.voiceMessageFileDescriptors.findIndex(oneFileDescriptor=>oneFileDescriptor.id===retrievedFileDescriptor.id);fileDescriptorIndex>-1&&this.voiceMessageFileDescriptors.splice(fileDescriptorIndex,1,retrievedFileDescriptor),this.$log.info("[FileStorageService] getRetrieveAndStoreOneVoiceMessageFileDescriptor "+fileId+" -- success")}else this.voiceMessageFileDescriptors.push(retrievedFileDescriptor)}})}deleteVoiceMessageFileDescriptor(fileId){this.$log.info("[FileStorageService] deleteVoiceMessageFileDescriptore "+fileId);let fileDescriptorExist=this.voiceMessageFileDescriptors.find(file=>file.id===fileId);if(void 0!==fileDescriptorExist){let fileDescriptorIndex=this.voiceMessageFileDescriptors.findIndex(oneFileDescriptor=>oneFileDescriptor.id===fileDescriptorExist.id);fileDescriptorIndex>-1&&this.voiceMessageFileDescriptors.splice(fileDescriptorIndex,1)}}}FileStorageService.$inject=["$injector","$q","$http","$log","$rootScope","authService","fileViewerFactory","errorHelperService","orderByFilter","contactService","helpersService","fileViewerElementFactory","fileDescriptorFactory"],angular.module("rainbow").service("fileStorageService",FileStorageService)},function(module,exports){angular.module("rainbow").factory("FileDescriptorEventHandler",["$log","$rootScope","contactService",function($log,$rootScope,contactService){"use strict";function FileDescriptorEventHandler(fileServerService){var that=this;this.fileServerService=fileServerService,this.fileStorageService=fileServerService.getFileStorageService(),that.onManagementMessageReceived=function(stanza){try{var stanzaElem=$(stanza);return stanzaElem.find("file").length>0?this.manageFileStanzaData(stanzaElem.find("file")):stanzaElem.find("thumbnail").length>0?this.manageThumbnailStanzaData(stanzaElem.find("thumbnail")):$log.info("[FileDescriptorEventHandler] onManagementMessageReceived  -- ignore the message"),!0}catch(error){return $log.error("[FileDescriptorEventHandler] onManagementMessageReceived ERROR "+error),!0}},that.manageFileStanzaData=function(stanza){for(var action=$(stanza).attr("action"),filesId=$(stanza).find("fileid"),updateConsumption=!1,i=0;i<filesId.length;i++){var fileId=$(filesId[i]).text(),fileDescriptor=this.fileStorageService.getFileDescriptorById(fileId);switch($log.info("[FileDescriptorEventHandler] manageFileStanzaData -- "+action+" fileDescriptor "+fileId),action){case"create":$log.debug("[FileDescriptorEventHandler] fileDescriptor "+fileId+" created on server -- do nothing");break;case"delete":fileDescriptor&&(fileDescriptor.ownerId===contactService.userContact.dbId&&"deleted"!==fileDescriptor.state&&(updateConsumption=!0),this.fileStorageService.deleteFileDescriptorFromCache(fileId),this.fileStorageService.deleteVoiceMessageFileDescriptor(fileId),$rootScope.$broadcast("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:fileId}));break;case"update":fileDescriptor||(updateConsumption=!0),that.fileStorageService.retrieveAndStoreOneFileDescriptor(fileId,!0).then((function(fileDesc){$log.info("[FileDescriptorEventHandler] fileDescriptor retrieved"),fileDesc.previewBlob||that.fileServerService.getBlobThumbnailFromFileDescriptor(fileDesc).then((function(blob){fileDesc.previewBlob=blob,$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:fileDesc.id})})).catch((function(error){$log.error("[FileDescriptorEventHandler] fileDescriptor retrieve error : ",error)}))})),that.fileStorageService.retrieveAndStoreOneVoiceMessageFileDescriptor(fileId)}}updateConsumption&&this.fileStorageService.retrieveUserConsumption()},that.manageThumbnailStanzaData=function(stanza){var action=$(stanza).attr("action"),fileId=$(stanza).find("fileid").text(),fileUrl=$(stanza).find("url").text(),fileMime=$(stanza).find("mime").text(),fileSize=($(stanza).find("filename").text(),$(stanza).find("size").text()),md5sum=$(stanza).find("md5sum").text();if($log.info("[FileDescriptorEventHandler] manageThumbnailStanzaData -- "+action+" fileDescriptor "+fileId),$log.debug("[FileDescriptorEventHandler]   fileUrl="+fileUrl),$log.debug("[FileDescriptorEventHandler]   fileMime="+fileMime),$log.debug("[FileDescriptorEventHandler]   fileSize="+fileSize),$log.debug("[FileDescriptorEventHandler]   md5sum="+md5sum),$log.debug("[FileDescriptorEventHandler]   fileId="+fileId),"create"===action||"update"===action){var fileDescriptor=this.fileStorageService.getFileDescriptorById(fileId);fileDescriptor?($log.debug("[FileDescriptorEventHandler] updating Thumbnail of found FileDescriptor "+fileId),fileDescriptor.previewBlob&&!fileDescriptor.thumbnail.availableThumbnail||!fileDescriptor.previewBlob?($rootScope.$broadcast("ON_FILE_DESCRIPTOR_THUMBNAIL_READY",fileDescriptor.id),fileDescriptor.thumbnail.availableThumbnail=!0,fileDescriptor.thumbnail.md5sum=md5sum,fileDescriptor.thumbnail.size=fileSize,$log.info("[FileDescriptorEventHandler] preview not already downloaded for "+fileId+" -- download it"),this.fileServerService.getBlobThumbnailFromFileDescriptor(fileDescriptor).then((function(){$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:fileDescriptor.id})}))):($rootScope.$broadcast("ON_FILE_DESCRIPTOR_THUMBNAIL_READY",fileDescriptor.id),$log.info("[FileDescriptorEventHandler] preview already downloaded for "+fileId+" -- do nothing"))):$log.error("[FileDescriptorEventHandler] FileDescriptor not found and we do nothing and its not OK")}}}return FileDescriptorEventHandler.create=function(fileServerService){return new FileDescriptorEventHandler(fileServerService)},FileDescriptorEventHandler}])},function(module,exports){angular.module("rainbow").service("extensionSharingService",["$q","$log","$rootScope",function($q,$log,$rootScope){"use strict";var that=this;this.extensionFound=!1,this.minVersion="1.5.1",this.port=null,this.currentStreamId="screen",this.start=function(){this.extensionId=this.extensionId||this.getExtensionId(config.webservices.server);var defered=$q.defer();return $log.info("[extensionService] === STARTING ==="),window.chrome&&window.chrome.runtime?($log.info("[extensionService] Chrome extension - try to ping...",this.extensionId),chrome.runtime.sendMessage(this.extensionId,{type:"ping",data:null},null,(function(extensionMessageResponse){extensionMessageResponse&&"pong"===extensionMessageResponse.type?($log.info("[extensionService] Chrome extension - pong received"),$log.info("[extensionService] Chrome extension - extension installed and detected"),$log.info("[extensionService] Chrome extension - try to connect..."),that.port=chrome.runtime.connect(that.extensionId),that.port?($log.info("[extensionService] Chrome extension - port created"),that.port.onDisconnect.addListener((function(){$log.info("Extension DISCONNECTED"),that.extensionFound=!1,that.port=null})),that.port.onMessage.addListener((function(msg){switch($log.info("[extensionService] Chrome extension - connected"),msg.type){case"loginResponse":that.extensionFound=!0,$log.info("[extensionService] Chrome extension - ready!"),$log.info("[extensionService] === STARTED ==="),$rootScope.$broadcast("ON_EXTENSION_SHARING_READY"),defered.resolve();break;case"getVersionResponse":0===msg.code&&msg.version?($rootScope.$broadcast("ON_EXTENSION_VERSION_UPDATED",msg.version),$log.info("[extensionService] Chrome extension - Detected version "+msg.version)):($rootScope.$broadcast("ON_EXTENSION_VERSION_UPDATED",null),$log.error("[extensionService] Chrome extension - No version received"));break;case"startsharingResponse":0===msg.code&&msg.streamID?($log.info("[extensionService] Chrome extension - stream ID received "+msg.streamID),$rootScope.$broadcast("ON_EXTENSION_SHARING_STREAM_FOUND",msg.streamID)):($log.info("[extensionService] Chrome extension - No stream ID received"),$rootScope.$broadcast("ON_EXTENSION_SHARING_STREAM_FOUND",null));break;case"endsharingResponse":$log.info("[extensionService] Chrome extension - end sharing session received")}})),that.port.postMessage({type:"login",data:null})):($log.info("[extensionService] Chrome extension - can't create port to contact the extension!!!"),$log.info("[extensionService] === STARTED ==="),defered.resolve())):($log.info("[extensionService] Chrome extension - not found"),chrome.runtime.lastError&&$log.info("[extensionService] Chrome extension - error "+chrome.runtime.lastError),defered.resolve())}))):($log.info("[extensionService] Not in chrome"),$log.info("[extensionService] === STARTED ==="),defered.resolve()),defered.promise},this.stop=function(){return $log.info("[extensionService] === STOPPING ==="),$log.info("[extensionService] === STOPPED ==="),$q.when()},this.getExtensionId=function(domain){return $log.info("Detected domain : "+domain),-1!==domain.indexOf("openrainbow.net")?"koefhabbjedbiecnldkolbijjfjinogj":-1!==domain.indexOf("openrainbow.org")?"ehamhlkmecdnidihfedapmplddlbidee":-1!==domain.indexOf("openrainbow.com")?"mgneongoclkopahpapenfhbbeckhdmnj":($log.error("Unkown domain, extension may not be available"),"mgneongoclkopahpapenfhbbeckhdmnj")},this.setExtensionId=function(extensionId){$log.info("set extensionId to : "+extensionId),this.extensionId=extensionId},this.getStreamToShareFromExtension=function(constraints){var defered=$q.defer(),callback=$rootScope.$on("ON_EXTENSION_SHARING_STREAM_FOUND",(function(__event,streamid){that.currentStreamId=streamid,callback(),streamid?(constraints.video.mandatory.chromeMediaSourceId=streamid,defered.resolve()):defered.reject()}));return this.port.postMessage({type:"startsharing",data:null}),defered.promise},this.getStreamId=function(){return this.currentStreamId},this.isExtensionInstalled=function(){var defered=$q.defer();return this.extensionFound?defered.resolve(!0):this.start().then((function(){defered.resolve(that.extensionFound)})),defered.promise},this.getExtensionVersion=function(){var defered=$q.defer(),callback=$rootScope.$on("ON_EXTENSION_VERSION_UPDATED",(function(__event,version){callback(),version?defered.resolve(version):defered.reject()}));return this.port.postMessage({type:"getVersion",data:null}),defered.promise},this.checkExtensionStatus=function(){var defered=$q.defer();return"chrome"!==adapter.default.browserDetails.browser?defered.resolve("notNeeded"):this.isExtensionInstalled().then((function(isInstalled){isInstalled?that.checkVersion().then((function(isUpToDate){isUpToDate?defered.resolve("good"):defered.resolve("needUpdate")})):defered.resolve("notInstalled")})),defered.promise},this.checkVersion=function(){var defered=$q.defer();return this.getExtensionVersion().then((function(version){defered.resolve(that.cmpVersions(version,that.minVersion)>=0)})),defered.promise},this.cmpVersions=function(curVersion,minVersion){var i,diff,regExStrip0=/(\.0+)+$/,segmentsA=curVersion.replace(regExStrip0,"").split("."),segmentsB=minVersion.replace(regExStrip0,"").split("."),length=Math.min(segmentsA.length,segmentsB.length);for(i=0;i<length;i++)if(diff=parseInt(segmentsA[i],10)-parseInt(segmentsB[i],10))return diff;return segmentsA.length-segmentsB.length}}])},function(module,exports,__webpack_require__){var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class PstnConferenceService{constructor($q,$rootScope,$log,$http,authService,errorHelperService,ConferenceSession,profileService,xmppService,countryService,Conference,contactService,$translate){this.$q=$q,this.$rootScope=$rootScope,this.$log=$log,this.$http=$http,this.authService=authService,this.errorHelperService=errorHelperService,this.ConferenceSession=ConferenceSession,this.profileService=profileService,this.xmppService=xmppService,this.countryService=countryService,this.Conference=Conference,this.contactService=contactService,this.$translate=$translate,this.MEDIATYPE={PSTNAUDIO:"pstnAudio",WEBRTC:"webrtc",WEBRTCSHARINGONLY:"webrtcSharingOnly"},this.started=!1,this.conferenceProvisionRef=null,this.isPstnConferenceAvailable=!1,this.conferenceSessions={},this.pstnConferenceEndpoints={},this.pstnInstantConferenceEndpoint=null,this.pstnConferencePhoneNumbers=null}start(stats){return this.$q(resolve=>{let startDate=performance.now();this.$log.info("[PstnConferenceService] === STARTING ==="),this.isPstnConferenceAvailable=!1,this.conferenceSessions={},this.pstnConferenceEndpoints={},this.pstnInstantConferenceEndpoint=null,this.pstnConferencePhoneNumbers=null,this.confProvPortalURL=config.restServerUrl+"/api/rainbow/confprovisioning/v1.0/",this.confPortalURL=config.restServerUrl+"/api/rainbow/conference/v1.0/conferences/",this.started=!0;let startDuration=Math.round(performance.now()-startDate);stats.push({service:"pstnConferenceService",startDuration:startDuration}),this.$log.info("[PstnConferenceService] === STARTED ("+startDuration+" ms) ==="),resolve()})}stop(){return this.$q(resolve=>{this.$log.info(""),this.$log.info("[PstnConferenceService] === STOPPING ==="),this.started=!1,this.$log.info("[PstnConferenceService] === STOPPED ==="),resolve()})}updateConference(confEndpointId,confData){return this.$log.info("[PstnConferenceService] updateConference"),this.$q((resolve,reject)=>{if(confEndpointId)this.$http({method:"PUT",url:this.confProvPortalURL+"conferences/"+confEndpointId,headers:this.authService.getRequestHeader(),data:confData}).then(response=>{let conferenceData=response.data.data,conference=this.Conference.createFromData(conferenceData);conferenceData.hasOwnProperty("id")&&(this.pstnConferenceEndpoints[conferenceData.id]&&delete this.pstnConferenceEndpoints[conferenceData.id],this.pstnConferenceEndpoints[conferenceData.id]=conference,conferenceData.scheduled||(delete this.pstnInstantConferenceEndpoint,this.pstnInstantConferenceEndpoint=conference)),this.$log.info("[PstnConferenceService] updateConference successfully"),resolve(conference)},response=>{let errorMessage="updateConference failure: "+(response.data?response.data.errorDetails:response.data);this.$log.error("[PstnConferenceService] "+errorMessage),reject(new Error(errorMessage))});else{let errorMessage="updateConference failure: No confEndpoint";this.$log.error("[PstnConferenceService] updateConference failure : No confEndpoint"),reject(new Error(errorMessage))}})}retrievePstnConferences(scheduled,provisioning){return this.$log.info("[PstnConferenceService] retrievePstnConferences with scheduled="+scheduled),this.$q((resolve,reject)=>{if(!this.isPstnConferenceAvailable)return this.$log.warn("[PstnConferenceService] retrieveConference - user is not allowed"),void reject(new Error("notAllowed"));let urlQueryParameters="?format=full&userId="+this.contactService.userContact.dbId+"&mediaType="+this.MEDIATYPE.PSTNAUDIO;angular.isDefined(scheduled)&&(urlQueryParameters+="&scheduled="+scheduled),provisioning&&(urlQueryParameters+="&provisioning=true"),this.$http({method:"GET",url:this.confProvPortalURL+"conferences"+urlQueryParameters,headers:this.authService.getRequestHeader()}).then(response=>{let conferencesProvisionData=response.data.data;for(let conferenceData of conferencesProvisionData)this.updateOrCreatePstnConferenceEndpoint(conferenceData);this.$log.info("[PstnConferenceService] retrievePstnConferences successfully"),resolve(conferencesProvisionData)},response=>{let errorMessage="retrievePstnConferences failure: "+(response.data?response.data.errorDetails:response.data);this.$log.error("[PstnConferenceService] "+errorMessage),reject(new Error(errorMessage))})})}updateOrCreateConferenceSession(confId,snapshotData){if(this.$log.debug("[PstnConferenceService] updateOrCreateConferenceSession for "+confId),!confId||!snapshotData||!snapshotData.data)return this.$log.error("[PstnConferenceService] updateOrCreateConferenceSession - Not enough data"),null;let conferenceSession=this.conferenceSessions[confId];return conferenceSession?snapshotData.data.active!==conferenceSession.active&&(this.$log.debug("active"),conferenceSession.updateActiveState(snapshotData.data.active),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",conferenceSession)):(this.$log.debug("[PstnConferenceService] updateOrCreateConferenceSession - create new conferencesession with id "+confId+"and data: \n"+JSON.stringify(snapshotData.data)),conferenceSession=this.ConferenceSession.createFromData(confId,[],snapshotData.data.active,this.MEDIATYPE.PSTNAUDIO),this.conferenceSessions[confId]=conferenceSession,this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",conferenceSession)),snapshotData.data.participants&&(this.$log.debug("[PstnConferenceService] updateOrCreateConferenceSession - update participants for "+confId+" with:\n"+JSON.stringify(snapshotData.data.participants)),conferenceSession.updateParticipants(snapshotData.data.participants).then(()=>{this.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",conferenceSession)})),conferenceSession}updateOrCreatePstnConferenceEndpoint(conferenceData){if(this.$log.info("[PstnConferenceService] updateOrCreatePstnConferenceEndpoint for "+conferenceData.id),!conferenceData)return this.$log.error("[PstnConferenceService] updateOrCreatePstnConferenceEndpoint - no conference data !"),null;if(conferenceData.mediaType!==this.MEDIATYPE.PSTNAUDIO)return this.$log.error("[PstnConferenceService] updateOrCreatePstnConferenceEndpoint - wrong mediaType:"+conferenceData.mediaType),null;let conference=this.Conference.createFromData(conferenceData);return this.pstnConferenceEndpoints[conferenceData.id]=conference,conference.scheduled||(this.pstnInstantConferenceEndpoint=conference,this.pstnInstantConferenceEndpoint.name||this.updateConference(this.pstnInstantConferenceEndpoint.id,{name:this.$translate.instant("namePersonalConference",{name:this.contactService.userContact.displayName})})),this.pstnConferenceEndpoints[conferenceData.id]}formatPstnPhoneNumbers(phoneNumbers){this.$log.info("[PstnConferenceService] formatPstnPhoneNumbers");let pstnConferencePhoneNumbers={};return phoneNumbers.forEach(phoneNumber=>{if(phoneNumber.locationcode){let propertyName=this.countryService.getAlpha2Code(phoneNumber.locationcode.substr(0,3));propertyName&&(pstnConferencePhoneNumbers[propertyName]||(pstnConferencePhoneNumbers[propertyName]={numbersList:[]})),pstnConferencePhoneNumbers[propertyName].numbersList.push({number:phoneNumber.number,locationName:phoneNumber.location,city:phoneNumber.location.split(", ")[1],numberType:phoneNumber.numberType,needLanguageSelection:phoneNumber.needLanguageSelection})}}),pstnConferencePhoneNumbers}retrievePstnPhoneNumbers(shouldFormatResults){return this.$log.info("[ConferenceService] retrievePstnPhoneNumbers"),this.pstnConferencePhoneNumbers?shouldFormatResults?this.$q.resolve(this.formatPstnPhoneNumbers(this.pstnConferencePhoneNumbers)):this.$q.resolve(this.pstnConferencePhoneNumbers):this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.confProvPortalURL+"conferences/audio/phonenumbers?shortList=false",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[PstnConferenceService] retrievePstnPhoneNumbers successfully"),this.pstnConferencePhoneNumbers=response.data.data.phoneNumberList,resolve(shouldFormatResults?this.formatPstnPhoneNumbers(this.pstnConferencePhoneNumbers):this.pstnConferencePhoneNumbers)},response=>{let errorMessage="retrievePstnPhoneNumbers failure: "+(response.data?response.data.errorDetails:response.data);this.$log.error("[PstnConferenceService] "+errorMessage),reject(new Error(errorMessage))})})}retrievePstnInstantConference(){return this.isPstnConferenceAvailable?this.retrievePstnConferences(!1).then(conferenceData=>(conferenceData.forEach(data=>{if(data.hasOwnProperty("id")){let conference=this.Conference.createFromData(data);conference.mediaType!==this.MEDIATYPE.PSTNAUDIO||conference.userId!==this.contactService.userContact.dbId||conference.scheduled||(this.pstnConferenceEndpoints[conferenceData.id]=conference,this.pstnInstantConferenceEndpoint=conference,this.pstnInstantConferenceEndpoint.name||this.updateConference(this.pstnInstantConferenceEndpoint.id,{name:this.$translate.instant("namePersonalConference",{name:this.contactService.userContact.displayName})}))}}),this.$q.resolve()),()=>(this.$log.warn("[PstnConferenceService] retrievePstnInstantConference - issue retrieving instant conference"),this.$q.resolve())):(this.$log.info("[PstnConferenceService] retrievePstnInstantConference -- No conference rights"),this.$q.resolve())}getConferenceSessionById(confId){return this.conferenceSessions[confId]}getConferenceSessionForRoom(roomConfEndpoints){let pstnSession=null;if(roomConfEndpoints&&roomConfEndpoints.length)for(let i=0;i<roomConfEndpoints.length;i++)roomConfEndpoints[i].mediaType===this.MEDIATYPE.PSTNAUDIO&&(pstnSession=this.conferenceSessions[roomConfEndpoints[i].confEndpointId]);return pstnSession}removeConferenceSession(confId){confId&&delete this.conferenceSessions[confId]}initiatesCallParticipant(confId,participantPhoneNumber,participant,country){return this.$log.info("[PstnConferenceService] initiatesCallParticipant( confId="+confId+", PhoneNumber="+participantPhoneNumber+", role="+participant.role+" country = "+country+" )"),confId&&participantPhoneNumber?this.$q((resolve,reject)=>{this.$http({method:"POST",url:this.confPortalURL+confId+"/join",headers:this.authService.getPostHeader(),data:{participantPhoneNumber:participantPhoneNumber,participant:participant,country:country}}).then(response=>{let joinStatus=response.data.status;this.$log.info("[PstnConferenceService] initiatesCallParticipant( confId="+confId+") success : "+joinStatus),resolve()},errorResponse=>{let msg=errorResponse.data?errorResponse.data.errorDetails:errorResponse.data,errorMessage="initiatesCallParticipant( confId="+confId+") failure: "+msg;this.$log.error("[PstnConferenceService] "+errorMessage);let error=this.errorHelperService.handleError(errorResponse);reject(error)})}):(this.$log.error("[PstnConferenceService] initiatesCallParticipant - missing parameter"),this.$q.reject())}initiatesAudio(confId){return this.$log.info("[PstnConferenceService] initiatesAudio( confId="+confId+")"),confId?this.conferenceSessions[confId]&&this.conferenceSessions[confId].isActive()?(this.$log.info("[PstnConferenceService] initiatesAudio : conference already started"),this.$q.resolve()):this.$q((resolve,reject)=>{this.$http({method:"PUT",url:this.confPortalURL+confId+"/start",headers:this.authService.getRequestHeader()}).then(()=>{this.$log.info("[PstnConferenceService] initiatesAudio( confId="+confId+") successfully"),resolve()},response=>{let error=this.errorHelperService.handleError(response);reject(error)})}):(this.$log.error("[PstnConferenceService] initiatesAudio - missing parameter"),this.$q.reject())}initiatesAudioRecording(confId,participantId,fileName,fileExtension){return this.$log.info("[PstnConferenceService] initiatesAudioRecording( confId="+confId+"participantId="+participantId+"fileName="+fileName+"fileExtension="+fileExtension+")"),confId&&participantId?this.$q((resolve,reject)=>{this.$http({method:"POST",url:this.confPortalURL+confId+"/participants/"+participantId+"/start-recording",headers:this.authService.getPostHeader(),data:{fileName:fileName,fileExtension:fileExtension}}).then(()=>{this.$log.info("[PstnConferenceService] initiatesAudioRecording( confId="+confId+"participantId="+participantId+") successfully"),resolve()},response=>{let msg=response.data?response.data.errorDetails:response.data,errorMessage="initiatesAudioRecording( confId="+confId+"participantId="+participantId+") failure: "+msg;this.$log.error("[PstnConferenceService] "+errorMessage),reject(new Error(errorMessage))})}):(this.$log.error("[PstnConferenceService] initiatesAudioRecording - missing parameter"),this.$q.reject())}stopsAudioRecording(confId,participantId){return this.$q((resolve,reject)=>{if(this.$log.info("[PstnConferenceService] stopsAudioRecording( confId="+confId+"participantId="+participantId+")"),!confId||!participantId)return this.$log.error("[PstnConferenceService] initiatesAudioRecording - missing parameter"),this.$q.reject();this.$http({method:"POST",url:this.confPortalURL+confId+"/participants/"+participantId+"/stop-recording",headers:this.authService.getPostHeader()}).then(()=>{this.$log.info("[PstnConferenceService] stopsAudioRecording( confId="+confId+"participantId="+participantId+") successfully"),resolve()},response=>{let msg=response.data?response.data.errorDetails:response.data,errorMessage="stopsAudioRecording( confId="+confId+"participantId="+participantId+") failure: "+msg;this.$log.error("[PstnConferenceService] "+errorMessage),reject(new Error(errorMessage))})})}pausesAudioRecording(confId,participantId){return this.$q((resolve,reject)=>{if(this.$log.info("[PstnConferenceService] pausesAudioRecording( confId="+confId+"participantId="+participantId+")"),!confId||!participantId)return this.$log.error("[PstnConferenceService] pausesAudioRecording - missing parameter"),this.$q.reject();this.$http({method:"POST",url:this.confPortalURL+confId+"/participants/"+participantId+"/pause-recording",headers:this.authService.getPostHeader()}).then(()=>{this.$log.info("[PstnConferenceService] pausesAudioRecording( confId="+confId+"participantId="+participantId+") successfully"),resolve()},response=>{let msg=response.data?response.data.errorDetails:response.data,errorMessage="pausesAudioRecording( confId="+confId+"participantId="+participantId+") failure: "+msg;this.$log.error("[PstnConferenceService] "+errorMessage),reject(new Error(errorMessage))})})}resumesAudioRecording(confId,participantId){return this.$q((resolve,reject)=>{if(this.$log.info("[PstnConferenceService] resumesAudioRecording( confId="+confId+"participantId="+participantId+")"),!confId||!participantId)return this.$log.error("[PstnConferenceService] resumesAudioRecording - missing parameter"),this.$q.reject();this.$http({method:"POST",url:this.confPortalURL+confId+"/participants/"+participantId+"/resume-recording",headers:this.authService.getPostHeader()}).then(()=>{this.$log.info("[PstnConferenceService] resumesAudioRecording( confId="+confId+"participantId="+participantId+") successfully"),resolve()},response=>{let msg=response.data?response.data.errorDetails:response.data,errorMessage="resumesAudioRecording( confId="+confId+"participantId="+participantId+") failure: "+msg;this.$log.error("[PstnConferenceService] "+errorMessage),reject(new Error(errorMessage))})})}makeSnapshotForConfId(confId=null){if(!confId){let errorMsg="[PstnConferenceService] makeSnapshotForConfId - No confId !!";return this.$log.error(errorMsg),this.$q.reject(errorMsg)}let confSession=this.conferenceSessions[confId];return confSession&&confSession.active&&confSession.haveJoined?(this.$log.debug("[WebConferenceService] makeSnapshotForConfId skipped, already joined"),this.$q.resolve(confSession)):this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.confPortalURL+confId+"/snapshot?mediaType=pstnAudio",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[PstnConferenceService] makeSnapshotForConfId success for confId "+confId);let snapshotData=response.data;this.updateOrCreateConferenceSession(confId,snapshotData),resolve(snapshotData.data)}).catch(errorResponse=>{this.$log.info("[PstnConferenceService] makeSnapshotForConfId failure for confID "+confId),404===errorResponse.status?this.$log.error("[PstnConferenceService] makeSnapshotForConfId - confId "+confId+" not found on server"):this.$log.error("[PstnConferenceService] makeSnapshotForConfId - inconsistent object on server"),this.conferenceSessions[confId]&&this.removeConferenceSession(confId),reject()})})}refreshConferenceSessions(){return this.$log.info("[PstnConferenceService] refreshConferenceSessions"),this.$q((resolve,reject)=>{let promiseArray=[];for(let key in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(key)){let conferenceSession=this.conferenceSessions[key];promiseArray.push(this.makeSnapshotForConfId(conferenceSession.id))}this.$q.all(promiseArray).then(()=>{this.$log.info("[PstnConferenceService] refreshConferenceSessions -- success"),resolve()}).catch(()=>{this.$log.error("[PstnConferenceService] refreshConferenceSessions -- error -- cleaning up all sessions"),this.removeAllConferenceSessions(),reject()})})}getConferenceSessionWithConnId(connId){this.$log.info("[PstnConferenceService] getConferenceSessionWithConnId with connId : "+connId);for(let key in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(key)){let conferenceSession=this.conferenceSessions[key];if(conferenceSession&&conferenceSession.callId===connId)return conferenceSession}return null}subscribeToPstnSession(confId){return __awaiter(this,void 0,void 0,(function*(){if(this.$log.info("[PstnConferenceService] subscribeToPstnSession( confId="+confId+" )"),!confId){const error=new Error("[PstnConferenceService] subscribeToPstnSession - missing parameter");throw this.$log.error(error.message),error}try{const joinStatus=(yield this.$http({method:"POST",url:this.confPortalURL+confId+"/join",headers:this.authService.getPostHeader(),data:{participantPhoneNumber:"joinWithoutAudio",participant:{role:"member",type:"unmuted"},mediaType:this.MEDIATYPE.PSTNAUDIO}})).data.status;return this.$log.info("[PstnConferenceService] subscribeToPstnSession( confId="+confId+") success : "+joinStatus),confId}catch(error){let e=error;throw error&&error.data&&(e=this.errorHelperService.handleError(error),this.$log.error("[PstnConferenceService] subscribeToPstnSession - "+e.message)),e}}))}unSubscribeParticipantFromPstnSession(confId,participantId){return __awaiter(this,void 0,void 0,(function*(){if(this.$log.info("[PstnConferenceService] unSubscribeParticipantFromPstnSession( confId="+confId+" - participantId="+participantId+")"),!confId||!participantId){const error=new Error("[PstnConferenceService] unSubscribeParticipantFromPstnSession - missing parameter");throw this.$log.error(error.message),error}try{yield this.$http({method:"DELETE",url:this.confPortalURL+confId+"/participants/"+participantId+"?mediaType="+this.MEDIATYPE.PSTNAUDIO,headers:this.authService.getPostHeader()}),this.$log.info("[PstnConferenceService] unSubscribeParticipantFromPstnSession( confId="+confId+") success")}catch(error){let e=error;throw error&&error.data&&(e=this.errorHelperService.handleError(error),this.$log.error("[PstnConferenceService] unSubscribeParticipantFromPstnSession - "+e.message)),e}}))}resetPersonalMeetingRoom(){return __awaiter(this,void 0,void 0,(function*(){this.$log.debug("[PstnConferenceService] resetPersonalMeetingRoom");try{yield this.$http({method:"PUT",url:this.confProvPortalURL+"meetings/reset",headers:this.authService.getRequestHeader()}),this.$log.info("[PstnConferenceService] resetPersonalMeetingRoom success")}catch(error){let e=error;throw error&&error.data&&(e=this.errorHelperService.handleError(error),this.$log.error("[PstnConferenceService] resetPersonalMeetingRoom - "+e.message)),e}}))}removeAllConferenceSessions(){this.$log.info("[PstnConferenceService] removeAllConferenceSessions");for(let key in this.conferenceSessions)this.conferenceSessions.hasOwnProperty(key)&&this.removeConferenceSession(key)}}PstnConferenceService.$inject=["$q","$rootScope","$log","$http","authService","errorHelperService","ConferenceSession","profileService","xmppService","countryService","Conference","contactService","$translate"],angular.module("rainbow").service("pstnConferenceService",PstnConferenceService)},function(module,exports,__webpack_require__){var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};class WebConferenceService{constructor($q,$rootScope,$log,$http,uuid4,$interval,authService,xmppService,videoService,roomService,errorHelperService,ConferenceSession,contactService,platformService,Conference,profileService){this.$q=$q,this.$rootScope=$rootScope,this.$log=$log,this.$http=$http,this.uuid4=uuid4,this.$interval=$interval,this.authService=authService,this.xmppService=xmppService,this.videoService=videoService,this.roomService=roomService,this.errorHelperService=errorHelperService,this.ConferenceSession=ConferenceSession,this.contactService=contactService,this.platformService=platformService,this.Conference=Conference,this.profileService=profileService,this.MEDIATYPE={WEBRTC:"webrtc",WEBRTCSHARINGONLY:"webrtcSharingOnly"},this.started=!1,this.webConferenceRoom=null,this.webrtcConferenceId=null,this.webrtcSharingOnlyRoom=null,this.webrtcSharingOnlyConferenceId=null,this.jingleJid=null,this.makingCall=!1,this.connected=!1,this.disconnecting=!1,this.reconnecting=!1,this.audioProfileChanging=!1,this.conferenceEndpoints={},this.attachLocalMediaStream=(attach,conferenceSession)=>{if(attach){if(conferenceSession.hasLocalVideo){let session=conferenceSession.sessions[conferenceSession.localVideoSessionId];if(session){let stream=conferenceSession.localStreams[session.localStreamId];this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#conferenceVideoPip"),stream,session.sid),this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#conferenceVideoPipSmall"),stream,session.sid)}}if(conferenceSession.hasLocalSharing){let session=conferenceSession.sessions[conferenceSession.localSharingSessionId];if(session){let stream=conferenceSession.localStreams[session.localStreamId];this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#conferenceSharingPip"),stream,session.sid)}}}else this.videoService.RTC.clearMediaStream(angular.element("#minivideo"),null)}}start(stats){return this.$q(resolve=>{let startDate=performance.now();this.$log.info("[WebConferenceService] === STARTING ==="),this.confProvPortalURL=config.restServerUrl+"/api/rainbow/confprovisioning/v1.0/",this.confPortalURL=config.restServerUrl+"/api/rainbow/conference/v1.0/conferences/",this.conferenceEndpoints={},this.conferenceSessions={},this.listeners=[],this.statsIntervals=[],this.connected=!0,this.disconnecting=!1,this.webConferenceRoom=null,this.webrtcConferenceId=null,this.webrtcSharingOnlyRoom=null,this.webrtcSharingOnlyConferenceId=null,this.jingleJid=null,this.makingCall=!1,this.videoGalleryElements=[],this.attachHandlers(),this.videoGalleryElementsNumber=4,this.started=!0;let startDuration=Math.round(performance.now()-startDate);stats.push({service:"WebConferenceService",startDuration:startDuration}),this.$log.info("[WebConferenceService] === STARTED ("+startDuration+" ms) ==="),resolve()})}stop(){return this.$log.info("[WebConferenceService] === STOPPING ==="),this.started=!1,this.makingCall=!1,this.listeners&&this.listeners.forEach(listenerDestroy=>{listenerDestroy()}),this.$log.info("[WebConferenceService] === STOPPED ==="),this.$q.when()}attachHandlers(){this.listeners.push(this.$rootScope.$on("ON_INPUT_DEVICE_CHANGED_EVENT",()=>{this.onAudioProfileChangeEvent()})),this.listeners.push(this.$rootScope.$on("ON_CONNECTION_STATE_CHANGE_EVENT",(event,status)=>{this.$log.info("[WebConferenceService] onConnectionStateChangeEvent : "+status);try{if("disconnected"===status)this.$log.info("[WebConferenceService] onConnectionStateChangeEvent : disconnected"),this.connected=!1;else if("connected"===status){this.$log.info("[WebConferenceService] onConnectionStateChangeEvent : connected"),this.connected=!0;for(let key in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(key)){let conferenceSession=this.conferenceSessions[key];if("reconnecting"===conferenceSession.status)for(let sessId in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(sessId)){let session=conferenceSession.sessions[sessId];"audio"===session.localType&&this.sendTransportReplaceForSession(session,1e4)}}}}catch(error){this.$log.info("[WebConferenceService] onConnectionStateChangeEvent error : "+error)}}))}retrieveWebConferences(mediaType=this.MEDIATYPE.WEBRTC){return this.$log.info("[WebConferenceService] retrieveWebConferences with mediaType="+mediaType),this.$q((resolve,reject)=>{if(!this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED)&&mediaType!==this.MEDIATYPE.WEBRTCSHARINGONLY)return this.$log.warn("[WebConferenceService] retrieveWebConferences - user is not allowed"),void reject(new Error("notAllowed"));let urlQueryParameters="?format=full&userId="+this.contactService.userContact.dbId;angular.isDefined(mediaType)&&(urlQueryParameters+="&mediaType="+mediaType),this.$http({method:"GET",url:this.confProvPortalURL+"conferences"+urlQueryParameters,headers:this.authService.getRequestHeader()}).then(response=>{let conferencesProvisionData=response.data.data;this.$log.info("[WebConferenceService] retrieveWebConferences successfully"),resolve(conferencesProvisionData)},response=>{let errorMessage="retrieveWebConferences failure: "+(response.data?response.data.errorDetails:response.data);this.$log.error("[WebConferenceService] "+errorMessage),reject(new Error(errorMessage))})})}updateConference(confEndpointId,confData){return this.$log.info("[WebConferenceService] updateConference"),this.$q((resolve,reject)=>{if(confEndpointId)this.$http({method:"PUT",url:this.confProvPortalURL+"conferences/"+confEndpointId,headers:this.authService.getRequestHeader(),data:confData}).then(response=>{let conferenceData=response.data.data,conference=this.Conference.createFromData(conferenceData);conferenceData.hasOwnProperty("id")&&(this.conferenceEndpoints[conferenceData.id]&&delete this.conferenceEndpoints[conferenceData.id],this.conferenceEndpoints[conferenceData.id]=conference),this.$log.info("[WebConferenceService] updateConference successfully"),resolve(conference)},response=>{let errorMessage="updateConference failure: "+(response.data?response.data.errorDetails:response.data);this.$log.error("[WebConferenceService] "+errorMessage),reject(new Error(errorMessage))});else{let errorMessage="updateConference failure: No confEndpoint";this.$log.error("[WebConferenceService] updateConference failure : No confEndpoint"),reject(new Error(errorMessage))}})}createVideoGalleryElements(){this.videoGalleryElements=[];for(let i=1;i<=this.videoGalleryElementsNumber;i++){let obj={state:"free",sessionId:"",id:"videoGallery_"+i,publisherId:"",publisherJid:"",subStreamLevel:null};this.videoGalleryElements.push(obj)}}setVideoGalleryElementsNumber(number){this.videoGalleryElementsNumber=number}getConferenceSessions(){return this.conferenceSessions}getConferenceEndpoints(){return this.conferenceEndpoints}addConferenceEndpoint(conferenceEndpointId,conferenceEndpoint){conferenceEndpointId?this.conferenceEndpoints[conferenceEndpointId]=conferenceEndpoint:this.$log.warn("[WebConferenceService] addConferenceEndpoint - missing conferenceEndpointId")}getConferenceIdToUse(room,mediaType=this.MEDIATYPE.WEBRTC){let webPontConferenceId=this.getPontConfIdForRoom(room,mediaType);if(webPontConferenceId)return webPontConferenceId;switch(mediaType){case this.MEDIATYPE.WEBRTC:if(room.isUserModerator(this.contactService.userContact)&&this.webrtcConferenceId)return this.webrtcConferenceId;break;case this.MEDIATYPE.WEBRTCSHARINGONLY:if(room.owner&&this.webrtcSharingOnlyConferenceId)return this.webrtcSharingOnlyConferenceId}return""}isMyConference(conferenceId){return conferenceId&&(this.webrtcConferenceId&&conferenceId===this.webrtcConferenceId||this.webrtcSharingOnlyConferenceId&&conferenceId===this.webrtcSharingOnlyConferenceId)}startOrJoinWebConference(room){return this.$q((resolve,reject)=>{if(!room){let error=new Error("[webConferenceService] startOrJoinWebConference error - missing parameters for room");return this.$log.error(error.message),void reject(error)}let webPontConferenceId=this.getConferenceIdToUse(room,this.MEDIATYPE.WEBRTC);if(!webPontConferenceId){let error=new Error("[webConferenceService] startOrJoinWebConference error - no available pont conference");return this.$log.error(error.message),void reject(error)}if(this.$log.info("[WebConferenceService] startOrJoinWebConference -- "+webPontConferenceId),this.makingCall)return this.$log.warn("[webConferenceService] already starting a conference"),this.$q.resolve();this.makingCall=!0,this.makeSnapshotForConfId(webPontConferenceId,this.MEDIATYPE.WEBRTC).then(()=>{let conferenceSession=this.conferenceSessions[webPontConferenceId];if(!(this.isMyConference(webPontConferenceId)||conferenceSession&&conferenceSession.active)){let error=new Error("[webConferenceService] startOrJoinWebConference error - no active conference to join");return this.$log.error(error.message),reject(error),void(this.makingCall=!1)}let role=this.isMyConference(webPontConferenceId)?"moderator":"member";conferenceSession&&conferenceSession.active?(this.$rootScope.$broadcast("ON_CONFERENCE_ENDED_INVITATION",room),resolve(this.joinWebConference(webPontConferenceId,role))):resolve(this.startWebConference(room,webPontConferenceId))},()=>{this.makingCall=!1;let error=new Error("[webConferenceService] startOrJoinWebConference error on snapshot");this.$log.error(error.message),reject(error)})})}startOrJoinSharingOnlyConference(room){return this.$q((resolve,reject)=>{if(!room){let error=new Error("[webConferenceService] startOrJoinSharingOnlyConference error - missing parameters for room");return this.$log.error(error.message),void reject(error)}let webPontConferenceId=this.getConferenceIdToUse(room,this.MEDIATYPE.WEBRTCSHARINGONLY);if(!webPontConferenceId){let error=new Error("[webConferenceService] startOrJoinSharingOnlyConference error - no available pont conference");return this.$log.error(error.message),void reject(error)}this.makeSnapshotForConfId(webPontConferenceId,this.MEDIATYPE.WEBRTCSHARINGONLY).then(()=>{let conferenceSession=this.conferenceSessions[webPontConferenceId];if(!(this.isMyConference(webPontConferenceId)||conferenceSession&&conferenceSession.active)){let error=new Error("[webConferenceService] startOrJoinSharingOnlyConference error - no active conference to join");return this.$log.error(error.message),void reject(error)}let role=this.isMyConference(webPontConferenceId)?"moderator":"member";conferenceSession&&conferenceSession.active?(this.$rootScope.$broadcast("ON_CONFERENCE_ENDED_INVITATION",room),resolve(this.joinSharingOnlyConference(webPontConferenceId,role,!1))):resolve(this.startSharingOnlyConference(room,webPontConferenceId))},()=>{let error=new Error("[webConferenceService] startOrJoinSharingOnlyConference error on snapshot");this.$log.error(error.message),reject(error)})})}startWebConference(room,webPontConferenceId,shouldSnapshotBeforeStart=!1){return webPontConferenceId&&room?(this.makingCall=!0,this.$log.info("[webConferenceService] startWebConference wtih ID "+webPontConferenceId),this.$q(resolve=>{shouldSnapshotBeforeStart?(this.$log.debug("[webConferenceService] startWebConference - trigger snapshot for "+webPontConferenceId),resolve(this.makeSnapshotForConfId(webPontConferenceId,this.MEDIATYPE.WEBRTC))):resolve()}).then(()=>this.conferenceSessions[webPontConferenceId].active?(this.$log.info("[webConferenceService] startWebConference - No need to start an already active conference"),this.joinWebConference(webPontConferenceId,"moderator",!1)):(this.conferenceSessions[webPontConferenceId].status="ringing",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",this.conferenceSessions[webPontConferenceId]),this.$http({method:"PUT",url:this.confPortalURL+webPontConferenceId+"/start",headers:this.authService.getRequestHeader(),data:{mediaType:this.MEDIATYPE.WEBRTC,roomId:room.dbId}}).then(()=>(this.$log.info("[webConferenceService] startWebConference - success -- now joining the conference"),this.joinWebConference(webPontConferenceId,"moderator",!1)),errorResponse=>{throw this.makingCall=!1,this.$log.error("[webConferenceService] startWebConference wtih ID "+webPontConferenceId+" failure ... -- "+this.errorHelperService.getErrorFullMessage(errorResponse)),this.leaveWebConference(webPontConferenceId),this.removeConferenceSession(webPontConferenceId),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT"),this.errorHelperService.handleError(errorResponse)}))).catch(err=>{this.makingCall=!1;let errorMsg="[webConferenceService] startWebConference - error on server, can't start conference -- ",msg="startMeetingFailure";return err&&(403620===err.errorDetailsCode&&(msg="startMeetingConflict"),err.errorDetailsLabel&&(errorMsg+=err.errorDetailsLabel)),this.$log.error(errorMsg),this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"startConference",popupBody:msg,okLabel:"ok"}),this.$q.reject(err)})):(this.$log.error("[startWebConference] No webPontConferenceId or Room!"),this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"startConference",popupBody:"startMeetingFailure",okLabel:"ok"}),this.$q.reject())}startSharingOnlyConference(room,webPontConferenceId,shouldJoin=!0){return this.makingCall?(this.$log.warn("[webConferenceService] already starting a conference"),this.$q.resolve()):webPontConferenceId&&room?(this.makingCall=!0,this.$log.info("[webConferenceService] startSharingOnlyConference wtih ID "+webPontConferenceId),this.makeSnapshotForConfId(webPontConferenceId,this.MEDIATYPE.WEBRTCSHARINGONLY).then(()=>{if(this.conferenceSessions[webPontConferenceId].active)return this.$log.info("[webConferenceService] startSharingOnlyConference - No need to start an already active conference"),shouldJoin?this.$q.resolve(this.joinSharingOnlyConference(webPontConferenceId,"moderator",!1)):this.$q.resolve();this.conferenceSessions[webPontConferenceId].status="ringing",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",this.conferenceSessions[webPontConferenceId]);let url=this.confPortalURL+webPontConferenceId+"/start";return this.$q((resolve,reject)=>{this.$http({method:"PUT",url:url,headers:this.authService.getRequestHeader(),data:{mediaType:this.MEDIATYPE.WEBRTCSHARINGONLY,roomId:room.dbId}}).then(()=>{if(shouldJoin)return this.joinSharingOnlyConference(webPontConferenceId,"moderator",!1).then(()=>{resolve()});resolve()},errorResponse=>{this.makingCall=!1,this.$log.error("[webConferenceService] startSharingOnlyConference wtih ID "+webPontConferenceId+" failure ... -- "+this.errorHelperService.getErrorFullMessage(errorResponse)),this.leaveWebConference(webPontConferenceId),this.removeConferenceSession(webPontConferenceId),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT"),reject(this.errorHelperService.handleError(errorResponse))})})}).catch(error=>(this.makingCall=!1,this.$log.error("[webConferenceService] startSharingOnlyConference - error on server, can't start conference"),this.$q.reject(error)))):(this.$log.error("[startSharingOnlyConference] No webPontConferenceId or Room!"),this.$q.reject())}joinWebConference(webPontConferenceId,role,shouldSnapshotBeforeJoin=!1){return this.$log.info("[webConferenceService] joinWebConference with ID "+webPontConferenceId+" and role "+role),webPontConferenceId?this.$q(resolve=>{shouldSnapshotBeforeJoin?(this.$log.debug("[webConferenceService] joinWebConference - trigger snapshot for "+webPontConferenceId),resolve(this.makeSnapshotForConfId(webPontConferenceId,this.MEDIATYPE.WEBRTC))):resolve()}).then(()=>this.$q((resolve,reject)=>{this.makingCall=!0,this.createVideoGalleryElements(),this.conferenceSessions[webPontConferenceId].videoGallery=this.videoGalleryElements,"ringing"!==this.conferenceSessions[webPontConferenceId].status&&(this.conferenceSessions[webPontConferenceId].status="ringing",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",this.conferenceSessions[webPontConferenceId]));let id="web_"+this.uuid4.generate(),url=this.confPortalURL+webPontConferenceId+"/join",params={participant:{role:role,type:"unmuted"},mediaType:this.MEDIATYPE.WEBRTC};this.getUserMediaForSession(webPontConferenceId).then(sessId=>{this.$http({method:"POST",url:url,headers:this.authService.getRequestHeader(),data:params}).then(response=>{let data=response.data.data;this.jingleJid=data.jingleJid,this.initCall(this.jingleJid,webPontConferenceId,id,this.MEDIATYPE.WEBRTC),this.conferenceSessions[webPontConferenceId].haveJoined=!0,this.makingCall=!1,resolve()},errorResponse=>{if(errorResponse){let msg=errorResponse.data?errorResponse.data.errorDetails:errorResponse.data,errorMessage="joinWebConference( confId="+webPontConferenceId+") failure: "+msg;this.$log.error("[conferenceService] "+errorMessage)}this.makingCall=!1;let data={popupTitle:"warning",popupBody:"joinMeetingFailure",okLabel:"ok"};errorResponse&&errorResponse.data&&403615===errorResponse.data.errorDetailsCode&&(data.popupBody="maximumNumberConferenceParticipantsReach"),this.leaveWebConference(webPontConferenceId),delete this.conferenceSessions[webPontConferenceId],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT"),this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",data),reject(this.errorHelperService.handleError(errorResponse))})}).catch(reason=>{this.$log.error("[webConferenceService] joinWebConference - getUserMediaForSession reject -- "+reason),this.makingCall=!1,"ignore"!==reason&&this.leaveWebConference(webPontConferenceId),reject()})})).catch(()=>(this.makingCall=!1,this.$log.error("[webConferenceService] joinWebConference - error on server, can't join conference"),this.$q.reject())):(this.$log.error("[webConferenceService] joinWebConference - No webPontConferenceId !"),this.$q.reject())}joinSharingOnlyConference(webPontConferenceId,role,shouldSnapshotBeforeJoin=!0){return this.$log.info("[webConferenceService] joinSharingOnlyConference with ID "+webPontConferenceId+" and role "+role),webPontConferenceId?this.$q(resolve=>{shouldSnapshotBeforeJoin?(this.$log.debug("[webConferenceService] joinSharingOnlyConference - trigger snapshot for "+webPontConferenceId),resolve(this.makeSnapshotForConfId(webPontConferenceId,this.MEDIATYPE.WEBRTCSHARINGONLY))):resolve()}).then(()=>this.$q((resolve,reject)=>{this.makingCall=!0,this.createVideoGalleryElements(),this.conferenceSessions[webPontConferenceId].videoGallery=this.videoGalleryElements,"ringing"!==this.conferenceSessions[webPontConferenceId].status&&(this.conferenceSessions[webPontConferenceId].status="ringing",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",this.conferenceSessions[webPontConferenceId]));this.uuid4.generate();let url=this.confPortalURL+webPontConferenceId+"/join",params={participant:{role:role,type:"muted"},mediaType:this.MEDIATYPE.WEBRTCSHARINGONLY};this.$http({method:"POST",url:url,headers:this.authService.getRequestHeader(),data:params}).then(response=>{let data=response.data.data;this.jingleJid=data.jingleJid,this.$log.info("[webConferenceService] joinSharingOnlyConference with ID success - jingleJid: "+this.jingleJid),this.conferenceSessions[webPontConferenceId].jingleJid=this.jingleJid,this.conferenceSessions[webPontConferenceId].haveJoined=!0,this.makingCall=!1,resolve()},errorResponse=>{if(errorResponse){let msg=errorResponse.data?errorResponse.data.errorDetails:errorResponse.data,errorMessage="joinSharingOnlyConference( confId="+webPontConferenceId+") failure: "+msg;this.$log.error("[conferenceService] "+errorMessage)}this.makingCall=!1;let data={popupTitle:"warning",popupBody:"joinMeetingFailure",okLabel:"ok"};errorResponse&&errorResponse.data&&403615===errorResponse.data.errorDetailsCode&&(data.popupBody="maximumNumberConferenceParticipantsReach"),this.leaveWebConference(webPontConferenceId),delete this.conferenceSessions[webPontConferenceId],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT"),reject(this.errorHelperService.handleError(errorResponse))})})).catch(()=>(this.makingCall=!1,this.$log.error("[webConferenceService] joinSharingOnlyConference - error on server, can't join conference"),this.$q.reject())):(this.$log.error("[webConferenceService] joinSharingOnlyConference - No webPontConferenceId !"),this.$q.reject())}stopWebConference(room){return this.$q((resolve,reject)=>{if(room){let confId=room.getSFUConfEndpointId()?room.getSFUConfEndpointId():room.getSFUSharingConfEndpointId(),url=this.confPortalURL+confId+"/stop";this.$http({method:"PUT",url:url,headers:this.authService.getRequestHeader(),data:{mediaType:this.MEDIATYPE.WEBRTC,roomId:room.dbId}}).then(()=>{resolve()},errorResponse=>{reject(this.errorHelperService.handleError(errorResponse))})}else reject()})}getFreeVideoGalleryElement(confId){this.$log.info("[webConferenceService] getFreeVideoGalleryElement "+confId);let confSession=this.conferenceSessions[confId],result=null;if(confSession){confSession.videoGallery||(this.createVideoGalleryElements(),confSession.videoGallery=this.videoGalleryElements);for(let i=0;i<confSession.videoGallery.length;i++)if("free"===confSession.videoGallery[i].state){result=confSession.videoGallery[i];break}}return result}askToAddSharingToConferenceSession(conversation,conferenceSession){!this.videoService.askToAddSharing(conversation.id,"sharing")&&this.addMediaToConferenceSession(conferenceSession,"sharing")}addMediaToConferenceSession(conferenceSession,mediaType){if(!conferenceSession)return;let mediaToGet=[mediaType],frameRate=20;"video"!==mediaType&&(frameRate=3),"sharing"===mediaType&&this.contactService.setBusyState("dnd","sharing"),this.$log.info("[webConferenceService] addMediaToConferenceSession to session "+conferenceSession.id+" with media "+mediaType),this.videoService.getBrowserMedia(mediaToGet,640,480,frameRate).then(stream=>{let streams=[stream],unifiedPlan=this.videoService.config.unifiedPlan,session=this.xmppService.connection.jingle.initiate(conferenceSession.jingleJid,this.xmppService.connection.jid,mediaType,streams,null,conferenceSession.id,null,unifiedPlan);conferenceSession.sessions[session.sid]=session,conferenceSession.localStreams.push(stream),session.localStreamId=conferenceSession.localStreams.length-1,"video"===mediaType?(conferenceSession.hasLocalVideo=!0,conferenceSession.localVideoSessionId=session.sid):(conferenceSession.hasLocalSharing=!0,conferenceSession.localSharingSessionId=session.sid),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession),this.videoService.callsStats[session.sid]={},this.updateStatisticsForSession(conferenceSession.id,session.sid),this.statsIntervals.push(session.getStats(5e3))})}removeMediaFromConferenceSession(conferenceSession,mediaType){if(!conferenceSession)return;"sharing"===mediaType&&this.contactService.setBusyState("dnd","audio"),"webrtcSharingOnly"===conferenceSession.type&&this.contactService.resetBusyState(),this.$log.info("[webConferenceService] removeMediaFromConferenceSession from session "+conferenceSession.id);let sessionId="video"===mediaType?conferenceSession.localVideoSessionId:conferenceSession.localSharingSessionId;if(conferenceSession.sessions[sessionId]){let session=conferenceSession.sessions[sessionId];this.updateStatisticsForSession(conferenceSession.id,sessionId),this.videoService.disableAudioVideoMedia(session),this.xmppService.connection.jingle.terminate(session.sid),delete conferenceSession.sessions[sessionId],delete conferenceSession.localStreams[session.localStreamId],delete this.videoService.callsStats[sessionId],"video"===mediaType?(conferenceSession.hasLocalVideo=!1,conferenceSession.localVideoSessionId=null):(conferenceSession.hasLocalSharing=!1,conferenceSession.localSharingSessionId=null)}this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession)}dropRemoteVideoSession(conferenceSession,sessionId){if(conferenceSession){if(this.$log.info("[webConferenceService] dropRemoteVideoSession fom conference "+conferenceSession.id+" and session "+sessionId),conferenceSession.sessions[sessionId]){let session=conferenceSession.sessions[sessionId];this.updateStatisticsForSession(conferenceSession.id,sessionId),this.xmppService.connection.jingle.terminate(session.sid),delete conferenceSession.sessions[sessionId],delete this.videoService.callsStats[sessionId]}this.removeSessionFromVideoGallery(conferenceSession,sessionId),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession)}}getUserMediaForSession(webPontConferenceId){return this.$q((resolve,reject)=>{let conference=this.conferenceSessions[webPontConferenceId];if(!conference)return void reject();conference.status="ringing",conference.haveJoined=!0,this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conference);this.videoService.getBrowserMedia(["audio"]).then(stream=>{this.$log.info("[webConferenceService] getUserMediaForSession -- sucess");let conf=this.conferenceSessions[webPontConferenceId];if(!conf||"ended"===conf.status)return this.$log.info("[webConferenceService] getUserMediaForSession -- missing conference"),this.disableMediaStream(stream),void reject("conference does not exist anymore");if(!this.makingCall)return this.$log.info("[webConferenceService] getUserMediaForSession -- already in the conference -- ignore"),this.disableMediaStream(stream),void reject("ignore");let streams=[stream];conf.localStreams=streams,resolve()}).catch(()=>{this.$log.error("[webConferenceService] getUserMediaForSession error -- getUserMedia failed");this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"warning",popupBody:"devicePermission",okLabel:"ok"}),reject("failed to get user media")})})}disableMediaStream(stream){stream&&(stream.getTracks().forEach(track=>{track.enabled=!1,track.stop(),track=null}),stream.stop&&stream.stop(),stream=null)}initCall(jid,webPontConferenceId,callId,type){let conference=this.conferenceSessions[webPontConferenceId];return this.$q(resolve=>{conference||(this.$log.warn("[webConferenceService] initCall - no conferenceSession as though we are trying to init call"),resolve(this.makeSnapshotForConfId(webPontConferenceId,type))),resolve()}).then(()=>__awaiter(this,void 0,void 0,(function*(){yield this.videoService.setWebrtcConfiguration().catch(()=>{this.$log.error("[webConferenceService] initCall - setWebrtcConfiguration failed")});let unifiedPlan=!!this.videoService.config&&this.videoService.config.unifiedPlan,session=this.xmppService.connection.jingle.initiate(jid,this.xmppService.connection.jid,"audio",conference.localStreams,callId,webPontConferenceId,null,unifiedPlan);conference.jingleJid=jid,conference.sessions[session.sid]=session,conference.status="ringing",this.createStatisticsForSession(webPontConferenceId,session.sid),this.statsIntervals.push(session.getStats(5e3)),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conference)})))}muteAudio(conversation,state){if(conversation.webConferenceSession){for(let property in conversation.webConferenceSession.sessions)if(conversation.webConferenceSession.sessions.hasOwnProperty(property)){conversation.webConferenceSession.sessions[property].muteAudio(state)}conversation.isMutedAudio=state,this.$rootScope.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{conversation:conversation})}else this.$log.info("[webConferenceService] muteAudio trying to mute a non existing session ")}createStatisticsForSession(webConfId,sessionId){if(this.$log.info("[webConferenceService] createStatisticsForSession for conf "+webConfId+" and session "+sessionId),!webConfId||!sessionId)return void this.$log.warn("[webConferenceService] createStatisticsForSession -- missing parameters");this.videoService.callsStats[sessionId]={};let metrics=[];metrics.push({connectionId:sessionId,stats:this.videoService.callsStats[sessionId]}),this.videoService.createStatisticsForSession(webConfId,webConfId,"pending",metrics).then(id=>{this.$log.info("[webConferenceService] createStatisticsForSession success "+id),this.videoService.callsStats[sessionId].id=id,this.conferenceSessions[webConfId].metricsId=id,this.conferenceSessions[webConfId].metricsState="pending"}).catch(error=>{this.$log.error("[webConferenceService] createStatisticsForSession error for conf "+webConfId)})}updateStatisticsForSession(webConfId,sessionId){if(this.$log.info("[webConferenceService] updateStatisticsForSession for conf "+webConfId+" and session "+sessionId),!webConfId||!sessionId)return void this.$log.warn("[webConferenceService] updateStatisticsForSession -- missing parameters");let webConference=this.conferenceSessions[webConfId];if(!webConference||!webConference.metricsId)return void this.$log.warn("[webConferenceService] updateStatisticsForSession -- missing webConference or no metricsId");webConference.metricsState||(webConference.metricsState="pending");let metrics=[];this.videoService.callsStats[sessionId]&&Object.keys(this.videoService.callsStats[sessionId]).length&&(this.videoService.callsStats[sessionId].RainMetrics&&this.videoService.callsStats[sessionId].push(this.videoService.callsStats[sessionId].RainMetrics),metrics.push({connectionId:sessionId,stats:this.videoService.callsStats[sessionId]}),this.videoService.updateStatisticsForCall(webConference.metricsId,webConfId,webConfId,webConference.metricsState,metrics))}leaveWebConference(confId){if(this.$log.info(`[WebConferenceService] leaveWebConference - ${confId}`),this.contactService.resetBusyState(),!confId)return;let statsInterval,webConference=this.conferenceSessions[confId];if(webConference){webConference.metricsState="ended";for(let property in webConference.sessions)if(webConference.sessions.hasOwnProperty(property)){let session=webConference.sessions[property];this.updateStatisticsForSession(webConference.id,session.sid),this.videoService.disableAudioVideoMedia(session),this.xmppService.connection.jingle.terminate(session.sid),delete this.videoService.callsStats[session.sid]}for(webConference.cleanupSessionData(),this.createVideoGalleryElements(),webConference.videoGallery=this.videoGalleryElements,webConference.sessions={};this.statsIntervals.length;)(statsInterval=this.statsIntervals.pop())&&(window.clearInterval(statsInterval),statsInterval=null);this.makingCall=!1,this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",webConference),this.videoService.clearSrcObjectsFromElements()}else this.$log.warn("[WebConferenceService] leaveWebConference - webConference does not exist")}attachDistantMediaStream(attach,conferenceSession){if(attach){let sessions=this.getRemoteVideoSessions(conferenceSession.id);this.updateMainSessionIfNeeded(sessions),this.$log.info("[WebConferenceService] attachDistantMediaStream for session "+conferenceSession.id);let remoteSharingSession=this.getRemoteSharingSession(conferenceSession.id);if(remoteSharingSession&&(remoteSharingSession.remoteStreams.forEach(track=>{track.getVideoTracks().length>0&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),track,remoteSharingSession.sid)}),remoteSharingSession.remoteStreamsObject[0]&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),remoteSharingSession.remoteStreamsObject[0],remoteSharingSession.sid)),sessions.length)for(let sessionId in sessions)if(sessions.hasOwnProperty(sessionId)&&(sessions[sessionId].remoteStreams&&sessions[sessionId].remoteStreams.forEach(track=>{if(track.getVideoTracks().length>0){!remoteSharingSession&&sessions[sessionId].mainSession&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),track,sessions[sessionId].sid);for(let i=0;i<conferenceSession.videoGallery.length;i++)if(conferenceSession.videoGallery[i].sessionId===sessions[sessionId].sid){this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#"+conferenceSession.videoGallery[i].id),track,conferenceSession.videoGallery[i].sessionId);break}}}),sessions[sessionId].remoteStreamsObject[0])){!remoteSharingSession&&sessions[sessionId].mainSession&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),sessions[sessionId].remoteStreamsObject[0],sessions[sessionId].sid);for(let i=0;i<conferenceSession.videoGallery.length;i++)if(conferenceSession.videoGallery[i].sessionId===sessions[sessionId].sid){this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#"+conferenceSession.videoGallery[i].id),sessions[sessionId].remoteStreamsObject[0],conferenceSession.videoGallery[i].sessionId);break}}let audioSession=this.getRemoteAudioSession(conferenceSession.id);audioSession&&audioSession.remoteStreams&&audioSession.remoteStreams.forEach(track=>{track.getAudioTracks().length>0&&this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),track)}),audioSession&&audioSession.remoteStreamsObject[0]&&this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),audioSession.remoteStreamsObject[0])}}attachMainMediaStream(session){session&&(this.$log.info("[webConferenceService] attachMainMediaStream"),session.remoteStreams.forEach(track=>{track.getVideoTracks().length>0&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),track,session.sid)}))}updateMainSessionIfNeeded(sessions){if(this.$log.info("[webConferenceService] updateMainSessionIfNeeded"),sessions&&sessions.length){let firstSession=null,shouldUpdateMainScreen=!0;for(let property in sessions)sessions.hasOwnProperty(property)&&(firstSession||(firstSession=sessions[property]),sessions[property].mainSession&&(shouldUpdateMainScreen=!1));shouldUpdateMainScreen&&(firstSession.mainSession=!0)}}getRelatedRoomToActiveConferenceSession(){return this.webConferenceRoom}getRelatedRoomToActiveSharingOnlyConferenceSession(){return this.webrtcSharingOnlyRoom}getConferenceBySessionId(sessionId){let result=null;for(let webConference in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(webConference)&&this.conferenceSessions[webConference].sessions)for(let session in this.conferenceSessions[webConference].sessions)if(this.conferenceSessions[webConference].sessions.hasOwnProperty(session)&&this.conferenceSessions[webConference].sessions[session].sid===sessionId)return result=this.conferenceSessions[webConference];return result}getPontConfIdForRoom(room,mediaType=this.MEDIATYPE.WEBRTC){if(room.confEndpoints&&room.confEndpoints.length)for(let i=0;i<room.confEndpoints.length;i++)if(room.confEndpoints[i].mediaType===mediaType)return room.confEndpoints[i].confEndpointId;return""}getConferenceSessionById(confId){return this.conferenceSessions[confId]}getSfuConferenceSessionForRoom(room){var confSession=null;return room&&(confSession=this.conferenceSessions[room.getSFUConfEndpointId()]),confSession}updateWebConferenceInfos(endpoints){this.$log.info("[WebConferenceService] updateWebConferenceInfos"),Object.assign(this.conferenceEndpoints,endpoints),this.webrtcConferenceId=this.getWebRtcConfEndpointId(),this.webrtcConferenceId&&this.roomService.getRoomByConferenceEndpointId(this.webrtcConferenceId).then(conferenceRoom=>{let name="nothing";conferenceRoom&&(name=conferenceRoom.name),this.webConferenceRoom=conferenceRoom,this.$log.info("[WebConferenceService] === updateWebConferenceInfos : webrtcConferenceId is currently attached to "+name)},()=>{this.$log.info("[WebConferenceService] === updateWebConferenceInfos FAILURE ===")})}updateWebSharingOnlyConferenceInfos(endpoints){this.$log.info("[WebConferenceService] updateWebSharingOnlyConferenceInfos"),Object.assign(this.conferenceEndpoints,endpoints),this.webrtcSharingOnlyConferenceId=this.getWebRtcSharingOnlyConfEndpointId(),this.webrtcSharingOnlyConferenceId&&this.roomService.getRoomByConferenceEndpointId(this.webrtcSharingOnlyConferenceId).then(conferenceRoom=>{let name=conferenceRoom&&conferenceRoom.name?conferenceRoom.name:"nothing";this.webrtcSharingOnlyRoom=conferenceRoom,this.$log.info("[WebConferenceService] === updateWebSharingOnlyConferenceInfos : webrtcSharingOnlyConferenceId is currently attached to "+name)},()=>{this.$log.info("[WebConferenceService] === updateWebSharingOnlyConferenceInfos FAILURE ===")})}updateWebConferenceRoom(){return this.webrtcConferenceId=this.getWebRtcConfEndpointId(),this.$q((resolve,reject)=>{this.roomService.getRoomByConferenceEndpointId(this.webrtcConferenceId).then(conferenceRoom=>{let name="nothing";conferenceRoom&&(name=conferenceRoom.name),this.webConferenceRoom=conferenceRoom,this.$log.info("[WebConferenceService] === updateWebConferenceRoom : room is currently attached to "+name),resolve()},()=>{this.$log.info("[WebConferenceService] === updateWebConferenceRoom FAILURE==="),reject()})})}getWebRtcConfEndpointId(){for(let property in this.conferenceEndpoints)if(this.conferenceEndpoints.hasOwnProperty(property)&&this.conferenceEndpoints[property].mediaType===this.MEDIATYPE.WEBRTC)return this.conferenceEndpoints[property].id;return null}getWebRtcSharingOnlyConfEndpointId(){for(let property in this.conferenceEndpoints)if(this.conferenceEndpoints.hasOwnProperty(property)&&this.conferenceEndpoints[property].mediaType===this.MEDIATYPE.WEBRTCSHARINGONLY)return this.conferenceEndpoints[property].id;return null}isJoinWebConferenceAllowed(){return!0}getWebConference(confId){if(confId)return this.conferenceSessions[confId]}removeConferenceSession(confId){if(!confId)return;let statsInterval;for(this.removeAllJingleSessionsForConferenceSession(confId),delete this.conferenceSessions[confId];this.statsIntervals.length;)(statsInterval=this.statsIntervals.pop())&&(this.$interval.cancel(statsInterval),statsInterval=null);this.makingCall=!1}removeAllJingleSessionsForConferenceSession(confId){if(!confId)return;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession){conferenceSession.metricsState="ended";for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];this.updateStatisticsForSession(conferenceSession.id,session.sid),delete this.videoService.callsStats[session.sid],this.videoService.disableAudioVideoMedia(session),this.xmppService.connection.jingle.terminate(session.sid)}conferenceSession.sessions=[]}}hasActiveConferenceSession(){for(let property in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(property)&&this.conferenceSessions[property].type===this.MEDIATYPE.WEBRTC&&this.conferenceSessions[property].isActive()&&this.conferenceSessions[property].haveJoined)return!0;return!1}getActiveConferenceSession(){let result=null;for(let property in this.conferenceSessions)this.conferenceSessions.hasOwnProperty(property)&&this.conferenceSessions[property].type===this.MEDIATYPE.WEBRTC&&this.conferenceSessions[property].isActive()&&this.conferenceSessions[property].haveJoined&&(result=this.conferenceSessions[property]);return result}hasActiveSharingOnlyConferenceSession(){for(let property in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(property)&&this.conferenceSessions[property].type===this.MEDIATYPE.WEBRTCSHARINGONLY&&this.conferenceSessions[property].isActive())return!0;return!1}getActiveSharingOnlyConferenceSession(){let result=null;for(let property in this.conferenceSessions)this.conferenceSessions.hasOwnProperty(property)&&this.conferenceSessions[property].type===this.MEDIATYPE.WEBRTCSHARINGONLY&&this.conferenceSessions[property].isActive()&&(result=this.conferenceSessions[property]);return result}hasIncomingVideoStream(confId){if(!confId)return;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];if(!session.isInitiator&&("video"===session.remoteType||"sharing"===session.remoteType))return!0}return!1}getRemoteSessionsWithVideoOrSharingStreams(confId){let result=[];if(!confId)return result;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];session.isInitiator||"video"!==session.remoteType&&"sharing"!==session.remoteType||result.push(session)}return result}getRemoteSharingSession(confId){let result=null;if(!confId)return result;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];if(!session.isInitiator&&"sharing"===session.remoteType){result=session;break}}return result}getRemoteVideoSessions(confId){let result=[];if(!confId)return result;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];session.isInitiator||"video"!==session.remoteType||result.push(session)}return result}getRemoteAudioSession(confId){let result;if(!confId)return result;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];if("audio"===session.localType){result=session;break}}return result}getRemoteMainVideoSession(confId){let sess;if(!confId)return sess;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];if(!session.isInitiator&&"video"===session.remoteType&&session.mainSession){sess=session;break}}return sess}isAlreadySubscribedToPublisher(confId,publisherId){if(!confId||!publisherId)return!1;let result=!1,conferenceSession=this.conferenceSessions[confId];if(conferenceSession&&conferenceSession.videoGallery)for(let i=0;i<conferenceSession.videoGallery.length;i++)if(conferenceSession.videoGallery[i].publisherId===publisherId){result=!0;break}return result}relatePublisherToElement(confId,publisher,elementId){if(!confId||!publisher||!elementId)return!1;this.$log.info("[WebConferenceService] relatePublisherToElement");let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let i=0;i<conferenceSession.videoGallery.length;i++)if(conferenceSession.videoGallery[i].id===elementId){conferenceSession.videoGallery[i].state="busy",conferenceSession.videoGallery[i].publisherId=publisher.participantId,conferenceSession.videoGallery[i].publisherJidIm=publisher.jid_im,conferenceSession.videoGallery[i].displayName=publisher.participantId;let contact=this.contactService.getContactByJid(publisher.jid_im);contact&&(conferenceSession.videoGallery[i].displayName=contact.displayName);break}}getRelatedPublisherToElement(confId,elementId){if(!confId||!elementId)return null;this.$log.info("[WebConferenceService] getRelatedPublisherToElement");let result=null,conferenceSession=this.conferenceSessions[confId];if(conferenceSession&&conferenceSession.videoGallery)for(let i=0;i<conferenceSession.videoGallery.length;i++)if(elementId===conferenceSession.videoGallery[i].id&&conferenceSession.videoGallery[i].publisherId){result=conferenceSession.videoGallery[i];break}return result}getRelatedElementToPublisher(confId,publisherId){if(!confId||!publisherId)return null;this.$log.info("[WebConferenceService] getRelatedPublisherToElement");let element=null,conferenceSession=this.conferenceSessions[confId];if(conferenceSession&&conferenceSession.videoGallery)for(let i=0;i<conferenceSession.videoGallery.length;i++)if(conferenceSession.videoGallery[i].publisherId===publisherId){element=conferenceSession.videoGallery[i];break}return element}relateSessionToPublisher(confId,publisherId,sessionId){if(!confId||!publisherId||!sessionId)return!1;this.$log.info("[WebConferenceService] relateSessionToPublisher pubId "+publisherId+" sessionId "+sessionId);let result=!1,conferenceSession=this.conferenceSessions[confId];if(conferenceSession){for(let i=0;i<conferenceSession.videoGallery.length;i++)if(publisherId===conferenceSession.videoGallery[i].publisherId&&!conferenceSession.videoGallery[i].sessionId){conferenceSession.videoGallery[i].sessionId=sessionId,result=!0;break}this.$log.info(conferenceSession.videoGallery)}return result}removeSessionFromVideoGallery(conferenceSession,sessionId){if(conferenceSession&&sessionId){conferenceSession.videoGallery||(this.createVideoGalleryElements(),conferenceSession.videoGallery=this.videoGalleryElements),this.$log.info("[WebConferenceService] removeSessionFromVideoGallery for conference "+conferenceSession.id+" sessionId "+sessionId);for(let i=0;i<conferenceSession.videoGallery.length;i++)conferenceSession.videoGallery[i].sessionId===sessionId&&(conferenceSession.videoGallery[i].sessionId="",conferenceSession.videoGallery[i].state="free",conferenceSession.videoGallery[i].publisherId="",conferenceSession.videoGallery[i].publisherJidIm="",conferenceSession.videoGallery[i].displayName="")}}reInitialiseVideoGalleryElementById(conferenceSession,elementId){if(conferenceSession&&elementId){conferenceSession.videoGallery||(this.createVideoGalleryElements(),conferenceSession.videoGallery=this.videoGalleryElements),this.$log.info("[WebConferenceService] reInitialiseVideoGalleryElementById for conference "+conferenceSession.id+" elementId "+elementId);for(let i=0;i<conferenceSession.videoGallery.length;i++)conferenceSession.videoGallery[i].id===elementId&&(conferenceSession.videoGallery[i].sessionId&&this.dropRemoteVideoSession(conferenceSession,conferenceSession.videoGallery[i].sessionId),conferenceSession.videoGallery[i].sessionId="",conferenceSession.videoGallery[i].state="free",conferenceSession.videoGallery[i].publisherId="",conferenceSession.videoGallery[i].publisherJidIm="",conferenceSession.videoGallery[i].displayName="",conferenceSession.videoGallery[i].subStreamLevel=null)}}updateMainScreenSession(confId,sessionId){if(!confId||!sessionId)return;this.$log.info("[WebConferenceService] updateMainScreenSession");let conferenceSession=this.conferenceSessions[confId],session=null;if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let sess=conferenceSession.sessions[property];sessionId===sess.sid?(sess.mainSession=!0,session=sess):sess.mainSession=!1}session&&this.attachMainMediaStream(session)}getListOfAvailableRemoteVideoPublishers(confId){if(!confId)return;this.$log.info("[WebConferenceService] getListOfAvailableRemoteVideoPublishers");let conferenceSession=this.conferenceSessions[confId],publishers=[];return conferenceSession&&(conferenceSession.videoGallery||(this.createVideoGalleryElements(),conferenceSession.videoGallery=this.videoGalleryElements),publishers=(publishers=conferenceSession.getListOfRemoteVideoPublishers()).filter(publisher=>{for(let i=0;i<conferenceSession.videoGallery.length;i++)if(conferenceSession.videoGallery[i].publisherId===publisher.participantId)return!1;let contact=this.contactService.getContactByJid(publisher.jid_im);return publisher.displayName=contact?contact.displayName:publisher.participantId,!0})),publishers}sendTransportReplaceForSession(sess,timeout){if(!sess)return void this.$log.warn("[WebConferenceService] sendTransportReplaceForSession missing session !");if(this.reconnecting)return void this.$log.warn("[WebConferenceService] sendTransportReplaceForSession already reconnecting !");let that=this;this.reconnecting=!0,timeout||(timeout=1e3),this.$interval(session=>{if(that.reconnecting=!1,that.connected&&session&&session.peerconnection&&"stable"===session.peerconnection.signalingState&&("failed"===session.peerconnection.iceConnectionState||"disconnected"===session.peerconnection.iceConnectionState)&&(that.$log.info("[WebConferenceService] sendTransportReplaceForSession for session "+session.sid),session.connection=that.xmppService.connection,session.reconnectSession(),session.type!==that.MEDIATYPE.WEBRTCSHARINGONLY)){var state=session.hasLocalSharing?"sharing":"audio";that.contactService.setBusyState("dnd",state)}},timeout,1,!0,sess)}onAudioProfileChangeEvent(){if(this.$log.info("[WebConferenceService] onAudioProfileChangeEvent"),this.audioProfileChanging)this.$log.info("[WebConferenceService] onAudioProfileChangeEvent -- already changing");else for(let key in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(key)){let conferenceSession=this.conferenceSessions[key];for(let sessId in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(sessId)){let session=conferenceSession.sessions[sessId];"audio"===session.localType&&(this.audioProfileChanging=!0,this.$interval(sess=>{this.audioProfileChanging=!1;this.videoService.getBrowserMedia(["audio"]).then(stream=>{sess.removeStream(sess.localStreams[0]),this.videoService.stopActiveAudioVideoStreams(sess),sess.localStreams.push(stream),sess.addStream(sess.localStreams[0]),sess.sendTransportReplace()})},500,1,!0,session))}}}onJingleError(sessionId){this.$log.info("[WebConferenceService] onJingleError -- "+sessionId);let webConference=this.getConferenceBySessionId(sessionId);if(webConference&&webConference.sessions){"audio"===webConference.sessions[sessionId].localType?this.leaveWebConference(webConference.id):(this.updateStatisticsForSession(webConference.id,sessionId),webConference.localVideoSessionId===sessionId?this.removeMediaFromConferenceSession(webConference,"video"):webConference.localSharingSessionId===sessionId?this.removeMediaFromConferenceSession(webConference,"sharing"):(this.removeSessionFromVideoGallery(webConference,sessionId),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",webConference)))}}onIceConnectionDisconnectedForSession(conferenceSession,sessionId){if(this.$log.info("[WebConferenceService] onIceConnectionDisconnectedForSession -- "+sessionId),conferenceSession&&conferenceSession.sessions){let session=conferenceSession.sessions[sessionId];"audio"===session.localType?(conferenceSession.status="reconnecting",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession),this.connected&&this.sendTransportReplaceForSession(session,1e3)):conferenceSession.localVideoSessionId!==sessionId&&conferenceSession.localSharingSessionId!==sessionId||this.connected&&this.sendTransportReplaceForSession(session,1e3)}}onIceConnectionFailedForSession(conferenceSession,sessionId){if(this.$log.info("[WebConferenceService] onIceConnectionFailedForSession -- "+sessionId),conferenceSession&&conferenceSession.sessions){let session=conferenceSession.sessions[sessionId];"audio"===session.localType?(conferenceSession.status="reconnecting",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession),this.connected&&this.sendTransportReplaceForSession(session,500)):conferenceSession.localVideoSessionId===sessionId||conferenceSession.localSharingSessionId===sessionId?this.connected&&this.sendTransportReplaceForSession(session,500):(this.xmppService.connection.jingle.terminate(sessionId,"icefailed"),this.updateStatisticsForSession(conferenceSession.id,sessionId),delete this.videoService.callsStats[sessionId],this.removeSessionFromVideoGallery(conferenceSession,sessionId),delete conferenceSession.sessions[sessionId],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession))}}onIncomingCall(sessionId){this.$log.info("[WebConferenceService] onIncomingCall -- "+sessionId);let session=this.xmppService.connection.jingle.sessions[sessionId],pontConfId=session.confId,conferenceSession=this.conferenceSessions[pontConfId];if(conferenceSession){if(conferenceSession.sessions[sessionId]=session,session.localType=session.remoteType,session.sendAnswer(),session.accept(),session.publisherId&&"sharing"!==session.remoteType){if(!this.relateSessionToPublisher(pontConfId,session.publisherId,session.sid)){this.$log.info("[WebConferenceService] no gallery element related to session, attach to first available");let element=this.getFreeVideoGalleryElement(pontConfId);element&&!this.isAlreadySubscribedToPublisher(conferenceSession.id,session.publisherId)&&(element.state="busy",element.publisherId=session.publisherId,element.sessionId=session.sid)}}this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession),this.videoService.callsStats[session.sid]={},this.updateStatisticsForSession(conferenceSession.id,session.sid),this.statsIntervals.push(session.getStats(5e3))}else this.$log.error("[WebConferenceService] onIncomingCall no such conferenceSession "+pontConfId)}onTerminatedCall(sessionId){this.$log.info("[WebConferenceService] onTerminatedCall -- "+sessionId);let session=this.xmppService.connection.jingle.sessions[sessionId];if(!session){let conferenceSession=this.getActiveConferenceSession()?this.getActiveConferenceSession():this.getActiveSharingOnlyConferenceSession();if(conferenceSession&&conferenceSession.sessions){let sess=conferenceSession.sessions[sessionId];sess&&(conferenceSession.metricsState="ended"),sess&&"audio"===sess.localType?this.leaveWebConference(conferenceSession.id):conferenceSession.localVideoSessionId===sessionId?this.removeMediaFromConferenceSession(conferenceSession,"video"):conferenceSession.localSharingSessionId===sessionId?this.removeMediaFromConferenceSession(conferenceSession,"sharing"):(this.removeSessionFromVideoGallery(conferenceSession,sessionId),this.videoService.disableAudioVideoMedia(conferenceSession.sessions[sessionId]),delete conferenceSession.sessions[sessionId],delete this.videoService.callsStats[sessionId],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession))}return}let pontConfId=session.confId,conferenceSession=this.conferenceSessions[pontConfId];conferenceSession?(this.updateStatisticsForSession(conferenceSession.id,sessionId),conferenceSession.localVideoSessionId===sessionId?this.removeMediaFromConferenceSession(conferenceSession,"video"):conferenceSession.localSharingSessionId===sessionId?this.removeMediaFromConferenceSession(conferenceSession,"sharing"):(this.removeSessionFromVideoGallery(conferenceSession,sessionId),this.videoService.disableAudioVideoMedia(session),this.xmppService.connection.jingle.terminate(session.sid),delete conferenceSession.sessions[session.sid],delete this.videoService.callsStats[sessionId],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession))):this.$log.error("[WebConferenceService] onTerminatedCall no such conferenceSession "+pontConfId)}onConferenceCallSwitched(sessionId){this.$log.info("[WebConferenceService] onConferenceCallSwitched -- "+sessionId);let conferenceSession=this.getActiveConferenceSession();conferenceSession&&this.leaveWebConference(conferenceSession.id)}onIceConnectionStateChange(sessionId,session){this.$log.info("[WebConferenceService] onIceConnectionStateChange for session "+sessionId);let webConference=this.getConferenceBySessionId(sessionId);try{webConference&&session.peerconnection&&("stable"===session.peerconnection.signalingState&&"connected"===session.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection established successfully"),webConference.status="connected",session.remoteStreams&&session.remoteStreams.forEach(track=>{track.getAudioTracks().length>0&&(this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),track),this.videoService.resetAudioOutputElement(!0))}),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",webConference),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",webConference)),"stable"===session.peerconnection.signalingState&&"completed"===session.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection completed successfully"),"connected"!==webConference.status&&(webConference.status="connected",session.remoteStreams&&session.remoteStreams.forEach(track=>{track.getAudioTracks().length>0&&(this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),track),this.videoService.resetAudioOutputElement(!0))}),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",webConference),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",webConference))),"stable"===session.peerconnection.signalingState&&"disconnected"===session.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection State disconnected"),this.onIceConnectionDisconnectedForSession(webConference,sessionId)),"stable"===session.peerconnection.signalingState&&"failed"===session.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection State failed"),this.onIceConnectionFailedForSession(webConference,sessionId)))}catch(error){this.$log.error("[WebConferenceService] onIceConnectionStateChange error "+error)}}updateOrCreateConferenceSession(confId,snapshotData,type="webrtc"){if(this.$log.debug("[webConferenceService] updateOrCreateConferenceSession for "+confId),!confId||!snapshotData||!snapshotData.data)return this.$log.error("[webConferenceService] updateOrCreateConferenceSession - Not enough data"),null;let conferenceSession=this.conferenceSessions[confId];return conferenceSession?snapshotData.data.active!==conferenceSession.active&&(this.$log.debug("active"),conferenceSession.updateActiveState(snapshotData.data.active),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",conferenceSession)):(this.$log.debug("[webConferenceService] updateOrCreateConferenceSession - create new conferencesession with id "+confId+"and data: \n"+JSON.stringify(snapshotData.data)),conferenceSession=this.ConferenceSession.createFromData(confId,[],snapshotData.data.active,type),this.conferenceSessions[confId]=conferenceSession,this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",conferenceSession)),snapshotData.data.participants&&(this.$log.debug("[webConferenceService] updateOrCreateConferenceSession - (is active : "+conferenceSession.active+") update participants for "+confId+" with:\n"+JSON.stringify(snapshotData.data.participants)),conferenceSession.updateParticipants(snapshotData.data.participants).then(()=>{this.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",conferenceSession)})),conferenceSession}updateOrCreateWebConferenceEndpoint(conferenceData){if(this.$log.info("[WebConferenceService] updateOrCreateWebConferenceEndpoint for "+conferenceData.id),!conferenceData)return this.$log.error("[WebConferenceService] updateOrCreateWebConferenceEndpoint - no conference data !"),null;if(conferenceData.mediaType!==this.MEDIATYPE.WEBRTC&&conferenceData.mediaType!==this.MEDIATYPE.WEBRTCSHARINGONLY)return this.$log.error("[WebConferenceService] updateOrCreateWebConferenceEndpoint - wrong mediaType:"+conferenceData.mediaType),null;let conference=this.Conference.createFromData(conferenceData);return this.conferenceEndpoints[conferenceData.id]=conference,conference.mediaType===this.MEDIATYPE.WEBRTC?this.updateWebConferenceInfos([conference]):this.updateWebSharingOnlyConferenceInfos([conference]),this.conferenceEndpoints[conferenceData.id]}makeSnapshotForConfId(confId=null,mediaType){if(!confId){let errorMsg="[webConferenceService] makeSnapshotForConfId - No confId !!";return this.$log.error(errorMsg),this.$q.reject(errorMsg)}let confSession=this.conferenceSessions[confId];return confSession&&confSession.active&&confSession.haveJoined?(this.$log.debug("[WebConferenceService] makeSnapshotForConfId skipped, already joined"),this.$q.resolve(confSession)):this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.confPortalURL+confId+"/snapshot?mediaType=webrtc",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[webConferenceService] makeSnapshotForConfId success for confId "+confId);let snapshotData=response.data;this.updateOrCreateConferenceSession(confId,snapshotData,mediaType),resolve(snapshotData.data)}).catch(errorResponse=>{this.$log.info("[webConferenceService] makeSnapshotForConfId failure for confID "+confId),404===errorResponse.status?this.$log.error("[webConferenceService] makeSnapshotForConfId - confId "+confId+" not found on server"):this.$log.error("[webConferenceService] makeSnapshotForConfId - inconsistent object on server"),this.conferenceSessions[confId]&&this.removeConferenceSession(confId),reject()})})}refreshConferenceSessions(){return this.$log.info("[webConferenceService] refreshConferenceSessions"),this.$q((resolve,reject)=>{let promiseArray=[];for(let key in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(key)){let conferenceSession=this.conferenceSessions[key];promiseArray.push(this.makeSnapshotForConfId(conferenceSession.id,conferenceSession.type))}this.$q.all(promiseArray).then(()=>{this.$log.info("[webConferenceService] refreshConferenceSessions -- success"),resolve()}).catch(()=>{this.$log.error("[webConferenceService] refreshConferenceSessions -- error -- cleaning up all sessions"),this.removeAllConferenceSessions(),reject()})})}removeAllConferenceSessions(){this.$log.info("[webConferenceService] removeAllConferenceSessions");for(let key in this.conferenceSessions)this.conferenceSessions.hasOwnProperty(key)&&this.removeConferenceSession(key)}getConferenceSessionForRoom(roomConfEndpoints){let sfuSession=null;if(roomConfEndpoints&&roomConfEndpoints.length)for(let i=0;i<roomConfEndpoints.length;i++)roomConfEndpoints[i].mediaType!==this.MEDIATYPE.WEBRTC&&roomConfEndpoints[i].mediaType!==this.MEDIATYPE.WEBRTCSHARINGONLY||(sfuSession=this.conferenceSessions[roomConfEndpoints[i].confEndpointId]);return sfuSession}}WebConferenceService.$inject=["$q","$rootScope","$log","$http","uuid4","$interval","authService","xmppService","videoService","roomService","errorHelperService","ConferenceSession","contactService","platformService","Conference","profileService"],angular.module("rainbow").service("webConferenceService",WebConferenceService)},function(module,exports){class ConferenceService{constructor($q,$log,$rootScope,$interval,$translate,$http,xmppService,authService,Conference,profileService,contactService,webConferenceService,pstnConferenceService,roomService,errorHelperService){this.$q=$q,this.$log=$log,this.$rootScope=$rootScope,this.$interval=$interval,this.$translate=$translate,this.$http=$http,this.xmppService=xmppService,this.authService=authService,this.Conference=Conference,this.profileService=profileService,this.contactService=contactService,this.webConferenceService=webConferenceService,this.pstnConferenceService=pstnConferenceService,this.roomService=roomService,this.errorHelperService=errorHelperService,this.MEDIATYPE={PSTNAUDIO:"pstnAudio",WEBRTC:"webrtc",WEBRTCSHARINGONLY:"webrtcSharingOnly"},this.started=!1,this.listeners=[],this.conferenceRef=null,this.conferenceMngtRef=null,this.pgiConferenceProvisionRef=null}start(stats){return this.$q(resolve=>{let startDate=performance.now();return this.$log.info("[ConferenceService] === STARTING ==="),this.confProvPortalURL=config.restServerUrl+"/api/rainbow/confprovisioning/v1.0/",this.confPortalURL=config.restServerUrl+"/api/rainbow/conference/v1.0/conferences/",this.computePstnConferencePremission(),this.attachHandlers(),this.pstnConferenceService.retrievePstnPhoneNumbers(),this.retrieveConferences(null,!1).then(()=>this.makeSnapshots()).then(()=>{this.started=!0;let startDuration=Math.round(performance.now()-startDate);stats.push({service:"conferenceService",startDuration:startDuration}),this.$log.info("[ConferenceService] === STARTED ("+startDuration+" ms) ==="),resolve()}).catch(error=>{this.$log.info("[ConferenceService] === STARTING FAILURE === "+error.message),resolve()})})}stop(){return this.$q(resolve=>{this.$log.info(""),this.$log.info("[ConferenceService] === STOPPING ==="),this.listeners&&this.listeners.forEach(listener=>{listener()}),this.started=!1,this.$log.info("[ConferenceService] === STOPPED ==="),resolve()})}attachHandlers(){this.$log.info("[ConferenceService] attachHandlers"),this.conferenceRef&&(this.xmppService.connection.deleteHandler(this.conferenceRef),this.conferenceRef=null),this.conferenceRef=this.xmppService.connection.addHandler(stanza=>this.onConferenceUpdate(stanza),"jabber:iq:conference","message",null),this.conferenceMngtRef&&(this.xmppService.connection.deleteHandler(this.conferenceMngtRef),this.conferenceMngtRef=null),this.conferenceMngtRef=this.xmppService.connection.addHandler(stanza=>this.onConferenceManagement(stanza),null,"message","management"),this.listeners.push(this.$rootScope.$on("ON_PROFILE_FEATURES_UPDATED",()=>{this.onMyProfileFeaturesChanged()}))}reconnectService(){this.$log.info("[ConferenceService] reconnectService"),this.attachHandlers(),this.refreshConferenceSessions()}onMyProfileFeaturesChanged(){let wasPstnConferenceAvailable=this.pstnConferenceService.isPstnConferenceAvailable;if(this.computePstnConferencePremission(),wasPstnConferenceAvailable)this.pstnConferenceService.isPstnConferenceAvailable||this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"information",popupBody:"pgiRightsRemovedWarning",okLabel:"ok"});else if(this.pstnConferenceService.isPstnConferenceAvailable)return this.retrieveConferences(null,!1).then(()=>{if(!this.pstnConferenceService.pstnInstantConferenceEndpoint)return this.$q.when()}).then(()=>this.makeSnapshots())}computePstnConferencePremission(){let isConferenceAllowed=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CONFERENCE_ALLOWED),isConferenceProvisioningOnGoing=!0,profiles=this.profileService.getMyProfiles();profiles&&profiles.length>0&&profiles.forEach(profile=>{-1!==profile.profileName.toLowerCase().indexOf("conference")&&-1!==profile.status.toLowerCase().indexOf("active")&&profile.provisioningNeeded&&profile.provisioningNeeded.length>0&&profile.provisioningNeeded.forEach(provisioning=>{-1!==provisioning.providerType.toLowerCase().indexOf("pgi")&&(isConferenceProvisioningOnGoing=provisioning.provisioningOngoing)&&(this.$log.info("[ConferenceService] computePstnConferencePremission - pgi provisioning on going"),this.pgiConferenceProvisionRef&&(this.xmppService.connection.deleteHandler(this.pgiConferenceProvisionRef),this.pgiConferenceProvisionRef=null),this.pgiConferenceProvisionRef=this.xmppService.connection.addHandler(stanza=>this.onConferenceProvisionUpdate(stanza),null,"message","management"))})}),this.pstnConferenceService.isPstnConferenceAvailable=isConferenceAllowed&&!isConferenceProvisioningOnGoing,this.$rootScope.$broadcast("ON_CONFERENCE_FEATURES_UPDATED")}onConferenceProvisionUpdate(stanza){return $(stanza).find("confuseractivated ").length>0&&(this.pgiConferenceProvisionRef&&(this.xmppService.connection.deleteHandler(this.pgiConferenceProvisionRef),this.pgiConferenceProvisionRef=null),this.pstnConferenceService.isPstnConferenceAvailable=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CONFERENCE_ALLOWED),this.pstnConferenceService.isPstnConferenceAvailable&&this.retrieveConferences(null,!1).then(()=>this.makeSnapshots()),this.$rootScope.$broadcast("ON_CONFERENCE_FEATURES_UPDATED")),!0}getPstnInstantConferenceEndpoint(){return this.pstnConferenceService.pstnInstantConferenceEndpoint}getPstnInstantConferenceEndpointId(){return this.pstnConferenceService.pstnInstantConferenceEndpoint?this.pstnConferenceService.pstnInstantConferenceEndpoint.id:-1}getWebConferenceEndpoints(){return this.webConferenceService.conferenceEndpoints}makeSnapshotsForList(confEndpointsList){return this.$q(resolve=>{if(this.$log.info("[ConferenceService] makeSnapshotsForList"),!confEndpointsList||!confEndpointsList.length)return void resolve();let promiseArray=[];for(let i=0;i<confEndpointsList.length;i++)promiseArray.push(this.makeSnapshotForConfId(confEndpointsList[i].confEndpointId,confEndpointsList[i].mediaType));this.$q.all(promiseArray).finally(()=>{resolve(this.getConferenceSessionForRoom(confEndpointsList))})})}getConferenceSessionForRoom(roomConfEndpoints){let pstnSession=null,sfuSession=null;if(roomConfEndpoints&&roomConfEndpoints.length)for(let i=0;i<roomConfEndpoints.length;i++)roomConfEndpoints[i].mediaType===this.MEDIATYPE.PSTNAUDIO?pstnSession=this.pstnConferenceService.conferenceSessions[roomConfEndpoints[i].confEndpointId]:sfuSession=this.webConferenceService.conferenceSessions[roomConfEndpoints[i].confEndpointId];return pstnSession||sfuSession}getMatchingConferenceSession(roomConfEndpoints,id){let confSession=null;if(roomConfEndpoints&&roomConfEndpoints.length)for(let i=0;i<roomConfEndpoints.length;i++)roomConfEndpoints[i].confEndpointId===id&&(confSession=roomConfEndpoints[i].mediaType===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[id]:this.webConferenceService.conferenceSessions[id]);return confSession}makeSnapshots(){return this.$log.info("[ConferenceService] makeSnapshots"),this.$q(resolve=>{let snapshotPromiseList=[];this.pstnConferenceService.pstnInstantConferenceEndpoint&&snapshotPromiseList.push(this.makeSnapshotForConfId(this.pstnConferenceService.pstnInstantConferenceEndpoint.id,this.pstnConferenceService.pstnInstantConferenceEndpoint.mediaType));for(let property in this.webConferenceService.conferenceEndpoints)if(this.webConferenceService.conferenceEndpoints.hasOwnProperty(property)){let pontConf=this.webConferenceService.conferenceEndpoints[property];snapshotPromiseList.push(this.makeSnapshotForConfId(pontConf.id,pontConf.mediaType))}this.$q.all(snapshotPromiseList).finally(()=>{this.$log.info("[ConferenceService] makeSnapshots done"),resolve()})})}onConferenceUpdate(stanza){this.$log.info("[ConferenceService] onConferenceUpdate message: "+stanza.innerHTML);let conferenceId=$(stanza).find("conference-id").text(),mediaTypeElem=$(stanza).find("media-type"),mediaType=this.MEDIATYPE.PSTNAUDIO;if(mediaTypeElem&&mediaTypeElem.length&&mediaTypeElem.text&&(mediaType=$(mediaTypeElem[0]).text()),conferenceId){let conferenceSession=null;if(conferenceSession=mediaType===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[conferenceId]:this.webConferenceService.conferenceSessions[conferenceId])(conferenceSession.type!==this.MEDIATYPE.WEBRTC||conferenceSession.haveJoined)&&this.updateConferenceSession(stanza,conferenceSession);else switch(this.$log.info("[ConferenceService] no such session for ID "+conferenceId),mediaType){case"webrtc":break;case"webrtcsharing":let publisherElem=$(stanza).find("publisher"),jid_im=publisherElem.find("jid-im").text(),publisher={participantId:publisherElem.find("publisher-id").text(),mediaType:mediaType,jid_im:jid_im};this.subscribeToPublisher(conferenceId,publisher)}}return!0}onConferenceManagement(stanza){try{let confendpointElem=$(stanza).find("confendpoint");if(confendpointElem.length&&"update"===confendpointElem.attr("action")){this.$log.info("[ConferenceService] onConferenceManagement - update of conference");let conferenceId=$(stanza).find("confendpointid").text();return this.retrieveConference(conferenceId,!0).then(()=>{this.$rootScope.$broadcast("ON_CONFERENCE_DATA_UPDATED_EVENT",conferenceId)}),!0}return!0}catch(error){return!0}}makeSnapshotForConfId(confId,type=this.MEDIATYPE.PSTNAUDIO){return this.$log.info("[ConferenceService] makeSnapshotForConfId "+confId),this.$q((resolve,reject)=>{if(!confId){let error=new Error("[ConferenceService] makeSnapshotForConfId missing conf ID !");return this.$log.error(error.message),void reject(error)}let confSession=null;switch(type){case this.MEDIATYPE.PSTNAUDIO:confSession=this.pstnConferenceService.conferenceSessions[confId];break;case this.MEDIATYPE.WEBRTC:case this.MEDIATYPE.WEBRTCSHARINGONLY:confSession=this.webConferenceService.conferenceSessions[confId];break;default:this.$log.info("[ConferenceService] makeSnapshotForConfId : unknown type "+type)}if(confSession&&confSession.active&&confSession.haveJoined)return this.$log.debug("[ConferenceService] makeSnapshotForConfId skipped, already joined"),void resolve(confSession);let mediaType=type===this.MEDIATYPE.WEBRTC||type===this.MEDIATYPE.WEBRTCSHARINGONLY?this.MEDIATYPE.WEBRTC:this.MEDIATYPE.PSTNAUDIO;this.$http({method:"GET",url:this.confPortalURL+confId+"/snapshot?mediaType="+mediaType,headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[ConferenceService] makeSnapshotForConfId success for confId "+confId);let conferenceData=response.data;mediaType===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.updateOrCreateConferenceSession(confId,conferenceData):this.webConferenceService.updateOrCreateConferenceSession(confId,conferenceData,type),resolve(conferenceData.data)}).catch(errorResponse=>{this.$log.info("[ConferenceService] makeSnapshotForConfId failure for confID "+confId),404===errorResponse.status?this.$log.error("[ConferenceService] makeSnapshotForConfId - confId "+confId+" not found on server"):this.$log.error("[ConferenceService] makeSnapshotForConfId - inconsistent object on server"),mediaType===this.MEDIATYPE.PSTNAUDIO?delete this.pstnConferenceService.conferenceSessions[confId]:delete this.webConferenceService.conferenceSessions[confId];let error=this.errorHelperService.handleError(errorResponse);reject(error)})})}retrieveConferences(mediaType,scheduled,provisioning){switch(this.$log.info("[ConferenceService] retrieveConferences with mediaType="+mediaType+" and scheduled="+scheduled),mediaType){case this.MEDIATYPE.PSTNAUDIO:return this.pstnConferenceService.retrievePstnConferences(scheduled,provisioning);case this.MEDIATYPE.WEBRTC:case this.MEDIATYPE.WEBRTCSHARINGONLY:return this.webConferenceService.retrieveWebConferences(mediaType)}return this.$q((resolve,reject)=>{if(!this.pstnConferenceService.isPstnConferenceAvailable&&!this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED))return this.$log.warn("[ConferenceService] retrieveConferences - user is not allowed"),void reject(new Error("notAllowed"));let urlParameters="conferences?format=full&userId="+this.contactService.userContact.dbId;angular.isDefined(scheduled)&&(urlParameters+="&scheduled="+scheduled),this.$http({method:"GET",url:this.confProvPortalURL+urlParameters,headers:this.authService.getRequestHeader()}).then(response=>{let conferencesProvisionData=response.data.data;for(let conferenceData of conferencesProvisionData)switch(conferenceData.mediaType){case this.MEDIATYPE.PSTNAUDIO:this.pstnConferenceService.updateOrCreatePstnConferenceEndpoint(conferenceData);break;case this.MEDIATYPE.WEBRTC:case this.MEDIATYPE.WEBRTCSHARINGONLY:this.webConferenceService.updateOrCreateWebConferenceEndpoint(conferenceData)}this.$log.info("[ConferenceService] retrieveConferences successfully"),resolve(conferencesProvisionData)},response=>{let errorMessage="retrieveConferences failure: "+(response.data?response.data.errorDetails:response.data);this.$log.error("[ConferenceService] "+errorMessage),reject(new Error(errorMessage))})})}retrieveConference(confId,force=!1){return this.$log.info("[ConferenceService] retrieveConference"),confId?this.$q((resolve,reject)=>{!this.pstnConferenceService.pstnConferenceEndpoints[confId]||force?this.webConferenceService.conferenceEndpoints[confId]?resolve(this.webConferenceService.conferenceEndpoints[confId]):this.$http({method:"GET",url:this.confProvPortalURL+"conferences/"+confId,headers:this.authService.getRequestHeader()}).then(response=>{let conferenceData=response.data.data;if(conferenceData&&conferenceData.hasOwnProperty("id")){let conference=this.Conference.createFromData(conferenceData);conferenceData.mediaType===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.pstnConferenceEndpoints[conferenceData.id]=conference:this.webConferenceService.conferenceEndpoints[conferenceData.id]=conference}this.$log.info("[ConferenceService] retrieveConference successfully"),resolve(conferenceData)},response=>{let errorMessage="retrieveConference failure: "+(response.data?response.data.errorDetails:response.data);this.$log.error("[ConferenceService] "+errorMessage),reject(new Error(errorMessage))}):resolve(this.pstnConferenceService.pstnConferenceEndpoints[confId])}):(this.$log.warn("[ConferenceService] retrieveConference - missing confID"),this.$q.reject(new Error("retrieveConference - missing confID")))}updateConferenceSession(stanza,conferenceSession){this.$log.info("[ConferenceService] updateConferenceSession");let conferenceStateElem=$(stanza).find("conference-state");if(conferenceStateElem.length){let isConferenceActive="true"===conferenceStateElem.find("active").text(),isTalkerActive="true"===conferenceStateElem.find("talker-active").text(),isRecordingStarted="true"===conferenceStateElem.find("recording-started").text(),isLock="true"===conferenceStateElem.find("lock").text();this.updateState(conferenceSession,isConferenceActive,isTalkerActive,isRecordingStarted,isLock)}let talkersElem=$(stanza).find("talkers");if(talkersElem.length){let talkers=[];talkersElem.find("participant-id").each((__index,talker)=>{let talkerParticipantId=$(talker).text();talkers.push(talkerParticipantId)}),this.updateTalkers(conferenceSession,talkers)}let participantsElem=$(stanza).find("participants");if(0===participantsElem.length&&(participantsElem=$(stanza).find("updated-participants")),participantsElem.length||(participantsElem=$(stanza).find("added-participants")),participantsElem.length){let participants=[];participantsElem.find("participant").each((__index,participant)=>{let participantElem=$(participant),participantId=participantElem.find("participant-id").text(),jid_im=participantElem.find("jid-im").text(),phoneNumber=participantElem.find("phone-number").text(),role=participantElem.find("role").text(),mute=participantElem.find("mute").text(),hold=participantElem.find("hold").text(),cnxState=participantElem.find("cnx-state").text();participants.push({participantId:participantId,jid_im:jid_im,phoneNumber:phoneNumber,participantRole:role,mute:"on"===mute,held:"on"===hold,participantState:cnxState})}),participants.length>0&&this.createOrUpdateParticipants(conferenceSession,participants)}let removedParticipantsElem=$(stanza).find("removed-participants");if(removedParticipantsElem.length){let removedParticipants=[];removedParticipantsElem.find("participant-id").each((__index,removedParticipant)=>{let removedParticipantId=$(removedParticipant).text();removedParticipants.push(removedParticipantId)}),this.removeParticipants(conferenceSession,removedParticipants)}let updatedPublishers=$(stanza).find("added-publishers");updatedPublishers.length&&(updatedPublishers.find("publisher").each((__index,publisher)=>{let publisherElem=$(publisher),publisherId=publisherElem.find("publisher-id").text(),mediaType=publisherElem.find("media-type").text(),jid_im=publisherElem.find("jid-im").text();this.addPublisher(conferenceSession,publisherId,mediaType,jid_im)}),this.$rootScope.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",conferenceSession));let removedPublishers=$(stanza).find("removed-publishers");removedPublishers.length&&(removedPublishers.find("publisher").each((__index,publisher)=>{let publisherElem=$(publisher),publisherId=publisherElem.find("participant-id").text(),mediaType=publisherElem.find("media-type").text();for(let i=0;i<conferenceSession.publishers.length;i++){let pub=conferenceSession.publishers[i];if(pub.participantId===publisherId&&pub.mediaType===mediaType){conferenceSession.publishers.splice(i,1);break}}if("video"===mediaType&&this.webConferenceService.isAlreadySubscribedToPublisher(conferenceSession.id,publisherId)){this.$log.info("[ConferenceService] removed-publishers : subscribed to this publisher, so re-init the element");let element=this.webConferenceService.getRelatedElementToPublisher(conferenceSession.id,publisherId);element&&this.webConferenceService.reInitialiseVideoGalleryElementById(conferenceSession,element.id)}}),this.$rootScope.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",conferenceSession));let publishers=$(stanza).find("publishers");return publishers.length&&(publishers.find("publisher").each((__index,publisher)=>{let publisherElem=$(publisher),publisherId=publisherElem.find("publisher-id").text(),mediaType=publisherElem.find("media-type").text(),jid_im=publisherElem.find("jid-im").text();this.addPublisher(conferenceSession,publisherId,mediaType,jid_im)}),this.$rootScope.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",conferenceSession)),!0}updateState(conferenceSession,isConferenceActive,isTalkerActive,isRecordingStarted,lock=!1){if(isConferenceActive||this.contactService.resetBusyState(),conferenceSession.active&&!isConferenceActive){if(this.contactService.userContact.guestMode&&conferenceSession.type!==this.MEDIATYPE.WEBRTCSHARINGONLY)this.$rootScope.$broadcast("ON_OPEN_POPUP","concludeInvitationEndMeeting");else{let rooms=this.roomService.findRoomsWithConfId(conferenceSession.id);if(rooms&&rooms.length)if(rooms[0].owner)conferenceSession.id===this.getPstnInstantConferenceEndpointId()&&rooms[0].isMyPersonalMeetingRoom()&&this.$rootScope.$broadcast("ON_OPEN_RENAME_MEETING_POPUP",{meetingRoomId:rooms[0].dbId,confEndpointId:this.getPstnInstantConferenceEndpointId()});else switch(conferenceSession.type){case this.MEDIATYPE.WEBRTCSHARINGONLY:break;case this.MEDIATYPE.PSTNAUDIO:case this.MEDIATYPE.WEBRTC:default:if(conferenceSession.isParticipantConnectedByJid(this.contactService.userContact.dbId)){let displayName=_escape(rooms[0].ownerContact.displayName),roomName=_escape(rooms[0].name),message=this.$translate.instant("meetingEndBy",{owner:displayName,meeting:roomName});this.$rootScope.$broadcast("GLOBAL_NOTIFY_MESSAGE_EVENT",message)}}}conferenceSession.participants=[],conferenceSession.status="ended"}conferenceSession.updateStateFromData(isConferenceActive,isTalkerActive,isRecordingStarted,lock),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",conferenceSession)}updateTalkers(conferenceSession,talkers){conferenceSession.updateTalkers(talkers),this.$rootScope.$broadcast("ON_CONFERENCE_TALKER_EVENT",conferenceSession)}createOrUpdateParticipants(conferenceSession,participants){conferenceSession.updateParticipants(participants).then(result=>{if(conferenceSession.participants.find(participant=>participant.jid_im===this.contactService.userContact.id&&"disconnected"!==participant.state)&&conferenceSession.type===this.MEDIATYPE.WEBRTC){var state=conferenceSession.hasLocalSharing?"sharing":"audio";this.contactService.setBusyState("dnd",state)}this.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",conferenceSession),"webrtc"===conferenceSession.type&&result&&this.$rootScope.$broadcast("ON_WEB_CONFENRECE_PARTICIPANT_JOINED_EVENT",conferenceSession)})}removeParticipants(conferenceSession,removedParticipants){if(conferenceSession.removeParticipants(removedParticipants),!conferenceSession.participants.find(participant=>participant.jid_im===this.contactService.userContact.id))switch(this.contactService.resetBusyState(),conferenceSession.type){case this.MEDIATYPE.WEBRTC:if(this.webConferenceService.removeAllJingleSessionsForConferenceSession(conferenceSession.id),conferenceSession.active){let room=this.roomService.findRoomsWithConfId(conferenceSession.id);if(room.length&&!this.webConferenceService.isMyConference(conferenceSession.id)){let name=_escape(room[0].name),message=this.$translate.instant("meetingDisconnect",{meeting:name});this.$rootScope.$broadcast("GLOBAL_NOTIFY_MESSAGE_EVENT",message)}}conferenceSession.cleanupSessionData();break;case this.MEDIATYPE.WEBRTCSHARINGONLY:this.webConferenceService.removeAllJingleSessionsForConferenceSession(conferenceSession.id),conferenceSession.cleanupSessionData();break;case this.MEDIATYPE.PSTNAUDIO:}this.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",conferenceSession)}addPublisher(conferenceSession,publisherId,mediaType,jid){let toAdd=!0;for(let i=0;i<conferenceSession.publishers.length;i++){let pub=conferenceSession.publishers[i];if(pub.participantId===publisherId&&pub.mediaType===mediaType){toAdd=!1;break}}let publisher={participantId:publisherId,mediaType:mediaType,jid_im:jid};if(toAdd&&conferenceSession.publishers.push(publisher),toAdd&&"video"===mediaType){let element=this.webConferenceService.getFreeVideoGalleryElement(conferenceSession.id);element&&!this.webConferenceService.isAlreadySubscribedToPublisher(conferenceSession.id,publisher.participantId)&&(this.$log.info("[ConferenceService] will subscribe to publisher "+conferenceSession.id+" for id "+publisherId+"and element id "+element.id+" in few moments"),element.state="busy",element.publisherId=publisher.participantId,this.$interval((confSession,newPublisher,elemToSubscribe)=>{"busy"===elemToSubscribe.state&&elemToSubscribe.publisherId===newPublisher.participantId&&(this.$log.info("[ConferenceService] subscribe to publisher "+confSession.id+" for id "+newPublisher.participantId+"and element id "+elemToSubscribe.id),this.subscribeToPublisher(confSession.id,newPublisher,elemToSubscribe.id).catch(()=>{this.$log.error("[ConferenceService] subscribe to publisher failed, reset the video gallery element with id "+elemToSubscribe.id),this.webConferenceService.reInitialiseVideoGalleryElementById(confSession,elemToSubscribe.id)}))},2500,1,!0,conferenceSession,publisher,element))}}stopConference(confId="",type=this.MEDIATYPE.PSTNAUDIO,roomId=""){if(this.$log.info("[ConferenceService] stopConference( confId="+confId+", type="+type+")"),!confId||!roomId&&type!==this.MEDIATYPE.PSTNAUDIO)return this.$log.warn("[ConferenceService] stopConference missing conf ID or roomID"),this.$q.reject();let conferenceSession=this.pstnConferenceService.conferenceSessions[confId]?this.pstnConferenceService.conferenceSessions[confId]:this.webConferenceService.conferenceSessions[confId];return conferenceSession&&conferenceSession.isActive()?this.$q((resolve,reject)=>{this.$http({method:"PUT",url:this.confPortalURL+confId+"/stop",headers:this.authService.getPostHeader(),data:{mediaType:type,roomId:roomId}}).then(()=>{this.contactService.resetBusyState();let session=null;(session=type===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[confId]:this.webConferenceService.conferenceSessions[confId])&&(this.updateState(session,!1,!1,!1),session.cleanupSessionData(),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",session)),this.$log.info("[ConferenceService] stopConference( confId="+confId+") successfully"),resolve()},response=>{let msg=response.data?response.data.errorDetails:response.data,errorMessage="stopConference( confId="+confId+") failure: "+msg;if(this.$log.error("[ConferenceService] "+errorMessage),404e3!==response.data.errorDetailsCode)this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"warning",popupBody:"stopMeetingFailure",okLabel:"ok"});else{let session=null;(session=type===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[confId]:this.webConferenceService.conferenceSessions[confId])&&(session.active=!1,session.participants=[],this.removeConferenceSession(session),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",session))}reject(new Error(errorMessage))})}):(this.$log.warn("[ConferenceService] stopConference - no active conference session to stop"),this.$q.reject())}removeConferenceSession(conferenceSession=null){conferenceSession&&(conferenceSession.type===this.MEDIATYPE.WEBRTC||conferenceSession.type===this.MEDIATYPE.WEBRTCSHARINGONLY?this.webConferenceService.removeConferenceSession(conferenceSession.id):delete this.pstnConferenceService.conferenceSessions[conferenceSession.id])}disconnectsParticipant(confId,participantId,mediaType=this.MEDIATYPE.PSTNAUDIO){return confId&&participantId?this.$q((resolve,reject)=>{this.$log.info("[ConferenceService] disconnectsParticipant( confId="+confId+"participantId="+participantId+")"),this.$http({method:"DELETE",url:this.confPortalURL+confId+"/participants/"+participantId+"?mediaType="+mediaType,headers:this.authService.getRequestHeader()}).then(()=>{this.$log.info("[ConferenceService] disconnectsParticipant( confId="+confId+"participantId="+participantId+") successfully"),resolve()},response=>{let msg=response.data?response.data.errorDetails:response.data,errorMessage="disconnectsParticipant( confId="+confId+"participantId="+participantId+") failure: "+msg;this.$log.error("[ConferenceService] "+errorMessage),reject(new Error(errorMessage))})}):(this.$log.warn("[ConferenceService] disconnectsParticipant missing conf ID or participantId"),this.$q.reject())}updateConference(confEndpointId,confData,mediaType=this.MEDIATYPE.PSTNAUDIO){if(mediaType===this.MEDIATYPE.PSTNAUDIO)return this.pstnConferenceService.updateConference(confEndpointId,confData);this.webConferenceService.updateConference(confEndpointId,confData)}updateConferenceState(confId,option,mediaType=this.MEDIATYPE.PSTNAUDIO){return this.$log.info("[ConferenceService] updateConferenceState( confId="+confId+", option="+option+" mediaType="+mediaType+")"),confId&&option?this.$q((resolve,reject)=>{let conferenceSession=null;if(!(conferenceSession=mediaType===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[confId]:this.webConferenceService.conferenceSessions[confId]))return this.$log.error("[ConferenceService] updateConferenceState - no corresponding conference session to update"),void reject();this.$http({method:"PUT",url:this.confPortalURL+confId+"/update",headers:this.authService.getRequestHeader(),data:{option:option,mediaType:conferenceSession.type}}).then(response=>{let conferenceData=response.data.data;this.$log.info("[ConferenceService] updateConferenceState( confId="+confId+") successfully"),resolve(conferenceData)},response=>{let msg=response.data?response.data.errorDetails:response.data,errorMessage="updatsConferenceState( confId="+confId+") failure: "+msg;this.$log.error("[ConferenceService] "+errorMessage),reject(new Error(errorMessage))})}):(this.$log.error("[ConferenceService] updateConferenceState - missing a parameter"),this.$q.reject())}updateParticipantState(confId,participantId,option,mediaType=this.MEDIATYPE.PSTNAUDIO,media=null,bitRate=null,subStreamLevel=null,publisherId=null){return this.$log.info("[ConferenceService] updateParticipantState( confId="+confId+"participantId="+participantId+" option="+option+" mediaType="+mediaType+")"),confId&&participantId&&option?this.$q((resolve,reject)=>{let conferenceSession=null;if(!(conferenceSession=mediaType===this.MEDIATYPE.PSTNAUDIO?this.pstnConferenceService.conferenceSessions[confId]:this.webConferenceService.conferenceSessions[confId]))return this.$log.error("[ConferenceService] updateParticipantState - no corresponding conference session to update"),void reject();let data={option:option,mediaType:conferenceSession.type};media&&(data.media=media),bitRate&&(data.bitRate=bitRate),publisherId&&(data.publisherId=publisherId),subStreamLevel&&(data.subStreamLevel=subStreamLevel),this.$http({method:"PUT",url:this.confPortalURL+confId+"/participants/"+participantId,headers:this.authService.getRequestHeader(),data:data}).then(response=>{let status=response.data;this.$log.info("[ConferenceService] updateParticipantState( confId="+confId+"participantId="+participantId+") successfully"),resolve(status)},response=>{let msg=response.data?response.data.errorDetails:response.data,errorMessage="updateParticipantState( confId="+confId+"participantId="+participantId+") failure: "+msg;this.$log.error("[ConferenceService] "+errorMessage),reject(new Error(errorMessage))})}):(this.$log.error("[ConferenceService] updateParticipantState - missing a parameter"),this.$q.reject())}retrievePstnPhoneNumbers(shouldFormatResults=!1){return this.pstnConferenceService.retrievePstnPhoneNumbers(shouldFormatResults)}joinPstnConference(confId,participantPhoneNumber,participant,country,room){return this.$q((resolve,reject)=>{if(this.$log.info("[ConferenceService] joinPstnConference with ( confId = "+confId+" participantPhoneNumber = "+participantPhoneNumber+" country = "+country+" )"),!confId||!room)return this.$log.error("[ConferenceService] joinPstnConference - missing parameter"),void reject(new Error("[ConferenceService] joinPstnConference - missing parameter"));resolve(this.pstnConferenceService.initiatesCallParticipant(confId,participantPhoneNumber,participant,country))})}subscribeToPublisher(confId="",publisher=null,elementId=""){return this.$q((resolve,reject)=>{if(!confId||!publisher)return this.$log.warn("[ConferenceService] subscribeToPublisher missing parameters !! Ignore !"),void resolve();this.$log.info("[ConferenceService] subscribeToPublisher for confId "+confId+" and publisher "+publisher.participantId),elementId&&this.webConferenceService.relatePublisherToElement(confId,publisher,elementId),this.$http({method:"POST",url:this.confPortalURL+confId+"/participants/"+publisher.participantId+"/subscribe",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[ConferenceService] subscribeToPublisher successfully"),resolve(response.data)},response=>{let errorMessage="subscribeToPublisher failure: "+(response.data?response.data.errorDetails:response.data);this.$log.error("[ConferenceService] "+errorMessage),reject(new Error(errorMessage))})})}isUserContactInCall(){for(let property in this.webConferenceService.conferenceSessions)if(this.webConferenceService.conferenceSessions.hasOwnProperty(property)){if(this.webConferenceService.conferenceSessions[property].isParticipantConnectedByJid(this.contactService.userContact.jid))return!0}return!1}stopAllConferencesFromRoom(room){var stopConferenceArray=[],pstnConfId=room.getPstnConfEndpointId(),webSharingConfId=room.getSFUSharingConfEndpointId(),sfuConfId=room.getSFUConfEndpointId();return pstnConfId&&stopConferenceArray.push(this.stopConference(pstnConfId)),webSharingConfId&&stopConferenceArray.push(this.stopConference(webSharingConfId,"webrtc")),sfuConfId&&stopConferenceArray.push(this.stopConference(sfuConfId,"webrtc")),this.$q.all(stopConferenceArray)}refreshConferenceSessions(){let promoseArray=[];return promoseArray.push(this.webConferenceService.refreshConferenceSessions()),promoseArray.push(this.pstnConferenceService.refreshConferenceSessions()),this.$q.all(promoseArray)}}ConferenceService.$inject=["$q","$log","$rootScope","$interval","$translate","$http","xmppService","authService","Conference","profileService","contactService","webConferenceService","pstnConferenceService","roomService","errorHelperService"],angular.module("rainbow").service("conferenceService",ConferenceService)},function(module,exports){angular.module("rainbow").service("profileService",["$q","$rootScope","$log","$http","$interval","Offer","authService","contactService","xmppService",function($q,$rootScope,$log,$http,$interval,Offer,authService,contactService,xmppService){"use strict";var service=this;service.FeaturesEnum={COMPANY_ADMIN_COUNT:"COMPANY_ADMIN_COUNT",COMPANY_LOGO_MODIFICATION:"COMPANY_LOGO_MODIFICATION",COMPANY_DOMAIN_NAME_MODIFICATION:"COMPANY_DOMAIN_NAME_MODIFICATION",COMPANY_DETAILS_MODIFICATION:"COMPANY_DETAILS_MODIFICATION",COMPANY_SINGLE_SIGN_ON_SAML:"COMPANY_SINGLE_SIGN_ON_SAML",COMPANY_SINGLE_SIGN_ON_OIDC:"COMPANY_SINGLE_SIGN_ON_OIDC",WEBRTC_FOR_MOBILE:"WEBRTC_FOR_MOBILE",BUBBLE_PARTICIPANT_COUNT:"BUBBLE_PARTICIPANT_COUNT",TELEPHONY_BASIC_CALL:"TELEPHONY_BASIC_CALL",TELEPHONY_SECOND_CALL:"TELEPHONY_SECOND_CALL",TELEPHONY_TRANSFER_CALL:"TELEPHONY_TRANSFER_CALL",TELEPHONY_CONFERENCE_CALL:"TELEPHONY_CONFERENCE_CALL",TELEPHONY_DEFLECT_CALL:"TELEPHONY_DEFLECT_CALL",TELEPHONY_PHONE_BOOK:"TELEPHONY_PHONE_BOOK",TELEPHONY_VOICE_MAIL:"TELEPHONY_VOICE_MAIL",TELEPHONY_CALL_FORWARD:"TELEPHONY_CALL_FORWARD",TELEPHONY_NOMADIC:"TELEPHONY_NOMADIC",CONFERENCE_PARTICIPANT_COUNT:"CONFERENCE_PARTICIPANT_COUNT",CONFERENCE_PARTICIPANT_ALLOWED:"CONFERENCE_PARTICIPANT_ALLOWED",WEBRTC_CONFERENCE_ALLOWED:"WEBRTC_CONFERENCE_ALLOWED",WEBRTC_CONFERENCE_PARTICIPANT_COUNT:"WEBRTC_CONFERENCE_PARTICIPANT_COUNT",WEBRTC_PARTICIPANT_ALLOWED:"WEBRTC_PARTICIPANT_ALLOWED",CONFERENCE_ALLOWED:"CONFERENCE_ALLOWED",CONFERENCE_DIAL_OUT:"CONFERENCE_DIAL_OUT",CONFERENCE_RECORDING:"CONFERENCE_RECORDING",MSO365_CALENDAR_PRESENCE:"MSO365_CALENDAR_PRESENCE",MSO365_DIRECTORY_PROVISIONING:"MSO365_DIRECTORY_PROVISIONING",MSO365_DIRECTORY_SEARCH:"MSO365_DIRECTORY_SEARCH",MSO365_CONTACT_SEARCH:"MSO365_CONTACT_SEARCH",MS_OUTLOOK_PLUGIN:"MS_OUTLOOK_PLUGIN",MS_SKYPE_PLUGIN:"MS_SKYPE_PLUGIN",FILE_SHARING_QUOTA_GB:"FILE_SHARING_QUOTA_GB",GOOGLE_CALENDAR_PRESENCE:"GOOGLE_CALENDAR_PRESENCE",WEBRTC_P2P_RECORDING:"WEBRTC_P2P_RECORDING",BUBBLE_PROMOTE_MEMBER:"BUBBLE_PROMOTE_MEMBER",BUBBLE_GUESTS_ALLOWED:"BUBBLE_GUESTS_ALLOWED",TELEPHONY_WEBRTC_GATEWAY:"TELEPHONY_WEBRTC_GATEWAY",TELEPHONY_WEBRTC_PSTN_CALLING:"TELEPHONY_WEBRTC_PSTN_CALLING",ANALYTICS_DASHBOARD_EC:"ANALYTICS_DASHBOARD_EC",ANALYTICS_DASHBOARD_BP:"ANALYTICS_DASHBOARD_BP",TELEPHONY_CALL_SUBJECT:"CALL_SUBJECT",CHANNEL_CREATE:"CHANNEL_CREATE",CHANNEL_CREATE_ADMIN_ROLE_BYPASS:"CHANNEL_CREATE_ADMIN_ROLE_BYPASS",CHANNEL_ACTIVATED:"CHANNEL_ACTIVATED",MANAGE_ANDROID_TV:"MANAGE_ANDROID_TV",USE_ANDROID_TV:"USE_ANDROID_TV",MASSPRO_USER_PROVISIONING_CSV:"MASSPRO_USER_PROVISIONING_CSV",SEARCH_BY_TAGS:"SEARCH_BY_TAGS",TELEPHONY_3DPARTY_ASSOC:"TELEPHONY_3DPARTY_ASSOC",WEBCLIENT_UI_2_0:"WEBCLIENT_UI_2_0",WEBRTC_UNIFIED_PLAN:"WEBRTC_UNIFIED_PLAN",USE_CLOUD_PBX:"USE_CLOUD_PBX"},service.started=!1,service.start=function(stats){$log.info(""),$log.info("[profileService] === STARTING ==="),service.features={},service.profiles=[],service.mainOffers=[],service.thirdPartyApps=null;var startDate=performance.now();return service.attachHandlers(),$q((function(resolve,reject){service.getServerProfile().then((function(){service.started=!0;var startDuration=Math.round(performance.now()-startDate);stats.push({service:"profileService",startDuration:startDuration}),$log.info("[profileService] === STARTED ("+startDuration+" ms) ==="),$rootScope.$broadcast("ON_PROFILE_FEATURES_UPDATED"),resolve()})).catch((function(error){$log.info("[profileService] === STARTING FAILURE === "+error.message),reject(error)}))}))},service.stop=function(){return $log.info("[profileService] === STOPPING ==="),service.detachHandlers(),service.started=!1,$log.info("[profileService] === STOPPED ==="),$q.when()},service.attachHandlers=function(){service.detachHandlers(),$log.info("[profileService] attachHandlers"),this.profileEventHandler=xmppService.addHandler(service.onManagementMessageReceived,null,"message","management")},service.detachHandlers=function(){$log.info("[profileService] detachHandlers"),this.profileEventHandler&&(xmppService.deleteHandler(this.profileEventHandler),this.profileEventHandler=null)},service.restart=function(){$log.info("[profileService] === RESTART ==="),service.attachHandlers(),service.onUserUpdateNeeded()},service.onManagementMessageReceived=function(stanza){try{var userprofileElem=$(stanza).find("userprofile");if($log.info("[profileService] onManagementMessageReceived  -- on userprofile management message received"),userprofileElem.length)switch(userprofileElem.attr("action")){case"create":case"update":case"delete":service.onUserUpdateNeeded();break;default:$log.info("[profileService] onManagementMessageReceived  -- unknown action")}return!0}catch(error){return $log.error("[profileService] onManagementMessageReceived ERROR "+error),!0}},service.onUserUpdateNeeded=function(){service.timer||(service.timer=$interval((function(){service.getServerProfile().then((function(){$rootScope.$broadcast("ON_PROFILE_FEATURES_UPDATED"),service.timer=null})).catch((function(error){service.timer=null,$log.info("[profileService] === onUserUpdateNeeded FAILURE === "+error.message)}))}),3e3,1))},service.getServerProfile=function(){return $q.all([service.getServerProfiles(),service.getServerProfilesFeatures()])},service.getServerProfiles=function(){return $q((function(resolve,reject){$http({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+contactService.userContact.dbId+"/profiles",headers:authService.getRequestHeader()}).then((function(response){service.profiles=[],service.mainOffers=[],response.data.data.forEach((function(profileData){$log.debug("[profileService] getServerProfiles === response ==="+profileData),service.profiles.push(profileData);var offer=Offer.createFromProfileData(profileData);(offer.isExclusive||offer.isDefault)&&service.mainOffers.push(offer)})),service.mainOffers.sort(Offer.offerComparator),resolve()}),(function(response){var errorMessage="getServerProfiles failure: no server response";response&&(errorMessage="getServerProfiles failure: "+JSON.stringify(response)),$log.error("[profileService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.getServerProfilesFeatures=function(){return $q((function(resolve,reject){$http({method:"GET",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+contactService.userContact.dbId+"/profiles/features",headers:authService.getRequestHeader()}).then((function(response){service.features={},response.data.data.forEach((function(featureData){$log.debug("[profileService] getServerProfilesFeatures === response ==="+JSON.stringify(featureData)),featureData.hasOwnProperty("featureUniqueRef")&&(service.features[featureData.featureUniqueRef]=featureData)})),resolve()}),(function(response){var errorMessage="getServerProfilesFeatures failure: no server response";response&&(errorMessage="getServerProfilesFeatures failure: "+JSON.stringify(response)),$log.error("[profileService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.getUserData=function(){return authService.getUserData()},service.setUserData=function(params){return $q((function(resolve,reject){var url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+contactService.userContact.dbId;$http({method:"PUT",url:url,headers:authService.getRequestHeader(),data:params}).then((function(result){$log.info("[profileService] setUserData "+JSON.stringify(params)+" -- success"),resolve(result.data)}),(function(response){var errorMessage="setUserData failure: no server response";response&&(errorMessage="setUserData failure: "+JSON.stringify(response)),$log.error("[profileService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.isFeatureEnabled=function(featureUniqueRef,features){if(features||(features=service.features),service.started&&features.hasOwnProperty(featureUniqueRef)&&features[featureUniqueRef].hasOwnProperty("featureType")&&"boolean"===features[featureUniqueRef].featureType&&features[featureUniqueRef].hasOwnProperty("isEnabled")){var enabled=features[featureUniqueRef].isEnabled;return $log.debug("[profileService] isFeatureEnabled("+featureUniqueRef+"): "+enabled),enabled}return $log.info("[profileService] isFeatureEnabled("+featureUniqueRef+"): service not started or feature not enabled"),!1},service.getFeatureLimitMax=function(featureUniqueRef){if(service.started&&service.features.hasOwnProperty(featureUniqueRef)&&service.features[featureUniqueRef].hasOwnProperty("featureType")&&"number"===service.features[featureUniqueRef].featureType&&service.features[featureUniqueRef].hasOwnProperty("limitMax")){var limitMax=service.features[featureUniqueRef].limitMax;return $log.debug("[profileService] getFeatureLimitMax("+featureUniqueRef+"): "+limitMax),limitMax}return $log.info("[profileService] getFeatureLimitMax("+featureUniqueRef+"): service not started or feature not enabled"),0},service.getFeatureLimitMin=function(featureUniqueRef){if(service.started&&service.features.hasOwnProperty(featureUniqueRef)&&service.features[featureUniqueRef].hasOwnProperty("featureType")&&"number"===service.features[featureUniqueRef].featureType&&service.features[featureUniqueRef].hasOwnProperty("limitMin")){var limitMin=service.features[featureUniqueRef].limitMin;return $log.debug("[profileService] getFeatureLimitMin("+featureUniqueRef+"): "+limitMin),limitMin}return $log.info("[profileService] getFeatureLimitMin("+featureUniqueRef+"): service not started or feature not enabled"),0},service.getMyProfileOffer=function(){return service.mainOffers.length>0?service.mainOffers.slice(-1)[0]:null},service.getMyProfileName=function(){var profile=this.getMyProfileOffer();return profile?profile.name:null},service.getMyProfiles=function(){var profiles=[];return service.started?profiles=service.profiles:$log.warn("[profileService] getMyProfiles(): service not started"),profiles},service.getMyProfileFeatures=function(){var profileFeatures={};return service.started?Object.keys(service.features).forEach((function(featureUniqueRef){var originalFeature=service.features[featureUniqueRef],feature={};Object.keys(originalFeature).filter((function(featureProperty){return"featureUniqueRef"===featureProperty||"featureType"===featureProperty||"limitMin"===featureProperty||"limitMax"===featureProperty||"isEnabled"===featureProperty})).forEach((function(featureProperty){feature[featureProperty]=originalFeature[featureProperty]})),profileFeatures[featureUniqueRef]=feature})):$log.warn("[profileService] getMyProfileFeatures(): service not started"),profileFeatures},service.getThirdPartyApps=function(force){return $q((function(resolve,reject){if(null!==service.thirdPartyApps&&!force)return $log.info("[profileService] getThirdPartyApps -- from cache"),resolve(service.thirdPartyApps);$http({method:"GET",url:config.restServerUrl+"/api/rainbow/authentication/v1.0/oauth/tokens?format=medium",headers:authService.getRequestHeader()}).then((function(response){$log.info("[profileService] getThirdPartyApps from server -- success"),response.data&&response.data.data?service.thirdPartyApps=response.data.data:service.thirdPartyApps=[],resolve(service.thirdPartyApps)})).catch((function(error){var errorMessage="getThirdPartyApps from server failed -- no answer from server";error&&(errorMessage="getThirdPartyApps from server failed -- "+JSON.stringify(error)),$log.error("[profileService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.revokeThirdPartyAccess=function(tokenId){return $q((function(resolve,reject){if(!tokenId)return $log.warn("[profileService] revokeThirdPartyAccess missing token"),reject();$log.info("[profileService] revokeThirdPartyAccess with token -- "+tokenId),$http({method:"DELETE",url:config.restServerUrl+"/api/rainbow/authentication/v1.0/oauth/tokens/"+tokenId,headers:authService.getRequestHeader()}).then((function(){$log.info("[profileService] revokeThirdPartyAccess -- success"),service.thirdPartyApps.forEach((function(app,index){app.id===tokenId&&service.thirdPartyApps.splice(index,1)})),resolve(service.thirdPartyApps)})).catch((function(error){var errorMessage="revokeThirdPartyAccess from server failed -- no answer from server";error&&(errorMessage="revokeThirdPartyAccess from server failed -- "+JSON.stringify(error)),$log.error("[profileService] "+errorMessage),reject(new Error(errorMessage))}))}))}}])},function(module,exports){angular.module("rainbow").service("updatingService",["$http","$log","$rootScope","$interval","helpersService","centralizedService","videoService","telephonyService","webConferenceService",function($http,$log,$rootScope,$interval,helpersService,centralizedService,videoService,telephonyService,webConferenceService){"use strict";var service=this;service.url=window.location.origin+"/app/"+version+"/js/version.js",service.started=!1,service.start=function(){$log.info("[updatingService] === STARTING ==="),service.started=!0,$log.info("[updatingService] === STARTED ==="),-1===service.url.indexOf("localhost")?(service.interval&&$interval.cancel(service.interval),service.interval=$interval(service.checkUpdate,6e5),centralizedService.isDesktopApp()&&(service.intervalDesktop&&$interval.cancel(service.intervalDesktop),service.intervalDesktop=$interval(service.checkUpdateForDesktop,6e5))):$log.info("[updatingService] Do not start on localhost")},service.checkUpdate=function(){$log.info("[updatingService] - Checking if a new version is online..."),$http({method:"GET",url:service.url+"?rand="+helpersService.randomString()}).then((function(){$log.info("[updatingService] - The web client is up to date")}),(function(response){var isInVideoCall=videoService.isUserContactInCall(),isInTelephonyCall=telephonyService.getActiveCall(),isInConferenceCall=webConferenceService.hasActiveConferenceSession();404===response.status?isInVideoCall||isInTelephonyCall||isInConferenceCall?$log.warn("[updatingService] - Update available but user is in call !"):($log.info("[updatingService] - Update available !"),$rootScope.$broadcast("ON_AVAILABLE_UPDATE")):$log.info("[updatingService] - An unknow error has been encountered.")}))},service.checkUpdateForDesktop=function(){var version=centralizedService.containerVersion();if($log.info("[updatingService] - Checking if a new desktop version is available... "+version),!version){var userAgent=navigator.userAgent.substring(navigator.userAgent.indexOf("Rainbow"));userAgent&&(version=userAgent.split("/")[1])}if(version){var temp=version.split(".");if(parseInt(temp[1],10)<35||35===parseInt(temp[1],10)&&parseInt(temp[2],10)<=4){$log.info("[updatingService] - should update from version "+version);var data={popupTitle:"updatingDesktopTitle",popupBody:"updatingDesktopMessage",okLabel:"download",okLink:config.autorizationMicrosoftLink,blockingPopup:!0};navigator.platform.toUpperCase().indexOf("MAC")>=0?data.okLink=config.clientsURL.mac:data.okLink=config.clientsURL.windows,$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",data)}}else $log.error("[updatingService] - no desktop version found !! ")},service.stop=function(){$log.info("[updatingService] === STOPPING ==="),service.started=!1,service.interval&&$interval.cancel(service.interval),service.intervalDesktop&&$interval.cancel(service.intervalDesktop),$log.info("[updatingService] === STOPPED ===")}}])},function(module,exports){function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}angular.module("rainbow").service("calendarService",["$q","$rootScope","$log","$http","$interval","authService","contactService","xmppService","errorHelperService","profileService","conversationService","settingsService","$localStorage",function($q,$rootScope,$log,$http,$interval,authService,contactService,xmppService,errorHelperService,profileService,conversationService,settingsService,$localStorage){"use strict";var that=this;this.intervalID=null,this.start=function(stats){$log.info(""),$log.info("[calendarService] === STARTING ===");var startDate=performance.now();that.serviceActivated=!1,that.serviceState=null,that.calendarState=null,that.autorizationLink="",that.calendaRejectIfBusyActivated=!1,$log.info("[calendarService] listen 'out of office' status for roster contacts"),$interval(that.getAutoReplyForEachContact,5e3,1),that.intervalID=$interval(that.updateAutoReplyForEachContact,9e5),that.officeCalendarPresenceEnabled=profileService.isFeatureEnabled(profileService.FeaturesEnum.MSO365_CALENDAR_PRESENCE),that.googleCalendarPresenceEnabled=profileService.isFeatureEnabled(profileService.FeaturesEnum.GOOGLE_CALENDAR_PRESENCE),that.calendarPresenceEnabled=that.officeCalendarPresenceEnabled||that.googleCalendarPresenceEnabled,$log.info("[calendarService] calendar presence status from profileService : "+that.calendarPresenceEnabled),that.disableCalendarPresencePrompt="true"===settingsService.getSetting("disableCalendarPresence"),$log.info("[calendarService] calendar presence prompt status from userSettings : "+!that.disableCalendarPresencePrompt);var startDuration=Math.round(performance.now()-startDate);return stats.push({service:"calendarService",startDuration:startDuration}),$log.info("[calendarService] === STARTED ("+startDuration+" ms) ==="),that.calendarPresenceEnabled&&!contactService.userContact.guestMode&&(that.attachHandlers(),that.calendarPresenceChangeListener=$rootScope.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",that.onCalendarPresenceChange),that.connectionStateChangeListener=$rootScope.$on("ON_CONNECTION_STATE_CHANGE_EVENT",that.onConnectionStateChange),that.getCalendarState().then((function(){"enabled"===that.serviceState&&that.handleEnableState()})).catch((function(error){that.serviceActivated=!1,that.serviceState,$log.error("[calendarService] === STARTING FAILURE === "+error.message)}))),$q.when()},this.attachHandlers=function(){$log.info("[calendarService] attachHandlers"),that.messageHandlerRef&&(xmppService.deleteHandler(that.messageHandlerRef),that.messageHandlerRef=null),that.messageHandlerRef=xmppService.addHandler((function(stanza){return that.onUpdateMessageReceived(stanza),!0}),"jabber:iq:configuration","message",null)},this.stop=function(){return $log.info("[calendarService] === STOPPING ==="),that.serviceActivated=!1,that.calendarPresenceChangeListener&&that.calendarPresenceChangeListener(),that.connectionStateChangeListener&&that.connectionStateChangeListener(),that.messageHandlerRef&&(xmppService.deleteHandler(that.messageHandlerRef),that.messageHandlerRef=null),that.intervalID&&$interval.cancel(that.intervalID),$log.info("[calendarService] === STOPPED ==="),$q.when()},this.onConnectionStateChange=function(__event,state){"connected"===state&&($log.info("[calendarService] onConnectionStateChange state:"+state),that.getCalendarState().then((function(){"enabled"===that.serviceState&&that.handleEnableState(),"consent_required"===that.serviceState&&that.handleConsentRequiredState()})).catch((function(error){that.serviceActivated=!1,that.serviceState,$log.error("[calendarService] === FAILURE === "+error.message)})))},this.handleEnableState=function(){var date=this.calendarState.until?new Date(this.calendarState.until):null,status=this.calendarState.busy?"dnd":"online",message=this.calendarState.busy?"busy":"";that.updateCalendarPresenceForUser(contactService.userContact.jid,status,date,message)},this.handleConsentRequiredState=_asyncToGenerator(regeneratorRuntime.mark((function _callee(){var registrationParams;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.next=2,that.getRegistrationParams(!1);case 2:registrationParams=_context.sent,$rootScope.$broadcast("ON_OPEN_CALENDARSELECTION_POPUP",registrationParams);case 4:case"end":return _context.stop()}}),_callee)}))),this.onUpdateMessageReceived=function(stanza){var info=$(stanza).find("calendar");return info.length&&(that.serviceState=info.attr("status"),that.serviceActivated="enabled"===that.serviceState,$rootScope.$broadcast("ON_CALENDAR_STATUS_CHANGE",that.serviceActivated),$log.info("[calendarService] onUpdateMessageReceived with state : "+that.serviceState),"consent_required"===that.serviceState&&that.handleConsentRequiredState()),!0},this.onCalendarPresenceChange=function(__event,attr){if(contactService.isTelJid(attr.jid)&&"calendar"===contactService.getRessourceFromJid(attr.jid)){var jid_im=contactService.getImJid(attr.jid);jid_im&&($log.info("[calendarService] onCalendarPresenceChange -- status: "+attr.status+" -- until: "+attr.until+" -- message: "+attr.message),that.updateCalendarPresenceForUser(jid_im,attr.status,attr.until,attr.message))}},this.updateAutoReplyForEachContact=function(){that.getAutoReplyInfoForContact(contactService.userContact),that.getAutoReplyForEachContact()},this.getAutoReplyForEachContact=function(){$log.info("[calendarService] getAutoReplyForEachContact"),conversationService.getConversations().forEach((function(conversation){null!==conversation.contact&&that.getAutoReplyInfoForContact(conversation.contact)}))},this.getAutoReplyInfoForContact=function(contact){return $q((function(resolve,reject){if(!contact.calendarState.status)return $log.info("[calendarService] getAutoReplyInfoForContact user has no calendar state"),void resolve();if(contact.calendarState.lastUpdate){var duration=moment.duration(contact.calendarState.lastUpdate.diff(moment()));if(Math.abs(Math.floor(duration.asMinutes()))<15)return $log.info("[calendarService] getAutoReplyInfoForContact state has been updated in the last 15min"),void resolve()}contact.calendarState.lastUpdate=moment(),$http({method:"GET",url:config.restServerUrl+"/api/rainbow/calendar/v1.0/automatic_reply?userid="+contact.dbId,headers:authService.getRequestHeader()}).then((function(response){that.treatOutOfOfficeState(response.data,contact),$log.info("[calendarService] getAutoReplyInfoForContact success for contact "+contact.dbId),resolve()}),(function(response){var err=errorHelperService.handleError(response);$log.error("[calendarService] "+errorHelperService.getErrorFullMessage(response,"getAutoReplyInfoForContact")),reject(err)}))}))},this.getCalendarState=function(){return $q((function(resolve,reject){$http({method:"GET",url:config.restServerUrl+"/api/rainbow/calendar/v1.0",headers:authService.getRequestHeader()}).then((function(response){var successMessage="[calendarService] getCalendarState success -- ",calendarInfo=response.data;"busy"===calendarInfo.status||"free"===calendarInfo.status||"out_of_office"===calendarInfo.status?(that.serviceState="enabled",that.calendarState=calendarInfo,successMessage+=that.serviceState+" "+that.calendarState.status):(that.serviceState=calendarInfo.status,that.calendarState=null,successMessage+=that.serviceState),$log.info(successMessage),resolve(response.data)}),(function(){$log.error("[calendarService] getCalendarState failure -- CalendarService portal not responding"),reject()}))}))},this.getRegistrationParams=function(fromSettings){return $q((function(resolve){$log.info("[calendarService] getRegistrationParams");var promiseArray=[];that.officeCalendarPresenceEnabled&&promiseArray.push(that.getCalendarRegistrationInfo("office365")),that.googleCalendarPresenceEnabled&&promiseArray.push(that.getCalendarRegistrationInfo("googleCalendar")),$q.all(promiseArray).finally((function(){that.autorizationGoogleLink||that.autorizationMicrosoftLink?($log.info("[calendarService] getRegistrationParams -- show registration popup or tooltip"),resolve({authentMicrosoftUrl:that.autorizationMicrosoftLink,authentGoogleUrl:that.autorizationGoogleLink,fromSettings:fromSettings})):($log.error("[calendarService] getRegistrationParams -- no calendar provider response"),resolve())}))}))},this.getCalendarRegistrationInfo=function(type){var calendarRedirect="o365",calendarType="office365";return"googleCalendar"===type&&(calendarRedirect="gcal",calendarType="google"),$q((function(resolve,reject){var lang=settingsService.getAppliLanguage().code;$http({method:"POST",url:config.restServerUrl+"/api/rainbow/calendar/v1.0/register",headers:authService.getRequestHeader(),data:{type:calendarType,callback:window.location.origin+"/redirectO365.html?provider="+calendarRedirect+"&lang="+lang}}).then((function(response){$log.info("[calendarService] getCalendarRegistrationInfo for "+type+" -- success"),that.autorizationLink=response.data.url,"googleCalendar"===type?that.autorizationGoogleLink=that.autorizationLink:that.autorizationMicrosoftLink=that.autorizationLink,resolve(that.autorizationLink)}),(function(response){$log.error("[calendarService] getCalendarRegistrationInfo failure"),$log.error(response),reject()}))}))},this.deactivateCalendar=function(){return $log.info("[calendarService] deactivateCalendar"),$q((function(resolve,reject){$http({method:"DELETE",url:config.restServerUrl+"/api/rainbow/calendar/v1.0",headers:authService.getRequestHeader()}).then((function(){$log.info("[calendarService] deactivateCalendar success"),that.serviceActivated=!1,resolve()}),(function(response){$log.error("[calendarService] deactivateCalendar failure"),$log.error(response),reject()}))}))},this.updateCalendarPresenceForUser=function(jid,status,date,message){contactService.getOrCreateContact(jid).then((function(contact){contact.calendarState.status=status,contact.calendarState.message=message;var mdate=null;"online"===status||date||(date=new Date),date&&(mdate=moment(date)),contact.calendarState.mdate=mdate,mdate?mdate.isSame(moment(),"d")?(contact.calendarState.until=mdate.format("LT"),contact.calendarState.untilDate=!1):(contact.calendarState.until=mdate.format("ll"),contact.calendarState.untilDate=!0):(date||(date=new Date),contact.calendarState.until=date,contact.calendarState.untilDate=!1),contactService.isUserContact(contact)?($log.info("[calendarService] updateCalendarPresenceForUser for my user : "+status+" until "+date),that.serviceActivated||"offline"===status||(that.serviceActivated=!0,$rootScope.$broadcast("ON_CALENDAR_STATUS_CHANGE",that.serviceActivated)),that.getAutoReplyInfoForContact(contactService.userContact)):$log.info("[calendarService] updateCalendarPresenceForUser for user : "+jid+" with : "+status+" until "+date),$rootScope.$broadcast("ON_CONTACT_CALENDAR_STATUS_CHANGE",contact)})).catch((function(error){$log.error("[calendarService] updateCalendarPresenceForUser failure for user "+jid+" with error : "+error)}))},this.treatOutOfOfficeState=function(data,contact){if($log.info("[calendarService] treatOutOfOfficeState for user : "+contact.jid+" with data enabled "+data.enabled+" and date end "+data.end),data.enabled){if(contact.calendarState.autoReplyOn=!0,contact.calendarState.autoReplyInfos={},data.message_text&&(contact.calendarState.autoReplyInfos.message=data.message_text),data.end){var mdate=moment(data.end);contact.calendarState.autoReplyInfos.mdate=mdate,mdate?mdate.isSame(moment(),"d")?(contact.calendarState.autoReplyInfos.until=mdate.format("LT"),contact.calendarState.autoReplyInfos.untilDate=!1):(contact.calendarState.autoReplyInfos.until=mdate.format("ll"),contact.calendarState.autoReplyInfos.untilDate=!0):(contact.calendarState.autoReplyInfos.until=data.end,contact.calendarState.autoReplyInfos.untilDate=!0)}$rootScope.$broadcast("ON_CALENDAR_STATUS_CHANGE",that.serviceActivated)}else contact.calendarState.autoReplyOn=!1,contact.calendarState.autoReplyInfos={};$rootScope.$broadcast("ON_CONTACT_CALENDAR_STATUS_CHANGE",contact)},this.calendarCancelCallback=function(){that.serviceActivated=!1,settingsService.setSetting("disableCalendarPresence",!0),contactService.setUserSettings({promptForCalendarPresence:!1}),$rootScope.$broadcast("ON_CALENDAR_STATUS_CHANGE",!1)},this.calendarLaterCallback=function(){that.serviceActivated=!1,$rootScope.$broadcast("ON_CALENDAR_STATUS_CHANGE",!1)},this.setCalendarRejectIfBusy=function(state){that.calendaRejectIfBusyActivated=!1},this.getCalendarRejectIfBusy=function(){return that.calendaRejectIfBusyActivated}}])},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class MeetingService{constructor($q,$log,roomService,contactService,pstnConferenceService,conferenceService,orderByFilter,webConferenceService){this.$q=$q,this.$log=$log,this.roomService=roomService,this.contactService=contactService,this.pstnConferenceService=pstnConferenceService,this.conferenceService=conferenceService,this.orderByFilter=orderByFilter,this.webConferenceService=webConferenceService,this.started=!1,this.meetings=[],this.listeners=[]}start(stats){return this.$q(resolve=>{let startDate=performance.now();this.$log.info("[MeetingService] === STARTING ==="),this.updateMeetingLists(),this.started=!0;var startDuration=Math.round(performance.now()-startDate);stats.push({service:"MeetingService",startDuration:startDuration}),this.$log.info("[MeetingService] === STARTED ("+startDuration+" ms) ==="),resolve()})}stop(){return this.$log.info("[MeetingService] === STOPPING ==="),this.meetings=[],this.started&&(this.started=!1),this.listeners&&this.listeners.forEach(listenerDestroy=>{listenerDestroy()}),this.$log.info("[MeetingService] === STOPPED ==="),this.$q.when()}getLastActivityDateDate(meeting){return moment(meeting.lastActivityDate)}sortByDate(dateA,dateB){var res=1;return dateA&&dateB&&(res=dateB.value-dateA.value),res}updateMeetingLists(){this.meetings=[],this.meetings=this.orderByFilter(this.roomService.getRooms().filter(room=>room.isMeetingRoom()&&room.status!==this.roomService.RoomUserStatus.REJECTED&&room.status!==this.roomService.RoomUserStatus.DELETED),this.getLastActivityDateDate,!1,this.sortByDate)}getMeetings(){return this.meetings.filter(meeting=>"invited"!==meeting.status&&meeting.conference&&!meeting.conference.scheduled)}getMeetingInvitations(){return this.meetings.filter(meeting=>"invited"===meeting.status)}getActiveMeetings(){return this.updateMeetingLists(),this.meetings.filter(meeting=>{let confId=meeting.getPstnConfEndpointId();if(!meeting.conference.scheduled&&confId){let confSession=this.pstnConferenceService.getConferenceSessionById(confId);if(confSession&&confSession.isActive())return!0}return!1})}endMeeting(meeting){let sharingConfId=meeting.getSFUSharingConfEndpointId(),sharingConfSession=this.webConferenceService.getConferenceSessionById(sharingConfId);return sharingConfSession&&sharingConfSession.isActive()&&this.webConferenceService.stopWebConference(meeting),this.conferenceService.stopConference(this.conferenceService.getPstnInstantConferenceEndpointId())}attendeeExitsMeeting(meeting){if(meeting.owner)return this.$q.reject();let promiseArray=[],confId=meeting.getPstnConfEndpointId();if(confId){let conferenceSession=this.pstnConferenceService.getConferenceSessionById(confId);if(conferenceSession){let confParticipant=conferenceSession.getConnectedParticipantByJid(this.contactService.userContact.jid);confParticipant&&promiseArray.push(this.conferenceService.disconnectsParticipant(confId,confParticipant.participantId,"pstnAudio"))}}return promiseArray.push(this.roomService.participantCloseRoom(meeting)),this.$q.all(promiseArray)}acceptMeetingInvitation(meeting){return this.roomService.acceptRoomInvitation(meeting).then(()=>(this.conferenceService.makeSnapshotForConfId(meeting.getPstnConfEndpointId(),"pstnAudio"),this.roomService.getServerRoom(meeting.dbId)))}declineMeetingInvitation(meeting){return this.roomService.declineRoomInvitation(meeting)}startMeeting(meeting){let confId=meeting.getPstnConfEndpointId();if(confId)return this.pstnConferenceService.initiatesAudio(confId);{let error=new Error("[MeetingService] No confEndpoint associated to meeting");return this.$log.error(error.message),this.$q.reject()}}updateMeetingName(meeting,newName){let conferenceId=meeting.getPstnConfEndpointId();return this.conferenceService.updateConference(conferenceId,{name:newName}).finally(()=>(meeting.name=newName,this.roomService.ownerUpdateRoomNameAndDescription(meeting)))}}exports.MeetingService=MeetingService,MeetingService.$inject=["$q","$log","roomService","contactService","pstnConferenceService","conferenceService","orderByFilter","webConferenceService"],angular.module("rainbow").service("meetingService",MeetingService)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const ts_ebml_1=__webpack_require__(288);class RecordsService{constructor($q,$rootScope,$log,fileServerService,fileStorageService,xmppService,$interval,$window){this.$q=$q,this.$rootScope=$rootScope,this.$log=$log,this.fileServerService=fileServerService,this.fileStorageService=fileStorageService,this.xmppService=xmppService,this.$interval=$interval,this.$window=$window,this.started=!1,this.recording=!1,this.upload=!1,this.filename="",this.recordStopOrigin="LOCAL"}start(){return this.started=!1,this.recording=!1,this.recorder=null,this.chunk=null,this.data=new Blob([],{type:"video/webm"}),this.audioContext=null,this.recordFile=null,this.decoder=new ts_ebml_1.Decoder,this.initConversationRecordContext(),this.$log.info("[RecordsService] start"),this.$q.when()}stop(){return this.$log.info("[RecordsService stop"),this.started&&(this.started=!1),this.$q.when()}onDataAvailable(event){this.$log.info("[RecordService] >onDataAvailable: size = "+event.data.size),event.data.size>0&&(this.chunk=event.data,this.data=new Blob([this.data,this.chunk],{type:this.chunk.type}))}canRecord(){try{return!!MediaRecorder}catch(e){return!1}}onStop(){this.$log.info("[RecordService] On stop recording"),navigator.mediaDevices.getUserMedia&&this.$window.mozRTCPeerConnection?(this.onStopCreateFileFromBlob(this.data),this.updatedBlob=this.data):navigator.mediaDevices.getUserMedia&&this.$window.webkitRTCPeerConnection&&this.chunk&&this.injectMetadata(this.chunk).then(result=>{this.updatedBlob=result,this.onStopCreateFileFromBlob(this.updatedBlob)})}onCreateFileFromBlobForSafari(blob){this.updatedBlob=blob,this.$log.info("[RecordService] Size of updatedBlob : "+blob.size),this.filename=this.filename.replace("mp4","wav"),this.recordFile={name:this.filename,extension:"wav",size:blob.size},this.recording=!1,this.recorder=null,this.chunk=null,this.$rootScope.$broadcast("ON_OPEN_RECORDINGFILESTORAGE_POPUP",this.recordFile,this.recordStopOrigin),this.$rootScope.$broadcast("ON_WEBRTC_RECORD_SAVED",this.recordFile,blob,this.recordStopOrigin),this.recordStopOrigin="LOCAL"}onStopCreateFileFromBlob(blob){this.$log.info("[RecordService] Size of updatedBlob : "+blob.size),this.recordFile={name:this.filename,extension:"mp4",size:blob.size},this.recording=!1,this.recorder=null,this.chunk=null,this.$rootScope.$broadcast("ON_OPEN_RECORDINGFILESTORAGE_POPUP",this.recordFile,this.recordStopOrigin),this.$rootScope.$broadcast("ON_WEBRTC_RECORD_SAVED",this.recordFile,blob,this.recordStopOrigin),this.recordStopOrigin="LOCAL"}readAsArrayBuffer(blob){return new Promise((resolve,reject)=>{const reader=new FileReader;reader.readAsArrayBuffer(blob),reader.onloadend=()=>{resolve(reader.result)},reader.onerror=ev=>{reject()}})}injectMetadata(blob){var defered=this.$q.defer();const decoder=new ts_ebml_1.Decoder,reader=new ts_ebml_1.Reader;return reader.logging=!1,reader.drop_default_duration=!1,this.readAsArrayBuffer(blob).then(buffer=>{decoder.decode(buffer).forEach(elm=>{reader.read(elm)}),reader.stop();var refinedMetadataBuf=ts_ebml_1.tools.makeMetadataSeekable(reader.metadatas,reader.duration,reader.cues),body=buffer.slice(reader.metadataSize);const result=new Blob([refinedMetadataBuf,body],{type:blob.type});defered.resolve(result)}),defered.promise}closeAudioContext(){this.audioContext&&(this.audioContext.destination&&this.audioContext.destination.disconnect(),"closed"!==this.audioContext.state&&(this.audioContext.close(),this.audioContext=null))}cleanRecord(){!1!==this.recording?this.$log.error("[RecordsService] Unexpected record cleaning while recording not stopped"):(this.updatedBlob=null,this.recordFile=null,this.data=null)}onError(event){this.$log.error("[RecordService] error : "+event.message||!1),this.recording=!1,this.stopConvTimer(),this.$rootScope.$broadcast("ON_WEBRTC_RECORD_ERROR")}createRecord(callID,sourceStream="REMOTE",upload=!1,filename="",onlyAudio=!1,mimeType){let options=null,localStreams=null,remoteStreams=null,stream=null,videoStream=null,audioStream=null,tracks=[];this.recorder=null,this.upload=upload,this.filename=filename;let streamsAvailable=!1,localIndexSharing=null,localIndexAudioVideo=null,remoteIndexSharing=null,remoteIndexAudioVideo=null,isSafari="safari"===adapter.default.browserDetails.browser;if(this.decoder=new ts_ebml_1.Decoder,this.data=new Blob([],{type:"video/webm"}),isSafari&&(mimeType="audio/wave"),mimeType&&MediaRecorder.isTypeSupported(mimeType)?options={mimeType:mimeType}:onlyAudio?MediaRecorder.isTypeSupported("audio/webm")&&(options={mimeType:"audio/webm"}):MediaRecorder.isTypeSupported("video/webm;codecs=vp8")?options={mimeType:"video/webm; codecs=vp8"}:MediaRecorder.isTypeSupported("video/webm;codecs=vp9")?options={mimeType:"video/webm; codecs=vp9"}:MediaRecorder.isTypeSupported("video/webm;codecs=h264")?options={mimeType:"video/webm; codecs=h264"}:MediaRecorder.isTypeSupported("video/mpeg")&&(options={mimeType:"video/mpeg"}),null===options)return this.$log.error("[RecordsService] Codecs : "+mimeType+" are not available for the navigator"),!1;this.$log.info("[RecordsService] createRecord -- mimeType used "+options.mimeType);var sess=this.xmppService.connection.jingle.sessions[callID];if(localStreams=this.xmppService.connection.jingle.sessions[callID].localStreams,(remoteStreams=sess.remoteStreams)&&remoteStreams.length||!sess.remoteStreamsObject||(remoteStreams=Object.values(sess.remoteStreamsObject)),streamsAvailable=localStreams&&localStreams.length&&null!==localStreams[0]||remoteStreams&&remoteStreams.length&&null!==remoteStreams[0],null!==this.recorder||!streamsAvailable)return this.$log.error("[RecordsService] Cannot get Stream"),!1;{let i,tmpIndexSharing=null;for(i=0;i<remoteStreams.length;i++)remoteStreams[i]&&null!=remoteStreams[i]&&(tmpIndexSharing=i,remoteStreams[i].getAudioTracks().forEach(element=>{tracks.push(element),remoteIndexAudioVideo=i,tmpIndexSharing=null}),null!==tmpIndexSharing&&(remoteIndexSharing=tmpIndexSharing));for(tmpIndexSharing=null,i=0;i<localStreams.length;i++)localStreams[i]&&null!=localStreams[i]&&(tmpIndexSharing=i,localStreams[i].getAudioTracks().forEach(element=>{tracks.push(element),localIndexAudioVideo=i,tmpIndexSharing=null}),null!==tmpIndexSharing&&(localIndexSharing=tmpIndexSharing));if(this.audioContext&&(this.$log.error("[RecordsService] anomaly audio Context not previously released"),this.closeAudioContext()),tracks.length)if(isSafari)audioStream=new MediaStream,tracks.forEach(track=>{audioStream.addTrack(track)});else{this.audioContext=new AudioContext;let sources=tracks.map(t=>this.audioContext.createMediaStreamSource(new MediaStream([t]))),dest=this.audioContext.createMediaStreamDestination();sources.forEach(source=>source.connect(dest)),audioStream=dest.stream}if(!onlyAudio&&!isSafari)if(videoStream=new MediaStream,"LOCAL"===sourceStream&&null!==localIndexSharing)localStreams[localIndexSharing].getVideoTracks().forEach(element=>{videoStream.addTrack(element)});else null!==remoteIndexSharing?remoteStreams[remoteIndexSharing].getVideoTracks().forEach(element=>{videoStream.addTrack(element)}):remoteStreams[remoteIndexAudioVideo].getVideoTracks().forEach(element=>{videoStream.addTrack(element)});stream=audioStream&&videoStream?new MediaStream([...audioStream.getTracks(),...videoStream.getTracks()]):audioStream&&!videoStream?audioStream:videoStream,isSafari?(this.recorder=new MediaRecorder(stream),this.recorder.addEventListener("dataavailable",function(e){console.info(e),this.onCreateFileFromBlobForSafari(e.data)}.bind(this)),this.recorder.onstop=this.onStop.bind(this),this.recorder.onerror=this.onError.bind(this)):(this.recorder=new MediaRecorder(stream,options),this.recorder.ondataavailable=this.onDataAvailable.bind(this),this.recorder.onstop=this.onStop.bind(this),this.recorder.onerror=this.onError.bind(this))}return!0}uploadFile(){return this.$q((resolve,reject)=>{let buffer=this.updatedBlob,file=this.recordFile,UploadError="";!1!==this.recording&&(this.$log.error("[RecordsService] Unexpected uploading file when recording not stopped"),reject(UploadError="recording not stopped pb")),0===file.size&&(this.$log.error("[RecordsService] error uploading empty file"),reject(UploadError="empty file pb")),this.fileStorageService.createFileDescriptor(file.name,file.extension,file.size).then(fileDescriptor=>{this.fileServerService.uploadAFileByChunk(fileDescriptor,buffer,void 0,()=>{}).then(success=>{this.$log.info("[RecordsService] uploadFile success"),this.cleanRecord(),resolve()}).catch(errorUpload=>{this.$log.error("[RecordsService] Unexpected error while uploading file",errorUpload),reject(UploadError="server pb")})}).catch(error=>{this.$log.error("[RecordsService] Unexpected error while creating file descriptor!",error),reject(UploadError="file descriptor pb")})})}setRecordStopOrigin(recordStopSource){recordStopSource&&""!==recordStopSource&&(this.recordStopOrigin=recordStopSource)}localSaveFile(){let buffer=this.updatedBlob,file=this.recordFile;!1===this.recording?(this.downloadFile(buffer,null,null,file.name,!0),this.cleanRecord()):this.$log.error("[RecordsService] Unexpected file local storage when recording not stopped")}downloadFile(blob,conversation_id,message_id,filename,browse){this.$log.info("[RecordsService] downloadFile -- default function")}startRecording(timeslice){null!==this.recorder&&(timeslice?this.recorder.start(timeslice):this.recorder.start(),this.recording=!0,this.startConvTimer())}stopRecording(){null!==this.recorder&&(this.recorder.stop(),this.recording=!1,this.closeAudioContext()),this.stopConvTimer(),this.initConversationRecordContext()}pauseResumeRecording(){null!==this.recorder&&("recording"===this.recorder.state?(this.recorder.pause(),this.conversationRecordContext.pause=!0,this.stopConvTimer()):(this.recorder.resume(),this.conversationRecordContext.pause=!1,this.startConvTimer()))}setOnDataAvailableCallback(callback){null!==this.recorder&&(this.recorder.ondataavailable=callback)}setOnErrorCallback(callback){null!==this.recorder&&(this.recorder.onerror=callback)}setOnPauseCallback(callback){null!==this.recorder&&(this.recorder.onpause=callback)}setOnResumeCallback(callback){null!==this.recorder&&(this.recorder.onresume=callback)}setOnStartCallback(callback){null!==this.recorder&&(this.recorder.onstart=callback)}setOnStopCallback(callback){null!==this.recorder&&(this.recorder.onstop=callback)}initConversationRecordContext(){this.conversationRecordContext={conversationId:"",recorder:!1,pause:!1,actualRecordTime:0,updateTimer:null,recordStopSource:"LOCAL"}}getConversationRecordContext(conversationId){return conversationId===this.conversationRecordContext.conversationId?this.conversationRecordContext:null}setConversationRecordContext(conversationId,recorder,pause,actualRecordTime,recordStopSource){conversationId&&""!==conversationId&&(this.conversationRecordContext.conversationId=conversationId,this.conversationRecordContext.recorder=recorder&&this.recording,this.conversationRecordContext.pause=pause,this.conversationRecordContext.actualRecordTime=actualRecordTime,this.conversationRecordContext.recordStopSource=recordStopSource)}startConvTimer(){this.conversationRecordContext.updateTimer=this.$interval(()=>{this.conversationRecordContext.actualRecordTime++},1e3)}stopConvTimer(){null!==this.conversationRecordContext.updateTimer&&(this.$interval.cancel(this.conversationRecordContext.updateTimer),this.conversationRecordContext.updateTimer=null)}}RecordsService.$inject=["$q","$rootScope","$log","fileServerService","fileStorageService","xmppService","$interval","$window"],angular.module("rainbow").service("recordsService",RecordsService)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var EBMLDecoder_1=__webpack_require__(289);exports.Decoder=EBMLDecoder_1.default;var EBMLEncoder_1=__webpack_require__(86);exports.Encoder=EBMLEncoder_1.default;var EBMLReader_1=__webpack_require__(294);exports.Reader=EBMLReader_1.default;var tools=__webpack_require__(20);exports.tools=tools;var version=__webpack_require__(295).version;exports.version=version},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var State,tools_1=__webpack_require__(20),int64_buffer_1=__webpack_require__(85),tools=__webpack_require__(20),byEbmlID=__webpack_require__(87).byEbmlID;!function(State){State[State.STATE_TAG=1]="STATE_TAG",State[State.STATE_SIZE=2]="STATE_SIZE",State[State.STATE_CONTENT=3]="STATE_CONTENT"}(State||(State={}));var EBMLDecoder=function(){function EBMLDecoder(){this._buffer=new tools_1.Buffer(0),this._tag_stack=[],this._state=State.STATE_TAG,this._cursor=0,this._total=0,this._schema=byEbmlID,this._result=[]}return EBMLDecoder.prototype.decode=function(chunk){this.readChunk(chunk);var diff=this._result;return this._result=[],diff},EBMLDecoder.prototype.readChunk=function(chunk){for(this._buffer=tools.concat([this._buffer,new tools_1.Buffer(chunk)]);this._cursor<this._buffer.length&&(this._state!==State.STATE_TAG||this.readTag())&&(this._state!==State.STATE_SIZE||this.readSize())&&(this._state!==State.STATE_CONTENT||this.readContent()););},EBMLDecoder.prototype.getSchemaInfo=function(tagNum){return this._schema[tagNum]||{name:"unknown",level:-1,type:"unknown",description:"unknown"}},EBMLDecoder.prototype.readTag=function(){if(this._cursor>=this._buffer.length)return!1;var tag=tools_1.readVint(this._buffer,this._cursor);if(null==tag)return!1;var tagNum=this._buffer.slice(this._cursor,this._cursor+tag.length).reduce((function(o,v,i,arr){return o+v*Math.pow(16,2*(arr.length-1-i))}),0),schema=this.getSchemaInfo(tagNum),tagObj={EBML_ID:tagNum.toString(16),schema:schema,type:schema.type,name:schema.name,level:schema.level,tagStart:this._total,tagEnd:this._total+tag.length,sizeStart:this._total+tag.length,sizeEnd:null,dataStart:null,dataEnd:null,dataSize:null,data:null};return this._tag_stack.push(tagObj),this._cursor+=tag.length,this._total+=tag.length,this._state=State.STATE_SIZE,!0},EBMLDecoder.prototype.readSize=function(){if(this._cursor>=this._buffer.length)return!1;var size=tools_1.readVint(this._buffer,this._cursor);if(null==size)return!1;var tagObj=this._tag_stack[this._tag_stack.length-1];return tagObj.sizeEnd=tagObj.sizeStart+size.length,tagObj.dataStart=tagObj.sizeEnd,tagObj.dataSize=size.value,-1===size.value?(tagObj.dataEnd=-1,"m"===tagObj.type&&(tagObj.unknownSize=!0)):tagObj.dataEnd=tagObj.sizeEnd+size.value,this._cursor+=size.length,this._total+=size.length,this._state=State.STATE_CONTENT,!0},EBMLDecoder.prototype.readContent=function(){var tagObj=this._tag_stack[this._tag_stack.length-1];if("m"===tagObj.type){if(tagObj.isEnd=!1,this._result.push(tagObj),this._state=State.STATE_TAG,0===tagObj.dataSize){var elm=Object.assign({},tagObj,{isEnd:!0});this._result.push(elm),this._tag_stack.pop()}return!0}if(this._buffer.length<this._cursor+tagObj.dataSize)return!1;var data=this._buffer.slice(this._cursor,this._cursor+tagObj.dataSize);switch(this._buffer=this._buffer.slice(this._cursor+tagObj.dataSize),tagObj.data=data,tagObj.type){case"u":tagObj.value=data.readUIntBE(0,data.length);break;case"i":tagObj.value=data.readIntBE(0,data.length);break;case"f":tagObj.value=4===tagObj.dataSize?data.readFloatBE(0):8===tagObj.dataSize?data.readDoubleBE(0):(console.warn("cannot read "+tagObj.dataSize+" octets float. failback to 0"),0);break;case"s":tagObj.value=data.toString("ascii");break;case"8":tagObj.value=data.toString("utf8");break;case"b":tagObj.value=data;break;case"d":tagObj.value=tools_1.convertEBMLDateToJSDate(new int64_buffer_1.Int64BE(data).toNumber())}if(null===tagObj.value)throw new Error("unknown tag type:"+tagObj.type);for(this._result.push(tagObj),this._total+=tagObj.dataSize,this._state=State.STATE_TAG,this._cursor=0,this._tag_stack.pop();this._tag_stack.length>0;){var topEle=this._tag_stack[this._tag_stack.length-1];if(topEle.dataEnd<0)return this._tag_stack.pop(),!0;if(this._total<topEle.dataEnd)break;if("m"!==topEle.type)throw new Error("parent element is not master element");elm=Object.assign({},topEle,{isEnd:!0});this._result.push(elm),this._tag_stack.pop()}return!0},EBMLDecoder}();exports.default=EBMLDecoder},function(module,exports,__webpack_require__){(function(Buffer){var tools={readVint:function(buffer,start){start=start||0;for(var length=1;length<=8&&!(buffer[start]>=Math.pow(2,8-length));length++);if(length>8)throw new Error("Unrepresentable length: "+length+" "+buffer.toString("hex",start,start+length));if(start+length>buffer.length)return null;for(var value=buffer[start]&(1<<8-length)-1,i=1;i<length;i++){if(7===i&&value>=Math.pow(2,45)&&buffer[start+7]>0)return{length:length,value:-1};value*=Math.pow(2,8),value+=buffer[start+i]}return{length:length,value:value}},writeVint:function(value){if(value<0||value>Math.pow(2,53))throw new Error("Unrepresentable value: "+value);for(var length=1;length<=8&&!(value<Math.pow(2,7*length)-1);length++);for(var buffer=new Buffer(length),i=1;i<=length;i++){var b=255&value;buffer[length-i]=b,value-=b,value/=Math.pow(2,8)}return buffer[0]=buffer[0]|1<<8-length,buffer}};module.exports=tools}).call(this,__webpack_require__(5).Buffer)},function(module,exports,__webpack_require__){var BufferReader=__webpack_require__(292),XIPH_LACING=1,EBML_LACING=3,FIXED_SIZE_LACING=2;module.exports=function(buffer){var block={},reader=new BufferReader(buffer);block.trackNumber=reader.nextUIntV(),block.timecode=reader.nextInt16BE();var flags=reader.nextUInt8();block.invisible=!!(8&flags),block.keyframe=!!(128&flags),block.discardable=!!(1&flags);var lacing=(6&flags)>>1;return block.frames=function(reader,lacing){if(!lacing)return[reader.nextBuffer()];var i,frameSize,frames=[],framesNum=reader.nextUInt8()+1;if(lacing===FIXED_SIZE_LACING){if(reader.length%framesNum!=0)throw new Error("Fixed-Size Lacing Error");for(frameSize=reader.length/framesNum,i=0;i<framesNum;i++)frames.push(reader.nextBuffer(frameSize));return frames}var frameSizes=[];if(lacing===XIPH_LACING)for(i=0;i<framesNum-1;i++){var val;frameSize=0;do{val=reader.nextUInt8(),frameSize+=val}while(255===val);frameSizes.push(frameSize)}else if(lacing===EBML_LACING)for(frameSize=reader.nextUIntV(),frameSizes.push(frameSize),i=1;i<framesNum-1;i++)frameSize+=reader.nextIntV(),frameSizes.push(frameSize);for(i=0;i<framesNum-1;i++)frames.push(reader.nextBuffer(frameSizes[i]));return frames.push(reader.nextBuffer()),frames}(reader,lacing),block}},function(module,exports,__webpack_require__){var vint=__webpack_require__(293);function BufferReader(buffer){this.buffer=buffer,this.offset=0}BufferReader.prototype.nextInt16BE=function(){var value=this.buffer.readInt16BE(this.offset);return this.offset+=2,value},BufferReader.prototype.nextUInt8=function(){var value=this.buffer.readUInt8(this.offset);return this.offset+=1,value},BufferReader.prototype.nextUIntV=function(){var v=vint(this.buffer,this.offset);return this.offset+=v.length,v.value},BufferReader.prototype.nextIntV=function(){var v=vint(this.buffer,this.offset,!0);return this.offset+=v.length,v.value},BufferReader.prototype.nextBuffer=function(length){var buffer=length?this.buffer.slice(this.offset,this.offset+length):this.buffer.slice(this.offset);return this.offset+=length||this.length,buffer},Object.defineProperty(BufferReader.prototype,"length",{get:function(){return this.buffer.length-this.offset}}),module.exports=BufferReader},function(module,exports){module.exports=function(buffer,start,signed){start=start||0;for(var length=1;length<=8&&!(buffer[start]>=Math.pow(2,8-length));length++);if(length>8)throw new Error("Unrepresentable length: "+length+" "+buffer.toString("hex",start,start+length));if(start+length>buffer.length)return null;var i,value=buffer[start]&(1<<8-length)-1;for(i=1;i<length;i++){if(7===i&&value>=Math.pow(2,45)&&buffer[start+7]>0)return{length:length,value:-1};value*=Math.pow(2,8),value+=buffer[start+i]}return signed&&(value-=Math.pow(2,7*length-1)-1),{length:length,value:value}}},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var events_1=__webpack_require__(27),tools=__webpack_require__(20),EBMLReader=function(_super){function EBMLReader(){var _this=_super.call(this)||this;return _this.logGroup="",_this.hasLoggingStarted=!1,_this.metadataloaded=!1,_this.chunks=[],_this.stack=[],_this.segmentOffset=0,_this.last2SimpleBlockVideoTrackTimecode=[0,0],_this.last2SimpleBlockAudioTrackTimecode=[0,0],_this.lastClusterTimecode=0,_this.lastClusterPosition=0,_this.timecodeScale=1e6,_this.metadataSize=0,_this.metadatas=[],_this.cues=[],_this.firstVideoBlockRead=!1,_this.firstAudioBlockRead=!1,_this.currentTrack={TrackNumber:-1,TrackType:-1,DefaultDuration:null,CodecDelay:null},_this.trackTypes=[],_this.trackDefaultDuration=[],_this.trackCodecDelay=[],_this.trackInfo={type:"nothing"},_this.ended=!1,_this.logging=!1,_this.use_duration_every_simpleblock=!1,_this.use_webp=!1,_this.use_segment_info=!0,_this.drop_default_duration=!0,_this}return __extends(EBMLReader,_super),EBMLReader.prototype.stop=function(){for(this.ended=!0,this.emit_segment_info();this.stack.length;)this.stack.pop(),this.logging&&console.groupEnd();this.logging&&this.hasLoggingStarted&&this.logGroup&&console.groupEnd()},EBMLReader.prototype.emit_segment_info=function(){var data=this.chunks;if(this.chunks=[],this.metadataloaded){if(!this.use_segment_info)return;var timecode=this.lastClusterTimecode,duration=this.duration,timecodeScale=this.timecodeScale;this.emit("cluster",{timecode:timecode,data:data}),this.emit("duration",{timecodeScale:timecodeScale,duration:duration})}else{this.metadataloaded=!0,this.metadatas=data;var videoTrackNum=this.trackTypes.indexOf(1),audioTrackNum=this.trackTypes.indexOf(2);if(this.trackInfo=videoTrackNum>=0&&audioTrackNum>=0?{type:"both",trackNumber:videoTrackNum}:videoTrackNum>=0?{type:"video",trackNumber:videoTrackNum}:audioTrackNum>=0?{type:"audio",trackNumber:audioTrackNum}:{type:"nothing"},!this.use_segment_info)return;this.emit("metadata",{data:data,metadataSize:this.metadataSize})}},EBMLReader.prototype.read=function(elm){var _this=this,drop=!1;if(!this.ended){if("m"===elm.type)if(elm.isEnd)this.stack.pop();else{var parent_1=this.stack[this.stack.length-1];if(null!=parent_1&&parent_1.level>=elm.level){this.stack.pop(),this.logging&&console.groupEnd(),parent_1.dataEnd=elm.dataEnd,parent_1.dataSize=elm.dataEnd-parent_1.dataStart,parent_1.unknownSize=!1;var o=Object.assign({},parent_1,{name:parent_1.name,type:parent_1.type,isEnd:!0});this.chunks.push(o)}this.stack.push(elm)}if("m"===elm.type&&"Segment"==elm.name)0!=this.segmentOffset&&console.warn("Multiple segments detected!"),this.segmentOffset=elm.dataStart,this.emit("segment_offset",this.segmentOffset);else if("b"===elm.type&&"SimpleBlock"===elm.name){var _a=tools.ebmlBlock(elm.data),timecode=_a.timecode,trackNumber=_a.trackNumber,frames_1=_a.frames;if(1===this.trackTypes[trackNumber]){if(!this.firstVideoBlockRead&&(this.firstVideoBlockRead=!0,"both"===this.trackInfo.type||"video"===this.trackInfo.type)){var CueTime=this.lastClusterTimecode+timecode;this.cues.push({CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:CueTime}),this.emit("cue_info",{CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:this.lastClusterTimecode}),this.emit("cue",{CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:CueTime})}this.last2SimpleBlockVideoTrackTimecode=[this.last2SimpleBlockVideoTrackTimecode[1],timecode]}else if(2===this.trackTypes[trackNumber]){if(!this.firstAudioBlockRead&&(this.firstAudioBlockRead=!0,"audio"===this.trackInfo.type)){CueTime=this.lastClusterTimecode+timecode;this.cues.push({CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:CueTime}),this.emit("cue_info",{CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:this.lastClusterTimecode}),this.emit("cue",{CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:CueTime})}this.last2SimpleBlockAudioTrackTimecode=[this.last2SimpleBlockAudioTrackTimecode[1],timecode]}this.use_duration_every_simpleblock&&this.emit("duration",{timecodeScale:this.timecodeScale,duration:this.duration}),this.use_webp&&frames_1.forEach((function(frame){if("9d012a"===frame.slice(3,6).toString("hex")){var webpBuf=tools.VP8BitStreamToRiffWebPBuffer(frame),webp=new Blob([webpBuf],{type:"image/webp"}),currentTime=_this.duration;_this.emit("webp",{currentTime:currentTime,webp:webp})}}))}else"m"===elm.type&&"Cluster"===elm.name&&!1===elm.isEnd?(this.firstVideoBlockRead=!1,this.firstAudioBlockRead=!1,this.emit_segment_info(),this.emit("cluster_ptr",elm.tagStart),this.lastClusterPosition=elm.tagStart):"u"===elm.type&&"Timecode"===elm.name?this.lastClusterTimecode=elm.value:"u"===elm.type&&"TimecodeScale"===elm.name?this.timecodeScale=elm.value:"m"===elm.type&&"TrackEntry"===elm.name?elm.isEnd?(this.trackTypes[this.currentTrack.TrackNumber]=this.currentTrack.TrackType,this.trackDefaultDuration[this.currentTrack.TrackNumber]=this.currentTrack.DefaultDuration,this.trackCodecDelay[this.currentTrack.TrackNumber]=this.currentTrack.CodecDelay):this.currentTrack={TrackNumber:-1,TrackType:-1,DefaultDuration:null,CodecDelay:null}:"u"===elm.type&&"TrackType"===elm.name?this.currentTrack.TrackType=elm.value:"u"===elm.type&&"TrackNumber"===elm.name?this.currentTrack.TrackNumber=elm.value:"u"===elm.type&&"CodecDelay"===elm.name?this.currentTrack.CodecDelay=elm.value:"u"===elm.type&&"DefaultDuration"===elm.name?this.drop_default_duration?(console.warn("DefaultDuration detected!, remove it"),drop=!0):this.currentTrack.DefaultDuration=elm.value:"unknown"===elm.name&&console.warn(elm);!this.metadataloaded&&elm.dataEnd>0&&(this.metadataSize=elm.dataEnd),drop||this.chunks.push(elm),this.logging&&this.put(elm)}},Object.defineProperty(EBMLReader.prototype,"duration",{get:function(){if("nothing"===this.trackInfo.type)return console.warn("no video, no audio track"),0;var defaultDuration=0,codecDelay=0,lastTimecode=0,_defaultDuration=this.trackDefaultDuration[this.trackInfo.trackNumber];if("number"==typeof _defaultDuration)defaultDuration=_defaultDuration;else if("both"===this.trackInfo.type)this.last2SimpleBlockAudioTrackTimecode[1]>this.last2SimpleBlockVideoTrackTimecode[1]?(defaultDuration=(this.last2SimpleBlockAudioTrackTimecode[1]-this.last2SimpleBlockAudioTrackTimecode[0])*this.timecodeScale,"number"==typeof(delay=this.trackCodecDelay[this.trackTypes.indexOf(2)])&&(codecDelay=delay),lastTimecode=this.last2SimpleBlockAudioTrackTimecode[1]):(defaultDuration=(this.last2SimpleBlockVideoTrackTimecode[1]-this.last2SimpleBlockVideoTrackTimecode[0])*this.timecodeScale,"number"==typeof(delay=this.trackCodecDelay[this.trackTypes.indexOf(1)])&&(codecDelay=delay),lastTimecode=this.last2SimpleBlockVideoTrackTimecode[1]);else if("video"===this.trackInfo.type){defaultDuration=(this.last2SimpleBlockVideoTrackTimecode[1]-this.last2SimpleBlockVideoTrackTimecode[0])*this.timecodeScale,"number"==typeof(delay=this.trackCodecDelay[this.trackInfo.trackNumber])&&(codecDelay=delay),lastTimecode=this.last2SimpleBlockVideoTrackTimecode[1]}else if("audio"===this.trackInfo.type){var delay;defaultDuration=(this.last2SimpleBlockAudioTrackTimecode[1]-this.last2SimpleBlockAudioTrackTimecode[0])*this.timecodeScale,"number"==typeof(delay=this.trackCodecDelay[this.trackInfo.trackNumber])&&(codecDelay=delay),lastTimecode=this.last2SimpleBlockAudioTrackTimecode[1]}var duration=((this.lastClusterTimecode+lastTimecode)*this.timecodeScale+defaultDuration-codecDelay)/this.timecodeScale;return Math.floor(duration)},enumerable:!0,configurable:!0}),EBMLReader.prototype.addListener=function(event,listener){return _super.prototype.addListener.call(this,event,listener)},EBMLReader.prototype.put=function(elm){this.hasLoggingStarted||(this.hasLoggingStarted=!0,this.logging&&this.logGroup&&console.groupCollapsed(this.logGroup)),"m"===elm.type?elm.isEnd?console.groupEnd():console.group(elm.name+":"+elm.tagStart):"b"===elm.type?console.log(elm.name,elm.type):console.log(elm.name,elm.tagStart,elm.type,elm.value)},EBMLReader}(events_1.EventEmitter);exports.default=EBMLReader},function(module){module.exports=JSON.parse('{"_args":[["ts-ebml@^2.0.2","/home/konrad/web/sdk/dependencies_otliteclient"]],"_from":"ts-ebml@>=2.0.2 <3.0.0","_id":"ts-ebml@2.0.2","_inCache":true,"_installable":true,"_location":"/ts-ebml","_nodeVersion":"6.11.0","_npmOperationalInternal":{"host":"s3://npm-registry-packages","tmp":"tmp/ts-ebml-2.0.2.tgz_1503116615810_0.8402522935066372"},"_npmUser":{"email":"legokichi@gmail.com","name":"legokichi"},"_npmVersion":"5.3.0","_phantomChildren":{},"_requested":{"name":"ts-ebml","raw":"ts-ebml@^2.0.2","rawSpec":"^2.0.2","scope":null,"spec":">=2.0.2 <3.0.0","type":"range"},"_requiredBy":["/"],"_resolved":"https://registry.npmjs.org/ts-ebml/-/ts-ebml-2.0.2.tgz","_shasum":"5e2c65b35ee6f1c030f51668666f3c018f4d9578","_shrinkwrap":null,"_spec":"ts-ebml@^2.0.2","_where":"/home/konrad/web/sdk/dependencies_otliteclient","author":{"name":"legokichi duckscallion"},"bin":{"ts-ebml":"./lib/cli.js"},"bugs":{"url":"https://github.com/legokichi/ts-ebml/issues"},"dependencies":{"buffer":"^5.0.7","commander":"^2.11.0","ebml":"^2.2.1","ebml-block":"^1.1.0","events":"^1.1.1","int64-buffer":"^0.1.9","matroska":"^2.2.3"},"description":"ebml decoder and encoder","devDependencies":{"@types/commander":"^2.9.1","@types/qunit":"^2.0.31","browserify":"^13.1.0","empower":"^1.2.3","espower-cli":"^1.1.0","power-assert":"^1.4.4","power-assert-formatter":"^1.4.1","qunit-tap":"^1.5.1","qunitjs":"^2.4.0","tslint":"^3.15.1","typedoc":"^0.5.3","typescript":"^2.4.2","watchify":"^3.7.0"},"directories":{},"dist":{"integrity":"sha512-V/HdlCn3FITQrFHQlVE02XtfMiRLab2QB/YOCfkbJWqiFYG/j5v7gHKV+wem6g0PD6/uxXs5oxMQfDXILmts/Q==","shasum":"5e2c65b35ee6f1c030f51668666f3c018f4d9578","tarball":"https://registry.npmjs.org/ts-ebml/-/ts-ebml-2.0.2.tgz"},"gitHead":"079f1cc2c766e1833f498b5cddd511fcee1bc9b1","homepage":"https://github.com/legokichi/ts-ebml#readme","keywords":["ebml","matrosika","mkv","webm","webp"],"license":"MIT","main":"./lib/index.js","maintainers":[{"name":"legokichi","email":"legokichi@gmail.com"}],"name":"ts-ebml","optionalDependencies":{},"readme":"ERROR: No README data found!","repository":{"type":"git","url":"git+https://github.com/legokichi/ts-ebml.git"},"scripts":{"browserify":"browserify lib/index.js --standalone EBML -o dist/EBML.js","build":"npm run clean   && tsc    -p .; npm run browserify","check":"tsc -w --noEmit -p ./","clean":"rm -rf lib/* dist/* test/*.js; mkdir -p dist","doc":"typedoc --mode modules --out doc --disableOutputCheck","example":"tsc; browserify lib/example_seekable.js -o test/example_seekable.js","examples":"tsc; for file in `find lib -name \'example_*.js\' -type f -printf \'%f\\\\n\'`; do browserify lib/$file -o test/$file; done","examples_bsd":"tsc; for file in `find lib -name \'example_*.js\' -type f -print`; do browserify lib/$(basename $file) -o test/$(basename $file); done","init":"npm run update; npm run mkdir; npm run build","lint":"tslint -c ./tslint.json --project ./tsconfig.json --type-check","mkdir":"mkdir lib dist 2>/dev/null","reset":"rm -rf node_modules","setup":"npm install -g http-server;","start":"http-server . -s & tsc -w -p .& watchify lib/example_seekable.js -o test/example_seekable.js","stop":"killall -- node */tsc -w -p","test":"tsc; espower lib/test.js > lib/test.tmp; mv -f lib/test.tmp lib/test.js; browserify lib/test.js -o test/test.js","update":"npm run reset; npm update","watchify":"watchify lib/index.js --standalone EBML -o dist/EBMl.js -v"},"typings":"./lib/index.d.ts","version":"2.0.2"}')},function(module,exports){!function(){"use strict";angular.module("rainbow").service("phonebookService",["$q","$rootScope","$log","$http","contactService","authService","orderByFilter","profileService","conversationService","utilService",function($q,$rootScope,$log,$http,contactService,authService,orderByFilter,profileService,conversationService,utilService){this.search=function(searchText,limit){return $q((function(resolve,reject){if(!profileService.isFeatureEnabled(profileService.FeaturesEnum.TELEPHONY_PHONE_BOOK))return $log.info("[phonebookService] search from phonebook not allowed for the user profile"),void resolve([]);if(!searchText||""===searchText)return $log.info("[phonebookService] search from phonebook not allowed for empty string"),void resolve([]);limit||(limit=20),$log.info("[phonebookService] search PBXContact from phonebook with text "+utilService.anonymizeString(searchText)+" and limit "+limit);var serverUrl=config.restServerUrl+"/api/rainbow/search/v1.0/phonebooks?limit="+limit+"&name="+encodeURIComponent(searchText);$http({method:"GET",url:serverUrl,headers:authService.getRequestHeader()}).then((function(response){var contactsData=response.data.phoneBooks;$log.info("[phonebookService] search find "+contactsData.length+" phonebooks contact(s)");var contacts=[];contactsData.forEach((function(contactData){var contact=contactService.createBasicContact(null,contactData.number);contact.updateName(contactData.firstName,contactData.lastName),contact.getAvatar(),contacts.push(contact)})),contacts=orderByFilter(contacts,"_displayName",!1),resolve(contacts)}),(function(err){err.data&&(401===err.data.errorCode&&$rootScope.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT"),$log.warn("[phonebookService] search failure "+err.data.errorMsg)),reject(new Error("phonebook service failure"))}))}))}}])}()},function(module,exports){angular.module("rainbow").service("adminCompanyService",["$q","$log","$http","$rootScope","authService","errorHelperService","Company","contactService","settingsService","Site","CompanyInvitation","pushImageHelperService","CompanyRequest","companyService","Bot",function($q,$log,$http,$rootScope,authService,errorHelperService,Company,contactService,settingsService,Site,CompanyInvitation,pushImageHelperService,CompanyRequest,companyService,Bot){"use strict";var service=this;service.start=function(){return $log.info("[adminCompanyService] === STARTING ==="),service.portalURL=config.restServerUrl+"/api/rainbow/admin/v1.0/",$log.info("[adminCompanyService] === STARTED ==="),$q.when()},service.stop=function(){return $log.info("[adminCompanyService] === STOPPING ==="),$log.info("[adminCompanyService] === STOPPED ==="),$q.when()},service.getCompanies=function(organisationId,page,pageSize,searchName,format,bpId,status,isBP,bpType,offerCanBeSold,searchReference,noLogo){var defered=$q.defer(),adminContact=contactService.userContact;if(!(adminContact.isSuperadmin()||adminContact.isBusinessAdmin()||adminContact.isBPAdmin()||adminContact.isOrganizationAdmin()))return service.getCompany(adminContact.company.id).then((function(company){return{companies:[company]}}));var url=service.portalURL+"companies?format="+(format||"full");return organisationId&&(url+="&organisationId="+organisationId),page&&pageSize&&(url+="&offset="+pageSize*(page-1)),pageSize&&(url+="&limit="+pageSize),searchName&&(url+="&name="+searchName),bpId&&(url+="&bpId="+bpId),status&&(Array.isArray(status)?status.forEach((function(value){url+="&status="+value})):url+="&status="+status),null!=isBP&&(url+="&isBP="+isBP),bpType&&(url+="&bpType="+bpType),offerCanBeSold&&(url+="&offerCanBeSold="+offerCanBeSold),searchReference&&(url+="&externalReference="+searchReference),$http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){var data=response.data.data;$log.info("[adminCompanyService] getCompanies success");var companies=[];data.forEach((function(orgData){var company=Company.createFromData(orgData);!angular.isUndefined(noLogo)&&noLogo||companyService.getCompanyLogo(company),companies.push(company)})),defered.resolve({companies:companies,limit:response.data.limit,offset:response.data.offset,total:response.data.total})}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanies"))})),defered.promise},service.getAllCompaniesSmall=function(organisationId,bpId,status,isBP,bpType){return service.getAllCompanies(organisationId,bpId,status,isBP,bpType,"small")},service.getAllCompanies=function(organisationId,bpId,status,isBP,bpType,format){return $q((function(resolve,reject){var result;service.getCompanies(organisationId,1,1e3,null,format,bpId,status,isBP,bpType).then((function(response){if(result=response,response.total>response.limit){var totalPages=Math.ceil(response.total/1e3),pages=Array.apply(null,Array(totalPages-1));pages=pages.map((function(__unused,index){return index+2}));for(var chunks=[];pages.length>0;)chunks.push(pages.splice(0,5));return chunks.reduce((function(promiseChain,requests){return promiseChain.then((function(){var promisesArray=requests.map((function(page){return service.getCompanies(organisationId,page,1e3,null,format,bpId,status,isBP,bpType).then((function(next){response.companies=response.companies.concat(next.companies),response.limit+=next.limit}))}));return $q.all(promisesArray)}))}),$q.resolve())}})).then((function(){resolve(result)})).catch((function(error){reject(error)}))}))},service.getCompany=function(companyId,format){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"?format="+(format||"full"),headers:authService.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getCompany success");var data=response.data.data,company=Company.createFromData(data);companyService.getCompanyLogo(company),companyService.getCompanyBanner(company),resolve(company)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompany"))}))}))},service.getDefaultCompany=function(){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/default",headers:authService.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getDefaultCompany success");var data=response.data.data,company=Company.createFromData(data);resolve(company)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getDefaultCompany"))}))}))},service.searchCompanies=function(searchValue){var defered=$q.defer(),searchValueLC=searchValue.toLowerCase();return service.getCompanies().then((function(result){var filteredCompanies=result.companies.filter((function(company){return company.name.toLowerCase().indexOf(searchValueLC)>-1}));defered.resolve(filteredCompanies)})),defered.promise},service.createCompany=function(company){var companyData=Company.prune(company,contactService.userContact),defered=$q.defer();return $http({method:"POST",url:service.portalURL+"companies",headers:authService.getRequestHeader(),data:companyData}).then((function(response){$log.info("[adminCompanyService] createCompany success");var newcompany=Company.createFromData(response.data.data);$rootScope.$broadcast("ADMIN_COMPANIES_CHANGE"),defered.resolve(newcompany)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"createCompany"))})),defered.promise},service.createCompanyEndUser=function(company){var companyData=Company.prune(company,contactService.userContact),defered=$q.defer();return $http({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/companies",headers:authService.getRequestHeader(),data:companyData}).then((function(response){$log.info("[adminCompanyService] createCompany success");var data=response.data.data,newcompany=Company.createFromData(data);defered.resolve(newcompany)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"createCompanyEndUser"))})),defered.promise},service.updateCompany=function(company){var companyData=Company.prune(company,contactService.userContact),defered=$q.defer();return $http({method:"PUT",url:service.portalURL+"companies/"+company.id,headers:authService.getRequestHeader(),data:companyData}).then((function(response){$log.info("[adminCompanyService] updateCompany success");var data=response.data.data,updatedCompany=Company.createFromData(data);defered.resolve(updatedCompany),$rootScope.$broadcast("ON_COMPANY_CHANGE_EVENT",company.id)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"updateCompany"))})),defered.promise},service.addVisibility=function(companyId,visibleByCompany){var defered=$q.defer();return $http({method:"POST",url:service.portalURL+"companies/"+companyId+"/visible-by/"+visibleByCompany,headers:authService.getRequestHeader()}).then((function(){$log.info("[adminCompanyService] addVisibility success"),defered.resolve()}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"addVisibility"))})),defered.promise},service.removeVisibility=function(companyId,visibleByCompany){var defered=$q.defer();return $http({method:"DELETE",url:service.portalURL+"companies/"+companyId+"/visible-by/"+visibleByCompany,headers:authService.getRequestHeader()}).then((function(){$log.info("[adminCompanyService] removeVisibility success"),defered.resolve()}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"removeVisibility"))})),defered.promise},service.getAllSiteCompany=function(companyId){var defered=$q.defer();return $http({method:"GET",url:service.portalURL+"companies/"+companyId+"/sites",headers:authService.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getAllSiteCompany success");var data=response.data.data,sites=[];data.forEach((function(element){var site=Site.createFromData(element);sites.push(site)})),defered.resolve(sites)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getAllSiteCompany"))})),defered.promise},service.getCompanyAdministrators=function(companyId){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"/administrators",headers:authService.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getCompanyAdministrators success");var data=response.data.data,adminUsers=[];data.forEach((function(adminUserData){var adminUser={id:adminUserData.id};adminUsers.push(adminUser)})),resolve(adminUsers)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanyAdministrators"))}))}))},service.deleteCompany=function(companyId){var defered=$q.defer();return $http({method:"DELETE",url:service.portalURL+"companies/"+companyId,headers:authService.getRequestHeader()}).then((function(){$log.info("[adminCompanyService] deleteCompany success"),defered.resolve()}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"deleteCompany"))})),defered.promise},service.pushLogo=function(companyId,logoImg,shape){return $q((function(resolve,reject){var pushServiceURL=service.portalURL+"companies/"+companyId+"/avatar";(angular.isDefined(logoImg)&&null!==logoImg?pushImageHelperService.pushImage(pushServiceURL,logoImg):$q.resolve()).then((function(){return service.getCompany(companyId)})).then((function(company){return company.avatarShape=shape,service.updateCompany(company)})).then((function(){$rootScope.$broadcast("ON_COMPANY_CHANGE_EVENT",companyId),$log.info("[adminCompanyService] pushLogo success"),resolve()})).catch((function(error){reject(error)}))}))},service.deleteLogo=function(companyId){return $q((function(resolve,reject){$http({method:"DELETE",url:service.portalURL+"companies/"+companyId+"/avatar",headers:authService.getRequestHeader()}).then((function(){$rootScope.$broadcast("ON_COMPANY_CHANGE_EVENT",companyId),service.getCompany(companyId).then((function(company){return company.avatarShape="circle",service.updateCompany(company)})).then((function(){$log.info("[adminCompanyService] deleteLogo success"),resolve()})).catch((function(error){reject(error)}))}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"deleteLogo"))}))}))},service.pushBanner=function(companyId,bannerImg,params){return $q((function(resolve,reject){var pushServiceURL=service.portalURL+"companies/"+companyId+"/banner";return pushImageHelperService.pushImage(pushServiceURL,bannerImg,params).then((function(){$rootScope.$broadcast("ON_COMPANY_CHANGE_EVENT",companyId),resolve()})).catch((function(error){reject(error)}))}))},service.deleteBanner=function(companyId){return $q((function(resolve,reject){$http({method:"DELETE",url:service.portalURL+"companies/"+companyId+"/banner",headers:authService.getRequestHeader()}).then((function(){$rootScope.$broadcast("ON_COMPANY_CHANGE_EVENT",companyId),$log.info("[adminCompanyService] deleteBanner success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"deleteBanner"))}))}))},service.getCompanySupportBot=function(companyId){return $q((function(resolve,reject){var url=service.portalURL+"bots/rainbow-support";companyId&&(url+="?companyId="+companyId),$http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){$log.info("[companyService] getCompanySupportBot success");var supportBot=Bot.create(response.data.data);resolve(supportBot)})).catch((function(response){var errorMessage="getCompanySupportBot failure "+response.data.errorDetails+" with status "+response.status;$log.error("[companyService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.pushCompanyBotAvatar=function(botId,companyId,avatarImg){return $q((function(resolve,reject){var pushServiceURL=service.portalURL+"bots/"+botId+"/companies/"+companyId+"/avatar";(angular.isDefined(avatarImg)&&null!==avatarImg?pushImageHelperService.pushImage(pushServiceURL,avatarImg):$q.resolve()).then((function(){$log.info("[adminCompanyService] pushCompanyBotAvatar success"),resolve()})).catch((function(error){reject(error)}))}))},service.deleteCompanyBotAvatar=function(botId,companyId){return $q((function(resolve,reject){$http({method:"DELETE",url:service.portalURL+"bots/"+botId+"/companies/"+companyId+"/avatar",headers:authService.getRequestHeader()}).then((function(){$log.info("[adminCompanyService] deleteCompanyBotAvatar success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[botService] "+errorHelperService.getErrorFullMessage(response,"deleteCompanyBotAvatar"))}))}))},service.getCompanyInvitations=function(companyId,page,pageSize){return $q((function(resolve,reject){var url=service.portalURL+"companies/"+companyId+"/join-companies/invitations?format=medium&status=pending declined&limit="+pageSize;page&&(url+="&offset="+pageSize*(page-1)),$http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){var invitations=[];response.data.data.forEach((function(invitationData){var invitation=CompanyInvitation.createFromData(invitationData);invitations.push(invitation)})),$log.info("[adminCompanyService] getCompanyInvitations success (found "+invitations.length+" invitation(s))"),resolve({invitations:invitations,total:response.data.total})}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanyInvitations"))}))}))},service.joinCompanyInvitation=function(companyId,email,invitedUserId,customMessage,invitedToBeCompanyAdmin,invitedToBeBpAdmin){var defered=$q.defer(),data={lang:settingsService.getAppliLanguageCodeForServer()};return customMessage&&(data.customMessage=customMessage),invitedUserId?data.invitedUserId=invitedUserId:email&&(data.email=email),invitedToBeCompanyAdmin&&(data.invitedToBeCompanyAdmin=invitedToBeCompanyAdmin),invitedToBeBpAdmin&&(data.invitedToBeBpAdmin=invitedToBeBpAdmin),$http({method:"POST",url:service.portalURL+"companies/"+companyId+"/join-companies/invitations",headers:authService.getRequestHeader(),data:data}).then((function(){$log.info("[adminCompanyService] joinCompanyInvitation success"),defered.resolve()}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"joinCompanyInvitation"))})),defered.promise},service.cancelJoinCompanyInvitation=function(companyId,invitationId){var defered=$q.defer();return $http({method:"POST",url:service.portalURL+"companies/"+companyId+"/join-companies/invitations/"+invitationId+"/cancel",headers:authService.getRequestHeader()}).then((function(response){var invitation=CompanyInvitation.createFromData(response.data.data);$log.info("[adminCompanyService] cancelJoinCompanyInvitation success"),defered.resolve(invitation)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"cancelJoinCompanyInvitation"))})),defered.promise},service.resendJoinCompanyInvitation=function(companyId,invitationId){var defered=$q.defer();return $http({method:"POST",url:service.portalURL+"companies/"+companyId+"/join-companies/invitations/"+invitationId+"/re-send",headers:authService.getRequestHeader()}).then((function(response){var invitation=CompanyInvitation.createFromData(response.data.data);$log.info("[adminCompanyService] resendJoinCompanyInvitation success"),defered.resolve(invitation)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"resendJoinCompanyInvitation"))})),defered.promise},service.getCompanyJoinRequests=function(companyId){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"/join-companies/requests?format=medium&status=pending",headers:authService.getRequestHeader()}).then((function(response){var companyRequests=[];response.data.data.forEach((function(companyRequestData){var companyRequest=CompanyRequest.createFromData(companyRequestData);companyRequests.push(companyRequest)})),$log.info("[adminCompanyService] getCompanyJoinRequests success (found "+response.data.total+" invitation(s))"),resolve({companyRequests:companyRequests,total:response.data.total})}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanyJoinRequests"))}))}))},service.getJoinCompanyRequest=function(companyId,joinCompanyRequestId){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"/join-companies/requests/"+joinCompanyRequestId+"?status=pending",headers:authService.getRequestHeader()}).then((function(response){var joinCompanyRequest=CompanyRequest.createFromData(response.data.data);$log.info("[adminCompanyService] getJoinCompanyRequest success"),resolve(joinCompanyRequest)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getJoinCompanyRequest"))}))}))},service.acceptCompanyJoinRequests=function(companyId,joinCompanyRequestId){return $q((function(resolve,reject){$http({method:"POST",url:service.portalURL+"companies/"+companyId+"/join-companies/requests/"+joinCompanyRequestId+"/accept",headers:authService.getRequestHeader()}).then((function(response){var joinCompanyRequest=CompanyRequest.createFromData(response.data.data);$log.info("[adminCompanyService] acceptCompanyJoinRequests success"),resolve(joinCompanyRequest)}),(function(response){var error=errorHelperService.handleError(response);$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"acceptCompanyJoinRequests")),reject(error)}))}))},service.declineCompanyJoinRequests=function(companyId,joinCompanyRequestId){return $q((function(resolve,reject){$http({method:"POST",url:service.portalURL+"companies/"+companyId+"/join-companies/requests/"+joinCompanyRequestId+"/decline",headers:authService.getRequestHeader()}).then((function(response){var joinCompanyRequest=CompanyRequest.createFromData(response.data.data);$log.info("[adminCompanyService] declineCompanyJoinRequests success"),resolve(joinCompanyRequest)}),(function(response){var error=errorHelperService.handleError(response);$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"declineCompanyJoinRequests")),reject(error)}))}))},service.getOAuthConsentUrl=function(){var lang=settingsService.getAppliLanguage().code;return $q((function(resolve,reject){$http({method:"GET",url:config.restServerUrl+"/api/rainbow/office365/v1.0/consent?callback="+window.location.origin+"/redirectO365.html?provider=o365&lang="+lang,headers:authService.getRequestHeader()}).then((function(response){var consentUrl=response.data.url;$log.info("[adminCompanyService] getOAuthConsentUrl success: "+consentUrl),resolve(consentUrl)}),(function(response){var error=errorHelperService.handleError(response);$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getOAuthConsentUrl")),reject(error)}))}))},service.getCompanyConferenceSettings=function(companyId){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"/settings/conferences",headers:authService.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getCompanyConferenceSettings success");var data=response.data.data;resolve(data)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanyConferenceSettings"))}))}))},service.setCompanyConferenceSettings=function(companyId,confDialOutEnabled){return $q((function(resolve,reject){var conferenceSettingData={confDialOutDisabled:!confDialOutEnabled};$http({method:"PUT",url:service.portalURL+"companies/"+companyId+"/settings/conferences",headers:authService.getRequestHeader(),data:conferenceSettingData}).then((function(response){$log.info("[adminCompanyService] setCompanyConferenceSettings success");var data=response.data.data;resolve(data)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"setCompanyConferenceSettings"))}))}))},service.getCompanySAMLConfigurationFile=function(companyId){return $q((function(resolve,reject){authService.getCompanySAMLConfiguration(companyId).then((function(data){var blob=new Blob([data],{type:"application/xml"});resolve(blob)})).catch((function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanySAMLConfigurationFile"))}))}))},service.createCompanySingleSignOnServerConfig=function(companyId,singleSignOnType,config){return $q((function(resolve,reject){config.type=singleSignOnType,$http({method:"POST",url:service.portalURL+"companies/"+companyId+"/settings/sso",headers:authService.getRequestHeader(),data:config}).then((function(response){$log.info("[adminCompanyService] createCompanySingleSignOnServerConfig success");var config=response.data.data;resolve(config)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"createCompanySingleSignOnServerConfig"))}))}))},service.deleteCompanySingleSignOnServerConfig=function(companyId,singleSignOnType){return $q((function(resolve,reject){$http({method:"DELETE",url:service.portalURL+"companies/"+companyId+"/settings/sso/"+singleSignOnType,headers:authService.getRequestHeader()}).then((function(){$log.info("[adminCompanyService] deleteCompanySingleSignOnServerConfig success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"deleteCompanySingleSignOnServerConfig"))}))}))},service.getCompanySingleSignOnServerConfig=function(companyId){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"/settings/sso",headers:authService.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getCompanySingleSignOnServerConfig success");var configArray=response.data.data?response.data.data:response.data;resolve(configArray)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanySingleSignOnServerConfig"))}))}))},service.updateCompanySingleSignOnServerConfig=function(companyId,singleSignOnType,config){return $q((function(resolve,reject){$http({method:"PUT",url:service.portalURL+"companies/"+companyId+"/settings/sso/"+singleSignOnType,headers:authService.getRequestHeader(),data:config}).then((function(response){$log.info("[adminCompanyService] updateCompanySingleSignOnConfig success");var config=response.data.data;resolve(config)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"updateCompanySingleSignOnConfig"))}))}))},service.getCompanyBpBusinessTypes=function(){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/bpbusinesstypes",headers:authService.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getCompanyBpBusinessTypes success");var config=response.data.data;resolve(config)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanyBpBusinessTypes"))}))}))},service.getVoIPSettingsForCompany=function(companyId){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"/settings/webrtcs",headers:authService.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getVoIPSettingsForCompany success");var settings=response.data.data;resolve(settings)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getVoIPSettingsForCompany"))}))}))},service.createVoIPSettingsForCompany=function(companyId,settings){return $q((function(resolve,reject){$http({method:"POST",url:service.portalURL+"companies/"+companyId+"/settings/webrtcs",headers:authService.getRequestHeader(),data:settings}).then((function(__response){resolve()}),(function(response){var error=errorHelperService.handleError(response);$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"createVoIPSettingsForCompany")),reject(error)}))}))},service.updateVoIPSettingsForCompany=function(companyId,settingsId,settings){return $q((function(resolve,reject){$http({method:"PUT",url:service.portalURL+"companies/"+companyId+"/settings/webrtcs/"+settingsId,headers:authService.getRequestHeader(),data:settings}).then((function(__response){resolve()}),(function(response){var error=errorHelperService.handleError(response);$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"createVoIPSettingsForCompany")),reject(error)}))}))}}])},function(module,exports){angular.module("rainbow").service("adminUserService",["$q","$log","$http","authService","errorHelperService","Company","User","Site","Organisation","userInfoService","contactService","PhoneNumber",function($q,$log,$http,authService,errorHelperService,Company,User,Site,Organisation,userInfoService,contactService,PhoneNumber){"use strict";var service=this;service.start=function(){return $log.info("[adminUserService] === STARTING ==="),service.portalURL=config.restServerUrl+"/api/rainbow/admin/v1.0/",$log.info("[adminUserService] === STARTED ==="),$q.when()},service.stop=function(){return $log.info("[adminUserService] === STOPPING ==="),$log.info("[adminUserService] === STOPPED ==="),$q.when()},service.getUsersByEmail=function(source,email){return $q((function(resolve,reject){var url=service.portalURL+"users?format=full";source&&source instanceof Organisation&&(url+="&organisationId="+source.id),source&&source instanceof Company&&(url+="&companyId="+source.id),source&&source instanceof Site&&(url+="&siteId="+source.id),email&&(url+="&email="+encodeURIComponent(email)),$http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){var data=response.data.data;$log.info("[adminUserService] getUsersByEmail success (find "+response.data.total+" user(s))");var users=[];data.forEach((function(userData){var user=User.createFromData(userData);users.push(user)})),resolve({users:users,total:response.data.total})}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"getUsersByEmail"))}))}))},service.getUsers=function(source,page,pageSize,searchPattern,isTerminated,isAdministrator,noDefaultValues,searchByTag){return $q((function(resolve,reject){var url=service.portalURL+"users?format=full&limit="+pageSize;source&&source instanceof Organisation&&(url+="&organisationId="+source.id),source&&source instanceof Company&&(url+="&companyId="+source.id),source&&source instanceof Site&&(url+="&siteId="+source.id),page&&(url+="&offset="+pageSize*(page-1)),searchPattern&&!searchByTag&&(url+="&displayName="+encodeURIComponent(searchPattern)+"&useEmails=true"),searchPattern&&searchByTag&&(url+="&tags="+encodeURIComponent(searchPattern)),null!=isTerminated&&(url+="&isTerminated="+isTerminated),isAdministrator&&(url+="&roles=admin&roles=bp_admin&roles=bp_finance&roles=superadmin&roles=business_admin"),$http({method:"GET",url:url+="&sortField=reverseDisplayName",headers:authService.getRequestHeader()}).then((function(response){var data=response.data.data;$log.info("[adminUserService] getUsers success (find "+response.data.total+" user(s))");var users=[];data.forEach((function(userData){var user=User.createFromData(userData,noDefaultValues);users.push(user)})),resolve({users:users,limit:response.data.limit,offset:response.data.offset,total:response.data.total})}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"getUsers"))}))}))},service.searchUsers=function(source,page,pageSize,searchPattern){return $q((function(resolve,reject){var url=config.restServerUrl+"/api/rainbow/search/v1.0/users?limit="+pageSize;source&&(url+="&companyId="+source.id),page&&(url+="&offset="+pageSize*(page-1)),searchPattern&&(url+="&displayName="+encodeURIComponent(searchPattern)),$http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){var data=response.data.data;$log.info("[adminUserService] searchUsers success (find "+response.data.total+" user(s))");var users=[];data.forEach((function(userData){var user=User.createFromData(userData);users.push(user)})),resolve({users:users,total:response.data.total})}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"searchUsers"))}))}))},service.getUser=function(userId){var defered=$q.defer();return $http({method:"GET",url:service.portalURL+"users/"+userId,headers:authService.getRequestHeader()}).then((function(response){$log.info("[adminUserService] getUser success");var data=response.data.data,user=User.createFromData(data);defered.resolve(user)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"getUser"))})),defered.promise},service.createUser=function(user){var userData=User.prune(user,contactService.userContact),defered=$q.defer();return $http({method:"POST",url:service.portalURL+"users",headers:authService.getRequestHeader(),data:userData}).then((function(response){var newuser=User.createFromData(response.data.data);$log.info("[adminUserService] createUser success"),defered.resolve(newuser)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"createUser"))})),defered.promise},service.deleteUser=function(user){var defered=$q.defer();return $http({method:"DELETE",url:service.portalURL+"users/"+user.id,headers:authService.getRequestHeader()}).then((function(){$log.info("[adminUserService] deleteUser success"),defered.resolve()}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"deleteUser"))})),defered.promise},service.updateUser=function(user){var userData=User.prune(user,contactService.userContact),defered=$q.defer();return $http({method:"PUT",url:service.portalURL+"users/"+user.id,headers:authService.getRequestHeader(),data:userData}).then((function(){$log.info("[adminUserService] updateUser success"),defered.resolve()}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"updateUser"))})),defered.promise},service.getUserAvatar=function(user){var color=userInfoService.computeUserColor(user.firstName+" "+user.lastName).color;userInfoService.getAvatarImage(user.id,user.initials,color,50,user.lastAvatarUpdateDate).then((function(image){user.image=image}))},service.expandTelephonyInfo=function(user){var result={};return user.phoneNumbers&&user.phoneNumbers.forEach((function(phoneNumber){var number=phoneNumber.number,numberCan=phoneNumber.numberE164,deviceType=phoneNumber.deviceType;switch(phoneNumber.type){case"work":"landline"===deviceType&&(phoneNumber.isCloudPbxDDI?(result.phonePro=phoneNumber.number,result.phoneProCan=phoneNumber.numberE164,result.phoneProDdiNumber=PhoneNumber.createFromData(phoneNumber)):result.phoneProNumber&&result.phoneProNumber.systemId||(result.phoneProDdiNumber||(result.phonePro=number,result.phoneProCan=numberCan),result.phoneProExt=phoneNumber.shortNumber,result.phoneProIsMonitored=phoneNumber.isMonitored,result.phoneProNumber=PhoneNumber.createFromData(phoneNumber))),"mobile"===deviceType&&(result.mobilePro=number,result.mobileProCan=numberCan);break;case"home":"landline"===deviceType&&(result.phonePerso=number,result.phonePersoCan=numberCan),"mobile"===deviceType&&(result.mobilePerso=number,result.mobilePersoCan=numberCan);break;case"rainbow":result.rainbowPhoneNumber=number}})),result},service.getAllUsers=function(source,noDefaultValues){return $q((function(resolve,reject){var result;service.getUsers(source,1,1e3,void 0,void 0,void 0,noDefaultValues).then((function(response){if(result=response,response.total>response.limit){var totalPages=Math.ceil(response.total/1e3),pages=Array.apply(null,Array(totalPages-1));pages=pages.map((function(__unused,index){return index+2}));for(var chunks=[];pages.length>0;)chunks.push(pages.splice(0,5));return chunks.reduce((function(promiseChain,requests){return promiseChain.then((function(){var promisesArray=requests.map((function(page){return service.getUsers(source,page,1e3,void 0,void 0,void 0,noDefaultValues).then((function(data){result.users=result.users.concat(data.users),result.limit+=data.limit}))}));return $q.all(promisesArray)}))}),$q.resolve())}})).then((function(){resolve(result)})).catch((function(error){reject(error)}))}))},service.getUserTags=function(companyId){return $q((function(resolve,reject){var url=service.portalURL+"users/tags";companyId&&(url+="?companyId="+companyId),$http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){var tags=response.data.data.tags||[];$log.info("[adminUserService] getUserTags success (find "+tags.length+"tags(s))"),resolve(tags)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"getUserTags"))}))}))},service.getUserTagsStats=function(companyId){return $q((function(resolve,reject){var url=service.portalURL+"users/tags/stats";companyId&&(url+="?companyId="+companyId),$http({method:"GET",url:url,headers:authService.getRequestHeader()}).then((function(response){var tagsStats=response.data.data.stats||[];$log.info("[adminUserService] getUserTagsStats success (find "+tagsStats.length+"tags(s))"),resolve(tagsStats)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"getUserTagsStats"))}))}))},service.renameUserTag=function(tag,newTagName,companyId){return $q((function(resolve,reject){var url=service.portalURL+"users/tags?tag="+encodeURIComponent(tag);companyId&&(url+="&companyId="+companyId),$http({method:"PUT",url:url,headers:authService.getRequestHeader(),data:{newTagName:newTagName}}).then((function(response){$log.info("[adminUserService] renameUserTag success => old tag: "+tag+" => new tag: "+newTagName+": found "+response.data.data.found+" occurence(s)"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"renameUserTag"))}))}))},service.deleteUserTag=function(tag,companyId){return $q((function(resolve,reject){var url=service.portalURL+"users/tags?tag="+encodeURIComponent(tag);companyId&&(url+="&companyId="+companyId),$http({method:"DELETE",url:url,headers:authService.getRequestHeader()}).then((function(response){$log.info("[adminUserService] deleteUserTag success (tag "+tag+": found "+response.data.data.found+" occurence(s)"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"deleteUserTag"))}))}))},service.getUserProfilesFeatures=function(userId){return $q((function(resolve,reject){$http({method:"GET",url:config.restServerUrl+"/api/rainbow/admin/v1.0/users/"+userId+"/profiles/features",headers:authService.getRequestHeader()}).then((function(response){var features={};response.data.data.forEach((function(featureData){$log.debug("[adminUserService] getUserProfilesFeatures === response ==="+JSON.stringify(featureData)),featureData.hasOwnProperty("featureUniqueRef")&&(features[featureData.featureUniqueRef]=featureData)})),resolve(features)}),(function(response){if(404===response.status)$log.debug("[adminUserService] getUserProfilesFeatures : features found for user: "+userId),resolve();else{var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"getUserProfilesFeatures"))}}))}))}}])},function(module,exports){angular.module("rainbow").filter("emojione",["$sce","$sanitize",function($sce,$sanitize){"use strict";return function(input){if(!angular.isString(input))return input;var temp=input.split(" ");return temp.forEach((function(item,index){""!==this[index]&&-1===this[index].indexOf("http://")&&-1===this[index].indexOf("https://")&&(this[index]=emojione.shortnameToImage(this[index]))}),temp),input=temp.join(" "),$sanitize($sce.trustAsHtml(input))}}]),angular.module("rainbow").filter("emojiUnicodeToShort",(function(){"use strict";return function(input){if(!angular.isString(input))return input;var temp=input.split(" ");return temp.forEach((function(__item,index){""!==this[index]&&-1===this[index].indexOf("http://")&&-1===this[index].indexOf("https://")&&(this[index]=emojione.toShort(this[index]))}),temp),input=temp.join(" ")}})),angular.module("rainbow").filter("emojiShortToUnicode",(function(){"use strict";return function(input){if(!angular.isString(input))return input;var temp=input.split(" ");return temp.forEach((function(__item,index){""!==this[index]&&-1===this[index].indexOf("http://")&&-1===this[index].indexOf("https://")&&(this[index]=emojione.shortnameToUnicode(this[index]))}),temp),input=temp.join(" ")}}))},function(module,exports){angular.module("rainbow").factory("PromiseQueue",["$log",function($log){"use strict";function PromiseQueue(){var that=this;this.queue=[],this.started=!1,this.add=function(promise){this.queue.push(promise),this.started||(this.started=!0,this.execute())},this.execute=function(){var promise=this.queue.shift();if(promise)try{that.timeoutPromise(2e4,promise).then((function(){that.execute()})).catch((function(error){var errorMessage=error&&error.message?error.message:"Unknown error";$log.error("[PromiseQueue] execute failure -- "+errorMessage),that.execute()}))}catch(error){var errorMessage=error&&error.message?error.message:"Unknown error",errorStack=error&&error.stack?error.stack:"Unknown stack";$log.error("[PromiseQueue] execution exception  -- "+errorMessage+" : "+errorStack),that.execute()}else this.started=!1},that.timeoutPromise=function(ms,promise){var timeoutId,timeout=new Promise((function(resolve,reject){timeoutId=setTimeout((function(){reject(new Error("Timed out in "+ms+"ms."))}),ms)}));return Promise.race([promise(),timeout]).then((function(value){return clearTimeout(timeoutId),value}))}}return PromiseQueue.create=function(){return new PromiseQueue},PromiseQueue}])},function(module,exports){angular.module("rainbow").factory("TransfertPromiseQueue",["$log","$q",function($log,$q){"use strict";function TransfertPromiseQueue(){var that=this;that.fileQueue=[],that.clearContext=function(){that.currentId=null,that.currentQueue=[],that.promiseCompletion=void 0,that.promiseReject=void 0,that.initialQueueSize=0,that.promisesDone=0,that.chunkErrorCounter=0,that.currentPromise=void 0},that.clearContext(),that.addPromiseArray=function(id,promiseArray,promiseCompletion,promiseReject){$log.debug("[TransfertPromiseQueue] adding promiseArray");var promiseInfos={};return promiseInfos.id=id,promiseInfos.promiseArray=promiseArray,promiseInfos.promiseCompletion=promiseCompletion,promiseInfos.promiseReject=promiseReject,0!==that.fileQueue.length||that.currentPromise?(that.fileQueue.push(promiseInfos),$log.debug("[TransfertPromiseQueue] adding PromiseArray in FileQueue: "+that.fileQueue.length)):($log.debug("[TransfertPromiseQueue] configuring file to transfert: "+promiseInfos.promiseArray.length),that.fileQueue.push(promiseInfos),that.popFileQueue()),$log.debug("[TransfertPromiseQueue] adding promise on FileQueue: "+that.fileQueue.length),$q},that.popFileQueue=function(){if(that.fileQueue.length>0){$log.debug("[TransfertPromiseQueue] go to next file");var promiseInfos=that.fileQueue.shift();that.currentId=promiseInfos.id,that.currentQueue=promiseInfos.promiseArray,that.promiseCompletion=promiseInfos.promiseCompletion,that.promiseReject=promiseInfos.promiseReject,that.initialQueueSize=that.currentQueue.length,that.promisesDone=0,that.chunkErrorCounter=0,that.currentPromise=that.currentQueue.shift(),that.execute()}else $log.debug("[TransfertPromiseQueue] no more file to transfert"),that.clearContext()},that.execute=function(){$log.debug("[TransfertPromiseQueue] execute"),that.currentPromise?($log.debug("[TransfertPromiseQueue] performing promise: "+that.promisesDone),that.currentPromise().then((function(){$log.debug("[TransfertPromiseQueue] promise success go to next one"),that.promisesDone++,that.chunkErrorCounter=0,that.promisesDone>=that.initialQueueSize?(that.promiseCompletion&&that.promiseCompletion(),that.popFileQueue()):(that.currentPromise=that.currentQueue.shift(),that.execute())})).catch((function(error){var errorMessage=error&&error.message?error.message:"Unknown error";$log.error("[TransfertPromiseQueue] failure executing promise -- "+errorMessage),that.chunkErrorCounter++,error&&error.errorDetailsCode>=500&&that.chunkErrorCounter<=3?that.execute():($log.error("[TransfertPromiseQueue] 3 chunk failed - ABORT File Upload"),that.promiseReject(error),that.popFileQueue())}))):($log.debug("[TransfertPromiseQueue] no promise to perform"),that.currentPromise=void 0)},that.isTransferInProgress=function(){return $log.debug("[TransfertPromiseQueue] >isTransferInProgress: "+that.fileQueue.length+"/"+that.currentQueue.length),that.fileQueue.length>0||that.currentQueue.length>0||that.currentPromise},that.cancelAllTransfers=function(){$log.debug("[TransfertPromiseQueue] cancelAllTransfers"),that.fileQueue=[],that.currentQueue=[]},that.cancelCurrentFiletransfer=function(id){if($log.debug("[TransfertPromiseQueue] cancelCurrentFiletransfer"),that.currentId===id)$log.debug("[TransfertPromiseQueue] cancelling current promise"),that.popFileQueue();else{var promiseFound=that.fileQueue.find((function(currentPromiseInfos){return currentPromiseInfos.id===id}));if(promiseFound){var promisePos=that.fileQueue.indexOf(promiseFound);$log.debug("[TransfertPromiseQueue] promise to remove at position="+promisePos),that.fileQueue.splice(promisePos,1)}}}}return TransfertPromiseQueue.create=function(){return $log.debug("[TransfertPromiseQueue] >create"),new TransfertPromiseQueue},TransfertPromiseQueue}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),window.sdk=angular.module("sdk",["pascalprecht.translate","ngSanitize","ngFileSaver","angular-jwt","uuid4","rainbow","rainbowAdmin"],(function(){})),__webpack_exports__.default={sdk:sdk}},function(module,exports){sdk.constant("SDK",{OK:1,ERROR:-1,ERRORUNAUTHORIZED:-2,ERRORXMPP:-4,ERRORXMPPJID:-8,ERRORBADREQUEST:-16,ERRORUNSUPPORTED:-32,ERRORNOTFOUND:-64})},function(module,exports){sdk.remoteConsole={debug:!1,log:!1,info:!1,warn:!1,error:!1},sdk.hasVerboseLog=!1,sdk.hasBeenLaunchedFromConfig=!1,sdk.key={appID:"",appSecret:"",host:"openrainbow.com"},sdk.config(["consoleLogsProvider","$provide","$httpProvider","$translateProvider",function(consoleLogsProvider,$provide,$httpProvider,$translateProvider){var utc=function(now){return now.toDateString()+" "+("0"+now.getHours()).slice(-2)+":"+("0"+now.getMinutes()).slice(-2)+":"+("0"+now.getSeconds()).slice(-2)};$provide.decorator("$log",["$delegate",function($delegate){var origDebug=$delegate.debug;$delegate.debug=function(){var args=[].slice.call(arguments);sdk.remoteConsole.debug&&console.re.debug(args[0]),sdk.hasVerboseLog&&origDebug.apply(null,args),consoleLogsProvider.setLogs(["["+utc(new Date)+"]"]+"debug : "+args+"\n")};var origLog=$delegate.log;$delegate.log=function(){var args=[].slice.call(arguments);sdk.remoteConsole.log&&console.re.log(args[0]),sdk.hasVerboseLog&&origLog.apply(null,args),consoleLogsProvider.setLogs(["["+utc(new Date)+"]"]+"log : "+args+"\n")};var origInfo=$delegate.info;$delegate.info=function(){var args=[].slice.call(arguments);sdk.remoteConsole.info&&console.re.info(args[0]),sdk.hasVerboseLog&&origInfo.apply(null,args),consoleLogsProvider.setLogs(["["+utc(new Date)+"]"]+"info : "+args+"\n")};var origWarn=$delegate.warn;$delegate.warn=function(){var args=[].slice.call(arguments);sdk.remoteConsole.warn&&console.re.warn(args[0]),origWarn.apply(null,args),consoleLogsProvider.setLogs(["["+utc(new Date)+"]"]+"warn : "+args+"\n")};var origError=$delegate.error;return $delegate.error=function(){var args=[].slice.call(arguments);sdk.remoteConsole.error&&console.re.error(args[0]),origError.apply(null,args),consoleLogsProvider.setLogs(["["+utc(new Date)+"]"]+"error : "+args+"\n")},$delegate.webrtc=function(){var args=[].slice.call(arguments),logs="rtcweb : "+args[0];args[0]="%c "+utc(new Date)+" | RTCWEB | "+args[0],args[args.length]="color:green",sdk.remoteConsole.log&&console.re.log(args[0]),origDebug.apply(null,args),consoleLogsProvider.setLogs(["["+utc(new Date)+"]"]+logs+"\n")},$delegate.sdk=function(){var args=[].slice.call(arguments),logs="RBW-SDK : "+args[0];args[0]="%c "+utc(new Date)+" | RBW-SDK | "+args[0],args[args.length]="color:green",sdk.remoteConsole.log&&console.re.log(args[0]),origDebug.apply(null,args),consoleLogsProvider.setLogs(["["+utc(new Date)+"]"]+logs+"\n")},$delegate}]),$httpProvider.defaults.useXDomain=!0,$translateProvider.useSanitizeValueStrategy(null)}]),sdk.run([function(){}]),sdk.provider("consoleLogs",[function(){this.logsBuffer=[],this.logsMaxLength=2e6,this.$get=function(){var logsBuffer=this.logsBuffer;return{getLogs:function(){return logsBuffer}}},this.cleanBuffer=function(){this.logsBuffer.length>this.logsMaxLength&&(this.logsBuffer=this.logsBuffer.slice(-this.logsMaxLength))},this.setLogs=function(logs){1e3===this.logsBuffer&&this.logsBuffer.shift(),this.logsBuffer.push(logs)}}])},function(module,exports){window.config={xmpp:{protocol:"wss",server:"sandbox.openrainbow.com",port:"443",pingInterval:"60000"},webservices:{protocol:"https",server:"sandbox.openrainbow.com",port:"443"},cpaas:{protocol:"https",server:"",port:"8887"}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var chrome_shim_namespaceObject={};__webpack_require__.r(chrome_shim_namespaceObject),__webpack_require__.d(chrome_shim_namespaceObject,"shimGetUserMedia",(function(){return shimGetUserMedia})),__webpack_require__.d(chrome_shim_namespaceObject,"shimGetDisplayMedia",(function(){return shimGetDisplayMedia})),__webpack_require__.d(chrome_shim_namespaceObject,"shimMediaStream",(function(){return shimMediaStream})),__webpack_require__.d(chrome_shim_namespaceObject,"shimOnTrack",(function(){return shimOnTrack})),__webpack_require__.d(chrome_shim_namespaceObject,"shimGetSendersWithDtmf",(function(){return shimGetSendersWithDtmf})),__webpack_require__.d(chrome_shim_namespaceObject,"shimGetStats",(function(){return shimGetStats})),__webpack_require__.d(chrome_shim_namespaceObject,"shimSenderReceiverGetStats",(function(){return shimSenderReceiverGetStats})),__webpack_require__.d(chrome_shim_namespaceObject,"shimAddTrackRemoveTrackWithNative",(function(){return shimAddTrackRemoveTrackWithNative})),__webpack_require__.d(chrome_shim_namespaceObject,"shimAddTrackRemoveTrack",(function(){return shimAddTrackRemoveTrack})),__webpack_require__.d(chrome_shim_namespaceObject,"shimPeerConnection",(function(){return shimPeerConnection})),__webpack_require__.d(chrome_shim_namespaceObject,"fixNegotiationNeeded",(function(){return fixNegotiationNeeded}));var edge_shim_namespaceObject={};__webpack_require__.r(edge_shim_namespaceObject),__webpack_require__.d(edge_shim_namespaceObject,"shimGetUserMedia",(function(){return getusermedia_shimGetUserMedia})),__webpack_require__.d(edge_shim_namespaceObject,"shimGetDisplayMedia",(function(){return getdisplaymedia_shimGetDisplayMedia})),__webpack_require__.d(edge_shim_namespaceObject,"shimPeerConnection",(function(){return edge_shim_shimPeerConnection})),__webpack_require__.d(edge_shim_namespaceObject,"shimReplaceTrack",(function(){return shimReplaceTrack}));var firefox_shim_namespaceObject={};__webpack_require__.r(firefox_shim_namespaceObject),__webpack_require__.d(firefox_shim_namespaceObject,"shimGetUserMedia",(function(){return firefox_getusermedia_shimGetUserMedia})),__webpack_require__.d(firefox_shim_namespaceObject,"shimGetDisplayMedia",(function(){return firefox_getdisplaymedia_shimGetDisplayMedia})),__webpack_require__.d(firefox_shim_namespaceObject,"shimOnTrack",(function(){return firefox_shim_shimOnTrack})),__webpack_require__.d(firefox_shim_namespaceObject,"shimPeerConnection",(function(){return firefox_shim_shimPeerConnection})),__webpack_require__.d(firefox_shim_namespaceObject,"shimSenderGetStats",(function(){return shimSenderGetStats})),__webpack_require__.d(firefox_shim_namespaceObject,"shimReceiverGetStats",(function(){return shimReceiverGetStats})),__webpack_require__.d(firefox_shim_namespaceObject,"shimRemoveStream",(function(){return shimRemoveStream})),__webpack_require__.d(firefox_shim_namespaceObject,"shimRTCDataChannel",(function(){return shimRTCDataChannel})),__webpack_require__.d(firefox_shim_namespaceObject,"shimAddTransceiver",(function(){return shimAddTransceiver})),__webpack_require__.d(firefox_shim_namespaceObject,"shimCreateOffer",(function(){return shimCreateOffer})),__webpack_require__.d(firefox_shim_namespaceObject,"shimCreateAnswer",(function(){return shimCreateAnswer}));var safari_shim_namespaceObject={};__webpack_require__.r(safari_shim_namespaceObject),__webpack_require__.d(safari_shim_namespaceObject,"shimLocalStreamsAPI",(function(){return shimLocalStreamsAPI})),__webpack_require__.d(safari_shim_namespaceObject,"shimRemoteStreamsAPI",(function(){return shimRemoteStreamsAPI})),__webpack_require__.d(safari_shim_namespaceObject,"shimCallbacksAPI",(function(){return shimCallbacksAPI})),__webpack_require__.d(safari_shim_namespaceObject,"shimGetUserMedia",(function(){return safari_shim_shimGetUserMedia})),__webpack_require__.d(safari_shim_namespaceObject,"shimConstraints",(function(){return shimConstraints})),__webpack_require__.d(safari_shim_namespaceObject,"shimRTCIceServerUrls",(function(){return shimRTCIceServerUrls})),__webpack_require__.d(safari_shim_namespaceObject,"shimTrackEventTransceiver",(function(){return shimTrackEventTransceiver})),__webpack_require__.d(safari_shim_namespaceObject,"shimCreateOfferLegacy",(function(){return shimCreateOfferLegacy}));var common_shim_namespaceObject={};__webpack_require__.r(common_shim_namespaceObject),__webpack_require__.d(common_shim_namespaceObject,"shimRTCIceCandidate",(function(){return shimRTCIceCandidate})),__webpack_require__.d(common_shim_namespaceObject,"shimMaxMessageSize",(function(){return shimMaxMessageSize})),__webpack_require__.d(common_shim_namespaceObject,"shimSendThrowTypeError",(function(){return shimSendThrowTypeError})),__webpack_require__.d(common_shim_namespaceObject,"shimConnectionState",(function(){return shimConnectionState})),__webpack_require__.d(common_shim_namespaceObject,"removeAllowExtmapMixed",(function(){return removeAllowExtmapMixed}));var adapter_core_namespaceObject={};__webpack_require__.r(adapter_core_namespaceObject),__webpack_require__.d(adapter_core_namespaceObject,"default",(function(){return adapter_core}));let logDisabled_=!0,deprecationWarnings_=!0;function extractVersion(uastring,expr,pos){const match=uastring.match(expr);return match&&match.length>=pos&&parseInt(match[pos],10)}function wrapPeerConnectionEvent(window,eventNameToWrap,wrapper){if(!window.RTCPeerConnection)return;const proto=window.RTCPeerConnection.prototype,nativeAddEventListener=proto.addEventListener;proto.addEventListener=function(nativeEventName,cb){if(nativeEventName!==eventNameToWrap)return nativeAddEventListener.apply(this,arguments);const wrappedCallback=e=>{const modifiedEvent=wrapper(e);modifiedEvent&&cb(modifiedEvent)};return this._eventMap=this._eventMap||{},this._eventMap[cb]=wrappedCallback,nativeAddEventListener.apply(this,[nativeEventName,wrappedCallback])};const nativeRemoveEventListener=proto.removeEventListener;proto.removeEventListener=function(nativeEventName,cb){if(nativeEventName!==eventNameToWrap||!this._eventMap||!this._eventMap[cb])return nativeRemoveEventListener.apply(this,arguments);const unwrappedCb=this._eventMap[cb];return delete this._eventMap[cb],nativeRemoveEventListener.apply(this,[nativeEventName,unwrappedCb])},Object.defineProperty(proto,"on"+eventNameToWrap,{get(){return this["_on"+eventNameToWrap]},set(cb){this["_on"+eventNameToWrap]&&(this.removeEventListener(eventNameToWrap,this["_on"+eventNameToWrap]),delete this["_on"+eventNameToWrap]),cb&&this.addEventListener(eventNameToWrap,this["_on"+eventNameToWrap]=cb)},enumerable:!0,configurable:!0})}function disableLog(bool){return"boolean"!=typeof bool?new Error("Argument type: "+typeof bool+". Please use a boolean."):(logDisabled_=bool,bool?"adapter.js logging disabled":"adapter.js logging enabled")}function disableWarnings(bool){return"boolean"!=typeof bool?new Error("Argument type: "+typeof bool+". Please use a boolean."):(deprecationWarnings_=!bool,"adapter.js deprecation warnings "+(bool?"disabled":"enabled"))}function log(){if("object"==typeof window){if(logDisabled_)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function deprecated(oldMethod,newMethod){deprecationWarnings_&&console.warn(oldMethod+" is deprecated, please use "+newMethod+" instead.")}function detectBrowser(window){const{navigator:navigator}=window,result={browser:null,version:null};if(void 0===window||!window.navigator)return result.browser="Not a browser.",result;if(navigator.mozGetUserMedia)result.browser="firefox",result.version=extractVersion(navigator.userAgent,/Firefox\/(\d+)\./,1);else if(navigator.webkitGetUserMedia||!1===window.isSecureContext&&window.webkitRTCPeerConnection&&!window.RTCIceGatherer)result.browser="chrome",result.version=extractVersion(navigator.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))result.browser="edge",result.version=extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!window.RTCPeerConnection||!navigator.userAgent.match(/AppleWebKit\/(\d+)\./))return result.browser="Not a supported browser.",result;result.browser="safari",result.version=extractVersion(navigator.userAgent,/AppleWebKit\/(\d+)\./,1),result.supportsUnifiedPlan=window.RTCRtpTransceiver&&"currentDirection"in window.RTCRtpTransceiver.prototype}return result}function isObject(val){return"[object Object]"===Object.prototype.toString.call(val)}function compactObject(data){return isObject(data)?Object.keys(data).reduce((function(accumulator,key){const isObj=isObject(data[key]),value=isObj?compactObject(data[key]):data[key],isEmptyObject=isObj&&!Object.keys(value).length;return void 0===value||isEmptyObject?accumulator:Object.assign(accumulator,{[key]:value})}),{}):data}function filterStats(result,track,outbound){const streamStatsType=outbound?"outbound-rtp":"inbound-rtp",filteredResult=new Map;if(null===track)return filteredResult;const trackStats=[];return result.forEach(value=>{"track"===value.type&&value.trackIdentifier===track.id&&trackStats.push(value)}),trackStats.forEach(trackStat=>{result.forEach(stats=>{stats.type===streamStatsType&&stats.trackId===trackStat.id&&function walkStats(stats,base,resultSet){base&&!resultSet.has(base.id)&&(resultSet.set(base.id,base),Object.keys(base).forEach(name=>{name.endsWith("Id")?walkStats(stats,stats.get(base[name]),resultSet):name.endsWith("Ids")&&base[name].forEach(id=>{walkStats(stats,stats.get(id),resultSet)})}))}(result,stats,filteredResult)})}),filteredResult}const getusermedia_logging=log;function shimGetUserMedia(window){const navigator=window&&window.navigator;if(!navigator.mediaDevices)return;const browserDetails=detectBrowser(window),constraintsToChrome_=function(c){if("object"!=typeof c||c.mandatory||c.optional)return c;const cc={};return Object.keys(c).forEach(key=>{if("require"===key||"advanced"===key||"mediaSource"===key)return;const r="object"==typeof c[key]?c[key]:{ideal:c[key]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);const oldname_=function(prefix,name){return prefix?prefix+name.charAt(0).toUpperCase()+name.slice(1):"deviceId"===name?"sourceId":name};if(void 0!==r.ideal){cc.optional=cc.optional||[];let oc={};"number"==typeof r.ideal?(oc[oldname_("min",key)]=r.ideal,cc.optional.push(oc),(oc={})[oldname_("max",key)]=r.ideal,cc.optional.push(oc)):(oc[oldname_("",key)]=r.ideal,cc.optional.push(oc))}void 0!==r.exact&&"number"!=typeof r.exact?(cc.mandatory=cc.mandatory||{},cc.mandatory[oldname_("",key)]=r.exact):["min","max"].forEach(mix=>{void 0!==r[mix]&&(cc.mandatory=cc.mandatory||{},cc.mandatory[oldname_(mix,key)]=r[mix])})}),c.advanced&&(cc.optional=(cc.optional||[]).concat(c.advanced)),cc},shimConstraints_=function(constraints,func){if(browserDetails.version>=61)return func(constraints);if((constraints=JSON.parse(JSON.stringify(constraints)))&&"object"==typeof constraints.audio){const remap=function(obj,a,b){a in obj&&!(b in obj)&&(obj[b]=obj[a],delete obj[a])};remap((constraints=JSON.parse(JSON.stringify(constraints))).audio,"autoGainControl","googAutoGainControl"),remap(constraints.audio,"noiseSuppression","googNoiseSuppression"),constraints.audio=constraintsToChrome_(constraints.audio)}if(constraints&&"object"==typeof constraints.video){let face=constraints.video.facingMode;face=face&&("object"==typeof face?face:{ideal:face});const getSupportedFacingModeLies=browserDetails.version<66;if(face&&("user"===face.exact||"environment"===face.exact||"user"===face.ideal||"environment"===face.ideal)&&(!navigator.mediaDevices.getSupportedConstraints||!navigator.mediaDevices.getSupportedConstraints().facingMode||getSupportedFacingModeLies)){let matches;if(delete constraints.video.facingMode,"environment"===face.exact||"environment"===face.ideal?matches=["back","rear"]:"user"!==face.exact&&"user"!==face.ideal||(matches=["front"]),matches)return navigator.mediaDevices.enumerateDevices().then(devices=>{let dev=(devices=devices.filter(d=>"videoinput"===d.kind)).find(d=>matches.some(match=>d.label.toLowerCase().includes(match)));return!dev&&devices.length&&matches.includes("back")&&(dev=devices[devices.length-1]),dev&&(constraints.video.deviceId=face.exact?{exact:dev.deviceId}:{ideal:dev.deviceId}),constraints.video=constraintsToChrome_(constraints.video),getusermedia_logging("chrome: "+JSON.stringify(constraints)),func(constraints)})}constraints.video=constraintsToChrome_(constraints.video)}return getusermedia_logging("chrome: "+JSON.stringify(constraints)),func(constraints)},shimError_=function(e){return browserDetails.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(navigator.getUserMedia=function(constraints,onSuccess,onError){shimConstraints_(constraints,c=>{navigator.webkitGetUserMedia(c,onSuccess,e=>{onError&&onError(shimError_(e))})})}.bind(navigator),navigator.mediaDevices.getUserMedia){const origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(cs){return shimConstraints_(cs,c=>origGetUserMedia(c).then(stream=>{if(c.audio&&!stream.getAudioTracks().length||c.video&&!stream.getVideoTracks().length)throw stream.getTracks().forEach(track=>{track.stop()}),new DOMException("","NotFoundError");return stream},e=>Promise.reject(shimError_(e))))}}}function shimGetDisplayMedia(window,getSourceId){window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices||window.navigator.mediaDevices&&("function"==typeof getSourceId?window.navigator.mediaDevices.getDisplayMedia=function(constraints){return getSourceId(constraints).then(sourceId=>{const widthSpecified=constraints.video&&constraints.video.width,heightSpecified=constraints.video&&constraints.video.height,frameRateSpecified=constraints.video&&constraints.video.frameRate;return constraints.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sourceId,maxFrameRate:frameRateSpecified||3}},widthSpecified&&(constraints.video.mandatory.maxWidth=widthSpecified),heightSpecified&&(constraints.video.mandatory.maxHeight=heightSpecified),window.navigator.mediaDevices.getUserMedia(constraints)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}function shimMediaStream(window){window.MediaStream=window.MediaStream||window.webkitMediaStream}function shimOnTrack(window){if("object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype)wrapPeerConnectionEvent(window,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e));else{Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(f){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=f)},enumerable:!0,configurable:!0});const origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=e=>{e.stream.addEventListener("addtrack",te=>{let receiver;receiver=window.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(r=>r.track&&r.track.id===te.track.id):{track:te.track};const event=new Event("track");event.track=te.track,event.receiver=receiver,event.transceiver={receiver:receiver},event.streams=[e.stream],this.dispatchEvent(event)}),e.stream.getTracks().forEach(track=>{let receiver;receiver=window.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(r=>r.track&&r.track.id===track.id):{track:track};const event=new Event("track");event.track=track,event.receiver=receiver,event.transceiver={receiver:receiver},event.streams=[e.stream],this.dispatchEvent(event)})},this.addEventListener("addstream",this._ontrackpoly)),origSetRemoteDescription.apply(this,arguments)}}}function shimGetSendersWithDtmf(window){if("object"==typeof window&&window.RTCPeerConnection&&!("getSenders"in window.RTCPeerConnection.prototype)&&"createDTMFSender"in window.RTCPeerConnection.prototype){const shimSenderWithDtmf=function(pc,track){return{track:track,get dtmf(){return void 0===this._dtmf&&("audio"===track.kind?this._dtmf=pc.createDTMFSender(track):this._dtmf=null),this._dtmf},_pc:pc}};if(!window.RTCPeerConnection.prototype.getSenders){window.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const origAddTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addTrack=function(track,stream){let sender=origAddTrack.apply(this,arguments);return sender||(sender=shimSenderWithDtmf(this,track),this._senders.push(sender)),sender};const origRemoveTrack=window.RTCPeerConnection.prototype.removeTrack;window.RTCPeerConnection.prototype.removeTrack=function(sender){origRemoveTrack.apply(this,arguments);const idx=this._senders.indexOf(sender);-1!==idx&&this._senders.splice(idx,1)}}const origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function(stream){this._senders=this._senders||[],origAddStream.apply(this,[stream]),stream.getTracks().forEach(track=>{this._senders.push(shimSenderWithDtmf(this,track))})};const origRemoveStream=window.RTCPeerConnection.prototype.removeStream;window.RTCPeerConnection.prototype.removeStream=function(stream){this._senders=this._senders||[],origRemoveStream.apply(this,[stream]),stream.getTracks().forEach(track=>{const sender=this._senders.find(s=>s.track===track);sender&&this._senders.splice(this._senders.indexOf(sender),1)})}}else if("object"==typeof window&&window.RTCPeerConnection&&"getSenders"in window.RTCPeerConnection.prototype&&"createDTMFSender"in window.RTCPeerConnection.prototype&&window.RTCRtpSender&&!("dtmf"in window.RTCRtpSender.prototype)){const origGetSenders=window.RTCPeerConnection.prototype.getSenders;window.RTCPeerConnection.prototype.getSenders=function(){const senders=origGetSenders.apply(this,[]);return senders.forEach(sender=>sender._pc=this),senders},Object.defineProperty(window.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function shimGetStats(window){if(!window.RTCPeerConnection)return;const origGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function(){const[selector,onSucc,onErr]=arguments;if(arguments.length>0&&"function"==typeof selector)return origGetStats.apply(this,arguments);if(0===origGetStats.length&&(0===arguments.length||"function"!=typeof selector))return origGetStats.apply(this,[]);const fixChromeStats_=function(response){const standardReport={};return response.result().forEach(report=>{const standardStats={id:report.id,timestamp:report.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[report.type]||report.type};report.names().forEach(name=>{standardStats[name]=report.stat(name)}),standardReport[standardStats.id]=standardStats}),standardReport},makeMapStats=function(stats){return new Map(Object.keys(stats).map(key=>[key,stats[key]]))};if(arguments.length>=2){const successCallbackWrapper_=function(response){onSucc(makeMapStats(fixChromeStats_(response)))};return origGetStats.apply(this,[successCallbackWrapper_,selector])}return new Promise((resolve,reject)=>{origGetStats.apply(this,[function(response){resolve(makeMapStats(fixChromeStats_(response)))},reject])}).then(onSucc,onErr)}}function shimSenderReceiverGetStats(window){if(!("object"==typeof window&&window.RTCPeerConnection&&window.RTCRtpSender&&window.RTCRtpReceiver))return;if(!("getStats"in window.RTCRtpSender.prototype)){const origGetSenders=window.RTCPeerConnection.prototype.getSenders;origGetSenders&&(window.RTCPeerConnection.prototype.getSenders=function(){const senders=origGetSenders.apply(this,[]);return senders.forEach(sender=>sender._pc=this),senders});const origAddTrack=window.RTCPeerConnection.prototype.addTrack;origAddTrack&&(window.RTCPeerConnection.prototype.addTrack=function(){const sender=origAddTrack.apply(this,arguments);return sender._pc=this,sender}),window.RTCRtpSender.prototype.getStats=function(){const sender=this;return this._pc.getStats().then(result=>filterStats(result,sender.track,!0))}}if(!("getStats"in window.RTCRtpReceiver.prototype)){const origGetReceivers=window.RTCPeerConnection.prototype.getReceivers;origGetReceivers&&(window.RTCPeerConnection.prototype.getReceivers=function(){const receivers=origGetReceivers.apply(this,[]);return receivers.forEach(receiver=>receiver._pc=this),receivers}),wrapPeerConnectionEvent(window,"track",e=>(e.receiver._pc=e.srcElement,e)),window.RTCRtpReceiver.prototype.getStats=function(){const receiver=this;return this._pc.getStats().then(result=>filterStats(result,receiver.track,!1))}}if(!("getStats"in window.RTCRtpSender.prototype&&"getStats"in window.RTCRtpReceiver.prototype))return;const origGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof window.MediaStreamTrack){const track=arguments[0];let sender,receiver,err;return this.getSenders().forEach(s=>{s.track===track&&(sender?err=!0:sender=s)}),this.getReceivers().forEach(r=>(r.track===track&&(receiver?err=!0:receiver=r),r.track===track)),err||sender&&receiver?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):sender?sender.getStats():receiver?receiver.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return origGetStats.apply(this,arguments)}}function shimAddTrackRemoveTrackWithNative(window){window.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(streamId=>this._shimmedLocalStreams[streamId][0])};const origAddTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addTrack=function(track,stream){if(!stream)return origAddTrack.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const sender=origAddTrack.apply(this,arguments);return this._shimmedLocalStreams[stream.id]?-1===this._shimmedLocalStreams[stream.id].indexOf(sender)&&this._shimmedLocalStreams[stream.id].push(sender):this._shimmedLocalStreams[stream.id]=[stream,sender],sender};const origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function(stream){this._shimmedLocalStreams=this._shimmedLocalStreams||{},stream.getTracks().forEach(track=>{if(this.getSenders().find(s=>s.track===track))throw new DOMException("Track already exists.","InvalidAccessError")});const existingSenders=this.getSenders();origAddStream.apply(this,arguments);const newSenders=this.getSenders().filter(newSender=>-1===existingSenders.indexOf(newSender));this._shimmedLocalStreams[stream.id]=[stream].concat(newSenders)};const origRemoveStream=window.RTCPeerConnection.prototype.removeStream;window.RTCPeerConnection.prototype.removeStream=function(stream){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[stream.id],origRemoveStream.apply(this,arguments)};const origRemoveTrack=window.RTCPeerConnection.prototype.removeTrack;window.RTCPeerConnection.prototype.removeTrack=function(sender){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},sender&&Object.keys(this._shimmedLocalStreams).forEach(streamId=>{const idx=this._shimmedLocalStreams[streamId].indexOf(sender);-1!==idx&&this._shimmedLocalStreams[streamId].splice(idx,1),1===this._shimmedLocalStreams[streamId].length&&delete this._shimmedLocalStreams[streamId]}),origRemoveTrack.apply(this,arguments)}}function shimAddTrackRemoveTrack(window){if(!window.RTCPeerConnection)return;const browserDetails=detectBrowser(window);if(window.RTCPeerConnection.prototype.addTrack&&browserDetails.version>=65)return shimAddTrackRemoveTrackWithNative(window);const origGetLocalStreams=window.RTCPeerConnection.prototype.getLocalStreams;window.RTCPeerConnection.prototype.getLocalStreams=function(){const nativeStreams=origGetLocalStreams.apply(this);return this._reverseStreams=this._reverseStreams||{},nativeStreams.map(stream=>this._reverseStreams[stream.id])};const origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function(stream){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},stream.getTracks().forEach(track=>{if(this.getSenders().find(s=>s.track===track))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[stream.id]){const newStream=new window.MediaStream(stream.getTracks());this._streams[stream.id]=newStream,this._reverseStreams[newStream.id]=stream,stream=newStream}origAddStream.apply(this,[stream])};const origRemoveStream=window.RTCPeerConnection.prototype.removeStream;function replaceInternalStreamId(pc,description){let sdp=description.sdp;return Object.keys(pc._reverseStreams||[]).forEach(internalId=>{const externalStream=pc._reverseStreams[internalId],internalStream=pc._streams[externalStream.id];sdp=sdp.replace(new RegExp(internalStream.id,"g"),externalStream.id)}),new RTCSessionDescription({type:description.type,sdp:sdp})}function replaceExternalStreamId(pc,description){let sdp=description.sdp;return Object.keys(pc._reverseStreams||[]).forEach(internalId=>{const externalStream=pc._reverseStreams[internalId],internalStream=pc._streams[externalStream.id];sdp=sdp.replace(new RegExp(externalStream.id,"g"),internalStream.id)}),new RTCSessionDescription({type:description.type,sdp:sdp})}window.RTCPeerConnection.prototype.removeStream=function(stream){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},origRemoveStream.apply(this,[this._streams[stream.id]||stream]),delete this._reverseStreams[this._streams[stream.id]?this._streams[stream.id].id:stream.id],delete this._streams[stream.id]},window.RTCPeerConnection.prototype.addTrack=function(track,stream){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const streams=[].slice.call(arguments,1);if(1!==streams.length||!streams[0].getTracks().find(t=>t===track))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const alreadyExists=this.getSenders().find(s=>s.track===track);if(alreadyExists)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const oldStream=this._streams[stream.id];if(oldStream)oldStream.addTrack(track),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const newStream=new window.MediaStream([track]);this._streams[stream.id]=newStream,this._reverseStreams[newStream.id]=stream,this.addStream(newStream)}return this.getSenders().find(s=>s.track===track)},["createOffer","createAnswer"].forEach((function(method){const nativeMethod=window.RTCPeerConnection.prototype[method],methodObj={[method](){const args=arguments;return arguments.length&&"function"==typeof arguments[0]?nativeMethod.apply(this,[description=>{const desc=replaceInternalStreamId(this,description);args[0].apply(null,[desc])},err=>{args[1]&&args[1].apply(null,err)},arguments[2]]):nativeMethod.apply(this,arguments).then(description=>replaceInternalStreamId(this,description))}};window.RTCPeerConnection.prototype[method]=methodObj[method]}));const origSetLocalDescription=window.RTCPeerConnection.prototype.setLocalDescription;window.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=replaceExternalStreamId(this,arguments[0]),origSetLocalDescription.apply(this,arguments)):origSetLocalDescription.apply(this,arguments)};const origLocalDescription=Object.getOwnPropertyDescriptor(window.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(window.RTCPeerConnection.prototype,"localDescription",{get(){const description=origLocalDescription.get.apply(this);return""===description.type?description:replaceInternalStreamId(this,description)}}),window.RTCPeerConnection.prototype.removeTrack=function(sender){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!sender._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(sender._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let stream;this._streams=this._streams||{},Object.keys(this._streams).forEach(streamid=>{this._streams[streamid].getTracks().find(track=>sender.track===track)&&(stream=this._streams[streamid])}),stream&&(1===stream.getTracks().length?this.removeStream(this._reverseStreams[stream.id]):stream.removeTrack(sender.track),this.dispatchEvent(new Event("negotiationneeded")))}}function shimPeerConnection(window){const browserDetails=detectBrowser(window);if(!window.RTCPeerConnection&&window.webkitRTCPeerConnection&&(window.RTCPeerConnection=window.webkitRTCPeerConnection),!window.RTCPeerConnection)return;const addIceCandidateNullSupported=0===window.RTCPeerConnection.prototype.addIceCandidate.length;browserDetails.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(method){const nativeMethod=window.RTCPeerConnection.prototype[method],methodObj={[method](){return arguments[0]=new("addIceCandidate"===method?window.RTCIceCandidate:window.RTCSessionDescription)(arguments[0]),nativeMethod.apply(this,arguments)}};window.RTCPeerConnection.prototype[method]=methodObj[method]}));const nativeAddIceCandidate=window.RTCPeerConnection.prototype.addIceCandidate;window.RTCPeerConnection.prototype.addIceCandidate=function(){return addIceCandidateNullSupported||arguments[0]?browserDetails.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():nativeAddIceCandidate.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}function fixNegotiationNeeded(window){wrapPeerConnectionEvent(window,"negotiationneeded",e=>{if("stable"===e.target.signalingState)return e})}function getusermedia_shimGetUserMedia(window){const navigator=window&&window.navigator,origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){return origGetUserMedia(c).catch(e=>Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e)))}}function getdisplaymedia_shimGetDisplayMedia(window){"getDisplayMedia"in window.navigator&&window.navigator.mediaDevices&&(window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices||(window.navigator.mediaDevices.getDisplayMedia=window.navigator.getDisplayMedia.bind(window.navigator)))}function edge_shim_shimPeerConnection(window){const browserDetails=detectBrowser(window);if(window.RTCIceGatherer&&(window.RTCIceCandidate||(window.RTCIceCandidate=function(args){return args}),window.RTCSessionDescription||(window.RTCSessionDescription=function(args){return args}),browserDetails.version<15025)){const origMSTEnabled=Object.getOwnPropertyDescriptor(window.MediaStreamTrack.prototype,"enabled");Object.defineProperty(window.MediaStreamTrack.prototype,"enabled",{set(value){origMSTEnabled.set.call(this,value);const ev=new Event("enabled");ev.enabled=value,this.dispatchEvent(ev)}})}!window.RTCRtpSender||"dtmf"in window.RTCRtpSender.prototype||Object.defineProperty(window.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new window.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),window.RTCDtmfSender&&!window.RTCDTMFSender&&(window.RTCDTMFSender=window.RTCDtmfSender);const RTCPeerConnectionShim=shimRTCPeerConnection(window,browserDetails.version);window.RTCPeerConnection=function(config){return config&&config.iceServers&&(config.iceServers=function(iceServers,edgeVersion){let hasTurn=!1;return(iceServers=JSON.parse(JSON.stringify(iceServers))).filter(server=>{if(server&&(server.urls||server.url)){var urls=server.urls||server.url;server.url&&!server.urls&&deprecated("RTCIceServer.url","RTCIceServer.urls");const isString="string"==typeof urls;return isString&&(urls=[urls]),urls=urls.filter(url=>{if(0===url.indexOf("stun:"))return!1;const validTurn=url.startsWith("turn")&&!url.startsWith("turn:[")&&url.includes("transport=udp");return validTurn&&!hasTurn?(hasTurn=!0,!0):validTurn&&!hasTurn}),delete server.url,server.urls=isString?urls[0]:urls,!!urls.length}})}(config.iceServers,browserDetails.version),log("ICE servers after filtering:",config.iceServers)),new RTCPeerConnectionShim(config)},window.RTCPeerConnection.prototype=RTCPeerConnectionShim.prototype}function shimReplaceTrack(window){!window.RTCRtpSender||"replaceTrack"in window.RTCRtpSender.prototype||(window.RTCRtpSender.prototype.replaceTrack=window.RTCRtpSender.prototype.setTrack)}function firefox_getusermedia_shimGetUserMedia(window){const browserDetails=detectBrowser(window),navigator=window&&window.navigator,MediaStreamTrack=window&&window.MediaStreamTrack;if(navigator.getUserMedia=function(constraints,onSuccess,onError){deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),navigator.mediaDevices.getUserMedia(constraints).then(onSuccess,onError)},!(browserDetails.version>55&&"autoGainControl"in navigator.mediaDevices.getSupportedConstraints())){const remap=function(obj,a,b){a in obj&&!(b in obj)&&(obj[b]=obj[a],delete obj[a])},nativeGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);if(navigator.mediaDevices.getUserMedia=function(c){return"object"==typeof c&&"object"==typeof c.audio&&(c=JSON.parse(JSON.stringify(c)),remap(c.audio,"autoGainControl","mozAutoGainControl"),remap(c.audio,"noiseSuppression","mozNoiseSuppression")),nativeGetUserMedia(c)},MediaStreamTrack&&MediaStreamTrack.prototype.getSettings){const nativeGetSettings=MediaStreamTrack.prototype.getSettings;MediaStreamTrack.prototype.getSettings=function(){const obj=nativeGetSettings.apply(this,arguments);return remap(obj,"mozAutoGainControl","autoGainControl"),remap(obj,"mozNoiseSuppression","noiseSuppression"),obj}}if(MediaStreamTrack&&MediaStreamTrack.prototype.applyConstraints){const nativeApplyConstraints=MediaStreamTrack.prototype.applyConstraints;MediaStreamTrack.prototype.applyConstraints=function(c){return"audio"===this.kind&&"object"==typeof c&&(c=JSON.parse(JSON.stringify(c)),remap(c,"autoGainControl","mozAutoGainControl"),remap(c,"noiseSuppression","mozNoiseSuppression")),nativeApplyConstraints.apply(this,[c])}}}}function firefox_getdisplaymedia_shimGetDisplayMedia(window,preferredMediaSource){window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices||window.navigator.mediaDevices&&(window.navigator.mediaDevices.getDisplayMedia=function(constraints){if(!constraints||!constraints.video){const err=new DOMException("getDisplayMedia without video constraints is undefined");return err.name="NotFoundError",err.code=8,Promise.reject(err)}return!0===constraints.video?constraints.video={mediaSource:preferredMediaSource}:constraints.video.mediaSource=preferredMediaSource,window.navigator.mediaDevices.getUserMedia(constraints)})}function firefox_shim_shimOnTrack(window){"object"==typeof window&&window.RTCTrackEvent&&"receiver"in window.RTCTrackEvent.prototype&&!("transceiver"in window.RTCTrackEvent.prototype)&&Object.defineProperty(window.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function firefox_shim_shimPeerConnection(window){const browserDetails=detectBrowser(window);if("object"!=typeof window||!window.RTCPeerConnection&&!window.mozRTCPeerConnection)return;if(!window.RTCPeerConnection&&window.mozRTCPeerConnection&&(window.RTCPeerConnection=window.mozRTCPeerConnection),browserDetails.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(method){const nativeMethod=window.RTCPeerConnection.prototype[method],methodObj={[method](){return arguments[0]=new("addIceCandidate"===method?window.RTCIceCandidate:window.RTCSessionDescription)(arguments[0]),nativeMethod.apply(this,arguments)}};window.RTCPeerConnection.prototype[method]=methodObj[method]})),browserDetails.version<68){const nativeAddIceCandidate=window.RTCPeerConnection.prototype.addIceCandidate;window.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():nativeAddIceCandidate.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}const modernStatsTypes={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},nativeGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function(){const[selector,onSucc,onErr]=arguments;return nativeGetStats.apply(this,[selector||null]).then(stats=>{if(browserDetails.version<53&&!onSucc)try{stats.forEach(stat=>{stat.type=modernStatsTypes[stat.type]||stat.type})}catch(e){if("TypeError"!==e.name)throw e;stats.forEach((stat,i)=>{stats.set(i,Object.assign({},stat,{type:modernStatsTypes[stat.type]||stat.type}))})}return stats}).then(onSucc,onErr)}}function shimSenderGetStats(window){if("object"!=typeof window||!window.RTCPeerConnection||!window.RTCRtpSender)return;if(window.RTCRtpSender&&"getStats"in window.RTCRtpSender.prototype)return;const origGetSenders=window.RTCPeerConnection.prototype.getSenders;origGetSenders&&(window.RTCPeerConnection.prototype.getSenders=function(){const senders=origGetSenders.apply(this,[]);return senders.forEach(sender=>sender._pc=this),senders});const origAddTrack=window.RTCPeerConnection.prototype.addTrack;origAddTrack&&(window.RTCPeerConnection.prototype.addTrack=function(){const sender=origAddTrack.apply(this,arguments);return sender._pc=this,sender}),window.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function shimReceiverGetStats(window){if("object"!=typeof window||!window.RTCPeerConnection||!window.RTCRtpSender)return;if(window.RTCRtpSender&&"getStats"in window.RTCRtpReceiver.prototype)return;const origGetReceivers=window.RTCPeerConnection.prototype.getReceivers;origGetReceivers&&(window.RTCPeerConnection.prototype.getReceivers=function(){const receivers=origGetReceivers.apply(this,[]);return receivers.forEach(receiver=>receiver._pc=this),receivers}),wrapPeerConnectionEvent(window,"track",e=>(e.receiver._pc=e.srcElement,e)),window.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function shimRemoveStream(window){!window.RTCPeerConnection||"removeStream"in window.RTCPeerConnection.prototype||(window.RTCPeerConnection.prototype.removeStream=function(stream){deprecated("removeStream","removeTrack"),this.getSenders().forEach(sender=>{sender.track&&stream.getTracks().includes(sender.track)&&this.removeTrack(sender)})})}function shimRTCDataChannel(window){window.DataChannel&&!window.RTCDataChannel&&(window.RTCDataChannel=window.DataChannel)}function shimAddTransceiver(window){if("object"!=typeof window||!window.RTCPeerConnection)return;const origAddTransceiver=window.RTCPeerConnection.prototype.addTransceiver;origAddTransceiver&&(window.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const initParameters=arguments[1],shouldPerformCheck=initParameters&&"sendEncodings"in initParameters;shouldPerformCheck&&initParameters.sendEncodings.forEach(encodingParam=>{if("rid"in encodingParam){if(!/^[a-z0-9]{0,16}$/i.test(encodingParam.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in encodingParam&&!(parseFloat(encodingParam.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in encodingParam&&!(parseFloat(encodingParam.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const transceiver=origAddTransceiver.apply(this,arguments);if(shouldPerformCheck){const{sender:sender}=transceiver,params=sender.getParameters();"encodings"in params||(params.encodings=initParameters.sendEncodings,this.setParametersPromises.push(sender.setParameters(params).catch(()=>{})))}return transceiver})}function shimCreateOffer(window){if("object"!=typeof window||!window.RTCPeerConnection)return;const origCreateOffer=window.RTCPeerConnection.prototype.createOffer;window.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>origCreateOffer.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):origCreateOffer.apply(this,arguments)}}function shimCreateAnswer(window){if("object"!=typeof window||!window.RTCPeerConnection)return;const origCreateAnswer=window.RTCPeerConnection.prototype.createAnswer;window.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>origCreateAnswer.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):origCreateAnswer.apply(this,arguments)}}function shimLocalStreamsAPI(window){if("object"==typeof window&&window.RTCPeerConnection){if("getLocalStreams"in window.RTCPeerConnection.prototype||(window.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in window.RTCPeerConnection.prototype)){const _addTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addStream=function(stream){this._localStreams||(this._localStreams=[]),this._localStreams.includes(stream)||this._localStreams.push(stream),stream.getAudioTracks().forEach(track=>_addTrack.call(this,track,stream)),stream.getVideoTracks().forEach(track=>_addTrack.call(this,track,stream))},window.RTCPeerConnection.prototype.addTrack=function(track){const stream=arguments[1];return stream&&(this._localStreams?this._localStreams.includes(stream)||this._localStreams.push(stream):this._localStreams=[stream]),_addTrack.apply(this,arguments)}}"removeStream"in window.RTCPeerConnection.prototype||(window.RTCPeerConnection.prototype.removeStream=function(stream){this._localStreams||(this._localStreams=[]);const index=this._localStreams.indexOf(stream);if(-1===index)return;this._localStreams.splice(index,1);const tracks=stream.getTracks();this.getSenders().forEach(sender=>{tracks.includes(sender.track)&&this.removeTrack(sender)})})}}function shimRemoteStreamsAPI(window){if("object"==typeof window&&window.RTCPeerConnection&&("getRemoteStreams"in window.RTCPeerConnection.prototype||(window.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in window.RTCPeerConnection.prototype))){Object.defineProperty(window.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(f){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=f),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach(stream=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(stream))return;this._remoteStreams.push(stream);const event=new Event("addstream");event.stream=stream,this.dispatchEvent(event)})})}});const origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function(){const pc=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(stream=>{if(pc._remoteStreams||(pc._remoteStreams=[]),pc._remoteStreams.indexOf(stream)>=0)return;pc._remoteStreams.push(stream);const event=new Event("addstream");event.stream=stream,pc.dispatchEvent(event)})}),origSetRemoteDescription.apply(pc,arguments)}}}function shimCallbacksAPI(window){if("object"!=typeof window||!window.RTCPeerConnection)return;const prototype=window.RTCPeerConnection.prototype,origCreateOffer=prototype.createOffer,origCreateAnswer=prototype.createAnswer,setLocalDescription=prototype.setLocalDescription,setRemoteDescription=prototype.setRemoteDescription,addIceCandidate=prototype.addIceCandidate;prototype.createOffer=function(successCallback,failureCallback){const options=arguments.length>=2?arguments[2]:arguments[0],promise=origCreateOffer.apply(this,[options]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise},prototype.createAnswer=function(successCallback,failureCallback){const options=arguments.length>=2?arguments[2]:arguments[0],promise=origCreateAnswer.apply(this,[options]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise};let withCallback=function(description,successCallback,failureCallback){const promise=setLocalDescription.apply(this,[description]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise};prototype.setLocalDescription=withCallback,withCallback=function(description,successCallback,failureCallback){const promise=setRemoteDescription.apply(this,[description]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise},prototype.setRemoteDescription=withCallback,withCallback=function(candidate,successCallback,failureCallback){const promise=addIceCandidate.apply(this,[candidate]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise},prototype.addIceCandidate=withCallback}function safari_shim_shimGetUserMedia(window){const navigator=window&&window.navigator;if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){const mediaDevices=navigator.mediaDevices,_getUserMedia=mediaDevices.getUserMedia.bind(mediaDevices);navigator.mediaDevices.getUserMedia=constraints=>_getUserMedia(shimConstraints(constraints))}!navigator.getUserMedia&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&(navigator.getUserMedia=function(constraints,cb,errcb){navigator.mediaDevices.getUserMedia(constraints).then(cb,errcb)}.bind(navigator))}function shimConstraints(constraints){return constraints&&void 0!==constraints.video?Object.assign({},constraints,{video:compactObject(constraints.video)}):constraints}function shimRTCIceServerUrls(window){const OrigPeerConnection=window.RTCPeerConnection;window.RTCPeerConnection=function(pcConfig,pcConstraints){if(pcConfig&&pcConfig.iceServers){const newIceServers=[];for(let i=0;i<pcConfig.iceServers.length;i++){let server=pcConfig.iceServers[i];!server.hasOwnProperty("urls")&&server.hasOwnProperty("url")?(deprecated("RTCIceServer.url","RTCIceServer.urls"),(server=JSON.parse(JSON.stringify(server))).urls=server.url,delete server.url,newIceServers.push(server)):newIceServers.push(pcConfig.iceServers[i])}pcConfig.iceServers=newIceServers}return new OrigPeerConnection(pcConfig,pcConstraints)},window.RTCPeerConnection.prototype=OrigPeerConnection.prototype,"generateCertificate"in window.RTCPeerConnection&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:()=>OrigPeerConnection.generateCertificate})}function shimTrackEventTransceiver(window){"object"==typeof window&&window.RTCTrackEvent&&"receiver"in window.RTCTrackEvent.prototype&&!("transceiver"in window.RTCTrackEvent.prototype)&&Object.defineProperty(window.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function shimCreateOfferLegacy(window){const origCreateOffer=window.RTCPeerConnection.prototype.createOffer;window.RTCPeerConnection.prototype.createOffer=function(offerOptions){if(offerOptions){void 0!==offerOptions.offerToReceiveAudio&&(offerOptions.offerToReceiveAudio=!!offerOptions.offerToReceiveAudio);const audioTransceiver=this.getTransceivers().find(transceiver=>"audio"===transceiver.receiver.track.kind);!1===offerOptions.offerToReceiveAudio&&audioTransceiver?"sendrecv"===audioTransceiver.direction?audioTransceiver.setDirection?audioTransceiver.setDirection("sendonly"):audioTransceiver.direction="sendonly":"recvonly"===audioTransceiver.direction&&(audioTransceiver.setDirection?audioTransceiver.setDirection("inactive"):audioTransceiver.direction="inactive"):!0!==offerOptions.offerToReceiveAudio||audioTransceiver||this.addTransceiver("audio"),void 0!==offerOptions.offerToReceiveVideo&&(offerOptions.offerToReceiveVideo=!!offerOptions.offerToReceiveVideo);const videoTransceiver=this.getTransceivers().find(transceiver=>"video"===transceiver.receiver.track.kind);!1===offerOptions.offerToReceiveVideo&&videoTransceiver?"sendrecv"===videoTransceiver.direction?videoTransceiver.setDirection?videoTransceiver.setDirection("sendonly"):videoTransceiver.direction="sendonly":"recvonly"===videoTransceiver.direction&&(videoTransceiver.setDirection?videoTransceiver.setDirection("inactive"):videoTransceiver.direction="inactive"):!0!==offerOptions.offerToReceiveVideo||videoTransceiver||this.addTransceiver("video")}return origCreateOffer.apply(this,arguments)}}function shimRTCIceCandidate(window){if(!window.RTCIceCandidate||window.RTCIceCandidate&&"foundation"in window.RTCIceCandidate.prototype)return;const NativeRTCIceCandidate=window.RTCIceCandidate;window.RTCIceCandidate=function(args){if("object"==typeof args&&args.candidate&&0===args.candidate.indexOf("a=")&&((args=JSON.parse(JSON.stringify(args))).candidate=args.candidate.substr(2)),args.candidate&&args.candidate.length){const nativeCandidate=new NativeRTCIceCandidate(args),parsedCandidate=SDPUtils.parseCandidate(args.candidate),augmentedCandidate=Object.assign(nativeCandidate,parsedCandidate);return augmentedCandidate.toJSON=function(){return{candidate:augmentedCandidate.candidate,sdpMid:augmentedCandidate.sdpMid,sdpMLineIndex:augmentedCandidate.sdpMLineIndex,usernameFragment:augmentedCandidate.usernameFragment}},augmentedCandidate}return new NativeRTCIceCandidate(args)},window.RTCIceCandidate.prototype=NativeRTCIceCandidate.prototype,wrapPeerConnectionEvent(window,"icecandidate",e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new window.RTCIceCandidate(e.candidate),writable:"false"}),e))}function shimMaxMessageSize(window){if(!window.RTCPeerConnection)return;const browserDetails=detectBrowser(window);"sctp"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const sctpInDescription=function(description){if(!description||!description.sdp)return!1;const sections=SDPUtils.splitSections(description.sdp);return sections.shift(),sections.some(mediaSection=>{const mLine=SDPUtils.parseMLine(mediaSection);return mLine&&"application"===mLine.kind&&-1!==mLine.protocol.indexOf("SCTP")})},getRemoteFirefoxVersion=function(description){const match=description.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===match||match.length<2)return-1;const version=parseInt(match[1],10);return version!=version?-1:version},getCanSendMaxMessageSize=function(remoteIsFirefox){let canSendMaxMessageSize=65536;return"firefox"===browserDetails.browser&&(canSendMaxMessageSize=browserDetails.version<57?-1===remoteIsFirefox?16384:2147483637:browserDetails.version<60?57===browserDetails.version?65535:65536:2147483637),canSendMaxMessageSize},getMaxMessageSize=function(description,remoteIsFirefox){let maxMessageSize=65536;"firefox"===browserDetails.browser&&57===browserDetails.version&&(maxMessageSize=65535);const match=SDPUtils.matchPrefix(description.sdp,"a=max-message-size:");return match.length>0?maxMessageSize=parseInt(match[0].substr(19),10):"firefox"===browserDetails.browser&&-1!==remoteIsFirefox&&(maxMessageSize=2147483637),maxMessageSize},origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===browserDetails.browser&&browserDetails.version>=76){const{sdpSemantics:sdpSemantics}=this.getConfiguration();"plan-b"===sdpSemantics&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(sctpInDescription(arguments[0])){const isFirefox=getRemoteFirefoxVersion(arguments[0]),canSendMMS=getCanSendMaxMessageSize(isFirefox),remoteMMS=getMaxMessageSize(arguments[0],isFirefox);let maxMessageSize;maxMessageSize=0===canSendMMS&&0===remoteMMS?Number.POSITIVE_INFINITY:0===canSendMMS||0===remoteMMS?Math.max(canSendMMS,remoteMMS):Math.min(canSendMMS,remoteMMS);const sctp={};Object.defineProperty(sctp,"maxMessageSize",{get:()=>maxMessageSize}),this._sctp=sctp}return origSetRemoteDescription.apply(this,arguments)}}function shimSendThrowTypeError(window){if(!(window.RTCPeerConnection&&"createDataChannel"in window.RTCPeerConnection.prototype))return;function wrapDcSend(dc,pc){const origDataChannelSend=dc.send;dc.send=function(){const data=arguments[0],length=data.length||data.size||data.byteLength;if("open"===dc.readyState&&pc.sctp&&length>pc.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+pc.sctp.maxMessageSize+" bytes)");return origDataChannelSend.apply(dc,arguments)}}const origCreateDataChannel=window.RTCPeerConnection.prototype.createDataChannel;window.RTCPeerConnection.prototype.createDataChannel=function(){const dataChannel=origCreateDataChannel.apply(this,arguments);return wrapDcSend(dataChannel,this),dataChannel},wrapPeerConnectionEvent(window,"datachannel",e=>(wrapDcSend(e.channel,e.target),e))}function shimConnectionState(window){if(!window.RTCPeerConnection||"connectionState"in window.RTCPeerConnection.prototype)return;const proto=window.RTCPeerConnection.prototype;Object.defineProperty(proto,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(proto,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(cb){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),cb&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=cb)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(method=>{const origMethod=proto[method];proto[method]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const pc=e.target;if(pc._lastConnectionState!==pc.connectionState){pc._lastConnectionState=pc.connectionState;const newEvent=new Event("connectionstatechange",e);pc.dispatchEvent(newEvent)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),origMethod.apply(this,arguments)}})}function removeAllowExtmapMixed(window){if(!window.RTCPeerConnection)return;const browserDetails=detectBrowser(window);if("chrome"===browserDetails.browser&&browserDetails.version>=71)return;const nativeSRD=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function(desc){return desc&&desc.sdp&&-1!==desc.sdp.indexOf("\na=extmap-allow-mixed")&&(desc.sdp=desc.sdp.split("\n").filter(line=>"a=extmap-allow-mixed"!==line.trim()).join("\n")),nativeSRD.apply(this,arguments)}}var adapter_core=function({window:window}={},options={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const logging=log,browserDetails=detectBrowser(window),adapter={browserDetails:browserDetails,commonShim:common_shim_namespaceObject,extractVersion:extractVersion,disableLog:disableLog,disableWarnings:disableWarnings};switch(browserDetails.browser){case"chrome":if(!chrome_shim_namespaceObject||!shimPeerConnection||!options.shimChrome)return logging("Chrome shim is not included in this adapter release."),adapter;logging("adapter.js shimming chrome."),adapter.browserShim=chrome_shim_namespaceObject,shimGetUserMedia(window),shimMediaStream(window),shimPeerConnection(window),shimOnTrack(window),shimAddTrackRemoveTrack(window),shimGetSendersWithDtmf(window),shimGetStats(window),shimSenderReceiverGetStats(window),fixNegotiationNeeded(window),shimRTCIceCandidate(window),shimConnectionState(window),shimMaxMessageSize(window),shimSendThrowTypeError(window),removeAllowExtmapMixed(window);break;case"firefox":if(!firefox_shim_namespaceObject||!firefox_shim_shimPeerConnection||!options.shimFirefox)return logging("Firefox shim is not included in this adapter release."),adapter;logging("adapter.js shimming firefox."),adapter.browserShim=firefox_shim_namespaceObject,firefox_getusermedia_shimGetUserMedia(window),firefox_shim_shimPeerConnection(window),firefox_shim_shimOnTrack(window),shimRemoveStream(window),shimSenderGetStats(window),shimReceiverGetStats(window),shimRTCDataChannel(window),shimAddTransceiver(window),shimCreateOffer(window),shimCreateAnswer(window),shimRTCIceCandidate(window),shimConnectionState(window),shimMaxMessageSize(window),shimSendThrowTypeError(window);break;case"edge":if(!edge_shim_namespaceObject||!edge_shim_shimPeerConnection||!options.shimEdge)return logging("MS edge shim is not included in this adapter release."),adapter;logging("adapter.js shimming edge."),adapter.browserShim=edge_shim_namespaceObject,getusermedia_shimGetUserMedia(window),getdisplaymedia_shimGetDisplayMedia(window),edge_shim_shimPeerConnection(window),shimReplaceTrack(window),shimMaxMessageSize(window),shimSendThrowTypeError(window);break;case"safari":if(!safari_shim_namespaceObject||!options.shimSafari)return logging("Safari shim is not included in this adapter release."),adapter;logging("adapter.js shimming safari."),adapter.browserShim=safari_shim_namespaceObject,shimRTCIceServerUrls(window),shimCreateOfferLegacy(window),shimCallbacksAPI(window),shimLocalStreamsAPI(window),shimRemoteStreamsAPI(window),shimTrackEventTransceiver(window),safari_shim_shimGetUserMedia(window),shimRTCIceCandidate(window),shimMaxMessageSize(window),shimSendThrowTypeError(window),removeAllowExtmapMixed(window);break;default:logging("Unsupported browser!")}return adapter}({window:window});function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}var _$log=new WeakMap,_$rootScope=new WeakMap,_authService=new WeakMap,_xmppService=new WeakMap,_companyService=new WeakMap,_contactService=new WeakMap,_botService=new WeakMap,_fileServerService=new WeakMap,_fileStorageService=new WeakMap,_roomService=new WeakMap,_groupService=new WeakMap,_videoService=new WeakMap,_favoriteService=new WeakMap,_voiceMessageService=new WeakMap,_webrtcServiceEventHandler=new WeakMap,_telephonyService=new WeakMap,_conferenceService=new WeakMap,_pstnConferenceService=new WeakMap,_webConferenceService=new WeakMap,_conversationService=new WeakMap,_callLogService=new WeakMap,_platformService=new WeakMap,_invitationService=new WeakMap,_adminCompanyService=new WeakMap,_adminUserService=new WeakMap,_profileService=new WeakMap,_channelService=new WeakMap,_webrtcGatewayService=new WeakMap,_recordsService=new WeakMap,_SDK=new WeakMap,ConnectionService=function(){function ConnectionService($log,$rootScope,authService,xmppService,companyService,contactService,botService,fileServerService,fileStorageService,roomService,groupService,videoService,favoriteService,voiceMessageService,webrtcServiceEventHandler,telephonyService,conferenceService,pstnConferenceService,webConferenceService,conversationService,callLogService,platformService,invitationService,adminCompanyService,adminUserService,profileService,channelService,webrtcGatewayService,recordsService,SDK){var _this=this;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,ConnectionService),this.logService="ConnectionService | ",this.state="disconnected",this.hostUsed="",_$log.set(this,$log),_$rootScope.set(this,$rootScope),_authService.set(this,authService),_xmppService.set(this,xmppService),_companyService.set(this,companyService),_contactService.set(this,contactService),_botService.set(this,botService),_fileServerService.set(this,fileServerService),_fileStorageService.set(this,fileStorageService),_roomService.set(this,roomService),_groupService.set(this,groupService),_videoService.set(this,videoService),_favoriteService.set(this,favoriteService),_voiceMessageService.set(this,voiceMessageService),_webrtcServiceEventHandler.set(this,webrtcServiceEventHandler),_telephonyService.set(this,telephonyService),_conferenceService.set(this,conferenceService),_pstnConferenceService.set(this,pstnConferenceService),_webConferenceService.set(this,webConferenceService),_conversationService.set(this,conversationService),_callLogService.set(this,callLogService),_platformService.set(this,platformService),_invitationService.set(this,invitationService),_adminCompanyService.set(this,adminCompanyService),_adminUserService.set(this,adminUserService),_profileService.set(this,profileService),_channelService.set(this,channelService),_webrtcGatewayService.set(this,webrtcGatewayService),_recordsService.set(this,recordsService),_SDK.set(this,SDK),this.RAINBOW_ONCONNECTIONSTATECHANGED="rainbowconnectionstatechanged",this.RAINBOW_ONSTARTED="started",this.RAINBOW_ONSIGNED="signed",this.RAINBOW_ONSTOPPED="stopped",this.RAINBOW_CONNECTIONINPROGRESS="inProgress",this.RAINBOW_ONUSERTOKENRENEW="userTokenRenew",this.RAINBOW_ONUSERTOKENRENEWFAILED="userTokenRenewFailed",this.RAINBOW_ONAPPTOKENRENEW="applicationTokenRenew",this.RAINBOW_ONAPPTOKENRENEWFAILED="applicationTokenRenewFailed",this.RAINBOW_CONNECTIONCONNECTED="connected",this.RAINBOW_CONNECTIONDISCONNECTED="disconnected",this.RAINBOW_OFFICIAL_HOST="openrainbow.com",this.RAINBOW_BETA_HOST="openrainbow.net",this.RAINBOW_DEV_HOST="openrainbow.org",this.RAINBOW_SANDBOX_HOST="sandbox.openrainbow.com",this.RAINBOW_CPAASPREPROD_HOST="cpaaspreprod.openrainbow.net",this.RAINBOW_CHINA_HOST="myopenrainbow.cn.com",this.RAINBOW_CHINASANDBOX_HOST="sandbox.openrainbow.cn.com",this.signin=this.signin.bind(this),this.signinOnRainbowOfficial=this.signinOnRainbowOfficial.bind(this),this.signinOnRainbowBeta=this.signinOnRainbowBeta.bind(this),this.signinOnRainbowCPaasPreProd=this.signinOnRainbowCPaasPreProd.bind(this),this.signinOnRainbowDev=this.signinOnRainbowDev.bind(this),this.signinOnRainbowSandboxChina=this.signinOnRainbowSandboxChina.bind(this),this.signinOnRainbowSandboxChina=this.signinOnRainbowSandboxChina.bind(this),this.signinOnRainbowHosted=this.signinOnRainbowHosted.bind(this),this.signinSandBoxWithToken=this.signinSandBoxWithToken.bind(this),this.signinOnRainbowOfficialWithToken=this.signinOnRainbowOfficialWithToken.bind(this),this.signinOnRainbowBetaWithToken=this.signinOnRainbowBetaWithToken.bind(this),this.signinOnRainbowDevWithToken=this.signinOnRainbowDevWithToken.bind(this),this.signinOnRainbowHostedWithToken=this.signinOnRainbowHostedWithToken.bind(this),this.signinOnRainbowWithOICD=this.signinOnRainbowWithOICD.bind(this),this.styleSignInWithRainbowButton=this.styleSignInWithRainbowButton.bind(this),this.signout=this.signout.bind(this),this.updateUserPassword=this.updateUserPassword.bind(this),this.getState=this.getState.bind(this),this.getToken=this.getToken.bind(this),this.refreshToken=this.refreshToken.bind(this),this.signinToRainbow=this.signinToRainbow.bind(this),this.disconnectionHandler=this.disconnectionHandler.bind(this),this.onConnectionStateChangeEvent=this.onConnectionStateChangeEvent.bind(this),$rootScope.$on("$destroy",$rootScope.$on("ON_CONNECTION_STATE_CHANGE_EVENT",this.onConnectionStateChangeEvent)),$rootScope.$on("$destroy",$rootScope.$on("ON_AUTH_TOKEN_RENEW",(function(){var sdkEvent=new CustomEvent(_this.RAINBOW_ONUSERTOKENRENEW,{detail:null});document.dispatchEvent(sdkEvent)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_AUTH_TOKEN_EXPIRE",(function(){var sdkEvent=new CustomEvent(_this.RAINBOW_ONUSERTOKENRENEWFAILED,{detail:null});document.dispatchEvent(sdkEvent)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_AUTH_TOKEN_RENEW",(function(){var sdkEvent=new CustomEvent(_this.RAINBOW_ONAPPTOKENRENEW,{detail:null});document.dispatchEvent(sdkEvent)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_AUTH_TOKEN_EXPIRE",(function(){var sdkEvent=new CustomEvent(_this.RAINBOW_ONAPPTOKENRENEWFAILED,{detail:null});document.dispatchEvent(sdkEvent)}))),window.addEventListener("beforeunload",(function(){$rootScope.$broadcast("ON_CONNECTION_STATE_CHANGE_EVENT","disconnected"),videoService.stop(),contactService.stop(),conversationService.stop(),groupService.stop(),telephonyService.stop(),fileServerService.stop(),fileStorageService.stop(),callLogService.stop(),xmppService.stop(),profileService.stop(),recordsService.stop(),channelService.stop(),webrtcGatewayService.stop()}))}return _createClass(ConnectionService,null,[{key:"$inject",get:function(){return["$log","$rootScope","authService","xmppService","companyService","contactService","botService","fileServerService","fileStorageService","roomService","groupService","videoService","favoriteService","voiceMessageService","webrtcServiceEventHandler","telephonyService","conferenceService","pstnConferenceService","webConferenceService","conversationService","callLogService","platformService","invitationService","adminCompanyService","adminUserService","profileService","channelService","webrtcGatewayService","recordsService","SDK"]}}]),_createClass(ConnectionService,[{key:"signin",value:function(strLogin,strPassword){return this.hostUsed=this.RAINBOW_SANDBOX_HOST,this.signinToRainbow(strLogin,strPassword,null)}},{key:"signinOnRainbowOfficial",value:function(strLogin,strPassword){return this.hostUsed=this.RAINBOW_OFFICIAL_HOST,this.signinToRainbow(strLogin,strPassword,null)}},{key:"signinOnRainbowBeta",value:function(strLogin,strPassword){return this.hostUsed=this.RAINBOW_BETA_HOST,this.signinToRainbow(strLogin,strPassword,null)}},{key:"signinOnRainbowCPaasPreProd",value:function(strLogin,strPassword){return this.hostUsed=this.RAINBOW_CPAASPREPROD_HOST,this.signinToRainbow(strLogin,strPassword,null)}},{key:"signinOnRainbowDev",value:function(strLogin,strPassword){return this.hostUsed=this.RAINBOW_DEV_HOST,this.signinToRainbow(strLogin,strPassword,null)}},{key:"signinOnRainbowSandboxChina",value:function(strLogin,strPassword){return this.hostUsed=this.RAINBOW_CHINASANDBOX_HOST,this.signinToRainbow(strLogin,strPassword,null)}},{key:"signinOnRainbowChina",value:function(strLogin,strPassword){return this.hostUsed=this.RAINBOW_CHINA_HOST,this.signinToRainbow(strLogin,strPassword,null)}},{key:"signinOnRainbowHosted",value:function(strLogin,strPassword,strHost){return this.hostUsed=strHost,this.signinToRainbow(strLogin,strPassword,null)}},{key:"signinSandBoxWithToken",value:function(strToken){return this.hostUsed=this.RAINBOW_SANDBOX_HOST,this.signinToRainbow(null,null,strToken)}},{key:"signinOnRainbowOfficialWithToken",value:function(strToken){return this.hostUsed=this.RAINBOW_OFFICIAL_HOST,this.signinToRainbow(null,null,strToken)}},{key:"signinOnRainbowBetaWithToken",value:function(strToken){return this.hostUsed=this.RAINBOW_BETA_HOST,this.signinToRainbow(null,null,strToken)}},{key:"signinOnRainbowDevWithToken",value:function(strToken){return this.hostUsed=this.RAINBOW_DEV_HOST,this.signinToRainbow(null,null,strToken)}},{key:"signinOnRainbowHostedWithToken",value:function(strToken,strHost){return this.hostUsed=strHost,this.signinToRainbow(null,null,strToken)}},{key:"signinOnRainbowWithOICD",value:function(strToken){for(var _this2=this,$log=_$log.get(this),challenge="",characters="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",charactersLength=characters.length,i=0;i<30;i++)challenge+=characters.charAt(Math.floor(Math.random()*charactersLength));var url="https://openrainbow.com/api/rainbow/authentication/v1.0/oidc-client/jwt?id_token=".concat(strToken,"&challenge=").concat(challenge);return new Promise((function(resolve,reject){if(!strToken)return $log.sdk(_this2.logService+"[signinOnRainbowWithOICD] :: Argument strToken is null or undefined"),reject("Argument strToken is null or undefined");var headersXrainbowAppAuth=window.btoa(unescape(encodeURIComponent(sdk.key.appID+":"+window.SHA256(sdk.key.appSecret+challenge))));headersXrainbowAppAuth="Basic "+headersXrainbowAppAuth;var sdkHeaders=new Headers({"Content-Type":"application/x-www-form-urlencoded","X-Rainbow-App-Auth":headersXrainbowAppAuth,Accept:"application/json"});fetch(url,{method:"get",mode:"cors",headers:sdkHeaders}).then((function(response){response.json().then((function(data){_this2.signinOnRainbowBetaWithToken(data.token).then((function(account){return resolve(account)})).catch((function(err){return reject(err)}))}))})).catch((function(err){return reject(err)}))}))}},{key:"styleSignInWithRainbowButton",value:function(color,size){var width,height,backgroundSize,fontSize,backgroundColor,textColor,$log=_$log.get(this),el=document.querySelector(".SignInWithRainbow");return el?(size||(size="medium"),color||(color="blue"),"blue"===color?(backgroundColor="#1b85e0",textColor="#FFFFFF"):"white"===color&&(backgroundColor="#FFFFFF",textColor="#1b85e0"),"small"===size?(width="200px",height="20px",backgroundSize="18px",fontSize="12px"):"medium"===size?(width="250px",height="30px",backgroundSize="26px",fontSize="16px"):"large"===size&&(width="350px",height="40px",backgroundSize="34px",fontSize="22px"),el.style.backgroundColor=backgroundColor,el.style.color=textColor,el.style.width=width,el.style.height=height,el.style.fontSize=fontSize,el.style.border="0px",el.style.borderRadius="5px",el.innerHTML="Sign in with Rainbow",el.style.backgroundImage="url('https://hub.openrainbow.com/android-chrome-48x48.png')",el.style.backgroundPosition="left",el.style.backgroundRepeat="no-repeat",el.style.verticalAlign="middle",el.style.backgroundSize=backgroundSize,el.style.backgroundOrigin="content-box",el.style.paddingLeft="13px",$log.sdk(this.logService+"[styleSignInWithRainbowButton] :: Styled a corresponding HTML element"),!0):($log.sdk(this.logService+"[styleSignInWithRainbowButton] :: Could not find a corresponding HTML element"),!1)}},{key:"signout",value:function(){var _this3=this,$log=_$log.get(this),videoService=_videoService.get(this),webrtcServiceEventHandler=_webrtcServiceEventHandler.get(this),contactService=_contactService.get(this),botService=_botService.get(this),profileService=_profileService.get(this),conversationService=_conversationService.get(this),conferenceService=_conferenceService.get(this),webConferenceService=_webConferenceService.get(this),pstnConferenceService=_pstnConferenceService.get(this),callLogService=_callLogService.get(this),channelService=_channelService.get(this),telephonyService=_telephonyService.get(this),fileServerService=_fileServerService.get(this),fileStorageService=_fileStorageService.get(this),invitationService=_invitationService.get(this),groupService=_groupService.get(this),favoriteService=_favoriteService.get(this),voiceMessageService=_voiceMessageService.get(this),roomService=_roomService.get(this),companyService=_companyService.get(this),adminCompanyService=_adminCompanyService.get(this),adminUserService=_adminUserService.get(this),webrtcGatewayService=_webrtcGatewayService.get(this),xmppService=_xmppService.get(this),recordsService=_recordsService.get(this),result={code:_SDK.get(this).OK,label:"OK"};return $log.sdk(this.logService+"[signout] :: Trying to sign out"),new Promise((function(resolve,reject){videoService.stop().then((function(){return $log.sdk(_this3.logService+"[signout] :: Video service stopped"),webrtcServiceEventHandler.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: WebRTCEventHandler service stopped"),contactService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Contact service stopped"),botService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Bot service stopped"),profileService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Profile service stopped"),conversationService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Conversation service stopped"),conferenceService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Conference service stopped"),webConferenceService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Web Conference service stopped"),pstnConferenceService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: PTSN Conference service stopped"),callLogService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: ChannelService service stopped"),channelService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: CallLog service stopped"),telephonyService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Telephony service stopped"),fileServerService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: FileServer service stopped"),fileStorageService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: FileStorage service stopped"),invitationService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Invitation service stopped"),groupService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Group service stopped"),favoriteService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Favorite service stopped"),voiceMessageService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Voice Message Service service stopped"),roomService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Company service stopped"),companyService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Admin Company service stopped"),adminCompanyService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Admin User service stopped"),adminUserService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Invitation service stopped"),webrtcGatewayService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: webrtcGateway service stopped"),xmppService.stop()})).then((function(){return $log.sdk(_this3.logService+"[signout] :: Records service stopped"),recordsService.stop()})).then((function(){$log.sdk(_this3.logService+"[signout] :: XMPP service stopped"),$log.sdk(_this3.logService+"[signout] :: Services Successfully unloaded!");var sdkEvent=new CustomEvent(_this3.RAINBOW_ONSTOPPED);return document.dispatchEvent(sdkEvent),resolve(result)})).catch((function(error){return $log.sdk(_this3.logService+"[signout] :: An error occured during signout"),reject(error)}))}))}},{key:"updateUserPassword",value:function(oldPassword,newPassword){return _contactService.get(this).updateUserPassword(oldPassword,newPassword,!1)}},{key:"getState",value:function(){return this.state}},{key:"getToken",value:function(){return _authService.get(this).token}},{key:"refreshToken",value:function(){return _authService.get(this).renewAuthToken(!1)}},{key:"signinToRainbow",value:function(login,password,token){var _this4=this,$log=_$log.get(this),$rootScope=_$rootScope.get(this),authService=_authService.get(this),videoService=_videoService.get(this),webrtcServiceEventHandler=_webrtcServiceEventHandler.get(this),contactService=_contactService.get(this),botService=_botService.get(this),profileService=_profileService.get(this),conversationService=_conversationService.get(this),conferenceService=_conferenceService.get(this),webConferenceService=_webConferenceService.get(this),pstnConferenceService=_pstnConferenceService.get(this),callLogService=_callLogService.get(this),channelService=_channelService.get(this),telephonyService=_telephonyService.get(this),fileServerService=_fileServerService.get(this),fileStorageService=_fileStorageService.get(this),invitationService=_invitationService.get(this),groupService=_groupService.get(this),favoriteService=_favoriteService.get(this),voiceMessageService=_voiceMessageService.get(this),roomService=_roomService.get(this),companyService=_companyService.get(this),adminCompanyService=_adminCompanyService.get(this),adminUserService=_adminUserService.get(this),webrtcGatewayService=_webrtcGatewayService.get(this),xmppService=_xmppService.get(this),recordsService=_recordsService.get(this),platformService=_platformService.get(this),SDK=_SDK.get(this),withToken=!1;return new Promise((function(resolve,reject){if(token)withToken=!0,login=null,password=null;else{if(!login)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'login' is missing or empty"});if(!password)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'password' is missing or empty"})}$log.sdk(_this4.logService+"[signin] :: Rainbow host used "+_this4.hostUsed),withToken?$log.sdk(_this4.logService+"[signin] :: Trying to sign-in with given token"):$log.sdk(_this4.logService+"[signin] :: Tryng to sign-in");var result={code:SDK.OK,label:"",account:null};authService.removeCredentials(),authService.authenticateOnHost(login,password,_this4.hostUsed,{appID:sdk.key.appID,appSecret:sdk.key.appSecret},token).then((function(){result.account={},result.label="ok",result.account.userId=authService.userId,result.account.companyId=authService.companyId,result.account.loginEmail=authService.login,result.account.roles=authService.userData.roles,result.token=authService.token,result.userData=authService.userData;var stats=[];$log.sdk(_this4.logService+"[signin] :: Successfully sign-in with  | "+authService.jidIm);var sdkEvent=new CustomEvent(_this4.RAINBOW_ONSIGNED,{detail:result});document.dispatchEvent(sdkEvent),authService.startTokenSurvey(),$log.sdk(_this4.logService+"[signin] :: Start services..."),xmppService.disconnectionHandler=_this4.disconnectionHandler,xmppService.start(stats).then((function(){return $log.sdk(_this4.logService+"[signin] :: XMPP service ready!"),companyService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Company service ready!"),adminCompanyService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Admin company service ready!"),adminUserService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Admin user service ready!"),contactService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Contact service ready!"),profileService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Profile service ready!"),invitationService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Invitation service ready!"),fileServerService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: FileServer service ready!"),fileStorageService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: FileStorage service ready!"),roomService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Room service ready!"),groupService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Group service ready!"),favoriteService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Favorite service ready!"),voiceMessageService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Voice Message Service service ready!"),webrtcGatewayService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: WebrtcGateway service ready!"),videoService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Video service ready!"),webrtcServiceEventHandler.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: WebRTCEventHandler service ready!"),telephonyService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Telephony service ready!"),pstnConferenceService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: PSTN Conference service ready!"),webConferenceService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Web Conference service ready!"),conversationService.start(stats)})).then((function(){$log.sdk(_this4.logService+"[signin] :: Conversation service ready!"),$log.sdk(_this4.logService+"[signin] :: Send initial presence"),contactService.sendPresenceFromConfiguration()})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Initial presence sent !"),callLogService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: CallLog service ready!"),platformService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Platform service ready!"),botService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Bot service ready!"),conferenceService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Conference service ready!"),recordsService.start(stats)})).then((function(){return $log.sdk(_this4.logService+"[signin] :: Records service ready!"),channelService.start(stats)})).then((function(){$log.sdk(_this4.logService+"[signin] :: Channel service ready!"),$log.sdk(_this4.logService+"[signin] :: Services Successfully loaded!"),$rootScope.$broadcast("ON_CONNECTION_STATE_CHANGE_EVENT","connected");var sdkEvent_RAINBOW_ONSTARTED=new CustomEvent(_this4.RAINBOW_ONSTARTED,{detail:result});return document.dispatchEvent(sdkEvent_RAINBOW_ONSTARTED),resolve(result)})).catch((function(__err){return $log.sdk(_this4.logService+"[signin] :: Error during signin"),$log.sdk(_this4.logService+"[SIGNIN ERROR]",__err),result.code=SDK.ERRORXMPP,result.label="errorXMPP",result.account=null,reject(result)}))})).catch((function(){return $log.sdk(_this4.logService+"[signin] :: Error during signin"),result.code=SDK.ERRORUNAUTHORIZED,result.label="errorUnauthorized",reject(result)}))}))}},{key:"disconnectionHandler",value:function(){_$log.get(this).sdk(this.logService+"[discHandler] :: Disconnected from the XMPP Rainbow Cloud Services")}},{key:"onConnectionStateChangeEvent",value:function(__event,status){_$log.get(this).sdk(this.logService+"[onChange] :: Connection state changed to "+status),this.state=status;var sdkEvent=new CustomEvent(this.RAINBOW_ONCONNECTIONSTATECHANGED,{detail:status});document.dispatchEvent(sdkEvent)}}]),ConnectionService}();function presenceService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function presenceService_createClass(Constructor,protoProps,staticProps){return protoProps&&presenceService_defineProperties(Constructor.prototype,protoProps),staticProps&&presenceService_defineProperties(Constructor,staticProps),Constructor}var presenceService_$log=new WeakMap,presenceService_$rootScope=new WeakMap,presenceService_xmppService=new WeakMap,presenceService_contactService=new WeakMap,presenceService_SDK=new WeakMap,PresenceService=function(){function PresenceService($log,$rootScope,xmppService,contactService,SDK){var _this=this;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,PresenceService),presenceService_$log.set(this,$log),presenceService_$rootScope.set(this,$rootScope),presenceService_xmppService.set(this,xmppService),presenceService_contactService.set(this,contactService),presenceService_SDK.set(this,SDK),this.logService="PresenceService | ",this.RAINBOW_PRESENCE_ONLINE="online",this.RAINBOW_PRESENCE_AWAY="away",this.RAINBOW_PRESENCE_DONOTDISTURB="dnd",this.RAINBOW_PRESENCE_OFFLINE="xa",this.RAINBOW_PRESENCE_BUSY="busy",this.RAINBOW_PRESENCE_UNKNOW="unknow",this.RAINBOW_ONCONTACTPRESENCECHANGED="rainbowcontactpresencechanged",this.RAINBOW_ONPRESENCECHANGED="rainbowpresencechanged",this.RAINBOW_ONCONTACTRICHPRESENCECHANGED="rainbowcontactrichpresencechanged",this.RAINBOW_ONRICHPRESENCECHANGED="rainbowrichpresencechanged",this.setPresenceTo=this.setPresenceTo.bind(this),$rootScope.$on("$destroy",$rootScope.$on("ON_ROSTER_PRESENCE_CHANGED_EVENT",(function(event,json){return _this.onPresenceChangedEvent(event,json)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_UPDATE_CONTACT_RICH_STATUS_EVENT",(function(event,contact){return _this.onRichPresenceChangedEvent(event,contact)})))}return presenceService_createClass(PresenceService,null,[{key:"$inject",get:function(){return["$log","$rootScope","xmppService","contactService","SDK"]}}]),presenceService_createClass(PresenceService,[{key:"setPresenceTo",value:function(strPresenceState){var $log=presenceService_$log.get(this),SDK=presenceService_SDK.get(this),contactService=presenceService_contactService.get(this);return strPresenceState!==this.RAINBOW_PRESENCE_DONOTDISTURB&&strPresenceState!==this.RAINBOW_PRESENCE_AWAY&&strPresenceState!==this.RAINBOW_PRESENCE_OFFLINE&&strPresenceState!==this.RAINBOW_PRESENCE_ONLINE?{code:SDK.ERRORBADREQUEST,label:"Parameter 'strPresenceState' should be 'dnd', 'away', 'xa' (invisible) or 'online'"}:($log.sdk(this.logService+"[setPresenceTo] :: Set presence to "+strPresenceState),contactService.changeMyPresence(strPresenceState),{code:SDK.OK,label:"OK"})}},{key:"onPresenceChangedEvent",value:function(__event,json){var xmppService=presenceService_xmppService.get(this),$log=presenceService_$log.get(this),message=json.message||"''";if(json.jid===xmppService.fullJid){$log.sdk(this.logService+"[onPresenceChangedEvent] :: Presence changed for me ("+json.jid+") to  "+json.status+" | "+message);var sdkEvent=new CustomEvent(this.RAINBOW_ONPRESENCECHANGED,{detail:json});document.dispatchEvent(sdkEvent)}else{$log.sdk(this.logService+"[onPresenceChangedEvent] :: Presence changed for contact ("+json.jid+") to  "+json.status+" | "+message);var _sdkEvent=new CustomEvent(this.RAINBOW_ONCONTACTPRESENCECHANGED,{detail:json});document.dispatchEvent(_sdkEvent)}}},{key:"onRichPresenceChangedEvent",value:function(__event,contact){var xmppService=presenceService_xmppService.get(this),$log=presenceService_$log.get(this),message=contact.message||"''",telStatus=contact.telStatus||"''";if(xmppService.fullJid.includes(contact.jid)){$log.sdk(this.logService+"[onPresenceChangedEvent] :: Rich Presence changed for myself to status "+contact.status+", message "+message+" and telStatus "+telStatus);var sdkEvent=new CustomEvent(this.RAINBOW_ONRICHPRESENCECHANGED,{detail:contact});document.dispatchEvent(sdkEvent)}else{$log.sdk(this.logService+"[onPresenceChangedEvent] :: Rich Presence changed for contact ("+contact.jid+") to status "+contact.status+", message "+message+" and telStatus "+telStatus);var _sdkEvent2=new CustomEvent(this.RAINBOW_ONCONTACTRICHPRESENCECHANGED,{detail:contact});document.dispatchEvent(_sdkEvent2)}}}]),PresenceService}();function userProfileService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function userProfileService_createClass(Constructor,protoProps,staticProps){return protoProps&&userProfileService_defineProperties(Constructor.prototype,protoProps),staticProps&&userProfileService_defineProperties(Constructor,staticProps),Constructor}var userProfileService_$log=new WeakMap,userProfileService_$rootScope=new WeakMap,userProfileService_contactService=new WeakMap,userProfileService_xmppService=new WeakMap,userProfileService_profileService=new WeakMap,userProfileService_adminUserService=new WeakMap,userProfileService_SDK=new WeakMap,UserProfileService=function(){function UserProfileService($log,$rootScope,contactService,xmppService,profileService,adminUserService,SDK){!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,UserProfileService),userProfileService_$log.set(this,$log),userProfileService_$rootScope.set(this,$rootScope),userProfileService_contactService.set(this,contactService),userProfileService_xmppService.set(this,xmppService),userProfileService_profileService.set(this,profileService),userProfileService_adminUserService.set(this,adminUserService),userProfileService_SDK.set(this,SDK),this.logService="UserProfileService | ",this.getProfile=this.getProfile.bind(this),this.updateFirstName=this.updateFirstName.bind(this),this.updateLastName=this.updateLastName.bind(this),this.updatePhoneNumber=this.updatePhoneNumber.bind(this),this.updatePhotoFromUrl=this.updatePhotoFromUrl.bind(this)}return userProfileService_createClass(UserProfileService,null,[{key:"$inject",get:function(){return["$log","$rootScope","contactService","xmppService","profileService","adminUserService","SDK"]}}]),userProfileService_createClass(UserProfileService,[{key:"getProfile",value:function(){var _this=this,$log=userProfileService_$log.get(this),profileService=userProfileService_profileService.get(this);return new Promise((function(resolve,reject){profileService.getUserData().then((function(userData){$log.sdk(_this.logService+"[getProfile] :: done");var obj={name:userData.lastName,firstName:userData.firstName,phoneNumbers:userData.phoneNumbers};return resolve(obj)})).catch((function(err){return $log.sdk(_this.logService+"[getProfile] :: Error when trying to get Profile - "+err),reject(err)}))}))}},{key:"updateFirstName",value:function(strFirstname){var _this2=this,SDK=userProfileService_SDK.get(this),profileService=userProfileService_profileService.get(this),$log=userProfileService_$log.get(this);return new Promise((function(resolve,reject){if(!strFirstname||"string"!=typeof strFirstname||strFirstname.length<1)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strFirstname' is missing, empty or null"});var param={firstName:strFirstname};profileService.setUserData(param).then((function(result){$log.sdk(_this2.logService+"[updateFirstName] :: First name updated");var obj={lastName:result.data.lastName,firstName:result.data.firstName,phoneNumbers:result.data.phoneNumbers};return resolve(obj)})).catch((function(err){return $log.sdk(_this2.logService+"[updateFirstName] :: Error when updating first name - "+err),reject(err)}))}))}},{key:"updateLastName",value:function(strLastName){var _this3=this,SDK=userProfileService_SDK.get(this),profileService=userProfileService_profileService.get(this),$log=userProfileService_$log.get(this);return new Promise((function(resolve,reject){if(!strLastName||"string"!=typeof strLastName||strLastName.length<1)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strName' is missing, empty or null"});var param={lastName:strLastName};profileService.setUserData(param).then((function(result){$log.sdk(_this3.logService+"[updateName] :: Name updated");var obj={lastName:result.data.lastName,firstName:result.data.firstName,phoneNumbers:result.data.phoneNumbers};return resolve(obj)})).catch((function(err){return $log.sdk(_this3.logService+"[updateName] :: Error when updating name - "+err),reject(err)}))}))}},{key:"updatePhoneNumber",value:function(type,deviceType,strPhoneNumber,country){var _this4=this,SDK=userProfileService_SDK.get(this),profileService=userProfileService_profileService.get(this),$log=userProfileService_$log.get(this);return new Promise((function(resolve,reject){if(!type||"string"!=typeof type||["home","work","other"].indexOf(type)<0)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'type' is missing or not in 'home', 'work', 'other'"});if(!deviceType||"string"!=typeof deviceType||["landline","mobile","fax","other"].indexOf(deviceType)<0)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'deviceType' is missing or not in 'landline', 'mobile', 'fax', 'other'"});if(!strPhoneNumber||"string"!=typeof strPhoneNumber)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strPhoneNumber' is missing, empty or null"});var param={phoneNumbers:[{type:type,deviceType:deviceType,number:strPhoneNumber}]};country&&"string"==typeof country&&(param.country=country),profileService.getUserData().then((function(userData){if(userData.phoneNumbers.length){if(!userData.phoneNumbers.some((function(number){return number.type===type&&number.deviceType===deviceType&&(number.number=strPhoneNumber,!0)}))){var newNumber={type:type,deviceType:deviceType,number:strPhoneNumber};userData.phoneNumbers.push(newNumber)}return profileService.setUserData(userData)}return profileService.setUserData(param)})).then((function(result){$log.sdk(_this4.logService+"[updatePhoneNumber] :: Phone number updated");var obj={lastName:result.data.lastName,firstName:result.data.firstName,phoneNumbers:result.data.phoneNumbers};return resolve(obj)})).catch((function(err){return $log.sdk(_this4.logService+"[updatePhoneNumber] :: Error when updating phone number - "+err),reject(err)}))}))}},{key:"updatePhotoFromUrl",value:function(imgUrl){var _this5=this,SDK=userProfileService_SDK.get(this),$log=userProfileService_$log.get(this),contactService=userProfileService_contactService.get(this);return new Promise((function(resolve,reject){if(!imgUrl||"string"!=typeof imgUrl||imgUrl.length<1)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'imgUrl' is missing, empty or null"});contactService.pushAvatarImage(imgUrl).then((function(){return $log.sdk(_this5.logService+"[updatePhotoFromUrl] :: Photo updated"),resolve()})).catch((function(err){return $log.sdk(_this5.logService+"[updatePhotoFromUrl] :: Error when updating Photo: "+err),reject(err)}))}))}}]),UserProfileService}();function contactsService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function contactsService_createClass(Constructor,protoProps,staticProps){return protoProps&&contactsService_defineProperties(Constructor.prototype,protoProps),staticProps&&contactsService_defineProperties(Constructor,staticProps),Constructor}var contactsService_$log=new WeakMap,contactsService_$rootScope=new WeakMap,contactsService_contactService=new WeakMap,_directoryService=new WeakMap,contactsService_invitationService=new WeakMap,contactsService_SDK=new WeakMap,ContactsService=function(){function ContactsService($log,$rootScope,contactService,directoryService,invitationService,SDK){var _this=this;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,ContactsService),this.logService="ContactService | ",contactsService_$log.set(this,$log),contactsService_$rootScope.set(this,$rootScope),contactsService_contactService.set(this,contactService),_directoryService.set(this,directoryService),contactsService_invitationService.set(this,invitationService),contactsService_SDK.set(this,SDK),this.RAINBOW_ONCONTACTINFORMATIONCHANGED="rainbowcontactinformationchanged",this.RAINBOW_ONINFORMATIONCHANGED="rainbowinformationchanged",this.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED="rainbowsubscriptionnumberchanged",this.RAINBOW_ONCONTACTINVITATIONRECEIVED="rainbowinvitationreceived",this.getContactByJID=this.getContactByJID.bind(this),this.getContactById=this.getContactById.bind(this),this.getNetworkContacts=this.getNetworkContacts.bind(this),this.getAll=this.getAll.bind(this),this.getConnectedUser=this.getConnectedUser.bind(this),this.getConnectedUserPhone=this.getConnectedUserPhone.bind(this),this.searchByName=this.searchByName.bind(this),this.searchByLogin=this.searchByLogin.bind(this),this.searchByJid=this.searchByJid.bind(this),this.searchById=this.searchById.bind(this),this.acceptInvitation=this.acceptInvitation.bind(this),this.declineInvitation=this.declineInvitation.bind(this),this.addToNetwork=this.addToNetwork.bind(this),this.sendInvitationByEmail=this.sendInvitationByEmail.bind(this),this.removeFromNetwork=this.removeFromNetwork.bind(this),this.getInvitationById=this.getInvitationById.bind(this),this.getInvitationsReceived=this.getInvitationsReceived.bind(this),this.cancelInvitation=this.cancelInvitation.bind(this),this.getInvitationsSent=this.getInvitationsSent.bind(this),$rootScope.$on("$destroy",$rootScope.$on("ON_CONTACT_UPDATED_EVENT",(function(event,contact){return _this.onContactInformationUpdated(event,contact)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_USER_CONTACT_UPDATED_EVENT",(function(event,contact){return _this.onInformationUpdated(event,contact)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_INVITATIONS_NUMBER_UPDATED",(function(){return _this.onInvitationNumberChanged()}))),$rootScope.$on("$destroy",$rootScope.$on("ON_INVITATION_CHANGED",(function(event,contact){return _this.onInvitationReceived(event,contact)})))}return contactsService_createClass(ContactsService,null,[{key:"$inject",get:function(){return["$log","$rootScope","contactService","directoryService","invitationService","SDK"]}}]),contactsService_createClass(ContactsService,[{key:"onContactInformationUpdated",value:function(__event,contact){var sdkEvent=new CustomEvent(this.RAINBOW_ONCONTACTINFORMATIONCHANGED,{detail:contact});document.dispatchEvent(sdkEvent)}},{key:"onInformationUpdated",value:function(__event,contact){var sdkEvent=new CustomEvent(this.RAINBOW_ONINFORMATIONCHANGED,{detail:contact});document.dispatchEvent(sdkEvent)}},{key:"onInvitationNumberChanged",value:function(){var sdkEvent=new CustomEvent(this.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED);document.dispatchEvent(sdkEvent)}},{key:"onInvitationReceived",value:function(__event,invitation){var sdkEvent=new CustomEvent(this.RAINBOW_ONCONTACTINVITATIONRECEIVED,{detail:invitation});document.dispatchEvent(sdkEvent)}},{key:"getContactByJID",value:function(strJID){var contactService=contactsService_contactService.get(this),SDK=contactsService_SDK.get(this);return strJID?contactService.getContactByJid(strJID):{code:SDK.ERRORBADREQUEST,label:"Parameter 'strJID' is missing or empty"}}},{key:"getContactById",value:function(strId){var contactService=contactsService_contactService.get(this),SDK=contactsService_SDK.get(this);return strId?contactService.getContactById(strId):{code:SDK.ERRORBADREQUEST,label:"Parameter 'strId' is missing or empty"}}},{key:"getNetworkContacts",value:function(){var contactService=contactsService_contactService.get(this);return contactService.getContacts().filter((function(contact){return contact.id!==contactService.userContact.id&&!contact.isBot&&contact.roster}))}},{key:"getAll",value:function(){var contactService=contactsService_contactService.get(this);return contactService.getContacts().filter((function(contact){return contact.id!==contactService.userContact.id&&!contact.isBot}))}},{key:"getConnectedUser",value:function(){return contactsService_contactService.get(this).userContact||null}},{key:"getConnectedUserPhone",value:function(){var contactService=contactsService_contactService.get(this);return contactService.userContact?0===contactService.userContact.pbxId.length?null:{phoneNumber:contactService.userContact.phonePbx,pbxId:contactService.userContact.pbxId}:null}},{key:"searchByName",value:function(strName,limit){var SDK=contactsService_SDK.get(this),directoryService=_directoryService.get(this);return new Promise((function(resolve,reject){if(!strName)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strName' is missing or empty"});limit||(limit=20),directoryService.search(strName,!0,Math.min(limit,1e3)).then((function(contacts){return resolve(contacts)})).catch((function(err){return reject(err)}))}))}},{key:"searchByLogin",value:function(strLogin){var SDK=contactsService_SDK.get(this),directoryService=_directoryService.get(this);return new Promise((function(resolve,reject){if(!strLogin)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strLogin' is missing or empty"});directoryService.searchUserByLogin(strLogin).then((function(contact){return resolve(contact)})).catch((function(err){return 404===err.status||400===err.status?resolve(null):reject(err)}))}))}},{key:"searchByJid",value:function(strJid){var SDK=contactsService_SDK.get(this),directoryService=_directoryService.get(this);return new Promise((function(resolve,reject){if(!strJid)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strJid' is missing or empty"});directoryService.searchUserByJid(strJid).then((function(contact){return resolve(contact)})).catch((function(err){return 404===err.status||400===err.status?resolve(null):reject(err)}))}))}},{key:"searchById",value:function(strId){var SDK=contactsService_SDK.get(this),contactService=contactsService_contactService.get(this);return new Promise((function(resolve,reject){if(!strId)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strId' is missing or empty"});contactService.getContactByDBId(strId,!0).then((function(contact){return resolve(contact)})).catch((function(err){return 404===err.status||400===err.status?resolve(null):reject(err)}))}))}},{key:"acceptInvitation",value:function(invitation){var SDK=contactsService_SDK.get(this),invitationService=contactsService_invitationService.get(this);return new Promise((function(resolve,reject){if(!invitation)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'invitation' is missing or null"});invitationService.acceptInvitation(invitation).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)}))}))}},{key:"declineInvitation",value:function(invitation){var SDK=contactsService_SDK.get(this),invitationService=contactsService_invitationService.get(this);return new Promise((function(resolve,reject){if(!invitation)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'invitation' is missing or null"});invitationService.declineInvitation(invitation).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)}))}))}},{key:"addToNetwork",value:function(contact){var SDK=contactsService_SDK.get(this),invitationService=contactsService_invitationService.get(this);return new Promise((function(resolve,reject){if(!contact)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"};invitationService.joinContactInvitation(contact).then((function(){return resolve(contact)})).catch((function(err){return reject(err)}))}))}},{key:"sendInvitationByEmail",value:function(email,customMessage){var SDK=contactsService_SDK.get(this),invitationService=contactsService_invitationService.get(this);return new Promise((function(resolve,reject){if(!email)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'email' is missing or null"});invitationService.sendInvitationByEmail(email,customMessage).then((function(contact){return resolve(contact)})).catch((function(err){return reject(err)}))}))}},{key:"removeFromNetwork",value:function(contact){var SDK=contactsService_SDK.get(this),contactService=contactsService_contactService.get(this);return new Promise((function(resolve,reject){if(!contact)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});contactService.removeContact(contact).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)}))}))}},{key:"getInvitationById",value:function(strInvitationId){var invitationService=contactsService_invitationService.get(this),SDK=contactsService_SDK.get(this);return strInvitationId?invitationService.getInvitation(strInvitationId):{code:SDK.ERRORBADREQUEST,label:"Parameter 'strInvitationId' is missing or null"}}},{key:"getInvitationsReceived",value:function(){return contactsService_invitationService.get(this).getReceivedInvitations()}},{key:"cancelInvitation",value:function(invitation){var invitationService=contactsService_invitationService.get(this),SDK=contactsService_SDK.get(this);return new Promise((function(resolve,reject){if(!invitation)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'invitation' is missing or null"});invitationService.cancelOneSendInvitation(invitation).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)}))}))}},{key:"getInvitationsSent",value:function(){return contactsService_invitationService.get(this).getSentInvitations()}}]),ContactsService}();function pbxService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function pbxService_createClass(Constructor,protoProps,staticProps){return protoProps&&pbxService_defineProperties(Constructor.prototype,protoProps),staticProps&&pbxService_defineProperties(Constructor,staticProps),Constructor}var pbxService_$log=new WeakMap,pbxService_$rootScope=new WeakMap,pbxService_contactService=new WeakMap,pbxService_videoService=new WeakMap,pbxService_telephonyService=new WeakMap,pbxService_webrtcGatewayService=new WeakMap,pbxService_voiceMessageService=new WeakMap,_Call=new WeakMap,pbxService_SDK=new WeakMap,PbxService=function(){function PbxService($log,$rootScope,contactService,videoService,telephonyService,webrtcGatewayService,voiceMessageService,Call,SDK){var _this=this;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,PbxService),this.logService="TelphonyService | ",pbxService_$log.set(this,$log),pbxService_$rootScope.set(this,$rootScope),pbxService_contactService.set(this,contactService),pbxService_videoService.set(this,videoService),pbxService_telephonyService.set(this,telephonyService),pbxService_webrtcGatewayService.set(this,webrtcGatewayService),pbxService_voiceMessageService.set(this,voiceMessageService),_Call.set(this,Call),pbxService_SDK.set(this,SDK),this.RAINBOW_ONTELEPHONYCALLSTATECHANGED="rainbowontelephonycallstatechanged",this.RAINBOW_ONVOIPCALLSTATECHANGED="rainbowonvoipcallstatechanged",this.RAINBOW_ONTELEPHONYSTARTED="rainbowontelephonystarted",this.RAINBOW_ONTELEPHONYSTOPPED="rainbowontelephonystopped",this.RAINBOW_ONTELEPHONYFORWARDSTATECHANGED="rainbowontelephonyforwardstatechanged",this.RAINBOW_ONCALLNOMADICEVENT="rainbowoncallnomadicevent",this.RAINBOW_ONVOIPSTARTED="rainbowonvoipstarted",this.RAINBOW_ONVOIPSTOPPED="rainbowonvoipstopped",this.RAINBOW_ONVOICEMESSAGEUPDATED="rainbowonvoicemessageupdated",this.RAINBOW_TELEPHONYDIALING="dialing",this.RAINBOW_TELEPHONYRINGINGOUTGOING="ringingOutgoing",this.RAINBOW_TELEPHONYINCOMING="incomingCall",this.RAINBOW_TELEPHONYACTIVE="active",this.RAINBOW_TELEPHONYRELEASING="releasing",this.RAINBOW_TELEPHONYUNKNOW="Unknown",this.isTelephonyAvailable=this.isTelephonyAvailable.bind(this),this.getAgentVersion=this.getAgentVersion.bind(this),this.getXMPPAgentStatus=this.getXMPPAgentStatus.bind(this),this.getPhoneAPIStatus=this.getPhoneAPIStatus.bind(this),this.makeCall=this.makeCall.bind(this),this.callByNumber=this.callByNumber.bind(this),this.callWithMessage=this.callWithMessage.bind(this),this.callWithSubject=this.callWithSubject.bind(this),this.calls=this.calls.bind(this),this.release=this.release.bind(this),this.deflectToVM=this.deflectToVM.bind(this),this.forwardToDevice=this.forwardToDevice.bind(this),this.forwardToVoicemail=this.forwardToVoicemail.bind(this),this.cancelForward=this.cancelForward.bind(this),this.getForwardStatusFromServer=this.getForwardStatusFromServer.bind(this),this.getForwardStatus=this.getForwardStatus.bind(this),this.answer=this.answer.bind(this),this.hold=this.hold.bind(this),this.retrieve=this.retrieve.bind(this),this.transfertCall=this.transfertCall.bind(this),this.conferenceCall=this.conferenceCall.bind(this),this.fetchVoiceMailMessagesNumber=this.fetchVoiceMailMessagesNumber.bind(this),this.getNomadicState=this.getNomadicState.bind(this),this.setExternalNomadicNumber=this.setExternalNomadicNumber.bind(this),this.setNomadicOfficePhone=this.setNomadicOfficePhone.bind(this),this.setNomadicWebRtc=this.setNomadicWebRtc.bind(this),this.isDeskPhoneAvailable=this.isDeskPhoneAvailable.bind(this),this.isVoIPAvailable=this.isVoIPAvailable.bind(this),$rootScope.$on("$destroy",$rootScope.$on("ON_TELEPHONY_STATUS_CHANGED_EVENT",(function(event,state){return _this.onTelephonyStateChanged(event,state)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_CALL_NOMADIC_EVENT",(function(event,nomadicObject){return _this.onCallNomadicEvent(event,nomadicObject)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_CALL_UPDATED_EVENT",(function(event,call){return _this.onTelephonyCallChanged(event,call)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_CALL_FORWARDED_EVENT",(function(event,forwardStatus){return _this.onCallForwardChanged(event,forwardStatus)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTCGATEWAY_STATE_CHG",(function(event,state){return _this.onVoIPStateChanged(event,state)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_VOICE_MESSAGE_UPDATE_EVENT",(function(event,counters){return _this.onVoiceMessageUpdated(event,counters)})))}return pbxService_createClass(PbxService,null,[{key:"$inject",get:function(){return["$log","$rootScope","contactService","videoService","telephonyService","webrtcGatewayService","voiceMessageService","Call","SDK"]}}]),pbxService_createClass(PbxService,[{key:"onTelephonyStateChanged",value:function(__event,state){if(pbxService_$log.get(this).sdk(this.logService+"[onTelephonyStateChanged] :: PBX state changed to "+state),"started"===state){var sdkEvent=new CustomEvent(this.RAINBOW_ONTELEPHONYSTARTED,{detail:null});document.dispatchEvent(sdkEvent)}else{var _sdkEvent=new CustomEvent(this.RAINBOW_ONTELEPHONYSTOPPED,{detail:null});document.dispatchEvent(_sdkEvent)}}},{key:"onCallNomadicEvent",value:function(__event,nomadicObject){pbxService_$log.get(this).sdk(this.logService+"[onCallNomadicEvent] :: Nomadic event received");var sdkEvent=new CustomEvent(this.RAINBOW_ONCALLNOMADICEVENT,{detail:nomadicObject});document.dispatchEvent(sdkEvent)}},{key:"onTelephonyCallChanged",value:function(__event,call){var webrtcGatewayService=pbxService_webrtcGatewayService.get(this),$log=pbxService_$log.get(this),isMediaPillarCallSituation=webrtcGatewayService.isMediaPillarCallSituation(call);if("Phone"===call.type.value&&isMediaPillarCallSituation){$log.sdk(this.logService+"[onTelephonyCallChanged] :: Telephony state changed to "+call);var sdkEvent=new CustomEvent(this.RAINBOW_ONTELEPHONYCALLSTATECHANGED,{detail:call});document.dispatchEvent(sdkEvent)}else if("Phone"!==call.type.value&&isMediaPillarCallSituation){$log.sdk(this.logService+"[onTelephonyCallChanged] :: Telephony state changed to "+call);var _sdkEvent2=new CustomEvent(this.RAINBOW_ONVOIPCALLSTATECHANGED,{detail:call});document.dispatchEvent(_sdkEvent2)}}},{key:"onCallForwardChanged",value:function(__event,forwardStatus){pbxService_$log.get(this).sdk(this.logService+"[onCallForwardChanged] :: Forward state changed to "+forwardStatus);var sdkEvent=new CustomEvent(this.RAINBOW_ONTELEPHONYFORWARDSTATECHANGED,{detail:forwardStatus});document.dispatchEvent(sdkEvent)}},{key:"onVoIPStateChanged",value:function(__event,state){if(pbxService_$log.get(this).sdk(this.logService+"[onVoIPStateChanged] :: VoIP state changed to "+state?"true":"false"),state){var sdkEvent=new CustomEvent(this.RAINBOW_ONVOIPSTARTED);document.dispatchEvent(sdkEvent)}else{var _sdkEvent3=new CustomEvent(this.RAINBOW_ONVOIPSTOPPED);document.dispatchEvent(_sdkEvent3)}}},{key:"onVoiceMessageUpdated",value:function(__event,counters){pbxService_$log.get(this).sdk(this.logService+"[onVoiceMessageUpdated] :: New Voice Message event received");var sdkEvent=new CustomEvent(this.RAINBOW_ONVOICEMESSAGEUPDATED,{detail:counters});document.dispatchEvent(sdkEvent)}},{key:"isTelephonyAvailable",value:function(){return pbxService_telephonyService.get(this).started}},{key:"getAgentVersion",value:function(){return pbxService_telephonyService.get(this).agentStatus.agentVersion||"unknown"}},{key:"getXMPPAgentStatus",value:function(){return pbxService_telephonyService.get(this).agentStatus.xmppAgent||"unknown"}},{key:"getPhoneAPIStatus",value:function(){return pbxService_telephonyService.get(this).agentStatus.phoneApi||"unknown"}},{key:"makeCall",value:function(contact,strPhoneNumber,callSubject,correlatorData){var SDK=pbxService_SDK.get(this),telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){if(!strPhoneNumber)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strPhoneNumber' is missing or empty"});telephonyService.makeCall(contact,strPhoneNumber,callSubject,correlatorData).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject({code:SDK.ERROR,label:err})}))}))}},{key:"callByNumber",value:function(strPhoneNumber){var SDK=pbxService_SDK.get(this),telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){if(!strPhoneNumber)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strPhoneNumber' is missing or empty"});telephonyService.makeCallByPhoneNumber(strPhoneNumber).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject({code:SDK.ERROR,label:err})}))}))}},{key:"callWithMessage",value:function(contact,phoneNumber,callSubject,correlatorData){var SDK=pbxService_SDK.get(this),telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){return contact?phoneNumber?callSubject?void telephonyService.makeCall(contact,phoneNumber,callSubject,correlatorData).then((function(){return resolve({code:SDK.OK,label:"OK"}).catch((function(err){return reject({code:SDK.ERROR,label:err})}))})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'callSubject' is missing or empty"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'phoneNumber' is missing or empty"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or empty"})}))}},{key:"callWithSubject",value:function(contact,phoneNumber,callSubject){var SDK=pbxService_SDK.get(this),telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){return contact?phoneNumber?callSubject?void telephonyService.makeCall(contact,phoneNumber,callSubject).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject({code:SDK.ERROR,label:err})})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'callSubject' is missing or empty"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'phoneNumber' is missing or empty"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or empty"})}))}},{key:"calls",value:function(){return pbxService_telephonyService.get(this).calls}},{key:"release",value:function(call){var SDK=pbxService_SDK.get(this),telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){if(!call)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"});telephonyService.releaseCall(call).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject({code:SDK.ERROR,label:err})}))}))}},{key:"deflectToVM",value:function(call){var SDK=pbxService_SDK.get(this),telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){if(!call)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"});telephonyService.deflectCallToVM(call).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject({code:SDK.ERROR,label:err})}))}))}},{key:"forwardToDevice",value:function(strPhoneNumber){var SDK=pbxService_SDK.get(this),telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){if(!strPhoneNumber||"string"!=typeof strPhoneNumber||0===strPhoneNumber.length)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strPhoneNumber' is missing or empty"});telephonyService.forwardToDevice(strPhoneNumber).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject({code:SDK.ERROR,label:err})}))}))}},{key:"forwardToVoicemail",value:function(){var telephonyService=pbxService_telephonyService.get(this),SDK=pbxService_SDK.get(this);return new Promise((function(resolve,reject){telephonyService.forwardToVoicemail().then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject({code:SDK.ERROR,label:err})}))}))}},{key:"cancelForward",value:function(){var telephonyService=pbxService_telephonyService.get(this),SDK=pbxService_SDK.get(this);return new Promise((function(resolve,reject){telephonyService.cancelForward().then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject({code:SDK.ERROR,label:err})}))}))}},{key:"getForwardStatusFromServer",value:function(){var telephonyService=pbxService_telephonyService.get(this),SDK=pbxService_SDK.get(this);return new Promise((function(resolve,reject){telephonyService.getForwardStatus().then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject({code:SDK.ERROR,label:err})}))}))}},{key:"getForwardStatus",value:function(){return pbxService_telephonyService.get(this).getForwardObject()}},{key:"answer",value:function(call){var SDK=pbxService_SDK.get(this),telephonyService=pbxService_telephonyService.get(this),videoService=pbxService_videoService.get(this);return new Promise((function(resolve,reject){return call?call.mediaPillarCall?(videoService.answerCall(call,"audio"),resolve()):void telephonyService.answerCall(call).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"})}))}},{key:"hold",value:function(call){var SDK=pbxService_SDK.get(this),telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){if(!call)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"});telephonyService.holdCall(call).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject({code:SDK.ERROR,label:err})}))}))}},{key:"retrieve",value:function(call){var SDK=pbxService_SDK.get(this),telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){if(!call)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"});telephonyService.retrieveCall(call).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject({code:SDK.ERROR,label:err})}))}))}},{key:"transfertCall",value:function(activeCall,heldCall){var SDK=pbxService_SDK.get(this),telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){return activeCall?heldCall?void telephonyService.transfertCall(activeCall,heldCall).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject({code:SDK.ERROR,label:err})})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'heldCall' is missing or null"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'activeCall' is missing or null"})}))}},{key:"conferenceCall",value:function(activeCall,heldCall){var SDK=pbxService_SDK.get(this),telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){return activeCall?heldCall?void telephonyService.conferenceCall(activeCall,heldCall).then((function(){return resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject({code:SDK.ERROR,label:err})})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'heldCall' is missing or null"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'activeCall' is missing or null"})}))}},{key:"fetchVoiceMailMessagesNumber",value:function(){var voiceMessageService=pbxService_voiceMessageService.get(this);return new Promise((function(resolve,reject){voiceMessageService.getVoiceMessagesCounters().then((function(){return resolve()})).catch((function(err){return reject(err)}))}))}},{key:"getNomadicState",value:function(){var telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){telephonyService.getNomadicStatus().then((function(){return resolve()})).catch((function(err){return reject(err)}))}))}},{key:"setExternalNomadicNumber",value:function(phoneNumber){var SDK=pbxService_SDK.get(this),telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){return phoneNumber?"string"!=typeof phoneNumber?reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'phoneNumber' is not a string"}):void telephonyService.nomadicLogin(phoneNumber).then((function(){return resolve()})).catch((function(err){return reject(err)})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'phoneNumber' is missing or null"})}))}},{key:"setNomadicOfficePhone",value:function(){var telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){telephonyService.nomadicLoginOnOfficePhone().then((function(){return resolve()})).catch((function(){return reject()}))}))}},{key:"setNomadicWebRtc",value:function(){var webrtcGatewayService=pbxService_webrtcGatewayService.get(this),telephonyService=pbxService_telephonyService.get(this);return new Promise((function(resolve,reject){var mediapillar=webrtcGatewayService.getMyMediaPillarRemoteExtension();telephonyService.nomadicLogin(mediapillar).then((function(){return resolve()})).catch((function(){return reject()}))}))}},{key:"isDeskPhoneAvailable",value:function(){return!pbxService_contactService.get(this).userContact.isVirtualTerm}},{key:"isVoIPAvailable",value:function(){return pbxService_webrtcGatewayService.get(this).isMediaPillarAvailable()}}]),PbxService}();function conversationsService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function conversationsService_createClass(Constructor,protoProps,staticProps){return protoProps&&conversationsService_defineProperties(Constructor.prototype,protoProps),staticProps&&conversationsService_defineProperties(Constructor,staticProps),Constructor}var conversationsService_$log=new WeakMap,conversationsService_$rootScope=new WeakMap,_Conversation=new WeakMap,conversationsService_conversationService=new WeakMap,conversationsService_SDK=new WeakMap,ConversationsService=function(){function ConversationsService($log,$rootScope,Conversation,conversationService,SDK){var _this=this;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,ConversationsService),this.logService="ConversationsService | ",conversationsService_$log.set(this,$log),conversationsService_$rootScope.set(this,$log),_Conversation.set(this,Conversation),conversationsService_conversationService.set(this,conversationService),conversationsService_SDK.set(this,SDK),this.RAINBOW_ONCONVERSATIONREMOVED="rainbowconversationremoved",this.RAINBOW_ONCONVERSATIONCHANGED="rainbowconversationchanged",this.RAINBOW_ONCONVERSATIONSCHANGED="rainbowconversationschanged",this.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED="rainbowconversationsmissedcounterchanged",this.getAllConversations=this.getAllConversations.bind(this),this.getCallById=this.getCallById.bind(this),this.getConversationById=this.getConversationById.bind(this),this.getConversationByBubbleId=this.getConversationByBubbleId.bind(this),this.openConversationForContact=this.openConversationForContact.bind(this),this.openConversationForBubble=this.openConversationForBubble.bind(this),this.closeConversation=this.closeConversation.bind(this),$rootScope.$on("$destroy",$rootScope.$on("ON_CONVERSATIONS_UPDATED_EVENT",(function(event,conversation){return _this.onConversationsChanged(event,conversation)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_CONVERSATION_REMOVE_EVENT",(function(event,conversation){return _this.onConversationsRemoved(event,conversation)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_CONVERSATION_UPDATED_EVENT",(function(event,conversation){return _this.onConversationChanged(event,conversation)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_MISSED_COUNTER_CHANGED_EVENT",(function(event,json){return _this.onConversationsCounterChanged(event,json)})))}return conversationsService_createClass(ConversationsService,null,[{key:"$inject",get:function(){return["$log","$rootScope","Conversation","conversationService","SDK"]}}]),conversationsService_createClass(ConversationsService,[{key:"onConversationsChanged",value:function(event,conversation){if(conversation){var sdkEvent=new CustomEvent(this.RAINBOW_ONCONVERSATIONSCHANGED,{detail:conversation});document.dispatchEvent(sdkEvent)}}},{key:"onConversationsRemoved",value:function(event,conversation){var sdkEvent=new CustomEvent(this.RAINBOW_ONCONVERSATIONREMOVED,{detail:conversation});document.dispatchEvent(sdkEvent)}},{key:"onConversationChanged",value:function(event,conversation){var sdkEvent=new CustomEvent(this.RAINBOW_ONCONVERSATIONCHANGED,{detail:conversation});document.dispatchEvent(sdkEvent)}},{key:"onConversationsCounterChanged",value:function(event,json){var sdkEvent=new CustomEvent(this.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED,{detail:json});document.dispatchEvent(sdkEvent)}},{key:"getAllConversations",value:function(){var allConversations=conversationsService_conversationService.get(this).getConversations(),oneToOneConversationsOnly=[];return allConversations.forEach((function(conversation){oneToOneConversationsOnly.push(conversation)})),oneToOneConversationsOnly}},{key:"getCallById",value:function(strCallId){var SDK=conversationsService_SDK.get(this),conversationService=conversationsService_conversationService.get(this);if(!strCallId)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'strCallId' is missing or empty"};var allConversations=conversationService.getConversations(),call=null;return allConversations.forEach((function(conversation){conversation.videoCall&&conversation.videoCall.id===strCallId?call=conversation.videoCall:conversation.audioCall&&conversation.audioCall.id===strCallId&&(call=conversation.audioCall)})),call}},{key:"getConversationById",value:function(strId){var SDK=conversationsService_SDK.get(this),conversationService=conversationsService_conversationService.get(this);return strId?conversationService.getConversationById(strId):{code:SDK.ERRORBADREQUEST,label:"Parameter 'callId' is missing or empty"}}},{key:"getConversationByBubbleId",value:function(strBubbleId){var SDK=conversationsService_SDK.get(this),conversationService=conversationsService_conversationService.get(this);return strBubbleId?conversationService.getConversationByRoomDbId(strBubbleId):{code:SDK.ERRORBADREQUEST,label:"Parameter 'strBubbleId' is missing or empty"}}},{key:"openConversationForContact",value:function(contact){var _this2=this,SDK=conversationsService_SDK.get(this),$log=conversationsService_$log.get(this),conversationService=conversationsService_conversationService.get(this);return new Promise((function(resolve,reject){if(!contact)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});$log.sdk(_this2.logService+"[openConversationForContact] :: Trying to open a conversation for a contact"),conversationService.getOrCreateOneToOneConversation(contact.jid).then((function(conversation){return $log.sdk(_this2.logService+"[openConversationForContact] :: Conversation retrieved or created "+conversation.id),resolve(conversation)})).catch((function(err){return $log.sdk(_this2.logService+"[openConversationForContact] :: Error"),reject(err)}))}))}},{key:"openConversationForBubble",value:function(bubble){var _this3=this,SDK=conversationsService_SDK.get(this),$log=conversationsService_$log.get(this),conversationService=conversationsService_conversationService.get(this);return new Promise((function(resolve,reject){if(!bubble)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});$log.sdk(_this3.logService+"[openConversationForBubble] :: Try to create or get a conversation for a bubble "),conversationService.getRoomConversation(bubble.jid).then((function(conversation){return $log.sdk(_this3.logService+"[openConversationForBubble] :: Conversation retrieved or created "+conversation.id),resolve(conversation)})).catch((function(err){return $log.sdk(_this3.logService+"[openConversationForBubble] :: Error"),reject(err)}))}))}},{key:"closeConversation",value:function(conversation){var SDK=conversationsService_SDK.get(this),conversationService=conversationsService_conversationService.get(this);return new Promise((function(resolve,reject){if(!conversation)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"});conversationService.closeConversation(conversation).then((function(){return resolve()})).catch((function(err){return reject(err)}))}))}}]),ConversationsService}();function imService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function imService_createClass(Constructor,protoProps,staticProps){return protoProps&&imService_defineProperties(Constructor.prototype,protoProps),staticProps&&imService_defineProperties(Constructor,staticProps),Constructor}var imService_$rootScope=new WeakMap,imService_$log=new WeakMap,imService_roomService=new WeakMap,imService_fileStorageService=new WeakMap,imService_conversationService=new WeakMap,imService_Conversation=new WeakMap,_Message=new WeakMap,imService_SDK=new WeakMap,ImService=function(){function ImService($rootScope,$log,roomService,fileStorageService,conversationService,Conversation,Message,SDK){var _this=this;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,ImService),imService_$rootScope.set(this,$rootScope),imService_$log.set(this,$log),imService_roomService.set(this,roomService),imService_fileStorageService.set(this,fileStorageService),imService_conversationService.set(this,conversationService),imService_Conversation.set(this,Conversation),_Message.set(this,Message),imService_SDK.set(this,SDK),this.logService="IMService | ",this.RAINBOW_ONNEWIMMESSAGERECEIVED="rainbownewimmessagereceived",this.RAINBOW_ONNEWIMRECEIPTRECEIVED="rainbownewimreceiptreceived",this.RAINBOW_ONNEWPARTICIPANTSTATUS="rainbownewparticipantstatus",this.getMessagesFromConversation=this.getMessagesFromConversation.bind(this),this.getMessageFromConversationById=this.getMessageFromConversationById.bind(this),this.getMessageFromBubbleById=this.getMessageFromBubbleById.bind(this),this.sendMessageToConversation=this.sendMessageToConversation.bind(this),this.sendCorrectedChatMessage=this.sendCorrectedChatMessage.bind(this),this.replyToMessage=this.replyToMessage.bind(this),this.deleteMessage=this.deleteMessage.bind(this),this.sendIsTypingStateInConversation=this.sendIsTypingStateInConversation.bind(this),this.sendMessageToBubble=this.sendMessageToBubble.bind(this),this.sendIsTypingStateInBubble=this.sendIsTypingStateInBubble.bind(this),this.removeAllMessagesFromConversation=this.removeAllMessagesFromConversation.bind(this),this.markMessageFromConversationAsRead=this.markMessageFromConversationAsRead.bind(this),$rootScope.$on("$destroy",$rootScope.$on("ON_CONVERSATION_MESSAGE_RECEIVED",(function(event,message,conversation,cc){return _this.onNewImMessageReceived(event,message,conversation,cc)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_CONVERSATION_RECEIPT_RECEIVED",(function(event,message,conversation,evt){return _this.onNewImReceiptReceived(event,message,conversation,evt)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_CONVERSATIONS_STATUS_MESSAGE_EVENT",(function(event,conversation,participant,status){return _this.onNewParticipantStatus(event,conversation,participant,status)})))}return imService_createClass(ImService,null,[{key:"$inject",get:function(){return["$rootScope","$log","roomService","fileStorageService","conversationService","Conversation","Message","SDK"]}}]),imService_createClass(ImService,[{key:"onNewImMessageReceived",value:function(__event,message,conversation,cc){var sdkEvent=new CustomEvent(this.RAINBOW_ONNEWIMMESSAGERECEIVED,{detail:{message:message,conversation:conversation,cc:cc}});document.dispatchEvent(sdkEvent)}},{key:"onNewImReceiptReceived",value:function(__event,message,conversation,evt){var sdkEvent=new CustomEvent(this.RAINBOW_ONNEWIMRECEIPTRECEIVED,{detail:{message:message,conversation:conversation,evt:evt}});document.dispatchEvent(sdkEvent)}},{key:"onNewParticipantStatus",value:function(__event,participant,conversation,status){if(status&&status.value){var sdkEvent=new CustomEvent(this.RAINBOW_ONNEWPARTICIPANTSTATUS,{detail:{participant:participant,conversation:conversation,status:status.value}});document.dispatchEvent(sdkEvent)}}},{key:"getMessagesFromConversation",value:function(conversation,intNbMessage){var conversationService=imService_conversationService.get(this),SDK=imService_SDK.get(this);return new Promise((function(resolve,reject){return conversation?(intNbMessage=intNbMessage?Math.min(intNbMessage,100):30,resolve(conversationService.getHistoryPage(conversation,intNbMessage))):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})}))}},{key:"getMessageFromConversationById",value:function(conversation,strMessageId){var SDK=imService_SDK.get(this),fileStorageService=imService_fileStorageService.get(this);if(!conversation)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"};if(!strMessageId)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'strMessageId' is missing or empty"};var message=conversation.getMessageById(strMessageId);return message&&message.fileId&&(message.shortFileDescriptor=fileStorageService.getFileDescriptorById(message.fileId)),message}},{key:"getMessageFromBubbleById",value:function(bubble,strMessageId){var SDK=imService_SDK.get(this),conversationService=imService_conversationService.get(this),Conversation=imService_Conversation.get(this),fileStorageService=imService_fileStorageService.get(this);if(!bubble)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"};if(!strMessageId)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'strMessageId' is missing or empty"};var conversation=conversationService.getConversationByRoomDbId(bubble.dbId);if(!conversation)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' don't have a conversation"};if(conversation.type!==Conversation.Type.ROOM)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is not a bubble conversation"};var message=conversation.getMessageById(strMessageId);return message&&message.fileId&&(message.shortFileDescriptor=fileStorageService.getFileDescriptorById(message.fileId)),message}},{key:"sendMessageToConversation",value:function(conversation,strMessage,alternativeContentType,alternativeContentMessage){var $log=imService_$log.get(this),SDK=imService_SDK.get(this),conversationService=imService_conversationService.get(this);if($log.sdk(this.logService+"[sendMessageToConversation] :: Trying to send a message"),!conversation)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"};if(!strMessage)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'strMessage' is missing or empty"};if("string"!=typeof strMessage)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'strMessage' must be a string"};if(strMessage.length>1024)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'strMessage' should be shorter than 1024 characters"};var alternativeContent=null;if(alternativeContentMessage){if(alternativeContentMessage.length>1024)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'alternativeContent.message' should be shorter than 1024 characters"};if(!alternativeContentType||"text"!==alternativeContentType&&"markdown"!==alternativeContentType)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'alternativeContent.type' should be set to either 'text' or 'markdown'"};alternativeContent={type:alternativeContentType,message:alternativeContentMessage}}return conversationService.sendChatMessage(conversation,strMessage,alternativeContent)}},{key:"sendCorrectedChatMessage",value:function(conversation,strMessage,messageId){var $log=imService_$log.get(this),SDK=imService_SDK.get(this),conversationService=imService_conversationService.get(this);return $log.sdk(this.logService+"[sendCorrectedChatMessage] :: Trying to send a corrected message"),conversation?strMessage?strMessage.length>1024?{code:SDK.ERRORBADREQUEST,label:"Parameter 'strMessage' should be shorter than 1024 characters"}:messageId?(conversationService.sendCorrectedChatMessage(conversation,strMessage,messageId),conversation.getMessageById(messageId)):{code:SDK.ERRORBADREQUEST,label:"Parameter 'messageId' is missing or empty"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'strMessage' is missing or empty"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}}},{key:"replyToMessage",value:function(conversation,strMessage,message){var SDK=imService_SDK.get(this),conversationService=imService_conversationService.get(this);return new Promise((function(resolve,reject){conversation?strMessage?message?(conversationService.sendAnswerChatMessage(conversation,strMessage,message),resolve(message)):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'message' is missing or null"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strMessage' is missing or null"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})}))}},{key:"deleteMessage",value:function(conversation,messageId){var SDK=imService_SDK.get(this),conversationService=imService_conversationService.get(this);return conversation?messageId?(conversationService.sendCorrectedChatMessage(conversation,"",messageId),conversation.getMessageById(messageId)):{code:SDK.ERRORBADREQUEST,label:"Parameter 'messageId' is missing or empty"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}}},{key:"sendIsTypingStateInConversation",value:function(conversation,status){var SDK=imService_SDK.get(this),conversationService=imService_conversationService.get(this);return new Promise((function(resolve,reject){if(conversation)return"boolean"!=typeof status?reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'status' is missing or null"}):(conversation=conversation.id?conversationService.getConversationById(conversation.id):null)?(conversationService.sendIsTypingState(conversation,status),resolve()):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation': this conversation doesn't exist"});reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})}))}},{key:"sendMessageToBubble",value:function(bubble,strMessage){var SDK=imService_SDK.get(this),conversationService=imService_conversationService.get(this),roomService=imService_roomService.get(this);return new Promise((function(resolve,reject){return bubble?strMessage?strMessage.length>1024?reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strMessage' should be shorter than 1024 characters"}):void conversationService.getRoomConversation(bubble.jid).then((function(conversation){if(!conversation)return reject({code:SDK.ERRORNOTFOUND,label:"No 'conversation' found"});if(bubble.isActive){var message=conversationService.sendChatMessage(conversation,strMessage);return resolve(message)}roomService.sendInitialRoomPresenceSync(bubble).then((function(){var message=conversationService.sendChatMessage(conversation,strMessage);return resolve(message)})).catch((function(err){return reject(err)}))})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strMessage' is missing or empty"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"})}))}},{key:"sendIsTypingStateInBubble",value:function(bubble,status){var SDK=imService_SDK.get(this),conversationService=imService_conversationService.get(this);return new Promise((function(resolve,reject){return bubble?"boolean"!=typeof status?reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'status' is missing or null"}):bubble.jid?void conversationService.getRoomConversation(bubble.jid).then((function(conversation){return conversation?(conversationService.sendIsTypingState(conversation,status),resolve()):reject({code:SDK.ERRORNOTFOUND,label:"No 'conversation' found for this bubble"})})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble': this bubble is not a valid one"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"})}))}},{key:"removeAllMessagesFromConversation",value:function(conversation){var conversationService=imService_conversationService.get(this),Conversation=imService_Conversation.get(this),SDK=imService_SDK.get(this);return new Promise((function(resolve,reject){conversation?conversation.type!==Conversation.Type.ONE_TO_ONE?reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):conversationService.removeAllMessages(conversation).then((function(){resolve({code:SDK.OK,label:"OK"})})).catch((function(err){reject(err)})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})}))}},{key:"markMessageFromConversationAsRead",value:function(conversation,message){var SDK=imService_SDK.get(this),conversationService=imService_conversationService.get(this),Message=_Message.get(this);return message?conversation?message.receiptStatus===Message.ReceiptStatus.READ?{code:SDK.ERRORBADREQUEST,label:"Parameter 'message' is aldready marked as read"}:(conversation.sendAckReadMessage(message),message.receiptStatus===Message.ReceiptStatus.READ&&conversationService.decreaseMissedIMCounterForConversation(conversation),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'message' is missing or empty"}}}]),ImService}();function webRTCService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function webRTCService_createClass(Constructor,protoProps,staticProps){return protoProps&&webRTCService_defineProperties(Constructor.prototype,protoProps),staticProps&&webRTCService_defineProperties(Constructor,staticProps),Constructor}var webRTCService_$log=new WeakMap,webRTCService_$rootScope=new WeakMap,webRTCService_videoService=new WeakMap,webRTCService_platformService=new WeakMap,_settingsService=new WeakMap,_XMPPService=new WeakMap,_extensionSharingService=new WeakMap,webRTCService_Call=new WeakMap,webRTCService_webrtcGatewayService=new WeakMap,webRTCService_recordsService=new WeakMap,webRTCService_conversationService=new WeakMap,webRTCService_SDK=new WeakMap,WebRTCService=function(){function WebRTCService($log,$rootScope,videoService,platformService,settingsService,XMPPService,extensionSharingService,Call,webrtcGatewayService,recordsService,conversationService,SDK){var _this=this;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,WebRTCService),this.logService="WebRTCService | ",webRTCService_$log.set(this,$log),webRTCService_$rootScope.set(this,$rootScope),webRTCService_videoService.set(this,videoService),webRTCService_platformService.set(this,platformService),_settingsService.set(this,settingsService),_XMPPService.set(this,XMPPService),_extensionSharingService.set(this,extensionSharingService),webRTCService_Call.set(this,Call),webRTCService_webrtcGatewayService.set(this,webrtcGatewayService),webRTCService_recordsService.set(this,recordsService),webRTCService_conversationService.set(this,conversationService),webRTCService_SDK.set(this,SDK),this.isChromeExtensionInstalled=!1,this.RAINBOW_ONWEBRTCCALLSTATECHANGED="rainbowonwebrtccallstatechanged",this.RAINBOW_ONVOIPCALLSTATECHANGED="rainbowonvoipcallstatechanged",this.RAINBOW_ONWEBRTCMEDIADEVICECHANGED="rainbowonwebrtcmediadevicechanged",this.RAINBOW_ONWEBRTCERRORHANDLED="rainbowonwebrtcerrorhandled",this.RAINBOW_ONWEBRTCSTREAMADDED="rainbowonwebrtcstreamadded",this.RAINBOW_ONWEBRTCTRACKCHANGED="rainbowonwebrtctrackchanged",this.RAINBOW_ONWEBRTCTMEDIAERROROCCURED="rainbowonwebrtcmediaerroroccured",this.RAINBOW_ONWEBRTCTRECORDSTARTED="rainbowonwebrtcrecordstarted",this.RAINBOW_ONWEBRTCTRECORDSTOPPED="rainbowonwebrtcrecordstopped",this.RAINBOW_ONWEBRTCTRECORDPAUSED="rainbowonwebrtcrecordpaused",this.RAINBOW_ONWEBRTCTRECORDREMOTESTARTED="rainbowonwebrtcrecordremotestarted",this.RAINBOW_ONWEBRTCTRECORDREMOTESTOPPED="rainbowonwebrtcrecordremotestopped",this.RAINBOW_ONWEBRTCTRECORDDONE="rainbowonwebrtcrecorddone",this.RAINBOW_ONWEBRTCTRECORDERROR="rainbowonwebrtcrecorderror",this.canMakeAudioVideoCall=this.canMakeAudioVideoCall.bind(this),this.hasAMicrophone=this.hasAMicrophone.bind(this),this.hasACamera=this.hasACamera.bind(this),this.useMicrophone=this.useMicrophone.bind(this),this.useSpeaker=this.useSpeaker.bind(this),this.useCamera=this.useCamera.bind(this),this.callInAudio=this.callInAudio.bind(this),this.callInVideo=this.callInVideo.bind(this),this.callInSharing=this.callInSharing.bind(this),this.callinAudioWithSharing=this.callinAudioWithSharing.bind(this),this.answerInAudio=this.answerInAudio.bind(this),this.answerInVideo=this.answerInVideo.bind(this),this.getPeerConnectionForCall=this.getPeerConnectionForCall.bind(this),this.showLocalVideo=this.showLocalVideo.bind(this),this.hideLocalVideo=this.hideLocalVideo.bind(this),this.showRemoteVideo=this.showRemoteVideo.bind(this),this.hideRemoteVideo=this.hideRemoteVideo.bind(this),this.addVideoToCall=this.addVideoToCall.bind(this),this.addSharingToCall=this.addSharingToCall.bind(this),this.removeVideoFromCall=this.removeVideoFromCall.bind(this),this.removeSharingFromCall=this.removeSharingFromCall.bind(this),this.release=this.release.bind(this),this.muteAudioCall=this.muteAudioCall.bind(this),this.muteVideoCall=this.muteVideoCall.bind(this),this.unmuteAudioCall=this.unmuteAudioCall.bind(this),this.unmuteVideoCall=this.unmuteVideoCall.bind(this),this.getLocalStreamsFromCall=this.getLocalStreamsFromCall.bind(this),this.getRemoteStreamsFromCall=this.getRemoteStreamsFromCall.bind(this),this.setChromeExtensionIdForSharing=this.setChromeExtensionIdForSharing.bind(this),this.canMakeDesktopSharingCall=this.canMakeDesktopSharingCall.bind(this),this.startRecording=this.startRecording.bind(this),this.stopRecording=this.stopRecording.bind(this),$rootScope.$on("$destroy",$rootScope.$on("ON_CALL_UPDATED_EVENT",(function(event,call){return _this.onWebRTCCallChanged(event,call)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTC_CALL_ERROR_EVENT",(function(event,error){return _this.onWebRTCErrorHandled(event,error)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTC_REMOTE_STREAM_ADDED",(function(event,streams){return _this.onWebRTCRemoteStreamAdded(event,streams)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTC_CALL_ESCALATION_SUCCESS",(function(event,call){return _this.onWebRTCEscalation(event,call)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTC_GETUSERMEDIA_ERROR",(function(event,error){return _this.onWebRTCGetUserMediaError(event,error)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTC_RECORD_SAVED",(function(event,description,data,source){return _this.onWebRTCRecordingData(event,description,data,source)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTC_RECORD_ERROR",(function(){return _this.onWebRTCRecordingError()}))),$rootScope.$on("$destroy",$rootScope.$on("ON_RECORDING_START_MSG_RECEIVED",(function(){return _this.onWebRTCRecordingStartedByRemote()}))),$rootScope.$on("$destroy",$rootScope.$on("ON_RECORDING_STOP_MSG_RECEIVED",(function(){return _this.onWebRTCRecordingStoppedByRemote()})))}return webRTCService_createClass(WebRTCService,null,[{key:"$inject",get:function(){return["$log","$rootScope","videoService","platformService","settingsService","xmppService","extensionSharingService","Call","webrtcGatewayService","recordsService","conversationService","SDK"]}}]),webRTCService_createClass(WebRTCService,[{key:"onWebRTCCallChanged",value:function(__event,call){var webrtcGatewayService=webRTCService_webrtcGatewayService.get(this),Call=webRTCService_Call.get(this);if(call.type.value!==Call.Type.WEBRTC.value||webrtcGatewayService.isMediaPillarCallSituation(call)){if(call.type.value===Call.Type.WEBRTC.value&&webrtcGatewayService.isMediaPillarCallSituation(call)){var _sdkEvent=new CustomEvent(this.RAINBOW_ONVOIPCALLSTATECHANGED,{detail:call});document.dispatchEvent(_sdkEvent)}}else{var sdkEvent=new CustomEvent(this.RAINBOW_ONWEBRTCCALLSTATECHANGED,{detail:call});document.dispatchEvent(sdkEvent)}}},{key:"onWebRTCErrorHandled",value:function(__event,error){var sdkEvent=new CustomEvent(this.RAINBOW_ONWEBRTCERRORHANDLED,{detail:error});document.dispatchEvent(sdkEvent)}},{key:"onWebRTCRemoteStreamAdded",value:function(__event,streams){var sdkEvent=new CustomEvent(this.RAINBOW_ONWEBRTCSTREAMADDED,{detail:streams});document.dispatchEvent(sdkEvent)}},{key:"onWebRTCEscalation",value:function(__event,call){var sdkEvent=new CustomEvent(this.RAINBOW_ONWEBRTCTRACKCHANGED,{detail:call});document.dispatchEvent(sdkEvent)}},{key:"onWebRTCGetUserMediaError",value:function(__event,error){var sdkEvent=new CustomEvent(this.RAINBOW_ONWEBRTCMEDIAERROROCCURED,{detail:error});document.dispatchEvent(sdkEvent)}},{key:"onWebRTCRecordingData",value:function(__event,description,data,source){var sdkEvent=new CustomEvent(this.RAINBOW_ONWEBRTCTRECORDDONE,{detail:[description,data,source]});document.dispatchEvent(sdkEvent)}},{key:"onWebRTCRecordingError",value:function(){var sdkEvent=new CustomEvent(this.RAINBOW_ONWEBRTCTRECORDERROR,{detail:null});document.dispatchEvent(sdkEvent)}},{key:"onWebRTCRecordingStartedByRemote",value:function(){var sdkEvent=new CustomEvent(this.RAINBOW_ONWEBRTCTRECORDREMOTESTARTED,{detail:null});document.dispatchEvent(sdkEvent)}},{key:"onWebRTCRecordingStoppedByRemote",value:function(){var sdkEvent=new CustomEvent(this.RAINBOW_ONWEBRTCTRECORDREMOTESTOPPED,{detail:null});document.dispatchEvent(sdkEvent)}},{key:"canMakeAudioVideoCall",value:function(){return("https:"===location.protocol||"chrome-extension:"===location.protocol)&&DetectRTC.isWebRTCSupported&&DetectRTC.isGetUserMediaSupported}},{key:"hasAMicrophone",value:function(){return DetectRTC.hasMicrophone}},{key:"hasACamera",value:function(){return DetectRTC.hasWebcam}},{key:"useMicrophone",value:function(strMicrophoneId){var SDK=webRTCService_SDK.get(this),settingsService=_settingsService.get(this);return strMicrophoneId?(settingsService.setSetting("microphone",strMicrophoneId),settingsService.setSetting("headsetMicrophone",strMicrophoneId),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORBADREQUEST,label:"Parameter 'strMicrophoneId' is missing or empty"}}},{key:"useSpeaker",value:function(strSpeakerId){var SDK=webRTCService_SDK.get(this),settingsService=_settingsService.get(this),platformService=webRTCService_platformService.get(this);return strSpeakerId?(settingsService.setSetting("speaker",strSpeakerId),settingsService.setSetting("headsetSpeaker",strSpeakerId),settingsService.setSetting("ringingSpeaker",strSpeakerId),platformService.setSpeakerForElement(document.getElementById("largevideo"),strSpeakerId),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORBADREQUEST,label:"Parameter 'strSpeakerId' is missing or empty"}}},{key:"useCamera",value:function(strCameraId){var SDK=webRTCService_SDK.get(this),settingsService=_settingsService.get(this);return strCameraId?(settingsService.setSetting("camera",strCameraId),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORBADREQUEST,label:"Parameter 'strCameraId' is missing or empty"}}},{key:"callInAudio",value:function(contact,subject){var SDK=webRTCService_SDK.get(this),videoService=webRTCService_videoService.get(this);return contact?this.canMakeAudioVideoCall()?(videoService.makeCall(contact,"audio",subject),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}}},{key:"callInVideo",value:function(contact,subject){var SDK=webRTCService_SDK.get(this),videoService=webRTCService_videoService.get(this);return contact?this.canMakeAudioVideoCall()?(videoService.makeCall(contact,"video",subject),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}}},{key:"callInSharing",value:function(contact,subject){var _this2=this,SDK=webRTCService_SDK.get(this),videoService=webRTCService_videoService.get(this),userAgent=navigator.userAgent;return new Promise((function(resolve,reject){if(!contact)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});if(!(userAgent.indexOf("Chrome")>-1))return videoService.makeDesktopSharingCall(contact,"sharingOnly",subject),resolve({code:SDK.OK,label:"OK"});var raw=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);if(parseInt(raw[2],10)>72)return videoService.makeDesktopSharingCall(contact,"sharingOnly",subject),resolve({code:SDK.OK,label:"OK"});_this2.canMakeDesktopSharingCall().then((function(){return videoService.makeDesktopSharingCall(contact,"sharingOnly",subject),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)}))}))}},{key:"callinAudioWithSharing",value:function(contact,subject){var _this3=this,SDK=webRTCService_SDK.get(this),videoService=webRTCService_videoService.get(this),userAgent=navigator.userAgent;return new Promise((function(resolve,reject){if(!contact)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});if(!(userAgent.indexOf("Chrome")>-1))return videoService.makeDesktopSharingCall(contact,subject),resolve({code:SDK.OK,label:"OK"});var raw=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);if(parseInt(raw[2],10)>72)return videoService.makeDesktopSharingCall(contact,subject),resolve({code:SDK.OK,label:"OK"});_this3.canMakeDesktopSharingCall().then((function(){return videoService.makeDesktopSharingCall(contact,subject),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)}))}))}},{key:"answerInAudio",value:function(call){var SDK=webRTCService_SDK.get(this),videoService=webRTCService_videoService.get(this);return call?this.canMakeAudioVideoCall()?(videoService.answerCall(call,"audio"),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}}},{key:"answerInVideo",value:function(call){var SDK=webRTCService_SDK.get(this),videoService=webRTCService_videoService.get(this);return call?this.canMakeAudioVideoCall()?(videoService.answerCall(call,"video"),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}}},{key:"getPeerConnectionForCall",value:function(call){var SDK=webRTCService_SDK.get(this),XMPPService=_XMPPService.get(this);return call?call.id?XMPPService.connection.jingle.sessions[call.id].peerconnection:{code:SDK.ERRORBADREQUEST,label:"Can not get the call ID"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}}},{key:"showLocalVideo",value:function(){var SDK=webRTCService_SDK.get(this),videoService=webRTCService_videoService.get(this);return this.canMakeAudioVideoCall()?(videoService.attachLocalMediaStreams(!0),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}}},{key:"hideLocalVideo",value:function(){var SDK=webRTCService_SDK.get(this),videoService=webRTCService_videoService.get(this);return this.canMakeAudioVideoCall()?(videoService.attachLocalMediaStreams(!1),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}}},{key:"showRemoteVideo",value:function(call){var SDK=webRTCService_SDK.get(this),videoService=webRTCService_videoService.get(this);return call?this.canMakeAudioVideoCall()?(videoService.attachDistantMediaStreams(!0,call),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}}},{key:"hideRemoteVideo",value:function(call){var SDK=webRTCService_SDK.get(this),videoService=webRTCService_videoService.get(this);return call?this.canMakeAudioVideoCall()?(videoService.attachDistantMediaStreams(!1,call),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}}},{key:"addVideoToCall",value:function(call){var SDK=webRTCService_SDK.get(this),videoService=webRTCService_videoService.get(this);return this.canMakeAudioVideoCall()?(videoService.addVideoToCall(call,!1),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}}},{key:"addSharingToCall",value:function(call){var _this4=this,videoService=webRTCService_videoService.get(this),SDK=webRTCService_SDK.get(this);return new Promise((function(resolve,reject){var userAgent=navigator.userAgent;if(!call)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"});if(!(userAgent.indexOf("Chrome")>-1))return videoService.addSharingToCall(call),resolve({code:SDK.OK,label:"OK"});var raw=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);if(parseInt(raw[2],10)>72)return videoService.addSharingToCall(call),resolve({code:SDK.OK,label:"OK"});_this4.canMakeDesktopSharingCall().then((function(){return videoService.addSharingToCall(call),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)}))}))}},{key:"removeVideoFromCall",value:function(call){var SDK=webRTCService_SDK.get(this),videoService=webRTCService_videoService.get(this);return this.canMakeAudioVideoCall()?(videoService.removeVideoFromCall(call),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}}},{key:"removeSharingFromCall",value:function(call){var videoService=webRTCService_videoService.get(this),SDK=webRTCService_SDK.get(this);return videoService.removeSharingFromCall(call),{code:SDK.OK,label:"OK"}}},{key:"release",value:function(call){var videoService=webRTCService_videoService.get(this),SDK=webRTCService_SDK.get(this),$log=webRTCService_$log.get(this);return call?(this.canMakeAudioVideoCall()||$log.warn("[webRTCService] release called but WebRTC is not supported by your browser"),videoService.rejectCall(call),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}}},{key:"muteAudioCall",value:function(conversation){var videoService=webRTCService_videoService.get(this),SDK=webRTCService_SDK.get(this);return conversation?this.canMakeAudioVideoCall()?(videoService.muteAudio(conversation,!0),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}}},{key:"muteVideoCall",value:function(conversation){var videoService=webRTCService_videoService.get(this),SDK=webRTCService_SDK.get(this);return conversation?this.canMakeAudioVideoCall()?(videoService.muteVideo(conversation,!0),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}}},{key:"unmuteAudioCall",value:function(conversation){var videoService=webRTCService_videoService.get(this),SDK=webRTCService_SDK.get(this);return conversation?this.canMakeAudioVideoCall()?(videoService.muteAudio(conversation,!1),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}}},{key:"unmuteVideoCall",value:function(conversation){var videoService=webRTCService_videoService.get(this),SDK=webRTCService_SDK.get(this);return conversation?this.canMakeAudioVideoCall()?(videoService.muteVideo(conversation,!1),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}}},{key:"getLocalStreamsFromCall",value:function(call){var XMPPService=_XMPPService.get(this),SDK=webRTCService_SDK.get(this),Call=webRTCService_Call.get(this);if(!(call&&"id"in call))return{code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or empty"};if(call.type!==Call.Type.WEBRTC)return{code:SDK.ERRORNOTFOUND,label:"This call is not an audio or audio/video call"};var session=XMPPService.connection.jingle.sessions[call.id];return session?session.localStreams:[]}},{key:"getRemoteStreamsFromCall",value:function(call){var SDK=webRTCService_SDK.get(this),Call=webRTCService_Call.get(this),XMPPService=_XMPPService.get(this);if(!(call&&"id"in call))return{code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or empty"};if(call.type!==Call.Type.WEBRTC)return{code:SDK.ERRORNOTFOUND,label:"This call is not an audio or audio/video call"};var session=XMPPService.connection.jingle.sessions[call.id];return session?session.remoteStreams:[]}},{key:"setChromeExtensionIdForSharing",value:function(strExtensionId){var SDK=webRTCService_SDK.get(this),extensionSharingService=_extensionSharingService.get(this);return strExtensionId?(extensionSharingService.setExtensionId(strExtensionId),extensionSharingService.start(),{code:SDK.OK,label:"OK"}):{code:SDK.ERRORBADREQUEST,label:"Parameter 'strExtensionId' is missing or empty"}}},{key:"canMakeDesktopSharingCall",value:function(){var _this5=this,extensionSharingService=_extensionSharingService.get(this),SDK=webRTCService_SDK.get(this);return new Promise((function(resolve,reject){var userAgent=navigator.userAgent;if(userAgent.indexOf("Firefox")>-1)return resolve({code:SDK.OK,label:"OK"});if(userAgent.indexOf("Chrome")>-1){var raw=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);if(parseInt(raw[2],10)>72)return videoService.addSharingToCall(call),resolve({code:SDK.OK,label:"OK"})}else extensionSharingService.isExtensionInstalled().then((function(isInstalled){return isInstalled?(_this5.isChromeExtensionInstalled=!0,resolve({code:SDK.OK,label:"OK"})):(_this5.isChromeExtensionInstalled=!1,reject({code:SDK.ERRORUNSUPPORTED,label:"Not Chrome Extension installed for desktop sharing"}))})).catch((function(err){return reject(err)}))}))}},{key:"startRecording",value:function(call,fileName,recordRemote,toUpload,onlyAudio,mimeType){var _this6=this,$log=webRTCService_$log.get(this),SDK=webRTCService_SDK.get(this),recordsService=webRTCService_recordsService.get(this),conversationService=webRTCService_conversationService.get(this);if($log.sdk(this.logService+"[startRecording] :: Enter"),!call)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"};if(!fileName)return{code:SDK.ERRORBADREQUEST,label:"Parameter 'fileName' is missing or null"};if(recordRemote=null==recordRemote||recordRemote,toUpload=null==toUpload||toUpload,onlyAudio=null!=onlyAudio&&onlyAudio,mimeType=null==mimeType?"video/webm;codecs=vp9":mimeType,$log.sdk(this.logService+"[startRecording] :: Prepare recording..."),recordsService.createRecord(call.id,recordRemote?"REMOTE":"LOCAL",toUpload,fileName,onlyAudio,mimeType)){recordsService.setOnPauseCallback((function(){$log.sdk(_this6.logService+"[onRTCChange] :: WebRTC recording paused");var sdkEvent=new CustomEvent(_this6.RAINBOW_ONWEBRTCTRECORDPAUSED,{detail:null});document.dispatchEvent(sdkEvent)})),$log.sdk(this.logService+"[startRecording] :: Start recording"),recordsService.startRecording();var conversation=conversationService.getConversationById(call.conversationId);conversation?($log.sdk(this.logService+"[startRecording] :: Notify remote peer",conversation),conversationService.sendRecordingMessage(conversation,"start")):$log.sdk(this.logService+"[startRecording] :: No conversation found - can't notify remote peer"),$log.sdk(this.logService+"[startRecording] :: WebRTC recording started");var _sdkEvent2=new CustomEvent(this.RAINBOW_ONWEBRTCTRECORDSTARTED,{detail:null});return document.dispatchEvent(_sdkEvent2),{code:SDK.OK,label:"OK"}}$log.sdk(this.logService+"[startRecording] :: can't start a webRTC recording");var sdkEvent=new CustomEvent(this.RAINBOW_ONWEBRTCTRECORDERROR,{detail:null});return document.dispatchEvent(sdkEvent),{code:SDK.ERRORBADREQUEST,label:"Can't record the conversation"}}},{key:"stopRecording",value:function(call){var $log=webRTCService_$log.get(this),recordsService=webRTCService_recordsService.get(this),conversationService=webRTCService_conversationService.get(this),SDK=webRTCService_SDK.get(this);$log.sdk(this.logService+"[stopRecording] :: Stop current WebRTC recording"),recordsService.setOnPauseCallback(null),recordsService.stopRecording();var conversation=conversationService.getConversationById(call.conversationId);conversation?($log.sdk(this.logService+"[stopRecording] :: Notify remote peer",conversation),conversationService.sendRecordingMessage(conversation,"stop")):$log.sdk(this.logService+"[stopRecording] :: No conversation found - can't notify remote peer");var sdkEvent=new CustomEvent(this.RAINBOW_ONWEBRTCTRECORDSTOPPED,{detail:null});return document.dispatchEvent(sdkEvent),{code:SDK.OK,label:"OK"}}}]),WebRTCService}();function bubblesService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function bubblesService_createClass(Constructor,protoProps,staticProps){return protoProps&&bubblesService_defineProperties(Constructor.prototype,protoProps),staticProps&&bubblesService_defineProperties(Constructor,staticProps),Constructor}var bubblesService_$log=new WeakMap,bubblesService_roomService=new WeakMap,bubblesService_videoService=new WeakMap,bubblesService_conversationService=new WeakMap,bubblesService_contactService=new WeakMap,bubblesService_conferenceService=new WeakMap,bubblesService_profileService=new WeakMap,bubblesService_webConferenceService=new WeakMap,_PromiseQueue=new WeakMap,bubblesService_SDK=new WeakMap,_Room=new WeakMap,bubblesService_$rootScope=new WeakMap,BubblesService=function(){function BubblesService($log,roomService,videoService,conversationService,contactService,conferenceService,profileService,webConferenceService,PromiseQueue,SDK,Room,$rootScope){var _this=this;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,BubblesService),this.logService="BubblesService | ",bubblesService_$log.set(this,$log),bubblesService_roomService.set(this,roomService),bubblesService_videoService.set(this,videoService),bubblesService_conversationService.set(this,conversationService),bubblesService_contactService.set(this,contactService),bubblesService_conferenceService.set(this,conferenceService),bubblesService_profileService.set(this,profileService),bubblesService_webConferenceService.set(this,webConferenceService),_PromiseQueue.set(this,PromiseQueue),bubblesService_SDK.set(this,SDK),_Room.set(this,Room),bubblesService_$rootScope.set(this,$rootScope),this.confBubble=null,this.confBubbleType=null,this.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED="rainbowbubblerequesttojoin",this.RAINBOW_ONBUBBLEUPDATED="rainbowbubbleupdated",this.RAINBOW_ONWEBCONFERENCEUPDATED="rainbowwebconferenceupdated",this.RAINBOW_ONWEBRTCMEDIAERROROCCURED="rainbowwebrtcmediaerroroccured",this.RAINBOW_ONBUBBLEAVATARUPDATED="rainbowbubbleavatarupdated",this.RAINBOW_ONBUBBLECONFERENCESTARTEDINVITATIONRECEIVED="rainbowbubbleconferencestartinvitation",this.RAINBOW_ONBUBBLECONFERENCETALKERACTIVE="rainbowonbubbleconferencetalkeractive",this.RAINBOW_ONBUBBLESHARINGCONFERENCESTARTEDINVITATIONRECEIVED="rainbowbubblesharingconferencestartinvitation",this.RAINBOW_ONBUBBLEDEACTIVATED="rainbowonbubbledeactivated",this.createBubble=this.createBubble.bind(this),this.deleteBubble=this.deleteBubble.bind(this),this.deleteAllBubbles=this.deleteAllBubbles.bind(this),this.inviteContactToBubble=this.inviteContactToBubble.bind(this),this.removeContactFromBubble=this.removeContactFromBubble.bind(this),this.promoteContactToModerator=this.promoteContactToModerator.bind(this),this.demoteContactFromModerator=this.demoteContactFromModerator.bind(this),this.changeOwner=this.changeOwner.bind(this),this.acceptInvitationToJoinBubble=this.acceptInvitationToJoinBubble.bind(this),this.declineInvitationToJoinBubble=this.declineInvitationToJoinBubble.bind(this),this.leaveBubble=this.leaveBubble.bind(this),this.closeBubble=this.closeBubble.bind(this),this.isBubbleArchived=this.isBubbleArchived.bind(this),this.getAllBubbles=this.getAllBubbles.bind(this),this.getAllOwnedBubbles=this.getAllOwnedBubbles.bind(this),this.getAllPendingBubbles=this.getAllPendingBubbles.bind(this),this.getAllInactiveBubbles=this.getAllInactiveBubbles.bind(this),this.getBubbleById=this.getBubbleById.bind(this),this.updateDescriptionForBubble=this.updateDescriptionForBubble.bind(this),this.updateAvatarForBubble=this.updateAvatarForBubble.bind(this),this.deleteAvatarFromBubble=this.deleteAvatarFromBubble.bind(this),this.updateCustomDataForBubble=this.updateCustomDataForBubble.bind(this),this.deleteCustomDataForBubble=this.deleteCustomDataForBubble.bind(this),this.isWebRtcConferenceAllowed=this.isWebRtcConferenceAllowed.bind(this),this.hasActiveConferenceSession=this.hasActiveConferenceSession.bind(this),this.getWebRtcConferenceBubble=this.getWebRtcConferenceBubble.bind(this),this.startOrJoinWebRtcConference=this.startOrJoinWebRtcConference.bind(this),this.addMediaToConferenceSession=this.addMediaToConferenceSession.bind(this),this.addSharingToConferenceSession=this.addSharingToConferenceSession.bind(this),this.removeMediaFromConferenceSession=this.removeMediaFromConferenceSession.bind(this),this.removeSharingFromConferenceSession=this.removeSharingFromConferenceSession.bind(this),this.addLocalVideoStreamToConference=this.addLocalVideoStreamToConference.bind(this),this.showLocalVideo=this.showLocalVideo.bind(this),this.getConferenceSessionById=this.getConferenceSessionById.bind(this),this.addDistantVideoStreamToConference=this.addDistantVideoStreamToConference.bind(this),this.updateMainVideoSession=this.updateMainVideoSession.bind(this),this.startOrJoinSharingWebRtcConference=this.startOrJoinSharingWebRtcConference.bind(this),this.stopWebRtcConference=this.stopWebRtcConference.bind(this),$rootScope.$on("ON_CONFERENCE_UPDATED_EVENT",(function(event,conferenceSession){return _this.onConferenceUpdated(event,conferenceSession)})),$rootScope.$on("ON_WEBRTC_GETUSERMEDIA_ERROR",(function(event,conferenceSession){return _this.onWebRtcGetUserMediaError(event,conferenceSession)})),$rootScope.$on("ON_CONFERENCE_PARTICIPANT_EVENT",(function(event,conferenceSession){return _this.onConferenceParticipantEvent(event,conferenceSession)})),$rootScope.$on(roomService.ROOM_UPDATE_EVENT,(function(event,room){return _this.onBubbleUpdatedEvent(event,room)})),$rootScope.$on(roomService.ROOM_AVATAR_UPDATE_EVENT,(function(event){return _this.onAvatarUpdatedEvent(event)})),$rootScope.$on("ROOM_INVITATION",(function(event,room){return _this.onRoomInvitationEvent(event,room)})),$rootScope.$on("ON_CONFERENCE_STARTED_INVITATION",(function(event,room){return _this.onConferenceStartedInvitation(event,room)})),$rootScope.$on("ON_CONFERENCE_TALKER_EVENT",(function(event,conferenceSession){return _this.onConferenceTalkerEvent(event,conferenceSession)}))}return bubblesService_createClass(BubblesService,null,[{key:"$inject",get:function(){return["$log","roomService","videoService","conversationService","contactService","conferenceService","profileService","webConferenceService","PromiseQueue","SDK","Room","$rootScope"]}}]),bubblesService_createClass(BubblesService,[{key:"onConferenceUpdated",value:function(__event,conferenceSession){if(conferenceSession){var sdkEvent=new CustomEvent(this.RAINBOW_ONWEBCONFERENCEUPDATED,{detail:conferenceSession});document.dispatchEvent(sdkEvent)}}},{key:"onWebRtcGetUserMediaError",value:function(__event,conferenceSession){var sdkEvent=new CustomEvent(this.RAINBOW_ONWEBRTCMEDIAERROROCCURED,{detail:conferenceSession});document.dispatchEvent(sdkEvent)}},{key:"onConferenceParticipantEvent",value:function(__event,conferenceSession){var sdkEvent=new CustomEvent(this.RAINBOW_ONWEBCONFERENCEUPDATED,{detail:conferenceSession});document.dispatchEvent(sdkEvent)}},{key:"onBubbleUpdatedEvent",value:function(__event,room){if(!1===room.isActive){var sdkEvent=new CustomEvent(this.RAINBOW_ONBUBBLEDEACTIVATED,{detail:room});document.dispatchEvent(sdkEvent)}else{var _sdkEvent=new CustomEvent(this.RAINBOW_ONBUBBLEUPDATED,{detail:room});document.dispatchEvent(_sdkEvent)}}},{key:"onAvatarUpdatedEvent",value:function(){var sdkEvent=new CustomEvent(this.RAINBOW_ONBUBBLEAVATARUPDATED,{detail:null});document.dispatchEvent(sdkEvent)}},{key:"onRoomInvitationEvent",value:function(__event,room){var sdkEvent=new CustomEvent(this.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED,{detail:room});document.dispatchEvent(sdkEvent)}},{key:"onConferenceStartedInvitation",value:function(__event,room){var _this2=this,confEndpoints=room.confEndpoints;confEndpoints&&confEndpoints.forEach((function(confEndpoint){if("webrtc"===confEndpoint.mediaType){var sdkEvent=new CustomEvent(_this2.RAINBOW_ONBUBBLECONFERENCESTARTEDINVITATIONRECEIVED,{detail:room});document.dispatchEvent(sdkEvent)}if("webrtcSharingOnly"===confEndpoint.mediaType){var _sdkEvent2=new CustomEvent(_this2.RAINBOW_ONBUBBLESHARINGCONFERENCESTARTEDINVITATIONRECEIVED,{detail:room});document.dispatchEvent(_sdkEvent2)}}))}},{key:"onConferenceTalkerEvent",value:function(__event,conferenceSession){if(conferenceSession){var sdkEvent=new CustomEvent(this.RAINBOW_ONBUBBLECONFERENCETALKERACTIVE,{detail:conferenceSession});document.dispatchEvent(sdkEvent)}}},{key:"createBubble",value:function(strName,strDescription,boolWithHistory,disableNotifications,urlAvatar,autoAcceptInvitation){var _this3=this,roomService=bubblesService_roomService.get(this),conversationService=bubblesService_conversationService.get(this),$log=bubblesService_$log.get(this),SDK=bubblesService_SDK.get(this),bubble=null,description=strDescription||"",history=Boolean(boolWithHistory),notifications=Boolean(disableNotifications),autoAccept=Boolean(autoAcceptInvitation);return new Promise((function(resolve,reject){strName?roomService.createRoom(strName,description,history,urlAvatar,notifications,!1,!1,autoAccept).then((function(newBubble){return bubble=newBubble,conversationService.getRoomConversation(bubble.jid)})).then((function(conversation){return $log.sdk(_this3.logService+"[createBubble] :: New bubble "+strName+" created successfully"),roomService.sendInitialRoomPresence(conversation.room),resolve(bubble)})).catch((function(err){return $log.sdk(_this3.logService+"[createBubble] :: Error when creating a bubble"),reject(err)})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strName' is missing or empty"})}))}},{key:"deleteBubble",value:function(bubble){var _this4=this,roomService=bubblesService_roomService.get(this),SDK=bubblesService_SDK.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){if(!bubble)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});_this4.closeBubble(bubble).then((function(closedBubble){return roomService.ownerDeleteRoom(closedBubble)})).then((function(deletedRoom){return resolve(deletedRoom)})).catch((function(err){return reject(err)}))}))}},{key:"deleteAllBubbles",value:function(){var _this5=this,PromiseQueue=_PromiseQueue.get(this),roomService=bubblesService_roomService.get(this),deleteallBubblePromiseQueue=PromiseQueue.create();return roomService.getMyRooms().forEach((function(bubble){deleteallBubblePromiseQueue.add((function(){return _this5.deleteBubble(bubble)}))})),deleteallBubblePromiseQueue.execute()}},{key:"inviteContactToBubble",value:function(contact,bubble,boolAsModerator,boolWithInvitation){var _this6=this,roomService=bubblesService_roomService.get(this),$log=bubblesService_$log.get(this),SDK=bubblesService_SDK.get(this),Room=_Room.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){if(!contact)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});if(!bubble)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});var privilege=Room.Privilege.USER;boolAsModerator&&(privilege=Room.Privilege.MODERATOR);var withoutInvitation=!1;"boolean"==typeof boolWithInvitation&&(withoutInvitation=!boolWithInvitation);var isActive=!1,isAway=!1,isInvited=!1,isRejected=!1,isDeleted=!1;if(bubble.users.forEach((function(user){if(user.contact.id===contact.id)switch(user.status){case"invited":isInvited=!0;break;case"accepted":isActive=!0;break;case"unsubscribed":isAway=!0;break;case"rejected":isRejected=!0;break;case"deleted":isDeleted=!0}})),isActive||isInvited)return reject({code:SDK.ERRORBADREQUEST,label:"Contact has been already invited or is already a member of the room"});isAway||isRejected?roomService.ownerReinviteRejectedUser(bubble,contact,null,privilege,withoutInvitation).then((function(updatedBubble){return updatedBubble.updateAvatarInfo(),resolve(updatedBubble)})).catch((function(err){return $log.sdk(_this6.logService+"[invite     ] :: Error when inviting a contact"),reject(err)})):isDeleted?roomService.ownerReinviteDeletedUser(bubble,contact,null,privilege).then((function(updatedBubble){return updatedBubble.updateAvatarInfo(),resolve(updatedBubble)})).catch((function(err){return $log.sdk(_this6.logService+"[invite     ] :: Error when inviting a contact"),reject(err)})):roomService.addRoomUser(bubble,contact,null,privilege,withoutInvitation).then((function(updatedBubble){return updatedBubble.updateAvatarInfo(),resolve(updatedBubble)})).catch((function(err){return $log.sdk(_this6.logService+"[invite     ] :: Error when inviting a contact"),reject(err)}))}))}},{key:"removeContactFromBubble",value:function(contact,bubble){var _this7=this,roomService=bubblesService_roomService.get(this),$log=bubblesService_$log.get(this),SDK=bubblesService_SDK.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){if(!contact)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"});if(!bubble)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or is null"});var contactStatus="";switch(bubble.users.forEach((function(user){user.contact.id===contact.id&&(contactStatus=user.status)})),contactStatus){case roomService.RoomUserStatus.INVITED:roomService.ownerDeletesUserFromRoom(bubble,contact).then((function(updatedBubble){return updatedBubble.updateAvatarInfo(),resolve(updatedBubble)})).catch((function(err){return $log.sdk(_this7.logService+"[removeContactFromBubble] :: Error when removing a contact"),reject(err)}));break;case roomService.RoomUserStatus.ACCEPTED:roomService.unsubscribeUserFromRoom(bubble,contact).then((function(updatedBubble){return updatedBubble.updateAvatarInfo(),resolve(updatedBubble)})).catch((function(err){return $log.sdk(_this7.logService+"[removeContactFromBubble] :: Error when removing a contact"),reject(err)}));break;default:return resolve(bubble)}}))}},{key:"promoteContactToModerator",value:function(contact,bubble){var _this8=this,roomService=bubblesService_roomService.get(this),$log=bubblesService_$log.get(this),SDK=bubblesService_SDK.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){return contact?bubble?void roomService.updateRoomUser(bubble,contact,null,"moderator").then((function(updatedBubble){return updatedBubble.updateAvatarInfo(),resolve(updatedBubble)})).catch((function(err){return $log.sdk(_this8.logService+"[promoteContactToModerator] :: Error when promoting a contact to a moderator"),reject(err)})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or is null"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"})}))}},{key:"demoteContactFromModerator",value:function(contact,bubble){var _this9=this,roomService=bubblesService_roomService.get(this),$log=bubblesService_$log.get(this),SDK=bubblesService_SDK.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){return contact?bubble?void roomService.updateRoomUser(bubble,contact,null,"user").then((function(updatedBubble){return updatedBubble.updateAvatarInfo(),resolve(updatedBubble)})).catch((function(err){return $log.sdk(_this9.logService+"[demoteContactFromModerator] :: Error when demoting a contact"),reject(err)})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or is null"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"})}))}},{key:"changeOwner",value:function(contact,bubble){var _this10=this,roomService=bubblesService_roomService.get(this),$log=bubblesService_$log.get(this),SDK=bubblesService_SDK.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){return contact?bubble?void roomService.changeRoomOwner(bubble,contact).then((function(updatedBubble){return updatedBubble.updateAvatarInfo(),resolve(updatedBubble)})).catch((function(err){return $log.sdk(_this10.logService+"[changeOwner] :: Error when changing bubble owner"),reject(err)})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or is null"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"})}))}},{key:"acceptInvitationToJoinBubble",value:function(bubble){var _this11=this,roomService=bubblesService_roomService.get(this),$log=bubblesService_$log.get(this),SDK=bubblesService_SDK.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){if(!bubble)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});roomService.acceptRoomInvitation(bubble).then((function(){return resolve(bubble)})).catch((function(err){return $log.sdk(_this11.logService+"[acceptInvitationToJoinBubble] :: Error when joining a bubble"),reject(err)}))}))}},{key:"declineInvitationToJoinBubble",value:function(bubble){var _this12=this,roomService=bubblesService_roomService.get(this),$log=bubblesService_$log.get(this),SDK=bubblesService_SDK.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){if(!bubble)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});roomService.declineRoomInvitation(bubble).then((function(updatedBubble){return resolve(updatedBubble)})).catch((function(err){return $log.sdk(_this12.logService+"[declineInvitationToJoinBubble] :: Error when joining a bubble"),reject(err)}))}))}},{key:"leaveBubble",value:function(bubble){var _this13=this,roomService=bubblesService_roomService.get(this),$log=bubblesService_$log.get(this),SDK=bubblesService_SDK.get(this),contactService=bubblesService_contactService.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){if(!bubble)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});var hasOtherModerator=!1;if(bubble.users.forEach((function(user){contactService.isUserContact(user)||"moderator"===user.privilege&&"accepted"===user.status&&(hasOtherModerator=!0)})),!hasOtherModerator)return reject({code:SDK.ERRORBADREQUEST,label:"Can't leave the bubble. No other moderator"});switch(bubble.status){case roomService.RoomUserStatus.UNSUBSCRIBED:roomService.participantCloseRoom(bubble).then((function(updatedBubble){return resolve(updatedBubble)})).catch((function(err){return $log.sdk(_this13.logService+"[leaveBubble] :: Error when leaving a bubble"),reject(err)}));break;default:roomService.unsubscribeMeFromRoom(bubble).then((function(updatedBubble){return resolve(updatedBubble)})).catch((function(err){return $log.sdk(_this13.logService+"[leaveBubble] :: Error when leaving a bubble"),reject(err)}))}}))}},{key:"closeBubble",value:function(bubble){var _this14=this,roomService=bubblesService_roomService.get(this),$log=bubblesService_$log.get(this),SDK=bubblesService_SDK.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){return bubble?_this14.isBubbleArchived(bubble)?resolve(bubble):void roomService.ownerArchiveRoom(bubble).then((function(updatedBubble){return resolve(updatedBubble)})).catch((function(err){return $log.sdk(_this14.logService+"[closeBubble] :: Error when closing a bubble"),reject(err)})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"})}))}},{key:"isBubbleArchived",value:function(bubble){var isArchived=!0,roomService=bubblesService_roomService.get(this);return(bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null)?bubble.status!==roomService.RoomUserStatus.UNSUBSCRIBED?isArchived=!1:bubble.users.forEach((function(user){user.status!==roomService.RoomUserStatus.UNSUBSCRIBED&&user.status!==roomService.RoomUserStatus.DELETED&&(isArchived=!1)})):isArchived=!1,isArchived}},{key:"getAllBubbles",value:function(){return bubblesService_roomService.get(this).getRooms()}},{key:"getAllOwnedBubbles",value:function(){return bubblesService_roomService.get(this).getMyRooms()}},{key:"getAllPendingBubbles",value:function(){return bubblesService_roomService.get(this).getRooms().filter((function(bubble){return"invited"===bubble.status}))}},{key:"getAllInactiveBubbles",value:function(){return bubblesService_roomService.get(this).getRooms().filter((function(bubble){return!1===bubble.isActive}))}},{key:"getBubbleById",value:function(strBubbleId){var roomService=bubblesService_roomService.get(this),SDK=bubblesService_SDK.get(this);return strBubbleId?roomService.getRoomById(strBubbleId):{code:SDK.ERRORBADREQUEST,label:"Parameter 'strBubbleId' is missing or empty"}}},{key:"updateDescriptionForBubble",value:function(strDescription,bubble){var roomService=bubblesService_roomService.get(this),SDK=bubblesService_SDK.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){return strDescription?bubble?(bubble.desc=strDescription,void roomService.ownerUpdateRoom(bubble).then((function(updatedBubble){return resolve(updatedBubble)})).catch((function(err){return reject(err)}))):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strDescription' is missing or empty"})}))}},{key:"updateAvatarForBubble",value:function(urlAvatar,bubble){var roomService=bubblesService_roomService.get(this),SDK=bubblesService_SDK.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){return urlAvatar?bubble?(bubble.id=bubble.dbId,void roomService.setAvatarRoom(bubble,urlAvatar).then((function(updatedBubble){return resolve(updatedBubble)})).catch((function(err){return reject(err)}))):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'urlAvatar' is missing or empty"})}))}},{key:"deleteAvatarFromBubble",value:function(bubble){var roomService=bubblesService_roomService.get(this),SDK=bubblesService_SDK.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){if(!bubble)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"});roomService.deleteAvatarRoom(bubble.dbId).then((function(updatedBubble){return resolve(updatedBubble)})).catch((function(err){return reject(err)}))}))}},{key:"updateCustomDataForBubble",value:function(customData,bubble){var roomService=bubblesService_roomService.get(this),SDK=bubblesService_SDK.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){return customData?bubble?(bubble.customData=customData,void roomService.ownerUpdateRoomCustomData(bubble).then((function(updatedCustomData){return bubble.customData=updatedCustomData,resolve(bubble)})).catch((function(err){return reject(err)}))):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'customData' is missing or empty"})}))}},{key:"deleteCustomDataForBubble",value:function(bubble){var roomService=bubblesService_roomService.get(this),SDK=bubblesService_SDK.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){if(!bubble)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"});bubble.customData={},roomService.ownerUpdateRoomCustomData(bubble).then((function(updatedCustomData){return bubble.customData=updatedCustomData,resolve(bubble)})).catch((function(err){return reject(err)}))}))}},{key:"isWebRtcConferenceAllowed",value:function(){var profileService=bubblesService_profileService.get(this);return profileService.isFeatureEnabled(profileService.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED)}},{key:"hasActiveConferenceSession",value:function(){return!!bubblesService_webConferenceService.get(this).hasActiveConferenceSession()}},{key:"getWebRtcConferenceBubble",value:function(){return bubblesService_webConferenceService.get(this).getRelatedRoomToActiveConferenceSession()}},{key:"startOrJoinWebRtcConference",value:function(bubble){var _this15=this,roomService=bubblesService_roomService.get(this),webConferenceService=bubblesService_webConferenceService.get(this),SDK=bubblesService_SDK.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){return bubble?_this15.hasActiveConferenceSession()?reject({code:SDK.ERROR,label:"Already in a conference"}):void webConferenceService.startOrJoinWebConference(bubble).then((function(){return _this15.confBubble=bubble,_this15.confBubbleType="webrtc",resolve(roomService.getRoomById(bubble.dbId))})).catch((function(err){return reject(err)})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"})}))}},{key:"addMediaToConferenceSession",value:function(conferenceSession){var SDK=bubblesService_SDK.get(this),webConferenceService=bubblesService_webConferenceService.get(this);return conferenceSession?webConferenceService.addMediaToConferenceSession(conferenceSession,"video"):{code:SDK.ERROR,label:"Parameter 'conferenceSession' is missing or empty"}}},{key:"addSharingToConferenceSession",value:function(conferenceSession){var SDK=bubblesService_SDK.get(this),webConferenceService=bubblesService_webConferenceService.get(this);return conferenceSession?webConferenceService.addMediaToConferenceSession(conferenceSession,"sharing"):{code:SDK.ERROR,label:"Parameter 'conferenceSession' is missing or empty"}}},{key:"removeMediaFromConferenceSession",value:function(conferenceSession){var SDK=bubblesService_SDK.get(this),webConferenceService=bubblesService_webConferenceService.get(this);return conferenceSession?(webConferenceService.removeMediaFromConferenceSession(conferenceSession,"video"),conferenceSession):{code:SDK.ERROR,label:"Parameter 'conferenceSession' is missing or empty"}}},{key:"removeSharingFromConferenceSession",value:function(conferenceSession){var SDK=bubblesService_SDK.get(this),webConferenceService=bubblesService_webConferenceService.get(this);return conferenceSession?(webConferenceService.removeMediaFromConferenceSession(conferenceSession,"sharing"),conferenceSession):{code:SDK.ERROR,label:"Parameter 'conferenceSession' is missing or empty"}}},{key:"addLocalVideoStreamToConference",value:function(conferenceSession){var SDK=bubblesService_SDK.get(this),webConferenceService=bubblesService_webConferenceService.get(this);return conferenceSession?(webConferenceService.attachLocalMediaStream(!0,conferenceSession),conferenceSession):{code:SDK.ERROR,label:"Parameter 'conferenceSession' is missing or empty"}}},{key:"showLocalVideo",value:function(){var SDK=bubblesService_SDK.get(this);return bubblesService_videoService.get(this).attachLocalMediaStream(!0),{code:SDK.OK,label:"OK"}}},{key:"getConferenceSessionById",value:function(conferenceId){var SDK=bubblesService_SDK.get(this),webConferenceService=bubblesService_webConferenceService.get(this);return conferenceId?webConferenceService.getConferenceSessionById(conferenceId):{code:SDK.ERROR,label:"Parameter 'conferenceId' is missing or empty"}}},{key:"addDistantVideoStreamToConference",value:function(conferenceSession){var SDK=bubblesService_SDK.get(this),webConferenceService=bubblesService_webConferenceService.get(this);return conferenceSession?(webConferenceService.attachDistantMediaStream(!0,conferenceSession),conferenceSession):{code:SDK.ERROR,label:"Parameter 'conferenceSession' is missing or empty"}}},{key:"updateMainVideoSession",value:function(conferenceId,sessionId){var SDK=bubblesService_SDK.get(this),webConferenceService=bubblesService_webConferenceService.get(this);return new Promise((function(__resolve,reject){return conferenceId?sessionId?(webConferenceService.updateMainScreenSession(conferenceId,sessionId),webConferenceService.getConferenceSessionById(conferenceId)):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'sessionId' is missing or empty"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conferenceId' is missing or empty"})}))}},{key:"startOrJoinSharingWebRtcConference",value:function(bubble){var _this16=this,SDK=bubblesService_SDK.get(this),webConferenceService=bubblesService_webConferenceService.get(this),roomService=bubblesService_roomService.get(this);return bubble=bubble&&bubble.dbId?roomService.getRoomById(bubble.dbId):null,new Promise((function(resolve,reject){return bubble?_this16.hasActiveConferenceSession()?reject({code:SDK.ERROR,label:"Already in a conference"}):void webConferenceService.startOrJoinSharingOnlyConference(bubble).then((function(){return _this16.confBubble=bubble,_this16.confBubbleType="sharing",resolve(roomService.getRoomById(bubble.dbId))})).catch((function(err){return reject(err)})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or empty"})}))}},{key:"stopWebRtcConference",value:function(){var _this17=this,roomService=bubblesService_roomService.get(this),SDK=bubblesService_SDK.get(this),webConferenceService=bubblesService_webConferenceService.get(this),conferenceService=bubblesService_conferenceService.get(this),contactService=bubblesService_contactService.get(this);return this.confBubble=this.confBubble&&this.confBubble.dbId?roomService.getRoomById(this.confBubble.dbId):null,new Promise((function(resolve,reject){if(!_this17.hasActiveConferenceSession()||!_this17.confBubble)return reject({code:SDK.ERRORBADREQUEST,label:"No known conference in a Bubble"});var id="";id="webrtc"===_this17.confBubbleType?_this17.confBubble.getSFUConfEndpointId():_this17.confBubble.getSFUSharingConfEndpointId();var sharingConfSession=webConferenceService.getConferenceSessionById(id),participant=sharingConfSession?sharingConfSession.getParticipantByJid(contactService.userContact.jid):null;"moderator"!==participant.role?conferenceService.disconnectsParticipant(id,participant.participantId,_this17.confBubbleType).then((function(){return _this17.confBubble=null,_this17.confBubbleType=null,resolve()})).catch((function(err){return reject(err)})):conferenceService.stopConference(id,_this17.confBubbleType,_this17.confBubble.dbId).then((function(){return _this17.confBubble=null,_this17.confBubbleType=null,resolve()})).catch((function(err){return reject(err)}))}))}}]),BubblesService}();function groupsService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function groupsService_createClass(Constructor,protoProps,staticProps){return protoProps&&groupsService_defineProperties(Constructor.prototype,protoProps),staticProps&&groupsService_defineProperties(Constructor,staticProps),Constructor}var groupsService_$rootScope=new WeakMap,groupsService_$log=new WeakMap,groupsService_groupService=new WeakMap,_Group=new WeakMap,groupsService_contactService=new WeakMap,groupsService_PromiseQueue=new WeakMap,groupsService_SDK=new WeakMap,GroupsService=function(){function GroupsService($log,groupService,Group,contactService,PromiseQueue,SDK,$rootScope){var _this=this;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,GroupsService),groupsService_$log.set(this,$log),groupsService_groupService.set(this,groupService),_Group.set(this,Group),groupsService_contactService.set(this,contactService),groupsService_PromiseQueue.set(this,PromiseQueue),groupsService_SDK.set(this,SDK),groupsService_$rootScope.set(this,$rootScope),this.logService="GroupService  | ",this.RAINBOW_ONGROUPCREATED="rainbowgroupcreated",this.RAINBOW_ONGROUPUPDATED="rainbowgroupupdated",this.RAINBOW_ONGROUPDELETED="rainbowgroupdeleted",this.RAINBOW_ONGROUPUSERADDED="rainbowgroupuseradded",this.RAINBOW_ONGROUPUSERREMOVED="rainbowgroupuserdeleted",this.createGroup=this.createGroup.bind(this),this.deleteGroup=this.deleteGroup.bind(this),this.deleteAllGroups=this.deleteAllGroups.bind(this),this.getAll=this.getAll.bind(this),this.getFavoritesGroups=this.getFavoritesGroups.bind(this),this.setGroupAsFavorite=this.setGroupAsFavorite.bind(this),this.unsetGroupAsFavorite=this.unsetGroupAsFavorite.bind(this),this.getGroupById=this.getGroupById.bind(this),this.getDetailedGroupById=this.getDetailedGroupById.bind(this),this.addContactInGroup=this.addContactInGroup.bind(this),this.removeContactFromGroup=this.removeContactFromGroup.bind(this),$rootScope.$on("$destroy",$rootScope.$on(groupService.ON_UPDATE_GROUP_EVENT,(function(event,groupId){return _this.onGroupUpdated(event,groupId)}))),$rootScope.$on("$destroy",$rootScope.$on(groupService.ON_CREATED_GROUP_EVENT,(function(event,groupId){return _this.onGroupCreated(event,groupId)}))),$rootScope.$on("$destroy",$rootScope.$on(groupService.ON_REMOVED_GROUP_EVENT,(function(event,groupId){return _this.onGroupDeleted(event,groupId)}))),$rootScope.$on("$destroy",$rootScope.$on(groupService.ON_ADD_GROUP_USER_EVENT,(function(event,groupId,userId){return _this.onGroupUserAdded(event,groupId,userId)}))),$rootScope.$on("$destroy",$rootScope.$on(groupService.ON_REMOVE_GROUP_USER_EVENT,(function(event,groupId,userId){return _this.onGroupUserRemoved(event,groupId,userId)})))}return groupsService_createClass(GroupsService,null,[{key:"$inject",get:function(){return["$log","groupService","Group","contactService","PromiseQueue","SDK","$rootScope"]}}]),groupsService_createClass(GroupsService,[{key:"onGroupUpdated",value:function(__event,groupId){var _this2=this;groupsService_groupService.get(this).getGroup(groupId).then((function(group){var sdkEvent=new CustomEvent(_this2.RAINBOW_ONGROUPUPDATED,{detail:group});document.dispatchEvent(sdkEvent)})).catch((function(err){return err}))}},{key:"onGroupCreated",value:function(__event,groupId){var _this3=this;groupsService_groupService.get(this).getGroup(groupId).then((function(group){var sdkEvent=new CustomEvent(_this3.RAINBOW_ONGROUPCREATED,{detail:group});document.dispatchEvent(sdkEvent)})).catch((function(err){return err}))}},{key:"onGroupDeleted",value:function(__event,groupId){var sdkEvent=new CustomEvent(this.RAINBOW_ONGROUPDELETED,{detail:groupId});document.dispatchEvent(sdkEvent)}},{key:"onGroupUserAdded",value:function(__event,groupId,userId){var _this4=this;groupsService_groupService.get(this).getGroup(groupId).then((function(group){var sdkEvent=new CustomEvent(_this4.RAINBOW_ONGROUPUSERADDED,{detail:{group:group,userId:userId}});document.dispatchEvent(sdkEvent)})).catch((function(err){return err}))}},{key:"onGroupUserRemoved",value:function(__event,groupId,userId){var _this5=this;groupsService_groupService.get(this).getGroup(groupId).then((function(group){var sdkEvent=new CustomEvent(_this5.RAINBOW_ONGROUPUSERREMOVED,{detail:{group:group,userId:userId}});document.dispatchEvent(sdkEvent)})).catch((function(err){return err}))}},{key:"createGroup",value:function(strName,strDescription,isFavorite){var _this6=this,Group=_Group.get(this),$log=groupsService_$log.get(this),groupService=groupsService_groupService.get(this),SDK=groupsService_SDK.get(this);return new Promise((function(resolve,reject){var group,comment=strDescription||"",boolFavorite=!1;if("boolean"==typeof isFavorite&&(boolFavorite=isFavorite),!strName)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'strName' is missing or empty"});group=new Group(null,strName,comment,boolFavorite),groupService.addGroup(group).then((function(newGroup){return $log.sdk(_this6.logService+"[createGroup] :: New group created successfully"),resolve(newGroup)})).catch((function(err){return $log.sdk(_this6.logService+"[createGroup] :: Error when creating a group"),reject(err)}))}))}},{key:"deleteGroup",value:function(group){var _this7=this,$log=groupsService_$log.get(this),groupService=groupsService_groupService.get(this),SDK=groupsService_SDK.get(this);return new Promise((function(resolve,reject){if(!group)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'group' is missing or empty"});groupService.removeGroup(group.id).then((function(){return $log.sdk(_this7.logService+"[deleteGroup] :: Group deleted successfully"),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return $log.sdk(_this7.logService+"[deleteGroup] :: Error when deleting a group"),reject(err)}))}))}},{key:"deleteAllGroups",value:function(){var _this8=this,$log=groupsService_$log.get(this),groupService=groupsService_groupService.get(this),SDK=groupsService_SDK.get(this);return new Promise((function(resolve,reject){var promiseQueue=[],groups=groupService.getGroupsAsArray();groups.forEach((function(group){promiseQueue.push(function(group){return groupService.removeGroup(group.id)}(group))})),Promise.all(promiseQueue).then((function(){return $log.sdk(_this8.logService+"[deleteAllGroups] :: All groups deleted successfully"),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return $log.sdk(_this8.logService+"[deleteAllGroups] :: Error when deleting all groups"),reject(err)}))}))}},{key:"getAll",value:function(){return groupsService_groupService.get(this).getGroupsAsArray()}},{key:"getFavoritesGroups",value:function(){return groupsService_groupService.get(this).getGroupsAsArray().filter((function(group){return group.isFavorite}))}},{key:"setGroupAsFavorite",value:function(group){var groupService=groupsService_groupService.get(this);return new Promise((function(resolve,reject){group.isFavorite=!0,groupService.updateGroup(group).then((function(){return resolve(group)})).catch((function(err){return reject(err)}))}))}},{key:"unsetGroupAsFavorite",value:function(group){var groupService=groupsService_groupService.get(this);return new Promise((function(resolve,reject){group.isFavorite=!1,groupService.updateGroup(group).then((function(){return resolve(group)})).catch((function(err){return reject(err)}))}))}},{key:"getGroupById",value:function(groupId){var groupService=groupsService_groupService.get(this),theGroup=null;return groupService.getGroupsAsArray().some((function(group){return groupId===group.id&&(theGroup=group,!0)})),theGroup}},{key:"getDetailedGroupById",value:function(id){var groupService=groupsService_groupService.get(this),SDK=groupsService_SDK.get(this);return new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});groupService.getGroup(id).then((function(updatedGroup){return resolve(updatedGroup)})).catch((function(err){return reject(err)}))}))}},{key:"addContactInGroup",value:function(contact,group){var _this9=this,SDK=groupsService_SDK.get(this),groupService=groupsService_groupService.get(this),$log=groupsService_$log.get(this);return new Promise((function(resolve,reject){return contact?group?void groupService.addGroupUser(group,contact).then((function(updatedGroup){return $log.sdk(_this9.logService+"[addContactInGroup] :: Contact added successfully"),resolve(updatedGroup)})).catch((function(err){return $log.sdk(_this9.logService+"[addContactInGroup] :: Error when adding a contact in a group"),reject(err)})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'group' is missing or null"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"})}))}},{key:"removeContactFromGroup",value:function(contact,group){var SDK=groupsService_SDK.get(this),groupService=groupsService_groupService.get(this);return new Promise((function(resolve,reject){return contact?group?resolve(groupService.removeGroupUser(group.id,contact)):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'group' is missing or null"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"})}))}}]),GroupsService}();function callsLogService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function callsLogService_createClass(Constructor,protoProps,staticProps){return protoProps&&callsLogService_defineProperties(Constructor.prototype,protoProps),staticProps&&callsLogService_defineProperties(Constructor,staticProps),Constructor}var callsLogService_callLogService=new WeakMap,CallsLogService=function(){function CallsLogService($rootScope,callLogService){var _this=this;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,CallsLogService),this.logService="CallsLogService | ",this.initialized=!1,callsLogService_callLogService.set(this,callLogService),this.RAINBOW_ONCALLLOGUPDATED="rainbowcalllogupdated",this.RAINBOW_ONCALLLOGACKUPDATED="rainbowcalllogackupdated",this.getAll=this.getAll.bind(this),this.getMissedCallLogCounter=this.getMissedCallLogCounter.bind(this),this.deleteOneCallLog=this.deleteOneCallLog.bind(this),this.deleteCallLogsForContact=this.deleteCallLogsForContact.bind(this),this.deleteAllCallLogs=this.deleteAllCallLogs.bind(this),this.markCallLogAsRead=this.markCallLogAsRead.bind(this),this.markAllCallsLogsAsRead=this.markAllCallsLogsAsRead.bind(this),this.isInitialized=this.isInitialized.bind(this),$rootScope.$on("$destroy",$rootScope.$on("ON_CALL_LOG_UPDATED",(function(event,data){return _this.onCallLogUpdated(event,data)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_CALL_LOG_ACK_UPDATED",(function(event,data){return _this.onCallLogAckUpdated(event,data)})))}return callsLogService_createClass(CallsLogService,null,[{key:"$inject",get:function(){return["$rootScope","callLogService"]}}]),callsLogService_createClass(CallsLogService,[{key:"onCallLogUpdated",value:function(__event,data){var sdkEvent=new CustomEvent(this.RAINBOW_ONCALLLOGUPDATED,{detail:data});document.dispatchEvent(sdkEvent)}},{key:"onCallLogAckUpdated",value:function(__event,data){var sdkEvent=new CustomEvent(this.RAINBOW_ONCALLLOGACKUPDATED,{detail:data});document.dispatchEvent(sdkEvent)}},{key:"getAll",value:function(){var callLogService=callsLogService_callLogService.get(this);callLogService.orderCallLogsFunction();for(var callLogs=callLogService.getSimplifiedCallLogs(),i=0;i<callLogs.length;i++){var durationMs=0,hmmss=callLogs[i].duration;if(hmmss&&"string"==typeof hmmss&&hmmss.match(/^(?:(?:([01]?\d|2[0-3])h )?([0-5]?\d)m )?([0-5]?\ds)$/)){for(var parts=(hmmss=hmmss.replace(/[hms]/g,"")).split(" ").reverse(),j=0;j<parts.length;j++)durationMs+=parts[j]*Math.pow(60,j);callLogs[i].duration=1e3*durationMs}}return callLogs}},{key:"getMissedCallLogCounter",value:function(){return callsLogService_callLogService.get(this).getMissedCallLogCounter()}},{key:"deleteOneCallLog",value:function(id){return callsLogService_callLogService.get(this).deleteOneCallLog(id)}},{key:"deleteCallLogsForContact",value:function(jid){return callsLogService_callLogService.get(this).deleteCallLogsForContact(jid)}},{key:"deleteAllCallLogs",value:function(){return callsLogService_callLogService.get(this).deleteAllCallLogs()}},{key:"markCallLogAsRead",value:function(id){return callsLogService_callLogService.get(this).markCallLogAsRead(id)}},{key:"markAllCallsLogsAsRead",value:function(){return callsLogService_callLogService.get(this).markAllCallsLogsAsRead()}},{key:"isInitialized",value:function(){return this.initialized}}]),CallsLogService}();function favoritesService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function favoritesService_createClass(Constructor,protoProps,staticProps){return protoProps&&favoritesService_defineProperties(Constructor.prototype,protoProps),staticProps&&favoritesService_defineProperties(Constructor,staticProps),Constructor}var favoritesService_favoriteService=new WeakMap,favoritesService_$log=new WeakMap,FavoritesService=function(){function FavoritesService($log,favoriteService){var _this=this;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,FavoritesService),favoritesService_favoriteService.set(this,favoriteService),favoritesService_$log.set(this,$log),this.logService="FavoritesService | ",this.RAINBOW_ONFAVORITECREATED="rainbowonfavoritecreated",this.RAINBOW_ONFAVORITEDELETED="rainbowonfavoritedeleted",this.fetchAllFavorites=this.fetchAllFavorites.bind(this),this.createFavorite=this.createFavorite.bind(this),this.deleteFavorite=this.deleteFavorite.bind(this),window.addEventListener("ON_FAVORITE_CREATED",(function(event){return _this.onFavoriteCreated(event)})),window.addEventListener("ON_FAVORITE_DELETED",(function(event){return _this.onFavoriteDeleted(event)}))}return favoritesService_createClass(FavoritesService,null,[{key:"$inject",get:function(){return["$log","favoriteService"]}}]),favoritesService_createClass(FavoritesService,[{key:"onFavoriteCreated",value:function(event){var sdkEvent=new CustomEvent(this.RAINBOW_ONFAVORITECREATED,{detail:event.detail});document.dispatchEvent(sdkEvent)}},{key:"onFavoriteDeleted",value:function(event){var sdkEvent=new CustomEvent(this.RAINBOW_ONFAVORITEDELETED,{detail:event.detail});document.dispatchEvent(sdkEvent)}},{key:"fetchAllFavorites",value:function(){var _this2=this,$log=favoritesService_$log.get(this),favoriteService=favoritesService_favoriteService.get(this);return new Promise((function(resolve,reject){var that=_this2;favoriteService.getServerFavorites().then((function(favorites){return $log.sdk(that.logService+"[fetchAllFavorites] :: Successfully fetched the Favorites"),resolve(favorites)})).catch((function(err){return $log.sdk(that.logService+"[fetchAllFavorites] :: ERROR:",err),reject(err)}))}))}},{key:"createFavorite",value:function(id,type){var _this3=this,favoriteService=favoritesService_favoriteService.get(this),$log=favoritesService_$log.get(this);return new Promise((function(resolve,reject){return id?type?"bubble"!==type&&"user"!==type?($log.sdk(_this3.logService+'[createFavorite] :: Error: type should be set to "user" or "bubble"'),reject(_this3.logService+'[createFavorite] :: Error: type should be set to "user" or "bubble"')):("bubble"===type&&(type="room"),void favoriteService.addServerFavorite(id,type).then((function(favorite){return $log.sdk(_this3.logService+"[createFavorite] :: Successfully added ".concat(type," to favorites")),resolve(favorite)})).catch((function(err){return $log.sdk(_this3.logService+"[createFavorite] :: Error: "+err),reject(err)}))):($log.sdk(_this3.logService+"[createFavorite] :: Error: parameter 'type' is missing or null"),reject(_this3.logService+"[createFavorite] :: Error: parameter 'type' is missing or null")):($log.sdk(_this3.logService+"[createFavorite] :: Error: parameter 'id' is missing or null"),reject(_this3.logService+"[createFavorite] :: Error: parameter 'id' is missing or null"))}))}},{key:"deleteFavorite",value:function(id){var _this4=this,favoriteService=favoritesService_favoriteService.get(this),$log=favoritesService_$log.get(this);return new Promise((function(resolve,reject){if(!id)return $log.sdk(_this4.logService+"[deleteFavorite] :: Error: parameter 'id' is missing or null"),reject(_this4.logService+"[deleteFavorite] :: Error: parameter 'id' is missing or null");favoriteService.removeServerFavorite(id).then((function(){return resolve()})).catch((function(err){return $log.sdk(_this4.logService+"[deleteFavorite] :: Error: "+err),reject(err)}))}))}}]),FavoritesService}();function filesStorageService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function filesStorageService_createClass(Constructor,protoProps,staticProps){return protoProps&&filesStorageService_defineProperties(Constructor.prototype,protoProps),staticProps&&filesStorageService_defineProperties(Constructor,staticProps),Constructor}var filesStorageService_$rootScope=new WeakMap,filesStorageService_$log=new WeakMap,filesStorageService_Conversation=new WeakMap,filesStorageService_fileStorageService=new WeakMap,filesStorageService_fileServerService=new WeakMap,filesStorageService_conversationService=new WeakMap,filesStorageService_contactService=new WeakMap,filesStorageService_SDK=new WeakMap,FilesStorageService=function(){function FilesStorageService($log,Conversation,fileStorageService,fileServerService,conversationService,contactService,SDK,$rootScope){var _this=this;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,FilesStorageService),filesStorageService_$log.set(this,$log),filesStorageService_Conversation.set(this,Conversation),filesStorageService_fileStorageService.set(this,fileStorageService),filesStorageService_fileServerService.set(this,fileServerService),filesStorageService_conversationService.set(this,conversationService),filesStorageService_contactService.set(this,contactService),filesStorageService_SDK.set(this,SDK),filesStorageService_$rootScope.set(this,$rootScope),this.logService="FilesStorageService | ",this.RAINBOW_ONFILEUPLOADED="rainbowfileuploaded",this.RAINBOW_ONFILEUPLOADED_ERROR="rainbowfileuploadederror",this.RAINBOW_ONFILEDOWNLOADED="rainbowonfiledownloaded",this.RAINBOW_ONFILEDOWNLOADED_ERROR="rainbowfiledownloadederror",this.RAINBOW_ONCHUNKLOADMESSAGE="rainbowonchunkloadmessage",this.eventsMap={success:{download:this.RAINBOW_ONFILEDOWNLOADED,upload:this.RAINBOW_ONFILEUPLOADED},error:{download:this.RAINBOW_ONFILEDOWNLOADED_ERROR,upload:this.RAINBOW_ONFILEUPLOADED_ERROR}},this.uploadFileToConversation=this.uploadFileToConversation.bind(this),this.uploadFileToBubble=this.uploadFileToBubble.bind(this),this.downloadFile=this.downloadFile.bind(this),this.removeFile=this.removeFile.bind(this),this.getFileDescriptorFromId=this.getFileDescriptorFromId.bind(this),this.getFilesReceivedInConversation=this.getFilesReceivedInConversation.bind(this),this.getFilesReceivedInBubble=this.getFilesReceivedInBubble.bind(this),this.getFilesSentInConversation=this.getFilesSentInConversation.bind(this),this.getFilesSentInBubble=this.getFilesSentInBubble.bind(this),this.getUserQuotaConsumption=this.getUserQuotaConsumption.bind(this),this.getAllFilesSent=this.getAllFilesSent.bind(this),this.getAllFilesReceived=this.getAllFilesReceived.bind(this),this.cancelCurrentFileTransfer=this.cancelCurrentFileTransfer.bind(this),$rootScope.$on("$destroy",$rootScope.$on("ON_FILE_TRANSFER_EVENT",(function(event,data){return _this.onFileTransferChanged(event,data)})))}return filesStorageService_createClass(FilesStorageService,null,[{key:"inject",get:function(){return["$log","Conversation","fileStorageService","fileServerService","conversationService","contactService","SDK","$rootScope"]}}]),filesStorageService_createClass(FilesStorageService,[{key:"onFileTransferChanged",value:function(__event,data){var $log=filesStorageService_$log.get(this);if(data.result&&data.type){$log.sdk(this.logService+"[onFileTransferChanged] ::  File transfered");var sdkEvent=new CustomEvent(this.eventsMap[data.result][data.type],{detail:data});document.dispatchEvent(sdkEvent)}else if("uploading"===(data=data.fileDesc).state||"downloading"===data.state){var _sdkEvent=new CustomEvent(this.RAINBOW_ONCHUNKLOADMESSAGE,{detail:data});document.dispatchEvent(_sdkEvent)}}},{key:"uploadFileToConversation",value:function(conversation,file,message){var _this2=this,SDK=filesStorageService_SDK.get(this),$log=filesStorageService_$log.get(this),Conversation=filesStorageService_Conversation.get(this),conversationService=filesStorageService_conversationService.get(this);return new Promise((function(resolve,reject){return conversation?file?conversation.type!==Conversation.Type.ONE_TO_ONE?reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):($log.sdk(_this2.logService+"[uploadFileToConversation] ::  Add file to the conversation "+conversation.id),void conversationService.sendFSMessage(conversation,file,message).then((function(fileMessage){return resolve(fileMessage)})).catch((function(err){return reject(err)}))):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'file' is missing or null"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})}))}},{key:"uploadFileToBubble",value:function(bubble,file,message){var _this3=this,SDK=filesStorageService_SDK.get(this),$log=filesStorageService_$log.get(this),Conversation=filesStorageService_Conversation.get(this),conversationService=filesStorageService_conversationService.get(this);return new Promise((function(resolve,reject){if(!bubble)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});if(!file)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'file' is missing or null"});var conversation=conversationService.getConversationByRoomDbId(bubble.dbId);return conversation?conversation.type!==Conversation.Type.ROOM?reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is not a bubble conversation"}):($log.sdk(_this3.logService+"[uploadFileToBubble] ::  Trying to add a file to the bubble "+bubble.dbId),void conversationService.sendFSMessage(conversation,file,message).then((function(fileMessage){return resolve(fileMessage)})).catch((function(err){return reject(err)}))):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' don't have a conversation"})}))}},{key:"downloadFile",value:function(fileDescriptor){var _this4=this,$log=filesStorageService_$log.get(this),fileServerService=filesStorageService_fileServerService.get(this),SDK=filesStorageService_SDK.get(this);return new Promise((function(resolve,reject){if(!fileDescriptor)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'fileDescriptor' is missing or null"});$log.sdk(_this4.logService+"[downloadFile] ::  Trying to get a file"),fileServerService.getBlobFromFileDescriptor(fileDescriptor,!0).then((function(blob){return $log.sdk(_this4.logService+"[downloadFile] ::  File downloaded"),resolve(blob)})).catch((function(err){return reject(err)}))}))}},{key:"removeFile",value:function(fileDescriptor){var _this5=this,$log=filesStorageService_$log.get(this),fileStorageService=filesStorageService_fileStorageService.get(this),SDK=filesStorageService_SDK.get(this);return new Promise((function(resolve,reject){if(fileDescriptor||reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'fileDescriptor' is missing or null"}),fileDescriptor.id||fileDescriptor.url){$log.sdk(_this5.logService+"[removeFile] ::  Trying to remove a file");var fileDescriptorId=fileDescriptor.id;if(!fileDescriptorId){var parts=fileDescriptor.url.split("/");fileDescriptorId=parts.pop()||parts.pop()}fileStorageService.deleteFileDescriptor(fileDescriptorId).then((function(){$log.sdk(_this5.logService+"[removeFile] ::  File removed"),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){reject(err)}))}else reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'fileDescriptor' don't contain information to remove the file"})}))}},{key:"getFileDescriptorFromId",value:function(id){var $log=filesStorageService_$log.get(this),fileStorageService=filesStorageService_fileStorageService.get(this);return $log.sdk(this.logService+"[getFileDescriptorFromId] ::  Get file descriptor "+id),fileStorageService.getFileDescriptorById(id)}},{key:"getFilesReceivedInConversation",value:function(conversation){var _this6=this,$log=filesStorageService_$log.get(this),fileStorageService=filesStorageService_fileStorageService.get(this),SDK=filesStorageService_SDK.get(this),Conversation=filesStorageService_Conversation.get(this),contactService=filesStorageService_contactService.get(this);return new Promise((function(resolve,reject){return conversation?conversation.type!==Conversation.Type.ONE_TO_ONE?reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):($log.sdk(_this6.logService+"[getFilesReceivedInConversation] ::  Get files received in conversation "+conversation.id+"..."),void fileStorageService.retrieveFilesReceivedFromPeer(contactService.userContact.dbId,conversation.contact.dbId).then((function(files){return $log.sdk(_this6.logService+"[getFilesReceivedInConversation] ::  Shared "+files.length),resolve(files)})).catch((function(err){return reject(err)}))):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})}))}},{key:"getFilesReceivedInBubble",value:function(bubble){var _this7=this,$log=filesStorageService_$log.get(this),fileStorageService=filesStorageService_fileStorageService.get(this),SDK=filesStorageService_SDK.get(this);return new Promise((function(resolve,reject){if(!bubble)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});$log.sdk(_this7.logService+"[getFilesReceivedInBubble] ::  Get files received in bubble "+bubble.dbId),fileStorageService.retrieveReceivedFilesForRoom(bubble.dbId).then((function(files){return $log.sdk(_this7.logService+"[getFilesReceivedInBubble] ::  Shared "+files.length),resolve(files)})).catch((function(err){return reject(err)}))}))}},{key:"getFilesSentInConversation",value:function(conversation){var _this8=this,$log=filesStorageService_$log.get(this),fileStorageService=filesStorageService_fileStorageService.get(this),SDK=filesStorageService_SDK.get(this),Conversation=filesStorageService_Conversation.get(this);return new Promise((function(resolve,reject){return conversation?conversation.type!==Conversation.Type.ONE_TO_ONE?reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is not a one-to-one conversation"}):($log.sdk(_this8.logService+"[getFilesSentInConversation] :: Get files sent in conversation "+conversation.id),void fileStorageService.retrieveSentFiles(conversation.contact.dbId).then((function(files){return $log.sdk(_this8.logService+"[getFilesSentInConversation] :: Shared "+files.length),resolve(files)})).catch((function(err){return reject(err)}))):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"})}))}},{key:"getFilesSentInBubble",value:function(bubble){var _this9=this,$log=filesStorageService_$log.get(this),fileStorageService=filesStorageService_fileStorageService.get(this),SDK=filesStorageService_SDK.get(this);return new Promise((function(resolve,reject){if(!bubble)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'bubble' is missing or null"});$log.sdk(_this9.logService+"[getFilesSentInBubble] :: Get files sent in bubble "+bubble.dbId),fileStorageService.retrieveSentFiles(bubble.dbId).then((function(files){return $log.sdk(_this9.logService+"[getFilesSentInBubble] :: Shared "+files.length),resolve(files)})).catch((function(err){return reject(err)}))}))}},{key:"getUserQuotaConsumption",value:function(){var fileStorageService=filesStorageService_fileStorageService.get(this);return new Promise((function(resolve,reject){fileStorageService.retrieveUserConsumption().then((function(consumptionData){return resolve(consumptionData)})).catch((function(err){return reject(err)}))}))}},{key:"getAllFilesSent",value:function(){return filesStorageService_fileStorageService.get(this).getDocuments()}},{key:"getAllFilesReceived",value:function(){return filesStorageService_fileStorageService.get(this).getReceivedDocuments()}},{key:"cancelCurrentFileTransfer",value:function(id){var SDK=filesStorageService_SDK.get(this),fileStorageService=filesStorageService_fileStorageService.get(this),fileServerService=filesStorageService_fileServerService.get(this);return new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or null"});var fileDescriptor=fileStorageService.getFileDescriptorById(id);return null===fileDescriptor?reject({code:SDK.ERRORBADREQUEST,label:"Could not find a file with the id "+id}):"downloading"!==fileDescriptor.state&&"uploading"!==fileDescriptor.state?reject({code:SDK.ERRORBADREQUEST,label:"File Status is not set to 'downloading' or 'uploading'"}):(fileServerService.cancelCurrentFiletransfer(id),"not_uploaded"!==fileDescriptor.state&&"uploading"!==fileDescriptor.state?(fileDescriptor.state="uploaded",resolve(fileDescriptor)):"not_uploaded"!==fileDescriptor.state&&"uploading"===fileDescriptor.state?(fileDescriptor.state="not_uploaded",resolve(fileDescriptor)):void 0)}))}}]),FilesStorageService}();function capabilitiesService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function capabilitiesService_createClass(Constructor,protoProps,staticProps){return protoProps&&capabilitiesService_defineProperties(Constructor.prototype,protoProps),staticProps&&capabilitiesService_defineProperties(Constructor,staticProps),Constructor}var capabilitiesService_profileService=new WeakMap,CapabilitiesService=function(){function CapabilitiesService(profileService){!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,CapabilitiesService),capabilitiesService_profileService.set(this,profileService),this.getAll=this.getAll.bind(this),this.isFeatureEnabled=this.isFeatureEnabled.bind(this),this.hasS4BExtensionEnabled=this.hasS4BExtensionEnabled.bind(this),this.hasOutlookExtensionEnabled=this.hasOutlookExtensionEnabled.bind(this),this.hasCalendarPresenceEnabled=this.hasCalendarPresenceEnabled.bind(this),this.hasTelephonyBasicCallEnabled=this.hasTelephonyBasicCallEnabled.bind(this),this.hasTelephonySecondCallEnabled=this.hasTelephonySecondCallEnabled.bind(this),this.hasTelephonyTransferCallEnabled=this.hasTelephonyTransferCallEnabled.bind(this),this.hasTelephonyConferenceCallEnabled=this.hasTelephonyConferenceCallEnabled.bind(this),this.hasTelephonyDeflectCallEnabled=this.hasTelephonyDeflectCallEnabled.bind(this),this.hasTelephonyForwardCallEnabled=this.hasTelephonyForwardCallEnabled.bind(this),this.hasTelephonyPhoneBookEnabled=this.hasTelephonyPhoneBookEnabled.bind(this),this.hasTelephonyVoiceMailEnabled=this.hasTelephonyVoiceMailEnabled.bind(this),this.hasWebRTCAudioMobileEnabled=this.hasWebRTCAudioMobileEnabled.bind(this),this.hasWebRTCVideoMobileEnabled=this.hasWebRTCVideoMobileEnabled.bind(this),this.hasBridgeConferenceEnabled=this.hasBridgeConferenceEnabled.bind(this),this.hasBridgeConferenceRecordEnabled=this.hasBridgeConferenceRecordEnabled.bind(this),this.hasBridgeConferenceDialOutEnabled=this.hasBridgeConferenceDialOutEnabled.bind(this),this.maxParticipantsPerBubbleAllowed=this.maxParticipantsPerBubbleAllowed.bind(this),this.maxParticipantsPerBridgeConferenceAllowed=this.maxParticipantsPerBridgeConferenceAllowed.bind(this),this.maxFileStorageQuotaAllowed=this.maxFileStorageQuotaAllowed.bind(this)}return capabilitiesService_createClass(CapabilitiesService,null,[{key:"$inject",get:function(){return["profileService"]}}]),capabilitiesService_createClass(CapabilitiesService,[{key:"getAll",value:function(){return capabilitiesService_profileService.get(this).getMyProfileFeatures()}},{key:"isFeatureEnabled",value:function(featureString){return capabilitiesService_profileService.get(this).isFeatureEnabled(featureString)}},{key:"hasS4BExtensionEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("MS_SKYPE_PLUGIN")}},{key:"hasOutlookExtensionEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("MS_OUTLOOK_PLUGIN")}},{key:"hasCalendarPresenceEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("MSO365_CALENDAR_PRESENCE")}},{key:"hasTelephonyBasicCallEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("TELEPHONY_BASIC_CALL")}},{key:"hasTelephonySecondCallEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("TELEPHONY_SECOND_CALL")}},{key:"hasTelephonyTransferCallEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("TELEPHONY_TRANSFER_CALL")}},{key:"hasTelephonyConferenceCallEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("TELEPHONY_CONFERENCE_CALL")}},{key:"hasTelephonyDeflectCallEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("TELEPHONY_DEFLECT_CALL")}},{key:"hasTelephonyForwardCallEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("TELEPHONY_FORWARD_CALL")}},{key:"hasTelephonyPhoneBookEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("TELEPHONY_PHONE_BOOK")}},{key:"hasTelephonyVoiceMailEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("TELEPHONY_VOICE_MAIL")}},{key:"hasWebRTCAudioMobileEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("WEBRTC_FOR_MOBILE")}},{key:"hasWebRTCVideoMobileEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("WEBRTC_FOR_MOBILE_VIDEO")}},{key:"hasBridgeConferenceEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("CONFERENCE_ALLOWED")}},{key:"hasBridgeConferenceRecordEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("CONFERENCE_RECORDING")}},{key:"hasBridgeConferenceDialOutEnabled",value:function(){return capabilitiesService_profileService.get(this).isFeatureEnabled("CONFERENCE_DIAL_OUT")}},{key:"maxParticipantsPerBubbleAllowed",value:function(){return capabilitiesService_profileService.get(this).getFeatureLimitMax("BUBBLE_PARTICIPANT_COUNT")}},{key:"maxParticipantsPerBridgeConferenceAllowed",value:function(){return capabilitiesService_profileService.get(this).getFeatureLimitMax("CONFERENCE_PARTICIPANT_COUNT")}},{key:"maxFileStorageQuotaAllowed",value:function(){return capabilitiesService_profileService.get(this).getFeatureLimitMax("FILE_SHARING_QUOTA_GB")}}]),CapabilitiesService}();function adminService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function adminService_createClass(Constructor,protoProps,staticProps){return protoProps&&adminService_defineProperties(Constructor.prototype,protoProps),staticProps&&adminService_defineProperties(Constructor,staticProps),Constructor}var _Company=new WeakMap,_User=new WeakMap,adminService_adminCompanyService=new WeakMap,adminService_adminUserService=new WeakMap,AdminService=function(){function AdminService(Company,User,adminCompanyService,adminUserService){!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,AdminService),this.logService="AdminService | ",_Company.set(this,Company),_User.set(this,User),adminService_adminCompanyService.set(this,adminCompanyService),adminService_adminUserService.set(this,adminUserService),this.createEssentialCompany=this.createEssentialCompany.bind(this),this.createCompany=this.createCompany.bind(this),this.removeCompany=this.removeCompany.bind(this),this.createUserForCompany=this.createUserForCompany.bind(this),this.removeUserFromCompany=this.removeUserFromCompany.bind(this),this.fetchUsersByTag=this.fetchUsersByTag.bind(this),this.updateUserTags=this.updateUserTags.bind(this),this.setVisibilityForCompany=this.setVisibilityForCompany.bind(this),this.promoteCompanyToBP=this.promoteCompanyToBP.bind(this)}return adminService_createClass(AdminService,null,[{key:"$inject",get:function(){return["Company","User","adminCompanyService","adminUserService"]}}]),adminService_createClass(AdminService,[{key:"createEssentialCompany",value:function(strName,strCountry){var Company=_Company.get(this),adminCompanyService=adminService_adminCompanyService.get(this);return new Promise((function(resolve,reject){var company=Company.create(null,"");company.name=strName,company.country=strCountry,adminCompanyService.createCompanyEndUser(company).then((function(companyCreated){resolve(companyCreated)})).catch((function(err){reject(err)}))}))}},{key:"createCompany",value:function(strName,strCountry,strState){var Company=_Company.get(this),adminCompanyService=adminService_adminCompanyService.get(this);return new Promise((function(resolve,reject){var company=Company.create(null,"");company.name=strName,company.country=strCountry,strState&&(company.state=strState),company.economicActivityClassification="",adminCompanyService.createCompany(company).then((function(companyCreated){resolve(companyCreated)})).catch((function(err){reject(err)}))}))}},{key:"removeCompany",value:function(company){var adminCompanyService=adminService_adminCompanyService.get(this);return new Promise((function(resolve,reject){adminCompanyService.deleteCompany(company.id).then((function(){resolve(company)})).catch((function(err){reject(err)}))}))}},{key:"createUserForCompany",value:function(strLogin,strFirstName,strLastName,strPassword,company,tags){var User=_User.get(this),adminUserService=adminService_adminUserService.get(this);return new Promise((function(resolve,reject){var user=User.create();user.loginEmail=strLogin,user.firstName=strFirstName,user.lastName=strLastName,user.password=strPassword,user.language="en",user.companyId=company.id,user.adminType="undefined",user.isActive=!0,user.isInitialized=!0,tags&&(user.tags=tags&&Array.isArray(tags)?tags:[tags]),adminUserService.createUser(user).then((function(userCreated){resolve(userCreated)})).catch((function(err){reject(err)}))}))}},{key:"removeUserFromCompany",value:function(user){var adminUserService=adminService_adminUserService.get(this);return new Promise((function(resolve,reject){adminUserService.deleteUser(user).then((function(){resolve(user)})).catch((function(err){reject(err)}))}))}},{key:"fetchUsersByTag",value:function(searchPattern,page,pageSize){var adminUserService=adminService_adminUserService.get(this);return new Promise((function(resolve,reject){page=page||1,pageSize=pageSize||10,adminUserService.getUsers(null,page,pageSize,searchPattern,!1,null,!1,!0).then((function(users){return resolve(users)})).catch((function(err){return reject(err)}))}))}},{key:"updateUserTags",value:function(user,tags){var _this=this,adminUserService=adminService_adminUserService.get(this);return new Promise((function(resolve,reject){return user?user.id?tags instanceof Array!=!0?reject(_this.logService+"[updateUserTags] :: Error: parameter 'tags' must be an array"):tags instanceof Array&&(tags.length<1||tags.length>5)?reject(_this.logService+"[updateUserTags] :: Error: parameter 'tags' must be an array with at least 1 and maximum 5 elements"):(user.tags=tags,void adminUserService.updateUser(user).then((function(){return resolve})).catch((function(err){return reject(err)}))):reject(_this.logService+"[updateUserTags] :: Error: parameter 'user.id' is missing or null"):reject(_this.logService+"[updateUserTags] :: Error: parameter 'user' is missing or null")}))}},{key:"setVisibilityForCompany",value:function(company,visibleByCompany){var adminCompanyService=adminService_adminCompanyService.get(this);return new Promise((function(resolve,reject){adminCompanyService.addVisibility(company.id,visibleByCompany.id).then((function(){resolve(company)})).catch((function(err){reject(err)}))}))}},{key:"promoteCompanyToBP",value:function(company,bpType,applicantNumber){var adminCompanyService=adminService_adminCompanyService.get(this);return new Promise((function(resolve,reject){company.isBP=!0,company.bpType=bpType,company.bpBusinessModel="resell",company.bpApplicantNumber=applicantNumber,company.bpCRDid=applicantNumber,company.supportEmail="rford@sandbox.westworld.com",adminCompanyService.updateCompany(company).then((function(updatedCompany){resolve(updatedCompany)})).catch((function(error){reject(error)}))}))}}]),AdminService}();function channelsService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function channelsService_createClass(Constructor,protoProps,staticProps){return protoProps&&channelsService_defineProperties(Constructor.prototype,protoProps),staticProps&&channelsService_defineProperties(Constructor,staticProps),Constructor}var channelsService_$log=new WeakMap,channelsService_$rootScope=new WeakMap,channelsService_channelService=new WeakMap,channelsService_contactService=new WeakMap,channelsService_SDK=new WeakMap,ChannelsService=function(){function ChannelsService($log,$rootScope,channelService,contactService,SDK){var _this=this;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,ChannelsService),this.logService="ChannelsService | ",channelsService_$log.set(this,$log),channelsService_$rootScope.set(this,$rootScope),channelsService_channelService.set(this,channelService),channelsService_contactService.set(this,contactService),channelsService_SDK.set(this,SDK),this.RAINBOW_ONCHANNELMESSAGERECEIVED="rainbowchannelmessagereceived",this.RAINBOW_ONCHANNELUPDATED="rainbowchannelupdate",this.RAINBOW_ONCHANNELDELETED="rainbowchanneldeleted",this.RAINBOW_ONCHANNELUSERSUPDATED="rainbowchannelusersupdate",this.RAINBOW_ONCHANNELRETRACTMESSAGERECEIVED="rainbowchannelretractmessage",this.RAINBOW_ONCHANNELAVATARUPDATED="rainbowchannelavatarupdate",this.RAINBOW_ONCHANNELUSERSUBSCRIBED="rainbowchannelusersubscribed",this.RAINBOW_ONCHANNELUSERUNSUBSCRIBED="rainbowchanneluserunsubscribed",this.fetchMyChannels=this.fetchMyChannels.bind(this),this.createPublicChannel=this.createPublicChannel.bind(this),this.createClosedChannel=this.createClosedChannel.bind(this),this.deleteChannel=this.deleteChannel.bind(this),this.fetchChannelsByName=this.fetchChannelsByName.bind(this),this.fetchChannelsByTopic=this.fetchChannelsByTopic.bind(this),this.fetchChannelsByCategory=this.fetchChannelsByCategory.bind(this),this.fetchChannel=this.fetchChannel.bind(this),this.createItem=this.createItem.bind(this),this.subscribeToChannelById=this.subscribeToChannelById.bind(this),this.subscribeToChannel=this.subscribeToChannel.bind(this),this.unsubscribeFromChannelById=this.unsubscribeFromChannelById.bind(this),this.unsubscribeFromChannel=this.unsubscribeFromChannel.bind(this),this.updateChannel=this.updateChannel.bind(this),this.updateChannelVisibility=this.updateChannelVisibility.bind(this),this.updateChannelVisibilityToPublic=this.updateChannelVisibilityToPublic.bind(this),this.updateChannelVisibilityToClosed=this.updateChannelVisibilityToClosed.bind(this),this.updateChannelName=this.updateChannelName.bind(this),this.updateChannelTopic=this.updateChannelTopic.bind(this),this.updateChannelCategory=this.updateChannelCategory.bind(this),this.updateChannelAvatar=this.updateChannelAvatar.bind(this),this.deleteChannelAvatar=this.deleteChannelAvatar.bind(this),this.fetchUsers=this.fetchUsers.bind(this),this.deleteAllUsersFromChannel=this.deleteAllUsersFromChannel.bind(this),this.updateChannelUsers=this.updateChannelUsers.bind(this),this.addMembersToChannel=this.addMembersToChannel.bind(this),this.addPublishersToChannel=this.addPublishersToChannel.bind(this),this.addOwnersToChannel=this.addOwnersToChannel.bind(this),this.deleteUsersFromChannel=this.deleteUsersFromChannel.bind(this),this.fetchItems=this.fetchItems.bind(this),this.deleteItem=this.deleteItem.bind(this),$rootScope.$on("$destroy",$rootScope.$on("CHANNEL_MESSAGE_RECEIVED",(function(event,messageType,message){return _this.onMessageReceived(event,messageType,message)}))),$rootScope.$on("$destroy",$rootScope.$on("CHANNEL_UPDATE_EVENT",(function(event,updateType,id){return _this.onChannelUpdated(event,updateType,id)}))),$rootScope.$on("$destroy",$rootScope.$on("CHANNEL_USERS_UPDATE_EVENT",(function(event,id,users){return _this.onChannelUsersUpdated(event,id,users)}))),$rootScope.$on("$destroy",$rootScope.$on("ON_UPDATE_CHANNEL_AVATAR",(function(event,id){return _this.onChannelAvatarUpdated(event,id)}))),$rootScope.$on("$destroy",$rootScope.$on("CHANNEL_USER_SUBSCRIPTION_EVENT",(function(event,type,channelId,userId){return _this.onUserSubscriptionChange(event,type,channelId,userId)})))}return channelsService_createClass(ChannelsService,null,[{key:"$inject",get:function(){return["$log","$rootScope","channelService","contactService","SDK"]}}]),channelsService_createClass(ChannelsService,[{key:"onMessageReceived",value:function(__event,messageType,message){var _this2=this,$log=channelsService_$log.get(this);$log.sdk(this.logService+"[ChannelsService] :: EVENT onMessageReceived"),this.fetchChannel(message.channelId).then((function(channel){if(0===messageType){var sdkEvent=new CustomEvent(_this2.RAINBOW_ONCHANNELMESSAGERECEIVED,{detail:{channel:channel,message:message}});document.dispatchEvent(sdkEvent)}else{$log.sdk(_this2.logService+"[ChannelsService] :: EVENT onMessageReceived - retracted message");var _sdkEvent=new CustomEvent(_this2.RAINBOW_ONCHANNELRETRACTMESSAGERECEIVED,{detail:{channel:channel,message:message}});document.dispatchEvent(_sdkEvent)}}))}},{key:"onChannelUpdated",value:function(__event,updateType,id){var _this3=this;if(channelsService_$log.get(this).sdk(this.logService+"[ChannelsService] :: EVENT: onChannelUpdated("+updateType+") id:"+id),3!==updateType)this.fetchChannel(id).then((function(channel){var sdkEvent=new CustomEvent(_this3.RAINBOW_ONCHANNELUPDATED,{detail:{channel:channel,updateType:updateType}});document.dispatchEvent(sdkEvent)}));else{var sdkEvent=new CustomEvent(this.RAINBOW_ONCHANNELDELETED,{detail:id});document.dispatchEvent(sdkEvent)}}},{key:"onChannelUsersUpdated",value:function(__event,id,users){var _this4=this;channelsService_$log.get(this).sdk(this.logService+"[ChannelsService] :: EVENT onChannelUsersUpdated:"+id),this.fetchChannel(id).then((function(channel){var sdkEvent=new CustomEvent(_this4.RAINBOW_ONCHANNELUSERSUPDATED,{detail:{channel:channel,users:users}});document.dispatchEvent(sdkEvent)}))}},{key:"onChannelAvatarUpdated",value:function(__event,id){var _this5=this,$log=channelsService_$log.get(this);this.fetchChannel(id).then((function(channel){$log.sdk(_this5.logService+"[ChannelsService] :: EVENT onChannelAvatarUpdated"+channel.id);var sdkEvent=new CustomEvent(_this5.RAINBOW_ONCHANNELAVATARUPDATED,{detail:channel});document.dispatchEvent(sdkEvent)}))}},{key:"onUserSubscriptionChange",value:function(__event,type,channelId,userId){var _this6=this,$log=channelsService_$log.get(this),contactService=channelsService_contactService.get(this),channel=null;this.fetchChannel(channelId).then((function(channelFound){return channel=channelFound,contactService.getContactByDBId(userId,!0)})).then((function(user){if(user=user||userId,4===type){$log.sdk(_this6.logService+"[ChannelsService] :: EVENT onUserSubscriptionChange: user subscribed to a channel: "+channelId);var sdkEvent=new CustomEvent(_this6.RAINBOW_ONCHANNELUSERSUBSCRIBED,{detail:{channel:channel,user:user}});document.dispatchEvent(sdkEvent)}else{$log.sdk(_this6.logService+"[ChannelsService] :: EVENT onUserSubscriptionChange: user unsubscribed from a channel: "+channelId);var _sdkEvent2=new CustomEvent(_this6.RAINBOW_ONCHANNELUSERUNSUBSCRIBED,{detail:{channel:channel,user:user}});document.dispatchEvent(_sdkEvent2)}}))}},{key:"fetchMyChannels",value:function(){return channelsService_channelService.get(this).getMyChannels()}},{key:"createPublicChannel",value:function(channelName){var _this7=this,channelTopic=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",category=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[createPublicChannel] :: Trying to create a new public channel"),new Promise((function(resolve,reject){if(!channelName)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'channelName' is missing or empty"});channelService.createChannel(channelName,"company_public",channelTopic,category,!1).then((function(channel){return $log.sdk(_this7.logService+"[createPublicChannel] :: Public Channel created: "+channel.id),resolve(channel)})).catch((function(err){return reject(err)}))}))}},{key:"createClosedChannel",value:function(channelName){var _this8=this,channelTopic=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",category=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[createClosedChannel] :: Trying to create a new closed channel"),new Promise((function(resolve,reject){if(!channelName)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'channelName' is missing or empty"});channelService.createChannel(channelName,"company_closed",channelTopic,category,!1).then((function(channel){return $log.sdk(_this8.logService+"[createClosedChannel] :: created: "+channel.id),resolve(channel)})).catch((function(err){return reject(err)}))}))}},{key:"deleteChannel",value:function(id){var _this9=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[deleteChannel] :: Trying to delete a channel"),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});channelService.deleteChannel(id).then((function(){return $log.sdk(_this9.logService+"[deleteChannel] :: deleted: "+id),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return err}))}))}},{key:"fetchChannelsByName",value:function(name){var _this10=this,$log=channelsService_$log.get(this),channelService=channelsService_channelService.get(this),SDK=channelsService_SDK.get(this);return $log.sdk(this.logService+"[fetchChannelsByName] :: Trying to fetch channels by name"),new Promise((function(resolve,reject){if(!name)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'name' is missing or empty"});var filter={};filter.name=name,channelService.findChannels(filter).then((function(channels){return $log.sdk(_this10.logService+"[fetchChannelsByName] :: fetched: "+channels.length),resolve(channels)})).catch((function(err){return reject(err)}))}))}},{key:"fetchChannelsByTopic",value:function(topic){var _this11=this,$log=channelsService_$log.get(this),channelService=channelsService_channelService.get(this),SDK=channelsService_SDK.get(this);return $log.sdk(this.logService+"[fetchChannelsByTopic] :: Trying to fetch channels by topic"),new Promise((function(resolve,reject){if(!topic)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'topic' is missing or empty"});var filter={};filter.topic=topic,channelService.findChannels(filter).then((function(channels){return $log.sdk(_this11.logService+"[fetchChannelsByTopic] :: fetched: "+channels.length),resolve(channels)})).catch((function(err){return reject(err)}))}))}},{key:"fetchChannelsByCategory",value:function(category){var _this12=this,$log=channelsService_$log.get(this),channelService=channelsService_channelService.get(this),SDK=channelsService_SDK.get(this);return $log.sdk(this.logService+"[fetchChannelsByCategory] :: Trying to fetch channels by category"),new Promise((function(resolve,reject){if(!category)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'category' is missing or empty"});var filter={};filter.category=category,channelService.findChannels(filter).then((function(channels){return $log.sdk(_this12.logService+"[fetchChannelsByCategory] :: fetched: "+channels.length),resolve(channels)})).catch((function(err){return reject(err)}))}))}},{key:"fetchChannel",value:function(id){var _this13=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[fetchChannel] :: Trying to fetch a channel..."),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});channelService.getChannel(id).then((function(channel){return $log.sdk(_this13.logService+"[fetchChannel] :: fetched: "+channel.id),resolve(channel)})).catch((function(err){return reject(err)}))}))}},{key:"createItem",value:function(channel,message,title,url,type){var _this14=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[createItem] :: Trying to create item"),new Promise((function(resolve,reject){return channel?message?type&&-1===["basic","markdown","html","data"].indexOf(type)?reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'type' could be 'basic', 'markdown', 'html' or 'data'"}):(title=title||"",url=url||"",type=type?"urn:xmpp:channels:"+type:"urn:xmpp:channels:basic",void channelService.publishToChannel(channel.id,null,type,message,title,url).then((function(){return $log.sdk(_this14.logService+"[createItem] :: created: "+channel.id),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)}))):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'message' is missing or empty"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'channel' is missing or empty"})}))}},{key:"subscribeToChannelById",value:function(id){var _this15=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[subscribeToChannelById] :: Trying to subscribe to a channel..."),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or null"});var channel=channelService.getChannelFromCache(id);channel?channelService.subscribeToChannel(channel).then((function(){return $log.sdk(_this15.logService+"[subscribeToChannelById] :: subscribed: "+id),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)})):channelService.getChannel(id).then((function(channelFound){if(!channelFound)return reject({code:SDK.ERRORBADREQUEST,label:"No channel found with id "+id});channelService.subscribeToChannel(channelFound).then((function(){return $log.sdk(_this15.logService+"[subscribeToChannelById] :: subscribed: "+id),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)}))}))}))}},{key:"subscribeToChannel",value:function(channel){var _this16=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[subscribeToChannel] :: Trying to subscribe to a channel..."),new Promise((function(resolve,reject){if(!channel)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'channel' is missing or null"});channelService.subscribeToChannel(channel).then((function(){return $log.sdk(_this16.logService+"[subscribeToChannel] :: subscribed: "+channel.id),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)}))}))}},{key:"unsubscribeFromChannelById",value:function(id){var _this17=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[unsubscribeFromChannelById] :: Trying to unsubscribe from a channel..."),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});var channel=channelService.getChannelFromCache(id);channel?channelService.unsubscribeToChannel(channel).then((function(){return $log.sdk(_this17.logService+"[unsubscribeFromChannelById] :: unsubscribed: "+id),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)})):channelService.getChannel(id).then((function(channelFound){if(!channelFound)return reject({code:SDK.ERRORBADREQUEST,label:"No channel found with id "+id});channelService.unsubscribeToChannel(channelFound).then((function(){return $log.sdk(_this17.logService+"[unsubscribeFromChannelById] :: unsubscribed: "+id),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)}))}))}))}},{key:"unsubscribeFromChannel",value:function(channel){var _this18=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[unsubscribeFromChannel] :: Trying to unsubscribe from a channel..."),new Promise((function(resolve,reject){if(!channel)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'channel' is missing or null"});channelService.unsubscribeToChannel(channel).then((function(){return $log.sdk(_this18.logService+"[unsubscribeFromChannel] :: unsubscribed: "+channel.id),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)}))}))}},{key:"updateChannel",value:function(id,channelTopic,visibility,maxItems,maxPayloadSize,channelName,category){var _this19=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[updateChannel] :: Trying to update a channel..."),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});var options={};null!==channelTopic&&(options.topic=channelTopic),null!==visibility&&(options.mode="company"===visibility?"company_public":"company_closed"),null!==maxItems&&(options.maxItems=maxItems),null!==maxPayloadSize&&(options.maxPayloadSize=maxPayloadSize),null!==channelName&&(options.name=channelName),null!==category&&(options.cateogry=category),channelService.updateChannel(id,options).then((function(channelUpdated){return channelUpdated.visibility=options.visibility,$log.sdk(_this19.logService+"[updateChannel] :: updated: "+id),resolve(channelUpdated)})).catch((function(err){return reject(err)}))}))}},{key:"updateChannelVisibility",value:function(id,visibility){var _this20=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[updateChannelVisibility] :: Trying to update visibility of a channel..."),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});if(!visibility)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'visibility' is missing or empty"});var options={};null!==visibility&&(options.mode="company"===visibility?"company_public":"company_closed"),channelService.updateChannel(id,options).then((function(channelUpdated){return $log.sdk(_this20.logService+"[updateChannelVisibility] :: updated: "+id),resolve(channelUpdated)})).catch((function(err){return reject(err)}))}))}},{key:"updateChannelVisibilityToPublic",value:function(id){var _this21=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[updateChannelVisibilityToPublic] :: Trying to update visibility to visible for a channel"),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});channelService.updateChannel(id,{mode:"company_public"}).then((function(channelUpdated){return $log.sdk(_this21.logService+"[updateChannelVisibilityToPublic] :: updated: "+id),resolve(channelUpdated)})).catch((function(err){return reject(err)}))}))}},{key:"updateChannelVisibilityToClosed",value:function(id){var _this22=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[updateChannelVisibilityToClosed] :: Trying to update visibility to closed for a channel"),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});channelService.updateChannel(id,{mode:"company_closed"}).then((function(channelUpdated){return $log.sdk(_this22.logService+"[updateChannelVisibilityToClosed] :: updated: "+id),resolve(channelUpdated)})).catch((function(err){return reject(err)}))}))}},{key:"updateChannelName",value:function(id,channelName){var _this23=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[updateChannelName] :: Trying to update the name of a channel"),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});var options={};null!==channelName&&(options.name=channelName),channelService.updateChannel(id,options).then((function(channelUpdated){return $log.sdk(_this23.logService+"[updateChannelName] :: updated: "+id),resolve(channelUpdated)})).catch((function(err){return reject(err)}))}))}},{key:"updateChannelTopic",value:function(id,channelTopic){var _this24=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[updateChannelTopic] :: Try to update the topic of a channel"),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});var options={};null!==channelTopic&&(options.topic=channelTopic),channelService.updateChannel(id,options).then((function(channelUpdated){return $log.sdk(_this24.logService+"[updateChannelTopic] :: updated: "+id),resolve(channelUpdated)})).catch((function(err){return reject(err)}))}))}},{key:"updateChannelCategory",value:function(id,category){var _this25=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[updateChannelCategory] :: Try to update the category of a channel"),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});var options={};null!==category&&(options.category=category),channelService.updateChannel(id,options).then((function(channelUpdated){return $log.sdk(_this25.logService+"[updateChannelCategory] :: updated: "+id),resolve(channelUpdated)})).catch((function(err){return reject(err)}))}))}},{key:"updateChannelAvatar",value:function(id,urlAvatar){var _this26=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[updateChannelAvatar] :: Try to update the avatar of a channel"),new Promise((function(resolve,reject){return id?urlAvatar?void channelService.uploadChannelAvatar(id,urlAvatar,512).then((function(){return $log.sdk(_this26.logService+"[updateChannelAvatar] :: updated: "+id),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'urlAvatar' is missing or empty"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"})}))}},{key:"deleteChannelAvatar",value:function(id){var _this27=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[deleteChannelAvatar] :: Try to delete the avatar of a channel"),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});channelService.deleteChannelAvatar(id).then((function(){return $log.sdk(_this27.logService+"[deleteChannelAvatar] :: updated: "+id),resolve({code:SDK.OK,label:"OK"})})).catch((function(err){return reject(err)}))}))}},{key:"fetchUsers",value:function(id,options){var _this28=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[fetchUsers] :: Trying to fetch users of a channel"),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});channelService.getChannelUsers(id,options).then((function(usersData){return $log.sdk(_this28.logService+"[fetchUsers] :: got: "+id),resolve(usersData.data)})).catch((function(error){return reject(error)}))}))}},{key:"deleteAllUsersFromChannel",value:function(id){var _this29=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[deleteAllUsersFromChannel] :: Trying to get delete all users of a channel..."),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});channelService.removeAllUsersFromChannel(id).then((function(){return channelService.getChannel(id)})).then((function(channelUpdated){return $log.sdk(_this29.logService+"[deleteAllUsersFromChannel] :: deleted: "+id),resolve(channelUpdated)})).catch((function(err){return reject(err)}))}))}},{key:"updateChannelUsers",value:function(id,users,userType){var _this30=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[updateChannelUsers] :: Trying to update users of a channel"),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});userType=userType||"member",channelService.updateChannelUsers(id,users,userType).then((function(usersData){return $log.sdk(_this30.logService+"[updateChannelUsers] :: updated: "+id),resolve(usersData)})).catch((function(err){return reject(err)}))}))}},{key:"addMembersToChannel",value:function(id,users){var _this31=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[addMembersToChannel] :: Trying to add members to a channel"),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});channelService.updateChannelUsers(id,users,"member").then((function(usersData){return $log.sdk(_this31.logService+"[addMembersToChannel] :: added: "+id),resolve(usersData)})).catch((function(err){return reject(err)}))}))}},{key:"addPublishersToChannel",value:function(id,users){var _this32=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[addPublishersToChannel] :: Trying to add publishers to a channel"),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});channelService.updateChannelUsers(id,users,"publisher").then((function(usersData){return $log.sdk(_this32.logService+"[addPublishersToChannel] :: added: "+id),resolve(usersData)})).catch((function(err){return reject(err)}))}))}},{key:"addOwnersToChannel",value:function(id,users){var _this33=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[addOwnersToChannel] :: Trying to add owners to a channel"),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});channelService.updateChannelUsers(id,users,"owner").then((function(usersData){return $log.sdk(_this33.logService+"[addOwnersToChannel] :: added: "+id),resolve(usersData)})).catch((function(err){return reject(err)}))}))}},{key:"deleteUsersFromChannel",value:function(id,users){var _this34=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[deleteUsersFromChannel] :: Trying to delete users from a channel"),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});channelService.updateChannelUsers(id,users,"none").then((function(usersData){return $log.sdk(_this34.logService+"[deleteUsersFromChannel] :: deleted: "+id),resolve(usersData)})).catch((function(err){return reject(err)}))}))}},{key:"fetchItems",value:function(id,maxMessages,beforeDate,afterDate){var _this35=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[fetchItems] :: Try to fetch items of a channel"),new Promise((function(resolve,reject){if(!id)return reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'id' is missing or empty"});channelService.getChannelItems(id,maxMessages,beforeDate,afterDate).then((function(messages){return $log.sdk(_this35.logService+"[fetchItems] :: fetched: "+id),resolve(messages)})).catch((function(err){return reject(err)}))}))}},{key:"deleteItem",value:function(channelId,itemId){var _this36=this,$log=channelsService_$log.get(this),SDK=channelsService_SDK.get(this),channelService=channelsService_channelService.get(this);return $log.sdk(this.logService+"[deleteItem] :: Trying to delete an item."),new Promise((function(resolve,reject){return channelId?itemId?void channelService.deleteChannelItem(channelId,itemId).then((function(){return $log.sdk(_this36.logService+"[deleteItem] :: Item deleted: "+itemId),resolve()})).catch((function(err){return reject(err)})):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'itemId' is missing or empty"}):reject({code:SDK.ERRORBADREQUEST,label:"Parameter 'channelId' is missing or empty"})}))}}]),ChannelsService}();function sdkService_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function sdkService_createClass(Constructor,protoProps,staticProps){return protoProps&&sdkService_defineProperties(Constructor.prototype,protoProps),staticProps&&sdkService_defineProperties(Constructor,staticProps),Constructor}var sdkService_$log=new WeakMap,sdkService_$rootScope=new WeakMap,_connectionService=new WeakMap,_presenceService=new WeakMap,_contactsService=new WeakMap,_conversationsService=new WeakMap,_imService=new WeakMap,_pbxService=new WeakMap,_webRTCService=new WeakMap,_bubblesService=new WeakMap,_groupsService=new WeakMap,_callsLogService=new WeakMap,_userProfileService=new WeakMap,sdkService_settingsService=new WeakMap,_favoritesService=new WeakMap,_filesStorageService=new WeakMap,_capabilitiesService=new WeakMap,_channelsService=new WeakMap,_adminService=new WeakMap,sdkService_SDK=new WeakMap,SdkService=function(){function SdkService($log,$rootScope,connectionService,presenceService,contactsService,conversationsService,imService,pbxService,webRTCService,bubblesService,groupsService,callsLogService,userProfileService,settingsService,favoritesService,filesStorageService,capabilitiesService,channelsService,adminService,SDK){!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,SdkService),sdkService_$log.set(this,$log),sdkService_$rootScope.set(this,$rootScope),_connectionService.set(this,connectionService),_presenceService.set(this,presenceService),_contactsService.set(this,contactsService),_conversationsService.set(this,conversationsService),_imService.set(this,imService),_pbxService.set(this,pbxService),_webRTCService.set(this,webRTCService),_bubblesService.set(this,bubblesService),_groupsService.set(this,groupsService),_callsLogService.set(this,callsLogService),_userProfileService.set(this,userProfileService),sdkService_settingsService.set(this,settingsService),_favoritesService.set(this,favoritesService),_filesStorageService.set(this,filesStorageService),_capabilitiesService.set(this,capabilitiesService),_channelsService.set(this,channelsService),_adminService.set(this,adminService),sdkService_SDK.set(this,SDK),this.eventHandler=null,this.isReady=!1,this.RAINBOW_ONREADY="ready",this.RAINBOW_ONLOADED="loaded",this.connection=connectionService,this.presence=presenceService,this.contacts=contactsService,this.conversations=conversationsService,this.im=imService,this.telephony=pbxService,this.webRTC=webRTCService,this.bubbles=bubblesService,this.groups=groupsService,this.callsLog=callsLogService,this.userProfile=userProfileService,this.favorites=favoritesService,this.fileStorage=filesStorageService,this.caps=capabilitiesService,this.channels=channelsService,this.admin=adminService,this.version=this.version.bind(this),this.mode=this.mode.bind(this),this.setVerboseLog=this.setVerboseLog.bind(this),this.setKeyFromConfig=this.setKeyFromConfig.bind(this),this.hasBeenLaunchedFromConfig=this.hasBeenLaunchedFromConfig.bind(this),this.initialize=this.initialize.bind(this),this.initializeFirstStep=this.initializeFirstStep.bind(this),this.intializeSecondStep=this.intializeSecondStep.bind(this),this.load=this.load.bind(this),this.ready=this.ready.bind(this),this.initialize_auto=this.initialize_auto.bind(this),this.start=this.start.bind(this)}return sdkService_createClass(SdkService,[{key:"$inject",value:function(){}}]),sdkService_createClass(SdkService,[{key:"version",value:function(){return window.sdkversion}},{key:"mode",value:function(){return sdkService_settingsService.get(this).getSetting("apiMode")}},{key:"setVerboseLog",value:function(boolHasVerboseLog){return sdk.hasVerboseLog=boolHasVerboseLog,sdk.hasVerboseLog}},{key:"setKeyFromConfig",value:function(strApplicationID,strApplicationSecret){return sdkService_$log.get(this).sdk("SDKService | [setKeyFromConfig] :: Linked to application ID "+strApplicationID+" from configuration file"),sdk.key.appID=strApplicationID,sdk.key.appSecret=strApplicationSecret,!0}},{key:"hasBeenLaunchedFromConfig",value:function(boolFromConfig){var fromConfig=boolFromConfig?"YES":"NO";return sdkService_$log.get(this).sdk("SDKService | [hasBeenLaunchedFromConfig] :: SDK lauched from a configuration file "+fromConfig),sdk.hasBeenLaunchedFromConfig=boolFromConfig,sdk.hasBeenLaunchedFromConfig}},{key:"initialize",value:function(strApplicationID,strApplicationSecret){var _this=this,$log=sdkService_$log.get(this);return strApplicationID&&strApplicationID.length>0?(sdk.key.appID=strApplicationID,$log.sdk("SDKService | [initialize] :: Initialize the SDK for the application "+sdk.key.appID)):$log.sdk("SDKService | [initialize] :: Initialize the SDK without an application key"),strApplicationSecret&&strApplicationSecret.length>0&&(sdk.key.appSecret=strApplicationSecret),new Promise((function(resolve,reject){_this.initializeFirstStep().then((function(){$log.sdk("SDKSrv     | [initialize ] :: Initialize step 1/2 ok"),_this.intializeSecondStep().then((function(){return $log.sdk("SDKSrv     | [initialize ] :: Initialize step 2/2 ok"),$log.sdk("SDKSrv     | [initialize ] :: SDK Initialized successfully!"),resolve()})).catch((function(err){return reject(err)}))}))}))}},{key:"initializeFirstStep",value:function(){var _this2=this,$rootScope=sdkService_$rootScope.get(this);return new Promise((function(resolve,reject){if(_this2.isReady)return resolve();var handler=$rootScope.$on("RAINBOW_INTERNAL_READY",(function(){return handler(),resolve()}));return reject()}))}},{key:"intializeSecondStep",value:function(){var _this3=this;return new Promise((function(resolve,reject){DetectRTC.load((function(){return _this3.initialize_auto(),resolve()}))}))}},{key:"load",value:function(){sdkService_$log.get(this).sdk("SDKService | [load] :: Rainbow SDK loaded!");var sdkEvent=new CustomEvent(this.RAINBOW_ONLOADED);document.dispatchEvent(sdkEvent)}},{key:"ready",value:function(){sdkService_$log.get(this).sdk("SDKService | [ready] :: Rainbow SDK ready!");var sdkEvent=new CustomEvent(this.RAINBOW_ONREADY);document.dispatchEvent(sdkEvent)}},{key:"initialize_auto",value:function(){var $log=sdkService_$log.get(this);$log.sdk("SDKSrv     | [initialize ] :: Initializing the Rainbow SDK..."),$log.sdk("SDKSrv     | [initialize ] :: -----------------------------"),$log.sdk("SDKSrv     | [initialize ] :: Platform    | "+DetectRTC.osName+" "+DetectRTC.osVersion),$log.sdk("SDKSrv     | [initialize ] :: Screen      | "+window.screen.width+"x"+window.screen.height),$log.sdk("SDKSrv     | [initialize ] :: Cookie      | "+navigator.cookieEnabled),$log.sdk("SDKSrv     | [initialize ] :: Java        | "+navigator.javaEnabled()),$log.sdk("SDKSrv     | [initialize ] :: Server      | "+config.webservices.server),$log.sdk("SDKSrv     | [initialize ] :: Version WEB | "+window.version),$log.sdk("SDKSrv     | [initialize ] :: Version SDK | "+window.sdkversion),$log.sdk("SDKSrv     | [initialize ] :: Browser     | "+DetectRTC.browser.name+" "+DetectRTC.browser.fullVersion),$log.sdk("SDKSrv     | [initialize ] :: Microphone  | "+DetectRTC.hasMicrophone),$log.sdk("SDKSrv     | [initialize ] :: Camera      | "+DetectRTC.hasWebcam),$log.sdk("SDKSrv     | [initialize ] :: Speakers    | "+DetectRTC.hasSpeakers),$log.sdk("SDKSrv     | [initialize ] :: WebRTC      | "+DetectRTC.isWebRTCSupported),$log.sdk("SDKSrv     | [initialize ] :: Mode        | "+this.mode()),$log.sdk("SDKSrv     | [initialize ] :: verboseLog  | "+sdk.hasVerboseLog),$log.sdk("SDKSrv     | [initialize ] :: launcher    | "+sdk.hasBeenLaunchedFromConfig),$log.sdk("SDKSrv     | [initialize ] :: appID       | "+sdk.key.appID),$log.sdk("SDKSrv     | [initialize ] :: -----------------------------"),$log.sdk("SDKSrv     | [initialize ] :: Initialized!"),this.ready()}},{key:"start",value:function(){var _this4=this,$rootScope=sdkService_$rootScope.get(this),settingsService=sdkService_settingsService.get(this);return new Promise((function(resolve,reject){return settingsService.setSetting("apiMode","sdk"),config.webservices.currentServer=config.webservices.server,_this4.isReady=!0,$rootScope.$broadcast("RAINBOW_INTERNAL_READY"),$rootScope.$on("$destroy",(function(){eventHandler&&eventHandler()})),resolve(_this4)}))}}]),SdkService}();__webpack_require__(88),__webpack_require__(89),window.adapter=adapter_core_namespaceObject,__webpack_require__(90),__webpack_require__(91),__webpack_require__(302),__webpack_require__(303),__webpack_require__(304),__webpack_require__(305),angular.module("sdk").service("connectionService",ConnectionService),angular.module("sdk").service("presenceService",PresenceService),angular.module("sdk").service("userProfileService",UserProfileService),angular.module("sdk").service("contactsService",ContactsService),angular.module("sdk").service("pbxService",PbxService),angular.module("sdk").service("conversationsService",ConversationsService),angular.module("sdk").service("imService",ImService),angular.module("sdk").service("webRTCService",WebRTCService),angular.module("sdk").service("bubblesService",BubblesService),angular.module("sdk").service("groupsService",GroupsService),angular.module("sdk").service("callsLogService",CallsLogService),angular.module("sdk").service("favoritesService",FavoritesService),angular.module("sdk").service("filesStorageService",FilesStorageService),angular.module("sdk").service("capabilitiesService",CapabilitiesService),angular.module("sdk").service("adminService",AdminService),angular.module("sdk").service("channelsService",ChannelsService),angular.module("sdk").service("rainbowSDK",SdkService),angular.bootstrap(document,["sdk"]).get("rainbowSDK");var rainbowSDK=angular.element(document).injector().get("rainbowSDK");__webpack_exports__.default=rainbowSDK}]);export default rainbowSDK.default;